(function(){"use strict";TS.registerModule("compression",{onStart:function(){},compress:function(k,str,immediate,after){var start=Date.now();if(immediate){var result=LZString.compress(str);var elapsed=Date.now()-start;TS.log(489,k+" took "+elapsed+"ms to _compress immediately str.length: "+str.length);return after({k:k,str:result})}_doCompressionJob(k,str,function(result,job_work_ms){var elapsed=Date.now()-start;TS.log(489,k+" took "+elapsed+"ms for the compression worker to callback ("+job_work_ms+"ms spent within the worker) result.length: "+result.length);after({k:k,str:result})})},decompress:function(k,str){var start=Date.now();if(str)str=LZString.decompress(str);var elapsed=Date.now()-start;if(str)TS.log(489,k+" took "+elapsed+"ms to _decompress str.length: "+str.length);return str},terminate:function(){if(_worker)_worker.terminate();_worker=null}});var _worker=null;var _count=0;var _callbacks={};var _doCompressionJob=function(k,str,callback){if(!_worker)_makeWorker();_count++;var job_key="job_key"+_count;_callbacks[job_key]=function(result,job_work_ms){callback(result,job_work_ms);delete _callbacks[job_key]};_worker.postMessage({request:"compress",input:str,job_key:job_key,k:k})};var _makeWorker=function(){if(_worker){TS.error("_makeWorker but there is a _worker");return}var LZString_url=cdn_url+"/85b8/js/libs/lz-string-1.4.4.js";if(TS.boot_data.version_ts=="dev"&&window["vvv"]){LZString_url=location.protocol+"//"+location.host+LZString_url}_worker=TS.utility.makeWebWorker("function() {			self.importScripts('"+LZString_url+"');			self.onmessage = function(e) {				var start = Date.now();				var result;				if (e.data.request == 'compress') {					result = LZString.compress(e.data.input)				}				var elapsed = Date.now() - start;				postMessage({					request: e.data.request,					result: result,					job_key: e.data.job_key,					k: e.data.k,					elapsed: elapsed				});			}		}",function(e){var callback=_callbacks[e.data.job_key];if(!callback){TS.error("e.data.job_key:"+e.data.job_key+" had no record in _callbacks??");return}callback(e.data.result,e.data.elapsed)})}})();(function(){"use strict";TS.registerModule("storage",{version:"0.82",msgs_version:window.boot_data&&boot_data.cache_version||"unknown_version",cache_ts_version:window.boot_data&&boot_data.cache_ts_version||"unknown_version",do_compression:!TS.model.is_our_app&&typeof window.Worker!=="undefined"&&(!window.bowser||!bowser.phantom),test:function(){return{getLocalStorage:_getLs,setLocalStorage:_setLs,getKeys:_getKeys,set:_set}},onStart:function(){TS.storage.onStart=function(){};TS.storage.version+=TS.storage.do_compression?"-compressed-LZString":"";var should_disable=_disabled||TS.qs_args["ls_disabled"]=="1"||!_ls||TS.boot_data&&TS.boot_data.ls_disabled||function(){if(!TS.storage.storageAvailable()){_removeAllOurKeys();if(!TS.storage.storageAvailable()){TS.warn("TS.storage.storageAvailable() = false in onStart after flushing all our keys, so disabling");return true}}return false}();TS.log(488,"TS.storage.onStart should_disable:"+should_disable);TS.log(488,"TS.storage.do_compression:"+TS.storage.do_compression+" (_ls.getItem('is_compressed') == 'yes'):"+(_ls&&_ls.getItem("is_compressed")=="yes"));TS.ui.window_unloaded_sig.add(_windowUnloaded);TS.ui.window_focus_changed_sig.add(_windowBlurred);TS.storage.setDisabled(should_disable);_set("rxn_records",null)},setDisabled:function(disabled){if(_disabled==disabled)return;if(disabled||!_ls){_disabled=true;if(_ls)_removeAllOurKeys()}else{_disabled=false;_setUp()}TS.info("_disabled:"+_disabled)},storageAvailable:function(){if(!_ls)return false;try{var key="test_to_see_if_we_can_write_to_local_storage";_ls.setItem(key,"foo");_ls.removeItem(key);return true}catch(err){return false}},storageSize:function(log){var length=0;if(!_ls)return length;var keys=_getKeys();var c=0;var key;var value;for(var i=0;i<keys.length;i++){c++;key=keys[i];value=_ls.getItem(key);if(!value&&value!==""){TS.warn(key+" not measurable value, typeof:"+typeof value)}else{length+=value.length;if(log)TS.info(key+"="+(value.length*2/1024).toFixed(2)+"KB "+"(total="+(length/1024).toFixed(2)+"KB)")}}if(log)TS.info("total for "+c+" items is "+(length/1024).toFixed(2)+"KB");return length},cleanOutMsgStorageAndResetIfTooOld:function(){if(!_isStorageTooOld())return false;TS.warn("last LS activity too old, we're purging");TS.storage.cleanOutMsgStorageAndReset();return true},cleanOutMsgStorageAndReset:function(){TS.info("cleanOutMsgStorageAndReset running");_cleanOutMsgStorage();TS.storage.storeLastEventTS("",true,true);TS.storage.storeLastMsgTS("",true);var fetched_b4_flush=TS.storage.fetchLastEventTS(true);TS.info("cleanOutMsgStorageAndReset fetched_b4_flush:"+fetched_b4_flush);if(fetched_b4_flush){TS.info("cleanOutMsgStorageAndReset _getKeys:"+_getKeys().join(", "));TS.info("cleanOutMsgStorageAndReset Object.keys(_buffer):"+Object.keys(_buffer).join(", "))}_flushBuffer(true,"cleanOutMsgStorageAndReset");var fetched_after_flush=TS.storage.fetchLastEventTS(true);TS.info("cleanOutMsgStorageAndReset fetched_after_flush:"+fetched_after_flush);if(fetched_after_flush){TS.info("cleanOutMsgStorageAndReset _getKeys:"+_getKeys().join(", "));TS.info("cleanOutMsgStorageAndReset Object.keys(_buffer):"+Object.keys(_buffer).join(", "))}},cleanOutCacheTsStorage:function(){var keys=_getKeys();TS.dir(488,keys,"_getKeys()");TS.storage.storeBots();TS.storage.storeMembers();keys=_getKeys();TS.dir(488,keys,"_getKeys()")},fetchStorageVersion:function(){return _get("storage_version")},storeStorageVersion:function(val){_set("storage_version",val,true)},fetchMsgsStorageVersion:function(){return _get("storage_msgs_version")},storeMsgsStorageVersion:function(val){_set("storage_msgs_version",val,true)},fetchCacheTSStorageVersion:function(){return _get("storage_cache_ts_version")},storeCacheTSStorageVersion:function(val){_set("storage_cache_ts_version",val,true)},fetchMsgsRaw:function(id){return _get(_makeMsgsId(id),[])||[]},fetchMsgs:function(id){var msgs=JSON.parse(JSON.stringify(_get(_makeMsgsId(id),[])||[]));var A=[];var imsg;for(var i=0;i<msgs.length;i++){if(TS.qs_args["not_all_ls_msgs"]&&i<5)continue;imsg=msgs[i];if(!imsg.ts)continue;if(TS.utility.msgs.isTempMsg(imsg))continue;if(imsg.is_ephemeral)continue;A.push(TS.utility.msgs.processImsg(imsg,id))}return A},storeMsgs:function(id,msgs){_set(_makeMsgsId(id),msgs);if(msgs&&msgs.length){var last_msg_ts=TS.storage.fetchLastMsgTS();if(msgs[0].ts>last_msg_ts){TS.storage.storeLastMsgTS(msgs[0].ts)}}},_makeMsgInputId:function(id){return"msg_input_"+id},fetchLastMsgInput:function(id){return _get(TS.storage._makeMsgInputId(id),null)},storeLastMsgInput:function(id,txt){_set(TS.storage._makeMsgInputId(id),txt)},_makeCommentInputId:function(id){return"comment_input_"+id},fetchLastCommentInput:function(id){return _get(TS.storage._makeCommentInputId(id),null)},storeLastCommentInput:function(id,txt){_set(TS.storage._makeCommentInputId(id),txt)},fetchOldestTs:function(id){return _get(_makeOldestTsId(id),null)},storeOldestTs:function(id,ts){_set(_makeOldestTsId(id),ts);return},fetchActiveHistory:function(){return _get("active_history",[])||[]},storeActiveHistory:function(history){_set("active_history",history,true)},fetchLastEventTS:function(log){return _get("last_event_ts","",log)||""},storeLastEventTS:function(ts,immediate,log){_set("last_event_ts",ts,immediate,log)},fetchLastMsgTS:function(){return _get("last_msg_ts","")||""},storeLastMsgTS:function(ts,immediate){_set("last_msg_ts",ts,immediate)},fetchUIState:function(){return _get("ui_state",{})||{}},storeUIState:function(state){_set("ui_state",state)},fetchInlineImgState:function(){return _get("inline_img_state",{})||{}},storeInlineImgState:function(state){_set("inline_img_state",state)},fetchInlineVideoState:function(){return _get("inline_video_state",{})||{}},storeInlineVideoState:function(state){_set("inline_video_state",state)},fetchInlineAttachmentState:function(){return _get("inline_attachment_state",{})||{}},storeInlineAttachmentState:function(state){_set("inline_attachment_state",state)},fetchExpandableState:function(){return _get("expandable_state",{})||{}},storeExpandableState:function(state){_set("expandable_state",state)},fetchClientWindows:function(){return _get("client_windows",{})||{}},storeClientWindows:function(wins){_set("client_windows",wins)},fetchInputHistory:function(){var A=_get("input_history",[])||[];if(typeof A==="string")A=[A];var max=300;if(A.length>max)A.length=max;return A},storeInputHistory:function(history){_set("input_history",history)},fetchCustomEmoji:function(){return _get("custom_emoji",null)||null},storeCustomEmoji:function(val){_set("custom_emoji",val)},fetchEmojiUse:function(){return _get("emoji_use",{})||{}},storeEmojiUse:function(val){_set("emoji_use",val)},fetchApps:function(){return _get("apps",null)||null},storeApps:function(val){_set("apps",val)},fetchAppsSearchResults:function(){return _get("apps_search",null)||null},storeAppsSearchResults:function(val){_set("apps_search",val)},fetchCmds:function(){return _get("cmds",null)||null},storeCmds:function(val){_set("cmds",val)},fetchChannelPageState:function(){return _get("channel_page_state",{})||{}},storeChannelPageState:function(state){_set("channel_page_state",state)},fetchInvitesState:function(){return _get("invites_state",[])||[]},storeInvitesState:function(state){_set("invites_state",state)},fetchReplyInput:function(model_ob_id,thread_ts){var inputs=_get("reply_inputs")||[];var prev_input=_.find(inputs,{model_ob_id:model_ob_id,thread_ts:thread_ts});return prev_input?prev_input.text:""},storeReplyInput:function(model_ob_id,thread_ts,text){var max_saved_inputs=10;var inputs=_get("reply_inputs")||[];inputs=_.reject(inputs,{model_ob_id:model_ob_id,thread_ts:thread_ts});if(inputs.length>max_saved_inputs){inputs.shift()}inputs.push({model_ob_id:model_ob_id,thread_ts:thread_ts,text:text});_set("reply_inputs",inputs)},fetchFilterState:function(){return _get("team_filter_state","")||""},storeFilterState:function(state){_set("team_filter_state",state)},fetchCallsState:function(){return _get("calls_state",{})||{}},storeCallsState:function(state){_set("calls_state",state)},fetchMembers:function(){var members_data=_get("members_data");if(!members_data)return[];return members_data.members||[]},storeMembers:function(members){_set("last_cache_ts",null,true);if(!TS.model.supports_user_caching&&members)return;var members_data=members?{members:members,cache_ts:_last_cache_ts_possible}:null;_set("members_data",members_data)},fetchBots:function(){var bots_data=_get("bots_data");if(!bots_data)return[];return bots_data.bots||[]},storeBots:function(bots){_set("last_cache_ts",null,true);if(!TS.model.supports_user_caching&&bots)return;var bots_data=bots?{bots:bots,cache_ts:_last_cache_ts_possible}:null;_set("bots_data",bots_data)},rememberLastCacheTS:function(ts){if(!TS.model.supports_user_caching)return;if(!ts)return;if(_last_cache_ts_possible&&ts<=_last_cache_ts_possible)return;_last_cache_ts_possible=ts},fetchLastCacheTS:function(){return parseInt(_get("last_cache_ts"))||0},fetchFrecency:function(namespace){return _get("frecency_"+namespace)},storeFrecency:function(namespace,data){_set("frecency_"+namespace,data)},clearFrecency:function(namespace){_set("frecency_"+namespace,"")},fetchEnterpriseState:function(){return _get("enterprise_state",{})||{}},storeEnterpriseState:function(state){_set("enterprise_state",state)}});var _prefix=window.boot_data.user_id+"_";var _msgs_id_part="channel_msgs_";var _makeMsgsId=function(id){return _msgs_id_part+id};var _oldest_ts_part="oldest_msg_ts_";var _makeOldestTsId=function(id){return _oldest_ts_part+id};var _disabled;var _immediate_saves=false;var _last_cache_ts_possible=null;var _buffer={};var _ls_fetch_cache={};var _slow_get_threshold=1e3;var _slow_get_logged=false;var _slow_set_threshold=1e3;var _slow_set_logged=false;var _slow_write_threshold=1e3;var _slow_write_logged=false;var _slow_all_write_logged=false;var _flush_all_buffer_interv=null;var _flush_all_buffer_interv_ms=2e3;var _flush_all_buffer_user_inactive_ms=1e4;var _flush_one_buffer_user_inactive_ms=1e3;var _getKeys=function(){var A=[];if(!_ls)return A;var len=_ls.length;if(!len)return A;for(var i=0;i<len;i++){A.push(_ls.key(i))}return A};var _setUp=function(){var keys;if(!_disabled){var temp_storage_version=TS.storage.fetchStorageVersion()||"";var is_compressed=temp_storage_version.indexOf("-compressed")!=-1||_ls.getItem("is_compressed")=="yes";if(TS.storage.do_compression&&!is_compressed){TS.warn("migrating to compressed format");keys=_getKeys();keys.forEach(function(k){var name=k.replace(_prefix,"");var val=_convertTypeForFetch(k,_ls.getItem(k));var log_string="converting: "+k+" -> "+name+" val.length: "+(val===undefined||val===null?-1:String(val).length);_set(name,null);_set(name,val);if(_get(name)==val){TS.log(488,log_string+" SUCCESS _get(name) has a value:"+!!_get(name)+", and it it the same as val")}else{TS.error(log_string+" FAILURE _get(name) !== val")}});TS.warn("migration to compressed format complete, "+keys.length+" migrated");TS.storage.storeStorageVersion(TS.storage.version)}else{TS.log(488,"no migration needed")}_ls.setItem("is_compressed",TS.storage.do_compression?"yes":"no")}var storage_msgs_version=TS.storage.fetchMsgsStorageVersion();TS.log(488,"TS.storage.msgs_version:"+TS.storage.msgs_version);TS.log(488,"storage_msgs_version:"+storage_msgs_version);var storage_cache_ts_version=TS.storage.fetchCacheTSStorageVersion();TS.log(488,"TS.storage.cache_ts_version:"+TS.storage.cache_ts_version);TS.log(488,"storage_cache_ts_version:"+storage_cache_ts_version);var storage_version=TS.storage.fetchStorageVersion()||"";if(storage_version.substr(0,4)=="0.84"&&TS.storage.version.substr(0,4)=="0.82"){storage_version=storage_version.replace("0.84","0.82").replace("-uncompressed","");TS.warn("corrected storage version for LS from "+TS.storage.fetchStorageVersion()+" to "+storage_version);TS.storage.storeStorageVersion(storage_version)}TS.log(488,"TS.storage.version:"+TS.storage.version);TS.log(488,"storage_version:"+storage_version);TS.log(488,"TS.storage last_unload_flushing: "+_get("last_unload_flushing"));TS.log(488,"TS.storage.storageAvailable(): "+TS.storage.storageAvailable());keys=_getKeys();TS.dir(488,keys,"_getKeys()");if(!TS.storage.storageAvailable()){TS.warn("TS.storage.storageAvailable() = false so flushing all our keys");_removeAllOurKeys()}else if(storage_version!=TS.storage.version){TS.warn("storage_version:"+storage_version+" does not match TS.storage.version:"+TS.storage.version+" so flushing all our keys: "+keys.join(", "));_removeAllOurKeys()}else if(!TS.storage.fetchLastEventTS()){TS.warn("TS.storage.fetchLastEventTS() is empty so flushing channel data");_cleanOutMsgStorage()}else if(storage_msgs_version!=TS.storage.msgs_version||TS.qs_args["no_ls_msgs"]=="1"){if(TS.qs_args["no_ls_msgs"]=="1"){TS.warn("TS.qs_args['no_ls_msgs'] == '1' so flushing channel data")}else{TS.warn("storage_msgs_version:"+storage_msgs_version+" does not match TS.storage.msgs_version:"+TS.storage.msgs_version+" so flushing channel data")}_cleanOutMsgStorage()}else if(storage_cache_ts_version!=TS.storage.cache_ts_version){TS.warn("storage_cache_ts_version:"+storage_cache_ts_version+" does not match TS.storage.cache_ts_version:"+TS.storage.cache_ts_version+" so flushing user/bot data");TS.storage.cleanOutCacheTsStorage()}TS.storage.storeStorageVersion(TS.storage.version);TS.storage.storeMsgsStorageVersion(TS.storage.msgs_version);TS.storage.storeCacheTSStorageVersion(TS.storage.cache_ts_version);TS.ms.connected_sig.addOnce(_flushAllBufferOnIdleTimer)};var _removeAllOurKeys=function(){_getKeys().forEach(function(key){if(key.indexOf(_prefix)===0)_ls.removeItem(key)})};var _isStorageTooOld=function(){var last_event_ts=TS.storage.fetchLastEventTS();var last_msg_ts=TS.storage.fetchLastMsgTS();var last_ts=last_event_ts;if(!last_ts||last_msg_ts>last_event_ts)last_ts=last_msg_ts;if(last_ts){var last_date=TS.utility.date.toDateObject(last_ts);var elapsed=Date.now()-last_date;var limit_ms=3*864e5;if(elapsed>limit_ms){return true}}return false};var _cleanOutMsgStorage=function(){var keys=_getKeys();TS.log(488,keys,"_getKeys()");var key;for(var i=0;i<keys.length;i++){key=keys[i];if(key.indexOf(_prefix)!==0)continue;if(key.indexOf(_msgs_id_part)==-1&&key.indexOf(_oldest_ts_part)==-1)continue;_ls.removeItem(key);delete _buffer[key];TS.warn("_ls.removeItem:"+key)}for(key in _buffer){if(key.indexOf(_prefix)!==0)continue;if(key.indexOf(_msgs_id_part)==-1&&key.indexOf(_oldest_ts_part)==-1)continue;delete _buffer[key];TS.warn("delete _buffer:"+key)}keys=_getKeys();TS.dir(488,keys,"_getKeys()")};var _windowUnloaded=function(){_immediate_saves=true;_set("last_unload_flushing",(new Date).toString(),true);_flushBuffer(true,"_windowUnloaded");TS.compression.terminate()};var _windowBlurred=function(){_flushBuffer(true,"_windowBlurred")};var _flushAllBufferOnIdleTimer=function(){if(_flush_all_buffer_interv){window.clearInterval(_flush_all_buffer_interv);_flush_all_buffer_interv=null}_flush_all_buffer_interv=window.setInterval(_maybeFlushBuffer,_flush_all_buffer_interv_ms)};var _maybeFlushBuffer=function(){if(!TS.model)return;var buffer_count=Object.keys(_buffer).length;if(!buffer_count)return;var ok_to_flush_all=false;var ok_to_flush_why="";if(!TS.model.ui.is_window_focused){ok_to_flush_why="window blurred!";ok_to_flush_all=true}var ms_since_activity=Date.now()-TS.model.client.last_user_active_timestamp;if(!ok_to_flush_all){if(ms_since_activity>=_flush_all_buffer_user_inactive_ms){ok_to_flush_why="window focused, but user has been idle long enough "+ms_since_activity+" >= "+_flush_all_buffer_user_inactive_ms;ok_to_flush_all=true}}TS.log(488,"_maybeFlushBuffer ok_to_flush_all:"+ok_to_flush_all);if(ok_to_flush_all){_flushBuffer(true,"maybeFlushBuffer ("+buffer_count+") "+ok_to_flush_why);return}var ok_to_flush_some=ms_since_activity>_flush_one_buffer_user_inactive_ms;TS.log(488,"_maybeFlushBuffer ok_to_flush_some:"+ok_to_flush_some);ok_to_flush_why="window focused, but user has been idle long enough "+ms_since_activity+" >= "+_flush_one_buffer_user_inactive_ms;if(ok_to_flush_some){_flushBuffer(false,"maybeFlushBuffer ("+buffer_count+") "+ok_to_flush_why)}};var _prepareValForStorage=function(val){return typeof val=="string"||typeof val=="number"||!val?val:JSON.stringify(val)};var _correctBadValsFromStorage=function(val){if(val=="undefined")return null;if(val=="null")return null;return val};var _flushBuffer=function(all,why){if(_disabled)return;var begin=new Date;var start=Date.now();var duration;var i=0;var k;var do_log=TS.model&&TS.model.team&&TS.model.team.domain&&TS.model.team.domain==="tinyspeck";var elapsed;var storage_size;var debug_time;var val;for(k in _buffer){if(_buffer[k].being_flushed)continue;val=_prepareValForStorage(_buffer[k].val);if(val===undefined||val===null){_ls.removeItem(k);delete _buffer[k]}else{try{_compressAndStore(k,val)}catch(err){TS.warn("_flushBuffer _ls.setItem failed once, flushing all our keys. TS.storage.storageSize():"+TS.storage.storageSize(false));TS.error(0,err);_removeAllOurKeys();delete _buffer[k];continue}}i++;duration=Date.now()-start;if(do_log){TS.log(488,"_flushBuffer _ls.setItem "+k+": "+duration+"ms "+(_buffer[k]&&_buffer[k].val&&_buffer[k].val.toString?_buffer[k].val.toString().substr(0,100):"NULL?"))}if(!all){elapsed=new Date-begin;if(!_slow_write_logged&&elapsed>_slow_write_threshold){_slow_write_logged=true;debug_time=new Date;try{storage_size=TS.storage.storageSize()}catch(err){}debug_time=new Date-debug_time;TS.logError({message:"Took "+elapsed+"ms for "+i+" item (!all case) (threshold is "+_slow_write_threshold+" ms). Key: "+k+". Buffer length: "+(_buffer[k]&&_buffer[k].val&&_buffer[k].val.toString()?_buffer[k].val.toString().length:"unknown (not a string)")+". localStorage size: "+(storage_size||"unknown")+". Time to read LS size: "+debug_time},"_flushBuffer exceeded slow write threshold")}}if(_buffer[k]){_buffer[k].being_flushed=true}if(!all){TS.log(488,"_flushBuffer: Wrote one item. why: "+why);return}_ls_fetch_cache={}}if(i&&!_slow_all_write_logged){elapsed=new Date-begin;if(elapsed>_slow_write_threshold){_slow_all_write_logged=true;try{storage_size=TS.storage.storageSize()}catch(err){}var message="Took "+elapsed+"ms for "+i+" items (threshold is "+_slow_write_threshold+" ms). localStorage size: "+storage_size+". App open for "+((new Date-TSConnLogger.start_time)/1e3/60).toFixed(2)+" min. why: "+why;TS.logError({message:message},"_flushBuffer exceeded slow write threshold (all case): "+message)}}if(i===0){TS.log(488,"_flushBuffer: Nothing to save.")}else{TS.log(488,"_flushBuffer: Saved "+i+(i===1?" item":" items")+" why: "+why)}};var _get=function(name,default_value,log){var k=_prefix+name;if(log)TS.info("_get name:"+name+" k:"+k+" disabled:"+_disabled+' _buffer["'+k+'"].val:'+(_buffer[k]&&_buffer[k].val));if(_disabled){return _buffer[k]&&_buffer[k].val||default_value}if(k in _buffer){return _buffer[k]&&_buffer[k].val||default_value}if(_ls_fetch_cache.hasOwnProperty(k)){return _ls_fetch_cache[k]}var result=_convertTypeForFetch(k,_decompress(k,_ls.getItem(k)),default_value,log);_ls_fetch_cache[k]=result;return result};var _convertTypeForFetch=function(k,val,default_value,log){var elapsed=new Date;var result=_correctBadValsFromStorage(val);if(log)TS.info("_get _correctBadValsFromStorage(_ls.getItem(k)) k:"+k+" typeof result:"+typeof result+" /^[{[]/.test(result):"+/^[{[]/.test(result));var storage_size;if(result&&typeof result=="string"&&/^[{[]/.test(result)){result=TS.utility.parseJSONOrElse(result)||result}result=result||(default_value!==undefined?default_value:null);elapsed=new Date-elapsed;if(!_slow_get_logged&&elapsed>_slow_get_threshold){_slow_get_logged=true;try{storage_size=TS.storage.storageSize()}catch(err){}TS.logError({message:"Took "+elapsed+"ms to read "+k+" (theshold is "+_slow_get_threshold+"ms), length = "+(result&&!isNaN(result.length)?result.length:"unknown")+". Storage size: "+storage_size},"_get took longer than threshold")}return result};var _set=function(name,value,immediate,log){var failed=false;var elapsed=new Date;var storage_size;var k=_prefix+name;_buffer[k]={val:value,being_flushed:false};_ls_fetch_cache[k]=_buffer[k];if(log)TS.info("_set immediate:"+immediate+" name:"+name+" k:"+k+" disabled:"+_disabled+" do_compression:"+TS.storage.do_compression+' _buffer["'+k+'"].val:'+_buffer[k].val);if(immediate){if(!_disabled){var val=_prepareValForStorage(value);if(val===undefined||val===null){_ls.removeItem(k);delete _buffer[k]}else{try{_compressAndStore(k,val)}catch(err){TS.warn("_set _ls.setItem failed, flushing. TS.storage.storageSize():"+TS.storage.storageSize(false));failed=true}}}if(log)TS.info("_set failed:"+failed);if(!failed){if(log)TS.info('_set _buffer["'+k+'"]:'+(_buffer[k]&&JSON.stringify(_buffer[k])));elapsed=new Date-elapsed;if(elapsed>_slow_set_threshold){TS.warn("_set immediately "+name+": "+elapsed+"ms "+(value&&value.toString?value.toString().substr(0,100):"NULL?"));if(!_slow_set_logged){_slow_set_logged=true;try{storage_size=TS.storage.storageSize()}catch(err){}TS.logError({message:"Took "+elapsed+"ms to write "+k+" (theshold is "+_slow_set_threshold+"ms), length = "+(value&&!isNaN(value.length)?value.length:"unknown")+". Storage length: "+storage_size},"_set exceeded slow set threshold (immediate)")}}else{TS.log(488,"_set GOOD immediately: "+immediate+" "+name+": "+elapsed+"ms "+(value&&value.toString?value.toString().substr(0,100):"NULL?"))}return}}};var _calcLastCacheTS=function(){var k=_prefix+"bots_data";var bots_data_raw=_ls.getItem(k);var bots_data=bots_data_raw&&JSON.parse(_correctBadValsFromStorage(_decompress(k,bots_data_raw)))||null;var k=_prefix+"members_data";var members_data_raw=_ls.getItem(k);var members_data=members_data_raw&&JSON.parse(_correctBadValsFromStorage(_decompress(k,members_data_raw)))||null;if(!TS.model.bots.length&&members_data&&members_data.cache_ts){return members_data.cache_ts}else if(bots_data&&bots_data.cache_ts&&members_data&&members_data.cache_ts){return bots_data.cache_ts<members_data.cache_ts?bots_data.cache_ts:members_data.cache_ts}else{return 0}};var _storeLastCacheTS=function(){if(!TS.model.supports_user_caching)return;var last_cache_ts=_calcLastCacheTS();TS.log(488,"setting last_cache_ts _calcLastCacheTS():"+last_cache_ts);_set("last_cache_ts",last_cache_ts,true)};var _using_macgap_ls=!!(window.macgap&&macgap.ls);var _ls=_using_macgap_ls?macgap.ls:window.localStorage;var _getLs=function(){return _ls};var _setLs=function(ls){_ls=ls};var _compressAndStore=function(k,str){str=String(str);if(TS.storage.do_compression){TS.compression.compress(k,str,_immediate_saves,_afterCompress);return}_afterCompress({k:k,str:str})};var _afterCompress=function(ob){_ls.setItem(ob.k,ob.str);var testAndFinishOrTryAgain=function(i){var from_ls=_ls.getItem(ob.k);if(from_ls===ob.str){if(i>1)TS.warn(ob.k+" now saved, try #"+i);delete _buffer[ob.k];var name=ob.k.replace(_prefix,"");if(name=="bots_data"||name=="members_data"){_storeLastCacheTS()}return}if(i>1&&(!_buffer[ob.k]||_buffer[ob.k].val!=ob.str)){TS.error("buffer changed for "+ob.k+" so we don't care anymore, a new value is being set for it, try #"+i);return}else{TS.error("WTF not saved, try #"+i+" "+ob.k+" "+(ob.str||"").length+" typeof ob.str:"+typeof ob.str+" from_ls:"+typeof from_ls);_ls.setItem(ob.k,ob.str);setTimeout(testAndFinishOrTryAgain,1e3,i+1)}};testAndFinishOrTryAgain(1)};var _decompress=function(k,str){if(!TS.storage.do_compression){return str}return TS.compression.decompress(k,str)}})();(function(){"use strict";TS.registerModule("api",{paused_sig:new signals.Signal,Q_empty_sig:new signals.Signal,onStart:function(){},test:function(){return{_one_at_a_time_methodsA:_one_at_a_time_methodsA,_kickOffACall:_kickOffACall,_makeRequest:_makeRequest,_one_at_a_time_call_pending:_one_at_a_time_call_pending,promisify:_promisify}},call:function(method,args,handler,dont_set_active,progressHandler){return _kickOffACallOrEnqueue(method,args,handler,dont_set_active,progressHandler)},callImmediately:function(method,args,handler,dont_set_active,progressHandler){var top_of_Q=true;if(_one_at_a_time_methodsA.indexOf(method)!=-1){if(_one_at_a_time_call_pending){TS.warn(method+" cannot be called with TS.api.callImmediately, so sending to _kickOffACallOrEnqueue for enqueuing");return _kickOffACallOrEnqueue(method,args,handler,dont_set_active,progressHandler,top_of_Q)}}if(_callsArePaused()){TS.warn(method+" cannot be called with TS.api.callImmediately because we are waiting due to a non-200 response, so sending to _kickOffACallOrEnqueue for enqueuing");return _kickOffACallOrEnqueue(method,args,handler,dont_set_active,progressHandler,top_of_Q)}args=args||{};var p=_promisify(handler);return _kickOffACall(method,args,p,dont_set_active,progressHandler)},callSynchronously:function(method,args,handler,dont_set_active,progressHandler){args=args||{};args._synchronously=true;return TS.api.callImmediately(method,args,handler,dont_set_active,progressHandler)},getCounts:function(){return{_method_call_counts:_method_call_counts,_pending:_pending}},hasPendingRequests:function(){return!!_pending},getQLengths:function(){return{_main_Q:_main_Q.length,_one_at_a_time_Q:_one_at_a_time_Q.length}},isPaused:function(){return _callsArePaused()}});var _ensure_model_methodsA=["activity.mentions","stars.list","files.list","files.info","search.messages","search.files","channels.history","groups.history","ims.history","mpims.history","channels.listShared","groups.listShared"];var _timing_methodsA=["rtm.start","rtm.leanStart","files.list"];var _progress_check_methodsA=["rtm.start","rtm.leanStart","activity.mentions","stars.list","files.list","files.info","apps.list","commands.list","channels.list","emoji.list","help.issues.list","subteams.list","subteams.users.list","test.fastReconnect"];var _one_at_a_time_methodsA=["users.prefs.set","rtm.start","rtm.leanStart","test.fastReconnect"];var _no_retry_methodsA=["dnd.teamInfo"];var _pending=0;var _main_Q=[];var _one_at_a_time_call_pending=false;var _one_at_a_time_Q=[];var _limit=4;var _pause_count=0;var _pause_secs=0;var _pause_interv;var _max_attempts=10;var _timeout_ms=6e4;var _timeout_breathing_room_ms=5e3;var _successful_breathing_ms=100;var _method_call_counts={total_asks:0,total_attempts:0,total_non_200s:0};var _consecutive_500_or_overs=0;var _getMaxAttempts=function(method){if(method=="rtm.start")return 2;if(method=="rtm.leanStart")return 2;if(method=="test.fastReconnect")return 2;return _max_attempts};var _callsArePaused=function(){return _pause_count>0};var _pause=function(delay_ms){_pause_secs=Math.max(_pause_secs,Math.ceil(delay_ms/1e3));_pause_count++;TS.api.paused_sig.dispatch(_pause_count,_pause_secs);clearInterval(_pause_interv);_pause_interv=setInterval(function(){_pause_secs--;if(_pause_secs){TS.api.paused_sig.dispatch(_pause_count,_pause_secs)}else{clearInterval(_pause_interv)}},1e3)};var _maybeUnPause=function(){if(!_pause_count)return;_pause_count=Math.max(0,_pause_count-1);if(_pause_count)return;clearInterval(_pause_interv);TS.api.paused_sig.dispatch(_pause_count,0)};var _incrementPending=function(method){_pending++;if(_one_at_a_time_methodsA.indexOf(method)!=-1){_one_at_a_time_call_pending=true}};var _decrementPending=function(method){_pending--;if(_one_at_a_time_methodsA.indexOf(method)!=-1){_one_at_a_time_call_pending=false}};var _onRequestDone=function(method){_decrementPending(method);if(_callsArePaused())return;_nextFromQ()};var _kickOffACallOrEnqueue=function(method,args,handler,dont_set_active,progressHandler,top_of_Q){args=args||{};if(method=="im.open"&&!args.team){args.team=TS.members.getExternalTeamIdForMemberById(args.user)||""}var p=_promisify(handler);var use_Q;if(_one_at_a_time_methodsA.indexOf(method)!=-1){if(!_callsArePaused()&&!_one_at_a_time_call_pending){return _kickOffACall(method,args,p,dont_set_active,progressHandler)}use_Q=_one_at_a_time_Q}else{if(!_callsArePaused()&&_pending<_limit){return _kickOffACall(method,args,p,dont_set_active,progressHandler)}use_Q=_main_Q}TSConnLogger.log("api_q_"+_makeLogSafeMethodName(method),"TS.api Qing "+method);var o={p:p,method:method,args:args,dont_set_active:dont_set_active,progressHandler:progressHandler};if(top_of_Q){use_Q.unshift(o)}else{use_Q.push(o)}return p.promise};var _kickOffACall=function(method,args,p,dont_set_active,progressHandler){if(p.promise.isCancelled()){TS.log(2,method+" cancelled before call could be made in TS.api");setTimeout(_nextFromQ,1);return p.promise}TSConnLogger.log("api_call_"+_makeLogSafeMethodName(method),"TS.api calling "+method);TS.log(2,'calling method "'+method+'" args._attempts:'+args._attempts);_incrementPending(method);args.token=TS.model.api_token;if(!TS.client&&!dont_set_active){args.set_active=true;TS.model.last_net_send=Date.now()}var start=Date.now();var timing_ob=_startTiming(method,args);var unixtime=Math.round(Date.now()/1e3);var url=TS.model.api_url+method+"?t="+unixtime+TS.getQsArgsForUrl();if((method=="rtm.start"||method=="rtm.leanStart")&&TS.client){url=TS.utility.appendLogToUrlWithLimit(url,TS.ms.getConnectionFlowLog())}if(TS.boot_data.feature_channel_eventlog_client){if(method=="channels.history"||method=="groups.history"||method=="im.history"||method=="mpim.history"){args.visible=1}}var headersHandler=function(){_logTimingForHeaders(timing_ob)};var dataHandler=function(data){var ms=Date.now()-start;TSConnLogger.log("api_complete_"+_makeLogSafeMethodName(method),"TS.api complete "+method+" (took "+ms+"ms)");TS.dir(2,{data:data,args:args},'got api rsp for method "'+method+'" (took '+ms+"ms)");data=data||{ok:false};if(data.ok){_logTimingForCompletion(timing_ob);_callOutsideHandler(method,args,data,p);return{breathing_ms:_successful_breathing_ms,try_again:false}}_cancelTiming(timing_ob);_logError(method,args,data);if(_no_retry_methodsA.indexOf(method)!=-1){TS.warn('NOT re-Qing "'+method+'", as specified');_callOutsideHandler(method,args,data,p);
return{breathing_ms:_successful_breathing_ms,try_again:false}}if(args._attempts>=_getMaxAttempts(method)||args._synchronously){TS.warn('NOT re-Qing api call "'+method+'" because we tried too many times ('+args._attempts+")");_callOutsideHandler(method,args,data,p);return{breathing_ms:_successful_breathing_ms,try_again:false}}if(data.error=="_timeout"){return{breathing_ms:_timeout_breathing_room_ms,try_again:true}}if(data.error=="_badly_formed"){return{breathing_ms:_successful_breathing_ms,try_again:true}}if(data.error=="_http_error"){args._delay_ms=_calculateHTTPErrorDelayMs(method,args,data);if(data.status==429&&!TS.model.ms_logged_in_once){_pause(args._delay_ms)}else if(data.status==503){_pause(args._delay_ms)}else if(data.status>=500){TS.error(_consecutive_500_or_overs);if(_consecutive_500_or_overs>=4){_pause(args._delay_ms)}}_method_call_counts.total_non_200s++;return{breathing_ms:args._delay_ms,try_again:true}}var retry=false;var retry_max_attempts=3;var retry_breathing_ms=_successful_breathing_ms;if(args._attempts<retry_max_attempts){if((method=="search.files"||method=="search.messages")&&data.error=="solr_failed"){retry=true}else if(method=="users.info"&&data.error=="user_not_found"){retry_breathing_ms=1e3*args._attempts;retry=true}}if(retry){return{breathing_ms:retry_breathing_ms,try_again:true}}_callOutsideHandler(method,args,data,p);return{breathing_ms:_successful_breathing_ms,try_again:false}};_makeRequest(url,method,args,p,headersHandler,dont_set_active,progressHandler,dataHandler);return p.promise};var _makeRequest=function(url,method,args,p,headersHandler,dont_set_active,progressHandler,dataHandler){var req=new XMLHttpRequest;var abort_on_slow_progress=_progress_check_methodsA.indexOf(method)!=-1;var progress_timer=0;if(!args._attempts){args._attempts=0;_method_call_counts.total_asks++;_method_call_counts[method]=_method_call_counts[method]?_method_call_counts[method]+1:1}args._attempts++;_method_call_counts.total_attempts++;TS.log(48,method+" count: "+_method_call_counts[method]+" (asks: "+_method_call_counts.total_asks+" attempts: "+_method_call_counts.total_attempts+")");var on200Response=function(){var data=TS.utility.parseJSONOrElse(req.responseText,function(err){TS.warn("unable to do anything with api rsp: "+req.responseText);TS.error(err);return{ok:false,error:"_badly_formed"}});_consecutive_500_or_overs=0;var ret=dataHandler(data);setTimeout(function(){if(ret.try_again)_reQueue(method,args,p,dont_set_active,progressHandler);_onRequestDone(method)},ret.breathing_ms)};var onNon200Response=function(){TSConnLogger.log("api_non_200_"+_makeLogSafeMethodName(method),"TS.api got a "+req.status+" response for method: "+method);if((method=="rtm.start"||method=="rtm.leanStart")&&TS.ms)TS.ms.logConnectionFlow("TS.api got a "+req.status+" response for method: "+method);var data={ok:false,error:"_http_error",status:parseInt(req.status),retry_after:parseInt(req.getResponseHeader&&req.getResponseHeader("Retry-After"))};if(data.status>=500){_consecutive_500_or_overs++}else{_consecutive_500_or_overs=0}var ret=dataHandler(data);setTimeout(function(){if(ret.try_again)_reQueue(method,args,p,dont_set_active,progressHandler);_maybeUnPause();_onRequestDone(method)},ret.breathing_ms)};var timeout=function(){req.onerror=$.noop;req.onreadystatechange=$.noop;req.onprogress=$.noop;req.abort();setProgressTimer=$.noop;var data={ok:false,error:"_timeout",seconds:_timeout_ms};var ret=dataHandler(data);setTimeout(function(){if(ret.try_again)_reQueue(method,args,p,dont_set_active,progressHandler);_onRequestDone(method)},ret.breathing_ms)};p.onCancel=function(){TS.log(2,method+" cancelled and aborted during request in TS.api");req.onerror=$.noop;req.onreadystatechange=$.noop;req.onprogress=$.noop;req.abort();setProgressTimer=$.noop;clearTimeout(progress_timer);setTimeout(_onRequestDone,_successful_breathing_ms,method)};var setProgressTimer=function(perc){TS.log(222,method+" progress: "+(perc!=undefined&&perc!=-1&&perc*100+"%"||perc!=-1&&perc!==0&&perc*100+"%"||"unknown"));if(!abort_on_slow_progress)return;clearTimeout(progress_timer);progress_timer=setTimeout(function(){clearTimeout(progress_timer);TS.ms.logConnectionFlow(method+"_timeout");TS.error(_timeout_ms+"ms passed, no "+method+" progress");timeout()},_timeout_ms)};req.onprogress=function(evt){var perc=evt.lengthComputable?evt.loaded/evt.total:-1;if(abort_on_slow_progress)setProgressTimer(perc);if(progressHandler)progressHandler(perc)};req.onerror=function(e){};req.onreadystatechange=function(){if(req.readyState==1){}else if(req.readyState==2){if(headersHandler)headersHandler(req)}else if(req.readyState==3){}else if(req.readyState==4){req.onprogress({loaded:1,total:1,lengthComputable:true});req.onprogress=$.noop;clearTimeout(progress_timer);if(req.status==200){req.onreadystatechange=null;on200Response()}else{onNon200Response()}}};var encoded_args=Object.keys(args).map(function(k){var encoded_key="";var encoded_args="";try{encoded_key=encodeURIComponent(k)}catch(e){TS.warn("Failed to encode key: "+k);TS.error(e)}try{encoded_args=encodeURIComponent(args[k])}catch(e){TS.warn("Failed to encode args: "+args[k]);TS.error(e)}return encoded_key+"="+encoded_args});req.open("POST",url,!args._synchronously);req.setRequestHeader("Content-Type","application/x-www-form-urlencoded");if(abort_on_slow_progress)setProgressTimer(0);req.send(encoded_args.join("&"))};var _nextFromQ=function(){var o;if(_one_at_a_time_Q.length&&!_one_at_a_time_call_pending){o=_one_at_a_time_Q.shift()}else if(_main_Q.length){o=_main_Q.shift()}if(!o){if(_pending===0){TS.api.Q_empty_sig.dispatch()}return}_kickOffACall(o.method,o.args,o.p,o.dont_set_active,o.progressHandler)};var _startTiming=function(method,args){var complete_label="api_call_"+_makeLogSafeMethodName(method);var headers_label=complete_label+"__headers";var mark_label="start_"+_method_call_counts.total_asks+"_"+complete_label;TS.timing.mark(mark_label);return{args:args,method:method,mark_label:mark_label,headers_label:headers_label,complete_label:complete_label,ephemeral:_timing_methodsA.indexOf(method)===-1}};var _logTimingForHeaders=function(timing_ob){if(!timing_ob)return;TS.timing.measure(timing_ob.headers_label,timing_ob.mark_label,null,{ephemeral:timing_ob.ephemeral});_addSpecialTiming(timing_ob,timing_ob.headers_label)};var _logTimingForCompletion=function(timing_ob){if(!timing_ob)return;TS.timing.measure(timing_ob.complete_label,timing_ob.mark_label,null,{ephemeral:timing_ob.ephemeral});_addSpecialTiming(timing_ob,timing_ob.complete_label);TS.timing.clearMarks(timing_ob.mark_label)};var _addSpecialTiming=function(timing_ob,root_label){if(!timing_ob)return;if(timing_ob.method=="rtm.start"||timing_ob.method=="rtm.leanStart"){var special_label=root_label;special_label+="__dmeliding_"+(timing_ob.args.only_relevant_ims?"yes":"no");special_label+="__usercache_"+(TS.model.supports_user_caching?"yes":"no");if(TS.model.supports_user_caching){if(parseInt(timing_ob.args.cache_ts)){special_label+="__hadcache_yes"}else{if(TS.model.had_bad_user_cache){special_label+="__hadcache_bad";if(root_label==timing_ob.complete_label)TS.model.had_bad_user_cache=false}else{special_label+="__hadcache_no"}}}TS.timing.measure(special_label,timing_ob.mark_label,null,{ephemeral:timing_ob.ephemeral})}};var _cancelTiming=function(timing_ob){if(!timing_ob)return;TS.timing.clearMarks(timing_ob.mark_label)};var _logError=function(method,args,data){if(data.error=="file_deleted"){}else{TS.error('api call "'+method+'" not ok');try{TS.warn("args: "+JSON.stringify(args))}catch(err){TS.warn("could not stringify args")}try{TS.warn("data: "+JSON.stringify(data))}catch(err){TS.warn("could not stringify data")}}};var _callOutsideHandler=function(method,args,data,p){var proceed=function(){p.handler(data.ok,data,args);return Promise.resolve()};if(!data.ok)return proceed();if(_ensure_model_methodsA.indexOf(method)==-1)return proceed();var ensureMembers=function(){TS.log(528,'running api data from "'+method+'" through TS.members.ensureMembersInDataArePresent()');return TS.members.ensureMembersInDataArePresent(data,method,args.channel||undefined).then(proceed).catch(function(err){TS.error(err);return proceed()})};var ensureModelObs=function(){TS.log(528,'running api data from "'+method+'" through TS.shared.ensureModelObsInDataArePresent()');return TS.shared.ensureModelObsInDataArePresent(data,method).then(ensureMembers).catch(function(err){TS.error(err);return proceed()})};ensureModelObs()};var _reQueue=function(method,args,p,dont_set_active,progressHandler){TS.warn('re Qing api call "'+method+'"');var use_Q=_one_at_a_time_methodsA.indexOf(method)!=-1?_one_at_a_time_Q:_main_Q;use_Q.unshift({method:method,args:args,p:p,dont_set_active:dont_set_active,progressHandler:progressHandler})};var _calculateHTTPErrorDelayMs=function(method,args,data){var max_secs;var increase_rate;var retry_after_secs=data.retry_after||0;if(data.status=="429"||data.status=="503"){increase_rate=1.1;retry_after_secs=retry_after_secs||60;max_secs=Math.max(180,parseInt(data.retry_after)||0)}else{increase_rate=1.3;retry_after_secs=1;max_secs=60}var ms=!args._delay_ms?(retry_after_secs+1)*1e3:Math.min(args._delay_ms*increase_rate,max_secs*1e3);ms+=Math.random()*(ms/2);return Math.floor(ms)};var _makeLogSafeMethodName=function(method){return String(method).replace(/\./g,"_")};var _getAPIErrorObject=function(response){var error=new Error("API call not ok");error.data=response.data;error.args=response.args;return error};var _promisify=function(handler){var reject_promise;var resolve_promise;var promise=new Promise(function(resolve,reject,onCancel){resolve_promise=resolve;reject_promise=reject;onCancel(function(){if(typeof handler=="function")TS.error("Because you passed a handler, which is deprecated, this API call has been cancelled but your handler has not been called. Use Promise chaining to cancel and react.");promisfy_obj.onCancel()})});if(typeof handler=="function"){promise=promise.caught($.noop)}var inner_handler=function(ok,data,args){var resp_obj={data:data,args:args};if(ok){resolve_promise(resp_obj)}else{reject_promise(_getAPIErrorObject(resp_obj))}if(handler){handler(ok,data,args)}};var promisfy_obj={promise:promise,handler:inner_handler,onCancel:$.noop};return promisfy_obj}})();(function(){"use strict";TS.registerModule("tips",{onStart:function(){_$body.delegate(".ts_tip_lazy, .ts_tip_float","mouseenter",_onMouseEnter);_$body.delegate(".ts_tip_float","mouseleave",_onMouseLeave);_$body.on("click",".ts_tip",function(){_toggleTipTitle($(this))})},hideAll:function(){$(".ts_tip").addClass("ts_tip_hide")},unhideAll:function(){$(".ts_tip").removeClass("ts_tip_hide")},updateTipTitle:function($tipped_el,tip){var $tip_el=_getTipEl($tipped_el);if($tip_el.length){$tip_el.html(tip)}else{$tipped_el.attr("title",tip)}if(_$tipped_el&&_$tipped_el[0]==$tipped_el[0]){_$floater_tip_el.html(tip);_positionFloater()}},updateFloater:function(args){if(args.title){_$floater_tip_el.text(args.title)}if(args.classes_to_add){_$floater.addClass(args.classes_to_add.join(" "))}}});var _$body=$("BODY");var _$scroller=null;var _$tipped_el=null;var _$floater=null;var _$floater_tip_el=null;var _unhide_ms=10;var _last_tim=0;var _onMouseEnter=function(e){_$tipped_el=$(e.currentTarget);var is_multiline=_$tipped_el.hasClass("ts_tip_multiline");_$tipped_el.addClass("ts_tip_hidden");if(_$tipped_el.children(".ts_tip_tip").length==0){var title=_$tipped_el.prop("title");if(is_multiline){_$tipped_el.append('<span class="ts_tip_tip"><span class="ts_tip_multiline_inner">'+title+"</span></span>")}else{_$tipped_el.append('<span class="ts_tip_tip">'+title+"</span></span>")}}_$tipped_el.removeAttr("title");_$tipped_el.removeClass("ts_tip_lazy");_$body.children("#ts_tip_float_floater").remove();if(_$tipped_el.hasClass("ts_tip_float")){var classes=_$tipped_el.attr("class").split(/\s+/).filter(function(name){if(name=="ts_tip_float")return false;if(name=="ts_tip_lazy")return false;return name.indexOf("ts_tip")===0});var floater_html=TS.templates.builders.strBuilder('<div id="ts_tip_float_floater" style="width:${w}px; height:${h}px;" class="${classes}">${tip_html}</div>',{w:_$tipped_el.width(),h:_$tipped_el.height(),classes:classes.join(" "),tip_html:_$tipped_el.find(".ts_tip_tip").clone()[0].outerHTML});_$floater=$(floater_html);_$body.append(_$floater);_last_tim=setTimeout(function(){_$floater.removeClass("ts_tip_hidden");_positionFloater()},_unhide_ms);_$scroller=_$tipped_el.closest(":scrollable(vertical)");_$scroller.on("scroll.ts_tip_removal",_hideFloater);_$tipped_el.on("destroyed.ts_tip_removal",_hideFloater);if(_$tipped_el.hasClass("ts_tip_hide_on_click")){_$tipped_el.on("click.ts_tip_removal",_hideFloater)}if(is_multiline){_$floater_tip_el=_$floater.find(".ts_tip_multiline_inner")}else{_$floater_tip_el=_$floater.find(".ts_tip_tip_inner");if(!_$floater_tip_el.length)_$floater_tip_el=_$floater.find(".ts_tip_tip")}}else{setTimeout(function(){_$tipped_el.removeClass("ts_tip_hidden")},_unhide_ms)}};var _onMouseLeave=function(e){_hideFloater()};var _hideFloater=function(){clearTimeout(_last_tim);if(_$floater){_$floater.addClass("ts_tip_hidden")}if(_$tipped_el){_$tipped_el.off("click.ts_tip_removal");_$tipped_el.off("destroyed.ts_tip_removal")}if(_$scroller){_$scroller.off("scroll.ts_tip_removal")}_$scroller=null;_$tipped_el=null;_$floater=null;_$floater_tip_el=null};var _positionFloater=function(){var offset=_$tipped_el.offset();var allowance=2;var ww=window.innerWidth-allowance;var wh=window.innerHeight-allowance;var is_mulitline=_$floater.hasClass("ts_tip_multiline");var getRect=function(){if(is_mulitline){return _$floater.find(".ts_tip_multiline_inner").dimensions_rect()}else{return _$floater.find(".ts_tip_tip").dimensions_rect()}};var setHorizontalPositionClass=function(c){_$floater.removeClass("			ts_tip_right 			ts_tip_rightish 			ts_tip_left 			ts_tip_leftish 			ts_tip_multiline_top_leftish 			ts_tip_multiline_top_left 			ts_tip_multiline_top_right 			ts_tip_multiline_top_rightish 		").addClass(c)};_$floater.css("left",offset.left).css("top",offset.top);var rect=getRect();if(rect.bottom>wh){_$floater.removeClass("ts_tip_bottom").addClass("ts_tip_top")}else if(rect.top<allowance){_$floater.removeClass("ts_tip_top").addClass("ts_tip_bottom")}if(is_mulitline){if(rect.right>ww){setHorizontalPositionClass("ts_tip_multiline_top_rightish")}else if(rect.left<allowance){setHorizontalPositionClass("ts_tip_multiline_top_leftish")}rect=getRect();if(rect.right>ww){setHorizontalPositionClass("ts_tip_multiline_top_right")}else if(rect.left<allowance){setHorizontalPositionClass("ts_tip_multiline_top_left")}}else{if(rect.right>ww){setHorizontalPositionClass("ts_tip_rightish")}else if(rect.left<allowance){setHorizontalPositionClass("ts_tip_leftish")}rect=getRect();if(rect.right>ww){setHorizontalPositionClass("ts_tip_right")}else if(rect.left<allowance){setHorizontalPositionClass("ts_tip_left")}}};var _toggleTipTitle=function($tipped_el){var $tip_el=_getTipEl($tipped_el);var toggle_attribute="tip-toggle-auto";var $tip_toggle_el;if($tipped_el.data(toggle_attribute)){$tip_toggle_el=$tipped_el}else if($tip_el.data(toggle_attribute)){$tip_toggle_el=$tip_el}if(!($tip_toggle_el&&$tip_toggle_el.length))return;var current_text=$tip_el.html();var new_text=$tip_toggle_el.data(toggle_attribute);if(!new_text)return TS.warn("No toggle state text defined on tipped element. Please add text to data-tip-toggle-text or data-tip-toggle-auto attribute");TS.tips.updateTipTitle($tipped_el,new_text);$tip_toggle_el.data(toggle_attribute,current_text)};var _getTipEl=function($tipped_el){var $tip_el=$tipped_el.find(".ts_tip_multiline_inner");if(!$tip_el.length)$tip_el=$tipped_el.find(".ts_tip_tip_inner");if(!$tip_el.length)$tip_el=$tipped_el.find(".ts_tip_tip");return $tip_el}})();(function(){"use strict";TS.registerModule("notifs",{onStart:function(){},canCorGHaveChannelMentions:function(c_id){var model_ob=TS.channels.getChannelById(c_id)||TS.groups.getGroupById(c_id)||TS.boot_data.feature_mpim_client&&TS.mpims.getMpimById(c_id);if(!model_ob){TS.error("no model_ob for c_id:"+c_id+"?");return true}return TS.notifs.canModelObHaveChannelMentions(model_ob)},canModelObHaveChannelMentions:function(model_ob){if(model_ob.is_im){return false}if(TS.model.team.prefs.who_can_at_channel=="admin"||TS.model.team.prefs.who_can_at_channel=="owner"){return true}if(model_ob.is_general&&(TS.model.team.prefs.who_can_at_everyone=="admin"||TS.model.team.prefs.who_can_at_everyone=="owner")){return true}if(model_ob.is_general&&(TS.model.team.prefs.who_can_post_general=="admin"||TS.model.team.prefs.who_can_post_general=="owner")){return true}var setting=TS.notifs.getCalculatedCorGNotifySetting(model_ob.id);if(setting!="mentions"&&setting!="nothing"){return true}return!TS.notifs.hasUserSuppressedCorGChannelMentions(model_ob.id)},hasUserSuppressedCorGChannelMentions:function(c_id){var model_ob=TS.channels.getChannelById(c_id)||TS.groups.getGroupById(c_id)||TS.boot_data.feature_mpim_client&&TS.mpims.getMpimById(c_id);if(!model_ob){TS.error("no model_ob for c_id:"+c_id+"?");return true}var i=TS.model.at_channel_suppressed_channels.indexOf(model_ob.id);if(i!=-1)return true;return false},hasUserSuppressedCorGPushChannelMentions:function(c_id){var model_ob=TS.channels.getChannelById(c_id)||TS.groups.getGroupById(c_id)||TS.boot_data.feature_mpim_client&&TS.mpims.getMpimById(c_id);if(!model_ob){TS.error("no model_ob for c_id:"+c_id+"?");return true}var i=TS.model.push_at_channel_suppressed_channels.indexOf(model_ob.id);if(i!=-1)return true;return false},isCorGMuted:function(c_id){if(!c_id){TS.error('wtf no c_id "'+c_id+'"');return false}if(TS.model.muted_channels.indexOf(c_id)>-1){return true}return false},getGlobalPushNotificationSetting:function(){if(TS.model.prefs.push_everything)return"everything";if(TS.model.prefs.push_mention_alert&&TS.model.prefs.push_dm_alert)return"dm_and_mentions";if(TS.model.prefs.push_mention_alert)return"mentions";if(TS.model.prefs.push_dm_alert)return"dms";return"nothing"},getCorGsNotUsingGlobalPushNotificationSetting:function(){var ret={nothing:[],mentions:[],everything:[]};var model_ob;var i;var all={};var id;var A;var global_setting="quiet";if(TS.model.prefs.push_mention_alert)global_setting="mentions";if(TS.model.prefs.push_everything)global_setting="loud";A=TS.model.prefs.push_loud_channels_set?TS.model.prefs.push_loud_channels_set.split(","):[];for(i=0;i<A.length;i++){id=$.trim(A[i]);if(!id)continue;all[id]="quiet"}A=TS.channels.getChannelsForUser();for(i=0;i<A.length;i++){if(!A[i])continue;id=A[i].id;if(TS.notifs.getCalculatedCorGPushNotifySetting(id)!="mentions")continue;if(!TS.notifs.hasUserSuppressedCorGPushChannelMentions(id))continue;all[id]="mentions_suppressed";ret.mentions.push(A[i])}A=TS.model.prefs.push_mention_channels?TS.model.prefs.push_mention_channels.split(","):[];for(i=0;i<A.length;i++){id=$.trim(A[i]);if(!id)continue;if(!all[id])continue;all[id]="mentions"}A=TS.model.prefs.push_loud_channels?TS.model.prefs.push_loud_channels.split(","):[];for(i=0;i<A.length;i++){id=$.trim(A[i]);if(!id)continue;if(!all[id])continue;all[id]="loud"}for(id in all){model_ob=TS.channels.getChannelById(id)||TS.groups.getGroupById(id)||TS.boot_data.feature_mpim_client&&TS.mpims.getMpimById(id);if(!model_ob)continue;if(model_ob.is_archived)continue;if(model_ob.is_channel&&!model_ob.is_member)continue;if(all[id]=="loud"){if(global_setting=="loud")continue;ret.everything.push(model_ob)}else if(all[id]=="mentions"){if(global_setting=="mentions")continue;ret.mentions.push(model_ob)}else if(all[id]=="mentions_suppressed"){}else{if(global_setting=="quiet")continue;ret.nothing.push(model_ob)}}return ret},getGlobalNotificationSetting:function(){if(!TS.model.prefs.growls_enabled)return"nothing";if(TS.model.prefs.all_channels_loud)return"everything";return"mentions"},getCorGsNotUsingGlobalNotificationSetting:function(){var ret={nothing:[],mentions:[],everything:[],muted:[]};var model_ob;var i;var channels=TS.channels.getChannelsForUser();for(i in channels){model_ob=channels[i];if(model_ob.is_archived)continue;if(!model_ob.is_member)continue;if(_isCorGNotifySettingNothingSetSpecifically(model_ob.id))ret.nothing.push(model_ob);if(_isCorGNotifySettingMentionsSetSpecifically(model_ob.id))ret.mentions.push(model_ob);if(_isCorGNotifySettingEverythingSetSpecifically(model_ob.id))ret.everything.push(model_ob);if(TS.notifs.isCorGMuted(model_ob.id))ret.muted.push(model_ob)}for(i in TS.model.groups){model_ob=TS.model.groups[i];if(model_ob.is_archived)continue;if(_isCorGNotifySettingNothingSetSpecifically(model_ob.id))ret.nothing.push(model_ob);if(_isCorGNotifySettingMentionsSetSpecifically(model_ob.id))ret.mentions.push(model_ob);if(_isCorGNotifySettingEverythingSetSpecifically(model_ob.id))ret.everything.push(model_ob);if(TS.notifs.isCorGMuted(model_ob.id))ret.muted.push(model_ob)}if(TS.boot_data.feature_mpim_client){for(i in TS.model.mpims){model_ob=TS.model.mpims[i];if(model_ob.is_archived)continue;if(_isCorGNotifySettingNothingSetSpecifically(model_ob.id))ret.nothing.push(model_ob);if(_isCorGNotifySettingMentionsSetSpecifically(model_ob.id))ret.mentions.push(model_ob);if(_isCorGNotifySettingEverythingSetSpecifically(model_ob.id))ret.everything.push(model_ob);if(TS.notifs.isCorGMuted(model_ob.id))ret.muted.push(model_ob)}}return ret},getCalculatedCorGNotifySetting:function(c_id){if(!c_id){TS.error('wtf no c_id "'+c_id+'"');return false}var is_loud_changed=_isCorGLoudSet(c_id);if(is_loud_changed){if(_isCorGLoud(c_id))return"everything";if(_isCorGNever(c_id))return"nothing";return"mentions"}if(TS.model.prefs.growls_enabled){if(TS.model.prefs.all_channels_loud)return"everything";return"mentions"}return"nothing"},makeCorGMuted:function(c_id){var channel=TS.channels.getChannelById(c_id);var group=TS.groups.getGroupById(c_id);var mpim=TS.boot_data.feature_mpim_client&&TS.mpims.getMpimById(c_id);if(!channel&&!group&&!mpim){TS.error('wtf no channel/group "'+c_id+'"');return false}var i=TS.model.muted_channels.indexOf(c_id);if(i==-1)TS.model.muted_channels.push(c_id);TS.prefs.setMutedChannels(TS.model.muted_channels.join(","));if(!TS.client)return;if(channel)TS.channels.calcUnreadCnts(channel);if(group)TS.groups.calcUnreadCnts(group);if(mpim)TS.mpims.calcUnreadCnts(mpim)},makeCorGNOTMuted:function(c_id){var channel=TS.channels.getChannelById(c_id);var group=TS.groups.getGroupById(c_id);var mpim=TS.boot_data.feature_mpim_client&&TS.mpims.getMpimById(c_id);if(!channel&&!group&&!mpim){TS.error('wtf no channel/group "'+c_id+'"');return false}var i=TS.model.muted_channels.indexOf(c_id);if(i!=-1)TS.model.muted_channels.splice(i,1);TS.prefs.setMutedChannels(TS.model.muted_channels.join(","));if(!TS.client)return;if(channel)TS.channels.calcUnreadCnts(channel);if(group)TS.groups.calcUnreadCnts(group);if(mpim)TS.mpims.calcUnreadCnts(mpim)},makeCorGSuppressed:function(c_id){var channel=TS.channels.getChannelById(c_id);var group=TS.groups.getGroupById(c_id);var mpim=TS.boot_data.feature_mpim_client&&TS.mpims.getMpimById(c_id);if(!channel&&!group&&!mpim){TS.error('wtf no channel/group "'+c_id+'"');return false}var i=TS.model.at_channel_suppressed_channels.indexOf(c_id);if(i==-1)TS.model.at_channel_suppressed_channels.push(c_id);TS.prefs.setSuppressedChannels(TS.model.at_channel_suppressed_channels.join(","));if(!TS.client)return;if(channel)TS.channels.calcUnreadCnts(channel);if(group)TS.groups.calcUnreadCnts(group);if(mpim)TS.mpims.calcUnreadCnts(mpim)},makeCorGNOTSuppressed:function(c_id){var channel=TS.channels.getChannelById(c_id);var group=TS.groups.getGroupById(c_id);var mpim=TS.boot_data.feature_mpim_client&&TS.mpims.getMpimById(c_id);if(!channel&&!group&&!mpim){TS.error('wtf no channel/group "'+c_id+'"');return false}var i=TS.model.at_channel_suppressed_channels.indexOf(c_id);if(i!=-1)TS.model.at_channel_suppressed_channels.splice(i,1);TS.prefs.setSuppressedChannels(TS.model.at_channel_suppressed_channels.join(","));if(!TS.client)return;if(channel)TS.channels.calcUnreadCnts(channel);if(group)TS.groups.calcUnreadCnts(group);if(mpim)TS.mpims.calcUnreadCnts(mpim)},makeCorGPushSuppressed:function(c_id){var channel=TS.channels.getChannelById(c_id);var group=TS.groups.getGroupById(c_id);var mpim=TS.boot_data.feature_mpim_client&&TS.mpims.getMpimById(c_id);if(!channel&&!group&&!mpim){TS.error('wtf no channel/group "'+c_id+'"');return false}var i=TS.model.push_at_channel_suppressed_channels.indexOf(c_id);if(i==-1)TS.model.push_at_channel_suppressed_channels.push(c_id);TS.prefs.setPushSuppressedChannels(TS.model.push_at_channel_suppressed_channels.join(","))},makeCorGNOTPushSuppressed:function(c_id){var channel=TS.channels.getChannelById(c_id);var group=TS.groups.getGroupById(c_id);var mpim=TS.boot_data.feature_mpim_client&&TS.mpims.getMpimById(c_id);if(!channel&&!group&&!mpim){TS.error('wtf no channel/group "'+c_id+'"');return false}var i=TS.model.push_at_channel_suppressed_channels.indexOf(c_id);if(i!=-1)TS.model.push_at_channel_suppressed_channels.splice(i,1);TS.prefs.setPushSuppressedChannels(TS.model.push_at_channel_suppressed_channels.join(","))},makeCorGDTopNothing:function(c_id){var channel=TS.channels.getChannelById(c_id);var group=TS.groups.getGroupById(c_id);var mpim=TS.boot_data.feature_mpim_client&&TS.mpims.getMpimById(c_id);if(!channel&&!group&&!mpim){TS.error('wtf no channel/group "'+c_id+'"');return false}var i=TS.model.loud_channels.indexOf(c_id);if(i!=-1)TS.model.loud_channels.splice(i,1);TS.prefs.setLoudChannels(TS.model.loud_channels.join(","));i=TS.model.never_channels.indexOf(c_id);if(TS.model.prefs.growls_enabled){if(i==-1)TS.model.never_channels.push(c_id);_markCorGAsDTopNonDefault(c_id)}else{if(i!=-1)TS.model.never_channels.splice(i,1);_markCorGAsDTopDefault(c_id)}TS.prefs.setNeverChannels(TS.model.never_channels.join(","))},makeCorGDTopEverything:function(c_id){var channel=TS.channels.getChannelById(c_id);var group=TS.groups.getGroupById(c_id);var mpim=TS.boot_data.feature_mpim_client&&TS.mpims.getMpimById(c_id);if(!channel&&!group&&!mpim){TS.error('wtf no channel/group "'+c_id+'"');return false}var i=TS.model.never_channels.indexOf(c_id);if(i!=-1)TS.model.never_channels.splice(i,1);TS.prefs.setNeverChannels(TS.model.never_channels.join(","));i=TS.model.loud_channels.indexOf(c_id);if(TS.model.prefs.growls_enabled&&TS.model.prefs.all_channels_loud){if(i!=-1)TS.model.loud_channels.splice(i,1);_markCorGAsDTopDefault(c_id)}else{if(i==-1)TS.model.loud_channels.push(c_id);_markCorGAsDTopNonDefault(c_id)}TS.prefs.setLoudChannels(TS.model.loud_channels.join(","))},makeCorGDTopMentions:function(c_id){var channel=TS.channels.getChannelById(c_id);var group=TS.groups.getGroupById(c_id);var mpim=TS.boot_data.feature_mpim_client&&TS.mpims.getMpimById(c_id);if(!channel&&!group&&!mpim){TS.error('wtf no channel/group "'+c_id+'"');return false}var i=TS.model.loud_channels.indexOf(c_id);if(i!=-1)TS.model.loud_channels.splice(i,1);TS.prefs.setLoudChannels(TS.model.loud_channels.join(","));i=TS.model.never_channels.indexOf(c_id);if(i!=-1)TS.model.never_channels.splice(i,1);TS.prefs.setNeverChannels(TS.model.never_channels.join(","));if(TS.model.prefs.growls_enabled&&!TS.model.prefs.all_channels_loud){_markCorGAsDTopDefault(c_id)}else{_markCorGAsDTopNonDefault(c_id)}},makeCorGPushNothing:function(c_id){var channel=TS.channels.getChannelById(c_id);var group=TS.groups.getGroupById(c_id);var mpim=TS.boot_data.feature_mpim_client&&TS.mpims.getMpimById(c_id);if(!channel&&!group&&!mpim){TS.error('wtf no channel/group "'+c_id+'"');return false}var i=TS.model.push_loud_channels.indexOf(c_id);if(i!=-1)TS.model.push_loud_channels.splice(i,1);TS.prefs.setPushLoudChannels(TS.model.push_loud_channels.join(","));i=TS.model.push_mention_channels.indexOf(c_id);if(i!=-1)TS.model.push_mention_channels.splice(i,1);TS.prefs.setPushMentionChannels(TS.model.push_mention_channels.join(","));if(TS.model.prefs.push_everything||TS.model.prefs.push_mention_alert){_markCorGAsPushNonDefault(c_id)}else{_markCorGAsPushDefault(c_id)}},makeCorGPushEverything:function(c_id){var channel=TS.channels.getChannelById(c_id);var group=TS.groups.getGroupById(c_id);var mpim=TS.boot_data.feature_mpim_client&&TS.mpims.getMpimById(c_id);if(!channel&&!group&&!mpim){TS.error('wtf no channel/group "'+c_id+'"');return false}var i=TS.model.push_mention_channels.indexOf(c_id);if(i!=-1)TS.model.push_mention_channels.splice(i,1);TS.prefs.setPushMentionChannels(TS.model.push_mention_channels.join(","));i=TS.model.push_loud_channels.indexOf(c_id);if(TS.model.prefs.push_everything){if(i!=-1)TS.model.push_loud_channels.splice(i,1);_markCorGAsPushDefault(c_id)}else{if(i==-1)TS.model.push_loud_channels.push(c_id);_markCorGAsPushNonDefault(c_id)}TS.prefs.setPushLoudChannels(TS.model.push_loud_channels.join(","))},makeCorGPushMentions:function(c_id){var channel=TS.channels.getChannelById(c_id);var group=TS.groups.getGroupById(c_id);var mpim=TS.boot_data.feature_mpim_client&&TS.mpims.getMpimById(c_id);if(!channel&&!group&&!mpim){TS.error('wtf no channel/group "'+c_id+'"');return false}var i=TS.model.push_loud_channels.indexOf(c_id);if(i!=-1)TS.model.push_loud_channels.splice(i,1);TS.prefs.setPushLoudChannels(TS.model.push_loud_channels.join(","));i=TS.model.push_mention_channels.indexOf(c_id);if(!TS.model.prefs.push_mention_alert||TS.model.prefs.push_everything){if(i==-1)TS.model.push_mention_channels.push(c_id);_markCorGAsPushNonDefault(c_id)}else{if(i!=-1)TS.model.push_mention_channels.splice(i,1);_markCorGAsPushDefault(c_id)}TS.prefs.setPushMentionChannels(TS.model.push_mention_channels.join(","))},getCalculatedCorGPushNotifySetting:function(c_id){if(!c_id){TS.error('wtf no c_id "'+c_id+'"');return false}var is_push_loud_changed=_isCorGPushLoudSet(c_id);if(is_push_loud_changed){if(_isCorGPushLoud(c_id))return"everything";if(_isCorGPushMention(c_id))return"mentions";return"nothing"}if(TS.model.prefs.push_everything)return"everything";if(TS.model.prefs.push_mention_alert)return"mentions";return"nothing"}});var _isCorGLoud=function(c_id){if(!c_id){TS.error('wtf no c_id "'+c_id+'"');return false}if(TS.model.loud_channels.indexOf(c_id)>-1){return true}return false};var _isCorGNever=function(c_id){if(!c_id){TS.error('wtf no c_id "'+c_id+'"');return false}if(TS.model.never_channels.indexOf(c_id)>-1){return true}return false};var _isCorGLoudSet=function(c_id){if(!c_id){TS.error('wtf no c_id "'+c_id+'"');return false}if(TS.model.loud_channels_set&&TS.model.loud_channels_set.indexOf(c_id)>-1){return true}return false};var _isCorGNotifySettingNothingSetSpecifically=function(c_id){if(TS.model.prefs.growls_enabled&&TS.notifs.getCalculatedCorGNotifySetting(c_id)=="nothing"){return true}return false};var _isCorGNotifySettingMentionsSetSpecifically=function(c_id){var setting=TS.notifs.getCalculatedCorGNotifySetting(c_id);if(setting!="mentions")return false;if(!TS.model.prefs.growls_enabled||TS.model.prefs.all_channels_loud){return true}if(TS.notifs.hasUserSuppressedCorGChannelMentions(c_id)){return true}return false};var _isCorGNotifySettingEverythingSetSpecifically=function(c_id){if((!TS.model.prefs.growls_enabled||!TS.model.prefs.all_channels_loud)&&TS.notifs.getCalculatedCorGNotifySetting(c_id)=="everything"){return true}return false};var _isCorGPushLoud=function(c_id){if(!c_id){TS.error('wtf no c_id "'+c_id+'"');return false}if(TS.model.push_loud_channels.indexOf(c_id)>-1){return true}return false};var _isCorGPushMention=function(c_id){if(!c_id){TS.error('wtf no c_id "'+c_id+'"');return false}if(TS.model.push_mention_channels.indexOf(c_id)>-1){return true}return false};var _isCorGPushLoudSet=function(c_id){if(!c_id){TS.error('wtf no c_id "'+c_id+'"');return false}if(TS.model.push_loud_channels_set&&TS.model.push_loud_channels_set.indexOf(c_id)>-1){return true}return false};var _markCorGAsDTopNonDefault=function(c_id){var i=TS.model.loud_channels_set.indexOf(c_id);if(i==-1)TS.model.loud_channels_set.push(c_id);TS.prefs.setLoudChannelsSet(TS.model.loud_channels_set.join(","))};var _markCorGAsDTopDefault=function(c_id){
var i=TS.model.loud_channels_set.indexOf(c_id);if(i!=-1)TS.model.loud_channels_set.splice(i,1);TS.prefs.setLoudChannelsSet(TS.model.loud_channels_set.join(","))};var _markCorGAsPushNonDefault=function(c_id){var i=TS.model.push_loud_channels_set.indexOf(c_id);if(i==-1)TS.model.push_loud_channels_set.push(c_id);TS.prefs.setPushLoudChannelsSet(TS.model.push_loud_channels_set.join(","))};var _markCorGAsPushDefault=function(c_id){var i=TS.model.push_loud_channels_set.indexOf(c_id);if(i!=-1)TS.model.push_loud_channels_set.splice(i,1);TS.prefs.setPushLoudChannelsSet(TS.model.push_loud_channels_set.join(","))}})();(function(){"use strict";TS.registerModule("channels",{switched_sig:new signals.Signal,pre_switched_sig:new signals.Signal,joined_sig:new signals.Signal,member_joined_sig:new signals.Signal,left_sig:new signals.Signal,member_left_sig:new signals.Signal,list_fetched_sig:new signals.Signal,history_fetched_sig:new signals.Signal,history_being_fetched_sig:new signals.Signal,message_received_sig:new signals.Signal,message_removed_sig:new signals.Signal,message_changed_sig:new signals.Signal,marked_sig:new signals.Signal,unread_changed_sig:new signals.Signal,unread_highlight_changed_sig:new signals.Signal,topic_changed_sig:new signals.Signal,purpose_changed_sig:new signals.Signal,created_sig:new signals.Signal,deleted_sig:new signals.Signal,renamed_sig:new signals.Signal,archived_sig:new signals.Signal,unarchived_sig:new signals.Signal,msg_not_sent_sig:new signals.Signal,data_retention_changed_sig:new signals.Signal,data_updated_sig:new signals.Signal,onStart:function(){},addMsg:function(id,msg){var channel=TS.channels.getChannelById(id);if(!channel){TS.error('unknown channel "'+id+'"');return}if(!TS.shared.addMsg(channel,msg))return;var and_mark=!TS.utility.msgs.isTempMsg(msg);TS.channels.calcUnreadCnts(channel,and_mark);TS.utility.msgs.maybeTruncateMsgs(channel);TS.channels.message_received_sig.dispatch(channel,msg)},calcUnreadCnts:function(channel,and_mark){TS.shared.calcUnreadCnts(channel,TS.channels,and_mark)},removeMsg:function(id,msg){var channel=TS.channels.getChannelById(id);if(!channel){TS.error('unknown channel "'+id+'"');return}if(channel._archive_msgs)TS.utility.msgs.spliceMsg(channel._archive_msgs,msg);var msgs=channel.msgs;TS.utility.msgs.spliceMsg(msgs,msg);TS.channels.message_removed_sig.dispatch(channel,msg);TS.utility.msgs.maybeStoreMsgs(channel.id,msgs);TS.channels.calcUnreadCnts(channel,true)},changeMsgText:function(id,msg,txt){var channel=TS.channels.getChannelById(id);if(!channel){TS.error('unknown channel "'+id+'"');return}msg.text=txt;TS.channels.message_changed_sig.dispatch(channel,msg);TS.utility.msgs.maybeStoreMsgs(channel.id,channel.msgs)},sendMsg:function(channel_id,text,in_reply_to_msg){var err_txt;var channel=TS.channels.getChannelById(channel_id);if(!channel)return false;if(channel.is_archived)return false;if(!channel.is_member)return false;var general=TS.channels.getGeneralChannel();var errorOut=function(err_txt,ephemeral_type){if(ephemeral_type){TS.client.ui.addOrFlashEphemeralBotMsg({text:err_txt,ephemeral_type:ephemeral_type})}else{TS.generic_dialog.alert(err_txt).then(function(){if(TS.boot_data.feature_message_replies&&in_reply_to_msg){TS.ui.replies.focusReplyInput()}else{TS.view.focusMessageInput()}})}if(TS.boot_data.feature_message_replies&&in_reply_to_msg){TS.ui.replies.populateReplyInput(text);TS.ui.replies.focusReplyInput()}else{TS.client.ui.$msg_input.val(text);TS.view.focusMessageInput()}};if(channel.is_general&&!TS.members.canUserPostInGeneral()){errorOut("A team owner has restricted posting to the #*"+channel.name+"* channel.","general_posting_restricted");return false}var clean_text=TS.format.cleanMsg(text);var is_at_here=TS.model.here_regex.test(clean_text);var is_at_channel=TS.model.channel_regex.test(clean_text)||TS.model.group_regex.test(clean_text)||is_at_here;var is_at_everyone=TS.model.everyone_regex.test(clean_text)||channel.is_general&&is_at_channel;if(is_at_everyone){if(!TS.members.canUserAtEveryone()){err_txt="<p>A team owner has restricted the use of <b>@everyone</b> messages.</p>";if(TS.model.user.is_restricted){err_txt="<p>Your account is restricted, and you cannot send <b>@everyone</b> messages.</p>"}if(!channel.is_general&&TS.members.canUserAtChannelOrAtGroup()){err_txt+='<p class="no_bottom_margin">If you just want to address everyone in this channel, use <b>@channel</b> instead.</p>'}errorOut(err_txt);return false}if(!channel.is_general&&!is_at_here){if(!general||!general.is_member){err_txt="<p>You cannot send <b>@everyone</b> messages.</p>";if(TS.members.canUserAtChannelOrAtGroup()){err_txt+='<p class="no_bottom_margin">If you just want to address everyone in this channel, use <b>@channel</b> instead.</p>'}errorOut(err_txt)}else{TS.generic_dialog.start({title:"Send @everyone a message",body:'<p class="bold">Would you like to switch to #'+general.name+' and send your message?</p><p class="">Using <b>@everyone</b> in a message is a way to address your whole team, but it must be done in the #'+general.name+' channel.</p><p class="no_bottom_margin">If you just want to address everyone in this channel, use <b>@channel</b> instead.</p>',show_cancel_button:true,show_go_button:true,go_button_text:"Yes, send it",onGo:function(){TS.channels.displayChannel(general.id,text)},onCancel:function(){TS.client.ui.$msg_input.val(text);TS.view.focusMessageInput()}})}return false}}if(is_at_channel&&!TS.members.canUserAtChannelOrAtGroup()){var key_word=is_at_here?"@here":"@channel";err_txt="<p>A team owner has restricted the use of <b>"+key_word+"</b> messages.</p>";errorOut(err_txt);return false}if(TS.ui.needToShowAtChannelWarning(channel_id,text)){TS.ui.at_channel_warning_dialog.startInMessagePane(channel_id,text,TS.channels);return false}return TS.shared.sendMsg(channel_id,text,TS.channels,in_reply_to_msg)},onSendMsg:function(success,imsg){var channel=TS.channels.getChannelById(imsg.SENT_MSG.channel);if(!channel){TS.error("unknown channel? "+imsg.SENT_MSG.channel);return}TS.shared.onSendMsg(success,imsg,channel,TS.channels)},displayChannel:function(channel_id,and_send_txt,from_history,replace_history_state){TS.timing.mark("start_channel_change_"+channel_id);from_history=!!from_history;replace_history_state=!!replace_history_state;var channel=TS.channels.getChannelById(channel_id);if(!channel){TS.error('channel "'+channel_id+'" unknown');return}if(channel._did_defer_initial_msg_history){TS.shared.checkInitialMsgHistory(channel,TS.channels)}if(channel_id==TS.model.active_channel_id&&!replace_history_state){TS.warn('channel "'+channel_id+'" already displayed');if(and_send_txt){TS.channels.sendMsg(channel_id,$.trim(and_send_txt))}return}if(!channel.is_member){if(and_send_txt){TS.model.requested_channel_joins[channel_id]={and_send_txt:and_send_txt};TS.channels.join(channel.name);return}else{TS.client.archives.previous_model_ob=TS.shared.getActiveModelOb()}}var signal=function(){var no_history_add=replace_history_state?false:from_history;if(TS.client.channelDisplaySwitched(channel_id,replace_history_state,no_history_add)){TS.channels.pre_switched_sig.dispatch();TS.channels.switched_sig.dispatch()}if(and_send_txt){TS.channels.sendMsg(channel_id,$.trim(and_send_txt))}return null};if(TS.boot_data.feature_shared_channels_ui&&channel.is_shared){TS.channels.promiseToEnsureChannelsInfo(channel_id,channel.is_shared).then(signal)}else{signal()}},setLastRead:function(channel,ts){if(channel.last_read==ts){return false}if(ts.indexOf(TS.utility.date.fake_ts_unique_padder)>-1){TS.error("bad ts:"+ts);return false}if(channel.last_read>ts){var dont_allow_back_setting=TS.model.last_reads_set_by_client[channel.id+"_"+ts];delete TS.model.last_reads_set_by_client[channel.id+"_"+ts];if(dont_allow_back_setting){TS.warn("NOT going back in time channel.last_read:"+channel.last_read+" new:"+ts);return}TS.info("going back in time channel.last_read:"+channel.last_read+" new:"+ts)}channel.last_read=ts;TS.channels.marked_sig.dispatch(channel);TS.channels.calcUnreadCnts(channel);return true},markMostRecentReadMsg:function(channel,reason){if(!channel){TS.error("channel unknown");return}if(!channel.msgs||!channel.msgs.length)return;var most_recent_valid_ts=TS.utility.msgs.getMostRecentValidTs(channel.msgs);if(!most_recent_valid_ts){TS.warn("no valid tses???");return}channel.all_read_this_session_once=true;TS.channels.markReadMsg(channel.id,most_recent_valid_ts,reason)},markReadMsg:function(channel_id,ts,reason){var channel=TS.channels.getChannelById(channel_id);if(!channel){TS.error('channel "'+channel_id+'" unknown');return}if(channel.last_read==ts){return}if(TS.channels.setLastRead(channel,ts)){channel._marked_reason=reason;if(channel.is_member){channel.needs_api_marking=true}}},onMarked:function(ok,data,args){var channel=TS.channels.getChannelById(args.channel);if(!channel){TS.error('wtf no channel "'+args.channel+'"');return}if(ok||data&&(data.error=="not_in_channel"||data.error=="is_archived")){}else{channel.needs_api_marking=true}},join:function(name,callback,in_background){if(TS.model.user.is_restricted)return;if(!name)return;if(!TS.channels.getChannelByName(name)){if(TS.model.created_channels[name]){return}TS.model.created_channels[name]=true}TS.api.call("channels.join",{name:name,in_background:!!in_background},function(ok,data,args){TS.channels.onJoin(ok,data,args);if(callback){callback(ok,data,args)}if(!ok){delete TS.model.created_channels[name]}})},onJoin:function(ok,data,args){if(!ok){if(data.error=="name_taken"){}else if(data.error=="is_archived"){TS.channels.displayChannel(TS.channels.getChannelByName(args.name).id)}else if(data.error=="restricted_action"){TS.generic_dialog.alert("<p>You don't have permission to create new channels.</p><p>Talk to your team owner.</p>")}else{TS.error("failed to join channel");alert("failed to join channel")}return}var channel_id;var channel;if(data.channel){channel=TS.channels.upsertChannel(data.channel);channel_id=data.channel.id}if(!channel_id){TS.error("no channel_id?!!");return}var and_send_txt="";if(TS.model.requested_channel_joins[channel_id]){and_send_txt=TS.model.requested_channel_joins[channel_id].and_send_txt;delete TS.model.requested_channel_joins[channel_id]}if(!channel){TS.error("no channel?!!");return}if(args.in_background){return}if(!channel.needs_created_message&&!channel.never_needs_joined_msg){channel.needs_joined_message=true}if(TS.client)TS.channels.displayChannel(channel_id,and_send_txt)},leave:function(id){var channel=TS.channels.getChannelById(id);if(!channel)return;if(channel.is_general||TS.model.user.is_restricted){TS.generic_dialog.alert("Sorry, you can't leave <b>#"+channel.name+"</b>!");return}TS.channels.markMostRecentReadMsg(channel,TS.model.marked_reasons.left);TS.client.markLastReadsWithAPI();TS.api.call("channels.leave",{channel:id},TS.channels.onLeave)},onLeave:function(ok,data,args){if(!ok){TS.error("failed to leave channel");return}var channel=TS.channels.getChannelById(args.channel);if(!channel){TS.error('wtf no channel "'+args.channel+'"');return}channel.msgs.length=0;TS.storage.storeMsgs(channel.id,null);if(channel.is_limited)channel.is_limited=false},setTopic:function(id,topic){TS.api.call("channels.setTopic",{channel:id,topic:topic},TS.channels.onSetTopic)},onSetTopic:function(ok,data,args){if(!ok){TS.error("failed to set channel topic");return}},setPurpose:function(id,purpose){TS.api.call("channels.setPurpose",{channel:id,purpose:purpose},TS.channels.onSetPurpose)},onSetPurpose:function(ok,data,args){if(!ok){TS.error("failed to set channel purpose");return}},getChannelById:function(id){var channels=TS.model.channels;var channel=_id_map[id];if(channel){return channel}if(!channels)return null;for(var i=0;i<channels.length;i++){channel=channels[i];if(channel.id==id){TS.warn(id+" not in _id_map?");_id_map[id]=channel;return channel}}return null},getFirstChannelYouAreIn:function(){var channels=TS.model.channels;var channel;if(!channels)return null;for(var i=0;i<channels.length;i++){channel=channels[i];if(channel.is_member)return channel}return null},getGeneralChannel:function(){var channels=TS.model.channels;var channel;for(var i=0;i<channels.length;i++){channel=channels[i];if(channel.is_general)return channel}},getChannelByName:function(name){name=TS.utility.getLowerCaseValue(name);var channels=TS.model.channels;var channel=_name_map[name];if(channel){return channel}if(!channels)return null;for(var i=0;i<channels.length;i++){channel=channels[i];if(channel._name_lc==name||"#"+channel._name_lc==name){TS.warn(name+" not in _name_map?");_name_map["#"+name]=channel;_name_map[name]=channel;return channel}}return null},upsertChannel:function(channel){var channels=TS.model.channels;var existing_channel=TS.channels.getChannelById(channel.id);var members;if(TS.boot_data.feature_no_unread_counts){delete channel.unread_count}if(existing_channel){TS.log(4,'updating existing channel "'+channel.id+'"');for(var k in channel){if(k=="members"){members=channel["members"];existing_channel.members.length=0;for(var i=0;i<members.length;i++){existing_channel.members.push(members[i])}}else if(k==="pinned_items"){if(TS.client){TS.pins.upsertPinnedItems(channel.pinned_items);existing_channel.pinned_items=channel.pinned_items}}else{existing_channel[k]=channel[k]}}channel=existing_channel;if(TS.client&&channel.is_member){TS.shared.checkInitialMsgHistory(channel,TS.channels)}}else{TS.log(4,'adding channel "'+channel.id+'"');channels.push(channel);channel._hotness=0;channel.is_channel=true;channel.is_general=!!channel.is_general;channel._name_lc=TS.utility.getLowerCaseValue(channel.name);channel._show_in_list_even_though_no_unreads=false;_id_map[channel.id]=channel;_name_map[channel._name_lc]=channel;_name_map["#"+channel._name_lc]=channel;if(!channel.members)channel.members=[];if(!channel.topic)channel.topic={};if(!channel.purpose)channel.purpose={};if(!TS.boot_data.feature_no_unread_counts){if(!channel.unread_count)channel.unread_count=0}channel.active_members=[];channel.is_member=!!channel.is_member;channel.oldest_msg_ts=TS.storage.fetchOldestTs(channel.id);channel.last_msg_input=TS.storage.fetchLastMsgInput(channel.id);channel.scroll_top=-1;channel.history_is_being_fetched=false;channel.needs_api_marking=false;channel.unread_highlight_cnt=0;channel.unread_highlights=[];channel.unread_cnt=0;channel.unreads=[];channel.oldest_unread_ts=null;channel.has_fetched_history_after_scrollback=false;if(channel.pinned_items&&TS.client)TS.pins.upsertPinnedItems(channel.pinned_items);if(TS.client){var stored_msgs=channel.is_member?TS.utility.msgs.fetchInitialMsgsFromLS(channel):[];TS.utility.msgs.setMsgs(channel,stored_msgs)}else{if(TS.boot_data.msgs){TS.utility.msgs.ingestMessagesFromBootData(channel)}}if(TS.model.created_channels[channel.name]){channel.needs_created_message=true;delete TS.model.created_channels[channel.name]}}if(channel.is_member&&channel.is_archived){TS.error("channel.is_member and channel.is_archived are both true for "+channel.id+" #"+channel.name);TS.dir(0,channel);channel.is_member=false}if(TS.client){var and_mark=TS.utility.msgs.shouldMarkUnreadsOnMessageFetch();TS.channels.calcUnreadCnts(channel,and_mark)}TS.channels.calcActiveMembersForChannel(channel);return channel},removeChannel:function(channel){var channels=TS.model.channels;TS.log(4,'removing channel "'+channel.id+'"');var c;for(var i=0;i<channels.length;i++){c=channels[i];if(c.id==channel.id){channels.splice(i,1);break}}delete _id_map[channel.id];delete _name_map[channel._name_lc];delete _name_map["#"+channel._name_lc];if(TS.client){if(TS.model.active_channel_id==channel.id){TS.client.activeChannelDisplayGoneAway()}}channel.msgs.length=0;TS.storage.storeMsgs(channel.id,null);if(channel.is_limited)channel.is_limited=false;TS.channels.deleted_sig.dispatch(channel)},channelRenamed:function(channel){var existing_channel=TS.channels.getChannelById(channel.id);delete _name_map[existing_channel._name_lc];delete _name_map["#"+existing_channel._name_lc];var new_channel=TS.channels.upsertChannel(channel);new_channel._name_lc=TS.utility.getLowerCaseValue(new_channel.name);_name_map[new_channel._name_lc]=new_channel;_name_map["#"+new_channel._name_lc]=new_channel;TS.channels.renamed_sig.dispatch(new_channel)},markScrollTop:function(id,scroll_top){var channel=TS.channels.getChannelById(id);if(!channel)return false;if(channel.scroll_top==scroll_top){return false}channel.scroll_top=scroll_top;return true},maybeLoadScrollBackHistory:function(id,force){var channel=TS.channels.getChannelById(id);if(!channel)return false;return TS.shared.maybeLoadScrollBackHistory(channel,TS.channels,force)},onHistory:function(ok,data,args){var channel=TS.channels.getChannelById(args.channel);if(!channel){TS.error('wtf no channel "'+args.channel+'"');return}var start_mark="start_channel_history_fetch_"+channel.id;if(TS.timing.getLatestMark(start_mark)){TS.timing.measure("channel_history_fetch",start_mark);TS.timing.clearMarks(start_mark)}if(!ok||!data||!data.messages){TS.error("failed to get history");channel.history_fetch_retries?channel.history_fetch_retries++:channel.history_fetch_retries=1;TS.channels.history_fetched_sig.dispatch(channel);return}delete channel.history_fetch_retries;var fetching_more=TS.shared.onHistory(channel,data,args,TS.channels);if(!fetching_more){channel.history_is_being_fetched=false;TS.channels.history_fetched_sig.dispatch(channel)}var and_mark=TS.utility.msgs.shouldMarkUnreadsOnMessageFetch();TS.channels.calcUnreadCnts(channel,and_mark)},fetchHistory:function(channel,api_args,handler){if(!channel){TS.error('wtf no channel "'+channel+'"');return}channel.history_is_being_fetched=true;channel.history_fetch_failed=false;TS.channels.history_being_fetched_sig.dispatch(channel);if(channel.history_fetch_retries>5){delete channel.history_fetch_retries;channel.history_is_being_fetched=false;channel.history_fetch_failed=true;if(TS.client)TS.client.msg_pane.updateEndMarker();return}TS.api.call("channels.history",api_args,handler||TS.channels.onHistory)},topicChanged:function(channel,user_id,ts,topic){if(!channel.topic)channel.topic={};channel.topic.creator=user_id;channel.topic.last_set=ts;channel.topic.value=topic;TS.channels.topic_changed_sig.dispatch(channel,user_id,topic)},purposeChanged:function(channel,user_id,ts,purpose){if(!channel.purpose)channel.purpose={};channel.purpose.creator=user_id;channel.purpose.last_set=ts;channel.purpose.value=purpose;TS.channels.purpose_changed_sig.dispatch(channel,user_id,purpose)},closeArchivedChannel:function(id){TS.shared.closeArchivedChannel(id)},makeMembersWithPreselectsForTemplate:function(A,preselected_ids){preselected_ids=preselected_ids||[];var ret=[];for(var i=0;i<A.length;i++){var member=A[i];var preselected=preselected_ids.indexOf(member.id)!=-1;ret[i]={member:member,preselected:preselected}}return ret},getActiveMembersNotInThisChannelForInviting:function(id,act_like_an_admin){var A=[];var is_admin=act_like_an_admin||TS.model.user.is_admin;if(TS.model.user.is_ultra_restricted)return A;var channel=TS.channels.getChannelById(id);if(!channel)return A;var member;var active_members=TS.members.getActiveMembersWithSelfAndNotSlackbot();for(var m=0;m<active_members.length;m++){member=active_members[m];if(member.is_ultra_restricted)continue;if(!is_admin&&member.is_restricted)continue;if(channel.members.indexOf(member.id)==-1){A.push(member)}}return A},calcActiveMembersForChannel:function(channel){channel.active_members.length=0;if(!channel.members)return;var member;for(var m=0;m<channel.members.length;m++){member=TS.members.getMemberById(channel.members[m]);if(!member)continue;if(member.deleted)continue;channel.active_members.push(member.id)}},calcActiveMembersForAllChannels:function(){var channels=TS.model.channels;for(var i=0;i<channels.length;i++){TS.channels.calcActiveMembersForChannel(channels[i])}},fetchList:function(){TS.api.call("channels.list",{exclude_members:1},TS.channels.onListFetched)},onListFetched:function(ok,data,args){if(!ok){TS.error("failed to fetch channel list");return}$.each(data.channels,function(i,channel){TS.channels.upsertChannel(channel)});TS.channels.list_fetched_sig.dispatch(data.channels)},kickMember:function(id,member_id){if(!TS.members.canUserKickFromChannels())return;var channel=TS.channels.getChannelById(id);if(!channel)return;return TS.shared.kickMember(channel,member_id)},getChannelsForUser:function(){if(!TS.model.user.is_restricted){return TS.model.channels}_users_channels.length=0;var channel;for(var i=0;i<TS.model.channels.length;i++){channel=TS.model.channels[i];if(!channel.is_member)continue;_users_channels.push(channel)}return _users_channels},getUnarchivedChannelsForUser:function(){_unarchived_channels.length=0;var channels=TS.channels.getChannelsForUser();var channel;for(var i=0;i<channels.length;i++){channel=channels[i];if(channel.is_archived)continue;_unarchived_channels.push(channel)}return _unarchived_channels},setDataRetention:function(channel_id,retention_type,retention_duration,handler){var args={channel:channel_id,retention_type:$("select[name=retention_type]").val()};if(args.retention_type==1){args.retention_duration=$("#retention_duration").val()}TS.api.call("channels.setRetention",args,function(ok,data,args){if(handler){handler(ok,data,args)}if(ok){TS.channels.data_retention_changed_sig.dispatch(args)}})},getDataRetention:function(channel_id,handler){TS.api.call("channels.getRetention",{channel:channel_id},handler)},promiseToEnsureChannelsInfo:function(channel_id,include_shared){return TS.api.callImmediately("channels.info",{channel:channel_id,include_shared:include_shared}).then(function(response){TS.channels.upsertChannel(response.data.channel);return TS.members.ensureMembersArePresent(response.data.channel.members,_.fill(Array(response.data.channel.members.length),channel_id))}).catch(function(error){return Promise.reject(Error("displayChannel channels.info api call failed when trying to display channel: "+channel_id))})}});var _users_channels=[];var _unarchived_channels=[];var _id_map={};var _name_map={}})();(function(){"use strict";TS.registerModule("channels.ui",{onStart:function(){},showDataRetentionDialog:function(channel_id,handler,retention_type,retention_duration){var load_retention_data=!retention_type;var channel,im,group,mpim;channel=TS.channels.getChannelById(channel_id);if(!channel)im=TS.ims.getImById(channel_id);if(!channel&&!im&&TS.boot_data.feature_mpim_client)mpim=TS.mpims.getMpimById(channel_id);if(!channel&&!im&&!mpim)group=TS.groups.getGroupById(channel_id);if(!im&&!channel&&!group&&!mpim){TS.error("unknown channel_id passed to data retention dialog:"+channel_id);return}var channel_name,model_type;if(channel){model_type="channel";channel_name="#"+TS.utility.htmlEntities(channel.name)}else if(im||mpim){model_type="conversation";channel_name="this conversation"}else{model_type="channel";channel_name=TS.utility.htmlEntities(group.name)}var team_type=TS.model.team.prefs.retention_type;var team_duration=TS.model.team.prefs.retention_duration;if(group){team_type=TS.model.team.prefs.group_retention_type;team_duration=TS.model.team.prefs.group_retention_duration}else if(im||mpim){team_type=TS.model.team.prefs.dm_retention_type;team_duration=TS.model.team.prefs.dm_retention_duration}var modal_body=_retentionDialogLoadingHtml();if(!load_retention_data){modal_body=TS.templates.channel_data_retention_dialog({model_type:model_type,retention_type:retention_type,retention_duration:retention_duration,team_type:team_type,team_duration:team_duration})}TS.generic_dialog.start({title:"Edit retention policy for "+channel_name,body:modal_body,go_button_text:"Save settings",enter_always_gos:true,onGo:function(){var type=$("select[name=retention_type]").val();var duration=$("#retention_duration").val();if(type===null)return;if(duration===null)return;if(channel){TS.channels.setDataRetention(channel_id,type,duration,handler)}else if(im){TS.ims.setDataRetention(channel_id,type,duration,handler)}else if(mpim){TS.mpims.setDataRetention(channel_id,type,duration,handler)}else{TS.groups.setDataRetention(channel_id,type,duration,handler)}},onShow:load_retention_data?null:_onShowDataRetentionDialog});if(load_retention_data){if(channel){TS.channels.getDataRetention(channel_id,_onChannelsGetRetention)}else if(im){TS.ims.getDataRetention(channel_id,_onImGetRetention)}else if(mpim){TS.mpims.getDataRetention(channel_id,_onImGetRetention)}else{TS.groups.getDataRetention(channel_id,_onGroupsGetRetention)}}},showArchiveChannelDialog:function(model_ob){TS.generic_dialog.start({title:"Archive #"+model_ob.name,body:"<p>Archiving a channel is useful to clean things up when you do not anticipate using the channel any more. If you archive this channel:</p> 			<ul> 				<li>No one will be able to send messages to it anymore</li> 				<li>It will be closed for anyone who has it open and all members will be removed</li> 				<li>You will be able to view past conversations in the Archives on the site</li> 				<li>You will be able to search for archived messages from this channel</li> 				<li>You will always be able to un-archive it later</li> 			</ul> 			<p>Are you sure you want to archive <b>#"+model_ob.name+"</b>?</p>",go_button_text:"Yes, archive the channel",onGo:function(){TS.api.call("channels.archive",{channel:model_ob.id},function(ok,data,args){if(ok){if(TS.web){$("p.alert").addClass("hidden");$("#archive_success").removeClass("hidden");$("#archive_btn").addClass("hidden");$("#unarchive_btn").removeClass("hidden")}return}var err_str='Archiving failed with error "'+data.error+'"';if(data.error=="last_ra_channel"){if(TS.model.user.is_admin){err_str="Sorry, you can't archive this channel because it is the only "+TS.templates.builders.channelOrGroupCopy()+" one of the guest account members belongs to. If you first disable the guest account, you will then be able to archive the channel."}else{err_str="Sorry, you can't archive this channel because it is the only "+TS.templates.builders.channelOrGroupCopy()+" one of the guest account members belongs to."}}else if(data.error=="restricted_action"){err_str="<p>You don't have permission to archive channels.</p><p>Talk to your team owner.</p>"}else if(data.error=="already_archived"){err_str="This channel was already archived."}else if(data.error=="cant_archive_general"){err_str="This channel cannot be archived."}setTimeout(TS.generic_dialog.alert,500,err_str)})}})},showArchiveGroupDialog:function(model_ob,and_leave){var title=and_leave?"Leave and archive "+TS.model.group_prefix+model_ob.name:"Archive "+TS.model.group_prefix+model_ob.name;var group_label=TS.templates.builders.groupCopy({skip_private:true});var go_button_text=and_leave?"Yes, leave & archive the "+group_label:"Yes, archive the "+group_label;TS.generic_dialog.start({title:title,body:"<p>If you archive this "+group_label+", no one will be able to send any messages in it and it will be closed for anyone who currently has it open. You will still be able to view the archives on the site and you will still be able to search for messages from this "+group_label+".</p><p>Are you sure you want to archive <b>"+TS.model.group_prefix+model_ob.name+"</b>?</p>",go_button_text:go_button_text,onGo:function(){TS.api.call("groups.archive",{channel:model_ob.id},function(ok,data,args){if(ok){if(and_leave&&TS.client){TS.shared.closeArchivedChannel(model_ob.id)}if(TS.web){$("p.alert").addClass("hidden");$("#archive_success").removeClass("hidden");$("#archive_btn").addClass("hidden");$("#unarchive_btn").removeClass("hidden")}return}var err_str='Archiving failed with error "'+data.error+'"';if(data.error=="last_ra_channel"){if(TS.model.user.is_admin){err_str="Sorry, you can't archive this "+group_label+" because it is the only "+TS.templates.builders.channelOrGroupCopy()+" one of the guest account members belongs to. If you first disable the guest account, you will then be able to archive the "+group_label+"."}else{err_str="Sorry, you can't archive this "+group_label+" because it is the only "+TS.templates.builders.channelOrGroupCopy()+" one of the guest account members belongs to."}}else if(data.error=="already_archived"){err_str="This "+group_label+" was already archived."}setTimeout(TS.generic_dialog.alert,500,err_str)})}})},channelCreateDialogShowNameTakenAlert:function(div){div.find(".modal_input_note").addClass("hidden");div.find(".name_taken_warning").removeClass("hidden");$("#channel_create_title").select()},channelCreateDialogShowDisallowedCharsAlert:function(div){div.find(".modal_input_note").addClass("hidden");div.find(".invalid_chars_warning").removeClass("hidden");$("#channel_create_title").select()},channelCreateDialogShowSinglePunctuationAlert:function($div){$div.find(".modal_input_note").addClass("hidden");$div.find(".single_punctuation_warning").removeClass("hidden");$("#channel_create_title").select()},channelCreateDialogShowOtherErrorAlert:function($div,text){if(!text)text="Sorry! Something went wrong.";$div.find(".modal_input_note").addClass("hidden");$div.find(".other_error").removeClass("hidden").find(".error_message").text(text)},channelCreateDialogValidateInput:function(div){var title=div.find(".title_input").val();var clean_title=TS.utility.cleanChannelName(title);while(title.substr(0,1)=="#")title=title.substr(1);if(clean_title!=title){div.find(".title_input").val(clean_title);TS.channels.ui.channelCreateDialogShowDisallowedCharsAlert(div);return false}if(clean_title==="_"||clean_title==="-"){TS.channels.ui.channelCreateDialogShowSinglePunctuationAlert(div);return false}if(!title){$("#channel_create_title").select();return false}if(TS.channels.getChannelByName(title)||TS.groups.getGroupByName(title)||TS.members.getMemberByName(title)){TS.channels.ui.channelCreateDialogShowNameTakenAlert(div);return false}return true}});var _onChannelsGetRetention=function(ok,data,args){if(ok){var type=data.retention.retention_type;var duration=data.retention.retention_duration;_replaceDataRetentionLoadingAnimation("channel",type,duration)}else{_replaceDataRetentionLoadingAnimationWithError("channel",data)}};var _onGroupsGetRetention=function(ok,data,args){if(ok){var type=data.retention.retention_type;var duration=data.retention.retention_duration;_replaceDataRetentionLoadingAnimation("group",type,duration)}else{_replaceDataRetentionLoadingAnimationWithError("group",data)}};var _onImGetRetention=function(ok,data,args){if(ok){var type=data.retention.retention_type;var duration=data.retention.retention_duration;_replaceDataRetentionLoadingAnimation("conversation",type,duration)}else{_replaceDataRetentionLoadingAnimationWithError("conversation",data)}};var _replaceDataRetentionLoadingAnimation=function(model_type,type,duration){var anim=$("#generic_dialog .loading_hash_animation");var team_type=TS.model.team.prefs.retention_type;var team_duration=TS.model.team.prefs.retention_duration;if(model_type==="group"){team_type=TS.model.team.prefs.group_retention_type;team_duration=TS.model.team.prefs.group_retention_duration}else if(model_type==="conversation"){team_type=TS.model.team.prefs.dm_retention_type;team_duration=TS.model.team.prefs.dm_retention_duration}if(model_type==="group"){model_type="channel"}anim.replaceWith(TS.templates.channel_data_retention_dialog({model_type:model_type,retention_type:type,retention_duration:duration,team_type:team_type,team_duration:team_duration}));_onShowDataRetentionDialog()};var _replaceDataRetentionLoadingAnimationWithError=function(model_type,data){var anim=$("#generic_dialog .loading_hash_animation");if(data.error==="no_perms"||data.error==="is_archived"||data.error==="not_paid"){if(model_type==="group"){model_type="channel"}anim.replaceWith('<p class="no_bottom_margin">Sorry! You can\'t change the retention duration for this '+model_type+".</p>")}else{anim.replaceWith('<p class="no_bottom_margin">Oops! Something went wrong. Please try again.</p>')}};var _onShowDataRetentionDialog=function(){$("select[name=retention_type]").change(function(){if(this.value!=1){$("#team_retention_pref").removeClass("hidden");
$("#retention_duration_container, #retention_duration_warning").addClass("hidden")}else{$("#team_retention_pref").addClass("hidden");$("#retention_duration_container, #retention_duration_warning").removeClass("hidden");if($("#retention_duration").val()===0){$("#retention_duration").val("")}$("#retention_duration").focus()}}).change()};var _retentionDialogLoadingHtml=function(){var url=cdn_url+"/f85a/img/loading_hash_animation_@2x.gif";return'<div class="loading_hash_animation" style="margin: 2rem;"><img src="'+url+'" alt="Loading" /><br />loading...</div>'}})();TS.registerModule("constants",{onStart:$.noop,avatar_size_map:{20:{standard:"image_24",retina:"image_48"},24:{standard:"image_24",retina:"image_48"},32:{standard:"image_32",retina:"image_72"},36:{standard:"image_48",retina:"image_72"},48:{standard:"image_48",retina:"image_72"},64:{standard:"image_64",retina:"image_64"},72:{standard:"image_72",retina:"image_192"},192:{standard:"image_192",retina:"image_192"}},restricted_overlay:{standard:cdn_url+"/0180/img/avatar_overlays.png",retina:cdn_url+"/0180/img/avatar_overlays_@2x.png"}});(function(){"use strict";TS.registerModule("groups",{switched_sig:new signals.Signal,pre_switched_sig:new signals.Signal,joined_sig:new signals.Signal,member_joined_sig:new signals.Signal,left_sig:new signals.Signal,member_left_sig:new signals.Signal,history_fetched_sig:new signals.Signal,history_being_fetched_sig:new signals.Signal,message_received_sig:new signals.Signal,message_removed_sig:new signals.Signal,message_changed_sig:new signals.Signal,marked_sig:new signals.Signal,unread_changed_sig:new signals.Signal,unread_highlight_changed_sig:new signals.Signal,topic_changed_sig:new signals.Signal,purpose_changed_sig:new signals.Signal,deleted_sig:new signals.Signal,renamed_sig:new signals.Signal,opened_sig:new signals.Signal,closed_sig:new signals.Signal,archived_sig:new signals.Signal,unarchived_sig:new signals.Signal,msg_not_sent_sig:new signals.Signal,data_retention_changed_sig:new signals.Signal,onStart:function(){},addMsg:function(id,msg){var group=TS.groups.getGroupById(id);if(!group){TS.error('unknown group "'+id+'"');return}if(!TS.shared.addMsg(group,msg))return;var and_mark=!TS.utility.msgs.isTempMsg(msg);TS.groups.calcUnreadCnts(group,and_mark);TS.utility.msgs.maybeTruncateMsgs(group);TS.groups.message_received_sig.dispatch(group,msg);if(!group.is_open){TS.api.call("groups.open",{channel:group.id},TS.groups.onOpened)}},calcUnreadCnts:function(group,and_mark){TS.shared.calcUnreadCnts(group,TS.groups,and_mark)},removeMsg:function(id,msg){var group=TS.groups.getGroupById(id);if(!group){TS.error('unknown group "'+id+'"');return}if(group._archive_msgs)TS.utility.msgs.spliceMsg(group._archive_msgs,msg);var msgs=group.msgs;TS.utility.msgs.spliceMsg(msgs,msg);TS.groups.message_removed_sig.dispatch(group,msg);TS.utility.msgs.maybeStoreMsgs(group.id,msgs);TS.groups.calcUnreadCnts(group,true)},changeMsgText:function(id,msg,txt){var group=TS.groups.getGroupById(id);if(!group){TS.error('unknown group "'+id+'"');return}msg.text=txt;TS.groups.message_changed_sig.dispatch(group,msg);TS.utility.msgs.maybeStoreMsgs(group.id,group.msgs)},sendMsg:function(group_id,text,in_reply_to_msg){return TS.shared.sendMsgGroup(group_id,text,TS.groups,in_reply_to_msg)},onSendMsg:function(success,imsg){var group=TS.groups.getGroupById(imsg.SENT_MSG.channel);if(!group){TS.error("unknown group? "+imsg.SENT_MSG.channel);return}TS.shared.onSendMsg(success,imsg,group,TS.groups)},closeGroup:function(id){var group=TS.groups.getGroupById(id);if(!group){return}TS.api.call("groups.close",{channel:id},TS.groups.onClosed)},onClosed:function(ok,data,args){if(!ok){return}if(data.no_op){var group=TS.groups.getGroupById(args.channel);if(group){group.is_open=false;if(group.is_archived)group.was_archived_this_session=false;if(TS.model.active_group_id==group.id){if(TS.client)TS.client.activeChannelDisplayGoneAway()}TS.groups.closed_sig.dispatch(group)}}},onOpened:function(ok,data){if(!ok){return}},displayGroup:function(group_id,and_send_txt,from_history,replace_history_state){TS.timing.mark("start_channel_change_"+group_id);from_history=!!from_history;replace_history_state=!!replace_history_state;var group=TS.groups.getGroupById(group_id);if(!group){TS.error('group "'+group_id+'" unknown');return}if(group._did_defer_initial_msg_history){TS.shared.checkInitialMsgHistory(group,TS.groups)}TS.info("displayGroup "+group.name+" from_history:"+from_history+" replace_history_state:"+replace_history_state);if(group_id==TS.model.active_group_id&&!replace_history_state){TS.warn('group "'+group_id+'" already displayed');if(and_send_txt){TS.groups.sendMsg(group_id,$.trim(and_send_txt))}return}var no_history_add=replace_history_state?false:from_history;if(TS.client.channelDisplaySwitched(group_id,replace_history_state,no_history_add)){TS.groups.pre_switched_sig.dispatch();TS.groups.switched_sig.dispatch()}if(group.is_open){if(and_send_txt){TS.groups.sendMsg(group_id,$.trim(and_send_txt))}return}TS.model.requested_group_opens[group_id]={and_send_txt:and_send_txt};TS.api.call("groups.open",{channel:group.id},TS.groups.onOpened)},setLastRead:function(group,ts){if(group.last_read==ts){return false}if(ts.indexOf(TS.utility.date.fake_ts_unique_padder)>-1){TS.error("bad ts:"+ts);return false}if(group.last_read>ts){var dont_allow_back_setting=TS.model.last_reads_set_by_client[group.id+"_"+ts];delete TS.model.last_reads_set_by_client[group.id+"_"+ts];if(dont_allow_back_setting){TS.warn("NOT going back in time group.last_read:"+group.last_read+" new:"+ts);return}TS.info("going back in time group.last_read:"+group.last_read+" new:"+ts)}group.last_read=ts;TS.groups.marked_sig.dispatch(group);TS.groups.calcUnreadCnts(group);return true},markMostRecentReadMsg:function(group,reason){if(!group){TS.error("group unknown");return}if(!group.msgs||!group.msgs.length)return;var most_recent_valid_ts=TS.utility.msgs.getMostRecentValidTs(group.msgs);if(!most_recent_valid_ts){TS.warn("no valid tses???");return}group.all_read_this_session_once=true;TS.groups.markReadMsg(group.id,most_recent_valid_ts,reason)},markReadMsg:function(group_id,ts,reason){var group=TS.groups.getGroupById(group_id);if(!group){TS.error('group "'+group_id+'" unknown');return}if(group.last_read==ts){return}if(TS.groups.setLastRead(group,ts)){group._marked_reason=reason;group.needs_api_marking=true}},onMarked:function(ok,data,args){var group=TS.groups.getGroupById(args.channel);if(!group){TS.error('wtf no group "'+args.channel+'"');return}if(ok||data&&data.error=="is_archived"){}else{group.needs_api_marking=true}},create:function(name,and_invite_members_idsA,callback){if(!name)return;TS.model.created_groups[name]=true;var and_invite_members_ids_str=and_invite_members_idsA?and_invite_members_idsA.join(","):"";TS.api.call("groups.create",{name:name,and_invite_members_ids:and_invite_members_ids_str},function(ok,data,args){TS.groups.onCreate(ok,data,args);if(callback){callback(ok,data,args)}})},createChild:function(group_id,and_invite_members_idsA,callback){var group=TS.groups.getGroupById(group_id);if(!group)return;TS.model.archives_and_recreated_groups[group_id]=true;var and_invite_members_ids_str=and_invite_members_idsA?and_invite_members_idsA.join(","):"";TS.api.call("groups.createChild",{channel:group_id,and_invite_members_ids:and_invite_members_ids_str},function(ok,data,args){TS.groups.onCreate(ok,data,args);if(callback){callback(ok,data,args)}})},onCreate:function(ok,data,args){if(!ok){if(data.error=="name_taken"){}else if(data.error=="restricted_action"){}else{TS.error("failed to create group");alert("failed to create group")}return}var group;var group_id;if(data.group){group=TS.groups.upsertGroup(data.group);group_id=data.group.id}if(!group_id){TS.error("no group_id?!!");return}if(!group){TS.error("no group?!!");return}var and_invite_members_ids=args.and_invite_members_ids?args.and_invite_members_ids.split(","):null;if(and_invite_members_ids){for(var i=0;i<and_invite_members_ids.length;i++){TS.api.call("groups.invite",{channel:group_id,user:and_invite_members_ids[i]})}}if(TS.client)TS.groups.displayGroup(group_id)},getLeaveAction:function(group_id){if(TS.model.user.is_ultra_restricted)return"";if(!TS.groups.canLeaveGroup(group_id))return"";var group=TS.groups.getGroupById(group_id);if(group.is_archived){return"close"}else if(group.active_members.length===1){return"leave_and_archive"}else{return"leave"}},leave:function(id){var group=TS.groups.getGroupById(id);if(!group){TS.error("WTF no group:"+id);return}var leave_action=TS.groups.getLeaveAction(id);if(leave_action==="close"){TS.shared.closeArchivedChannel(id)}else if(leave_action==="leave_and_archive"){TS.channels.ui.showArchiveGroupDialog(group,true)}else if(leave_action==="leave"){TS.generic_dialog.start({title:"Leave "+TS.model.group_prefix+group.name,body:"<p>If you leave the "+TS.templates.builders.groupCopy()+", you will no longer be able to see any of its messages. To rejoin the "+TS.templates.builders.groupCopy()+", you will have to be re-invited.</p><p>Are you sure you wish to leave?</p>",go_button_text:"Yes, leave the "+TS.templates.builders.groupCopy(),onGo:function(){TS.api.call("groups.leave",{channel:id},TS.groups.onLeave)}})}else{TS.generic_dialog.alert("Sorry, you can't leave <b>"+TS.model.group_prefix+group.name+"</b>!")}},onLeave:function(ok,data,args){if(!ok){if(data&&data.error=="last_member"){TS.shared.closeArchivedChannel(args.channel);return}TS.error("failed to leave group");return}var group=TS.groups.getGroupById(args.channel);if(!group){TS.error('wtf no group "'+args.channel+'"');return}group.msgs.length=0;TS.storage.storeMsgs(group.id,null);if(group.is_limited)group.is_limited=false},setTopic:function(id,topic){TS.api.call("groups.setTopic",{channel:id,topic:topic},TS.groups.onSetTopic)},onSetTopic:function(ok,data,args){if(!ok){TS.error("failed to set group topic");return}},setPurpose:function(id,purpose){TS.api.call("groups.setPurpose",{channel:id,purpose:purpose},TS.groups.onSetPurpose)},onSetPurpose:function(ok,data,args){if(!ok){TS.error("failed to set group purpose");return}},getGroupById:function(id){var groups=TS.model.groups;var group=_id_map[id];if(group){return group}if(!groups)return null;for(var i=0;i<groups.length;i++){group=groups[i];if(group.id==id){TS.warn(id+" not in _id_map?");_id_map[id]=group;return group}}return null},getGroupByName:function(name){name=TS.utility.getLowerCaseValue(name);var groups=TS.model.groups;var group=_name_map[name];if(group){return group}if(!groups)return null;for(var i=0;i<groups.length;i++){group=groups[i];if(group._name_lc==name||TS.model.group_prefix+group._name_lc==name){TS.warn(name+" not in _name_map?");_name_map[name]=group;_name_map[TS.model.group_prefix+name]=group;return group}}return null},upsertGroup:function(group){var groups=TS.model.groups;var existing_group=TS.groups.getGroupById(group.id);var members;if(TS.boot_data.feature_no_unread_counts){delete group.unread_count}if(existing_group){TS.log(4,'updating existing group "'+group.id+'"');for(var k in group){if(k=="members"){members=group["members"];existing_group.members.length=0;for(var i=0;i<members.length;i++){existing_group.members.push(members[i])}}else if(k==="pinned_items"){if(TS.client){TS.pins.upsertPinnedItems(group.pinned_items);existing_group.pinned_items=group.pinned_items}}else{existing_group[k]=group[k]}}group=existing_group;if(TS.client){TS.shared.checkInitialMsgHistory(group,TS.groups)}}else{TS.log(4,'adding group "'+group.id+'"');groups.push(group);group._hotness=0;group.is_group=true;group._name_lc=TS.utility.getLowerCaseValue(group.name);group._show_in_list_even_though_no_unreads=false;_id_map[group.id]=group;_name_map[group._name_lc]=group;_name_map[TS.model.group_prefix+group._name_lc]=group;group.active_members=[];group.oldest_msg_ts=TS.storage.fetchOldestTs(group.id);group.last_msg_input=TS.storage.fetchLastMsgInput(group.id);group.scroll_top=-1;group.history_is_being_fetched=false;group.needs_api_marking=false;group.unread_highlight_cnt=0;group.unread_highlights=[];group.unread_cnt=0;group.unreads=[];group.oldest_unread_ts=null;group.has_fetched_history_after_scrollback=false;if(group.pinned_items&&TS.client)TS.pins.upsertPinnedItems(group.pinned_items);if(TS.client){var stored_msgs=TS.utility.msgs.fetchInitialMsgsFromLS(group);TS.utility.msgs.setMsgs(group,stored_msgs)}else{if(TS.boot_data.msgs){TS.utility.msgs.ingestMessagesFromBootData(group)}}if(TS.model.created_groups[group.name]){delete TS.model.created_groups[group.name]}}if(TS.client){var and_mark=TS.utility.msgs.shouldMarkUnreadsOnMessageFetch();TS.groups.calcUnreadCnts(group,and_mark)}TS.groups.calcActiveMembersForGroup(group);return group},removeGroup:function(group){var groups=TS.model.groups;TS.log(4,'removing group "'+group.id+'"');var c;for(var i=0;i<groups.length;i++){c=groups[i];if(c.id==group.id){groups.splice(i,1);break}}delete _id_map[group.id];delete _name_map[group._name_lc];delete _name_map[TS.model.group_prefix+group._name_lc];if(TS.client){if(TS.model.active_group_id==group.id){TS.client.activeChannelDisplayGoneAway()}}group.msgs.length=0;TS.storage.storeMsgs(group.id,null);if(group.is_limited)group.is_limited=false;TS.groups.deleted_sig.dispatch(group)},groupRenamed:function(group){var existing_group=TS.groups.getGroupById(group.id);delete _name_map[existing_group._name_lc];delete _name_map[TS.model.group_prefix+existing_group._name_lc];var new_group=TS.groups.upsertGroup(group);new_group._name_lc=TS.utility.getLowerCaseValue(new_group.name);_name_map[new_group._name_lc]=new_group;_name_map[TS.model.group_prefix+new_group._name_lc]=new_group;TS.groups.renamed_sig.dispatch(new_group)},markScrollTop:function(id,scroll_top){var group=TS.groups.getGroupById(id);if(!group)return false;if(group.scroll_top==scroll_top){return false}group.scroll_top=scroll_top;return true},maybeLoadScrollBackHistory:function(id,force){var group=TS.groups.getGroupById(id);if(!group)return false;return TS.shared.maybeLoadScrollBackHistory(group,TS.groups,force)},onHistory:function(ok,data,args){var group=TS.groups.getGroupById(args.channel);if(!group){TS.error('wtf no group "'+args.channel+'"');return}if(!ok||!data||!data.messages){TS.error("failed to get history");group.history_fetch_retries?group.history_fetch_retries++:group.history_fetch_retries=1;TS.groups.history_fetched_sig.dispatch(group);return}delete group.history_fetch_retries;var fetching_more=TS.shared.onHistory(group,data,args,TS.groups);if(!fetching_more){group.history_is_being_fetched=false;TS.groups.history_fetched_sig.dispatch(group)}var and_mark=TS.utility.msgs.shouldMarkUnreadsOnMessageFetch();TS.groups.calcUnreadCnts(group,and_mark)},fetchHistory:function(group,api_args,handler){if(!group){TS.error('wtf no group "'+group+'"');return}group.history_is_being_fetched=true;group.history_fetch_failed=false;TS.groups.history_being_fetched_sig.dispatch(group);if(group.history_fetch_retries>5){delete group.history_fetch_retries;group.history_is_being_fetched=false;group.history_fetch_failed=true;if(TS.client)TS.client.msg_pane.updateEndMarker();return}TS.api.call("groups.history",api_args,handler||TS.groups.onHistory)},topicChanged:function(group,user_id,ts,topic){if(!group.topic)group.topic={};group.topic.creator=user_id;group.topic.last_set=ts;group.topic.value=topic;TS.groups.topic_changed_sig.dispatch(group,user_id,topic)},purposeChanged:function(group,user_id,ts,purpose){if(!group.purpose)group.purpose={};group.purpose.creator=user_id;group.purpose.last_set=ts;group.purpose.value=purpose;TS.groups.purpose_changed_sig.dispatch(group,user_id,purpose)},getUnarchivedClosedGroups:function(id){_unarchived_closed_groups.length=0;var groups=TS.model.groups;var group;for(var i=0;i<groups.length;i++){group=groups[i];if(group.is_archived)continue;if(group.is_open)continue;_unarchived_closed_groups.push(group)}return _unarchived_closed_groups},getUnarchivedGroups:function(){_unarchived_groups.length=0;var groups=TS.model.groups;var group;for(var i=0;i<groups.length;i++){group=groups[i];if(group.is_archived)continue;_unarchived_groups.push(group)}return _unarchived_groups},getActiveMembersNotInThisGroupForInviting:function(id,act_like_an_admin){var model_ob=TS.shared.getModelObById(id);if(!model_ob)return[];return _getActiveMembersForInvitingWorker(act_like_an_admin,model_ob)},getActiveMembersForInviting:function(act_like_an_admin){return _getActiveMembersForInvitingWorker(act_like_an_admin)},getGroupsWithTheseActiveMembers:function(members_idsA){var A=[];var groups=TS.model.groups;var group;var members_ids_str=members_idsA.sort().join(",");var groups_active_members;var member;for(var i=0;i<groups.length;i++){group=groups[i];group.members.sort();groups_active_members=[];for(var m=0;m<group.members.length;m++){member=TS.members.getMemberById(group.members[m]);if(!member)continue;if(member.deleted)continue;groups_active_members.push(member.id)}if(members_ids_str==groups_active_members.join(",")){A.push(group)}}return A},calcActiveMembersForGroup:function(group){group.active_members.length=0;if(!group.members)return;var member;for(var m=0;m<group.members.length;m++){member=TS.members.getMemberById(group.members[m]);if(!member)continue;if(member.deleted)continue;group.active_members.push(member.id)}},calcActiveMembersForAllGroups:function(){var groups=TS.model.groups;for(var i=0;i<groups.length;i++){TS.groups.calcActiveMembersForGroup(groups[i])}},createSuggestedName:function(member_idsA){var name=TS.model.user.name;var membersA=[];var member;var i;var max_l=TS.model.channel_name_max_length;for(i=0;i<member_idsA.length;i++){member=TS.members.getMemberById(member_idsA[i]);if(!member)continue;membersA.push(member)}membersA.sort(function compare(a,b){if(a.id==TS.ui.group_create_dialog.start_member_id)return-1;if(b.id==TS.ui.group_create_dialog.start_member_id)return 1;var a_srt=a._name_lc;var b_srt=b._name_lc;if(a_srt<b_srt)return-1;if(a_srt>b_srt)return 1;return 0});for(i=0;i<membersA.length;i++){member=membersA[i];name+="-"+member.name.split("-")[0]}if(name.length>max_l){name=name.substr(0,max_l);if(name.charAt(name.length-1)=="-"){name=name.substr(0,max_l-1)}}var name_root=name;var suffix=1;var suffix_str;while(TS.channels.getChannelByName(name)||TS.groups.getGroupByName(name)||TS.members.getMemberByName(name)){suffix_str=(suffix+1).toString();suffix++;name=name_root+suffix_str;if(name.length>max_l){name=name_root.substr(0,max_l-suffix_str.length)+suffix_str}}return name},kickMember:function(id,member_id){if(!TS.members.canUserKickFromGroups())return;var group=TS.groups.getGroupById(id);if(!group)return;return TS.shared.kickMember(group,member_id)},canLeaveGroup:function(group_id){if(!TS.model.user.is_restricted)return true;if(TS.model.user.is_ultra_restricted)return false;if(TS.channels.getChannelsForUser().length)return true;var groups=TS.model.groups;var group;for(var i=0;i<groups.length;i++){group=groups[i];if(group.is_archived)continue;if(group.id==group_id)continue;return true}return false},setDataRetention:function(group_id,retention_type,retention_duration,handler){var args={channel:group_id,retention_type:$("select[name=retention_type]").val()};if(args.retention_type==1){args.retention_duration=$("#retention_duration").val()}TS.api.call("groups.setRetention",args,function(ok,data,args){if(handler){handler(ok,data,args)}if(ok){TS.groups.data_retention_changed_sig.dispatch(args)}})},getDataRetention:function(group_id,handler){TS.api.call("groups.getRetention",{channel:group_id},handler)}});var _id_map={};var _name_map={};var _unarchived_closed_groups=[];var _unarchived_groups=[];var _getActiveMembersForInvitingWorker=function(act_like_an_admin,group){var A=[];if(TS.model.user.is_ultra_restricted&&!act_like_an_admin)return A;var members_for_user=TS.members.getMembersForUser();var member;for(var m=0;m<members_for_user.length;m++){member=members_for_user[m];if(member.deleted)continue;if(member.is_slackbot)continue;if(member.is_self)continue;if(member.is_ultra_restricted)continue;if(!group||group.members.indexOf(member.id)==-1){A.push(member)}}return A}})();(function(){"use strict";TS.registerModule("files",{member_files_fetched_sig:new signals.Signal,team_files_fetched_sig:new signals.Signal,team_file_added_sig:new signals.Signal,team_file_deleted_sig:new signals.Signal,team_file_changed_sig:new signals.Signal,team_file_comment_added_sig:new signals.Signal,team_file_comment_edited_sig:new signals.Signal,team_file_comment_deleted_sig:new signals.Signal,file_uploaded_sig:new signals.Signal,file_uploading_sig:new signals.Signal,file_progress_sig:new signals.Signal,file_canceled_sig:new signals.Signal,file_queue_emptied_sig:new signals.Signal,channel_files_fetched_sig:new signals.Signal,user_changed_public_url_sig:new signals.Signal,uploadQ:[],uploading:false,polling_count:0,polling_file_id:null,polling_ticket:null,polling_tim:null,polling_handler:null,waiting_for_refresh:{},onStart:function(){},isFilePrivate:function(file){return!file.is_public&&!file.is_external&&!file.is_shared},isFileUntitled:function(file){return file.name=="-"},createPublicURL:function(file,callback){if(TS.model.team.prefs.disallow_public_file_urls){return}TS.api.callImmediately("files.sharedPublicURL",{file:file.id},function(ok,data,args){if(ok){TS.files.upsertAndSignal({id:file.id,public_url_shared:true});TS.files.user_changed_public_url_sig.dispatch(data.file)}else if(data.error&&data.error==="not_allowed"){TS.model.team.prefs.disallow_public_file_urls=true;TS.generic_dialog.alert("An administator has disabled public file URL creation. You will not be able to create a public URL for this space.")}if(callback&&typeof callback=="function"){callback(ok,data,args)}})},createSpace:function(callback){TS.api.callSynchronously("files.createSpace",{},function(ok,data,args){if(ok){var file=TS.files.upsertAndSignal(data.file).file;if(TS.web)TS.ssb.upsertFileInSSBParentWin(file);callback(file)}else{TS.generic_dialog.alert('<p class="no_bottom_margin">Oops! Something went wrong. Please try again.</p>');callback(null)}})},createAndOpenNewSpace:function(optional_callback,open_in_browser){TS.files.createSpace(function(file){if(file){var qs=TS.model.active_cid?"?origin_channel="+TS.model.active_cid:"";var url=file.permalink+qs;if(open_in_browser||!TS.ssb.openNewFileWindow(file,url,qs)){TS.utility.openInNewTab(url,file.id)}}if(typeof optional_callback=="function"){optional_callback(file)}})},promptForFileUnshare:function(file_id,c_id){var channel=TS.channels.getChannelById(c_id);if(!channel)var group=TS.groups.getGroupById(c_id);if(!group)group=TS.mpims.getMpimById(c_id);if(!group&&!channel)return;TS.generic_dialog.start({title:"Un-share file",body:"<p>Are you sure you want to un-share this file from the <b>"+(channel?"#"+channel.name+"</b> channel":group.name+"</b> "+TS.templates.builders.groupCopy())+"?</p>					<p>Un-sharing the file will not remove existing share and comment messages, but it will keep any future comments from appearing 					in the "+(channel?"channel":TS.templates.builders.groupCopy({skip_private:true}))+".</p>",show_cancel_button:true,show_go_button:true,go_button_text:"Yes, unshare this file",cancel_button_text:"Cancel",onGo:function(){TS.files.unshareFile(file_id,c_id)}})},shareFile:function(id,channel_id,comment,share_quietly,callback){var share_args={file:id,channel:channel_id,comment:comment||""};share_args["resharing_aware"]=true;if(share_quietly){share_args["share_quietly"]=true}TS.api.call("files.share",share_args,function(ok,data,args){TS.files.onFileShare(ok,data,args);if(callback)callback(ok,data,args)})},onFileShare:function(ok,data,args){if(!ok){return}TS.files.fetchFileInfo(args.file,function(id,file){TS.templates.builders.updateFileShareLabels(file);if(TS.web){TS.files.upsertAndSignal(file)}});if(TS.web){var file=TS.files.getFileById(args.file);if(file.mode==="post")TS.web.file.onPostShare(ok,data,args);if(TS.web.space){TS.web.space.onFileShare(ok,data,args)}}},unshareFile:function(id,channel_id,callback){TS.api.call("files.unshare",{file:id,channel:channel_id},function(ok,data,args){TS.files.onFileUnShare(ok,data,args);if(callback){callback(id,TS.files.getFileById(id))}})},onFileUnShare:function(ok,data,args){if(!ok){return}else{TS.files.fetchFileInfo(args.file,function(id,file){TS.templates.builders.updateFileShareLabels(file);if(TS.web){TS.files.upsertAndSignal(file)}})}},fetchFileInfo:function(id,callback){TS.api.call("files.info",{file:id,page:1,count:500,truncate:1},function(ok,data,args){TS.files.onFileFetch(ok,data,args);if(callback){callback(id,TS.files.getFileById(id))}})},fetchFileInfoNEW:function(id,callback){if(!id){TS.error("WTF no file id for fetchFileInfo()?");return}if(_info_fetching_map[id]){if(callback)_info_fetching_map[id].callbacks.push(callback);if(id=="F02CLF8UA")TS.warn("NOT FETCHING "+id+" ****************************************************************************************");return}_info_fetching_map[id]={callbacks:[callback]};TS.api.call("files.info",{file:id,truncate:1},function(ok,data,args){TS.files.onFileFetch(ok,data,args);var callbacks=_info_fetching_map[args.file].callbacks;callbacks.forEach(function(cb,i){if(cb)cb(args.file,TS.files.getFileById(args.file))});delete _info_fetching_map[args.file]})},onFileFetch:function(ok,data,args){if(!ok){if(data.error=="file_deleted"){var existing_file=TS.files.getFileById(args.file);if(existing_file){TS.files.removeFile(existing_file.id)}else if(args.file){TS.files.removeFile(args.file)}}else if(data.error=="file_not_found"){TS.files.removeFile(args.file)}return}if(data.file){data.file.comments=data.comments;data.file.content=data.content;data.file.content_html=data.content_html;data.file.content_highlight_html=data.content_highlight_html;TS.files.upsertAndSignal(data.file)}},fetchTeamFiles:function(types){types=TS.model.file_list_types;var types_str=types&&types.length?types.join(","):"";TS.api.call("files.list",{types:types_str},TS.files.onTeamFetch)},onTeamFetch:function(ok,data,args){if(!ok){return}if(data.files){var file;for(var i=0;i<data.files.length;i++){file=data.files[i];TS.files.upsertFile(file)}}TS.files.team_files_fetched_sig.dispatch(TS.model.files)},fetchMemberFiles:function(id,types){var types_str=types&&types.length?types.join(","):"";TS.api.call("files.list",{user:id,types:types_str},TS.files.onMemberFetch)},onMemberFetch:function(ok,data,args){if(!ok){return}if(data.files){var file;for(var i=0;i<data.files.length;i++){file=data.files[i];TS.files.upsertFile(file)}}TS.files.team_files_fetched_sig.dispatch(TS.model.files);var member=TS.members.getMemberById(args.user);TS.files.member_files_fetched_sig.dispatch(member)},fetchChannelFiles:function(id,callback,count,types){var types_str=types&&types.length?types.join(","):"";if(callback){TS.api.call("files.list",{channel:id,types:types_str,count:count},function(ok,data,args){if(ok){TS.files.onChannelFetch(ok,data,args)}callback(ok,data,args)})}else{TS.api.call("files.list",{channel:id,types:types_str},TS.files.onChannelFetch)}},onChannelFetch:function(ok,data,args){if(!ok){return}if(data.files){var file;for(var i=0;i<data.files.length;i++){file=data.files[i];TS.files.upsertFile(file)}}TS.files.channel_files_fetched_sig.dispatch(args.channel,data.files)},addComment:function(id,comment,callback){TS.api.callImmediately("files.comments.add",{file:id,comment:comment},function(ok,data,args){TS.files.onFileComment(ok,data,args);if(callback){callback(ok,data,args)}})},onFileComment:function(ok,data,args){if(!ok){return}var file=TS.files.getFileById(args.file);if(!file){TS.error("no file? "+args.file);return}TS.files.addCommentToFile(data.comment,file)},getFileById:function(id){return TS.files.getFileByProp("id",id)},getFileByDownloadUrlPrivate:function(url){return TS.files.getFileByProp("url_private_download",url)},getFileByProp:function(name,value){if(!name)return null;if(!value)return null;var files=TS.model.files;var file;for(var i=0;i<files.length;i++){file=files[i];if(file[name]==value)return file}return null},getFileActions:function(file){if(!file)return;var actions={};var file_belongs_to_user=false;if(file.user==TS.model.user.id)file_belongs_to_user=true;if(file.is_public){actions.share=true}else if(file_belongs_to_user){actions.share=true}else{actions.share_private_file=true}actions.comment=true;if(!file.public_url_shared&&file.mode!="external"&&!TS.model.user.is_restricted&&!TS.model.team.prefs.disallow_public_file_urls){if(file.is_public){actions.create_public_link=true}else if(file_belongs_to_user){actions.create_public_link=true}}if(file.public_url_shared&&!TS.model.user.is_restricted&&(TS.model.user.is_admin||file_belongs_to_user)&&!TS.model.team.prefs.disallow_public_file_urls){actions.revoke_public_link=true}if(file.mode=="hosted"||file.mode=="snippet"){actions.download=true}if(file.mimetype&&file.mimetype.indexOf("image/")===0||file.mode=="external"||file.mode=="snippet"||file.mode=="email"){actions.open_original=true}if(TS.web){if(file.mode=="post"||file.mode=="snippet"||file.mode=="space"||file.mode=="email"){actions.print=true}}if(file.mode=="space"&&TS.boot_data.feature_spaces&&!(file.user==="USLACKBOT"&&file.name==="Getting_Started_with_Posts")){actions.learn_more=true}if(file.mode=="space"){actions.new_window=true}if(TS.boot_data.feature_pass_the_baton&&file.mode=="space")actions.edit=true;if(file_belongs_to_user){if(file.mode=="snippet"||file.mode=="post"||file.mode=="space"){actions.edit=true}if(file.mode=="hosted"||file.mode=="email"){actions.edit_title=true}actions.delete_file=true}if(TS.model.user.is_admin){actions.delete_file=true}if(file.mode=="external"){if(file_belongs_to_user||TS.model.user.is_admin){actions.refresh=true}}if(window.Dropbox&&Dropbox.isBrowserSupported()&&TS.model.prefs.dropbox_enabled){if(file.mode=="hosted"){actions.save_to_dropbox=true}}if(TS.client){var model_ob=TS.shared.getActiveModelOb();if(TS.pins.canUserPinHere(model_ob)){if(file.pinned_to&&file.pinned_to.indexOf(model_ob.id)!==-1){actions.unpin_file=true}else{var can_pin=!!file.is_public;if(file.channels){can_pin=can_pin||file.channels.indexOf(model_ob.id)!==-1}else{TS.warn("No channels array for file object in getFileActions(): "+file.id)}if(file.groups){can_pin=can_pin||file.groups.indexOf(model_ob.id)!==-1}else{TS.warn("No groups array for file object in getFileActions(): "+file.id)}if(file.ims){can_pin=can_pin||file.ims.indexOf(model_ob.id)!==-1}else{TS.warn("No ims array for file object in getFileActions(): "+file.id)}if(can_pin)actions.pin_file=true}}}actions.rxn_file=true;return actions},getFileCommentActions:function(comment,file){if(!comment)return{};var actions={can_edit:true,can_delete:true};if(comment.user!=TS.model.user.id){actions.can_edit=false}else if(TS.model.team.prefs.msg_edit_window_mins>-1&&(Date.now()-TS.utility.date.toDateObject(comment.timestamp))/6e4>TS.model.team.prefs.msg_edit_window_mins){actions.can_edit=false}if(!TS.model.team.prefs.allow_message_deletion){if(!TS.model.user.is_admin){actions.can_delete=false}}else if(comment.user!=TS.model.user.id){if(!TS.model.user.is_admin){actions.can_delete=false}}if(TS.client){var model_ob=TS.shared.getActiveModelOb();if(TS.pins.canUserPinHere(model_ob)){if(comment.pinned_to&&comment.pinned_to.indexOf(model_ob.id)!==-1){actions.can_unpin=true}else{var can_pin=!!file.is_public;if(file.channels){can_pin=can_pin||file.channels.indexOf(model_ob.id)!==-1}else{TS.warn("No channels array for file object in getFileCommentActions(): "+file.id)}if(file.groups){can_pin=can_pin||file.groups.indexOf(model_ob.id)!==-1}else{TS.warn("No groups array for file object in getFileCommentActions(): "+file.id)}if(file.ims){can_pin=can_pin||file.ims.indexOf(model_ob.id)!==-1}else{TS.warn("No ims array for file object in getFileCommentActions(): "+file.id)}if(can_pin)actions.can_pin=true}}}actions.rxn_file_comment=true;return actions},getThumbSrcForFile:function(file,options){if(typeof file==="string")file=TS.files.getFileById(file);
if(!file||!file.thumb_360&&!file.thumb_360_gif)return false;if(!options)options={};if(!options.max_size)options.max_size=480;if(file.thumb_480_gif||file.thumb_360_gif){if(options.max_size>360&&file.thumb_480_gif)return file.thumb_480_gif;if(file.thumb_360_gif)return file.thumb_360_gif}if(options.max_size>480&&file.thumb_1024)return file.thumb_1024;if(options.max_size>360&&file.thumb_960)return file.thumb_960;if(file.thumb_720)return file.thumb_720;if(file.thumb_480)return file.thumb_480;return file.thumb_360},fileIsImage:function(file){if(typeof file==="string")file=TS.files.getFileById(file);if(!file)return false;var has_thumb=file.thumb_360||file.thumb_360_gif;var gdrive_native=file.external_type==="gdrive"&&file.mimetype.indexOf("image/")<0;return has_thumb&&!gdrive_native},getFileTemplateArguments:function(file,image_1x_max_size){var args={};args.current_user_id=TS.model.user.id;args.file_partial="generic";if(/(snippet|post|email)/.test(file.mode))args.file_partial=file.mode;if(/(space)/.test(file.mode))args.file_partial="post";if(TS.files.fileIsImage(file)){args.file_partial="image";args.image_src=TS.files.getThumbSrcForFile(file,{max_size:image_1x_max_size});args.image_width=image_1x_max_size===360?file.thumb_360_w:file.thumb_480_w||file.thumb_360_w;args.image_height=image_1x_max_size===360?file.thumb_360_h:file.thumb_480_h||file.thumb_360_h;args.preserve_aspect_ratio=args.image_width>0&&args.image_height>0&&TS.utility.cssCalcSupported();args.preview_actions_class="";if(args.image_width<170||args.image_height<50){args.preview_actions_class+=" overflow_preview_actions"}if(args.image_width<170){args.preview_actions_class+=" overflow_preview_actions_width"}}if(/(post|space|email|generic)/.test(args.file_partial))args.title_hider=true;if(file.mode=="snippet")args.title_hider=file.title==="Untitled";args.filesize=file.size>2e4&&!/(gdoc|gpres|gsheet|gdraw)/.test(file.filetype);if(!/(space|post)/.test(file.filetype))args.meta_filetype=TS.templates.builders.makeFiletypeHTML(file);if(TS.templates.builders.makeExternalFiletypeHTML(file)===args.meta_filetype)args.meta_filetype=false;if(/(mp4|mov)/.test(file.filetype))args.file_is_video=true;return args},sortFiles:function(files){function compare(a,b){if(a.timestamp<b.timestamp)return 1;if(a.timestamp>b.timestamp)return-1;return 0}files.sort(compare)},getFileCommentById:function(file,comment_id){var comment;for(var i=0;i<file.comments.length;i++){comment=file.comments[i];if(comment.id==comment_id)return comment}return null},addCommentToFile:function(comment,file){var exisiting_comment=TS.files.getFileCommentById(file,comment.id);if(exisiting_comment){return exisiting_comment}comment._rxn_key=TS.rxns.getRxnKey("file_comment",comment.id);TS.rxns.upsertRxnsFromDataAndUpdateUI(comment._rxn_key,comment.reactions);delete comment.reactions;file.comments.push(comment);TS.files.sortCommentsOnFile(file);TS.files.team_file_comment_added_sig.dispatch(file,comment);return comment},editCommentOnFile:function(comment,file){var was_comment;var good=false;var initial_comment_changed=false;for(var i=0;i<file.comments.length;i++){was_comment=file.comments[i];if(was_comment.id==comment.id){good=true;file.comments[i]=comment;if(was_comment.is_starred){comment.is_starred=true}if(was_comment._rxn_key){comment._rxn_key=was_comment._rxn_key}if(was_comment.pinned_to&&!comment.pinned_to){comment.pinned_to=was_comment.pinned_to}if(file.initial_comment&&was_comment.id==file.initial_comment.id){file.initial_comment=comment;initial_comment_changed=true}break}}if(!good){return false}TS.files.makeSureReferencesGetSavedToLS(file.id);TS.files.sortCommentsOnFile(file);TS.files.team_file_comment_edited_sig.dispatch(file,comment);if(initial_comment_changed)TS.files.team_file_changed_sig.dispatch(file);return true},deleteCommentOnFile:function(comment_id,file){var was_comment;var A=[];var deleted_comment;for(var i=0;i<file.comments.length;i++){was_comment=file.comments[i];if(was_comment.id==comment_id){deleted_comment=was_comment;if(file.initial_comment&&was_comment.id==file.initial_comment.id){file.initial_comment=null}continue}A.push(was_comment)}if(A.length==file.comments.length){return}file.comments=A;TS.files.makeSureReferencesGetSavedToLS(file.id);TS.files.sortCommentsOnFile(file);TS.files.team_file_comment_deleted_sig.dispatch(file,comment_id,deleted_comment);TS.files.team_file_changed_sig.dispatch(file)},makeSureReferencesGetSavedToLS:function(file_id){var isFileReferencedInTheseMsgs=function(msgs,file_id){var msg;for(var i=0;i<msgs.length;i++){msg=msgs[i];if(msg.file&&msg.file.id==file_id)return true}return false};var i;var channel;for(i=0;i<TS.model.channels.length;i++){channel=TS.model.channels[i];if(channel&&channel.msgs&&channel.msgs.length){if(isFileReferencedInTheseMsgs(channel.msgs,file_id)){TS.utility.msgs.maybeStoreMsgs(channel.id,channel.msgs)}}}var group;for(i=0;i<TS.model.groups.length;i++){group=TS.model.groups[i];if(group&&group.msgs&&group.msgs.length){if(isFileReferencedInTheseMsgs(group.msgs,file_id)){TS.utility.msgs.maybeStoreMsgs(group.id,group.msgs)}}}var im;for(i=0;i<TS.model.ims.length;i++){im=TS.model.ims[i];if(im&&im.msgs&&im.msgs.length){if(isFileReferencedInTheseMsgs(im.msgs,file_id)){TS.utility.msgs.maybeStoreMsgs(im.id,im.msgs)}}}if(TS.boot_data.feature_mpim_client){var mpim;for(i=0;i<TS.model.mpims.length;i++){mpim=TS.model.mpims[i];if(mpim&&mpim.msgs&&mpim.msgs.length){if(isFileReferencedInTheseMsgs(mpim.msgs,file_id)){TS.utility.msgs.maybeStoreMsgs(mpim.id,mpim.msgs)}}}}},sortCommentsOnFile:function(file){function compare(a,b){if(a.timestamp>b.timestamp)return 1;if(a.timestamp<b.timestamp)return-1;return 0}file.comments.sort(compare)},upsertFile:function(file){if(file.mode==="space"){try{if(file.preview&&/^\s*<document>/.test(file.preview)){var $p=$(file.preview);if($p.length)file.preview=$p.html();if(TS.boot_data.feature_files_list&&$p.length){var $first_fragment=$p.children().eq(0);if($first_fragment.hasClass("list")){$first_fragment.find("li:not(:first)").remove()}if($first_fragment.prop("tagName").toLowerCase()==="pre"){file.preview_in_list=$first_fragment.length?'<span class="monospace">'+TS.utility.htmlEntities($first_fragment.text())+"</span>":""}else{file.preview_in_list=$first_fragment.length?TS.utility.htmlEntities($first_fragment.text()):""}}}}catch(err){TS.log(93,"problem with file.preview id:"+file.id);TS.log(93,"file.preview: "+file.preview)}try{if(file.content_html){var $c=$(file.content_html);if($c.length)file.content_html=$c.html()}}catch(err){TS.log(93,"problem with file.content_html id:"+file.id);TS.log(93,"file.content_html: "+file.content_html)}}if(TS.boot_data.feature_files_list&&file.mode==="post"&&file.preview){var preview=file.preview;var preview_list=preview.split("\n");var preview_list_length=preview_list.length;for(var j=0;j<preview_list_length;j++){var preview_line=preview_list[j];if(preview_line){file.preview_in_list=preview_line;break}}}if(file.mode==="snippet"){var content_keys=["content","content_highlight_html"];var max_length_of_content=12800;_.forEach(content_keys,function(content_key){if(file[content_key]&&file[content_key].length>max_length_of_content){file[content_key]=truncate(file[content_key],max_length_of_content);file.is_truncated=true}})}var files=TS.model.files;var existing_file=TS.files.getFileById(file.id);var status="NOOP";var what_changed=[];var c_ids_to_save;var comment;var existing_rxns;var i;if(existing_file){file._rxn_key=TS.rxns.getRxnKey("file",file.id);existing_rxns=TS.rxns.getExistingRxnsByKey(file._rxn_key);if(existing_rxns&&!file.reactions){TS.warn("file:"+file.id+" has reactions in local model, but we are upserting an object that does NOT have reactions, which seems suspicious")}else{TS.rxns.upsertRxnsFromDataAndUpdateUI(file._rxn_key,file.reactions)}delete file.reactions;if(file.comments){for(i=0;i<file.comments.length;i++){comment=file.comments[i];comment._rxn_key=TS.rxns.getRxnKey("file_comment",comment.id);existing_rxns=TS.rxns.getExistingRxnsByKey(comment._rxn_key);if(existing_rxns&&!comment.reactions){TS.warn("comment:"+file.id+" has reactions in local model, but we are upserting an object that does NOT have reactions, which seems suspicious")}else{TS.rxns.upsertRxnsFromDataAndUpdateUI(comment._rxn_key,comment.reactions)}delete comment.reactions}}if(file.initial_comment){file.initial_comment._rxn_key=TS.rxns.getRxnKey("file_comment",file.initial_comment.id);existing_rxns=TS.rxns.getExistingRxnsByKey(file.initial_comment._rxn_key);if(existing_rxns&&!file.initial_comment.reactions){TS.warn("initial_comment:"+file.id+" has reactions in local model, but we are upserting an object that does NOT have reactions, which seems suspicious")}else{TS.rxns.upsertRxnsFromDataAndUpdateUI(file.initial_comment._rxn_key,file.initial_comment.reactions)}delete file.initial_comment.reactions}c_ids_to_save=(existing_file.channels||[]).concat(existing_file.ims||[]).concat(existing_file.groups||[]);for(var k in file){if(k=="channels"||k=="ims"||k=="groups"||k=="pinned_to"||k=="to"||k=="from"||k=="cc"||k=="attachments"){var changed=false;var new_prop_array=TS.utility.ensureArray(file[k]);var old_prop_array=TS.utility.ensureArray(existing_file[k]);if(k=="to"||k=="from"||k=="cc"||k=="attachments"){if(old_prop_array.length!=new_prop_array.length){changed=true}}else{if(old_prop_array.join("")!=new_prop_array.join("")){changed=true;if(k=="channels"||k=="ims"||k=="groups"){c_ids_to_save=c_ids_to_save.concat(file[k]||[])}}}if(changed){existing_file[k]=file[k];status="CHANGED";what_changed.push(k)}}else if(k=="preview"){if(existing_file[k]!==file[k]){existing_file[k]=file[k];if(existing_file.content)delete existing_file.content;if(existing_file.content_html)delete existing_file.content_html;if(existing_file.content_highlight_html)delete existing_file.content_highlight_html;status="CHANGED";what_changed=what_changed.concat([k,"content","content_html","content_highlight_html"])}}else if(k=="comments"){if(file[k]&&!TS.utility.areSimpleObjectsEqual(file[k],existing_file[k],"file:"+file.id+" "+file.name)){existing_file[k]=file[k];status="CHANGED";what_changed.push(k)}}else if(k=="content"){if(file[k]&&existing_file[k]!=file[k]){existing_file[k]=file[k];status="CHANGED";what_changed.push(k)}}else if(k=="editor"||k=="state"){if(file[k]!=existing_file[k]){c_ids_to_save=[];what_changed.push(k);existing_file[k]=file[k];status="CHANGED"}}else if(k=="initial_comment"){existing_file[k]=file[k]}else if(k=="reactions"){existing_file[k]=file[k]}else if(existing_file[k]!=file[k]){if(file[k]&&!TS.utility.isScalar(file[k])){existing_file[k]=file[k];TS.warn(k+" is not scalar! it needs to be handled by upsertFile specifically to test if it has changed! "+typeof file[k])}else if(typeof file[k]!="boolean"||!file[k]!=!existing_file[k]){what_changed.push(k+" ["+existing_file[k]+"] -> ["+file[k]+"]");existing_file[k]=file[k];status="CHANGED"}}}}else{status="ADDED";file._rxn_key=TS.rxns.getRxnKey("file",file.id);TS.rxns.upsertRxnsFromDataAndUpdateUI(file._rxn_key,file.reactions);delete file.reactions;if(file.comments){for(i=0;i<file.comments.length;i++){comment=file.comments[i];comment._rxn_key=TS.rxns.getRxnKey("file_comment",comment.id);TS.rxns.upsertRxnsFromDataAndUpdateUI(comment._rxn_key,comment.reactions);delete comment.reactions}if(file.initial_comment){file.initial_comment._rxn_key=TS.rxns.getRxnKey("file_comment",file.initial_comment.id);TS.rxns.upsertRxnsFromDataAndUpdateUI(file.initial_comment._rxn_key,file.initial_comment.reactions);delete file.initial_comment.reactions}}files.push(file);var member=TS.members.getMemberById(file.user);if(member){member.files.push(file);TS.files.sortFiles(member.files);member.has_files=true}else{TS.error("hmmm, file "+file.id+" does not have a know user "+file.user)}_addFileToInlineImgs(file);existing_file=file}if(status=="CHANGED"){_addFileToInlineImgs(file)}if(!existing_file.comments){existing_file.comments=[]}else{existing_file.comments_count=Math.max(existing_file.comments_count,existing_file.comments.length)}if(!existing_file.channels){existing_file.channels=[]}if(!existing_file.ims){existing_file.ims=[]}if(!existing_file.groups){existing_file.groups=[]}existing_file.is_shared=existing_file.groups.length>0||existing_file.channels.length>0;if(status!="NOOP"){TS.utility.msgs.maybeStoreMsgsForMany(c_ids_to_save)}TS.files.sortFiles(TS.model.files);return{status:status,file:existing_file,what_changed:what_changed}},upsertAndSignal:function(file){var upsert=TS.files.upsertFile(file);if(upsert.status=="CHANGED"){TS.files.team_file_changed_sig.dispatch(upsert.file)}else if(upsert.status=="ADDED"){TS.files.team_file_added_sig.dispatch(upsert.file)}return upsert},removeFile:function(file_id){TS.log(4,'removing file "'+file_id+'"');var i;var file=TS.files.getFileById(file_id);if(file)file.is_deleted=true;var channels=TS.model.channels;var channel;for(i=0;i<channels.length;i++){channel=channels[i];if(file)TS.utility.msgs.removeFileSharesAndMentions(channel,file);if(file)TS.utility.msgs.removeFileComments(channel,file);TS.utility.msgs.removeFileReferences(channel,file_id)}var groups=TS.model.groups;var group;for(i=0;i<groups.length;i++){group=groups[i];if(file)TS.utility.msgs.removeFileSharesAndMentions(group,file);if(file)TS.utility.msgs.removeFileComments(group,file);TS.utility.msgs.removeFileReferences(group,file_id)}var ims=TS.model.ims;var im;for(i=0;i<ims.length;i++){im=ims[i];if(file)TS.utility.msgs.removeFileSharesAndMentions(im,file);if(file)TS.utility.msgs.removeFileComments(im,file);TS.utility.msgs.removeFileReferences(im,file_id)}if(TS.boot_data.feature_mpim_client){var mpims=TS.model.mpims;var mpim;for(i=0;i<mpims.length;i++){mpim=mpims[i];if(file)TS.utility.msgs.removeFileSharesAndMentions(mpim,file);if(file)TS.utility.msgs.removeFileComments(mpim,file);TS.utility.msgs.removeFileReferences(mpim,file_id)}}if(file)TS.files.team_file_deleted_sig.dispatch(file)},upload:function(args){if(TS.files.uploading){TS.files.uploadQ.push(args)}else{TS.files.actuallyUpload(args)}},actuallyUpload:function(args){TS.files.uploading=true;args.retry_num=args.retry_num||0;var form_data=new FormData;var display_name;var cancelable=!!args.file;if(args.text){display_name=args.title||args.filetype;TS.files.file_uploading_sig.dispatch(display_name,args.retry_num>0,cancelable);form_data.append("content",args.text);if(args.filetype){form_data.append("filetype",args.filetype)}if(args.filename){TS.warn("ignoring filename because it makes no sense for text files")}}else{display_name=args.title||args.filename||args.file.name||"blob";TS.files.file_uploading_sig.dispatch(display_name,args.retry_num>0,cancelable);if(typeof args.file=="string"){form_data.append("content64",args.file)}else{form_data.append("file",args.file)}if(args.filename){form_data.append("filename",args.filename)}if(args.filetype){TS.warn("ignoring filetype we send a filename which can intuit it")}}form_data.append("token",TS.model.api_token);if(args.channels&&args.channels.length){var channels_str=typeof args.channels=="string"?args.channels:args.channels.join?args.channels.join(","):"";form_data.append("channels",channels_str)}form_data.append("title",args.title);if(args.initial_comment){form_data.append("initial_comment",args.initial_comment)}var api_method="files.uploadAsync";if(args.link){if(args.is_dropbox)api_method="files.uploadExternal";if(args.is_box)api_method="files.uploadExternal";form_data.append("link",args.link)}TS.log(2,"calling "+TS.model.api_url+"files.upload");var url;if(api_method=="files.uploadAsync"){url=TS.model.async_api_url+api_method}else{url=TS.model.api_url+api_method}var errored=false;_current_xhr=$.ajax({url:url,data:form_data,dataType:"json",cache:false,contentType:false,processData:false,type:"POST",xhr:function(){var xhr=jQuery.ajaxSettings.xhr();if(xhr.upload){xhr.upload.addEventListener("progress",function(evt){if(evt.lengthComputable){var percent_done=parseInt(100*evt.loaded/evt.total,10);TS.files.file_progress_sig.dispatch(percent_done)}else{TS.info("Upload length not computable")}},false)}return xhr},error:function(data,textStatus,errorThrown){errored=true;TS.info("Error: Failed to upload file.");TS.info("textStatus:"+textStatus+" errorThrown:"+errorThrown);TS.info("data:"+data);if(textStatus==="abort"){TS.files.file_canceled_sig.dispatch(display_name);TS.files.uploadOver(false);return}if(args.retry_num===0){args.retry_num++;TS.files.actuallyUpload(args)}else{TS.generic_dialog.start({title:"Upload failed",body:'Failed to upload file: "'+textStatus+(errorThrown?" "+errorThrown:"")+'". Try again?',go_button_text:"Yes, try again",cancel_button_text:"No, cancel",onGo:function(){args.retry_num++;TS.files.actuallyUpload(args)},onCancel:function(){TS.files.uploadOver(false)}})}},complete:function(data){if(errored)return;data=jQuery.parseJSON(data.responseText);if(data&&data.ok&&data.file){if(api_method=="files.uploadAsync"){var pollHandler=function(ok,data,args){if(!TS.files.polling_file_id)return;if(ok){if(data.status=="complete"){var upsert=TS.files.upsertAndSignal(data.file);TS.files.uploadProcessingOver(true,upsert.file.id)}else if(data.status=="failed"){var debug_str="";if(data.debug&&TS.model.team.domain=="tinyspeck"){debug_str="<br><br>TS only Debugging:<br><br>"+data.debug}TS.generic_dialog.start({title:"Upload failed",body:"Failed to process the uploaded file. Try again?"+debug_str,go_button_text:"Yes, try again",cancel_button_text:"No, cancel",onGo:function(){args.retry_num++;TS.files.actuallyUpload(args)},onCancel:function(){TS.files.uploadProcessingOver(false,TS.files.polling_file_id)}})}else{TS.files.pollForUploadProcessing()}}else{TS.generic_dialog.start({title:"Upload failed",body:"Failed to process the uploaded file.",show_cancel_button:true});TS.files.uploadProcessingOver(false,TS.files.polling_file_id)}};TS.files.startPollingForUploadProcessing(data.file,data.ticket,pollHandler)}else{var upsert=TS.files.upsertAndSignal(data.file);TS.files.uploadOver(data.ok,upsert.file.id)}}else{TS.info("Error: Failed to upload file.");TS.info(data);if(data){if(args.retry_num===0){args.retry_num++;TS.files.actuallyUpload(args)}else if(data.error==="folders_not_supported"){TS.generic_dialog.start({title:"Folders not supported",body:"<p>Sorry, <b>"+TS.utility.htmlEntities(args.filename)+"</b> is a folder, and folder uploads are not supported by Slack.</p>									<p>Try uploading a .zip version of the file instead.</p>",show_cancel_button:false,esc_for_ok:true,onGo:function(){TS.generic_dialog.end();TS.files.uploadOver(false)}})}else if(data.error==="request_timeout"){TS.generic_dialog.start({title:"File upload timed out",body:'<p>It looks like you\'re on a slow or inconsistent internet connection. You may want to try your file upload again later. Or, try again now and it might work if you cross your fingers!</p>									<p>If you\'re still having problems, you can:</p><ul><li><a href="/help/test" target="'+TS.templates.builders.newWindowName()+'" class="bold">Run our Self-Help Tests</a></li><li><a href="/help/requests/new" target="'+TS.templates.builders.newWindowName()+'" class="bold">Contact our support team</li></ul>',show_cancel_button:false,esc_for_ok:true,onGo:function(){TS.generic_dialog.end();TS.files.uploadOver(false)}})}else if(data.error==="file_uploads_disabled"){TS.generic_dialog.start({title:"Upload failed",body:"At the request of your administrator, file uploads have been disabled on this team.",show_cancel_button:false,onGo:function(){TS.files.uploadOver(false)}})}else if(data.error==="file_uploads_except_images_disabled"){TS.generic_dialog.start({title:"Upload failed",body:"At the request of your administrator, only images can be uploaded to this team.",show_cancel_button:false,onGo:function(){TS.files.uploadOver(false)}})}else{TS.generic_dialog.start({title:"Upload failed",body:'Failed to upload file: "'+(data.error||"unknown error")+'". Try again?',go_button_text:"Yes, try again",cancel_button_text:"No, cancel",onGo:function(){args.retry_num++;TS.files.actuallyUpload(args)},onCancel:function(){TS.files.uploadOver(false)}})}}else{alert("Upload failed.");TS.files.uploadOver(false)}}}})},startPollingForUploadProcessing:function(file_id,ticket,pollHandler){TS.files.polling_count=0;TS.files.polling_file_id=file_id;TS.files.polling_ticket=ticket;TS.files.polling_handler=pollHandler;TS.files.pollForUploadProcessing()},pollForUploadProcessing:function(){TS.files.polling_count++;TS.files.polling_tim=setTimeout(function(){if(!TS.files.polling_ticket)return;TS.api.callImmediately("files.uploadStatus",{ticket:TS.files.polling_ticket},function(ok,data,args){if(!TS.files.polling_ticket)return;TS.files.polling_handler(ok,data,args)})},TS.files.polling_count*1e3)},uploadProcessingOver:function(ok,file_id){if(TS.files.polling_file_id!=file_id){return}TS.info("TS.files.uploadProcessingOver polling_file_id:"+TS.files.polling_file_id+" polling_ticket:"+TS.files.polling_ticket+" polling_count:"+TS.files.polling_count);TS.files.polling_count=0;TS.files.polling_file_id=null;TS.files.polling_ticket=null;TS.files.polling_handler=null;clearTimeout(TS.files.polling_tim);TS.files.uploadOver(ok,file_id)},uploadOver:function(ok,file_id){TS.files.file_uploaded_sig.dispatch(ok,file_id);TS.files.uploading=false;_current_xhr=null;if(TS.files.uploadQ.length){TS.files.actuallyUpload.call(null,TS.files.uploadQ.shift())}else{TS.files.file_queue_emptied_sig.dispatch()}},cancelCurrentUpload:function(){if(_current_xhr){_current_xhr.abort()}},deleteFile:function(id){TS.api.call("files.delete",{file:id},TS.files.onFileDelete)},onFileDelete:function(ok,data,args){if(!ok){return}},endEditFileTitle:function(){$("#file_edit_title_container").addClass("hidden");$("#file_title_container").removeClass("hidden")},saveEditFileTitle:function(file_id){var file=TS.files.getFileById(file_id);if(!file)return;var val=$("#file_edit_title_input").val();if(!$.trim(val)){TS.sounds.play("beep");return}var prev_title=file.title;if(prev_title==val){TS.files.endEditFileTitle();return}TS.api.callImmediately("files.edit",{file:file_id,title:val},function(ok,data,args){if(!ok){TS.files.upsertAndSignal({id:file_id,title:prev_title});alert("save failed!")}});val=TS.utility.htmlEntities(val);TS.files.upsertAndSignal({id:file_id,title:val});TS.files.endEditFileTitle()},editFileTitle:function(file_id){var file=TS.files.getFileById(file_id);if(!file)return;var title=file.title;if(title){title=TS.format.unFormatMsg(title)}else{title=file.name}$("#file_title_container").addClass("hidden");$("#file_edit_title_container").removeClass("hidden");$("#file_edit_title_input").val(title);$("#file_edit_title_input").select()},openBoxChooser:function(){TS.utility.box.unregister(TS.utility.box.SUCCESS_EVENT_TYPE,TS.files.onBoxChooser);TS.utility.box.success(TS.files.onBoxChooser);TS.utility.box.launchPopup()},onBoxChooser:function(box_files){var files=new Array(box_files.length);for(var i=0;i<box_files.length;i++){var b=box_files[i];files[i]={name:b.name,link:b.url,is_box:true}}TS.ui.upload_dialog.startWithCommentFromChatInput(files)},openDropboxChooser:function(){var linkType="preview";Dropbox.choose({success:TS.files.onDropboxChooser,linkType:linkType,multiselect:true})},onDropboxChooser:function(dropbox_files){var files=[];for(var i=0;i<dropbox_files.length;i++){var d=dropbox_files[i];files.push({name:d.name,size:d.bytes,link:d.link,icon:d.icon,is_dropbox:true})}TS.ui.upload_dialog.startWithCommentFromChatInput(files)},makeFileNameFromFile:function(file){var now=Date.now()/1e3;return file.name||"Pasted image at "+TS.utility.date.toFilenameFriendlyDate(now)+".png"},makeFileTitleFromFile:function(file){var now=Date.now()/1e3;return file.name||"Pasted image at "+TS.utility.date.toDate(now)},justUploadTheseFileNow:function(files){var file;for(var i=0;i<files.length;i++){file=files[i];if(file.size>TS.model.upload_file_size_limit_bytes){continue}TS.files.upload({file:file,filename:TS.files.makeFileNameFromFile(file),title:TS.files.makeFileTitleFromFile(file),channels:[TS.shared.getActiveModelOb().id],initial_comment:""})}},refreshFile:function(id){TS.files.startRefreshingFile(id);TS.api.call("files.refresh",{file:id},TS.files.onFileRefresh)},onFileRefresh:function(ok,data,args){var id=args.file;if(ok){TS.menu.$menu.find("#refresh_file").find(".item_label").text("File refreshed!").end()}else if(!ok){TS.files.doneRefreshingFile(id,'<span class="moscow_red">Refresh failed.</span>',5e3);TS.menu.$menu.find("#refresh_file").find(".item_label").text("Refresh failed").end()}if(ok&!data.will_refresh){TS.files.doneRefreshingFile(id,'<span class="moscow_red">File refreshed < 1 minute ago.</span>',5e3)}if(TS.web&&ok){TS.menu.$menu.find("#refresh_file").find(".item_label").text("Reloading...");location.reload()}if(!ok){if(data.error=="file_deleted"){var existing_file=TS.files.getFileById(id);if(existing_file){TS.files.removeFile(existing_file.id)}}return}},fileWasMaybeRefreshed:function(file){if(!file)return;if(!TS.files.waiting_for_refresh[file.id])return;TS.files.doneRefreshingFile(file.id,'<span class="kelly_green">File refreshed!</span>',6e4)},startRefreshingFile:function(id){TS.files.waiting_for_refresh[id]=true;$('.file_refresh[data-file-id="'+id+'"]').addClass("hidden");$('.file_refresh_status[data-file-id="'+id+'"]').removeClass("hidden")},doneRefreshingFile:function(id,msg,ms){delete TS.files.waiting_for_refresh[id];$('.file_refresh_status[data-file-id="'+id+'"]').html(msg);setTimeout(function(){$('.file_refresh[data-file-id="'+id+'"]').removeClass("hidden");$('.file_refresh_status[data-file-id="'+id+'"]').text("Refreshing file...").addClass("hidden")},ms)},shareOrReshareFile:function(file_id,hide_file_preview,space_has_title){var file=TS.files&&TS.files.getFileById?TS.files.getFileById(file_id):null;var can_reshare=false;var is_owned_by_other=file.user!=TS.model.user.id;var is_owned_by_a_user=!file.bot_id;if(TS.files.isFilePrivate(file)&&is_owned_by_other&&is_owned_by_a_user){can_reshare=true}if(!file){TS.error("File for reshare doesn't exist: "+file_id);return}else if(can_reshare){TS.files.reShareConfirmation([file],function(){TS.ui.share_dialog.start(file_id,hide_file_preview,space_has_title)})}else{TS.ui.share_dialog.start(file_id,hide_file_preview,space_has_title)}},reShareConfirmation:function(files,callback){var file_owners=files.map(function(file){return TS.members.getMemberDisplayNameById(file.user,true)});file_owners=TS.utility.dedupeArray(file_owners);var user_names=TS.utility.concatNames(file_owners);var has_pluralization="has";var file_pluralization="this file";var msg_title="You're about to share a private file";var it_pluralization="it";if(file_owners.length>1){has_pluralization="have"}if(files.length>1){file_pluralization="these files";msg_title="You're about to share private files";it_pluralization="them"}else{var title=files[0].title||"Untitled";title=TS.format.formatNoSpecials(title);file_pluralization="the file <b>"+title+"</b>"}var msg_body="<p><b>"+user_names+"</b> "+has_pluralization+" privately shared "+file_pluralization+" with you. Are you sure you want to proceed with sharing "+it_pluralization+" somewhere else?</p><p>Its important to note that any comments on "+file_pluralization+" will also be shared.</p>";TS.generic_dialog.start({title:msg_title,body:msg_body,show_cancel_button:true,show_go_button:true,go_button_text:"Proceed with sharing",cancel_button_text:"Cancel",onGo:callback})},updateFileListItem:function(file,$container){var $file_list_item=$container.find('.file_list_item[data-file-id="'+file.id+'"]');if($file_list_item.length){$file_list_item.replaceWith(TS.templates.builders.fileHTML(file));if(TS.files.fileIsImage(file))$container.find(".lazy").lazyload()}}});var _current_xhr=null;var _info_fetching_map={};var _addFileToInlineImgs=function(file){if(!TS.files.fileIsImage(file))return;var inline_img={width:file.thumb_360_w,height:file.thumb_360_h,link_url:file.url_private,internal_file_id:file.id};if(file.thumb_480_gif||file.thumb_360_gif){if(file.thumb_480_gif)TS.inline_imgs.makeInternalInlineImg(file.thumb_480_gif,inline_img);if(file.thumb_360_gif)TS.inline_imgs.makeInternalInlineImg(file.thumb_360_gif,inline_img)}else{if(file.thumb_720)TS.inline_imgs.makeInternalInlineImg(file.thumb_720,inline_img);if(file.thumb_480)TS.inline_imgs.makeInternalInlineImg(file.thumb_480,inline_img);if(file.thumb_360)TS.inline_imgs.makeInternalInlineImg(file.thumb_360,inline_img)}}})();(function(){"use strict";TS.registerModule("rooms",{added_sig:new signals.Signal,changed_name_sig:new signals.Signal,changed_participants_sig:new signals.Signal,changed_date_end_sig:new signals.Signal,changed_channels_sig:new signals.Signal,onStart:function(){},getRoomById:function(id){return TS.rooms.getRoomByProp("id",id)},getRoomByProp:function(name,value){if(!name)return null;var rooms=TS.model.rooms;var room;for(var i in rooms){room=rooms[i];if(room[name]===value)return room}return null},upsertAndSignal:function(room){var upsert=TS.rooms.upsertRoom(room);if(upsert.status=="CHANGED"){if(upsert.what_changed.indexOf("name")!=-1){TS.rooms.changed_name_sig.dispatch(upsert.room)}if(upsert.what_changed.indexOf("participants")!=-1){TS.rooms.changed_participants_sig.dispatch(upsert.room)}if(upsert.what_changed.indexOf("date_end")!=-1){TS.rooms.changed_date_end_sig.dispatch(upsert.room)}if(upsert.what_changed.indexOf("channels")!=-1){TS.rooms.changed_channels_sig.dispatch(upsert.room)}}else if(upsert.status=="ADDED"){TS.rooms.added_sig.dispatch(upsert.room)}return upsert},upsertRoom:function(room){var rooms=TS.model.rooms;var existing_room=TS.rooms.getRoomById(room.id);var status="NOOP";var what_changed=[];var c_ids_to_save;if(room.date_start)room.date_start=Number(room.date_start);if(room.date_end)room.date_end=Number(room.date_end);if(room.was_rejected)room.was_rejected=Boolean(room.was_rejected);if(room.is_dm_call)room.is_dm_call=Boolean(room.is_dm_call);if(room.was_missed)room.was_missed=Boolean(room.was_missed);if(existing_room){TS.log(4,'updating existing room "'+room.id+'"');c_ids_to_save=existing_room.channels||[];for(var k in room){if(k=="participants"||k=="channels"||k=="participant_history"){if(room[k]&&!TS.utility.areSimpleObjectsEqual(room[k],existing_room[k])){what_changed.push(k);existing_room[k]=room[k];status="CHANGED";if(k=="channels"){c_ids_to_save=c_ids_to_save.concat(room[k]||[])}}}else if(existing_room[k]!=room[k]){if(room[k]&&!TS.utility.isScalar(room[k])){existing_room[k]=room[k];TS.warn(k+" is not scalar! it needs to be handled by upsertRoom specifically to test if it has changed! "+typeof room[k])}else if(typeof room[k]!="boolean"||!room[k]!=!existing_room[k]){what_changed.push(k);existing_room[k]=room[k];status="CHANGED"}}}room=existing_room}else if(room.id){status="ADDED";TS.log(4,'adding room "'+room.id);rooms.push(room)}else{TS.error("bad error, no room.id")}if(status!="NOOP"){TS.utility.msgs.maybeStoreMsgsForMany(c_ids_to_save)}return{status:status,room:room,what_changed:what_changed}}})})();(function(){"use strict";TS.registerModule("ims",{switched_sig:new signals.Signal,pre_switched_sig:new signals.Signal,history_fetched_sig:new signals.Signal,history_being_fetched_sig:new signals.Signal,message_received_sig:new signals.Signal,message_removed_sig:new signals.Signal,message_changed_sig:new signals.Signal,marked_sig:new signals.Signal,closed_sig:new signals.Signal,unread_changed_sig:new signals.Signal,unread_highlight_changed_sig:new signals.Signal,opened_sig:new signals.Signal,msg_not_sent_sig:new signals.Signal,data_retention_changed_sig:new signals.Signal,onStart:function(){},addMsg:function(id,msg){var im=TS.ims.getImById(id);if(!im){TS.error('unknown im "'+id+'"');return}if(!TS.shared.addMsg(im,msg))return;var and_mark=!TS.utility.msgs.isTempMsg(msg);TS.ims.calcUnreadCnts(im,and_mark);TS.utility.msgs.maybeTruncateMsgs(im);TS.ims.message_received_sig.dispatch(im,msg);if(!im.is_open){TS.api.call("im.open",{user:im.user,reason:"TS.ims.addMsg"},TS.ims.onOpened);
}},calcUnreadCnts:function(im,and_mark){TS.shared.calcUnreadCnts(im,TS.ims,and_mark)},removeMsg:function(id,msg){var im=TS.ims.getImById(id);if(!im){TS.error('unknown im "'+id+'"');return}if(im._archive_msgs)TS.utility.msgs.spliceMsg(im._archive_msgs,msg);var msgs=im.msgs;TS.utility.msgs.spliceMsg(msgs,msg);TS.ims.message_removed_sig.dispatch(im,msg);TS.utility.msgs.maybeStoreMsgs(im.id,msgs);TS.ims.calcUnreadCnts(im,true)},changeMsgText:function(id,msg,txt){var im=TS.ims.getImById(id);if(!im){TS.error('unknown im "'+id+'"');return}msg.text=txt;TS.ims.message_changed_sig.dispatch(im,msg);TS.utility.msgs.maybeStoreMsgs(im.id,im.msgs)},sendMsg:function(im_id,text,in_reply_to_msg){return TS.shared.sendMsg(im_id,text,TS.ims,in_reply_to_msg)},onSendMsg:function(success,imsg){var im=TS.ims.getImById(imsg.SENT_MSG.channel);if(!im){TS.error("unknown im? "+imsg.SENT_MSG.channel);return}TS.shared.onSendMsg(success,imsg,im,TS.ims)},closeImByMemberId:function(member_id){var im=TS.ims.getImByMemberId(member_id);if(!im){return}TS.ims.closeIm(im.id)},closeIm:function(id){var im=TS.ims.getImById(id);if(!im){return}if(false&&im.is_slackbot_im){TS.error("can't leave self channel");return}TS.api.call("im.close",{channel:id},TS.ims.onClosed)},onClosed:function(ok,data,args){if(!ok){return}if(data.no_op){var im=TS.ims.getImById(args.channel);if(im)TS.ims.closed_sig.dispatch(im)}},startImById:function(id,from_history,and_send_txt){var im=TS.ims.getImById(id);if(!im){TS.error(id+" not an im");return}TS.ims.startImByMemberId(im.user,from_history,and_send_txt)},startImByMemberName:function(member_name,from_history,and_send_txt){var member=TS.members.getMemberByName(member_name);if(!member){TS.error("no member?? "+member_name);return}TS.ims.startImByMemberId(member.id,from_history,and_send_txt)},startImByMemberId:function(member_id,from_history,and_send_txt,callback){var im=TS.ims.getImByMemberId(member_id);if(im){TS.ims.displayIm(im.id,from_history);if(im.is_open){if(and_send_txt){TS.ims.sendMsg(im.id,$.trim(and_send_txt))}return}}TS.model.requested_im_opens[member_id]={and_send_txt:and_send_txt};TS.api.call("im.open",{user:member_id,reason:"TS.ims.startImByMemberId"},TS.ims.onOpened)},onOpened:function(ok,data){if(!ok){return}},displayIm:function(im_id,from_history,and_send_txt){TS.timing.mark("start_channel_change_"+im_id);var im=TS.ims.getImById(im_id);if(!im){TS.error('im "'+im_id+'" unknown');return}if(im._did_defer_initial_msg_history){TS.shared.checkInitialMsgHistory(im,TS.ims)}if(im_id==TS.model.active_im_id){if(and_send_txt){TS.ims.sendMsg(im.id,$.trim(and_send_txt))}return}var no_history_add=from_history;if(TS.client.channelDisplaySwitched(im_id,false,no_history_add)){TS.ims.pre_switched_sig.dispatch();TS.ims.switched_sig.dispatch()}if(and_send_txt){TS.ims.sendMsg(im.id,$.trim(and_send_txt))}},setLastRead:function(im,ts){if(im.last_read==ts){return false}if(ts.indexOf(TS.utility.date.fake_ts_unique_padder)>-1){TS.error("bad ts:"+ts);return false}if(im.last_read>ts){var dont_allow_back_setting=TS.model.last_reads_set_by_client[im.id+"_"+ts];delete TS.model.last_reads_set_by_client[im.id+"_"+ts];if(dont_allow_back_setting){TS.warn("NOT going back in time im.last_read:"+im.last_read+" new:"+ts);return}TS.info("going back in time im.last_read:"+im.last_read+" new:"+ts)}im.last_read=ts;TS.ims.marked_sig.dispatch(im);TS.ims.calcUnreadCnts(im);return true},markMostRecentReadMsg:function(im,reason){if(!im){TS.error("im unknown");return}if(!im.msgs||!im.msgs.length)return;var most_recent_valid_ts=TS.utility.msgs.getMostRecentValidTs(im.msgs);if(!most_recent_valid_ts){TS.warn("no valid tses???");return}im.all_read_this_session_once=true;TS.ims.markReadMsg(im.id,most_recent_valid_ts,reason)},markReadMsg:function(im_id,ts,reason){var im=TS.ims.getImById(im_id);if(!im){TS.error('im "'+im_id+'" unknown');return}if(im.last_read==ts){return}if(TS.ims.setLastRead(im,ts)){im._marked_reason=reason;im.needs_api_marking=true}},onMarked:function(ok,data,args){var im=TS.ims.getImById(args.channel);if(!im){TS.error('wtf no im "'+args.channel+'"');return}if(!ok)im.needs_api_marking=true},getImById:function(id){var ims=TS.model.ims;var im=_id_map[id];if(im){return im}if(!ims)return null;for(var i=0;i<ims.length;i++){im=ims[i];if(im.id==id){TS.warn(id+" not in _id_map");_id_map[id]=im;return im}}return null},getDisplayNameOfUserForIm:function(im){return TS.members.getMemberDisplayName(TS.members.getMemberById(im.user))},getDisplayNameOfUserForImLowerCase:function(im){return TS.members.getMemberDisplayNameLowerCase(TS.members.getMemberById(im.user))},getImByUsername:function(name){var member=TS.members.getMemberByName(name);if(!member)return null;return TS.ims.getImByMemberId(member.id)},getImByMemberId:function(id){var ims=TS.model.ims;var im=_member_id_map[id];if(im){return im}if(!ims)return null;for(var i=0;i<ims.length;i++){im=ims[i];if(im.user==id){TS.warn(id+" not in _member_id_map?");_member_id_map[id]=im;return im}}return null},getFirstOpenIm:function(){var ims=TS.model.ims;var im;if(!ims)return null;for(var i=0;i<ims.length;i++){im=ims[i];if(im.is_open)return im}return null},isImWithDeletedMember:function(model_ob){if(!model_ob.is_im)return false;var member=TS.members.getMemberById(model_ob.user);if(!member||!member.deleted)return false;return true},setNameFromMember:function(member){var im=TS.ims.getImByMemberId(member.id);if(!im)return;_setName(im)},upsertIm:function(im){var ims=TS.model.ims;var existing_im=TS.ims.getImById(im.id);if(TS.boot_data.feature_no_unread_counts){delete im.unread_count}if(existing_im){TS.log(4,'updating existing im "'+im.id+'"');for(var k in im){existing_im[k]=im[k]}im=existing_im;if(TS.client&&(im.is_open||im.unread_cnt)){TS.shared.checkInitialMsgHistory(im,TS.ims)}}else{TS.log(4,'adding im "'+im.id+'"');ims.push(im);im._hotness=0;im.is_im=true;_setName(im);var member=TS.members.getMemberById(im.user);if(member){if(member.is_slackbot){im.is_slackbot_im=true}}_id_map[im.id]=im;_member_id_map[im.user]=im;im.opened_this_session=false;im.oldest_msg_ts=TS.storage.fetchOldestTs(im.id);im.last_msg_input=TS.storage.fetchLastMsgInput(im.id);im.scroll_top=-1;im.history_is_being_fetched=false;im.needs_api_marking=false;im.unread_highlight_cnt=0;im.unread_highlights=[];im.unread_cnt=0;im.unreads=[];im.oldest_unread_ts=null;im.has_fetched_history_after_scrollback=false;if(TS.client){var stored_msgs=TS.utility.msgs.fetchInitialMsgsFromLS(im);TS.utility.msgs.setMsgs(im,stored_msgs)}else{if(TS.boot_data.msgs){TS.utility.msgs.ingestMessagesFromBootData(im)}}}if(TS.client){var and_mark=TS.utility.msgs.shouldMarkUnreadsOnMessageFetch();TS.ims.calcUnreadCnts(im,and_mark)}return im},markScrollTop:function(id,scroll_top){var im=TS.ims.getImById(id);if(!im)return false;if(im.scroll_top==scroll_top){return false}im.scroll_top=scroll_top;return true},maybeLoadScrollBackHistory:function(id,force){var im=TS.ims.getImById(id);if(!im)return false;return TS.shared.maybeLoadScrollBackHistory(im,TS.ims,force)},onHistory:function(ok,data,args){var im=TS.ims.getImById(args.channel);if(!im){TS.error('wtf no im "'+args.channel+'"');return}if(!ok||!data||!data.messages){TS.error("failed to get history");im.history_fetch_retries?im.history_fetch_retries++:im.history_fetch_retries=1;TS.ims.history_fetched_sig.dispatch(im);return}delete im.history_fetch_retries;var fetching_more=TS.shared.onHistory(im,data,args,TS.ims);if(!fetching_more){im.history_is_being_fetched=false;TS.ims.history_fetched_sig.dispatch(im)}var and_mark=TS.utility.msgs.shouldMarkUnreadsOnMessageFetch();TS.ims.calcUnreadCnts(im,and_mark);if(TS.view){if(!fetching_more&&im.unread_cnt){TS.client.channel_pane.rebuildImList()}}},fetchHistory:function(im,api_args,handler){if(!im){TS.error('wtf no im "'+im+'"');return}im.history_is_being_fetched=true;im.history_fetch_failed=false;TS.ims.history_being_fetched_sig.dispatch(im);if(im.history_fetch_retries>5){delete im.history_fetch_retries;im.history_is_being_fetched=false;im.history_fetch_failed=true;if(TS.client)TS.client.msg_pane.updateEndMarker();return}TS.api.call("im.history",api_args,handler||TS.ims.onHistory)},checkForOldImsToClose:function(){if(TS.boot_data.feature_mpim_client){return TS.shared.checkForOldImsToClose()}var ims=TS.model.ims;var im;var activity_ts;var activity_date;var ms_since_activity;var i;var dms_listed_cnt=0;var allow_in_list=11;var allow_elapsed_ms=1e3*60*60*168;for(i=0;i<ims.length;i++){im=ims[i];if(!im.is_open&&!im.unread_cnt)continue;dms_listed_cnt++}var this_too_many=dms_listed_cnt-allow_in_list;if(this_too_many<1){return}TS.info("checkForOldImsToClose might close some. this_too_many:"+this_too_many);var leaveA=[];for(i=0;i<ims.length;i++){im=ims[i];if(im.is_slackbot_im)continue;if(!im.is_open)continue;if(im.unread_cnt)continue;if(im.is_starred)continue;if(im.opened_this_session)continue;activity_ts=TS.shared.getLatestMsgTs(im)||"";if(im.msgs&&im.msgs.length&&im.msgs[0]&&im.msgs[0].ts>activity_ts){activity_ts=im.msgs[0].ts}if(activity_ts){activity_date=TS.utility.date.toDateObject(activity_ts)}else{activity_date=new Date(im.created*1e3)}ms_since_activity=new Date-activity_date;if(ms_since_activity>allow_elapsed_ms){TS.info(im.name+" "+activity_date+" ms_since_activity:"+ms_since_activity+" allow_elapsed_ms:"+allow_elapsed_ms);leaveA.push({im:im,ms_since_activity:ms_since_activity})}}if(!leaveA.length){TS.info("checkForOldImsToClose found no candidates for closing")}leaveA.sort(function compare(a,b){var a_srt=a.ms_since_activity;var b_srt=b.ms_since_activity;if(a_srt<b_srt)return 1;if(a_srt>b_srt)return-1;return 0});leaveA.length=leaveA.length>this_too_many?this_too_many:leaveA.length;for(i=0;i<leaveA.length;i++){im=leaveA[i].im;TS.warn("checkForOldImsToClose CLOSING:"+im.name+" ms_since_activity:"+leaveA[i].ms_since_activity);TS.ims.closeIm(im.id)}},setDataRetention:function(im_id,retention_type,retention_duration,handler){var args={channel:im_id,retention_type:$("select[name=retention_type]").val()};if(args.retention_type==1){args.retention_duration=$("#retention_duration").val()}TS.api.call("im.setRetention",args,function(ok,data,args){if(handler){handler(ok,data,args)}if(ok){TS.ims.data_retention_changed_sig.dispatch(args)}})},getDataRetention:function(im_id,handler){TS.api.call("im.getRetention",{channel:im_id},handler)}});var _id_map={};var _member_id_map={};var _setName=function(im){im.name=im.user;var member=TS.members.getMemberById(im.user);if(member){if(member._is_local){im.name=member.name}else{im.name=member.name+"_"+member.team_id}}im._name_lc=TS.utility.getLowerCaseValue(im.name)}})();(function(){"use strict";TS.registerModule("mpims",{switched_sig:new signals.Signal,pre_switched_sig:new signals.Signal,joined_sig:new signals.Signal,member_joined_sig:new signals.Signal,history_fetched_sig:new signals.Signal,history_being_fetched_sig:new signals.Signal,message_received_sig:new signals.Signal,message_removed_sig:new signals.Signal,message_changed_sig:new signals.Signal,marked_sig:new signals.Signal,closed_sig:new signals.Signal,unread_changed_sig:new signals.Signal,unread_highlight_changed_sig:new signals.Signal,opened_sig:new signals.Signal,msg_not_sent_sig:new signals.Signal,data_retention_changed_sig:new signals.Signal,onStart:function(){if(!TS.boot_data.feature_mpim_client)return;TS.prefs.display_real_names_override_changed_sig.add(_realNamePrefChanged);TS.prefs.team_display_real_names_changed_sig.add(_realNamePrefChanged);TS.members.changed_profile_sig.add(_memberRealNameChanged)},getVisibleMpims:function(){if(!TS.boot_data.feature_mpim_client)return[];var all=TS.model.mpims;return all.filter(function(mpim){if(mpim.is_open)return true;if(mpim.is_starred)return true;if(mpim.unread_cnt)return true;if(mpim.members&&mpim.members.length===2)return false;if(TS.model.user.is_ultra_restricted)return true;return true})},addMsg:function(id,msg){var mpim=TS.mpims.getMpimById(id);if(!mpim){TS.error('unknown mpim "'+id+'"');return}if(!TS.shared.addMsg(mpim,msg))return;var and_mark=!TS.utility.msgs.isTempMsg(msg);TS.mpims.calcUnreadCnts(mpim,and_mark);TS.utility.msgs.maybeTruncateMsgs(mpim);TS.mpims.message_received_sig.dispatch(mpim,msg);if(!mpim.is_open&&TS.utility.msgs.msgCanCountAsUnread(msg)){if(mpim.members.length==1){var user=mpim.members[0];TS.api.call("im.open",{user:user,reason:"TS.mpims.addMsg"},TS.mpims.onOpened)}else if(mpim.members.length>1){var users=mpim.members.join(",");TS.api.call("mpim.open",{users:users},TS.mpims.onOpened)}else{}}},calcUnreadCnts:function(mpim,and_mark){TS.shared.calcUnreadCnts(mpim,TS.mpims,and_mark)},removeMsg:function(id,msg){var mpim=TS.mpims.getMpimById(id);if(!mpim){TS.error('unknown mpim "'+id+'"');return}if(mpim._archive_msgs)TS.utility.msgs.spliceMsg(mpim._archive_msgs,msg);var msgs=mpim.msgs;TS.utility.msgs.spliceMsg(msgs,msg);TS.mpims.message_removed_sig.dispatch(mpim,msg);TS.utility.msgs.maybeStoreMsgs(mpim.id,msgs);TS.mpims.calcUnreadCnts(mpim,true)},changeMsgText:function(id,msg,txt){},sendMsg:function(mpim_id,text,in_reply_to_msg){return TS.shared.sendMsgGroup(mpim_id,text,TS.mpims,in_reply_to_msg)},onSendMsg:function(success,imsg){var mpim=TS.mpims.getMpimById(imsg.SENT_MSG.channel);if(!mpim){TS.error("unknown mpim? "+imsg.SENT_MSG.channel);return}TS.shared.onSendMsg(success,imsg,mpim,TS.mpims)},closeMpim:function(id){var mpim=TS.mpims.getMpimById(id);if(!mpim){return}TS.api.call("mpim.close",{channel:id},TS.mpims.onClosed)},onClosed:function(ok,data,args){if(!ok){return}if(data.no_op){var mpim=TS.mpims.getMpimById(args.channel);if(mpim)TS.mpims.closed_sig.dispatch(mpim)}},startMpimWithMembers:function(members,callback){var ids=members.map(function(user){return user.id});ids=ids.join(",");TS.api.call("mpim.open",{users:ids},function(ok,data,args){if(data.group){var mpim=TS.mpims.upsertMpim(data.group);if(mpim){TS.mpims.displayMpim(mpim.id)}else{TS.error("no mpim?!?")}}if(callback)callback(ok,data,args)})},onOpened:function(ok,data){if(!ok){return}},displayMpim:function(mpim_id,and_send_txt,from_history,replace_history_state){TS.timing.mark("start_channel_change_"+mpim_id);from_history=!!from_history;replace_history_state=!!replace_history_state;var mpim=TS.mpims.getMpimById(mpim_id);if(!mpim){TS.error('mpim "'+mpim_id+'" unknown');return}if(mpim._did_defer_initial_msg_history){TS.shared.checkInitialMsgHistory(mpim,TS.mpims)}if(mpim_id==TS.model.active_mpim_id&&!replace_history_state){TS.warn('mpim "'+mpim_id+'" already displayed');if(and_send_txt){TS.mpims.sendMsg(mpim_id,$.trim(and_send_txt))}return}var no_history_add=replace_history_state?false:from_history;if(TS.client.channelDisplaySwitched(mpim_id,replace_history_state,no_history_add)){TS.mpims.pre_switched_sig.dispatch();TS.mpims.switched_sig.dispatch()}if(mpim.is_open){if(and_send_txt){TS.mpims.sendMsg(mpim_id,$.trim(and_send_txt))}return}TS.model.requested_mpim_opens[mpim_id]={and_send_txt:and_send_txt};var user_ids=mpim.members.filter(function(member_id){return TS.model.user.id!==member_id});TS.api.call("mpim.open",{users:user_ids.join(",")},TS.mpims.onOpened)},setLastRead:function(mpim,ts){if(mpim.last_read==ts){return false}if(ts.indexOf(TS.utility.date.fake_ts_unique_padder)>-1){TS.error("bad ts:"+ts);return false}if(mpim.last_read>ts){var dont_allow_back_setting=TS.model.last_reads_set_by_client[mpim.id+"_"+ts];delete TS.model.last_reads_set_by_client[mpim.id+"_"+ts];if(dont_allow_back_setting){TS.warn("NOT going back in time mpim.last_read:"+mpim.last_read+" new:"+ts);return}TS.info("going back in time mpim.last_read:"+mpim.last_read+" new:"+ts)}mpim.last_read=ts;TS.mpims.marked_sig.dispatch(mpim);TS.mpims.calcUnreadCnts(mpim);return true},markMostRecentReadMsg:function(mpim,reason){if(!mpim){TS.error("mpim unknown");return}if(!mpim.msgs||!mpim.msgs.length)return;var most_recent_valid_ts=TS.utility.msgs.getMostRecentValidTs(mpim.msgs);if(!most_recent_valid_ts){TS.warn("no valid tses???");return}mpim.all_read_this_session_once=true;TS.mpims.markReadMsg(mpim.id,most_recent_valid_ts,reason)},markReadMsg:function(mpim_id,ts,reason){var mpim=TS.mpims.getMpimById(mpim_id);if(!mpim){TS.error('mpim "'+mpim_id+'" unknown');return}if(mpim.last_read==ts){return}if(TS.mpims.setLastRead(mpim,ts)){mpim._marked_reason=reason;mpim.needs_api_marking=true}},onMarked:function(ok,data,args){var mpim=TS.mpims.getMpimById(args.channel);if(!mpim){TS.error('wtf no mpim "'+args.channel+'"');return}if(!ok)mpim.needs_api_marking=true},getMpimById:function(id){var mpims=TS.model.mpims;var mpim=_id_map[id];if(mpim){return mpim}if(!mpims)return null;for(var i=0;i<mpims.length;i++){mpim=mpims[i];if(mpim.id==id){TS.warn(id+" not in _id_map?");_id_map[id]=mpim;return mpim}}return null},getMpimByName:function(name){name=TS.utility.getLowerCaseValue(name);var mpims=TS.model.mpims;var mpim=_name_map[name];if(mpim)return mpim;if(!mpims)return null;for(var i=0;i<mpims.length;i++){mpim=mpims[i];if(mpim._name_lc==name){TS.warn(name+" not in _name_map?");_name_map[mpim._name_lc]=mpim;_name_map[mpim._internal_name]=mpim;return mpim}}return null},getActiveMembers:function(mpim){var members=TS.mpims.getMembersInDisplayOrder(mpim);return members.filter(function(m){return!m.deleted})},getMembersInDisplayOrder:function(mpim){if(!mpim)return;if(mpim._members&&mpim._members.length===mpim.members.length-1)return mpim._members;var members=[];for(var i=0;i<mpim.members.length;i++){if(mpim.members[i]===TS.model.user.id)continue;members.push(TS.members.getMemberById(mpim.members[i]))}mpim._members=members;return members},getDisplayName:function(mpim,for_header,show_last_initial){if(mpim._display_name&&!for_header&&!show_last_initial)return mpim._display_name;var members=TS.mpims.getMembersInDisplayOrder(mpim);var display_real_names=TS.members.shouldDisplayRealNames();var first_name_map={};if(display_real_names){members.forEach(function(member){if(member.profile.first_name){if(!first_name_map[member.profile.first_name])first_name_map[member.profile.first_name]=[];first_name_map[member.profile.first_name].push(member)}})}var names=members.map(function(member){if(member.profile.first_name&&display_real_names){var first_name=$.trim(member.profile.first_name);var last_name=$.trim(member.profile.last_name);var name=first_name;if(first_name_map[first_name]&&first_name_map[first_name].length>1&&last_name||show_last_initial){name+=" "+_getFirstLetter(last_name)+"."}if(for_header&&!TS.boot_data.feature_channel_header_refresh){name=TS.utility.htmlEntities($.trim(name));if(member.deleted){name='<span class="cloud_silver">'+name+"</span>"}else{name+=TS.templates.makeMemberPresenceIcon(member)}}else if(for_header&&TS.boot_data.feature_channel_header_refresh){name='<li class="mpdm_member '+TS.templates.makeMemberDomId(member)+" "+TS.templates.makeMemberPresenceStateClass(member)+'" data-member-id="'+member.id+'">'+name+"</li>"}return name}else{var user_name=$.trim(member.name);if(for_header&&!TS.boot_data.feature_channel_header_refresh){user_name=TS.utility.htmlEntities(user_name);if(member.deleted){user_name='<span class="cloud_silver"><span class="prefix">@</span>'+user_name+"</span>"}else{user_name+=TS.templates.makeMemberPresenceIcon(member)}}else if(for_header&&TS.boot_data.feature_channel_header_refresh){user_name='<li class="mpdm_member '+TS.templates.makeMemberDomId(member)+" "+TS.templates.makeMemberPresenceStateClass(member)+'" data-member-id="'+member.id+'">'+user_name+"</li>"}return user_name}});var display_name;if(for_header&&TS.boot_data.feature_channel_header_refresh){display_name=names.join(" ")}else{display_name=names.join(", ")}if(!for_header&&!show_last_initial)mpim._display_name=display_name;return display_name},getDisplayNameLowerCase:function(mpim){if(mpim._display_name_lc)return mpim._display_name_lc;var display_name=TS.mpims.getDisplayName(mpim);mpim._display_name_lc=TS.utility.getLowerCaseValue(display_name);return mpim._display_name_lc},getTooltipText:function(mpim){var members=TS.mpims.getMembersInDisplayOrder(mpim);var names=members.map(function(member){if(member.profile.real_name)return member.profile.real_name;return member.name});var tooltip=names.join(", ");if(tooltip===TS.mpims.getDisplayName(mpim))return"";return tooltip},getMpimArchivesPath:function(mpim){return"/archives/"+mpim.id},getMemberCount:function(mpim){return Math.min(Math.max(mpim.members.length-1,2),9)},upsertMpim:function(mpim_group){var mpims=TS.model.mpims;var existing_mpim=TS.mpims.getMpimById(mpim_group.id);if(TS.boot_data.feature_no_unread_counts){delete mpim_group.unread_count}if(existing_mpim){TS.log(4,'updating existing mpim "'+existing_mpim.id+'"');for(var k in mpim_group){if(k==="name")continue;existing_mpim[k]=mpim_group[k]}mpim_group=existing_mpim;if(TS.client&&(mpim_group.is_open||mpim_group.unread_cnt)){TS.shared.checkInitialMsgHistory(mpim_group,TS.mpims)}}else{TS.log(4,'adding mpim "'+mpim_group.id+'"');mpim_group._internal_name=mpim_group.name;_name_map[mpim_group._internal_name]=mpim_group;_updateMpimName(mpim_group);mpims.push(mpim_group);mpim_group._hotness=0;mpim_group.is_mpim=true;_id_map[mpim_group.id]=mpim_group;mpim_group.opened_this_session=false;mpim_group.oldest_msg_ts=TS.storage.fetchOldestTs(mpim_group.id);mpim_group.last_msg_input=TS.storage.fetchLastMsgInput(mpim_group.id);mpim_group.scroll_top=-1;mpim_group.history_is_being_fetched=false;mpim_group.needs_api_marking=false;mpim_group.unread_highlight_cnt=0;mpim_group.unread_highlights=[];mpim_group.unread_cnt=0;mpim_group.unreads=[];mpim_group.oldest_unread_ts=null;mpim_group.has_fetched_history_after_scrollback=false;if(TS.client){var stored_msgs=TS.utility.msgs.fetchInitialMsgsFromLS(mpim_group);TS.utility.msgs.setMsgs(mpim_group,stored_msgs)}else{if(TS.boot_data.msgs){TS.utility.msgs.ingestMessagesFromBootData(mpim_group)}}}if(TS.client){var and_mark=TS.utility.msgs.shouldMarkUnreadsOnMessageFetch();TS.mpims.calcUnreadCnts(mpim_group,and_mark)}return mpim_group},markScrollTop:function(id,scroll_top){var mpim=TS.mpims.getMpimById(id);if(!mpim)return false;if(mpim.scroll_top==scroll_top){return false}mpim.scroll_top=scroll_top;return true},maybeLoadScrollBackHistory:function(id,force){var mpim=TS.mpims.getMpimById(id);if(!mpim)return false;return TS.shared.maybeLoadScrollBackHistory(mpim,TS.mpims,force)},onHistory:function(ok,data,args){var mpim=TS.mpims.getMpimById(args.channel);if(!mpim){TS.error('wtf no mpim "'+args.channel+'"');return}if(!ok||!data||!data.messages){TS.error("failed to get history");mpim.history_fetch_retries?mpim.history_fetch_retries++:mpim.history_fetch_retries=1;TS.mpims.history_fetched_sig.dispatch(mpim);return}delete mpim.history_fetch_retries;var fetching_more=TS.shared.onHistory(mpim,data,args,TS.mpims);if(!fetching_more){mpim.history_is_being_fetched=false;TS.mpims.history_fetched_sig.dispatch(mpim)}var and_mark=TS.utility.msgs.shouldMarkUnreadsOnMessageFetch();TS.mpims.calcUnreadCnts(mpim,and_mark);if(TS.view){if(!fetching_more&&mpim.unread_cnt){TS.client.channel_pane.rebuildImAndMpimList()}}},fetchHistory:function(mpim,api_args,handler){if(!mpim){TS.error('wtf no mpim "'+mpim+'"');return}mpim.history_is_being_fetched=true;mpim.history_fetch_failed=false;TS.mpims.history_being_fetched_sig.dispatch(mpim);if(mpim.history_fetch_retries>5){delete mpim.history_fetch_retries;mpim.history_is_being_fetched=false;mpim.history_fetch_failed=true;if(TS.client)TS.client.msg_pane.updateEndMarker();return}TS.api.call("mpim.history",api_args,handler||TS.mpims.onHistory)},setNamesFromMember:function(member){var mpim;var i,j;for(i=0;i<TS.model.mpims.length;i++){mpim=TS.model.mpims[i];for(j=0;j<mpim.members.length;j++){if(member.id===mpim.members[j]){_updateMpimName(mpim);_clearDisplayNameCache(mpim)}}}},checkMpimMatch:function(mpim,prefix_regexes,suffix_regexes){if(!mpim)return;var match_names_only=true;var every_regex_matched=true;var members=TS.mpims.getMembersInDisplayOrder(mpim);for(var i=0;i<prefix_regexes.length;i++){var regex_matched=false;for(var j=0;j<members.length;j++){if(TS.members.checkMemberMatch(members[j],prefix_regexes[i],match_names_only)||suffix_regexes&&TS.members.checkMemberMatch(members[j],suffix_regexes[i],match_names_only)){regex_matched=true}}if(!regex_matched)every_regex_matched=false}return every_regex_matched},setDataRetention:function(group_id,retention_type,retention_duration,handler){var args={channel:group_id,retention_type:$("select[name=retention_type]").val()};if(args.retention_type==1){args.retention_duration=$("#retention_duration").val()}TS.api.call("mpim.setRetention",args,function(ok,data,args){if(handler){handler(ok,data,args)}if(ok){TS.mpims.data_retention_changed_sig.dispatch(args)}})},getDataRetention:function(group_id,handler){TS.api.call("mpim.getRetention",{channel:group_id},handler)},convertToGroup:function(mpim,group_name){var c_id=mpim.id;return TS.api.call("mpim.convertToGroup",{channel:c_id,name:group_name})}});var _id_map={};var _name_map={};var _makeNameForMpim=function(mpim){var members=TS.mpims.getMembersInDisplayOrder(mpim);if(members.length<2){return mpim._internal_name}return"@"+members.map(function(member){if(!member._is_local)return member.name+"_"+member.team_id;return member.name}).join(",")};var _updateMpimName=function(mpim){if(mpim._name_lc)delete _name_map[mpim._name_lc];mpim.name=_makeNameForMpim(mpim);mpim._name_lc=TS.utility.getLowerCaseValue(mpim.name);_name_map[mpim._name_lc]=mpim};var _memberRealNameChanged=function(member){TS.model.mpims.forEach(function(mpim){if(mpim.members.indexOf(member.id)!==-1)_clearDisplayNameCache(mpim)})};var _realNamePrefChanged=function(){TS.model.mpims.forEach(_clearDisplayNameCache)};var _clearDisplayNameCache=function(mpim){delete mpim._display_name;delete mpim._display_name_lc};var _getFirstLetter=function(word){var first=word.charCodeAt(0);var second;if(first>=55296&&first<=56319&&word.length>1){second=word.charCodeAt(1);if(second>=56320&&second<=57343){return word.substring(0,2)}}return word.substring(0,1)}})();(function(){"use strict";TS.registerModule("shared",{msg_sent_sig:new signals.Signal,model_ob_hotness_changed_sig:new signals.Signal,onStart:function(){TS.shared.updateHotnessByIdThrottled=TS.utility.throttleFunc(TS.shared.updateHotnessByIdThrottled,1e3)},calcUnreadCnts:function(model_ob,controller,and_mark){if(model_ob._did_defer_initial_msg_history){TS.shared.checkInitialMsgHistory(model_ob,controller);return}model_ob.unreads.length=0;model_ob.unread_highlights.length=0;model_ob.oldest_unread_ts=null;var msgs=model_ob.msgs;var was_cnt=model_ob.unread_cnt;var was_highlight_cnt=model_ob.unread_highlight_cnt;var msg;var some_can_cnt_as_unread=false;var this_can_cnt_as_unread=false;var can_have_any_unreads=true;var user_is_away=TS.model.user.presence=="away";if(!model_ob.was_archived_this_session){if(model_ob.is_archived)can_have_any_unreads=false;if(model_ob.is_channel&&!model_ob.is_member)can_have_any_unreads=false}if(model_ob.is_im){var member=TS.members.getMemberById(model_ob.user);if(member&&member.deleted)can_have_any_unreads=false}var model_ob_is_muted=TS.notifs.isCorGMuted(model_ob.id);var channel_mentions_can_count=model_ob.is_im||TS.boot_data.feature_mpim_client&&model_ob.is_mpim||TS.notifs.canCorGHaveChannelMentions(model_ob.id);if(can_have_any_unreads&&msgs){for(var i=0;i<msgs.length;i++){msg=msgs[i];if(msg.ts<=model_ob.last_read)continue;if(TS.utility.msgs.isTempMsg(msg)&&!msg._alert_even_though_temp)continue;this_can_cnt_as_unread=TS.utility.msgs.msgCanCountAsUnread(msg);some_can_cnt_as_unread=some_can_cnt_as_unread||this_can_cnt_as_unread;if(!this_can_cnt_as_unread)continue;model_ob.unreads.push(msg.ts);if(!model_ob.oldest_unread_ts||msg.ts<model_ob.oldest_unread_ts){model_ob.oldest_unread_ts=msg.ts}if(channel_mentions_can_count){var msg_time_ms=parseFloat(msg.ts)*1e3;var ignore_at_here_mentions=user_is_away||msg_time_ms<TS.model.user._presence_last_changed;if(TS.utility.msgs.msgContainsMention(msg,ignore_at_here_mentions)){model_ob.unread_highlights.push(msg.ts)}}else{if(TS.utility.msgs.getMsgMentionData(msg).non_channel_mentions){model_ob.unread_highlights.push(msg.ts)}}}}if(!some_can_cnt_as_unread&&model_ob.unreads.length){model_ob.unreads.length=0;model_ob.unread_highlights.length=0;model_ob.oldest_unread_ts=null;if(and_mark){controller.markMostRecentReadMsg(model_ob,TS.model.marked_reasons.none_qualify)}}model_ob.unread_cnt=model_ob.unreads.length;if(model_ob_is_muted){if(model_ob.unread_cnt)model_ob._show_in_list_even_though_no_unreads=true}model_ob.unread_highlight_cnt=model_ob.unread_highlights.length;TS.shared.maybeMarkReadIfMuted(model_ob,controller);TS.utility.msgs.countAllUnreads();if(was_cnt!=model_ob.unread_cnt){controller.unread_changed_sig.dispatch(model_ob)}if(was_highlight_cnt!=model_ob.unread_highlight_cnt){controller.unread_highlight_changed_sig.dispatch(model_ob)}if(TS.model.prefs.hotness){TS.shared.updateHotnessByIdThrottled(model_ob.id)}},getLatestMsgTs:function(model_ob){if(model_ob.latest&&model_ob.latest.ts){return model_ob.latest.ts}return model_ob.latest},checkInitialMsgHistory:function(model_ob,controller,defer_api_check){if(model_ob.history_is_being_fetched){TS.warn('checkInitialMsgHistory NOT DOING ANYTHING, because "'+model_ob.name+'" history_is_being_fetched:true');return}delete model_ob._did_defer_initial_msg_history;var initial_count=TS.model.initial_msgs_cnt;var latest_ts=TS.shared.getLatestMsgTs(model_ob);if(!latest_ts){TS.shared.maybeDealWithAllSentTempMsgs(model_ob,controller)}else{var msg=TS.utility.msgs.getMsg(latest_ts,model_ob.msgs);if(msg){TS.log(58,'we have all recent "'+model_ob.id+'" "'+model_ob.name+'" msgs unread_count:'+model_ob.unread_count+" unread_cnt:"+model_ob.unread_cnt+" initial_count:"+initial_count);TS.shared.maybeDealWithAllSentTempMsgs(model_ob,controller);var status=TS.utility.msgs.getOlderMsgsStatus(model_ob);if(model_ob.msgs.length<TS.model.initial_msgs_cnt&&status.more){TS.error("calling loadHistory because status.more=true && model_ob.msgs.length < TS.model.initial_msgs_cnt: "+model_ob.msgs.length+" < "+TS.model.initial_msgs_cnt);TS.dir(0,status,model_ob.name);TS.shared.loadHistory(model_ob,controller,initial_count);return true}if(!TS.boot_data.feature_no_unread_counts){if(model_ob.msgs.length<model_ob.unread_count&&status.more){initial_count=Math.min(TS.model.special_initial_msgs_cnt,model_ob.unread_count-model_ob.msgs.length+1);TS.log(58,"calling loadHistory because model_ob.msgs.length < model_ob.unread_count");TS.warn('setting special initial_count for "'+model_ob.id+'" "'+model_ob.name+'" to:'+initial_count);TS.shared.loadHistory(model_ob,controller,initial_count);return true}}}else if(defer_api_check){TS.log(58,'We do not have recent messages for "'+model_ob.id+'" "'+model_ob.name+'" but are deferring the fetch until it is required');model_ob._did_defer_initial_msg_history=true}else{TS.log(58,'WE DO NOT HAVE ALL RECENT MESSAGES for "'+model_ob.id+'" "'+model_ob.name+'" unread_count:'+model_ob.unread_count+" unread_cnt:"+model_ob.unread_cnt+" initial_count:"+initial_count);var no_oldest=false;if(!TS.boot_data.feature_no_unread_counts&&model_ob.unread_count>TS.model.initial_msgs_cnt){initial_count=Math.min(TS.model.special_initial_msgs_cnt,model_ob.unread_count);TS.warn('setting special initial_count for "'+model_ob.id+'" "'+model_ob.name+'" to:'+initial_count)}else if(!model_ob.msgs.length){}var api_args={channel:model_ob.id,latest:latest_ts,count:initial_count,inclusive:typeof model_ob.latest=="string"};if(no_oldest){TS.log(58,'we have some but not all recent "'+model_ob.id+'" "'+model_ob.name+'" msgs but we no_oldest so are not setting oldest for api call')}else if(model_ob.msgs.length&&!TS.utility.msgs.isTempMsg(model_ob.msgs[0])){TS.log(58,'we have some but not all recent "'+model_ob.id+'" "'+model_ob.name+'" msgs');api_args.oldest=model_ob.msgs[0].ts}else{TS.log(58,'we have no "'+model_ob.id+'" msgs')}var doIt=function(){controller.fetchHistory(model_ob,api_args)};if(TS.model.ms_connected){doIt()}else{TS.ms.connected_sig.addOnce(doIt)}}}},maybeLoadScrollBackHistory:function(model_ob,controller,force){
if(!force&&model_ob.scroll_top!==0)return false;var status=TS.utility.msgs.getOlderMsgsStatus(model_ob);if(!status.more){TS.info("Not loading scrollback in "+model_ob.id+": "+status.text);if(status.code===3){TS.shared.checkForMoreMsgs(model_ob).then(function(){TS.logError({message:"more messages than expected in "+model_ob.id},"maybeLoadScrollBackHistory: oldest_msg_ts or is_limited is wrong");if(TS.shared.getActiveModelOb().id!==model_ob.id||model_ob.history_is_being_fetched)return;if(model_ob.is_limited)model_ob.is_limited=false;if(model_ob.oldest_msg_ts)TS.utility.msgs.resetOldestMsgsTs(model_ob);TS.shared.loadScrollBackHistory(model_ob,controller)},$.noop)}return false}return TS.shared.loadScrollBackHistory(model_ob,controller)},loadScrollBackHistory:function(model_ob,controller){if(!model_ob.msgs.length)return;TS.info(model_ob.id+" HAS MORE");TS.shared.loadHistory(model_ob,controller);model_ob.has_fetched_history_after_scrollback=true;model_ob.fetched_history_after_scrollback_time=Date.now();return true},loadHistory:function(model_ob,controller,count){var api_args={channel:model_ob.id,latest:model_ob.msgs[model_ob.msgs.length-1].ts,count:count||TS.model.subsequent_msgs_cnt};controller.fetchHistory(model_ob,api_args)},checkForMoreMsgs:function(model_ob){return TS.api.call(TS.shared.getHistoryApiMethodForModelOb(model_ob),{channel:model_ob.id,latest:model_ob.msgs[model_ob.msgs.length-1].ts,count:1}).then(function(res){if(res.data.messages&&res.data.messages.length>0){return Promise.resolve(res)}else{return Promise.reject(new Error("No more messages"))}})},onSendMsg:function(success,imsg,model_ob,controller){var temp_msg=TS.utility.msgs.getMsgByRspId(imsg.reply_to,model_ob.msgs);if(!success){if(temp_msg){TS.model.unsent_msgs[temp_msg.ts]=true;controller.msg_not_sent_sig.dispatch(model_ob,temp_msg,imsg)}else{TS.error("that makes no sense")}return}TS.view.scroll_down_when_msg_from_user_is_added=true;var new_msg;if(temp_msg){new_msg=TS.utility.clone(temp_msg);new_msg.text=imsg.text;new_msg.ts=imsg.ts;delete new_msg.rsp_id;controller.removeMsg(model_ob.id,temp_msg)}else{TS.warn("no temp msg for "+imsg.reply_to);new_msg={text:imsg.text,user:TS.model.user.id,ts:imsg.ts}}if(TS.boot_data.feature_message_replies&&imsg.SENT_MSG.thread_ts){new_msg.thread_ts=imsg.SENT_MSG.thread_ts;new_msg.parent_ts=imsg.SENT_MSG.parent_ts;new_msg.parent_user_id=imsg.SENT_MSG.parent_user_id}controller.addMsg(imsg.SENT_MSG.channel||model_ob.id,TS.utility.msgs.processImsg(new_msg,model_ob.id));TS.client.ui.maybeHandleSingleEmoji(imsg.text);TS.prefs.recordEmojiUse(imsg.text);var not_present_membersA;var what;var ts=TS.utility.date.makeTsStamp();if(model_ob.is_channel){what="channel";not_present_membersA=TS.channels.getActiveMembersNotInThisChannelForInviting(model_ob.id)}else if(model_ob.is_group&&!model_ob.is_mpim){what=TS.templates.builders.groupCopy();not_present_membersA=TS.groups.getActiveMembersNotInThisGroupForInviting(model_ob.id)}else{return}if(!not_present_membersA.length)return;if(TS.boot_data.feature_subteams){var subteam_matches=imsg.text.match(/<!subteam\^(.*?)\|@.+>/g);if(subteam_matches){for(var k=0;k<subteam_matches.length;k++){var cmd=subteam_matches[k].replace(">","").replace("<","");cmd=cmd.split("|")[0];var user_group_id=cmd.split("^")[1];if(!user_group_id)continue;(function(local_user_group_id){TS.user_groups.getUserGroupMembers(local_user_group_id,function(updated_group){var members_not_in_channel=[];var user_group_members=updated_group.users;if(!user_group_members)return;for(var j=0;j<user_group_members.length;j++){var member=TS.members.getMemberById(user_group_members[j]);if(not_present_membersA.indexOf(member)==-1)continue;if(members_not_in_channel.indexOf(member)>-1)continue;members_not_in_channel.push(member)}if(!members_not_in_channel.length)return;var member_idsA=members_not_in_channel.map(function(member){return member.id});var name="<!subteam^"+local_user_group_id+">";var count=members_not_in_channel.length;var prompt="TS.client.ui.promptForGroupOrChannelInvite('"+model_ob.id+"', '"+member_idsA.join(",")+"', '"+ts+"')";var message="TS.client.ui.sendChannelMsgThroughSlackBot('"+model_ob.id+"', '"+imsg.ts+"', '"+member_idsA.join(",")+"', '"+ts+"')";var nothing="TS.utility.msgs.removeEphemeralMsg('"+model_ob.id+"', '"+ts+"')";TS.client.msg_pane.addMaybeClick(prompt,TS.client.ui.promptForGroupOrChannelInvite.bind(Object.create(null),model_ob.id,member_idsA.join(","),ts));TS.client.msg_pane.addMaybeClick(message,TS.client.ui.sendChannelMsgThroughSlackBot.bind(Object.create(null),model_ob.id,imsg.ts,member_idsA.join(","),ts));TS.client.msg_pane.addMaybeClick(nothing,TS.utility.msgs.removeEphemeralMsg.bind(Object.create(null),model_ob.id,ts));var bot_text=[];bot_text.push("You mentioned the "+name+" user group, but "+(count===1?"one member":count+" members")," of that user group"+(count===1?" is":" are")+" not in this "+what+".");if(model_ob.id.charAt(0)==="G"){bot_text.push(" If you'd like I can"," <javascript:"+prompt+"|invite them to join>,"," or, <javascript:"+nothing+"|do nothing>.")}else{bot_text.push(" If you'd like I can"," <javascript:"+message+"|send them a link to this message>?"," Or, <javascript:"+nothing+"|do nothing>.")}TS.client.ui.addEphemeralBotMsg({channel:model_ob.id,ts:ts,text:bot_text.join("")});ts=TS.utility.date.makeTsStamp()})})(user_group_id)}}}var mention_matches=imsg.text.match(/<@(.*?)>/g);var bad_mention_membersA=[];var member;var i;if(mention_matches){for(i=0;i<mention_matches.length;i++){member=TS.utility.msgs.getMemberFromMemberMarkup(mention_matches[i].replace(">","").replace("<",""));if(not_present_membersA.indexOf(member)==-1)continue;if(bad_mention_membersA.indexOf(member)>-1)continue;bad_mention_membersA.push(member)}}if(!bad_mention_membersA.length)return;var names_text="";var member_idsA=[];for(i=0;i<bad_mention_membersA.length;i++){if(i!==0){if(i==bad_mention_membersA.length-1){if(bad_mention_membersA.length>2)names_text+=",";names_text+=" and "}else{names_text+=", "}}names_text+="<@"+bad_mention_membersA[i].id+">";member_idsA.push(bad_mention_membersA[i].id)}var prompt="TS.client.ui.promptForGroupOrChannelInvite('"+model_ob.id+"', '"+member_idsA.join(",")+"', '"+ts+"')";var message="TS.client.ui.sendChannelMsgThroughSlackBot('"+model_ob.id+"', '"+imsg.ts+"', '"+member_idsA.join(",")+"', '"+ts+"')";var nothing="TS.utility.msgs.removeEphemeralMsg('"+model_ob.id+"', '"+ts+"')";TS.client.msg_pane.addMaybeClick(prompt,TS.client.ui.promptForGroupOrChannelInvite.bind(Object.create(null),model_ob.id,member_idsA.join(","),ts));TS.client.msg_pane.addMaybeClick(message,TS.client.ui.sendChannelMsgThroughSlackBot.bind(Object.create(null),model_ob.id,imsg.ts,member_idsA.join(","),ts));TS.client.msg_pane.addMaybeClick(nothing,TS.utility.msgs.removeEphemeralMsg.bind(Object.create(null),model_ob.id,ts));TS.client.ui.addEphemeralBotMsg({channel:model_ob.id,ts:ts,text:"You mentioned "+names_text+", but they're not in this "+what+". Would you like to "+"<javascript:"+prompt+"|invite them to join>"+(model_ob.is_group?"?":" or have slackbot <javascript:"+message+"|send them a link to your message>?")+" Or, <javascript:"+nothing+"|do nothing>."})},sendMsg:function(c_id,text,controller,in_reply_to_msg){if(!text)return false;var model_ob=TS.shared.getModelObById(c_id);var d=model_ob&&model_ob.msgs&&model_ob.msgs[0]&&TS.utility.date.toDateObject(model_ob.msgs[0].ts+1)||Date.now();var temp_ts=TS.utility.date.makeTsStamp(d);text=TS.format.cleanMsg(text);if(text.indexOf("DELEEEEETETEEESTTTT")===0)TS.ms.disconnect();var params={type:"message",channel:c_id,text:$.trim(text)};if(TS.boot_data.feature_message_replies&&in_reply_to_msg){params.thread_ts=in_reply_to_msg.thread_ts||in_reply_to_msg.ts;params.parent_ts=in_reply_to_msg.ts;params.parent_user_id=in_reply_to_msg.user}var rsp_id=TS.ms.send(params,controller.onSendMsg,temp_ts);TS.typing.userEnded(model_ob);var placeholder_msg={type:"message",text:text,user:TS.model.user.id,ts:temp_ts,rsp_id:rsp_id};if(params.thread_ts){placeholder_msg.thread_ts=params.thread_ts;placeholder_msg.parent_ts=params.parent_ts;placeholder_msg.parent_user_id=params.parent_user_id}controller.addMsg(c_id,placeholder_msg);TS.shared.msg_sent_sig.dispatch(model_ob,rsp_id);return true},sendMsgGroup:function(model_ob_id,text,controller,in_reply_to_msg){var model_ob=TS.shared.getModelObById(model_ob_id);var model_label=model_ob.is_mpim?"conversation":TS.templates.builders.groupCopy({skip_private:true});if(!model_ob)return false;if(model_ob.is_archived)return false;var general=TS.channels.getGeneralChannel();var errorOut=function(err_txt){TS.generic_dialog.alert(err_txt).then(function(){if(TS.boot_data.feature_message_replies&&in_reply_to_msg){TS.ui.replies.focusReplyInput()}else{TS.view.focusMessageInput()}});if(TS.boot_data.feature_message_replies&&in_reply_to_msg){TS.ui.replies.populateReplyInput(text)}else{TS.client.ui.$msg_input.val(text)}};var clean_text=TS.format.cleanMsg(text);var err_txt;if(TS.model.everyone_regex.test(clean_text)){if(!TS.members.canUserAtEveryone()){err_txt="<p>A team owner has restricted the use of <b>@everyone</b> messages.</p>";if(TS.model.user.is_restricted){err_txt="<p>Your account is restricted, and you cannot send <b>@everyone</b> messages.</p>"}if(TS.members.canUserAtChannelOrAtGroup()){err_txt+='<p class="no_bottom_margin">If you just want to address everyone in this '+model_label+", use <b>@"+model_label+"</b> instead.</p>"}errorOut(err_txt);return false}if(!general||!general.is_member){err_txt="<p>You cannot send <b>@everyone</b> messages.</p>";if(TS.members.canUserAtChannelOrAtGroup()){err_txt+='<p class="no_bottom_margin">If you just want to address everyone in this '+model_label+", use <b>@"+model_label+"</b> instead.</p>"}errorOut(err_txt)}else{TS.generic_dialog.start({title:"Send @everyone a message",body:'<p class="bold">Would you like to switch to #'+TS.utility.htmlEntities(general.name)+' and send your message?</p><p class="">Using <b>@everyone</b> in a message is a way to address your whole team, but it must be done in the #'+TS.utility.htmlEntities(general.name)+' channel.</p><p class="no_bottom_margin">If you just want to address everyone in this '+model_label+", use <b>@"+TS.templates.builders.groupCopy({skip_private:true})+"</b> instead.</p>",show_cancel_button:true,show_go_button:true,go_button_text:"Yes, send it",onGo:function(){TS.channels.displayChannel(general.id,text)},onCancel:function(){TS.client.ui.$msg_input.val(text);TS.view.focusMessageInput()}})}return false}var is_at_here=TS.model.here_regex.test(clean_text);var is_at_group=TS.model.channel_regex.test(clean_text)||TS.model.group_regex.test(clean_text)||is_at_here;if(is_at_group&&!TS.members.canUserAtChannelOrAtGroup()){var key_word=is_at_here?"@here":"@"+TS.templates.builders.groupCopy({skip_private:true});err_txt="<p>A team owner has restricted the use of <b>"+key_word+"</b> messages.</p>";errorOut(err_txt);return false}if(TS.ui.needToShowAtChannelWarning(model_ob_id,text)){TS.ui.at_channel_warning_dialog.startInMessagePane(model_ob_id,text,controller);return false}return TS.shared.sendMsg(model_ob_id,text,controller,in_reply_to_msg)},onHistory:function(model_ob,data,args,controller){var msgs=model_ob.msgs;var imsg;if(data.is_limited){data.has_more=false;model_ob.is_limited=true}if(args.oldest){if(data.has_more){TS.info(model_ob.name+" has more than one page of msg history between what is in cache and the latest, so let's dump what we have and just use this page of results");TS.info(model_ob.name+" args.oldest:"+args.oldest);msgs.length=0;if(model_ob.is_limited)model_ob.is_limited=false}}var new_msgs=[];if(data.messages){for(var i=0;i<data.messages.length;i++){if(!TS.utility.msgs.getMsg(data.messages[i].ts,msgs)){imsg=data.messages[i];new_msgs.push(TS.utility.msgs.processImsgFromHistory(imsg,model_ob.id))}}}if(new_msgs.length&&!TS.utility.msgs.getDisplayedMsgs(new_msgs).length){TS.warn("no displayed msgs in this page for "+model_ob.id+' "'+model_ob.name+'"! We expect TS.client.ui.afterHistoryFetch to detect this and load another page')}msgs=TS.utility.msgs.setMsgs(model_ob,new_msgs.concat(msgs));TS.log(4,model_ob.id+" msgs has more history now");if(model_ob.latest&&model_ob.latest.ts&&!TS.utility.msgs.getMsg(model_ob.latest.ts,msgs)){TS.log(4,"tacking on latest msg "+model_ob.latest.ts);imsg=model_ob.latest;TS.utility.msgs.appendMsg(msgs,TS.utility.msgs.processImsgFromHistory(imsg,model_ob.id));TS.utility.msgs.sortMsgs(msgs);TS.utility.msgs.maybeStoreMsgs(model_ob.id,msgs)}if(!args.oldest){if(!data.has_more&&!data.is_limited){TS.utility.msgs.setOldestMsgsTs(model_ob)}}TS.shared.maybeDealWithAllSentTempMsgs(model_ob,controller)},maybeDealWithAllSentTempMsgs:function(model_ob,controller){if(!TS.ms)return;for(var k in TS.ms.sent_map){var sent_data=TS.ms.sent_map[k];if(sent_data.msg.channel!=model_ob.id)continue;var temp_ts=sent_data.temp_ts;var temp_msg=TS.utility.msgs.getMsg(temp_ts,model_ob.msgs);if(!temp_msg){continue}var existing_msg=TS.utility.msgs.getNonTempMsgFromUserMatchingText(sent_data.msg.text,TS.model.user.id,model_ob.msgs);if(existing_msg){var existing_time=TS.utility.date.toDateObject(existing_msg.ts);var temp_time=TS.utility.date.toDateObject(temp_ts);if(existing_time<temp_time){TS.info("existing_msg time is older than temp_msg time, so it cant be the message we were looking for");existing_msg=null}}if(!existing_msg){TS.warn("not removing, we dont appear to have this non-temp message:"+sent_data.msg.text);TS.model.unsent_msgs[temp_msg.ts]=true;controller.msg_not_sent_sig.dispatch(model_ob,temp_msg);continue}TS.info("removing temp_msg:"+temp_msg.ts+" "+temp_msg.text+" existing_msg:"+existing_msg.ts+" "+existing_msg.text);delete TS.ms.sent_map[k];if(model_ob.is_channel){TS.channels.removeMsg(model_ob.id,temp_msg)}else if(TS.boot_data.feature_mpim_client&&model_ob.is_mpim){TS.mpims.removeMsg(model_ob.id,temp_msg)}else if(model_ob.is_group){TS.groups.removeMsg(model_ob.id,temp_msg)}else{TS.ims.removeMsg(model_ob.id,temp_msg)}}},getControllerForModelOb:function(model_ob){if(model_ob.is_mpim&&TS.boot_data.feature_mpim_client){return TS.mpims}else if(model_ob.is_group){return TS.groups}else if(model_ob.is_im){return TS.ims}else{return TS.channels}},getActiveModelOb:function(){var model_ob;if(TS.client){if(TS.model.active_channel_id){model_ob=TS.channels.getChannelById(TS.model.active_channel_id)}else if(TS.model.active_im_id){model_ob=TS.ims.getImById(TS.model.active_im_id)}else if(TS.boot_data.feature_mpim_client&&TS.model.active_mpim_id){model_ob=TS.mpims.getMpimById(TS.model.active_mpim_id)}else if(TS.model.active_group_id){model_ob=TS.groups.getGroupById(TS.model.active_group_id)}else{}}else{if(TS.boot_data.channel_id){model_ob=TS.channels.getChannelById(TS.boot_data.channel_id)}else if(TS.boot_data.im_id){model_ob=TS.ims.getImById(TS.boot_data.im_id)}else if(TS.boot_data.feature_mpim_client&&TS.boot_data.mpim_id){model_ob=TS.mpims.getMpimById(TS.boot_data.mpim_id)}else if(TS.boot_data.group_id){model_ob=TS.groups.getGroupById(TS.boot_data.group_id)}else{TS.warn("WTF getActiveModelOb found no ob");TS.warn("TS.boot_data.channel_id: "+TS.boot_data.channel_id);TS.warn("TS.boot_data.im_id: "+TS.boot_data.im_id);TS.warn("TS.boot_data.group_id: "+TS.boot_data.group_id)}}return model_ob},getDisplayNameForModelOb:function(model_ob){if(model_ob.is_mpim){return TS.mpims.getDisplayName(model_ob)}else if(model_ob.is_im){var escaped=false;var include_at_sign=true;return TS.members.getMemberDisplayNameById(model_ob.user,escaped,include_at_sign)}else if(model_ob.is_group){return model_ob.name}else if(model_ob.is_channel){return"#"+model_ob.name}else{TS.warn("getDisplayNameForModelOb: unknown model_ob type: "+model_ob.id);return model_ob.id}},getDisplayNameForModelObNoSigns:function(model_ob){if(model_ob.is_mpim){return TS.mpims.getDisplayName(model_ob)}else if(model_ob.is_im){var escaped=false;var include_at_sign=false;return TS.members.getMemberDisplayNameById(model_ob.user,escaped,include_at_sign)}else if(model_ob.is_group){return model_ob.name}else if(model_ob.is_channel){return model_ob.name}else{TS.warn("getDisplayNameForModelOb: unknown model_ob type: "+model_ob.id);return model_ob.id}},getModelObById:function(c_id){if(!c_id)return null;if(c_id.charAt(0)==="C"){return TS.channels.getChannelById(c_id)}else if(c_id.charAt(0)==="G"){return TS.mpims.getMpimById(c_id)||TS.groups.getGroupById(c_id)}else{return TS.ims.getImById(c_id)}},getAllModelObsForUser:function(){return TS.channels.getChannelsForUser().concat(TS.model.groups,TS.model.ims,TS.model.mpims)},getShareModelObId:function(model_ob_id,callback){var im;var channel;var maybeCancelArchivesView=function(id){if(TS.model.archive_view_is_showing&&TS.client.archives.current_model_ob.id==id){TS.client.archives.cancel()}};if(model_ob_id&&model_ob_id.charAt(0)==="U"){im=TS.ims.getImByMemberId(model_ob_id);if(!im){TS.api.call("im.open",{user:model_ob_id,reason:"TS.shared.getShareModelObId"},function(ok,data){if(ok){im=TS.ims.getImByMemberId(model_ob_id);if(im){callback(im.id)}else if(TS.web){callback(data.channel.id)}else{TS.error("getShareModelObId opened an IM, but it is not in the model? data.channel.id: "+data.channel.id)}}else{TS.error("getShareModelObId try to open an IM, but failed data: "+JSON.stringify(data||null))}})}else{model_ob_id=im.id;maybeCancelArchivesView(model_ob_id);callback(model_ob_id)}}else if(model_ob_id&&model_ob_id.charAt(0)==="C"){channel=TS.channels.getChannelById(model_ob_id);if(!channel.is_member&&!channel.is_archived){TS.channels.join(channel.name,function(ok,data,args){if(ok){callback(model_ob_id)}else{callback(model_ob_id)}})}else{maybeCancelArchivesView(model_ob_id);callback(model_ob_id)}}else{maybeCancelArchivesView(model_ob_id);callback(model_ob_id)}},getModelObIdForSendingMsg:function(id,callback){var im;var channel;if(id&&id.charAt(0)==="U"){im=TS.ims.getImByMemberId(id);if(!im){TS.api.call("im.open",{user:id,reason:"TS.shared.getModelObIdForSendingMsg"},function(ok,data){if(ok){im=TS.ims.getImByMemberId(id);if(im){callback(im.id)}else if(TS.web){callback(data.channel.id)}else{TS.error("getModelObIdForSendingMsg opened an IM, but it is not in the model? data.channel.id: "+data.channel.id)}}else{TS.error("getModelObIdForSendingMsg try to open an IM, but failed data: "+JSON.stringify(data||null))}})}else{id=im.id;callback(id)}}else if(id&&id.charAt(0)==="C"){channel=TS.channels.getChannelById(id);if(!channel.is_member&&!channel.is_archived){TS.channels.join(channel.name,function(ok,data,args){if(ok){callback(id)}else{callback(id)}})}else{callback(id)}}else{callback(id)}},maybeMarkReadIfMuted:function(model_ob,controller){if(!model_ob)return;if(!TS.notifs.isCorGMuted(model_ob.id))return;if(!model_ob.unreads.length||model_ob.unread_highlights.length)return;if(TS.model.prefs.sidebar_behavior=="hide_read_channels"){if(TS.model.active_cid==model_ob.id)return}else if(TS.model.prefs.sidebar_behavior=="hide_read_channels_unless_starred"&&!model_ob.is_starred){if(TS.model.active_cid==model_ob.id)return}if(TS.boot_data.feature_mpim_client&&model_ob.is_mpim){TS.mpims.markMostRecentReadMsg(model_ob,TS.model.marked_reasons.muted)}else if(model_ob.is_group){TS.groups.markMostRecentReadMsg(model_ob,TS.model.marked_reasons.muted)}else{TS.channels.markMostRecentReadMsg(model_ob,TS.model.marked_reasons.muted)}},closeArchivedChannel:function(id){var model_ob=TS.shared.getModelObById(id);if(!model_ob)return;if(!model_ob.is_archived)return;model_ob.was_archived_this_session=false;TS.client.activeChannelDisplayGoneAway()},getLastMsg:function(model_ob){if(!model_ob.msgs||model_ob.msgs.length===0)return null;for(var i=0;i<model_ob.msgs.length;i++){if(!model_ob.msgs[i].no_display&&!model_ob.msgs[i].is_ephemeral)return model_ob.msgs[i]}return null},sorterByLastMsg:function(a,b){var a_msg=a&&TS.shared.getLastMsg(a);var b_msg=b&&TS.shared.getLastMsg(b);var a_ts;var b_ts;if(a_msg){a_ts=parseFloat(a_msg.ts)}else if(a){a_ts=TS.shared.getLatestMsgTs(a);if(a_ts)a_ts=parseFloat(a_ts)}if(b_msg){b_ts=parseFloat(b_msg.ts)}else if(b){b_ts=TS.shared.getLatestMsgTs(b);if(b_ts)b_ts=parseFloat(b_ts)}if(a_ts&&b_ts){if(a_ts>b_ts)return-1;if(b_ts>a_ts)return 1}else{if(a_ts)return-1;if(b_ts)return 1}return 0},hasUnreads:function(model_ob){if(!model_ob)return false;if(!TS.boot_data.feature_no_unread_counts){return!!model_ob.unread_count}var latest_ts=TS.shared.getLatestMsgTs(model_ob);if(!latest_ts)return false;return latest_ts>model_ob.last_read},checkForOldImsToClose:function(){var ims=TS.model.ims;var mpims=TS.model.mpims;var model_obs=ims.concat(mpims);var model_ob;var activity_ts;var activity_date;var ms_since_activity;var i;var dms_listed_cnt=0;var allow_in_list=11;var allow_elapsed_ms=1e3*60*60*168;for(i=0;i<model_obs.length;i++){model_ob=model_obs[i];if(!model_ob.is_open&&!model_ob.unread_cnt)continue;dms_listed_cnt++}var this_too_many=dms_listed_cnt-allow_in_list;if(this_too_many<1){return}TS.info("checkForOldImsToClose might close some. this_too_many:"+this_too_many);var leaveA=[];for(i=0;i<model_obs.length;i++){model_ob=model_obs[i];if(model_ob.is_slackbot_im)continue;if(!model_ob.is_open)continue;if(model_ob.unread_cnt)continue;if(model_ob.is_starred)continue;if(model_ob.opened_this_session)continue;activity_ts=TS.shared.getLatestMsgTs(model_ob)||"";if(model_ob.msgs&&model_ob.msgs.length&&model_ob.msgs[0]&&model_ob.msgs[0].ts>activity_ts){activity_ts=model_ob.msgs[0].ts}if(activity_ts){activity_date=TS.utility.date.toDateObject(activity_ts)}else{activity_date=new Date(model_ob.created*1e3)}ms_since_activity=new Date-activity_date;if(ms_since_activity>allow_elapsed_ms){TS.info(model_ob.name+" "+activity_date+" ms_since_activity:"+ms_since_activity+" allow_elapsed_ms:"+allow_elapsed_ms);leaveA.push({model_ob:model_ob,ms_since_activity:ms_since_activity})}}if(!leaveA.length){TS.info("checkForOldImsToClose found no candidates for closing")}leaveA.sort(function compare(a,b){var a_srt=a.ms_since_activity;var b_srt=b.ms_since_activity;if(a_srt<b_srt)return 1;if(a_srt>b_srt)return-1;return 0});leaveA.length=leaveA.length>this_too_many?this_too_many:leaveA.length;for(i=0;i<leaveA.length;i++){model_ob=leaveA[i].model_ob;TS.warn("checkForOldImsToClose CLOSING:"+model_ob.name+" ms_since_activity:"+leaveA[i].ms_since_activity);if(model_ob.is_im){TS.ims.closeIm(model_ob.id)}else if(model_ob.is_mpim){TS.mpims.closeMpim(model_ob.id)}}},ensureModelObIsPresent:function(c_id){return new Promise(function(resolve,reject){if(!c_id)return resolve();if(typeof c_id!=="string")return resolve();_getModelObByIdFromModelOrApi(c_id).then(resolve,reject)})},getModelObIdsNotPresent:function(c_ids){return c_ids.filter(function(c_id){return!TS.shared.getModelObById(c_id)})},ensureModelObsArePresent:function(c_ids){if(!c_ids||!c_ids.length){return Promise.resolve()}var promises=c_ids.map(function(c_id,i){return TS.shared.ensureModelObIsPresent(c_id).reflect()});return Promise.all(promises).then(function(results){var rejection_reasons=[];results.forEach(function(result){if(result.isFulfilled())return;rejection_reasons.push(result.reason())});if(rejection_reasons.length){return Promise.reject(new Error("some ensureModelObsArePresent c_ids failed:\n"+rejection_reasons.join("\n")))}else{return Promise.resolve()}})},ensureModelObsInDataArePresent:function(data,source){var c_ids=TS.utility.extractAllModelObIds(data,source);return TS.shared.ensureModelObsArePresent(c_ids)},fetchInitialModelObData:function(c_id){return new Promise(function(resolve,reject){var method="channels.view";if(TS.boot_data.feature_web_lean_all_users){if(c_id.charAt(0)==="C"){method="channels.info"}else if(c_id.charAt(0)==="G"){method="groups.info"}else{method="im.info"}}return TS.api.callImmediately(method,{channel:c_id}).then(function(resp){var model_ob_data=resp.data.channel||resp.data.im||resp.data.mpim||resp.data.group;var model_ob;if(model_ob_data.is_channel){model_ob=TS.channels.upsertChannel(model_ob_data)}else if(model_ob_data.is_im){model_ob=TS.ims.upsertIm(model_ob_data)}else if(model_ob_data.is_mpim){model_ob=TS.mpims.upsertMpim(model_ob_data)}else if(model_ob_data.is_group){model_ob=TS.groups.upsertGroup(model_ob_data)}if(resp.data.history)model_ob._prefetched_history=resp.data.history;if(resp.data.users){resp.data.users.forEach(function(m){TS.members.upsertMember(m)})}if(resp.data.self)TS.members.upsertMember(resp.data.self);resolve()},function(){reject(Error("fetchChannelView api call failed: "+method+" channel:"+c_id))})})},updateHotnessForAll:function(){return _updateHotness()},updateHotnessByIdThrottled:function(c_id){return _updateHotness(c_id)},getHistoryApiMethodForModelOb:function(model_ob){if(TS.boot_data.feature_mpim_client&&model_ob.is_mpim)return"mpim.history";if(model_ob.is_group)return"groups.history";if(model_ob.is_im)return"im.history";return"channels.history"},addMsg:function(model_ob,msg){return _addMsgsWorker(model_ob,[msg])},addMsgs:function(model_ob,msgs){if(_addMsgsWorker(model_ob,msgs)){var and_mark=false;if(model_ob.is_channel){TS.channels.calcUnreadCnts(model_ob,and_mark)}else if(model_ob.is_mpim){TS.mpims.calcUnreadCnts(model_ob,and_mark)}else if(model_ob.is_group){TS.groups.calcUnreadCnts(model_ob,and_mark)}else if(model_ob.is_im){TS.ims.calcUnreadCnts(model_ob,and_mark)}TS.utility.msgs.maybeTruncateMsgs(model_ob);if(TS.client)TS.client.msg_pane.rebuildMsgs();return true}return false},kickMember:function(model_ob,member_id){var is_kickable_model_ob=model_ob.is_channel||model_ob.is_group&&!model_ob.is_mpim;if(!is_kickable_model_ob)return;if(model_ob.is_group){if(!TS.members.canUserKickFromGroups())return}else{if(!TS.members.canUserKickFromChannels())return}var member=TS.members.getMemberById(member_id);if(!member)return;var escaped=true;var include_at_sign=true;var member_display_name=TS.members.getMemberDisplayName(member,escaped,include_at_sign);var model_ob_display_name=TS.shared.getDisplayNameForModelOb(model_ob);if(model_ob.members.indexOf(member.id)==-1){TS.generic_dialog.alert("<b>"+member_display_name+"</b> is not a member of "+model_ob_display_name+".");return}var confirm_msg;if(model_ob.is_group){confirm_msg="<p>If you remove <b>"+member_display_name+"</b> from "+model_ob_display_name+", they will no longer be able to see any of its messages. To rejoin the "+TS.templates.builders.groupCopy()+", they will have to be re-invited.</p><p>Are you sure you wish to do this?</p>"}else{confirm_msg="<p>Are you sure you wish to remove <b>"+member_display_name+"</b> from "+model_ob_display_name+"?</p>"}var api_endpoint=model_ob.is_group?"groups.kick":"channels.kick";TS.generic_dialog.start({title:"Remove "+member_display_name,body:confirm_msg,go_button_text:"Yes, remove them",onGo:function(){TS.api.call(api_endpoint,{channel:model_ob.id,user:member_id}).catch(function(resp){TS.info("Removing user failed; api="+api_endpoint+"; error="+resp.data.error);setTimeout(function(){var account_type=member.is_ultra_restricted?"Single-channel guests":TS.templates.builders.raLabel("Restricted accounts");if(resp.data.error=="cant_kick_from_last_channel"&&TS.model.user.is_admin){TS.generic_dialog.start({title:"Removing "+member_display_name+" failed",body:"<p>"+account_type+" (like <b>"+member_display_name+"</b>) cant be removed from channels.</p><p>If <b>"+member_display_name+"</b> should no longer have access to your Slack team, we suggest deactivating their account.",go_button_text:"Manage Team Members",show_cancel_button:true,onGo:function(){TS.utility.openInNewTab("/admin#restricted",TS.templates.builders.newWindowName())}});return}var err_str;switch(resp.data.error){case"cant_kick_from_last_channel":err_str="<p>"+account_type+" (like <b>"+member_display_name+"</b>) cant be removed from channels.</p><p>Please contact a Team Admin if <b>"+member_display_name+"</b> should no longer have access to your Slack team.</p>";break;case"restricted_action":err_str="<p>Hmm, looks like you dont have permission to kick from channels.</p><p>Please contact a Team Admin if <b>"+member_display_name+"</b> should no longer have access to your Slack team.</p>";break;default:err_str="<p>Somethings gone wrong, and we couldnt remove <b>"+member_display_name+"</b> from "+model_ob_display_name+". We suspect this is only temporary. Try again in a bit?</p>"}TS.generic_dialog.alert(err_str,"Removing "+member_display_name+" failed")},500)})}})}});var _addMsgsWorker=function(model_ob,msgs){var added_any=false;msgs.forEach(function(msg){if(TS.utility.msgs.validateMsg(model_ob.id,msg,model_ob.msgs)){added_any=true;TS.utility.msgs.appendMsg(model_ob.msgs,msg)}});if(!added_any)return false;TS.utility.msgs.sortMsgs(model_ob.msgs);TS.utility.msgs.maybeStoreMsgs(model_ob.id,model_ob.msgs);TS.utility.msgs.maybeSetOldestMsgsTsAfterMsgAdded(model_ob);return true};var _getModelObByIdFromModelOrApi=function(c_id){if(typeof c_id!=="string"){return Promise.reject(Error('c_id: "'+c_id+'" is not a String'))}TS.log(529,'_getModelObByIdFromModelOrApi c_id: "'+c_id+'"');var model_ob=TS.shared.getModelObById(c_id);if(model_ob){return Promise.resolve(model_ob)}return new Promise(function(resolve,reject){var tries=TS.model.incrementUnknownIdHandled(c_id);if(c_id.charAt(0)==="C"){TS.api.callImmediately("channels.info",{channel:c_id}).then(function(resp){resolve(TS.channels.upsertChannel(resp.data.channel));TS.model.reportResultOfUnknownIdHandled(c_id,true)},function(ret){reject(Error((ret.data&&ret.data.error||"unknown error")+" try #"+tries+" calling channels.info with channel:"+c_id));TS.model.reportResultOfUnknownIdHandled(c_id,false)})}else if(c_id.charAt(0)==="G"){TS.api.callImmediately("groups.info",{channel:c_id}).then(function(resp){if(resp.data.group.is_mpim){resolve(TS.mpims.upsertMpim(resp.data.group))}else{resolve(TS.groups.upsertGroup(resp.data.group))}TS.model.reportResultOfUnknownIdHandled(c_id,true)},function(ret){reject(Error((ret.data&&ret.data.error||"unknown error")+" try #"+tries+" calling groups.info with channel:"+c_id));TS.model.reportResultOfUnknownIdHandled(c_id,false)})}else{TS.api.callImmediately("im.info",{channel:c_id}).then(function(resp){resolve(TS.ims.upsertIm(resp.data.im));TS.model.reportResultOfUnknownIdHandled(c_id,true)},function(ret){reject(Error((ret.data&&ret.data.error||"unknown error")+" try #"+tries+" calling im.info with channel:"+c_id));TS.model.reportResultOfUnknownIdHandled(c_id,false)})}})};var _isModelObRelevantToHotness=function(model_ob){if(model_ob.is_archived)return false;if(!model_ob.msgs)return false;if(!model_ob.msgs.length)return false;return true};var _isMsgRelevantToHotness=function(msg){if(msg.is_ephemeral)return false;if(TS.utility.msgs.isTempMsg(msg))return false;return true};var _setHotness=function(model_ob,hotness){if(model_ob._hotness==hotness)return;model_ob._hotness=hotness;TS.shared.model_ob_hotness_changed_sig.dispatch(model_ob)};var _updateHotness=function(c_id){if(!TS.model.prefs.hotness)return;var hotness_secs=60*2;var model_obs=TS.shared.getAllModelObsForUser();var model_ob=TS.shared.getModelObById(c_id);if(model_ob&&!_isModelObRelevantToHotness(model_ob))return;var mark_label="start_updated_hotness_all";TS.timing.mark(mark_label);(model_ob&&[model_ob]||model_obs).forEach(function(model_ob){var hotness=0;var msg;if(_isModelObRelevantToHotness(model_ob)){for(var i=0;i<model_ob.msgs.length;i++){msg=model_ob.msgs[i];if(parseInt(TS.utility.date.makeTsStamp())-parseInt(msg.ts)>hotness_secs)break;if(_isMsgRelevantToHotness(msg))hotness+=1}}_setHotness(model_ob,hotness)});if(TS.shouldLog(752)){model_obs.sort(function compare(a,b){if(a._hotness<b._hotness)return 1;if(a._hotness>b._hotness)return-1;var a_srt=TS.shared.getDisplayNameForModelObNoSigns(a);var b_srt=TS.shared.getDisplayNameForModelObNoSigns(b);if(a_srt<b_srt)return-1;if(a_srt>b_srt)return 1;return 0});model_obs.slice(0,10).forEach(function(model_ob,i){if(!_isModelObRelevantToHotness(model_ob))return;TS.info(i+" "+model_ob._hotness+" "+TS.templates.makeHotnessIconDomClasses(model_ob)+" "+TS.shared.getDisplayNameForModelOb(model_ob));
})}if(!c_id)TS.timing.measureAndClear("updated_hotness_all",mark_label)}})();(function(){"use strict";TS.registerModule("members",{status_changed_sig:new signals.Signal,presence_changed_sig:new signals.Signal,ds_presence_changed_sig:new signals.Signal,user_color_changed_sig:new signals.Signal,joined_team_sig:new signals.Signal,changed_name_sig:new signals.Signal,changed_real_name_sig:new signals.Signal,changed_deleted_sig:new signals.Signal,changed_profile_sig:new signals.Signal,changed_tz_sig:new signals.Signal,changed_account_type_sig:new signals.Signal,changed_admin_perms_sig:new signals.Signal,changed_self_sig:new signals.Signal,is_in_bulk_upsert_mode:false,members_for_user_changed_sig:new signals.Signal,onStart:function(){_storeMembersThrottled=TS.utility.throttleFunc(_storeMembersThrottled,20)},getMemberById:function(id){var members=TS.model.members;var member=_id_map[id];if(member){return member}if(!members){TS.warn("Trying to look up member by id ("+id+") but TS.model.members is not present.")}if(TS.members.is_in_bulk_upsert_mode){return null}for(var i=0;i<members.length;i++){member=members[i];if(member.id==id){TS.warn(id+" not in _id_map");_id_map[id]=member;return member}}return null},getMemberByName:function(name,team_id){name=TS.utility.getLowerCaseValue(name);team_id=team_id||TS.model.team.id;var name_lc_key=_makeNameKey(name,team_id);var members=TS.model.members;var member=_name_map[name_lc_key];if(member){return member}for(var i=0;i<members.length;i++){member=members[i];if(member._name_lc_key==name_lc_key||"@"+member._name_lc_key==name_lc_key){TS.error(name_lc_key+" not in _name_map?");_name_map[member._name_lc_key]=member;_name_map["@"+member._name_lc_key]=member;return member}}return null},getMemberByEmail:function(email){email=TS.utility.getLowerCaseValue(email);var members=TS.model.members;var member;for(var i=0;i<members.length;i++){member=members[i];if(!member.profile)continue;if(!member.profile.email)continue;if(TS.utility.getLowerCaseValue(member.profile.email)==email)return member}return null},upsertAndSignal:function(member){var upsert=TS.members.upsertMember(member);if(upsert.status=="CHANGED"){if(upsert.what_changed.indexOf("profile")!=-1){TS.members.changed_profile_sig.dispatch(upsert.member)}if(upsert.what_changed.indexOf("is_restricted")!=-1||upsert.what_changed.indexOf("is_ultra_restricted")!=-1){TS.members.changed_account_type_sig.dispatch(upsert.member)}if(upsert.what_changed.indexOf("real_name")!=-1){TS.members.changed_real_name_sig.dispatch(upsert.member)}if(upsert.what_changed.indexOf("name")!=-1){TS.members.changed_name_sig.dispatch(upsert.member)}if(upsert.what_changed.indexOf("tz")!=-1){TS.members.changed_tz_sig.dispatch(upsert.member)}if(upsert.what_changed.indexOf("deleted")!=-1){TS.members.changed_deleted_sig.dispatch(upsert.member);var im=TS.ims.getImByMemberId(upsert.member.id);if(im)TS.ims.calcUnreadCnts(im,true);TS.channels.calcActiveMembersForAllChannels();TS.groups.calcActiveMembersForAllGroups()}if(upsert.what_changed.indexOf("presence")!=-1){TS.members.presence_changed_sig.dispatch(upsert.member)}if(upsert.what_changed.indexOf("is_admin")!=-1){TS.members.changed_admin_perms_sig.dispatch(upsert.member)}if(member.is_self){TS.members.changed_self_sig.dispatch(upsert.member);TS.model.makeYouRegex()}}return upsert},upsertMember:function(member,log){var members=TS.model.members;var existing_member=TS.members.getMemberById(member.id);var status="NOOP";var what_changed=[];if(member.is_ultra_restricted){member.is_restricted=true}if(existing_member){TS.log(4,'updating existing member "'+member.id+'"');for(var k in member){if(k=="profile"){if(member[k]&&!TS.utility.areSimpleObjectsEqual(member[k],existing_member[k],"member:"+member.id+" "+member.name)){var real_name_changed=false;if(!existing_member["profile"]||member["profile"].real_name!=existing_member["profile"].real_name){real_name_changed=true}existing_member["profile"]=member["profile"];if(real_name_changed){TS.members.setLowerCaseNamesForMemberProfile(existing_member)}status="CHANGED";what_changed.push(k)}}else if(existing_member[k]!=member[k]){if(member[k]&&!TS.utility.isScalar(member[k])){existing_member[k]=member[k];TS.warn(k+" is not scalar! it needs to be handled by upsertMember specifically to test if it has changed! "+typeof member[k])}else if(typeof member[k]!="boolean"||!member[k]!=!existing_member[k]){what_changed.push(k);existing_member[k]=member[k];status="CHANGED";if(k=="name"){TS.members.usernameChanged(existing_member)}else if(k=="real_name"){existing_member._real_name_lc=TS.utility.getLowerCaseValue(existing_member.real_name)}}}}member=existing_member}else if(member.id){status="ADDED";if(member.id=="USLACKBOT"){member.is_slackbot=true}member.member_color=member.color;if(TS.model.user_colors[member.id]){TS.members.setMemberUserColor(member,TS.model.user_colors[member.id])}TS.log(4,'adding member "'+member.id+'" color:'+member.color+" member_color:"+member.member_color);member.team_id=member.team_id||TS.model.team.id;member._is_local=member.team_id===TS.model.team.id;if(TS.boot_data.feature_shared_channels_ui){member._is_from_org=!member._is_local&&!!member.enterprise_user&&TS.model.enterprise&&TS.model.enterprise.id===member.enterprise_user.enterprise_id;member._is_external=!member._is_local&&!member._is_from_org}member._first_name_lc="";member._last_name_lc="";member._real_name_normalized_lc="";TS.members.setLowerCaseNamesForMemberProfile(member);member._name_lc=TS.utility.getLowerCaseValue(member.name);member._name_lc_key=_makeNameKey(member._name_lc,member.team_id);member._real_name_lc=TS.utility.getLowerCaseValue(member.real_name);_id_map[member.id]=member;_name_map[member._name_lc_key]=member;_name_map["@"+member._name_lc_key]=member;member.files=[];member.activity=[];member.stars=[];member.mentions=[];member.presence=member.presence=="active"?"active":"away";members.push(member);_setImAndMpimNames(member)}else{TS.error("bad error, no member.id")}if(member.is_self&&member.deleted){TS.info("calling TS.reload() because member.is_self && member.deleted");TS.reload(null,"TS.reload() because member.is_self && member.deleted");return}if(!TS.members.is_in_bulk_upsert_mode){TS.members.invalidateMembersUserCanSeeArrayCaches();TS.members.invalidateActiveMembersArrayCaches()}member._has_files_or_we_dont_know=TS.boot_data.feature_no_has_files||member.has_files;if(status=="ADDED"||status=="CHANGED")TS.members.maybeStoreMembers();return{status:status,member:member,what_changed:what_changed}},setMemberUserColor:function(member,color){color=TS.utility.htmlEntities(color);member.member_color=color||member.color;if(color&&color!=member.color){TS.model.user_colors[member.id]=color}else{delete TS.model.user_colors[member.id]}TS.members.user_color_changed_sig.dispatch(member)},setUserStatus:function(txt){TS.api.call("status.set",{status:txt},TS.members.onUserStatusSet)},onUserStatusSet:function(ok,data){if(!ok){return}},toggleUserPresence:function(){var new_presence=TS.model.user.presence=="away"?"active":"away";var args={presence:new_presence};return TS.api.call("presence.set",args)},usernameChanged:function(member){delete _name_map[member._name_lc_key];delete _name_map["@"+member._name_lc_key];member._name_lc=TS.utility.getLowerCaseValue(member.name);member._name_lc_key=_makeNameKey(member._name_lc,member.team_id);_name_map[member._name_lc_key]=member;_name_map["@"+member._name_lc_key]=member;_setImAndMpimNames(member)},setLowerCaseNamesForMemberProfile:function(member){if(!member.profile)return;if("first_name"in member.profile)member._first_name_lc=TS.utility.getLowerCaseValue(member.profile.first_name);if("last_name"in member.profile)member._last_name_lc=TS.utility.getLowerCaseValue(member.profile.last_name);if("real_name_normalized"in member.profile)member._real_name_normalized_lc=TS.utility.getLowerCaseValue(member.profile.real_name_normalized);if("real_name"in member.profile){member._real_name_lc=TS.utility.getLowerCaseValue(member.profile.real_name);member.real_name=member.profile.real_name;member._real_name_lc=TS.utility.getLowerCaseValue(member.real_name)}else{member.real_name=member.real_name||""}},getMyChannelsThatThisMemberIsNotIn:function(id){var A=[];var member=TS.members.getMemberById(id);if(!member)return A;var channel;var channels=TS.model.channels;channel_loop:for(var i=0;i<channels.length;i++){channel=channels[i];if(!channel.is_member)continue;for(var m=0;m<channel.members.length;m++){if(channel.members[m]==id)continue channel_loop}A.push(channel)}return A},getMyGroupsThatThisMemberIsNotIn:function(id){var A=[];var member=TS.members.getMemberById(id);if(!member)return A;var group;group_loop:for(var i=0;i<TS.model.groups.length;i++){group=TS.model.groups[i];if(group.is_archived)continue;for(var m=0;m<group.members.length;m++){if(group.members[m]==id)continue group_loop}A.push(group)}return A},getActiveMembersWithSelfAndNotSlackbot:function(){var A=_active_members_with_self_and_not_slackbot;if(!A.length){A=_active_members_with_self_and_not_slackbot=_getActiveMembersWorker(A,TS.members.getMembersForUser(),false,false)}return A},getActiveMembersExceptSelfAndSlackbot:function(){var A=_active_members_except_self_and_slackbot;if(!A.length){A=_active_members_except_self_and_slackbot=_getActiveMembersWorker(A,TS.members.getMembersForUser(),true,false)}return A},getActiveMembersWithSelfAndSlackbot:function(){var A=_active_members_with_self_and_slackbot;if(!A.length){A=_active_members_with_self_and_slackbot=_getActiveMembersWorker(A,TS.members.getMembersForUser(),false,true)}return A},getActiveMembersWithSlackbotAndNotSelf:function(){var A=_active_members_with_slackbot_and_not_self;if(!A.length){A=_active_members_with_slackbot_and_not_self=_getActiveMembersWorker(A,TS.members.getMembersForUser(),true,true)}return A},getActiveLocalMembersWithSlackbotAndNotSelf:function(){var A=_active_local_members_with_slackbot_and_not_self;if(!A.length){A=_active_local_members_with_slackbot_and_not_self=_getActiveMembersWorker(A,TS.members.getMembersForUser(),true,true,true)}return A},getActiveLocalMembersWithSelfAndSlackbot:function(){var A=_active_local_members_with_self_and_slackbot;if(!A.length){A=_active_local_members_with_self_and_slackbot=_getActiveMembersWorker(A,TS.members.getMembersForUser(),false,true,true)}return A},getMembersForUser:function(){return TS.members.getMembersForUserNew.apply(this,arguments)},canUserSeeMember:function(){return TS.members.canUserSeeMemberNew.apply(this,arguments)},getMembersForUserNew:function(){if(!TS.model.user.is_restricted)return TS.model.members;if(_members_for_user.length)return _members_for_user;var user_id_map={};TS.shared.getAllModelObsForUser().forEach(function(model_ob){if(model_ob.is_group&&!model_ob.is_archived){model_ob.members.forEach(function(user_id){user_id_map[user_id]=true})}else if(model_ob.is_channel&&model_ob.is_member){model_ob.members.forEach(function(user_id){user_id_map[user_id]=true})}else if(model_ob.is_im){user_id_map[model_ob.user]=true}});_members_for_user=Object.keys(user_id_map).map(TS.members.getMemberById).filter(function(user){return!user.deleted});return _members_for_user},canUserSeeMemberNew:function(member){if(!TS.model.user.is_restricted){return true}else if(member.is_self){return true}else if(member.is_slackbot){return true}return TS.members.getMembersForUser().indexOf(member)>=0},shouldDisplayRealNames:function(){var override=TS.model.prefs.display_real_names_override;return TS.model.team.prefs.display_real_names&&override!=-1||override==1},getMemberDisplayNameById:function(id,escaped,include_at_sign){var member=TS.members.getMemberById(id);return member?TS.members.getMemberDisplayName(member,escaped,include_at_sign):id},getMemberDisplayName:function(member,escaped,include_at_sign){if(!member)return"NO MEMBER??";if(!TS.model.team)return member.name;var username_prefix=include_at_sign?"@":"";if(TS.members.shouldDisplayRealNames()){if(member.real_name&&member.real_name.length){if(escaped)return TS.utility.htmlEntities(member.real_name);return member.real_name}else{return username_prefix+member.name}}return username_prefix+member.name},getMemberDisplayNameLowerCase:function(member,escaped){if(!member)return"NO MEMBER??";if(!TS.model.team)return member._name_lc;if(TS.members.shouldDisplayRealNames()){if(member.real_name){if(escaped)return TS.utility.htmlEntities(member._real_name_lc);return member._real_name_lc}}return member._name_lc},invalidateMembersUserCanSeeArrayCaches:function(no_signal){if(!TS.model.user||!TS.model.user.is_restricted)return;var was_length=_members_for_user.length;if(!was_length)return;_members_for_user.length=0;TS.members.invalidateActiveMembersArrayCaches();if(no_signal)return;var A=TS.members.getMembersForUser();if(A.length!==was_length){TS.members.members_for_user_changed_sig.dispatch()}},invalidateActiveMembersArrayCaches:function(){_active_members_with_self_and_not_slackbot.length=0;_active_members_except_self_and_slackbot.length=0;_active_members_with_self_and_slackbot.length=0;_active_members_with_slackbot_and_not_self.length=0;_active_local_members_with_slackbot_and_not_self.length=0;_active_local_members_with_self_and_slackbot.length=0},canMemberPostInModelOb:function(member,model_ob){if(model_ob.is_general){return TS.members.canMemberPostInGeneral(member)}return true},canMemberPostInGeneral:function(user){if(!user){return false}if(user.is_restricted){return TS.model.team.prefs.who_can_post_general=="ra"}if(TS.model.team.prefs.who_can_post_general=="ra")return true;if(TS.model.team.prefs.who_can_post_general=="regular")return true;if(TS.model.team.prefs.who_can_post_general=="admin")return!!user.is_admin;if(TS.model.team.prefs.who_can_post_general=="owner")return!!user.is_owner;return true},canUserAtEveryone:function(){if(TS.model.user.is_restricted){return TS.model.team.prefs.who_can_at_everyone=="ra"}if(TS.model.team.prefs.who_can_at_everyone=="ra")return true;if(TS.model.team.prefs.who_can_at_everyone=="regular")return true;if(TS.model.team.prefs.who_can_at_everyone=="admin")return!!TS.model.user.is_admin;if(TS.model.team.prefs.who_can_at_everyone=="owner")return!!TS.model.user.is_owner;return true},canUserAtChannelOrAtGroup:function(){if(TS.model.user.is_restricted){return TS.model.team.prefs.who_can_at_channel=="ra"}if(TS.model.team.prefs.who_can_at_channel=="ra")return true;if(TS.model.team.prefs.who_can_at_channel=="regular")return true;if(TS.model.team.prefs.who_can_at_channel=="admin")return!!TS.model.user.is_admin;if(TS.model.team.prefs.who_can_at_channel=="owner")return!!TS.model.user.is_owner;return true},canUserCreateChannels:function(){if(TS.model.user.is_restricted)return false;if(TS.model.team.prefs.who_can_create_channels=="regular")return true;if(TS.model.team.prefs.who_can_create_channels=="admin")return!!TS.model.user.is_admin;if(TS.model.team.prefs.who_can_create_channels=="owner")return!!TS.model.user.is_owner;return true},canUserCreateSharedChannels:function(){var is_enabled=TS.boot_data.feature_shared_channels_ui&&(TS.model.enterprise&&TS.model.enterprise.id||TS.boot_data.feature_external_shared_channels_ui);if(!is_enabled)return false;if(TS.model.user.is_restricted)return false;if(TS.model.team.prefs.who_can_create_channels=="admin")return!!TS.model.user.is_admin;if(TS.model.team.prefs.who_can_create_channels=="owner")return!!TS.model.user.is_owner;return true},canUserArchiveChannels:function(){if(TS.model.user.is_restricted)return false;if(TS.model.team.prefs.who_can_archive_channels=="regular")return true;if(TS.model.team.prefs.who_can_archive_channels=="admin")return!!TS.model.user.is_admin;if(TS.model.team.prefs.who_can_archive_channels=="owner")return!!TS.model.user.is_owner;return true},canUserCreateGroups:function(){if(TS.model.user.is_ultra_restricted)return false;if(TS.model.user.is_restricted){return TS.model.team.prefs.who_can_create_groups=="ra"}if(TS.model.team.prefs.who_can_create_groups=="ra")return true;if(TS.model.team.prefs.who_can_create_groups=="regular")return true;if(TS.model.team.prefs.who_can_create_groups=="admin")return!!TS.model.user.is_admin;if(TS.model.team.prefs.who_can_create_groups=="owner")return!!TS.model.user.is_owner;return true},canUserCreateMpims:function(){if(TS.model.user.is_ultra_restricted)return false;if(TS.boot_data.feature_mpim_restrictions&&TS.model.team.prefs.who_can_create_mpdm==="off")return false;return true},canUserCreateAndDeleteUserGroups:function(){if(!TS.boot_data.feature_subteams)return false;if(TS.model.user.is_restricted)return false;if(TS.model.team.prefs.who_can_create_delete_user_groups=="regular")return true;if(TS.model.team.prefs.who_can_create_delete_user_groups=="admin")return!!TS.model.user.is_admin;if(TS.model.team.prefs.who_can_create_delete_user_groups=="owner")return!!TS.model.user.is_owner;return true},canUserEditUserGroups:function(){if(!TS.boot_data.feature_subteams)return false;if(TS.model.user.is_restricted)return false;if(TS.model.team.prefs.who_can_edit_user_groups=="regular")return true;if(TS.model.team.prefs.who_can_edit_user_groups=="admin")return!!TS.model.user.is_admin;if(TS.model.team.prefs.who_can_edit_user_groups=="owner")return!!TS.model.user.is_owner;return true},canUserPostInGeneral:function(){return TS.members.canMemberPostInGeneral(TS.model.user)},canUserKickFromChannels:function(){if(TS.model.user.is_restricted)return false;if(TS.model.team.prefs.who_can_kick_channels=="regular")return true;if(TS.model.team.prefs.who_can_kick_channels=="admin")return!!TS.model.user.is_admin;if(TS.model.team.prefs.who_can_kick_channels=="owner")return!!TS.model.user.is_owner;return true},canUserKickFromGroups:function(){if(TS.model.user.is_restricted)return false;if(TS.model.team.prefs.who_can_kick_groups=="regular")return true;if(TS.model.team.prefs.who_can_kick_groups=="admin")return!!TS.model.user.is_admin;if(TS.model.team.prefs.who_can_kick_groups=="owner")return!!TS.model.user.is_owner;return true},memberSorterByActive:function(a,b){if(a.presence!=b.presence){if(a.presence=="active")return-1;if(b.presence=="active")return 1}var a_srt=TS.members.getMemberDisplayNameLowerCase(a);var b_srt=TS.members.getMemberDisplayNameLowerCase(b);if(a_srt<b_srt)return-1;if(a_srt>b_srt)return 1;return 0},memberSorterByActiveWithBotsLast:function(a,b){if(a.presence!=b.presence){if(a.presence=="active")return-1;if(b.presence=="active")return 1}var a_bot=a.is_bot||a.is_slackbot;var b_bot=b.is_bot||b.is_slackbot;if(a_bot!==b_bot){if(!a_bot)return-1;if(!b_bot)return 1}var a_srt=TS.members.getMemberDisplayNameLowerCase(a);var b_srt=TS.members.getMemberDisplayNameLowerCase(b);if(a_srt<b_srt)return-1;if(a_srt>b_srt)return 1;return 0},memberSorterByName:function(a,b){var a_srt=TS.members.getMemberDisplayNameLowerCase(a);var b_srt=TS.members.getMemberDisplayNameLowerCase(b);if(a_srt<b_srt)return-1;if(a_srt>b_srt)return 1;return 0},checkMemberMatch:function(member,regex,names_only){return member.name&&member.name.match(regex)||!names_only&&member.profile&&member.profile.email&&member.profile.email.match(regex)||member.profile&&member.profile.real_name_normalized&&member.profile.real_name_normalized.match(regex)||member.profile&&member.profile.real_name&&member.profile.real_name.match(regex)},prepareMembersForLS:function(){var new_members=[];var new_member;var member;var k;var i;for(i=0;i<TS.model.members.length;i++){member=TS.model.members[i];new_member={};new_members.push(new_member);for(k in member){if(k=="files")continue;if(k=="activity")continue;if(k=="stars")continue;if(k=="mentions")continue;if(k.indexOf("_")===0)continue;new_member[k]=member[k]}}return new_members},maybeStoreMembers:function(force){if(!TS.model.supports_user_caching)return;if(TS.members.is_in_bulk_upsert_mode)return;_storeMembersThrottled(force||false)},clearMemberMaps:function(){_id_map={};_name_map={}},ensureMembersInDataArePresent:function(data,source,channel_id){var ret=TS.utility.extractAllMemberIds(data,source,channel_id);return TS.members.ensureMembersArePresent(ret.m_ids,ret.c_ids,ret.t_ids)},ensureMemberIsPresent:function(m_id,c_id,t_id){if(!m_id)return Promise.resolve();if(typeof m_id!=="string")return Promise.resolve();return _getMemberByIdFromModelOrApi(m_id,c_id,t_id)},getMemberIdsNotPresent:function(m_ids,c_ids,t_ids){var new_m_ids=[];var new_c_ids=[];var new_t_ids=[];m_ids.forEach(function(m_id,i){if(!TS.members.getMemberById(m_id)){new_m_ids.push(m_id);new_c_ids.push(c_ids[i]);new_t_ids.push(t_ids[i])}});return{m_ids:new_m_ids,c_ids:new_c_ids,t_ids:new_t_ids}},ensureMembersArePresent:function(m_ids,c_ids,t_ids){if(!m_ids||!m_ids.length){return Promise.resolve()}c_ids=c_ids||new Array(m_ids.length);t_ids=t_ids||new Array(m_ids.length);var promises=m_ids.map(function(m_id,i){return TS.members.ensureMemberIsPresent(m_id,c_ids[i],t_ids[i]).reflect()});return Promise.all(promises).then(function(results){var rejection_reasons=[];results.forEach(function(result){if(result.isFulfilled())return;rejection_reasons.push(result.reason())});if(rejection_reasons.length){return Promise.reject(new Error("some ensureMembersArePresent m_ids failed:\n"+rejection_reasons.join("\n")))}else{return Promise.resolve()}})},ensureMembersArePresentInSharedModelObs:function(model_obs){model_obs=model_obs.filter(function(model_ob){return!!model_ob.is_shared});return TS.members.ensureMembersArePresentInModelObs(model_obs)},ensureMembersArePresentInModelObs:function(model_obs){var m_ids=[];var c_ids=[];model_obs.forEach(function(model_ob){if(model_ob.is_im){m_ids.push(model_ob.user);c_ids.push(model_ob.id)}else if(model_ob.is_mpim){}else if(model_ob.is_channel){}else if(model_ob.is_group){}else{TS.warn("ensureMembersArePresentInModelObs found an unexpected model_ob type")}});if(!m_ids.length)return Promise.resolve();return TS.members.ensureMembersArePresent(m_ids,c_ids)},getExternalTeamIdForMemberById:function(id){var member=TS.members.getMemberById(id);return member&&!member._is_local&&member.team_id},isMemberInDnd:function(member){return!!member._is_in_dnd},startBatchUpsert:function(){if(TS.members.is_in_bulk_upsert_mode)return false;TS.members.is_in_bulk_upsert_mode=true;return true},finishBatchUpsert:function(){if(!TS.members.is_in_bulk_upsert_mode)return false;TS.members.is_in_bulk_upsert_mode=false;TS.members.invalidateMembersUserCanSeeArrayCaches();TS.members.invalidateActiveMembersArrayCaches();TS.members.maybeStoreMembers();return true},allocateTeamListMembers:function(members_for_user){var member;var members=[];var disabled_members=[];var deleted_bots=[];var bots=[];var restricted_members=[];var ultra_restricted_members=[];members_for_user.sort(function(a,b){var a_name=a._real_name_lc||a._name_lc;var b_name=b._real_name_lc||b._name_lc;return a_name>b_name?1:b_name>a_name?-1:0});for(var i=0;i<members_for_user.length;i++){member=members_for_user[i];if(member.deleted){if(member.is_bot){deleted_bots.push(member)}else{disabled_members.push(member)}}else if(member.is_ultra_restricted){ultra_restricted_members.push(member)}else if(member.is_restricted){restricted_members.push(member)}else if(member.is_bot||member.is_slackbot){bots.push(member)}else{members.push(member)}}return{members:members,disabled_members:disabled_members,deleted_bots:deleted_bots,bots:bots,restricted_members:restricted_members,ultra_restricted_members:ultra_restricted_members}}});var _id_map={};var _name_map={};var _active_members_with_self_and_not_slackbot=[];var _active_members_except_self_and_slackbot=[];var _active_members_with_self_and_slackbot=[];var _active_members_with_slackbot_and_not_self=[];var _active_local_members_with_slackbot_and_not_self=[];var _active_local_members_with_self_and_slackbot=[];var _members_for_user=[];var _makeNameKey=function(name_lc,team_id){return name_lc+"_"+team_id};var _setImAndMpimNames=function(member){TS.ims.setNameFromMember(member);if(TS.boot_data.feature_mpim_client)TS.mpims.setNamesFromMember(member)};var _getActiveMembersWorker=function(A,members,exclude_self,include_slackbot,only_local){A.length=0;var member;for(var m=0;m<members.length;m++){member=members[m];if(member.deleted)continue;if(!include_slackbot&&member.is_slackbot)continue;if(exclude_self&&member.is_self)continue;if(only_local&&!member._is_local)continue;A.push(member)}return A};var _getMemberByIdFromModelOrApi=function(m_id,c_id,t_id){if(typeof m_id!=="string"){return Promise.reject(Error('m_id: "'+m_id+'" is not a String'))}c_id=c_id||"";t_id=t_id||"";TS.log(529,'_getMemberByIdFromModelOrApi m_id: "'+m_id+'" c_id: "'+c_id+'" t_id: "'+t_id+'"');var member=TS.members.getMemberById(m_id);if(member){return Promise.resolve(member)}return new Promise(function(resolve,reject){var unknown_id=m_id+"_"+c_id+"_"+t_id;var tries=TS.model.incrementUnknownIdHandled(unknown_id);var calling_args={user:m_id};if(c_id)calling_args.shared_channel=c_id;if(!c_id&&t_id)calling_args.team=t_id;TS.api.callImmediately("users.info",calling_args).then(function(resp){resolve(TS.members.upsertAndSignal(resp.data.user).member);TS.model.reportResultOfUnknownIdHandled(unknown_id,true)},function(ret){reject(Error((ret.data&&ret.data.error||"unknown error")+" try #"+tries+" calling users.info with user:"+m_id+" channel:"+c_id));TS.model.reportResultOfUnknownIdHandled(unknown_id,false)})})};var _storeMembersThrottled=function(force){var members=TS.members.prepareMembersForLS();var existing=!force&&TS.storage.fetchMembers();if(force||!existing||!TS.utility.areSimpleObjectsEqual(existing,members)){TS.storage.storeMembers(members)}}})();(function(){"use strict";TS.registerModule("team",{team_profile_changed_sig:new signals.Signal,team_plan_changed_sig:new signals.Signal,team_email_domain_changed_sig:new signals.Signal,team_domain_changed_sig:new signals.Signal,team_name_changed_sig:new signals.Signal,onStart:function(){if(TS.ms)TS.ms.connected_sig.add(_getTeamProfileOnNextRequest,TS.team);_maybeSetupTeamModel()},upsertAndSignal:function(team){if(!team)return;var upsert=TS.team.upsertTeam(team);if(upsert.status=="CHANGED"){if(upsert.what_changed.indexOf("profile")!=-1){TS.team.team_profile_changed_sig.dispatch(upsert.team)}if(upsert.what_changed.indexOf("email_domain")!=-1){TS.team.team_email_domain_changed_sig.dispatch(upsert.team)}if(upsert.what_changed.indexOf("domain")!=-1){TS.team.team_domain_changed_sig.dispatch(upsert.team)}}return upsert},upsertTeam:function(team,log){_maybeSetupTeamModel();var existing_team=TS.model.team;var status="NOOP";var what_changed=[];if(team){TS.log(4,'updating team "'+team.id+'"');for(var k in team){if(k=="profile"){if(team.profile.fields&&team.profile.fields.length){if(typeof team.profile.fields[0]==="object"){_mergeFields(team.profile.fields)}else if(typeof team.profile.fields[0]==="string"){_deleteFields(team.profile.fields)}what_changed.push(k);status="CHANGED"}}else if(k=="icon"||k=="prefs"){existing_team[k]=team[k]}else if(existing_team[k]!=team[k]){if(team[k]&&!TS.utility.isScalar(team[k])){existing_team[k]=team[k];TS.warn(k+" is not scalar! it needs to be handled by upsertTeam specifically to test if it has changed! "+typeof team[k])}else if(typeof team[k]!="boolean"||!team[k]!=!existing_team[k]){existing_team[k]=team[k];what_changed.push(k);status="CHANGED"}}}}return{status:status,team:existing_team,what_changed:what_changed}},ensureTeamProfileFieldsForMembers:function(members){if(_promise_to_get_team_profile)return _promise_to_get_team_profile;_promise_to_get_team_profile=TS.api.call("team.profile.get").then(function(response){TS.team.upsertTeam({profile:response.data.profile})});return _promise_to_get_team_profile},getTeamProfileFieldById:function(id){if(!TS.model.team.profile.fields.length)TS.warn("Ensure profile fields exist before calling getTeamProfileFieldById");for(var i=0;i<TS.model.team.profile.fields.length;i++){if(TS.model.team.profile.fields[i].id===id)return TS.model.team.profile.fields[i]}return null},getVisibleTeamProfileFields:function(){if(!TS.model.team.profile.fields.length)TS.warn("Ensure profile fields exist before calling getVisibleTeamProfileFields");return TS.model.team.profile.fields.filter(function(field){return!field.is_hidden})},getHiddenTeamProfileFields:function(){if(!TS.model.team.profile.fields.length)TS.warn("Ensure profile fields exist before calling getHiddenTeamProfileFields");return TS.model.team.profile.fields.filter(function(field){return field.is_hidden})},sortTeamProfileFieldsByOrdering:function(){if(!TS.model.team.profile.fields.length)return void TS.warn("Ensure profile fields exist before calling sortTeamProfileFieldsByOrdering");TS.model.team.profile.fields.sort(function(this_field,that_field){return this_field.ordering-that_field.ordering})},getVisibleTeamProfileFieldsForMember:function(member,include_empty_member_fields){if(!(member&&member.profile))return[];if(!TS.model.team.profile.fields.length)TS.warn("Ensure profile fields exist before calling getVisibleTeamProfileFieldsForMember");return TS.model.team.profile.fields.map(function(field){if((include_empty_member_fields||_.get(member.profile,["fields",field.id,"value"]))&&!field.is_hidden){return $.extend(true,{value:_.get(member.profile,["fields",field.id,"value"]),alt:_.get(member.profile,["fields",field.id,"alt"])},field)}}).filter(function(field){return!!field})}});var _promise_to_get_team_profile;var _getTeamProfileOnNextRequest=function(){_promise_to_get_team_profile=null};var _isEmpty=function(fields){if(fields&&fields.length)_.remove(fields,function(field){return!field});return!(fields&&fields.length)};var _maybeSetupTeamModel=function(){if(_.get(window,"TS.model.team.profile.fields"))return;TS.model.team=TS.model.team||{};TS.model.team.profile=TS.model.team.profile||{};TS.model.team.profile.fields=TS.model.team.profile.fields||[]};var _mergeFields=function(fields){if(_isEmpty(fields))return;var sort=false;var upsert_members=false;var map=TS.model.team.profile.fields.reduce(function(accumulator,field){accumulator[field.id]=field;return accumulator},{});fields.forEach(function(field){var existing_field=map[field.id];if(existing_field){upsert_members=upsert_members||_mustUpsertMembersAfterMerge(existing_field,field);sort=sort||existing_field.ordering!==field.ordering;$.extend(true,existing_field,field)}else{TS.model.team.profile.fields.push(field);if(TS.model.members&&field.type==="options_list")upsert_members=true}});if(sort)TS.team.sortTeamProfileFieldsByOrdering();if(upsert_members)_upsertMembers(fields)};var _deleteFields=function(fields){if(_isEmpty(fields))return;_.remove(TS.model.team.profile.fields,function(field){return fields.indexOf(field.id)!==-1});_upsertMembers(fields)};var _upsertMembers=function(fields){if(!fields||!fields.length)return;if(!TS.model.members)return;fields.forEach(function(field){TS.model.members.forEach(function(member){if(member.profile.fields&&member.profile.fields[field.id||field]){if(field.id){if(field.type!=="options_list")return;var value_is_valid=field.possible_values.indexOf(member.profile.fields[field.id].value)!==-1;if(value_is_valid)return}var member_to_upsert=$.extend(true,{},member);delete member_to_upsert.profile.fields[field.id||field];TS.members.upsertMember(member_to_upsert)}})})};var _mustUpsertMembersAfterMerge=function(old_field,new_field){if(TS.model.members&&new_field.type==="options_list"){return new_field.possible_values.some(function(value){return old_field.possible_values.indexOf(value)===-1})}return false}})();(function(){"use strict";TS.registerModule("apps",{onStart:function(){var always_wait=true;_resetUpAppsThrottled=TS.utility.throttleFunc(_resetUpAppsThrottled,3e3,always_wait)},resetUpApps:function(){TS.storage.storeApps("");_resetUpAppsThrottled()},setUp:function(){return TS.apps.fetchApps()},ingest:function(apps){if(!Array.isArray(apps))return;TS.model.apps={};apps.forEach(function(app){TS.model.apps[app.id]=app})},fetchApps:function(){var ls_apps=TS.storage.fetchApps();if(ls_apps&&TS.model.apps_cache_ts==ls_apps.cache_ts){TS.model.did_we_load_with_app_cache=true;TS.apps.ingest(ls_apps.data);return Promise.resolve();
}return TS.api.call("apps.list").then(function(res){TS.model.apps_cache_ts=res.data.cache_ts;TS.storage.storeApps({data:res.data.apps,cache_ts:TS.model.apps_cache_ts});TS.apps.ingest(res.data.apps)}).catch($.noop)},sortNames:function(names){return names.slice().sort(TS.apps.compareNames)},compareNames:function(a,b){if(!a||!b)return!a?-1:1;return a.localeCompare(b)}});var _resetUpAppsThrottled=function(){TS.apps.setUp()}})();(function(){"use strict";TS.registerModule("bots",{added_sig:new signals.Signal,changed_name_sig:new signals.Signal,changed_deleted_sig:new signals.Signal,changed_icons_sig:new signals.Signal,is_in_bulk_upsert_mode:false,onStart:function(){_storeBotsThrottled=TS.utility.throttleFunc(_storeBotsThrottled,20)},getBotById:function(id){var bots=TS.model.bots;var bot;for(var i=0;i<bots.length;i++){bot=bots[i];if(bot.id==id)return bot}return null},getBotByName:function(name){var bots=TS.model.bots;var bot;if(typeof name==="undefined"){return null}for(var i=0;i<bots.length;i++){bot=bots[i];if(bot.name.toLowerCase()==name.toLowerCase())return bot}return null},upsertAndSignal:function(bot){var upsert=TS.bots.upsertBot(bot);if(upsert.status=="CHANGED"){if(upsert.what_changed.indexOf("icons")!=-1){TS.bots.changed_icons_sig.dispatch(upsert.bot)}if(upsert.what_changed.indexOf("name")!=-1){TS.bots.changed_name_sig.dispatch(upsert.bot)}if(upsert.what_changed.indexOf("deleted")!=-1){TS.bots.changed_deleted_sig.dispatch(upsert.bot)}}return upsert},upsertBot:function(bot,log){var bots=TS.model.bots;var existing_bot=TS.bots.getBotById(bot.id);var status="NOOP";var what_changed=[];if(existing_bot){TS.log(4,'updating existing bot "'+bot.id+'"');for(var k in bot){if(k=="icons"){if(bot[k]&&!TS.utility.areSimpleObjectsEqual(bot[k],existing_bot[k],"bot:"+bot.id+" "+bot.name)){existing_bot["icons"]=bot["icons"];status="CHANGED";what_changed.push(k)}}else if(existing_bot[k]!=bot[k]){if(bot[k]&&!TS.utility.isScalar(bot[k])){existing_bot[k]=bot[k];TS.warn(k+" is not scalar! it needs to be handled by upsertBot specifically to test if it has changed! "+typeof bot[k])}else if(typeof bot[k]!="boolean"||!bot[k]!=!existing_bot[k]){what_changed.push(k);existing_bot[k]=bot[k];status="CHANGED"}}}bot=existing_bot}else{status="ADDED";TS.log(4,'adding bot "'+bot.id);bots.push(bot)}if(status=="ADDED"||status=="CHANGED")TS.bots.maybeStoreBots();return{status:status,bot:bot,what_changed:what_changed}},prepareBotsForLS:function(){var new_bots=[];var new_bot;var bot;var k;var i;for(i=0;i<TS.model.bots.length;i++){bot=TS.model.bots[i];new_bot={};new_bots.push(new_bot);for(k in bot){new_bot[k]=bot[k]}}return new_bots},maybeStoreBots:function(force){if(!TS.model.supports_user_caching)return;if(TS.bots.is_in_bulk_upsert_mode)return;_storeBotsThrottled(force||false)},configureUrl:function(member){if(!member.is_bot)return;var url;var app_id=_getBotAppId(member);if(app_id){url="/apps/manage/"+app_id}else if(member.profile.bot_id){url="/services/"+member.profile.bot_id}return url},startBatchUpsert:function(){if(TS.bots.is_in_bulk_upsert_mode)return false;TS.bots.is_in_bulk_upsert_mode=true;return true},finishBatchUpsert:function(){if(!TS.bots.is_in_bulk_upsert_mode)return false;TS.bots.is_in_bulk_upsert_mode=false;TS.bots.maybeStoreBots();return true}});var _getBotAppId=function(member){var app_id=member.profile.api_app_id;if(!app_id&&TS.model.apps&&TS.model.apps.length){var bot_app=_.find(TS.model.apps,function(app){return app.name.toLowerCase()==member.name.toLowerCase()});if(bot_app)app_id=bot_app.id}return app_id};var _storeBotsThrottled=function(force){var bots=TS.bots.prepareBotsForLS();var existing=!force&&TS.storage.fetchBots();if(force||!existing||!TS.utility.areSimpleObjectsEqual(existing,bots)){TS.storage.storeBots(bots)}}})();(function(){"use strict";TS.registerModule("members.view",{team_filter_changed_sig:new signals.Signal,filter_timer:null,onStart:function(){_is_web_admin_page=TS.web&&TS.web.admin},switchTabs:function(tab_name){if(_is_web_admin_page&&TS.web.admin.view=="invites"){$("#"+tab_name+"_invites_tab").trigger("click")}else{if(TS.client){$("#"+tab_name+"_members_tab").find("a").trigger("click")}else{$("#"+tab_name+"_members_tab").trigger("click")}}},bindTeamFilter:function(filter_container_id,scroller_id,full_profile_filter){var $div=$(filter_container_id);var $input=$div.find("input.member_filter");var $icon_close=$div.find(".icon_close");_query_for_match=null;if(full_profile_filter){$input.on("focus",function(){TS.team.ensureTeamProfileFieldsForMembers(TS.model.members)})}$input.bind("keyup update-team-filter",function(e){var new_query=$input.val();if(TS.members.view.filter_timer){window.clearTimeout(TS.members.view.filter_timer)}TS.members.view.filter_timer=window.setTimeout(function(){if(e.which==TS.utility.keymap.enter&&filter_container_id=="#dms_filter"){TS.members.view.selectMatch(filter_container_id)}if(new_query.trim().toLocaleLowerCase()!==_query_for_match){TS.members.view.filterTeam(new_query,filter_container_id,scroller_id,full_profile_filter).then(function(){if(TS.boot_data.feature_subteams&&TS.view)TS.view.rebuildUserGroupList();$icon_close.toggleClass("hidden",!_query_for_match)})}else{$icon_close.toggleClass("hidden",!_query_for_match)}},TS.members.getMembersForUser().length>500?250:50)});$icon_close.bind("click",function(){TS.members.view.clearFilter(filter_container_id,scroller_id);if(TS.boot_data.feature_subteams&&TS.view)TS.view.rebuildUserGroupList();_query_for_match=null;setTimeout(function(){$input.focus()},0)})},filterTeam:function(new_query,filter_container_id,scroller_id,full_profile_filter){if(full_profile_filter){return TS.team.ensureTeamProfileFieldsForMembers(TS.model.members).then(function(){_filterTeam(new_query,filter_container_id,scroller_id,full_profile_filter);return Promise.resolve()})}else{return Promise.resolve().then(function(){_filterTeam(new_query,filter_container_id,scroller_id);return Promise.resolve()})}},getTeamFilter:function(){return _query_for_match},selectMatch:function(filter_container_id){var $div=$(filter_container_id);var list_items_id=$div.data("list-items-id");var $list_items_container=$(list_items_id);var $list_items=$list_items_container.find(".member_item");var $active_items=$list_items.filter(".active");if($active_items.length==1){var $active_item=$active_items.first();var member_id=$active_item.data("member-id");if(member_id){TS.ims.startImByMemberId(member_id);TS.menu.end()}}},clearFilter:function(filter_container_id,scroller_id){var $div=$(filter_container_id);var $input=$div.find("input.member_filter");var $icon_close=$div.find(".icon_close");var list_items_id=$div.data("list-items-id");var $list_items_container=$(list_items_id);var $list_items=$list_items_container.find(".member_item");_query_for_match="";TS.storage.storeFilterState(_query_for_match);if(TS.members.view.filter_timer){window.clearTimeout(TS.members.view.filter_timer);TS.members.view.filter_timer=null}$input.val("");$icon_close.addClass("hidden");$(".restricted_header, .bot_header, .ra_invite_prompt, .restricted_info").removeClass("hidden");$list_items_container.find(".no_results").addClass("hidden");$list_items.addClass("active");if(_lazy_clones[scroller_id]){_lazy_clones[scroller_id].detachEvents();delete _lazy_clones[scroller_id]}$list_items_container.find(".member_item.clone").remove();$list_items_container.find(".filter_header").remove();TS.members.view.team_filter_changed_sig.dispatch("",TS.members.getMembersForUser().length);if(TS.client&&scroller_id)$(scroller_id).trigger("resize-immediate").data("monkeyScroll").updateFunc()},onTeamDirectoryItemClick:function(e){if($(e.target).closest("a").length)return;var $item=$(this);var member_id=$item.data("member-id");var member=TS.members.getMemberById(member_id);if(!member)return;TS.client.ui.previewMember(member_id)}});var _query_for_match="";var _lazy_clones={};var _label_map={};var _filterTeam=function(new_query,filter_container_id,scroller_id,full_profile_filter){var measure_label="members_view_search";var start_mark_label="start_members_view_search";TS.timing.mark(start_mark_label);var $div=$(filter_container_id);var query_for_display=new_query.trim();_query_for_match=query_for_display.toLocaleLowerCase();var list_items_id=$div.data("list-items-id");var $list_items_container=$(list_items_id);var $list_items=$list_items_container.find(".member_item:not(.clone)");var $list_items_active=$list_items.filter(".active");var $list_items_cloned=$list_items_container.find(".member_item.clone");var $list_items_cloned_header=$list_items_container.find(".filter_header");var lazy_load=!TS.web&&filter_container_id==="#team_filter";var node_hash={};var $parent_node;var $last_focused_node;var matches;TS.storage.storeFilterState(_query_for_match);var can_use_fast_detach=false;var $display_toggle_element;if(_is_web_admin_page&&filter_container_id==="#team_filter"){measure_label="admin_list_search";$display_toggle_element=$list_items_container.find(".tab_pane.selected")}if(!$display_toggle_element&&!TS.web&&filter_container_id==="#team_filter"){measure_label="flexpane_team_search";$display_toggle_element=$("#team_list_members")}if($display_toggle_element&&$display_toggle_element.length){$display_toggle_element.addClass("hidden")}if(can_use_fast_detach){$parent_node=$list_items.parent();$last_focused_node=document.activeElement?$(document.activeElement):null;$list_items.detach()}if(_lazy_clones[scroller_id]){_lazy_clones[scroller_id].detachEvents();delete _lazy_clones[scroller_id]}$list_items_cloned.remove();$list_items_cloned_header.remove();$list_items_active.removeClass("active");$list_items_container.find(".no_results").addClass("hidden");if(can_use_fast_detach){$parent_node.append($list_items);if($last_focused_node){$last_focused_node.focus()}}var findMatchesWithRegex=function(list,query,full_filter,start_regex,suffix_regex){var matches={};var team_fields=full_filter&&query?TS.team.getVisibleTeamProfileFields():[];_label_map={title:"What I Do",name:"Name"};list.forEach(function(member){var match=member.name&&(member.name.match(start_regex)||member.name.match(suffix_regex))||member.first_name&&(member.first_name.match(start_regex)||member.first_name.match(suffix_regex))||member.last_name&&(member.last_name.match(start_regex)||member.last_name.match(suffix_regex))||member._real_name_lc&&(member._real_name_lc.match(start_regex)||member._real_name_lc.match(suffix_regex))||member.email&&(member.email.match(start_regex)||member.email.match(suffix_regex))||member.profile&&member.profile.email&&(member.profile.email.match(start_regex)||member.profile.email.match(suffix_regex))||member.profile&&member.profile.real_name_normalized&&(member.profile.real_name_normalized.match(start_regex)||member.profile.real_name_normalized.match(suffix_regex))||member.profile&&member.profile.real_name&&(member.profile.real_name.match(start_regex)||member.profile.real_name.match(suffix_regex));if(match){if(!matches["name"])matches["name"]=[];matches["name"].push({member:member})}if(full_filter&&query){match=member.profile&&member.profile.title&&(member.profile.title.match(start_regex)||member.profile.title.match(suffix_regex));if(match){if(!matches["title"])matches["title"]=[];matches["title"].push({member:member})}}if(team_fields.length&&member.profile&&member.profile.fields){team_fields.forEach(function(team_field){var field=member.profile.fields[team_field.id];if(!field)return;match=null;if(team_field.type==="user"){if(field.value){var value="";field.value.split(/\s*\,\s*/).some(function(id){value=TS.members.getMemberDisplayNameById(id,false);match=value.match(start_regex)||value.match(suffix_regex);if(match)return true});if(match){if(!matches[team_field.id])matches[team_field.id]=[];matches[team_field.id].push({member:member,value:value,match:match[0]})}}}else{match=field.value&&(field.value.match(start_regex)||field.value.match(suffix_regex));if(match){if(!matches[team_field.id])matches[team_field.id]=[];matches[team_field.id].push({member:member,value:field.value,match:match[0]})}else{match=field.alt&&(field.alt.match(start_regex)||field.alt.match(suffix_regex));if(match){if(!matches[team_field.id])matches[team_field.id]=[];matches[team_field.id].push({member:member,value:field.alt,match:match[0]})}}}if(match&&!_label_map[team_field.id])_label_map[team_field.id]=team_field.label})}});return matches};var findMatchesInMemberList=function(list,query,full_filter){var start_regex=new RegExp("^"+TS.utility.regexpEscape(query),"i");var suffix_regex=new RegExp("(-|_|\\+|\\s|\\.|@)"+TS.utility.regexpEscape(query),"i");return findMatchesWithRegex(list,query,full_filter,start_regex,suffix_regex)};var tabs;if(_is_web_admin_page&&TS.web.admin.view=="invites"){measure_label="admin_invite_search";var all_matches=[];var pending_matches=[];var accepted_matches=[];$.each($list_items,function(i,item){var id;item=$(item);id=item.data("invite-id");node_hash[id]=item});pending_matches=findMatchesInMemberList(TS.web.admin.pending_invites,_query_for_match).name||[];accepted_matches=findMatchesInMemberList(TS.web.admin.accepted_invites,_query_for_match).name||[];all_matches=pending_matches.concat(accepted_matches);if(all_matches.length>0){$.each(all_matches,function(i,invite){if(invite&&invite.member&&invite.member.id&&node_hash[invite.member.id]){node_hash[invite.member.id].addClass("active")}});if(scroller_id)$(scroller_id).trigger("resize")}tabs=[{name:"pending",label:"pending invitations",matches:pending_matches},{name:"accepted",label:"accepted invitations",matches:accepted_matches}];tabs.forEach(function(tab){var $no_results=$("#"+tab.name+"_no_results");if(tab.matches.length>0){$no_results.addClass("hidden").empty();return}else{var template_args={query:query_for_display,tab:tab,pending_matches:pending_matches,show_pending_matches:tab.name!="pending"&&pending_matches.length>0,accepted_matches:accepted_matches,show_accepted_matches:tab.name!="accepted"&&accepted_matches.length>0};var html=TS.templates.team_list_no_results(template_args);$no_results.removeClass("hidden").html(html);$no_results.find(".clear_members_filter").on("click",function(){TS.members.view.clearFilter(filter_container_id,scroller_id)})}});matches=all_matches}else{var all_members;var active_matches=[];var restricted_matches=[];var disabled_matches=[];if(filter_container_id=="#dms_filter"){measure_label="dm_list_search";all_members=TS.members.getActiveMembersWithSlackbotAndNotSelf()}else{if(_is_web_admin_page){if(!new_query.length){all_members=TS.web.admin.getMembersForUser()}else{all_members=TS.members.getMembersForUser()}}else{all_members=TS.members.getMembersForUser()}}$(".restricted_header, .bot_header, .ra_invite_prompt, .restricted_info").toggleClass("hidden",!!_query_for_match);$.each($list_items,function(i,item){var id;item=$(item);id=item.data("member-id");node_hash[id]=item});var all_matches=findMatchesInMemberList(all_members,_query_for_match,full_profile_filter);var keys=Object.keys(all_matches);if(keys.length>0){_displayMatches(all_matches,keys,node_hash,disabled_matches,restricted_matches,active_matches,lazy_load?scroller_id:"");if(scroller_id){$(scroller_id).trigger("resize");var monkey_scroll=$(scroller_id).data("monkeyScroll");if(monkey_scroll){monkey_scroll.updateFunc()}}}else{if(filter_container_id=="#dms_filter"||filter_container_id=="#file_member_filter"){$list_items_container.find(".query").text(query_for_display);$list_items_container.find(".no_results").removeClass("hidden")}}if(filter_container_id=="#team_filter"){tabs=[{name:"active",label:"full team members",matches:active_matches},{name:"restricted",label:TS.templates.builders.raLabel("restricted accounts"),matches:restricted_matches},{name:"disabled",label:"disabled accounts",matches:disabled_matches}];tabs.forEach(function(tab){var $no_results=$("#"+tab.name+"_no_results");function noMatchesCase(){var template_args={query:query_for_display,tab:tab,active_matches:active_matches,show_active_matches:tab.name!="active"&&active_matches.length>0,restricted_matches:restricted_matches,show_restricted_matches:tab.name!="restricted"&&restricted_matches.length>0,disabled_matches:disabled_matches,show_disabled_matches:TS.web&&tab.name!="disabled"&&disabled_matches.length>0};var html=TS.templates.team_list_no_results(template_args);$no_results.removeClass("hidden").html(html);$no_results.find(".clear_members_filter").on("click",function(){TS.members.view.clearFilter(filter_container_id,scroller_id)})}if(tab.matches.length>0){$no_results.addClass("hidden").empty();return}else{noMatchesCase()}})}matches=active_matches.concat(restricted_matches,disabled_matches)}if($display_toggle_element&&$display_toggle_element.length){$display_toggle_element.removeClass("hidden")}if(TS.client&&scroller_id){$(scroller_id).data("monkeyScroll").updateFunc()}TS.members.view.team_filter_changed_sig.dispatch(query_for_display,matches.length);TS.timing.measureAndClear(measure_label,start_mark_label)};var _getFilterHeaderLabel=function(key){return _label_map[key]||key};var _getFilterHeader=function(label,values){var header=document.createElement("div");var header_label=document.createElement("strong");header.classList.add("filter_header");header_label.appendChild(document.createTextNode(label));if(values.length)header_label.appendChild(document.createTextNode(": "));header.appendChild(header_label);values.forEach(function(value,index){header.appendChild(value);if(index<values.length-1)header.appendChild(document.createTextNode(", "))});return header};var _getHighlightedValue=function(value,match){var highlighted_value=document.createElement("span");var strong_value=document.createElement("strong");var parts=value.split(match);strong_value.appendChild(document.createTextNode(match));highlighted_value.appendChild(document.createTextNode(parts.shift()));highlighted_value.appendChild(strong_value);highlighted_value.appendChild(document.createTextNode(parts.join(match)));return highlighted_value};var _displayMatches=function(matches,keys,node_hash,disabled_matches,restricted_matches,active_matches,lazy_id){var $lazy=$(lazy_id);var parent_disabled_fragment=document.createDocumentFragment();var parent_restricted_fragment=document.createDocumentFragment();var parent_active_fragment=document.createDocumentFragment();var $disabled_parent;var $restricted_parent;var $active_parent;var is_admin_subset_case=_is_web_admin_page&&TS.web.admin.isSubsetCase();keys.sort(function(keyA,keyB){return _label_map[keyA].localeCompare(_label_map[keyB])}).forEach(function(key){var disabled_fragment=document.createDocumentFragment();var restricted_fragment=document.createDocumentFragment();var active_fragment=document.createDocumentFragment();var disabled_matches_values=[];var restricted_matches_values=[];var active_matches_values=[];var disabled_matches_value_map={};var restricted_matches_value_map={};var active_matches_value_map={};if(is_admin_subset_case){if(!$active_parent){$active_parent=$("#active_members > div:first-of-type");$restricted_parent=$("#restricted_members > div:first-of-type");$disabled_parent=$("#disabled_members > div:first-of-type")}}matches[key].forEach(function(match){var member=match.member;var node;var node_created=false;if(member&&member.id){node=node_hash[member.id];if(!node&&is_admin_subset_case){node=$(TS.web.admin.buildMemberHTML(member,false,false));node_created=true}if(node){if(key==="name"&&!node_created){node.addClass("active")}else{if(member.deleted){if(!$disabled_parent)$disabled_parent=node.parent();if(match.value&&!disabled_matches_value_map[match.value])disabled_matches_value_map[match.value]=disabled_matches_values.push(_getHighlightedValue(match.value,match.match));disabled_fragment.appendChild(node.clone().addClass("active clone").get(0))}else if(member.is_restricted){if(!$restricted_parent)$restricted_parent=node.parent();if(match.value&&!restricted_matches_value_map[match.value])restricted_matches_value_map[match.value]=restricted_matches_values.push(_getHighlightedValue(match.value,match.match));restricted_fragment.appendChild(node.clone().addClass("active clone").get(0))}else{if(!$active_parent)$active_parent=node.parent();if(match.value&&!active_matches_value_map[match.value])active_matches_value_map[match.value]=active_matches_values.push(_getHighlightedValue(match.value,match.match));active_fragment.appendChild(node.clone().addClass("active clone").get(0))}}}if(member.deleted){disabled_matches.push(member)}else if(member.is_restricted){restricted_matches.push(member)}else{active_matches.push(member)}}});if(disabled_fragment.childNodes&&disabled_fragment.childNodes.length){parent_disabled_fragment.appendChild(_getFilterHeader(_getFilterHeaderLabel(key),disabled_matches_values));parent_disabled_fragment.appendChild(disabled_fragment)}if(restricted_fragment.childNodes&&restricted_fragment.childNodes.length){parent_restricted_fragment.appendChild(_getFilterHeader(_getFilterHeaderLabel(key),restricted_matches_values));parent_restricted_fragment.appendChild(restricted_fragment)}if(active_fragment.childNodes&&active_fragment.childNodes.length){parent_active_fragment.appendChild(_getFilterHeader(_getFilterHeaderLabel(key),active_matches_values));parent_active_fragment.appendChild(active_fragment)}});if($disabled_parent)$disabled_parent.append(parent_disabled_fragment);if($restricted_parent)$restricted_parent.append(parent_restricted_fragment);if($active_parent)$active_parent.append(parent_active_fragment);if($lazy.length){var $clones=$lazy.find(".member_item.clone");_lazy_clones[lazy_id]=$clones.find(".lazy").lazyload({container:$lazy,ignore_when_hidden_element:$lazy,all_images_same_size:true});$clones.one("remove",function(){if(_lazy_clones[lazy_id]){_lazy_clones[lazy_id].detachEvents();delete _lazy_clones[lazy_id]}})}if(is_admin_subset_case){if(TS.web.admin.lazyload&&TS.web.admin.lazyload.detachEvents){TS.web.admin.lazyload.detachEvents();TS.web.admin.lazyload=null}if(!TS.web.admin.lazyload){TS.web.admin.lazyload=$("#admin_list").find(".lazy").lazyload()}}};var _is_web_admin_page})();(function(){"use strict";TS.registerModule("prefs",{highlight_words_changed_sig:new signals.Signal,seen_welcome_2_changed_sig:new signals.Signal,emoji_mode_changed_sig:new signals.Signal,obey_inline_img_limit_changed_sig:new signals.Signal,show_member_presence_changed_sig:new signals.Signal,messages_theme_changed_sig:new signals.Signal,expand_inline_imgs_changed_sig:new signals.Signal,expand_internal_inline_imgs_changed_sig:new signals.Signal,expand_non_media_attachments_changed_sig:new signals.Signal,webapp_spellcheck_changed_sig:new signals.Signal,color_names_in_list_changed_sig:new signals.Signal,search_only_my_channels_changed_sig:new signals.Signal,search_exclude_channels_changed_sig:new signals.Signal,search_exclude_bots_changed_sig:new signals.Signal,box_enabled_changed_sig:new signals.Signal,dropbox_enabled_changed_sig:new signals.Signal,collapsible_changed_sig:new signals.Signal,read_changed_sig:new signals.Signal,push_changed_sig:new signals.Signal,time24_changed_sig:new signals.Signal,sidebar_behavior_changed_sig:new signals.Signal,dtop_notif_changed_sig:new signals.Signal,muted_channels_changed_sig:new signals.Signal,mac_speak_changed_sig:new signals.Signal,mac_ssb_bullet_changed_sig:new signals.Signal,team_hide_referers_changed_sig:new signals.Signal,team_require_at_for_mention_changed_sig:new signals.Signal,sidebar_theme_changed_sig:new signals.Signal,k_key_omnibox_changed_sig:new signals.Signal,seen_spaces_new_xp_tooltip_changed_sig:new signals.Signal,no_omnibox_in_channels_changed_sig:new signals.Signal,k_key_omnibox_auto_hide_count_changed_sig:new signals.Signal,display_real_names_override_changed_sig:new signals.Signal,team_display_real_names_changed_sig:new signals.Signal,team_perms_pref_changed_sig:new signals.Signal,privacy_policy_seen_changed_sig:new signals.Signal,two_factor_update_seen_changed_sig:new signals.Signal,compliance_export_start_changed_sig:new signals.Signal,team_disallow_public_file_urls_changed_sig:new signals.Signal,msg_preview_changed_sig:new signals.Signal,mentions_exclude_at_channels_changed_sig:new signals.Signal,mentions_exclude_at_user_groups_changed_sig:new signals.Signal,emoji_use_changed_sig:new signals.Signal,team_auth_mode_changed_sig:new signals.Signal,team_sso_auth_restrictions_changed_sig:new signals.Signal,team_posts_migrating_changed_sig:new signals.Signal,preferred_skin_tone_changed_sig:new signals.Signal,show_all_skin_tones_changed_sig:new signals.Signal,msg_replies_changed_sig:new signals.Signal,separate_private_channels_changed_sig:new signals.Signal,whats_new_read_changed_sig:new signals.Signal,team_dnd_enabled_changed_sig:new signals.Signal,team_dnd_start_hour_changed_sig:new signals.Signal,team_dnd_end_hour_changed_sig:new signals.Signal,team_invites_only_admins_changed_sig:new signals.Signal,tz_changed_sig:new signals.Signal,team_allow_calls_changed_sig:new signals.Signal,hotness_changed_sig:new signals.Signal,frecency_jumper_changed_sig:new signals.Signal,jumbomoji_changed_sig:new signals.Signal,onStart:function(){if(TS.client)TS.client.login_sig.add(TS.prefs.onLogin,TS.prefs)},onLogin:function(ok,data){var notification_sounds=TS.boot_data.notification_sounds;for(var i=0;i<notification_sounds.length;i++){if(notification_sounds[i].label==TS.model.prefs.new_msg_snd){TS.warn("corrected TS.model.prefs.new_msg_snd "+notification_sounds[i].label+" -> "+notification_sounds[i].value);TS.model.prefs.new_msg_snd==notification_sounds[i].value;TS.api.callImmediately("users.prefs.set",{name:"new_msg_snd",value:notification_sounds[i].value});break}}setInterval(function(){if(_emoji_use_dirty_cnt>0){TS.prefs.saveEmojiUse()}},1e3*60*10)},setPrefs:function(prefs){TS.model.prefs=prefs;TS.prefs.mergeEmojiUse(TS.model.prefs.emoji_use);TS.prefs.mergeFrecencyJumper(TS.model.prefs.frecency_jumper);TS.prefs.setUserColors(TS.model.prefs.user_colors);TS.prefs.setLoudChannels(TS.model.prefs.loud_channels);TS.prefs.setSuppressedChannels(TS.model.prefs.at_channel_suppressed_channels);TS.prefs.setPushSuppressedChannels(TS.model.prefs.push_at_channel_suppressed_channels);TS.prefs.setNeverChannels(TS.model.prefs.never_channels);TS.prefs.setMutedChannels(TS.model.prefs.muted_channels);TS.prefs.setLoudChannelsSet(TS.model.prefs.loud_channels_set);TS.prefs.setPushLoudChannels(TS.model.prefs.push_loud_channels);TS.prefs.setPushMentionChannels(TS.model.prefs.push_mention_channels);TS.prefs.setPushLoudChannelsSet(TS.model.prefs.push_loud_channels_set);TS.prefs.setSearchExcludeChannels(TS.model.prefs.search_exclude_channels);TS.prefs.setSidebarThemeCustomValues(TS.utility.parseJSONOrElse(TS.model.prefs.sidebar_theme_custom_values,undefined));TS.emoji.setEmojiMode();TS.prefs.setTheme();TS.model.prefs.emoji_autocomplete_big=false;TSSSB.call("runFromTray",!!TS.model.prefs.winssb_run_from_tray);TSSSB.call("windowFlashBehavior",TS.model.prefs.winssb_window_flash_behavior)},setHighlightWords:function(highlight_words){TS.model.prefs.highlight_words=highlight_words;TS.model.highlight_words=["@"+TS.model.user.name];if(!TS.model.team.prefs.require_at_for_mention){TS.model.highlight_words.push(TS.model.user.name)}TS.model.highlight_words.push("<@"+TS.model.user.id);if(highlight_words&&typeof highlight_words=="string"){TS.model.highlight_words=TS.model.highlight_words.concat(highlight_words.split(","))}TS.model.highlight_words_regex=null},setSuppressedChannels:function(at_channel_suppressed_channels){TS.model.prefs.at_channel_suppressed_channels=at_channel_suppressed_channels;TS.model.at_channel_suppressed_channels=[];if(at_channel_suppressed_channels&&typeof at_channel_suppressed_channels=="string"){TS.model.at_channel_suppressed_channels=TS.model.at_channel_suppressed_channels.concat(at_channel_suppressed_channels.split(","))}},setPushSuppressedChannels:function(push_at_channel_suppressed_channels){TS.model.prefs.push_at_channel_suppressed_channels=push_at_channel_suppressed_channels;TS.model.push_at_channel_suppressed_channels=[];if(push_at_channel_suppressed_channels&&typeof push_at_channel_suppressed_channels=="string"){TS.model.push_at_channel_suppressed_channels=TS.model.push_at_channel_suppressed_channels.concat(push_at_channel_suppressed_channels.split(","))}},setLoudChannels:function(loud_channels){TS.model.prefs.loud_channels=loud_channels;TS.model.loud_channels=[];if(loud_channels&&typeof loud_channels=="string"){TS.model.loud_channels=TS.model.loud_channels.concat(loud_channels.split(","))}},setNeverChannels:function(never_channels){TS.model.prefs.never_channels=never_channels;TS.model.never_channels=[];if(never_channels&&typeof never_channels=="string"){TS.model.never_channels=TS.model.never_channels.concat(never_channels.split(","))}},setMutedChannels:function(muted_channels){TS.model.prefs.muted_channels=muted_channels;var i;var model_ob;TS.model.muted_channels=[];if(muted_channels&&typeof muted_channels=="string"){TS.model.muted_channels=TS.model.muted_channels.concat(muted_channels.split(","))}for(i=0;i<TS.model.muted_channels.length;i++){model_ob=TS.shared.getModelObById(TS.model.muted_channels[i]);if(!model_ob)continue;if(!model_ob.unread_cnt)continue;model_ob._show_in_list_even_though_no_unreads=true}for(i=0;i<TS.model.channels.length;i++){model_ob=TS.model.channels[i];if(TS.notifs.isCorGMuted(model_ob.id))continue;model_ob._show_in_list_even_though_no_unreads=false}for(i=0;i<TS.model.groups.length;i++){model_ob=TS.model.groups[i];if(TS.notifs.isCorGMuted(model_ob.id))continue;model_ob._show_in_list_even_though_no_unreads=false}},setLoudChannelsSet:function(loud_channels_set){TS.model.prefs.loud_channels_set=loud_channels_set;TS.model.loud_channels_set=[];if(loud_channels_set&&typeof loud_channels_set=="string"){TS.model.loud_channels_set=TS.model.loud_channels_set.concat(loud_channels_set.split(","))}},setPushLoudChannels:function(push_loud_channels){TS.model.prefs.push_loud_channels=push_loud_channels;TS.model.push_loud_channels=[];if(push_loud_channels&&typeof push_loud_channels=="string"){TS.model.push_loud_channels=TS.model.push_loud_channels.concat(push_loud_channels.split(","))}},setPushMentionChannels:function(push_mention_channels){TS.model.prefs.push_mention_channels=push_mention_channels;TS.model.push_mention_channels=[];if(push_mention_channels&&typeof push_mention_channels=="string"){TS.model.push_mention_channels=TS.model.push_mention_channels.concat(push_mention_channels.split(","))}},setPushLoudChannelsSet:function(push_loud_channels_set){TS.model.prefs.push_loud_channels_set=push_loud_channels_set;TS.model.push_loud_channels_set=[];if(push_loud_channels_set&&typeof push_loud_channels_set=="string"){TS.model.push_loud_channels_set=TS.model.push_loud_channels_set.concat(push_loud_channels_set.split(","))}},setSearchExcludeChannels:function(search_exclude_channels){TS.model.prefs.search_exclude_channels=search_exclude_channels;TS.model.search_exclude_channels=[];if(search_exclude_channels&&typeof search_exclude_channels=="string"){TS.model.search_exclude_channels=TS.model.search_exclude_channels.concat(search_exclude_channels.split(","))}},recordEmojiUse:function(str){var added=TS.utility.msgs.recordEmojiInHash(str,TS.model.emoji_use);if(!added)return;_emoji_use_dirty_cnt++;if(_emoji_use_dirty_cnt>10){TS.prefs.saveEmojiUse()}else{TS.storage.storeEmojiUse(TS.model.emoji_use)}},saveEmojiUse:function(){TS.dir(777,TS.model.emoji_use,"saving emoji_use pref");_emoji_use_dirty_cnt=0;TS.storage.storeEmojiUse(TS.model.emoji_use);TS.prefs.setPrefByAPI({name:"emoji_use",value:JSON.stringify(TS.model.emoji_use)})},mergeFrecencyJumper:function(frecency_jumper){if(!frecency_jumper||typeof frecency_jumper!=="object"){frecency_jumper=TS.utility.parseJSONOrElse(frecency_jumper||null)||{}}TS.model.frecency_jumper=frecency_jumper;return true},mergeEmojiUse:function(emoji_use){if(!emoji_use||typeof emoji_use!=="object"){emoji_use=TS.utility.parseJSONOrElse(emoji_use||null)||{}}var something_changed=false;for(k in emoji_use){if(!TS.model.emoji_use.hasOwnProperty(k)||emoji_use[k]>TS.model.emoji_use[k]){
TS.model.emoji_use[k]=emoji_use[k];something_changed=true}}if(!something_changed){TS.log(777,"mergeEmojiUse TS.model.emoji_use unchanged");return false}TS.dir(777,TS.model.emoji_use,"mergeEmojiUse TS.model.emoji_use set to:");var root_name;var condensed={};for(var k in TS.model.emoji_use){root_name=TS.emoji.nameToCanonicalName(k.split("::")[0]);if(!condensed.hasOwnProperty(root_name)){condensed[root_name]=0}condensed[root_name]+=TS.model.emoji_use[k]}TS.dir(777,condensed,"condensed emoji names:");TS.model.emoji_use_for_menu=Object.keys(condensed).sort(function(a,b){return-(condensed[a]-condensed[b])});TS.model.emoji_use_for_menu.length=Math.min(TS.model.emoji_use_for_menu.length,TS.model.emoji_menu_columns*4);return true},setUserColors:function(user_colors){TS.model.prefs.user_colors=user_colors;var parse=user_colors?JSON.parse(user_colors):{};TS.model.user_colors=parse||{}},setTheme:function(theme){if(TS.model.prefs.messages_theme=="default"){TS.model.prefs.messages_theme="light_with_avatars"}TS.model.prefs.theme="light";TS.model.prefs.avatars=true;if(TS.model.prefs.messages_theme=="dense"){TS.model.prefs.theme="dense";TS.model.prefs.avatars=false}else if(TS.model.prefs.messages_theme=="light"){TS.model.prefs.theme="light";TS.model.prefs.avatars=false}else if(TS.model.prefs.messages_theme=="light_with_avatars"){TS.model.prefs.theme="light";TS.model.prefs.avatars=true}},onTeamPrefChanged:function(imsg){if(imsg.name=="msg_edit_window_mins"){TS.model.team.prefs.msg_edit_window_mins=imsg.value}else if(imsg.name=="allow_message_deletion"){TS.model.team.prefs.allow_message_deletion=!!imsg.value}else if(imsg.name=="hide_referers"){TS.model.team.prefs.hide_referers=!!imsg.value;TS.prefs.team_hide_referers_changed_sig.dispatch()}else if(imsg.name=="require_at_for_mention"){TS.model.team.prefs.require_at_for_mention=!!imsg.value;TS.prefs.setHighlightWords(TS.model.prefs.highlight_words);TS.prefs.team_require_at_for_mention_changed_sig.dispatch()}else if(imsg.name=="display_real_names"){TS.model.team.prefs.display_real_names=!!imsg.value;TS.prefs.team_display_real_names_changed_sig.dispatch()}else if(imsg.name.indexOf("who_can_")===0){if(TS.model.team.prefs[imsg.name]!=imsg.value){TS.model.team.prefs[imsg.name]=imsg.value;TS.prefs.team_perms_pref_changed_sig.dispatch(imsg.name)}}else if(imsg.name=="compliance_export_start"){if(TS.model.team.prefs.compliance_export_start!=imsg.value){TS.model.team.prefs.compliance_export_start=imsg.value;TS.prefs.compliance_export_start_changed_sig.dispatch()}}else if(imsg.name=="disallow_public_file_urls"){TS.model.team.prefs.disallow_public_file_urls=!!imsg.value;TS.prefs.team_disallow_public_file_urls_changed_sig.dispatch()}else if(imsg.name=="auth_mode"){TS.model.team.prefs.auth_mode=imsg.value;TS.prefs.team_auth_mode_changed_sig.dispatch()}else if(imsg.name=="sso_auth_restrictions"){TS.model.team.prefs.sso_auth_restrictions=imsg.value;TS.prefs.team_sso_auth_restrictions_changed_sig.dispatch()}else if(imsg.name=="posts_migrating"){TS.model.team.prefs.posts_migrating=imsg.value;TS.prefs.team_posts_migrating_changed_sig.dispatch()}else if(imsg.name=="dnd_enabled"){TS.model.team.prefs.dnd_enabled=imsg.value;TS.prefs.team_dnd_enabled_changed_sig.dispatch()}else if(imsg.name=="dnd_start_hour"){TS.model.team.prefs.dnd_start_hour=imsg.value;TS.prefs.team_dnd_start_hour_changed_sig.dispatch()}else if(imsg.name=="dnd_end_hour"){TS.model.team.prefs.dnd_end_hour=imsg.value;TS.prefs.team_dnd_end_hour_changed_sig.dispatch()}else if(imsg.name=="invites_only_admins"){TS.model.team.prefs.invites_only_admins=imsg.value;TS.prefs.team_invites_only_admins_changed_sig.dispatch()}else if(imsg.name=="allow_calls"){TS.model.team.prefs.allow_calls=imsg.value;TS.prefs.team_allow_calls_changed_sig.dispatch()}else{TS.model.team.prefs[imsg.name]=imsg.value}},onPrefChanged:function(imsg){switch(imsg.name){case"color_names_in_list":TS.model.prefs.color_names_in_list=!!imsg.value;TS.prefs.color_names_in_list_changed_sig.dispatch();break;case"display_real_names_override":TS.model.prefs.display_real_names_override=imsg.value;TS.prefs.display_real_names_override_changed_sig.dispatch();break;case"growls_enabled":TS.model.prefs.growls_enabled=!!imsg.value;TS.prefs.dtop_notif_changed_sig.dispatch();break;case"sidebar_theme":if(TS.model.prefs.sidebar_theme!==imsg.value){TS.model.prefs.sidebar_theme=imsg.value;TS.prefs.sidebar_theme_changed_sig.dispatch()}break;case"sidebar_theme_custom_values":if(TS.model.prefs.sidebar_theme_custom_values!==imsg.value){TS.prefs.setSidebarThemeCustomValues(JSON.parse(imsg.value));TS.prefs.sidebar_theme_changed_sig.dispatch()}break;case"expand_inline_imgs":TS.model.prefs.expand_inline_imgs=!!imsg.value;TS.prefs.expand_inline_imgs_changed_sig.dispatch();break;case"webapp_spellcheck":TS.model.prefs.webapp_spellcheck=!!imsg.value;TS.prefs.webapp_spellcheck_changed_sig.dispatch();break;case"expand_internal_inline_imgs":TS.model.prefs.expand_internal_inline_imgs=!!imsg.value;TS.prefs.expand_internal_inline_imgs_changed_sig.dispatch();break;case"expand_non_media_attachments":TS.model.prefs.expand_non_media_attachments=!!imsg.value;TS.prefs.expand_non_media_attachments_changed_sig.dispatch();break;case"messages_theme":TS.model.prefs.messages_theme=imsg.value;TS.prefs.setTheme();TS.prefs.messages_theme_changed_sig.dispatch();break;case"show_member_presence":TS.model.prefs.show_member_presence=!!imsg.value;TS.prefs.show_member_presence_changed_sig.dispatch();break;case"highlight_words":TS.prefs.setHighlightWords(imsg.value);TS.prefs.highlight_words_changed_sig.dispatch();break;case"at_channel_suppressed_channels":TS.prefs.setSuppressedChannels(imsg.value);TS.prefs.dtop_notif_changed_sig.dispatch();break;case"push_at_channel_suppressed_channels":TS.prefs.setPushSuppressedChannels(imsg.value);TS.prefs.push_changed_sig.dispatch();break;case"loud_channels":TS.prefs.setLoudChannels(imsg.value);break;case"never_channels":TS.prefs.setNeverChannels(imsg.value);break;case"muted_channels":TS.prefs.setMutedChannels(imsg.value);TS.prefs.muted_channels_changed_sig.dispatch();break;case"loud_channels_set":TS.prefs.setLoudChannelsSet(imsg.value);TS.prefs.dtop_notif_changed_sig.dispatch();break;case"push_loud_channels":TS.prefs.setPushLoudChannels(imsg.value);break;case"push_mention_channels":TS.prefs.setPushMentionChannels(imsg.value);break;case"push_loud_channels_set":TS.prefs.setPushLoudChannelsSet(imsg.value);TS.prefs.push_changed_sig.dispatch();break;case"emoji_use":if(TS.prefs.mergeEmojiUse(imsg.value)){TS.emoji.makeEmoticonList();TS.prefs.emoji_use_changed_sig.dispatch()}break;case"user_colors":var member;var member_id;for(member_id in TS.model.user_colors){member=TS.members.getMemberById(member_id);if(member)TS.members.setMemberUserColor(member,member.color)}TS.prefs.setUserColors(imsg.value);for(member_id in TS.model.user_colors){member=TS.members.getMemberById(member_id);if(member)TS.members.setMemberUserColor(member,TS.model.user_colors[member_id])}break;case"graphic_emoticons":TS.model.prefs.graphic_emoticons=imsg.value;TS.emoji.setEmojiMode();TS.prefs.emoji_mode_changed_sig.dispatch();break;case"ss_emojis":TS.model.prefs.ss_emojis=imsg.value;TS.emoji.setEmojiMode();TS.prefs.emoji_mode_changed_sig.dispatch();TS.emoji.makeEmoticonList();break;case"emoji_mode":TS.model.prefs.emoji_mode=imsg.value;TS.emoji.setEmojiMode();TS.prefs.emoji_mode_changed_sig.dispatch();TS.emoji.makeEmoticonList();break;case"obey_inline_img_limit":TS.model.prefs.obey_inline_img_limit=imsg.value;TS.prefs.obey_inline_img_limit_changed_sig.dispatch();break;case"search_only_my_channels":TS.model.prefs.search_only_my_channels=!!imsg.value;TS.prefs.search_only_my_channels_changed_sig.dispatch();break;case"search_exclude_channels":TS.prefs.setSearchExcludeChannels(imsg.value);TS.prefs.search_exclude_channels_changed_sig.dispatch();break;case"search_exclude_bots":TS.model.prefs.search_exclude_bots=!!imsg.value;TS.prefs.search_exclude_bots_changed_sig.dispatch();break;case"mac_speak_voice":if(TS.model.prefs.mac_speak_voice!=imsg.value){TS.model.prefs.mac_speak_voice=imsg.value;TS.prefs.mac_speak_changed_sig.dispatch()}break;case"mac_speak_speed":if(TS.model.prefs.mac_speak_speed!=imsg.value){TS.model.prefs.mac_speak_speed=imsg.value;TS.prefs.mac_speak_changed_sig.dispatch()}break;case"speak_growls":if(TS.model.prefs.speak_growls!==imsg.value){TS.model.prefs.speak_growls=imsg.value;TS.prefs.mac_speak_changed_sig.dispatch()}break;case"has_uploaded":TS.model.prefs.has_uploaded=!!imsg.value;break;case"has_invited":TS.model.prefs.has_invited=!!imsg.value;break;case"has_created_channel":TS.model.prefs.has_created_channel=!!imsg.value;break;case"no_joined_overlays":TS.model.prefs.no_joined_overlays=!!imsg.value;break;case"no_created_overlays":TS.model.prefs.no_created_overlays=!!imsg.value;break;case"seen_welcome_2":TS.model.prefs.seen_welcome_2=!!imsg.value;TS.prefs.seen_welcome_2_changed_sig.dispatch();break;case"box_enabled":TS.model.prefs.box_enabled=!!imsg.value;TS.prefs.box_enabled_changed_sig.dispatch();break;case"dropbox_enabled":TS.model.prefs.dropbox_enabled=!!imsg.value;TS.prefs.dropbox_enabled_changed_sig.dispatch();break;case"collapsible":if(TS.model.prefs.collapsible!==!!imsg.value){TS.model.prefs.collapsible=!!imsg.value;TS.prefs.collapsible_changed_sig.dispatch()}break;case"collapsible_by_click":if(TS.model.prefs.collapsible_by_click!==!!imsg.value){TS.model.prefs.collapsible_by_click=!!imsg.value;TS.prefs.collapsible_changed_sig.dispatch()}break;case"mark_msgs_read_immediately":if(TS.model.prefs.mark_msgs_read_immediately!==!!imsg.value){TS.model.prefs.mark_msgs_read_immediately=!!imsg.value;TS.prefs.read_changed_sig.dispatch()}break;case"start_scroll_at_oldest":if(TS.model.prefs.start_scroll_at_oldest!==!!imsg.value){TS.model.prefs.start_scroll_at_oldest=!!imsg.value;TS.prefs.read_changed_sig.dispatch()}break;case"mac_ssb_bullet":if(TS.model.prefs.mac_ssb_bullet!==!!imsg.value){TS.model.prefs.mac_ssb_bullet=!!imsg.value;TS.prefs.mac_ssb_bullet_changed_sig.dispatch()}break;case"all_channels_loud":if(TS.model.prefs.all_channels_loud!==!!imsg.value){TS.model.prefs.all_channels_loud=!!imsg.value;TS.prefs.dtop_notif_changed_sig.dispatch()}break;case"push_everything":if(TS.model.prefs.push_everything!==!!imsg.value){TS.model.prefs.push_everything=!!imsg.value;TS.prefs.push_changed_sig.dispatch()}break;case"push_mention_alert":if(TS.model.prefs.push_mention_alert!==!!imsg.value){TS.model.prefs.push_mention_alert=!!imsg.value;TS.prefs.push_changed_sig.dispatch()}break;case"push_dm_alert":if(TS.model.prefs.push_dm_alert!==!!imsg.value){TS.model.prefs.push_dm_alert=!!imsg.value;TS.prefs.push_changed_sig.dispatch()}break;case"time24":if(TS.model.prefs.time24!==!!imsg.value){TS.model.prefs.time24=!!imsg.value;TS.prefs.time24_changed_sig.dispatch()}break;case"sidebar_behavior":if(TS.model.prefs.sidebar_behavior!=imsg.value){TS.model.prefs.sidebar_behavior=imsg.value;TS.prefs.sidebar_behavior_changed_sig.dispatch()}break;case"two_factor_update_seen":if(TS.model.two_factor_update_seen!=imsg.value){TS.mode.prefs.two_factor_update_seen=imsg.value;TS.prefs.two_factor_update_seen_changed_sig.dispatch()}break;case"privacy_policy_seen":if(TS.model.prefs.privacy_policy_seen!=imsg.value){TS.model.prefs.privacy_policy_seen=imsg.value;TS.prefs.privacy_policy_seen_changed_sig.dispatch()}break;case"last_seen_at_channel_warning":if(TS.model.prefs.last_seen_at_channel_warning!=imsg.value){TS.model.prefs.last_seen_at_channel_warning=imsg.value}break;case"msg_preview":if(TS.model.prefs.msg_preview!=imsg.value){TS.model.prefs.msg_preview=imsg.value;TS.prefs.msg_preview_changed_sig.dispatch()}break;case"msg_preview_displaces":if(TS.model.prefs.msg_preview_displaces!=imsg.value){TS.model.prefs.msg_preview_displaces=imsg.value;TS.prefs.msg_preview_changed_sig.dispatch()}break;case"msg_preview_persistent":if(TS.model.prefs.msg_preview_persistent!=imsg.value){TS.model.prefs.msg_preview_persistent=imsg.value;TS.prefs.msg_preview_changed_sig.dispatch()}break;case"winssb_run_from_tray":if(TS.model.prefs.winssb_run_from_tray!=imsg.value){TS.model.prefs.winssb_run_from_tray=imsg.value;TSSSB.call("runFromTray",!!TS.model.prefs.winssb_run_from_tray)}break;case"winssb_window_flash_behavior":if(TS.model.prefs.winssb_window_flash_behavior!=imsg.value){TS.model.prefs.winssb_window_flash_behavior=imsg.value;TSSSB.call("windowFlashBehavior",TS.model.prefs.winssb_window_flash_behavior)}break;case"mentions_exclude_at_channels":if(TS.model.prefs.mentions_exclude_at_channels!=imsg.value){TS.model.prefs.mentions_exclude_at_channels=imsg.value;TS.prefs.mentions_exclude_at_channels_changed_sig.dispatch()}break;case"mentions_exclude_at_user_groups":if(TS.model.prefs.mentions_exclude_at_user_groups!=imsg.value){TS.model.prefs.mentions_exclude_at_user_groups=imsg.value;TS.prefs.mentions_exclude_at_user_groups_changed_sig.dispatch()}break;case"k_key_omnibox":if(TS.model.prefs.k_key_omnibox!=imsg.value){TS.model.prefs.k_key_omnibox=imsg.value;TS.prefs.k_key_omnibox_changed_sig.dispatch()}break;case"seen_spaces_new_xp_tooltip":if(TS.model.prefs.seen_spaces_new_xp_tooltip!=imsg.value){TS.model.prefs.seen_spaces_new_xp_tooltip=imsg.value;TS.prefs.seen_spaces_new_xp_tooltip_changed_sig.dispatch()}break;case"no_omnibox_in_channels":if(TS.model.prefs.no_omnibox_in_channels!=imsg.value){TS.model.prefs.no_omnibox_in_channels=imsg.value;TS.prefs.no_omnibox_in_channels_changed_sig.dispatch()}break;case"k_key_omnibox_auto_hide_count":if(TS.model.prefs.k_key_omnibox_auto_hide_count!=imsg.value){TS.model.prefs.k_key_omnibox_auto_hide_count=imsg.value;TS.prefs.k_key_omnibox_auto_hide_count_changed_sig.dispatch()}break;case"preferred_skin_tone":if(TS.model.prefs.preferred_skin_tone!=imsg.value){TS.model.prefs.preferred_skin_tone=imsg.value;TS.prefs.preferred_skin_tone_changed_sig.dispatch()}break;case"show_all_skin_tones":if(TS.model.prefs.show_all_skin_tones!=imsg.value){TS.model.prefs.show_all_skin_tones=imsg.value;TS.prefs.show_all_skin_tones_changed_sig.dispatch()}break;case"msg_replies":if(TS.model.prefs.msg_replies!=imsg.value){TS.model.prefs.msg_replies=imsg.value;TS.prefs.msg_replies_changed_sig.dispatch()}break;case"separate_private_channels":if(TS.model.prefs.separate_private_channels!=imsg.value){TS.model.prefs.separate_private_channels=imsg.value;TS.prefs.separate_private_channels_changed_sig.dispatch()}break;case"whats_new_read":if(TS.model.prefs.whats_new_read!=imsg.value){TS.model.prefs.whats_new_read=imsg.value;TS.prefs.whats_new_read_changed_sig.dispatch()}break;case"tz":if(TS.model.prefs.tz!=imsg.value){TS.model.prefs.tz=imsg.value;TS.prefs.tz_changed_sig.dispatch()}break;case"hotness":if(TS.model.prefs.hotness!=imsg.value){TS.model.prefs.hotness=imsg.value;TS.prefs.hotness_changed_sig.dispatch()}break;case"frecency_jumper":if(TS.prefs.mergeFrecencyJumper(imsg.value)){TS.prefs.frecency_jumper_changed_sig.dispatch()}break;case"jumbomoji":if(TS.model.prefs.jumbomoji!=imsg.value){TS.model.prefs.jumbomoji=imsg.value;TS.prefs.jumbomoji_changed_sig.dispatch()}break;default:TS.model.prefs[imsg.name]=imsg.value}},hex_regex:new RegExp(/^#?([0-9a-f]{6})$/i),setSidebarThemeCustomValues:function(ob){var good_values=false;if(ob&&typeof ob==="object"&&ob.length===undefined){for(var k in ob){good_values=false;if(!ob[k])break;if(!ob[k].substr)break;ob[k]=ob[k].substr(0,7);if(!ob[k].match(TS.prefs.hex_regex))break;good_values=true}}if(good_values){TS.model.prefs.sidebar_theme_custom_values=JSON.stringify(ob)}else{TS.model.prefs.sidebar_theme="default";TS.model.prefs.sidebar_theme_custom_values=JSON.stringify(TS.sidebar_themes.default_themes["default_theme"])}},setMultiPrefsByAPI:function(prefs,handler){var value="";for(var k in prefs){value+="&"+encodeURIComponent(k)+"="+encodeURIComponent(prefs[k])}if(!value){TS.error(" no prefs to set?");return}var args={prefs:value};TS.prefs.setPrefByAPI(args,handler)},setPrefByAPI:function(args,handler){var localHandler=function(ok,data,args){if(!ok){var desc="args:"+JSON.stringify(args)+" ";try{desc+="data:"+JSON.stringify(data)}catch(e){desc+="data2:"+data}TS.logError({message:desc},"TS.prefs.setPrefByAPI call got a not ok rsp");setTimeout(function(){if(args.prefs){TS.error("multi preferences setting failed.")}else{TS.error('"'+args.name+'" preference setting failed.')}},0)}if(handler){handler(ok,data,args)}};return TS.api.call("users.prefs.set",args,localHandler)},saveHighlightWords:function(val,callback,force){var A=$.trim(val.replace(/\, /g,",")).split(",");var B=[];for(var i=0;i<A.length;i++){if(A[i])B.push(A[i])}var highlight_words_new=B.join(",");if(force||TS.model.prefs.highlight_words!=highlight_words_new){TS.prefs.setPrefByAPI({name:"highlight_words",value:highlight_words_new},callback)}},getReadStateTrackingPref:function(){var val="default";if(TS.model.prefs.mark_msgs_read_immediately&&TS.model.prefs.start_scroll_at_oldest){val="immediate_scroll"}else if(TS.model.prefs.mark_msgs_read_immediately){val="immediate"}return val},setReadStateTrackingPref:function(val,handler){var prefs={};if(val=="immediate_scroll"||val=="immediate"){prefs.mark_msgs_read_immediately=true;TS.model.prefs.mark_msgs_read_immediately=true;if(val=="immediate_scroll"){prefs.start_scroll_at_oldest=true;TS.model.prefs.start_scroll_at_oldest=true}else{prefs.start_scroll_at_oldest=false;TS.model.prefs.start_scroll_at_oldest=false}}else{prefs.mark_msgs_read_immediately=false;TS.model.prefs.mark_msgs_read_immediately=false;prefs.start_scroll_at_oldest=false;TS.model.prefs.start_scroll_at_oldest=false}TS.prefs.setMultiPrefsByAPI(prefs,handler)}});var _emoji_use_dirty_cnt=0})();(function(){"use strict";TS.registerModule("search",{search_dispatched_sig:new signals.Signal,quick_search_results_fetched_sig:new signals.Signal,all_search_results_fetched_sig:new signals.Signal,message_search_results_fetched_sig:new signals.Signal,file_search_results_fetched_sig:new signals.Signal,autosuggest_search_results_fetched_sig:new signals.Signal,search_filter_set_sig:new signals.Signal,search_filetype_filter_set_sig:new signals.Signal,search_sort_set_sig:new signals.Signal,search_channel_set_sig:new signals.Signal,search_group_set_sig:new signals.Signal,search_member_set_sig:new signals.Signal,message_search_more_results_fetched_sig:new signals.Signal,query:"",query_string:"",last_search_query:"",previous_query:"",sort:"timestamp",filter:"messages",filetype:"all",results:{},submit_tim:0,delay:500,suggestions:[],input:"",from_regex:/from:[@*\-.\w]+/gi,member:null,from:null,in_regex:/in:[#*\-.\w]+/gi,channel:null,group:null,im:null,per_page:-1,keyword_modifiers:["after","before","bot","during","from","to","has","in","on"],keyword_modifier_pair_regex:null,keyword_modifier_extract_regex:null,search_query_max_length:250,onStart:function(){TS.search.keyword_modifier_pair_regex=new RegExp("^("+TS.search.keyword_modifiers.join("|")+"):S+$");TS.search.keyword_modifier_extract_regex=new RegExp("^("+TS.search.keyword_modifiers.join("|")+"):w*");TS.search.per_page=parseInt(TS.qs_args["search_count"])||20;if(TS.client)TS.search.delay=10;if(TS.client){TS.client.login_sig.add(TS.search.loggedIn,TS.search)}else if(TS.web){TS.web.login_sig.add(TS.search.loggedIn,TS.search)}TS.search.search_channel_set_sig.add(TS.search.searchAll,TS.search);TS.search.search_group_set_sig.add(TS.search.searchAll,TS.search);TS.search.search_member_set_sig.add(TS.search.searchAll,TS.search);TS.prefs.search_only_my_channels_changed_sig.add(TS.search.searchAll,TS.search);TS.prefs.search_exclude_bots_changed_sig.add(TS.search.searchAll,TS.search);TS.files.team_file_changed_sig.add(_teamFileChanged);if(TS.qs_args["delay"])TS.search.delay=TS.qs_args["delay"];TS.search.input=$("#search_terms")},loggedIn:function(){var pref=TS.model.prefs.search_sort;TS.search.sort=pref=="score"||pref=="timestamp"?pref:TS.search.sort},startSearchTimer:function(query,count,callback){clearTimeout(TS.search.submit_tim);TS.search.submit_tim=setTimeout(TS.search.dispatchSearch,TS.search.delay,query,count,callback);TS.search.search_dispatched_sig.dispatch()},getNextPageOfSearchResults:function(query,page){TS.search.dispatchSearch(query,TS.search.per_page,TS.search.onSearchAll,page)},getNextPageOfMessageResults:function(query,page){var args=_args(query,TS.search.per_page,page);TS.api.call("search.messages",args,_onSearchMessages)},getNextPageOfFileResults:function(query,page){var args=_args(query,TS.search.per_page,page);TS.api.call("search.files",args,_onSearchFiles)},extractNonModifierSearchTxt:function(txt){var ret="";var A=txt.split(" ");A.forEach(function(m){if(m.match(TS.search.keyword_modifier_extract_regex))return;ret+=" "+m});ret=$.trim(ret);return ret},dispatchSearch:function(query,count,callback,page){var args=_args(query,count,page);if(!page||page==1){var system_find_str=TS.search.extractNonModifierSearchTxt(query);if(system_find_str)TSSSB.call("writeFindString",system_find_str)}if(TS.search.separateMessagesAndFiles()){if(!page||page==1)TS.search.results[query]=null;var response_tracker=_makeSearchCallbackTracker();TS.api.call("search.messages",args,response_tracker.msgs);TS.api.call("search.files",args,response_tracker.files)}else{TS.api.call("search.all",args,callback)}},setFilter:function(filter){TS.search.filter=filter;TS.search.search_filter_set_sig.dispatch()},setFiletypeFilter:function(filter){TS.search.filetype=filter;TS.search.search_filetype_filter_set_sig.dispatch()},setSort:function(sort){if(TS.search.sort==sort)return;$(".search_toggle").toggleClass("active");TS.search.sort=sort;TS.search.search_sort_set_sig.dispatch();TS.prefs.setPrefByAPI({name:"search_sort",value:sort=="score"?"score":"timestamp"})},setChannel:function(id){var channel=TS.channels.getChannelById(id);if(channel){TS.search.channel=channel;TS.search.group=null;TS.search.im=null}else{TS.search.channel=null}TS.search.search_channel_set_sig.dispatch()},setGroup:function(id){var group=TS.groups.getGroupById(id);if(group){TS.search.group=group;TS.search.channel=null;TS.search.im=null}else{TS.search.group=null}TS.search.search_group_set_sig.dispatch()},setMember:function(id){var member=TS.members.getMemberById(id);if(member){TS.search.member=member}else{TS.search.member=null;TS.search.from=null;var input_val=$.trim(TS.search.input.val());var from_matches=input_val.match(TS.search.from_regex);if(from_matches){$.each(from_matches,function(i,match){input_val=$.trim(input_val.replace(match,""))});TS.search.input.val(input_val)}}TS.search.search_member_set_sig.dispatch()},buildQueryString:function(query,set_params){var from_matches=query.match(TS.search.from_regex);if(from_matches){var from_matched=false;$.each(from_matches,function(i,match){if(from_matched){query=$.trim(query.replace(match,""))}else{var from_str=match.replace("from:","");if(from_str.toLowerCase()=="me"){if(set_params)TS.search.member=TS.model.user;TS.search.from=null;from_matched=true}else{var member=TS.members.getMemberByName(from_str);if(member){if(set_params)TS.search.member=member;TS.search.from=null;from_matched=true}else{if(set_params){TS.search.from=from_str;TS.search.member=null}else if(TS.search.member){TS.search.from=null}from_matched=true}}if(from_matched)query=$.trim(query.replace(match,""))}})}else{if(!TS.search.view.advanced_options&&TS.search.filter=="messages"){TS.search.member=null;TS.search.from=null}}var in_matches=query.match(TS.search.in_regex);if(in_matches){var in_matched=false;$.each(in_matches,function(i,match){if(in_matched){query=$.trim(query.replace(match,""))}else{var match_name=match.replace("in:","");var channel=TS.channels.getChannelByName(match_name);var group=TS.groups.getGroupByName(match_name);var im=TS.ims.getImByUsername(match_name);if(channel){in_matched=true;if(set_params){TS.search.channel=channel;TS.search.group=null;TS.search.im=null}}else if(group){in_matched=true;if(set_params){TS.search.group=group;TS.search.channel=null;TS.search.im=null}}else if(im){in_matched=true;if(set_params){TS.search.im=im;TS.search.channel=null;TS.search.group=null}}else{TS.info("Unable to filter search results by channel, group, or IM named '"+match_name+"'")}in_matched=true}if(in_matched)query=$.trim(query.replace(match,""))})}else{if(!TS.search.view.advanced_options){TS.search.channel=null;TS.search.group=null;TS.search.im=null}}if(!from_matches){if(TS.search.previous_query==TS.search.query&&set_params){TS.search.member=null;TS.search.from=null}}if(!in_matches){if(TS.search.previous_query==TS.search.query&&set_params){TS.search.channel=null;TS.search.group=null;TS.search.im=null}}TS.search.query=$.trim(query);TS.search.query_string=TS.search.query;if(TS.search.member!==null)TS.search.query_string+=" from:"+TS.search.member.name;if(TS.search.from!==null)TS.search.query_string+=" from:"+TS.search.from;if(TS.search.channel!==null)TS.search.query_string+=" in:"+TS.search.channel.name;if(TS.search.group!==null)TS.search.query_string+=" in:"+TS.search.group.name;if(TS.search.im!==null)TS.search.query_string+=" in:"+TS.search.im.name;TS.search.query_string=$.trim(TS.search.query_string)},quickSearch:function(query){TS.search.query=query;TS.search.buildQueryString(query);var count=5;TS.search.startSearchTimer(query,count,TS.search.onQuickSearch)},onQuickSearch:function(ok,data,args){if(!ok){return}TS.search.quick_search_results_fetched_sig.dispatch(data)},searchAll:function(query){if(!TS.client){clearTimeout(TS.search.widget.key_tim)}TS.search.previous_query=TS.search.query;if(query){TS.search.query=query}else{TS.search.query=$.trim(TS.search.input.val())}TS.search.query=$.trim(TS.search.query);TS.search.query_string=TS.search.query;if(TS.search.query_string){TS.search.startSearchTimer(TS.search.query_string,TS.search.per_page,TS.search.onSearchAll)}else{TS.search.view.updateOptions();if(TS.client){TS.search.autocomplete.stopSpinner()}else{TS.search.widget.stopSpinner()}}},onSearchAll:function(ok,data,args){if(TS.qs_args["force_search_fail"]=="1"){window.failed_once=true;ok=false;data={ok:false,error:"solr_failed"}}if(!ok){var err_str=data&&data.error?data.error:"unknown_error";if(!data){data={ok:false,error:err_str}}data.query=data.query||args.query;data.messages=data.messages||{total:0,paging:{count:TS.search.per_page,total:0,page:1,pages:0},matches:[]};data.files=data.files||{total:0,paging:{count:TS.search.per_page,total:0,page:1,pages:0},matches:[]}}if(args.query!=TS.search.query_string){if(!TS.search.results[args.query]||!TS.search.results[args.query].error){return}}TS.search.last_search_query=args.query;if(TS.client)TS.search.upsertFiles(data);TS.search.expandChannelsAndCheckForMsgsInModel(data);if(args.page==1){TS.search.results[args.query]=data;TS.search.results[args.query]["_time_of_search"]=Date.now();TS.search.all_search_results_fetched_sig.dispatch(data,args);TS.search.getNextPageOfSearchResults(args.query,2)}else{var existing=TS.search.results[args.query];if(existing.messages.matches)data.messages.matches=existing.messages.matches.concat(data.messages.matches);if(existing.files.matches)data.files.matches=existing.files.matches.concat(data.files.matches);TS.search.results[args.query]=data;TS.search.all_search_results_fetched_sig.dispatch(data,args)}},searchSuggest:function(query){TS.api.call("search.autocomplete",{query:query},TS.search.onSearchSuggest)},onSearchSuggest:function(ok,data,args){if(!TS.client){if(TS.search.widget.suppress_suggestions){TS.search.widget.suppress_suggestions=false;return}}if(!ok){return}TS.search.suggestions=[];if(data.suggestions[0]==TS.search.query&&data.suggestions.length==1){TS.search.suggestions=[]}else{$.each(data.suggestions,function(i,value){TS.search.suggestions[i]={value:value,highlighted:TS.search.highlightSuggestion(TS.utility.htmlEntities(value))}})}TS.search.autosuggest_search_results_fetched_sig.dispatch(data,args)},highlightSuggestion:function(value){var highlighted=value.replace(new RegExp("("+TS.utility.preg_quote(TS.search.input.val())+")","gi"),"<b>$1</b>");return highlighted},expandChannelsAndCheckForMsgsInModel:function(results){var match;var model_ob;if(!results.messages||!results.messages.matches)return;var existing_rxns;for(var i=0;i<results.messages.matches.length;i++){match=results.messages.matches[i];if(!match){continue}TS.utility.msgs.processAttachments(match.attachments);if(match.next)TS.utility.msgs.processAttachments(match.next.attachments);if(match.next_2)TS.utility.msgs.processAttachments(match.next_2.attachments);if(match.previous)TS.utility.msgs.processAttachments(match.previous.attachments);if(match.previous_2)TS.utility.msgs.processAttachments(match.previous_2.attachments);match._rxn_key=TS.rxns.getRxnKey("message",match.ts,match.channel.id);existing_rxns=TS.rxns.getExistingRxnsByKey(match._rxn_key);if(existing_rxns&&!match.reactions){TS.warn("msg:"+match.ts+" has reactions in local model, but we got an object in search results that does NOT have reactions, which seems suspicious")}else{TS.rxns.upsertRxnsFromDataAndUpdateUI(match._rxn_key,match.reactions)}model_ob=TS.shared.getModelObById(match.channel.id);if(model_ob){if(match.type=="im"&&!TS.ims.isImWithDeletedMember(model_ob)){match.im_exists=true}if(model_ob.msgs){match.is_loaded=!!TS.utility.msgs.getMsg(match.ts,model_ob.msgs)}else if(TS.client){TS.warn(model_ob.name+" has no msgs")}match.channel=model_ob;if(!match.permalink)match.permalink=TS.utility.msgs.constructMsgPermalink(model_ob,match.ts)}}},upsertFiles:function(data){if(!data.files||!data.files.matches)return;for(var i=0;i<data.files.matches.length;i++){if(data.files.matches[i].preview){data.files.matches[i].preview_search=data.files.matches[i].preview;delete data.files.matches[i].preview}data.files.matches[i]=TS.files.upsertFile(data.files.matches[i]).file}},getResultsByQuery:function(query){return TS.search.results[query]},getMatchByQueryAndTs:function(query,ts){return TS.search.getMatchByQueryByThings(query,ts)},getMatchByQueryAndChannelAndTs:function(query,channel_id,ts){return TS.search.getMatchByQueryByThings(query,ts,channel_id)},getMatchByQueryByThings:function(query,ts,channel_id){var results=TS.search.getResultsByQuery(query);if(!results){TS.error("WTF no results?");return null}return TS.search.getMatchFromResultsByThings(false,results,ts,channel_id)},getMatchFromResultsByThings:function(return_ob,results,ts,channel_id){if(!results){TS.error("WTF no results?");return null}if(!results.messages){TS.error("WTF no results.messages?");return null}if(!results.messages.matches){TS.error("WTF no results.messages.matches?");return null}var match;for(var i=0;i<results.messages.matches.length;i++){match=results.messages.matches[i];if(!match){TS.error("WTF no match?");continue}if((!channel_id||match.channel.id==channel_id)&&match.ts==ts){if(return_ob){return{match:match,index:i}}else{return match}}}return null},truncateQuery:function(q){if(q.length>TS.search.search_query_max_length){return q.substring(0,TS.search.search_query_max_length)}return q},resetSearchOptions:function(){TS.search.channel=null;TS.search.group=null;TS.search.im=null;TS.search.member=null;TS.search.from=null;TS.search.searchAll()},saveSearch:function(params,callback){if(!params.terms)return;params.terms=$.trim(params.terms);if(TS.search.keyword_modifier_pair_regex.test(params.terms))return;TS.api.call("search.save",params,callback)},separateMessagesAndFiles:function(){return!!TS.client},setInputVal:function(txt){TS.search.input.val(txt).focus()},appendToInputAndSelect:function(txt){var current=TS.search.input.val();if(current&&!/\s$/.test(current))current+=" ";TS.search.input.val(current+txt);TS.search.input.textrange("set",current.length,current.length+txt.length)},submitSearch:function(){TS.search.input.closest("form").trigger("submit")}});var _args=function(query,count,page){var args={query:query,highlight:true,count:count,types:[TS.search.filetype],sort:TS.search.sort,no_posts:1,more_matches:true,page:page||1,extracts:1,extra_message_data:1,max_extract_len:150,highlight_attachments:1};return args};var _onSearchMessages=function(ok,data,args){
if(!ok||!data.messages){var err_str=data&&data.error?data.error:"unknown_error";if(!data){data={ok:false,error:err_str}}data.query=data.query||args.query;data.messages=data.messages||{total:0,paging:{count:TS.search.per_page,total:0,page:1,pages:0},matches:[]}}if(args.query!=TS.search.query_string){if(!TS.search.results[args.query]||!TS.search.results[args.query].error){return}}if(TS.search.last_search_query!==args.query){delete TS.search.results[TS.search.last_search_query]}TS.search.last_search_query=args.query;TS.search.expandChannelsAndCheckForMsgsInModel(data);var existing=TS.search.results[args.query];if(args.page==1){if(!existing){TS.search.results[args.query]=data;existing=data}else{$.extend(existing,data)}existing.initial_messages_total=data.messages.total;existing["_time_of_search"]=Date.now();TS.search.message_search_results_fetched_sig.dispatch(existing,args)}else{if(existing.messages&&existing.messages.matches){data.messages.matches=existing.messages.matches.concat(data.messages.matches)}$.extend(existing,data);TS.search.message_search_results_fetched_sig.dispatch(existing,args)}};var _onSearchFiles=function(ok,data,args){if(!ok||!data.files){var err_str=data&&data.error?data.error:"unknown_error";if(!data){data={ok:false,error:err_str}}data.query=data.query||args.query;data.files=data.files||{total:0,paging:{count:TS.search.per_page,total:0,page:1,pages:0},matches:[]}}if(args.query!=TS.search.query_string){if(!TS.search.results[args.query]||!TS.search.results[args.query].error){return}}if(TS.search.last_search_query!==args.query){delete TS.search.results[TS.search.last_search_query]}TS.search.last_search_query=args.query;if(TS.client)TS.search.upsertFiles(data);var existing=TS.search.results[args.query];if(args.page==1){if(!existing){TS.search.results[args.query]=data;existing=data}else{$.extend(existing,data)}existing.initial_files_total=data.files.total;existing["_time_of_search"]=Date.now();TS.search.file_search_results_fetched_sig.dispatch(existing,args)}else{if(existing.files&&existing.files.matches){data.files.matches=existing.files.matches.concat(data.files.matches)}$.extend(existing,data);TS.search.file_search_results_fetched_sig.dispatch(existing,args)}};var _makeSearchCallbackTracker=function(){var msgs_fetched=false;var files_fetched=false;var after=function(){if(msgs_fetched&&files_fetched){TS.search.all_search_results_fetched_sig.dispatch()}};return{msgs:function(){msgs_fetched=true;_onSearchMessages.apply(this,arguments);after()},files:function(){files_fetched=true;_onSearchFiles.apply(this,arguments);after()}}};var _teamFileChanged=function(file){TS.files.updateFileListItem(file,$("#search_results_items"))}})();(function(){"use strict";TS.registerModule("ms",{last_pong_time:0,sent_map:{},connected_sig:new signals.Signal,disconnected_sig:new signals.Signal,trouble_sig:new signals.Signal,reconnecting_sig:new signals.Signal,pong_sig:new signals.Signal,on_msg_sig:new signals.Signal,reconnect_requested_sig:new signals.Signal,onStart:function(){_setPongTimeoutMs(TS.model.ui.is_window_focused||false);TS.ui.window_focus_changed_sig.add(_setPongTimeoutMs);setInterval(function(){if(!TS.model.ms_connected)return;if(TS.model.rtm_start_throttler<1)return;TS.model.rtm_start_throttler--},1e3*60)},send:function(msg,handler,temp_ts){msg.id=++_msg_id;TS.ms.sent_map[msg.id.toString()]={msg:msg,handler:handler,ts:Date.now(),temp_ts:temp_ts};if(msg.type=="ping"||msg.type=="pong"){TS.log(3,"MS sending "+msg.type);TS.dir(3,msg)}else{TS.model.last_net_send=Date.now();TS.log(2,"sending "+msg.type);TS.dir(2,msg)}_websocket.send(JSON.stringify(msg));return msg.id},sendTyping:function(c_id){var msg_str='{"type":"typing", "channel":"'+c_id+'"}';_websocket.send(msg_str)},sendTickle:function(){TS.model.last_net_send=Date.now();var msg_str='{"type":"tickle"}';_websocket.send(msg_str)},handleMsg:function(imsg){var is_reconnect_reply=imsg.reply_to&&!("ok"in imsg)&&imsg.type=="message";if(is_reconnect_reply){}var sent;if(imsg.reply_to){if(imsg.reply_to.toString()in TS.ms.sent_map){sent=TS.ms.sent_map[imsg.reply_to];imsg.SENT_MSG=sent.msg;delete TS.ms.sent_map[imsg.reply_to]}else{if(!is_reconnect_reply){TS.error('received msg "'+imsg.reply_to+'" with type "'+imsg.type+'" but we have no record of it in sent_map')}}}else{if(imsg.event_ts&&!imsg._from_evt_log){TS.ms.storeLastEventTS(imsg.event_ts)}if(TS.model.supports_user_caching&&imsg.cache_ts){TS.storage.rememberLastCacheTS(imsg.cache_ts)}}if(imsg.type=="ping"||imsg.type=="pong"){TS.log(3,"MS msg "+imsg.type+" time: "+(Date.now()-sent.ts)+"ms");TS.ms.last_pong_time=Date.now();TS.ms.pong_sig.dispatch();_check_last_pong_time=false;TS.dir(3,imsg)}else{if(sent){var type=imsg.type?imsg.type:imsg.SENT_MSG.type?imsg.SENT_MSG.type:"";TS.log(2,"msg "+(type?'"'+type+'" ':"")+"rsp time "+(Date.now()-sent.ts)+"ms")}else{TS.log(2,'msg "'+imsg.type+'"')}TS.dir(2,imsg)}if(imsg.type=="error"){_onErrorMsg(imsg)}else if(imsg.type=="hello"){_onHello()}else if(!imsg.reply_to){TS.ms.on_msg_sig.dispatch(imsg)}if(sent){if(!imsg.ok){imsg.error=imsg.error||{code:0,msg:"unknown error (not specified by MS)"}}if(is_reconnect_reply){imsg.ok=true}if(sent.handler){sent.handler(imsg.ok,imsg)}}},storeLastEventTS:function(ts){if(!ts)return;var last_event_ts=TS.storage.fetchLastEventTS();if(last_event_ts&&ts<=last_event_ts)return;TS.storage.storeLastEventTS(ts)},onFailure:function(reason_str){TS.warn("TS.ms.onFailure reason_str:"+reason_str);if(reason_str)_reportDisconnect("You got disconnected and are on team Tiny Speck, so here are some details:\n>>>"+reason_str);_check_last_pong_time=false;_deprecateCurrentSocket();if(TS.model.ms_connected){TS.info("Disconnected from MS, TS.model.rtm_start_throttler:"+TS.model.rtm_start_throttler);TS.ms.logConnectionFlow("on_connected_failure");TS.model.ms_reconnect_ms=100;TS.ms.disconnect()}else{TS.ms.logConnectionFlow("on_notconnected_failure");var ms=TS.model.ms_reconnect_ms=(TS.model.ms_reconnect_ms+1e3)*2;if(TS.model.ms_reconnect_ms>4e3){TS.model.ms_reconnect_ms=TS.utility.randomInt(ms,ms+ms/2)}TS.model.ms_reconnect_ms=Math.min(TS.model.ms_reconnect_ms,3e5)}if(TS.model.rtm_start_throttler>5){var min_ms=2e3*TS.model.rtm_start_throttler;if(TS.model.ms_reconnect_ms<min_ms){TS.info("because TS.model.rtm_start_throttler:"+TS.model.rtm_start_throttler+" we are increasing time until next login call");TS.model.ms_reconnect_ms=min_ms}}if(TS.model.ms_connected){TS.model.ms_connected=false;TS.ms.disconnected_sig.dispatch()}TS.model.ms_connected=false;clearInterval(_check_ping_interv);clearInterval(_send_ping_interv);if(TS.model.ms_asleep){TS.warn("NOT doing startReconnection(), we are asleep");return}if(TS.api.isPaused()){TS.warn("NOT doing startReconnection() because TS.api.isPaused()");return}TS.ms.startReconnection()},startReconnection:function(){TS.model.ms_reconnect_time=Date.now()+TS.model.ms_reconnect_ms;TS.info("Attempting to reconnect in "+TS.model.ms_reconnect_ms+"ms");clearInterval(_reconnect_interv);_reconnect_interv=setInterval(_onReconnectInterval,_reconnect_interv_ms);_onReconnectInterval();clearTimeout(_auto_reconnect_tim);_auto_reconnect_tim=setTimeout(function(){if(!TS.model.window_unloading){TS.ms.startReconnectionImmediately()}},TS.model.ms_reconnect_ms)},startReconnectionImmediately:function(){clearTimeout(_auto_reconnect_tim);if(TS.model.attempting_fast_reconnect&&_isReconnectUrlValid()){TS.ms.fastReconnect()}else{if(TS.model.attempting_fast_reconnect)_clearReconnectUrl();TS.ms.reconnect_requested_sig.dispatch()}},manualReconnectNow:function(){TS.ms.logConnectionFlow("manual_reconnect");clearTimeout(_auto_reconnect_tim);clearInterval(_reconnect_interv);clearTimeout(_connect_timeout_tim);_connect_timeout_count=0;if(!TS.model.window_unloading){TS.ms.reconnect_requested_sig.dispatch();TS.ms.reconnecting_sig.dispatch(0)}},disconnect:function(){if(_websocket&&TS.model.ms_connected){TS.ms.logConnectionFlow("disconnect");_websocket.close()}else{TS.warn("TS.ms.disconnect called, but _websocket="+_websocket+" TS.model.ms_connected="+TS.model.ms_connected)}},logConnectionFlow:function(name){var ms_conn_log=TS.model.ms_conn_log;var time=Date.now();ms_conn_log.push({name:name,time:time,delta:ms_conn_log.length?time-ms_conn_log[ms_conn_log.length-1].time:0});TS.log(2,"logConnectionFlow "+name+" "+ms_conn_log[ms_conn_log.length-1].delta)},getConnectionFlowLog:function(){var ms_conn_log=TS.model.ms_conn_log;var args=[];for(var i=0;i<ms_conn_log.length;i++){args.push(encodeURIComponent(ms_conn_log[i].name+"-"+(ms_conn_log[i].delta?Math.round(ms_conn_log[i].delta/1e3):0)+"-"+Math.round(ms_conn_log[i].time/1e3)))}TS.dir(2,TS.model.ms_conn_log);var log=args.join("&");return log},connect:function(url){if(!url)url=TS.model.team.url;TSConnLogger.log("ms_connecting","TS.ms.connect "+url);if(!window.WebSocket){window.WebSocket=window.MozWebSocket}if(window.WebSocket){try{TS.ms.logConnectionFlow("connect");var special_str=TS.qs_args["simulate_old_token"]==1?"&TRIGGER_OLD_TOKEN=1":"";url+="?version_uid="+TS.boot_data.version_uid+special_str;url=TS.utility.appendLogToUrlWithLimit(url,TS.ms.getConnectionFlowLog());TS.info("Connecting to: "+url);if(TS.qs_args["simulate_first_connect_failure"]==1&&!window.already_simulated_first_connect_failure){url=url.replace("e","w");TS.info("simulate_first_connect_failure url:"+url);window.already_simulated_first_connect_failure=true}_connect_timeout_tim_ms=window.WEB_SOCKET_USING_FLASH?_connect_flash_timeout_tim_ms:_connect_ws_timeout_tim_ms;clearTimeout(_connect_timeout_tim);_connect_timeout_tim=setTimeout(_onConnectTimeout,_connect_timeout_tim_ms);TS.ms.last_url=url;TS.ms.last_start_ms=Date.now();_deprecateCurrentSocket();_websocket=new WebSocket(url)}catch(error){TS.warn("failed to create new WebSocket");TS.error(error);TS.ms.onFailure("failed to create new WebSocket");return}TS.model.ms_connecting=true;if(TS.qs_args["simulate_first_connect_timeout"]==1&&_connect_timeout_count<1){TS.info("simulate_first_connect_timeout url:"+url)}else{_websocket.onopen=_onConnect}_websocket.onclose=_onDisconnect;_websocket.onerror=_onError}else{alert("Your browser does not support Web Sockets.")}},fastReconnect:function(){TS.info("Trying fast reconnect");TS.model.calling_test_fast_reconnect=true;TS.api.callImmediately("test.fastReconnect").then(function(response){var data=response.data;if(TS.reloadIfVersionsChanged(data))return;TS.ms.connect(_reconnect_url)},function(response){var data=response.data;var error=data&&data.error;if(error&&error!=="_http_error")_clearReconnectUrl();TS.ms.onFailure("test.fastReconnect returned not-OK. error: "+error)}).finally(function(){TS.model.calling_test_fast_reconnect=false})},setReconnectUrl:function(url){_reconnect_url=url;_reconnect_url_received_at=Date.now()},sleep:function(){if(TS.model.ms_asleep)return;if(!TS.model.ms_connected)return;TS.model.ms_asleep=true;TS.ms.disconnect()},wake:function(){if(!TS.model.ms_asleep)return;TS.model.ms_asleep=false;TS.ms.startReconnection()}});var _check_ping_interv=0;var _check_ping_interv_ms=3e3;var _send_ping_interv=0;var _send_ping_interv_ms=1e4;var _connect_timeout_tim=0;var _connect_timeout_tim_ms=0;var _connect_ws_timeout_tim_ms=1e4;var _connect_flash_timeout_tim_ms=2e4;var _hello_timeout_tim=0;var _hello_timeout_tim_ms=1e4;var _disconnect_timeout_tim=0;var _disconnect_timeout_tim_ms=5e3;var _reconnect_interv=0;var _reconnect_interv_ms=1e3;var _auto_reconnect_tim=0;var _websocket=null;var _msg_id=0;var _check_last_pong_time=false;var _pong_timeout_ms=0;var _away_limit_ms=3e5;var _connect_timeout_count=0;var _last_slack_broadcast_imsg=null;var _eventlog_per_page=2e3;var _reconnect_url=null;var _reconnect_url_received_at=null;var _last_connect_was_fast=false;var _reconnect_url_limit_ms=3e5;var _setPongTimeoutMs=function(has_focus){if(has_focus){_pong_timeout_ms=1e4}else{_pong_timeout_ms=6e4}_pong_timeout_ms+=_send_ping_interv_ms;TS.log(3,"MS _pong_timeout_ms set to:"+_pong_timeout_ms+" has_focus:"+has_focus)};var _onMsg=function(e){var imsg=JSON.parse(e.data);TS.ms.handleMsg(imsg)};var _onConnect=function(e){clearTimeout(_connect_timeout_tim);_connect_timeout_count=0;if(TS.model.attempting_fast_reconnect){_clearReconnectUrl();_last_connect_was_fast=true}else{_last_connect_was_fast=false}if(TS.qs_args["simulate_hello_timeout"]==1&&!window.already_simulated_hello_timeout){TS.info("simulate_hello_timeout");window.already_simulated_hello_timeout=true}else{_websocket.onmessage=_onMsg}TS.model.ms_conn_log.length=0;TSConnLogger.log("ms_connected","_onConnect (took "+(Date.now()-TS.ms.last_start_ms)+"ms)");TS.info("MS WS connected!");TS.ms.logConnectionFlow("on_connect");clearTimeout(_hello_timeout_tim);_hello_timeout_tim=setTimeout(_onHelloTimeout,_hello_timeout_tim_ms)};var _onEventLog=function(ok,data,args){var done=function(){TS.utility.msgs.checkConsistencyViaApi(TS.model.active_cid)};if(!ok){TS.error("_onEventLog "+data);if(TS.client&&data&&data.error=="timestamp_too_old"){TS.storage.cleanOutMsgStorageAndReset();var msg="TS.reload() after a TS.storage.cleanOutMsgStorageAndReset() because data.error: <code>timestamp_too_old</code>";if(data.reason){msg+=" data.reason: <code>"+data.reason+"</code>"}if(args)delete args.token;try{msg+=" args: <pre>"+JSON.stringify(args,null,"	")+"</pre>"}catch(err){}msg+="<p><b>Tell eric about this, please!</b></p>";setTimeout(TS.reload,1,null,msg)}done();return}if(!data.events){TS.error("_onEventLog missing events");done();return}if(TS.client&&data.has_more){TS.storage.cleanOutMsgStorageAndReset();TS.info("going to call TS.reload() after a TS.storage.cleanOutMsgStorageAndReset() because data.has_more:"+data.has_more+")");setTimeout(TS.reload,1,null,"TS.reload() after a TS.storage.cleanOutMsgStorageAndReset() because data.has_more:"+data.has_more+")");return}var last_eventlog_ts;var imsg;var imsgs_to_handle=[];var uniques_handled={};var unique_str;var i;for(i=data.events.length-1;i>-1;i--){imsg=data.events[i];imsg._from_evt_log=true;unique_str=null;last_eventlog_ts=last_eventlog_ts||imsg.event_ts;if(imsg.type=="file_change"&&imsg.file&&imsg.file.id){unique_str=imsg.type+imsg.file.id}else if(imsg.type=="user_change"&&imsg.user&&imsg.user.id){unique_str=imsg.type+imsg.user.id}else if(imsg.type=="emoji_changed"){unique_str=imsg.type}else if(imsg.type=="channel_history_changed"&&imsg.channel){TS.info("eventlog: channel_history_changed for "+imsg.channel);unique_str=imsg.type+imsg.channel}else if(imsg.type=="group_history_changed"&&imsg.channel){TS.info("eventlog: group_history_changed for "+imsg.channel);unique_str=imsg.type+imsg.channel}else if(imsg.type=="im_history_changed"&&imsg.channel){TS.info("eventlog: im_history_changed for "+imsg.channel);unique_str=imsg.type+imsg.channel}if(unique_str){if(uniques_handled[unique_str])continue;uniques_handled[unique_str]=true;imsgs_to_handle.unshift(imsg)}else if(imsg.type=="slack_broadcast"){if(!imsg.reload)continue;var last=_last_slack_broadcast_imsg;if(last){if(!last.force_reload&&imsg.force_reload){_last_slack_broadcast_imsg=imsg}}else{_last_slack_broadcast_imsg=imsg}}else{imsgs_to_handle.unshift(imsg)}}for(i=0;i<imsgs_to_handle.length;i++){imsg=imsgs_to_handle[i];try{TS.ms.handleMsg(imsg)}catch(e){}}if(last_eventlog_ts){TS.ms.storeLastEventTS(last_eventlog_ts)}if(_last_slack_broadcast_imsg){try{TS.ms.handleMsg(_last_slack_broadcast_imsg)}catch(e){}_last_slack_broadcast_imsg=null}done()};var _checkPings=function(){if(!_check_last_pong_time)return;var since_last_pong_ms=Date.now()-TS.ms.last_pong_time;TS.log(3,"MS since_last_pong_ms:"+since_last_pong_ms+" pong_timeout_ms:"+_pong_timeout_ms);if(since_last_pong_ms<_pong_timeout_ms)return;TS.warn("since_last_pong_ms too long! "+since_last_pong_ms+" > "+_pong_timeout_ms);TS.warn("calling disconnect(), expect to get an onDisconnect() callback");TS.ms.logConnectionFlow("on_ping_timeout");TS.ms.trouble_sig.dispatch();_check_last_pong_time=false;_reportDisconnect("You are on team Tiny Speck, so here are some pong details:\n>>>"+"since_last_pong_ms too long! "+since_last_pong_ms+" > "+_pong_timeout_ms+" ... calling disconnect(), expect to get an onDisconnect() callback");try{TS.ms.disconnect();clearTimeout(_disconnect_timeout_tim);_disconnect_timeout_tim=setTimeout(function(){TS.info("called disconnect, no onDisconnect callback happened in "+_disconnect_timeout_tim_ms+"ms, so calling _onDisconnect() manually now");_onDisconnect(null,"since_last_pong_ms too long! then called disconnect, but no onDisconnect callback happened in "+_disconnect_timeout_tim_ms+"ms, so calling _onDisconnect() manually now")},_disconnect_timeout_tim_ms)}catch(err){TS.info("since_last_pong_ms too long! then an error calling disconnect, going to assume it is because it is already closed, calling _onDisconnect() manually now");TS.warn(err);_onDisconnect(null,"error calling disconnect, going to assume it is because it is already closed, calling _onDisconnect() manually now")}};var _sendPing=function(){TS.ms.send({type:"ping"});_check_last_pong_time=true};var _onDisconnect=function(e,reason_str){reason_str=reason_str||"_onDisconnect called with event:"+e;TS.info("MS WS disconnected");TS.ms.logConnectionFlow("on_disconnect");clearTimeout(_disconnect_timeout_tim);clearTimeout(_hello_timeout_tim);clearTimeout(_connect_timeout_tim);if(e){TS.info("_onDisconnect event.code:"+e.code);if(e.code=="1006"&&false){TS.generic_dialog.start({title:"Connection trouble error #1006",body:"Apologies, we're having some trouble with your connection. The particular error code indicates that restarting the application might fix it.",show_cancel_button:false,show_go_button:true,go_button_text:"OK",esc_for_ok:true})}}else{TS.info("no event")}if(_isReconnectUrlValid()){TS.model.attempting_fast_reconnect=true}TS.ms.onFailure(reason_str)};var _reportDisconnect=function(reason_str){return};var _deprecateCurrentSocket=function(){if(!_websocket)return;_websocket.onmessage=null;_websocket.onopen=null;_websocket.onerror=null;_websocket.onclose=null;try{_websocket.close()}catch(err){}if(false){var old_socket=_websocket;_websocket.onclose=function(e){TS.ms.logConnectionFlow("old_socket_closed");if(!TS.model.ms_connected&&!TS.model.ms_connecting){TS.warn("Our last socket just fired a close event, and we are not yet connected or connecting again, so let us jump start the connection process with manualReconnectNow()");TS.ms.manualReconnectNow()}old_socket.onclose=null}}};var _onReconnectInterval=function(){var ms=TS.model.ms_reconnect_time-Date.now();var secs=Math.round(ms/1e3);if(secs>=0){TS.ms.reconnecting_sig.dispatch(secs)}if(TS.model.window_unloading){clearInterval(_reconnect_interv)}};var _onHelloTimeout=function(){var desc="socket received no hello msg "+_hello_timeout_tim_ms+"ms after connection";TS.warn(desc);TS.ms.logConnectionFlow("_onHelloTimeout");TS.ms.onFailure(desc)};var _onConnectTimeout=function(){_connect_timeout_count++;var desc="socket not connected "+_connect_timeout_tim_ms+"ms after creation. _connect_timeout_count:"+_connect_timeout_count;TS.warn(desc);TS.ms.logConnectionFlow("_onConnectTimeout");if(_connect_timeout_count==3){TS.generic_dialog.start({title:"Connection trouble",body:"<p>Apologies, we're having some trouble with your web socket connection.</p>				<p>We've seen this problem clear up with a restart of "+(TS.model.is_our_app?"Slack":"your browser")+", 				a solution which we suggest to you now only with great regret and self-loathing.</p>				",show_cancel_button:false,go_button_text:"OK",esc_for_ok:true});return}else if(_connect_timeout_count==2){if(window.WEB_SOCKET_USING_FLASH){}else if(TS.model.is_chrome&&!TS.model.is_our_app){window.fallBackToFlashWebSockets();setTimeout(function(){if(window.WEB_SOCKET_USING_FLASH_BUT_NO_FLASH||!document.getElementById("webSocketFlash")||!document.getElementById("webSocketFlash").receiveEvents){TS.generic_dialog.start({title:"Connection trouble",body:"<p>Apologies, we're having some trouble with your web socket connection. 							We tried falling back to Flash, but it appears you do not have a version of Flash installed that we can use.</p>							<p>But we've seen this problem clear up with a restart of "+(TS.model.is_our_app?"Slack":"your browser")+", 							a solution which we suggest to you now only with great regret and self-loathing.</p>							",show_cancel_button:false,go_button_text:"OK",esc_for_ok:true})}else{TS.ms.onFailure("3secs passed, waiting on Flash, no connection")}},3e3);return}}TS.ms.onFailure(desc)};var _onError=function(e){var err_str="";if(e){if(e.name)err_str+=" e.name="+e.name;if(e.message)err_str+=" e.message="+e.message;if(e.data)err_str+=" e.data="+e.data}TS.warn("_onError err_str: "+err_str);TS.dir(0,e)};var _onErrorMsg=function(imsg){if(imsg.error){if(imsg.error.code==1){TS.ms.logConnectionFlow("msg_error_code_1");_clearReconnectUrl()}else{TS.logError({message:JSON.stringify(imsg)},"_onErrorMsg");TS.ms.onFailure("_onErrorMsg imsg.error:"+imsg.error)}}else{TS.logError({message:imsg?JSON.stringify(imsg):"no imsg?"},"_onErrorMsg")}};var _onHello=function(){clearTimeout(_hello_timeout_tim);TSConnLogger.log("ms_hello","_onHello (took "+(Date.now()-TS.ms.last_start_ms)+"ms)");var since_last_pong_ms=Date.now()-TS.ms.last_pong_time;TS.info("Hello msg recvd, since_last_pong_ms:"+since_last_pong_ms);TS.ms.logConnectionFlow("on_hello");if(TS.client&&since_last_pong_ms>_away_limit_ms&&!_last_connect_was_fast){TS.client.ui.maybePromptForSetActive()}clearInterval(_reconnect_interv);_check_last_pong_time=true;TS.ms.last_pong_time=Date.now();clearInterval(_check_ping_interv);_check_ping_interv=setInterval(_checkPings,_check_ping_interv_ms);clearInterval(_send_ping_interv);_send_ping_interv=setInterval(_sendPing,_send_ping_interv_ms);TS.model.ms_connecting=false;TS.model.ms_connected=true;var last_event_ts=TS.storage.fetchLastEventTS();if(last_event_ts&&!_last_connect_was_fast){TS.info("calling eventlog.history with start:"+last_event_ts+" (from TS.storage.fetchLastEventTS())");TS.api.callImmediately("eventlog.history",{start:last_event_ts,count:_eventlog_per_page},_onEventLog)}else{TS.utility.msgs.checkConsistencyViaApi(TS.model.active_cid)}TS.ms.connected_sig.dispatch(_last_connect_was_fast);_sendPing()};var _isReconnectUrlValid=function(){if(!TS.boot_data.feature_client_fast_reconnect)return false;if(!_reconnect_url)return false;var now=Date.now();var reconnect_url_age=now-_reconnect_url_received_at;if(reconnect_url_age<_reconnect_url_limit_ms)return true;_clearReconnectUrl();return false};var _clearReconnectUrl=function(){TS.model.attempting_fast_reconnect=false;_reconnect_url=null;_reconnect_url_received_at=null}})();(function(){"use strict";TS.registerModule("ms.msg_handlers",{onStart:function(){TS.ms.on_msg_sig.add(TS.ms.msg_handlers.msgReceived)},msgReceivedFromParentWindow:function(imsg){TS.ms.msg_handlers.msgReceived(imsg)},msgReceived:function(imsg){if(imsg.reply_to)return;if(!TS.ms.msg_handlers[imsg.type])return;_addToQ(imsg)},message:function(imsg){if(!TS.client)return;TS.log(2,"recved message "+imsg.type);if(imsg.is_ephemeral&&!imsg.ts){imsg.ts=TS.utility.date.makeTsStamp()}var subtype_method_name="subtype__"+imsg.subtype;if(subtype_method_name in TS.ms.msg_handlers){if(TS.boot_data.feature_channel_eventlog_client){if(imsg.subtype=="message_changed"||imsg.subtype=="message_deleted"||imsg.subtype=="channel_history_changed"||imsg.subtype=="group_history_changed"||imsg.subtype=="im_history_changed"||imsg.subtype=="mpim_history_changed"){imsg.type=imsg.subtype;delete imsg.subtype;TS.ms.msg_handlers[imsg.type](imsg);return}if(imsg.hidden){console.error("WE SHOULD NOT BE GETTING ANY HIDDEN MESSAGES ANYMORE");console.dir(0,imsg)}}TS.ms.msg_handlers[subtype_method_name](imsg)}var msg=TS.utility.msgs.processImsg(imsg,imsg.channel);if(TS.ims.getImById(imsg.channel)){if(imsg.text=="start_profile_AAAAAA"){TS.model.profiling_keys=true}else if(imsg.text=="end_profile_AAAAAA"){TS.model.profiling_keys=false;if(TS.model.profiling_key_times){TS.files.upload({text:JSON.stringify(TS.model.profiling_key_times,null,"	"),title:"auto profile",filetype:"javascript",channels:[imsg.channel],initial_comment:""});delete TS.model.profiling_key_times}}TS.ims.addMsg(imsg.channel,msg)}else if(TS.mpims.getMpimById(imsg.channel)){TS.mpims.addMsg(imsg.channel,msg)}else if(TS.groups.getGroupById(imsg.channel)){TS.groups.addMsg(imsg.channel,msg)}else{TS.channels.addMsg(imsg.channel,msg)}var model_ob=TS.shared.getModelObById(imsg.channel);var member=TS.members.getMemberById(msg.user);if(TS.typing&&member&&model_ob)TS.typing.memberEnded(model_ob,member)},subtype__file_share:function(imsg){if(!imsg.file)return;if(imsg.file.id==TS.files.polling_file_id){TS.files.uploadProcessingOver(true,imsg.file.id)}},message_changed:function(imsg){TS.log(2,"recved message "+imsg.type);TS.ms.msg_handlers.message_changed_worker(imsg)},subtype__message_changed:function(imsg){TS.log(2,"recved subtype "+imsg.subtype);if(TS.boot_data.feature_channel_eventlog_client){TS.warn("feature_channel_eventlog_client=1 so we should never be getting subtype "+imsg.subtype)}TS.ms.msg_handlers.message_changed_worker(imsg)},message_changed_worker:function(imsg){if(!imsg.message){TS.error("no message?");return}TS.mentions.replaceMsg(imsg.message);var model_ob=TS.shared.getModelObById(imsg.channel);if(!model_ob){TS.error("unknown imsg.channel:"+imsg.channel);return}if(TS.pins){TS.pins.replaceMsg(imsg.message,model_ob)}if(imsg.message.imgs||TS.utility.msgs.hasImgs(imsg.message)){TS.model.show_inline_img_size_pref_reminder=true}var might_not_exist=true;TS.utility.msgs.replaceMsg(model_ob,imsg.message,might_not_exist)},message_deleted:function(imsg){TS.log(2,"recved message "+imsg.type);TS.ms.msg_handlers.message_deleted_worker(imsg)},subtype__message_deleted:function(imsg){TS.log(2,"recved subtype "+imsg.subtype);if(TS.boot_data.feature_channel_eventlog_client){TS.warn("feature_channel_eventlog_client=1 so we should never be getting subtype "+imsg.subtype)}TS.ms.msg_handlers.message_deleted_worker(imsg)},message_deleted_worker:function(imsg){if(!imsg.deleted_ts){TS.error("no deleted_ts?");return}TS.mentions.removeMsg(imsg.deleted_ts);var channel=TS.channels.getChannelById(imsg.channel);var im;var group;var mpim;if(!channel)im=TS.ims.getImById(imsg.channel);if(!channel&&!im)mpim=TS.mpims.getMpimById(imsg.channel);if(!channel&&!im&&!mpim)group=TS.groups.getGroupById(imsg.channel);if(!im&&!channel&&!mpim&&!group){TS.error("unknown imsg.channel:"+imsg.channel);return}var model_ob=im||channel||mpim||group;if(TS.pins){TS.pins.removeMsg(imsg.deleted_ts,model_ob)}var original_msg=TS.utility.msgs.getMsg(imsg.deleted_ts,model_ob.msgs);if(!original_msg&&model_ob._archive_msgs){original_msg=TS.utility.msgs.getMsg(imsg.deleted_ts,model_ob._archive_msgs)}if(!original_msg){return}if(im){TS.ims.removeMsg(model_ob.id,original_msg)}else if(channel){TS.channels.removeMsg(model_ob.id,original_msg)}else if(mpim){TS.mpims.removeMsg(model_ob.id,original_msg)}else if(group){TS.groups.removeMsg(model_ob.id,original_msg)}},subtype__sh_room_created:function(imsg){if(!TS.boot_data.feature_screenhero&&!TS.boot_data.feature_calls)return;if(!imsg.room)return;TS.dir(441,imsg)},subtype__sh_room_shared:function(imsg){if(!TS.boot_data.feature_screenhero&&!TS.boot_data.feature_calls)return;if(!imsg.room)return;TS.dir(441,imsg)},channel_left:function(imsg){TS.info("You left channel "+imsg.channel);var channel=TS.channels.getChannelById(imsg.channel);if(!channel){TS.error('unknown channel: "'+imsg.channel)}channel.is_member=false;if(TS.model.active_channel_id==imsg.channel&&!channel.was_archived_this_session){if(TS.client)TS.client.activeChannelDisplayGoneAway()}TS.channels.calcUnreadCnts(channel,true);TS.members.invalidateMembersUserCanSeeArrayCaches();TS.channels.left_sig.dispatch(channel)},subtype__channel_leave:function(imsg){var user_id=imsg.user;var member=TS.members.getMemberById(user_id);if(!member){TS.error('unknown member: "'+user_id+'"');return}TS.info(member.name+" left channel "+imsg.channel);var channel=TS.channels.getChannelById(imsg.channel);if(channel){for(var i=0;i<channel.members.length;i++){if(channel.members[i]==member.id){channel.members.splice(i,1);TS.channels.calcActiveMembersForChannel(channel);break}}}TS.members.invalidateMembersUserCanSeeArrayCaches();TS.channels.member_left_sig.dispatch(channel,member)},channel_joined:function(imsg){TS.info("You joined channel "+imsg.channel.name);var channel=TS.channels.upsertChannel(imsg.channel);TS.members.invalidateMembersUserCanSeeArrayCaches();TS.channels.joined_sig.dispatch(channel)},channel_created:function(imsg){if(TS.model.user.is_restricted)return;TS.info("created channel "+imsg.channel.name);var channel=TS.channels.upsertChannel(imsg.channel);TS.channels.created_sig.dispatch(channel)},channel_deleted:function(imsg){var channel=TS.channels.getChannelById(imsg.channel);if(!channel){TS.error('unknown channel: "'+imsg.channel);return}TS.info("deleted channel "+imsg.channel);TS.channels.removeChannel(channel)},channel_archive:function(imsg){var channel=TS.channels.getChannelById(imsg.channel);if(!channel){TS.error('unknown channel: "'+imsg.channel);return}if(channel.is_archived){return}TS.info("archived channel "+imsg.channel);channel.members.length=0;TS.channels.calcActiveMembersForChannel(channel);channel.is_archived=true;if(!TS.model.user.is_restricted){if(channel.is_member){channel.was_archived_this_session=true}}TS.channels.archived_sig.dispatch(channel)},channel_unarchive:function(imsg){var channel=TS.channels.getChannelById(imsg.channel);if(!channel){TS.error('unknown channel: "'+imsg.channel);return}if(!channel.is_archived){return}TS.info("unarchived channel "+imsg.channel);if(channel.was_archived_this_session){var in_background=true;TS.channels.join(channel.name,null,in_background)}channel.is_archived=false;channel.was_archived_this_session=false;TS.channels.unarchived_sig.dispatch(channel)},channel_rename:function(imsg){var channel=TS.channels.getChannelById(imsg.channel.id);if(!channel){TS.error('unknown channel: "'+imsg.channel);return}TS.info("renamed channel "+imsg.channel.id+" to "+imsg.channel.name);TS.channels.channelRenamed(imsg.channel)},subtype__channel_join:function(imsg){var user_id=imsg.user;var member=TS.members.getMemberById(user_id);if(!member){TS.error('unknown member: "'+user_id+'"');return}TS.info(member.name+" joined channel "+imsg.channel);var channel=TS.channels.getChannelById(imsg.channel);var existing_member_id;if(channel){for(var i=0;i<channel.members.length;i++){if(channel.members[i]==member.id){existing_member_id=channel.members[i];break}}}if(!existing_member_id){channel.members.push(member.id);TS.channels.calcActiveMembersForChannel(channel)}if(member.is_self&&imsg.inviter){channel.needs_invited_message=true;channel.inviter=imsg.inviter}TS.members.invalidateMembersUserCanSeeArrayCaches();TS.channels.member_joined_sig.dispatch(channel,member)},channel_marked:function(imsg){if(!TS.client)return;var channel=TS.channels.getChannelById(imsg.channel);if(!channel){TS.error('unknown channel: "'+imsg.channel+'"');return}channel.needs_invited_message=false;delete TS.model.last_reads_set_by_client[channel.id+"_"+imsg.ts];TS.channels.setLastRead(channel,imsg.ts)},subtype__channel_topic:function(imsg){var channel=TS.channels.getChannelById(imsg.channel);if(!channel){TS.error('unknown channel: "'+imsg.channel+'"');return}var user_id=imsg.user;var member=TS.members.getMemberById(user_id);if(!member){TS.error('unknown member: "'+user_id+'"');return}TS.info(member.name+" changed topic for channel "+imsg.channel+" to "+imsg.topic);TS.channels.topicChanged(channel,user_id,imsg.ts,imsg.topic)},subtype__channel_purpose:function(imsg){var channel=TS.channels.getChannelById(imsg.channel);if(!channel){TS.error('unknown channel: "'+imsg.channel+'"');return}var user_id=imsg.user;var member=TS.members.getMemberById(user_id);if(!member){TS.error('unknown member: "'+user_id+'"');return}TS.info(member.name+" changed purpose for channel "+imsg.channel+" to "+imsg.purpose);
TS.channels.purposeChanged(channel,user_id,imsg.ts,imsg.purpose)},channel_history_changed:function(imsg){TS.ms.msg_handlers.channel_history_changed_worker(imsg)},subtype__channel_history_changed:function(imsg){if(TS.boot_data.feature_channel_eventlog_client){TS.warn("feature_channel_eventlog_client=1 so we should never be getting subtype "+imsg.subtype)}TS.ms.msg_handlers.channel_history_changed_worker(imsg)},channel_history_changed_worker:function(imsg){TS.info("channel_history_changed for "+imsg.channel);return _sharedHistoryChangedWorker(imsg,TS.channels)},mpim_joined:function(imsg){var existing_mpim=TS.mpims.getMpimById(imsg.channel.id);if(existing_mpim){return}var mpim=TS.mpims.upsertMpim(imsg.channel);TS.members.invalidateMembersUserCanSeeArrayCaches();TS.mpims.joined_sig.dispatch(mpim);if(TS.client)TS.shared.checkInitialMsgHistory(mpim,TS.mpims)},subtype__mpim_join:function(imsg){var user_id=imsg.user;var member=TS.members.getMemberById(user_id);if(!member){TS.error('unknown member: "'+user_id+'"');return}TS.info(member.name+" joined mpim "+imsg.channel);return},mpim_open:function(imsg){var mpim=TS.mpims.getMpimById(imsg.channel);if(!mpim){TS.error("unknown mpim! "+imsg.channel);return}mpim.is_open=true;if(TS.model.requested_mpim_opens[imsg.channel]){TS.mpims.displayMpim(mpim.id,false,TS.model.requested_mpim_opens[imsg.channel].and_send_txt);delete TS.model.requested_mpim_opens[imsg.channel]}mpim.opened_this_session=true;TS.mpims.opened_sig.dispatch(mpim);if(TS.client)TS.shared.checkInitialMsgHistory(mpim,TS.mpims)},mpim_close:function(imsg){var mpim=TS.mpims.getMpimById(imsg.channel);if(!mpim){TS.error('unknown mpim: "'+imsg.channel+'"');return}mpim.is_open=false;if(TS.model.active_mpim_id==imsg.channel){if(TS.boot_data.feature_convert_mpim_client){var converted_to=imsg.converted_to;if(TS.client&&converted_to&&TS.groups.getGroupById(converted_to)){TS.groups.displayGroup(converted_to)}else if(TS.client){TS.client.activeChannelDisplayGoneAway()}}else{if(TS.client)TS.client.activeChannelDisplayGoneAway()}}TS.mpims.closed_sig.dispatch(mpim)},mpim_marked:function(imsg){if(!TS.client)return;var mpim=TS.mpims.getMpimById(imsg.channel);if(!mpim){TS.error('unknown mpim: "'+imsg.channel+'"');return}mpim.needs_invited_message=false;delete TS.model.last_reads_set_by_client[mpim.id+"_"+imsg.ts];TS.mpims.setLastRead(mpim,imsg.ts)},mpim_history_changed:function(imsg){TS.ms.msg_handlers.mpim_history_changed_worker(imsg)},subtype__mpim_history_changed:function(imsg){if(TS.boot_data.feature_channel_eventlog_client){TS.warn("feature_channel_eventlog_client=1 so we should never be getting subtype "+imsg.subtype)}TS.ms.msg_handlers.mpim_history_changed_worker(imsg)},mpim_history_changed_worker:function(imsg){TS.info("mpim_history_changed for "+imsg.channel);return _sharedHistoryChangedWorker(imsg,TS.mpims)},group_left:function(imsg){TS.info("You left group "+imsg.channel);var group=TS.groups.getGroupById(imsg.channel);if(!group){TS.error('unknown group: "'+imsg.channel);return}TS.groups.removeGroup(group);TS.members.invalidateMembersUserCanSeeArrayCaches();TS.groups.left_sig.dispatch(group)},subtype__group_leave:function(imsg){var user_id=imsg.user;var member=TS.members.getMemberById(user_id);if(!member){TS.error('unknown member: "'+user_id+'"');return}TS.info(member.name+" left group "+imsg.channel);var group=TS.groups.getGroupById(imsg.channel);if(group){for(var i=0;i<group.members.length;i++){if(group.members[i]==member.id){group.members.splice(i,1);TS.groups.calcActiveMembersForGroup(group);break}}}TS.members.invalidateMembersUserCanSeeArrayCaches();TS.groups.member_left_sig.dispatch(group,member)},group_joined:function(imsg){TS.info("You joined group "+imsg.channel.name);if(TS.boot_data.feature_mpim_client&&imsg.channel.is_mpim)return;var existing_group=TS.groups.getGroupById(imsg.channel.name);if(existing_group){TS.error("should not be getting a group_joined message if we already know about the group: "+imsg.channel.name+" "+imsg.channel.id);return}var group=TS.groups.upsertGroup(imsg.channel);TS.members.invalidateMembersUserCanSeeArrayCaches();TS.groups.joined_sig.dispatch(group);if(TS.client)TS.shared.checkInitialMsgHistory(group,TS.groups)},group_deleted:function(imsg){var group=TS.groups.getGroupById(imsg.channel);if(!group){TS.error('unknown group: "'+imsg.channel);return}TS.info("deleted group "+imsg.channel);TS.groups.removeGroup(group)},group_archive:function(imsg){var group=TS.groups.getGroupById(imsg.channel);if(!group){TS.error('unknown group: "'+imsg.channel);return}if(group.is_archived){return}TS.info("archived group "+imsg.channel);group.is_archived=true;if(group.is_open){group.was_archived_this_session=true}TS.groups.archived_sig.dispatch(group)},group_unarchive:function(imsg){var group=TS.groups.getGroupById(imsg.channel);if(!group){TS.error('unknown group: "'+imsg.channel);return}if(!group.is_archived){return}TS.info("unarchived group "+imsg.channel);group.is_archived=false;group.was_archived_this_session=false;TS.groups.unarchived_sig.dispatch(group)},group_rename:function(imsg){var group=TS.groups.getGroupById(imsg.channel.id);if(!group){TS.error('unknown group: "'+imsg.channel.id);return}TS.info("renamed group "+imsg.channel.id+" to "+imsg.channel.name);TS.groups.groupRenamed(imsg.channel)},subtype__group_join:function(imsg){var user_id=imsg.user;var member=TS.members.getMemberById(user_id);if(!member){TS.error('unknown member: "'+user_id+'"');return}if(TS.boot_data.feature_mpim_client&&imsg.is_mpim)return;TS.info(member.name+" joined group "+imsg.channel);var group=TS.groups.getGroupById(imsg.channel);var existing_member_id;if(group){for(var i=0;i<group.members.length;i++){if(group.members[i]==member.id){existing_member_id=group.members[i];break}}}if(!existing_member_id){group.members.push(member.id);TS.groups.calcActiveMembersForGroup(group)}if(member.is_self&&imsg.inviter){group.needs_invited_message=true;group.inviter=imsg.inviter}TS.members.invalidateMembersUserCanSeeArrayCaches();TS.groups.member_joined_sig.dispatch(group,member)},group_open:function(imsg){if(TS.mpims.getMpimById(imsg.channel)){return TS.ms.msg_handlers.mpim_open(imsg)}var group=TS.groups.getGroupById(imsg.channel);if(!group){TS.error("unkown group! "+imsg.channel);return}group.is_open=true;if(TS.model.requested_group_opens[imsg.channel]){TS.groups.displayGroup(group.id,false,TS.model.requested_group_opens[imsg.channel].and_send_txt);delete TS.model.requested_group_opens[imsg.channel]}group.opened_this_session=true;TS.groups.opened_sig.dispatch(group);if(TS.client)TS.shared.checkInitialMsgHistory(group,TS.groups)},group_marked:function(imsg){if(!TS.client)return;if(TS.mpims.getMpimById(imsg.channel)){return TS.ms.msg_handlers.mpim_marked(imsg)}var group=TS.groups.getGroupById(imsg.channel);if(!group){TS.error('unknown group: "'+imsg.channel+'"');return}group.needs_invited_message=false;delete TS.model.last_reads_set_by_client[group.id+"_"+imsg.ts];TS.groups.setLastRead(group,imsg.ts)},group_close:function(imsg){if(TS.mpims.getMpimById(imsg.channel)){if(TS.boot_data.feature_convert_mpim_client)return;return TS.ms.msg_handlers.mpim_close(imsg)}var group=TS.groups.getGroupById(imsg.channel);if(!group){TS.error('unknown group: "'+imsg.channel+'"');return}group.is_open=false;if(TS.model.active_group_id==imsg.channel){if(TS.client)TS.client.activeChannelDisplayGoneAway()}TS.groups.closed_sig.dispatch(group)},subtype__group_topic:function(imsg){var mpim=TS.mpims.getMpimById(imsg.channel);if(TS.boot_data.feature_mpim_client&&mpim)return;var group=TS.groups.getGroupById(imsg.channel);if(!group){TS.error('unknown group: "'+imsg.channel+'"');return}var user_id=imsg.user;var member=TS.members.getMemberById(user_id);if(!member){TS.error('unknown member: "'+user_id+'"');return}TS.info(member.name+" changed topic for group "+imsg.channel+" to "+imsg.topic);TS.groups.topicChanged(group,user_id,imsg.ts,imsg.topic)},subtype__group_purpose:function(imsg){var mpim=TS.mpims.getMpimById(imsg.channel);if(TS.boot_data.feature_mpim_client&&mpim)return;var group=TS.groups.getGroupById(imsg.channel);if(!group){TS.error('unknown group: "'+imsg.channel+'"');return}var user_id=imsg.user;var member=TS.members.getMemberById(user_id);if(!member){TS.error('unknown member: "'+user_id+'"');return}TS.info(member.name+" changed purpose for group "+imsg.channel+" to "+imsg.purpose);TS.groups.purposeChanged(group,user_id,imsg.ts,imsg.purpose)},group_history_changed:function(imsg){TS.ms.msg_handlers.group_history_changed_worker(imsg)},subtype__group_history_changed:function(imsg){if(TS.boot_data.feature_channel_eventlog_client){TS.warn("feature_channel_eventlog_client=1 so we should never be getting subtype "+imsg.subtype)}TS.ms.msg_handlers.group_history_changed_worker(imsg)},group_history_changed_worker:function(imsg){if(imsg.is_mpim)return;TS.info("group_history_changed for "+imsg.channel);return _sharedHistoryChangedWorker(imsg,TS.groups)},im_created:function(imsg){var im=TS.ims.getImById(imsg.channel.id);if(im){TS.warn("we already have an im for this user: "+imsg.user);return}TS.ims.upsertIm(imsg.channel);im=TS.ims.getImById(imsg.channel.id);if(!im){TS.error("WTF why can we not find this im: "+imsg.channel.id);return}TS.members.invalidateMembersUserCanSeeArrayCaches();if(im.is_open){if(TS.model.requested_im_opens[imsg.user]){TS.ims.displayIm(im.id,false,TS.model.requested_im_opens[imsg.user].and_send_txt);delete TS.model.requested_im_opens[imsg.user]}TS.ims.opened_sig.dispatch(im)}im.opened_this_session=true},im_open:function(imsg){var im=TS.ims.getImById(imsg.channel);if(!im){TS.error("unkown im! "+imsg.channel);return}im.is_open=true;if(TS.model.requested_im_opens[imsg.user]){TS.ims.displayIm(im.id,false,TS.model.requested_im_opens[imsg.user].and_send_txt);delete TS.model.requested_im_opens[imsg.user]}im.opened_this_session=true;TS.ims.opened_sig.dispatch(im);if(TS.client)TS.shared.checkInitialMsgHistory(im,TS.ims)},im_marked:function(imsg){if(!TS.client)return;var im=TS.ims.getImById(imsg.channel);if(!im){TS.error('unknown im: "'+imsg.channel+'"');return}delete TS.model.last_reads_set_by_client[im.id+"_"+imsg.ts];TS.ims.setLastRead(im,imsg.ts)},im_close:function(imsg){var im=TS.ims.getImById(imsg.channel);if(!im){TS.error('unknown im: "'+imsg.channel+'"');return}im.is_open=false;if(TS.model.active_im_id==imsg.channel){if(TS.client)TS.client.activeChannelDisplayGoneAway()}TS.ims.closed_sig.dispatch(im)},im_history_changed:function(imsg){TS.ms.msg_handlers.im_history_changed_worker(imsg)},subtype__im_history_changed:function(imsg){if(TS.boot_data.feature_channel_eventlog_client){TS.warn("feature_channel_eventlog_client=1 so we should never be getting subtype "+imsg.subtype)}TS.ms.msg_handlers.im_history_changed_worker(imsg)},im_history_changed_worker:function(imsg){TS.info("im_history_changed for "+imsg.channel);return _sharedHistoryChangedWorker(imsg,TS.ims)},manual_presence_change:function(imsg){var user=TS.model.user;if(imsg.presence!="away"&&imsg.presence!="active"){TS.error('unknown presence: "'+imsg.presence+'"');return}user.manual_presence=imsg.presence;TS.members.presence_changed_sig.dispatch(user)},presence_change:function(imsg){imsg.team=imsg.team||TS.model.team.id;var member=TS.members.getMemberById(imsg.user);if(!member){TS.error('unknown member: "'+imsg.user+'"');return}if(imsg.presence!="away"&&imsg.presence!="active"){TS.error('unknown presence: "'+imsg.presence+'"');return}if(member.presence==imsg.presence)return;if(member.is_self){member._presence_last_changed=new Date}member.presence=imsg.presence;TS.members.presence_changed_sig.dispatch(member)},status_change:function(imsg){var member=TS.members.getMemberById(imsg.user);if(!member){TS.error('unknown member: "'+imsg.user+'"');return}if(member.status==imsg.status)return;member.status=imsg.status;TS.members.status_changed_sig.dispatch(member)},pref_change:function(imsg){TS.prefs.onPrefChanged(imsg)},team_pref_change:function(imsg){TS.prefs.onTeamPrefChanged(imsg)},team_profile_change:function(imsg){TS.team.upsertAndSignal({profile:imsg.profile})},team_profile_reorder:function(imsg){TS.team.upsertAndSignal({profile:imsg.profile})},team_profile_delete:function(imsg){TS.team.upsertAndSignal({profile:imsg.profile})},team_plan_change:function(imsg){TS.team.team_plan_changed_sig.dispatch(imsg)},file_created:function(imsg){if(!_isFileMsgRelevant(imsg))return;var was_file=TS.files.getFileById(imsg.file.id);if(was_file){TS.warn("we already know about this file, which probably means the files.upload response came in before this message (so np) "+imsg.file.id)}else{TS.files.upsertAndSignal(imsg.file)}},file_public:function(imsg){if(!_isFileMsgRelevant(imsg))return;TS.files.upsertAndSignal(imsg.file)},file_deleted:function(imsg){if(!_isFileMsgRelevant(imsg))return;TS.files.removeFile(imsg.file_id)},file_private:function(imsg){if(!_isFileMsgRelevant(imsg))return;TS.files.fetchFileInfo(imsg.file_id)},file_change:function(imsg){if(!_isFileMsgRelevant(imsg))return;TS.files.upsertAndSignal(imsg.file);TS.files.fileWasMaybeRefreshed(imsg.file)},file_shared:function(imsg){if(!_isFileMsgRelevant(imsg))return;TS.files.upsertAndSignal(imsg.file)},file_unshared:function(imsg){if(!_isFileMsgRelevant(imsg))return;TS.files.upsertAndSignal(imsg.file)},file_comment_added:function(imsg){if(!_isFileMsgRelevant(imsg))return;var was_file=TS.files.getFileById(imsg.file.id);if(!was_file){return}if(!TS.files.editCommentOnFile(imsg.comment,was_file)){TS.files.addCommentToFile(imsg.comment,was_file)}TS.files.upsertFile(imsg.file)},file_comment_edited:function(imsg){if(!_isFileMsgRelevant(imsg))return;var was_file=TS.files.getFileById(imsg.file.id);if(!was_file){return}TS.files.editCommentOnFile(imsg.comment,was_file);TS.files.upsertFile(imsg.file)},file_comment_deleted:function(imsg){if(!_isFileMsgRelevant(imsg))return;var was_file=TS.files.getFileById(imsg.file.id);if(!was_file){return}TS.files.deleteCommentOnFile(imsg.comment,was_file);TS.files.upsertFile(imsg.file)},hello:function(imsg){},team_join:function(imsg){var member=imsg.user;TS.info(member.name+" joined the team");TS.members.upsertMember(member);member=TS.members.getMemberById(member.id);if(!member){TS.error("wtf no member "+member.id+"?");return}TS.members.joined_team_sig.dispatch(member);if(TS.client)TS.view.showProperTeamPaneFiller()},user_change:function(imsg){var member=TS.members.getMemberById(imsg.user.id);if(!member){TS.error("wtf no member "+imsg.user.id+"?");return}TS.members.upsertAndSignal(imsg.user)},star_added:function(imsg){if(!imsg.item){TS.error(imsg.type+" has no item");return}if(imsg.user!=TS.model.user.id)return;TS.stars.userStarStatusHasChanged(true,imsg.item,imsg.type);TS.stars.maybeUpdateUserStarredList()},star_removed:function(imsg){if(!imsg.item){TS.error(imsg.type+" has no item");return}if(imsg.user!=TS.model.user.id)return;TS.stars.userStarStatusHasChanged(false,imsg.item,imsg.type);TS.stars.maybeUpdateUserStarredList()},message_actions_changed:function(imsg){if(!TS.boot_data.feature_attachment_actions)return;TS.msg_card.card_changed_sig.dispatch({actions:imsg.actions,attachment_id:imsg.attachment_id,channel_id:imsg.channel_id,msg_ts:imsg.msg_ts})},reaction_added:function(imsg){if(!imsg.item){TS.error(imsg.type+" has no item");return}TS.rxns.changeRxnsFromIMsg(imsg)},reaction_removed:function(imsg){if(!imsg.item){TS.error(imsg.type+" has no item");return}TS.rxns.changeRxnsFromIMsg(imsg)},email_domain_changed:function(imsg){TS.team.upsertAndSignal({email_domain:imsg.email_domain});if(TS.client)TS.view.showProperTeamPaneFiller()},team_domain_change:function(imsg){TS.team.upsertAndSignal({domain:imsg.domain});TS.model.last_team_domain=TS.model.team.domain;TSSSB.call("setCurrentTeam",TS.model.team.domain)},slack_broadcast:function(imsg){var onGo=null;var title=imsg.title||"Broadcast message";var body=imsg.body||"";var body_plus="";var go_button_text=imsg.button||(imsg.reload?"Reload":"OK");var do_reload=false;if(!!imsg.reload){if(!!imsg.force_reload){TS.info("reloading because imsg.force_reload");do_reload=true}else if(!TS.boot_data.version_ts){TS.info("reloading because we dont have an version_ts");do_reload=true}else if(imsg.version_ts=="dev"){TS.info("reloading because dev");do_reload=true}else if(parseInt(TS.boot_data.version_ts)<parseInt(imsg.version_ts)){TS.info("reloading because "+TS.boot_data.version_ts+" < "+imsg.version_ts);do_reload=true}if(!do_reload)return;onGo=function(){if(TS.client)TS.reload()}}if(do_reload){var secs=TS.utility.randomInt(10,20);body_plus='<p class="top_margin">(You will be auto reloaded in <span id="auto_secs">'+secs+"</span> seconds.)</p>";setTimeout(function(){if(TS.client)TS.reload()},secs*1e3);setInterval(function(){secs--;if(secs<1)return;$("#auto_secs").text(secs)},1e3)}TS.generic_dialog.start({title:TS.format.formatNoHighlightsNoSpecials(title),body:TS.format.formatNoHighlightsNoSpecials(body)+body_plus,go_button_text:go_button_text,show_cancel_button:false,esc_for_ok:true,onGo:onGo})},team_rename:function(imsg){$("#team_name").text(imsg.name);document.title=document.title.replace(TS.model.last_team_name,imsg.name);if(TS.ui.growls.original_document_title){TS.ui.growls.original_document_title=TS.ui.growls.original_document_title.replace(TS.model.last_team_name,imsg.name)}TS.model.last_team_name=TS.model.team.name=imsg.name;TS.team.team_name_changed_sig.dispatch(TS.model.team)},team_icon_change:function(imsg){if(!imsg.icon)return;TS.model.team.icon=imsg.icon;if(TS.client)TS.client.updateTeamIcon()},bot_added:function(imsg){var bot=imsg.bot;TS.info(bot.name+" was added");TS.bots.upsertBot(bot);bot=TS.bots.getBotById(bot.id);if(!bot){TS.error("wtf no bot "+bot.id+"?");return}TS.bots.added_sig.dispatch(bot)},bot_changed:function(imsg){var bot=TS.bots.getBotById(imsg.bot.id);if(!bot){TS.error("wtf no bot "+imsg.bot.id+"?");return}TS.bots.upsertAndSignal(imsg.bot)},bot_removed:function(imsg){var bot=TS.bots.getBotById(imsg.bot.id);if(!bot){TS.error("wtf no bot "+imsg.bot.id+"?");return}TS.bots.upsertAndSignal(imsg.bot)},error:function(imsg){},user_typing:function(imsg){if(!TS.typing)return;var member=TS.members.getMemberById(imsg.user);if(!member){TS.error("unknown imsg.user:"+imsg.user);return}var model_ob=TS.shared.getModelObById(imsg.channel);if(!model_ob){TS.error("unknown imsg.channel:"+imsg.channel);return}TS.typing.memberStarted(model_ob,member)},issue_change:function(imsg){TS.help.onIssueChange(imsg.issue)},emoji_changed:function(imsg){if(imsg.event_ts)TS.model.emoji_cache_ts=imsg.event_ts;TS.emoji.resetUpEmoji()},play_sound:function(imsg){if(TS.model.prefs.autoplay_chat_sounds)TS.sounds.play(imsg.sound+".mp3")},commands_changed:function(imsg){if(imsg.event_ts)TS.model.commands_cache_ts=imsg.event_ts;TS.cmd_handlers.resetUpCmds()},accounts_changed:function(){setTimeout(TS.refreshTeams,1e3)},pin_added:function(imsg){var model_ob=TS.shared.getModelObById(imsg.channel_id);if(model_ob){TS.pins.pinStatusHasChanged(true,imsg.item,imsg.item.type,model_ob);model_ob.has_pins=true}},pin_removed:function(imsg){var model_ob=TS.shared.getModelObById(imsg.channel_id);if(model_ob){TS.pins.pinStatusHasChanged(false,imsg.item,imsg.item.type,model_ob);if(imsg.has_pins===false)model_ob.has_pins=false}},sh_room_join:function(imsg){if(!TS.boot_data.feature_screenhero&&!TS.boot_data.feature_calls)return;TS.dir(441,imsg);TS.rooms.upsertAndSignal(imsg.room)},sh_room_leave:function(imsg){if(!TS.boot_data.feature_screenhero&&!TS.boot_data.feature_calls)return;TS.dir(441,imsg);TS.rooms.upsertAndSignal(imsg.room)},sh_room_update:function(imsg){if(!TS.boot_data.feature_screenhero&&!TS.boot_data.feature_calls)return;TS.dir(441,imsg);TS.rooms.upsertAndSignal(imsg.room)},subteam_updated:function(imsg){if(!TS.boot_data.feature_subteams)return;TS.user_groups.upsertUserGroupAndSignal(imsg.subteam);TS.user_groups.getUserGroupMembers(imsg.subteam.id)},subteam_created:function(imsg){if(!TS.boot_data.feature_subteams)return;TS.user_groups.upsertUserGroupAndSignal(imsg.subteam)},subteam_deleted:function(imsg){if(!TS.boot_data.feature_subteams)return;TS.user_groups.removeUserGroupAndSignal(imsg.subteam)},subteam_self_added:function(imsg){if(!TS.boot_data.feature_subteams)return;TS.user_groups.upsertSelfUserGroup(imsg.subteam_id)},subteam_self_removed:function(imsg){if(!TS.boot_data.feature_subteams)return;TS.user_groups.removeSelfUserGroup(imsg.subteam_id)},apps_changed:function(imsg){if(imsg.event_ts)TS.model.apps_cache_ts=imsg.event_ts;TS.apps.resetUpApps()},dnd_override:function(imsg){TS.dnd.dndOverride(imsg.channel,imsg.timestamp)},dnd_updated:function(imsg){TS.dnd.updateUserPropsAndSignal(imsg.user,imsg.dnd_status)},dnd_updated_user:function(imsg){TS.dnd.updateUserPropsAndSignal(imsg.user,imsg.dnd_status)},reconnect_url:function(imsg){if(!TS.boot_data.feature_client_fast_reconnect)return;var url=imsg.url;TS.ms.setReconnectUrl(url)}});var _isFileMsgRelevant=function(file_msg){if(!TS.web)return true;if(file_msg.file&&TS.web.space&&!TS.web.space.isFileRelevant(file_msg.file.id))return false;if(file_msg.file_id&&TS.web.space&&!TS.web.space.isFileRelevant(file_msg.file_id))return false;return true};var _Q=[];var _q_grew_from_event_log=false;var _addToQ=function(imsg){if(imsg._from_evt_log)_q_grew_from_event_log=true;_Q.push(imsg);if(_Q.length==1){_nextFromQ()}else{TS.log(2,imsg.type+" is Qed and not being handled immediately _Q.length:"+_Q.length);if(_q_grew_from_event_log){if(_Q.length>100){}}else if(_Q.length>10){}}};var _nextFromQ=function(){if(!_Q.length)return;var imsg=_Q[0];TS.log(2,imsg.type+" is now being handled");var full_type="type:"+imsg.type+(imsg.subtype?" subtype:"+imsg.subtype:"");var c_ids=TS.utility.extractAllModelObIds(imsg,full_type);var m_ids=TS.utility.extractAllMemberIds(imsg,full_type);var missing_c_ids=TS.shared.getModelObIdsNotPresent(c_ids);var missing_m_ids=TS.members.getMemberIdsNotPresent(m_ids.m_ids,m_ids.c_ids,m_ids.t_ids);var ensureModelObs=function(){return TS.shared.ensureModelObsArePresent(missing_c_ids).then(function(){return ensureMembers()},function(err){if(imsg.channel&&typeof imsg.channel=="string"&&!TS.shared.getModelObById(imsg.channel)){TS.error(full_type+" could not be handled because imsg.channel could not be fetched. full err: "+err.message);TS.dir(0,imsg,"errored imsg: "+JSON.stringify(imsg));return _afterMsgHandled()}else{TS.warn(full_type+" held some references to model_obs we could not fetch, but we have imsg.channel (or there was no imsg.channel) so we can still proceed");TS.dir(0,imsg,"warned imsg: "+JSON.stringify(imsg));if(missing_m_ids.m_ids.length){return ensureMembers()}return proceedWithImsg()}})};var ensureMembers=function(){return TS.members.ensureMembersArePresent(missing_m_ids.m_ids,missing_m_ids.c_ids,missing_m_ids.t_ids).then(function(){return proceedWithImsg()},function(err){if(imsg.user&&typeof imsg.user=="string"&&!TS.members.getMemberById(imsg.user)||imsg.channel&&typeof imsg.channel=="object"&&imsg.channel.user&&typeof imsg.channel.user=="string"&&!TS.members.getMemberById(imsg.channel.user)){TS.error(full_type+" could not be handled because imsg.user or imsg.channel.user could not be fetched. full err: "+err.message);TS.dir(0,imsg,"errored imsg");return _afterMsgHandled()}else{TS.warn(full_type+" held some references to members we could not fetch, but we have imsg.user and imsg.channel.user (or they did not exist) so we can still proceed");TS.dir(0,imsg,"warned imsg: "+JSON.stringify(imsg));return proceedWithImsg()}})};var proceedWithImsg=function(){try{_handleMsg(imsg)}catch(err){TS.error(full_type+" errored out when being handled, with err: "+err.message)}return _afterMsgHandled()};if(missing_c_ids.length){ensureModelObs()}else if(missing_m_ids.m_ids.length){ensureMembers()}else if(TS.boot_data.feature_ms_events_always_use_promises){Promise.resolve().then(function(){return proceedWithImsg()})}else{proceedWithImsg()}};var _afterMsgHandled=function(){if(!_Q.length)return Promise.resolve();_Q.shift();if(!_Q.length)_q_grew_from_event_log=false;_nextFromQ();return Promise.resolve()};var _handleMsg=function(imsg){TS.ms.msg_handlers[imsg.type](imsg);if(TS.client&&TS.model.is_our_app){TS.dir(236,imsg,"calling TS.client.windows.distributeMsgToWins");TS.client.windows.distributeMsgToWins(imsg)}};var _sharedHistoryChangedWorker=function(imsg,controller){var model_ob=TS.shared.getModelObById(imsg.channel);if(!model_ob){TS.error('unknown model_ob: "'+imsg.channel+'"');return}model_ob.history_changed=true;controller.fetchHistory(model_ob,{channel:model_ob.id,latest:imsg.latest,inclusive:true,count:TS.utility.clamp(model_ob.msgs.length,TS.model.initial_msgs_cnt,1e3)},function(ok,data,args){if(!ok){TS.error("could not retrieve history for "+model_ob.id)}else{TS.info("_history_changed: dumping old messages for "+model_ob.id);model_ob.is_limited=false;TS.utility.msgs.resetOldestMsgsTs(model_ob);TS.warn("imsg.latest: "+imsg.latest);for(var i=model_ob.msgs.length-1;i>-1;i--){var msg=model_ob.msgs[i];if(msg.ts<imsg.latest)continue;data.messages.unshift(msg)}model_ob.msgs.length=0}controller.onHistory(ok,data,args);delete model_ob.history_changed})}})();(function(){"use strict";TS.registerModule("ds",{last_pong_time:0,sent_map:{},connected_sig:new signals.Signal,disconnected_sig:new signals.Signal,trouble_sig:new signals.Signal,reconnecting_sig:new signals.Signal,pong_sig:new signals.Signal,on_msg_sig:new signals.Signal,reconnect_requested_sig:new signals.Signal,onStart:function(){_setPongTimeoutMs(TS.model.ui.is_window_focused||false);TS.ui.window_focus_changed_sig.add(_setPongTimeoutMs);setInterval(function(){if(!TS.model.ds_connected)return;if(TS.model.rtd_start_throttler<1)return;TS.model.rtd_start_throttler--},1e3*60)},send:function(msg,handler,temp_ts){msg.id=++_msg_id;TS.ds.sent_map[msg.id.toString()]={msg:msg,handler:handler,ts:Date.now(),temp_ts:temp_ts};if(msg.type=="ping"||msg.type=="pong"){TS.log(3,"DS TS.ds ping -->\n"+JSON.stringify(msg,null,"  "))}else{TS.model.last_net_send=Date.now();TS.log(2,"TS.ds -->\n"+JSON.stringify(msg,null,"  "))}if(_websocket&&TS.model.ds_connected){_websocket.send(JSON.stringify(msg))}else{TS.ds.Q.push(msg)}return msg.id},Q:[],sendTyping:function(c_id){var msg_str='{"type":"typing", "channel":"'+c_id+'"}';_websocket.send(msg_str)},handleMsg:function(imsg){var is_reconnect_reply=imsg.reply_to&&!("ok"in imsg)&&imsg.type=="message";if(is_reconnect_reply){}var sent;if(imsg.reply_to){if(imsg.reply_to.toString()in TS.ds.sent_map){sent=TS.ds.sent_map[imsg.reply_to];imsg.SENT_MSG=sent.msg;delete TS.ds.sent_map[imsg.reply_to]}else{if(!is_reconnect_reply){TS.error('received msg "'+imsg.reply_to+'" with type "'+imsg.type+'" but we have no record of it in sent_map')}}}if(imsg.type=="ping"||imsg.type=="pong"){TS.log(3,"DS msg "+imsg.type+" time: "+(Date.now()-sent.ts)+"ms");TS.log(3,"DS TS.ds ping <--\n"+JSON.stringify(imsg,null,"  "));TS.ds.last_pong_time=Date.now();TS.ds.pong_sig.dispatch();_check_last_pong_time=false}else{if(sent){var type=imsg.type?imsg.type:imsg.SENT_MSG.type?imsg.SENT_MSG.type:"";TS.log(2,"msg "+(type?'"'+type+'" ':"")+"rsp time "+(Date.now()-sent.ts)+"ms")}else{}TS.log(2,"TS.ds <-- \n"+JSON.stringify(imsg,null," "))}if(imsg.type=="error"){_onErrorMsg(imsg)}else if(!imsg.reply_to){TS.ds.on_msg_sig.dispatch(imsg);if(imsg.type=="hello"){_onHello(imsg)}}if(sent){if(!imsg.ok){imsg.error=imsg.error||{code:0,msg:"unknown error (not specified by MS)"}}if(is_reconnect_reply){imsg.ok=true}if(sent.handler){sent.handler(imsg.ok,imsg)}}},onFailure:function(reason_str){if(reason_str)_reportDisconnect("You got disconnected and are on team Tiny Speck, so here are some details:\n>>>"+reason_str);_check_last_pong_time=false;_deprecateCurrentSocket();if(TS.model.ds_connected){TS.info("Disconnected from DS, TS.model.rtd_start_throttler:"+TS.model.rtd_start_throttler);TS.ds.logConnectionFlow("on_connected_failure");TS.model.ds_reconnect_ms=100;TS.ds.disconnect()}else{TS.ds.logConnectionFlow("on_notconnected_failure");var ms=TS.model.ds_reconnect_ms=(TS.model.ds_reconnect_ms+1e3)*1.3;if(TS.model.ds_reconnect_ms>4e3){TS.model.ds_reconnect_ms=TS.utility.randomInt(ms,ms+ms/3)}TS.model.ds_reconnect_ms=Math.min(TS.model.ds_reconnect_ms,3e5)}if(TS.model.rtd_start_throttler>5){var min_ms=2e3*TS.model.rtd_start_throttler;if(TS.model.ds_reconnect_ms<min_ms){TS.info("because TS.model.rtd_start_throttler:"+TS.model.rtd_start_throttler+" we are increasing time until next login call");TS.model.ds_reconnect_ms=min_ms}}if(TS.model.ds_connected){TS.model.ds_connected=false;TS.ds.disconnected_sig.dispatch()}TS.model.ds_connected=false;clearInterval(_send_ping_interv);clearInterval(_check_ping_interv);if(TS.model.ds_asleep){TS.warn("NOT doing startReconnection(), we are asleep");return}TS.ds.startReconnection()},startReconnection:function(){TS.model.ds_reconnect_time=Date.now()+TS.model.ds_reconnect_ms;TS.info("Attempting to reconnect in "+TS.model.ds_reconnect_ms+"ms");clearInterval(_reconnect_interv);_reconnect_interv=setInterval(_onReconnectInterval,_reconnect_interv_ms);_onReconnectInterval();clearTimeout(_auto_reconnect_tim);_auto_reconnect_tim=setTimeout(function(){if(!TS.model.window_unloading){TS.ds.reconnect_requested_sig.dispatch()}},TS.model.ds_reconnect_ms)},manualReconnectNow:function(){TS.ds.logConnectionFlow("manual_reconnect");clearTimeout(_auto_reconnect_tim);clearInterval(_reconnect_interv);clearTimeout(_connect_timeout_tim);_connect_timeout_count=0;if(!TS.model.window_unloading){TS.ds.reconnect_requested_sig.dispatch();TS.ds.reconnecting_sig.dispatch(0)}},disconnect:function(){if(_websocket&&TS.model.ds_connected){TS.ds.logConnectionFlow("disconnect");_websocket.close()}else{TS.warn("TS.ds.disconnect called, but _websocket="+_websocket+" TS.model.ds_connected="+TS.model.ds_connected)}},logConnectionFlow:function(name){var ds_conn_log=TS.model.ds_conn_log;var time=Date.now();ds_conn_log.push({name:name,time:time,delta:ds_conn_log.length?time-ds_conn_log[ds_conn_log.length-1].time:0});TS.log(2,"logConnectionFlow "+name+" "+ds_conn_log[ds_conn_log.length-1].delta)},getConnectionFlowLog:function(){var ds_conn_log=TS.model.ds_conn_log;var args=[];for(var i=0;i<ds_conn_log.length;i++){args.push(encodeURIComponent(ds_conn_log[i].name+"-"+(ds_conn_log[i].delta?Math.round(ds_conn_log[i].delta/1e3):0)+"-"+Math.round(ds_conn_log[i].time/1e3)))}TS.dir(2,TS.model.ds_conn_log);var log=args.join("&");return log},connect:function(){TSConnLogger.log("ds_connecting","TS.ds.connect "+TS.web.space.login_data.ws);if(!window.WebSocket){window.WebSocket=window.MozWebSocket}if(window.WebSocket){var url;try{TS.ds.logConnectionFlow("connect");url=TS.web.space.login_data.ws;var special_str=TS.qs_args["simulate_old_token"]==1?"&TRIGGER_OLD_TOKEN=1":"";url+="?version_uid="+TS.boot_data.version_uid+special_str;url=TS.utility.appendLogToUrlWithLimit(url,TS.ds.getConnectionFlowLog());TS.info("Connecting to: "+url);if(TS.qs_args["simulate_first_connect_failure"]==1&&!window.already_simulated_first_connect_failure){url=url.replace("e","w");TS.info("simulate_first_connect_failure url:"+url);window.already_simulated_first_connect_failure=true}_connect_timeout_tim_ms=window.WEB_SOCKET_USING_FLASH?_connect_flash_timeout_tim_ms:_connect_ws_timeout_tim_ms;clearTimeout(_connect_timeout_tim);_connect_timeout_tim=setTimeout(_onConnectTimeout,_connect_timeout_tim_ms);TS.ds.last_url=url;TS.ds.last_start_ms=Date.now();_deprecateCurrentSocket();_websocket=new WebSocket(url)}catch(error){TS.warn("failed to create new WebSocket");TS.error(error);TS.ds.onFailure("failed to create new WebSocket");return}TS.model.ds_connecting=true;if(TS.qs_args["simulate_first_connect_timeout"]==1&&_connect_timeout_count<1){TS.info("simulate_first_connect_timeout url:"+url)}else{_websocket.onopen=_onConnect}_websocket.onclose=_onDisconnect;_websocket.onerror=_onError}else{alert("Your browser does not support Web Sockets.")}},sleep:function(){if(TS.model.ds_asleep)return;if(!TS.model.ds_connected)return;
TS.model.ds_asleep=true;TS.ds.disconnect()},wake:function(){if(!TS.model.ds_asleep)return;TS.model.ds_asleep=false;TS.ds.startReconnection()}});var _check_ping_interv=0;var _check_ping_interv_ms=3e3;var _send_ping_interv=0;var _send_ping_interv_ms=1e4;var _connect_timeout_tim=0;var _connect_timeout_tim_ms=0;var _connect_ws_timeout_tim_ms=1e4;var _connect_flash_timeout_tim_ms=2e4;var _hello_timeout_tim=0;var _hello_timeout_tim_ms=1e4;var _disconnect_timeout_tim=0;var _disconnect_timeout_tim_ms=5e3;var _reconnect_interv=0;var _reconnect_interv_ms=1e3;var _auto_reconnect_tim=0;var _websocket=null;var _msg_id=0;var _check_last_pong_time=false;var _pong_timeout_ms=0;var _connect_timeout_count=0;var _setPongTimeoutMs=function(has_focus){if(has_focus){_pong_timeout_ms=1e4}else{_pong_timeout_ms=6e4}_pong_timeout_ms+=_send_ping_interv_ms;TS.log(3,"DS _pong_timeout_ms set to:"+_pong_timeout_ms+" has_focus:"+has_focus)};var _onMsg=function(e){var imsg=JSON.parse(e.data);TS.ds.handleMsg(imsg)};var _onConnect=function(e){clearTimeout(_connect_timeout_tim);_connect_timeout_count=0;if(TS.qs_args["simulate_hello_timeout"]==1&&!window.already_simulated_hello_timeout){TS.info("simulate_hello_timeout");window.already_simulated_hello_timeout=true}else{_websocket.onmessage=_onMsg}TS.model.ds_conn_log.length=0;TSConnLogger.log("ds_connected","_onConnect (took "+(Date.now()-TS.ds.last_start_ms)+"ms)");TS.info("DS WS connected!");TS.ds.logConnectionFlow("on_connect");clearTimeout(_hello_timeout_tim);_hello_timeout_tim=setTimeout(_onHelloTimeout,_hello_timeout_tim_ms)};var _checkPings=function(){if(!_check_last_pong_time)return;var since_last_pong_ms=Date.now()-TS.ds.last_pong_time;TS.log(3,"DS MS since_last_pong_ms:"+since_last_pong_ms+" pong_timeout_ms:"+_pong_timeout_ms);if(since_last_pong_ms<_pong_timeout_ms)return;TS.warn("since_last_pong_ms too long! "+since_last_pong_ms+" > "+_pong_timeout_ms);TS.warn("calling disconnect(), expect to get an onDisconnect() callback");TS.ds.logConnectionFlow("on_ping_timeout");TS.ds.trouble_sig.dispatch();_check_last_pong_time=false;_reportDisconnect("You are on team Tiny Speck, so here are some pong details:\n>>>"+"since_last_pong_ms too long! "+since_last_pong_ms+" > "+_pong_timeout_ms+" ... calling disconnect(), expect to get an onDisconnect() callback");try{TS.ds.disconnect();clearTimeout(_disconnect_timeout_tim);_disconnect_timeout_tim=setTimeout(function(){TS.info("called disconnect, no onDisconnect callback happened in "+_disconnect_timeout_tim_ms+"ms, so calling _onDisconnect() manually now");_onDisconnect(null,"since_last_pong_ms too long! then called disconnect, but no onDisconnect callback happened in "+_disconnect_timeout_tim_ms+"ms, so calling _onDisconnect() manually now")},_disconnect_timeout_tim_ms)}catch(err){TS.info("since_last_pong_ms too long! then an error calling disconnect, going to assume it is because it is already closed, calling _onDisconnect() manually now");TS.warn(err);_onDisconnect(null,"error calling disconnect, going to assume it is because it is already closed, calling _onDisconnect() manually now")}};var _sendPing=function(){TS.ds.send({type:"ping"});_check_last_pong_time=true};var _onDisconnect=function(e,reason_str){reason_str=reason_str||"_onDisconnect called with event:"+e;TS.info("DS WS disconnected");TS.ds.logConnectionFlow("on_disconnect");clearTimeout(_disconnect_timeout_tim);clearTimeout(_hello_timeout_tim);clearTimeout(_connect_timeout_tim);if(e){TS.info("_onDisconnect event.code:"+e.code);if(e.code=="1006"&&false){TS.generic_dialog.start({title:"Connection trouble error #1006",body:"Apologies, we're having some trouble with your connection. The particular error code indicates that restarting the application might fix it.",show_cancel_button:false,show_go_button:true,go_button_text:"OK",esc_for_ok:true})}}else{TS.info("no event")}TS.ds.onFailure(reason_str)};var _reportDisconnect=function(reason_str){TS.warn("_reportDisconnect reason_str:"+reason_str)};var _deprecateCurrentSocket=function(){if(!_websocket)return;_websocket.onmessage=null;_websocket.onopen=null;_websocket.onerror=null;_websocket.onclose=null;try{_websocket.close()}catch(err){}if(false){var old_socket=_websocket;_websocket.onclose=function(e){TS.ds.logConnectionFlow("old_socket_closed");if(!TS.model.ds_connected&&!TS.model.ds_connecting){TS.warn("Our last socket just fired a close event, and we are not yet connected or connecting again, so let us jump start the connection process with manualReconnectNow()");TS.ds.manualReconnectNow()}old_socket.onclose=null}}};var _onReconnectInterval=function(){var ms=TS.model.ds_reconnect_time-Date.now();var secs=Math.round(ms/1e3);if(secs>=0){TS.ds.reconnecting_sig.dispatch(secs)}if(TS.model.window_unloading){clearInterval(_reconnect_interv)}};var _onHelloTimeout=function(){var desc="socket received no hello msg "+_hello_timeout_tim_ms+"ms after connection";TS.warn(desc);TS.ds.logConnectionFlow("_onHelloTimeout");TS.ds.onFailure(desc)};var _onConnectTimeout=function(){_connect_timeout_count++;var desc="socket not connected "+_connect_timeout_tim_ms+"ms after creation. _connect_timeout_count:"+_connect_timeout_count;TS.warn(desc);TS.ds.logConnectionFlow("_onConnectTimeout");if(_connect_timeout_count==3){TS.generic_dialog.start({title:"Connection trouble",body:"<p>Apologies, we're having some trouble with your web socket connection.</p>				<p>We've seen this problem clear up with a restart of "+(TS.model.is_our_app?"Slack":"your browser")+", 				a solution which we suggest to you now only with great regret and self-loathing.</p>				",show_cancel_button:false,go_button_text:"OK",esc_for_ok:true});return}else if(_connect_timeout_count==2){if(window.WEB_SOCKET_USING_FLASH){}else if(TS.model.is_chrome&&!TS.model.is_our_app){window.fallBackToFlashWebSockets();setTimeout(function(){if(window.WEB_SOCKET_USING_FLASH_BUT_NO_FLASH||!document.getElementById("webSocketFlash")||!document.getElementById("webSocketFlash").receiveEvents){TS.generic_dialog.start({title:"Connection trouble",body:"<p>Apologies, we're having some trouble with your web socket connection. 							We tried falling back to Flash, but it appears you do not have a version of Flash installed that we can use.</p>							<p>But we've seen this problem clear up with a restart of "+(TS.model.is_our_app?"Slack":"your browser")+", 							a solution which we suggest to you now only with great regret and self-loathing.</p>							",show_cancel_button:false,go_button_text:"OK",esc_for_ok:true})}else{TS.ms.onFailure("3secs passed, waiting on Flash, no connection")}},3e3);return}}TS.ds.onFailure(desc)};var _onError=function(e){var err_str="";if(e){if(e.name)err_str+=" e.name="+e.name;if(e.message)err_str+=" e.message="+e.message;if(e.data)err_str+=" e.data="+e.data}TS.warn("_onError err_str: "+err_str);TS.dir(0,e)};var _onErrorMsg=function(imsg){if(imsg.error){if(imsg.error.code==1){TS.ds.logConnectionFlow("msg_error_code_1")}else{TS.logError({message:JSON.stringify(imsg)},"_onErrorMsg");TS.ds.onFailure("_onErrorMsg imsg.error:"+imsg.error)}}else{TS.logError({message:imsg?JSON.stringify(imsg):"no imsg?"},"_onErrorMsg")}};var _onHello=function(){clearTimeout(_hello_timeout_tim);TSConnLogger.log("ds_hello","_onHello (took "+(Date.now()-TS.ds.last_start_ms)+"ms)");var since_last_pong_ms=Date.now()-TS.ds.last_pong_time;TS.info("Hello msg recvd, since_last_pong_ms:"+since_last_pong_ms);TS.ds.logConnectionFlow("on_hello");clearInterval(_reconnect_interv);_check_last_pong_time=true;TS.ds.last_pong_time=Date.now();clearInterval(_check_ping_interv);_check_ping_interv=setInterval(_checkPings,_check_ping_interv_ms);clearInterval(_send_ping_interv);_send_ping_interv=setInterval(_sendPing,_send_ping_interv_ms);TS.model.ds_connecting=false;TS.model.ds_connected=true;var msg;for(var i=0;i<TS.ds.Q.length;i++){msg=TS.ds.Q.shift();TS.log(2,"TS.ds (Q) -->\n"+JSON.stringify(msg,null,"  "));_websocket.send(JSON.stringify(msg))}TS.ds.connected_sig.dispatch();_sendPing()}})();(function(){"use strict";TS.registerModule("templates",{onStart:function(){_load();if(TS.members){TS.members.user_color_changed_sig.add(TS.templates.memberUserColorChanged,TS.templates)}if(TS.prefs){TS.prefs.sidebar_behavior_changed_sig.add(TS.templates.sidebarBehaviorPrefChanged,TS.templates)}TS.ui.retina_changed_sig.add(_redrawRetinaAssets)},makeUnreadMessagesDomId:function(item){return TS.utility.makeSafeForDomId("activity_unread_messages_"+item.id)},makeRxnKeyDomId:function(rxn_key){return TS.utility.makeSafeForDomId("rxns_key_"+rxn_key)},makeUnreadGroupMessagesDomId:function(item){return TS.utility.makeSafeForDomId("activity_unread_group_messages_"+item.id)},makeUnreadDmsDomId:function(item){return TS.utility.makeSafeForDomId("activity_unread_dms_"+item.id)},makeSentMessagesDomId:function(item){return TS.utility.makeSafeForDomId("activity_sent_messages_"+item.id)},makeSentGroupMessagesDomId:function(item){return TS.utility.makeSafeForDomId("activity_sent_group_messages_"+item.id)},makeIssueListDomId:function(id){return"issue_list_"+id},makeSentDmsDomId:function(item){return TS.utility.makeSafeForDomId("activity_sent_dms_"+item.id)},makeMsgDomId:function(ts){return TS.utility.makeSafeForDomId("msg_"+ts)},makeMsgLabelDomId:function(ts){return TS.utility.makeSafeForDomId("msg_"+ts+"_label")},makeMsgAttachmentTextExpanderDomId:function(ts,index){return TS.utility.makeSafeForDomId("msg_rest_text_expander_"+ts+"_"+index)},makeMSRDomId:function(match){return TS.utility.makeSafeForDomId("MSR_"+match.channel.id+"_"+match.ts)},makeSHRoomClass:function(room_id){return TS.utility.makeSafeForDomId("screenhero_room_"+room_id)},makeChannelDomId:function(channel){return"channel_"+channel.id},makeDayDividerDomId:function(ts){return TS.utility.makeSafeForDomId("day_divider_"+ts)},makeGroupDomId:function(group){return"group_"+group.id},makeHotnessIconDomId:function(model_ob){return"hotness_"+model_ob.id},makeHotnessIconDomClasses:function(model_ob){var hotness_class="";if(TS.model.prefs.hotness){if(model_ob._hotness>0)hotness_class="warm";if(model_ob._hotness>2)hotness_class="warmer";if(model_ob._hotness>4)hotness_class="hot";if(model_ob._hotness>6)hotness_class="hotter";if(model_ob._hotness>8)hotness_class="hottest"}else{hotness_class="hidden"}return"hotness_icon "+hotness_class},makeMemberDomId:function(member){if(!member)return;return TS.templates.makeMemberDomIdById(member.id)},makeMemberDomIdById:function(id){if(!id)return;return"member_"+id},makeMpimDomId:function(mpim){return"mpim_"+mpim.id},makeChannelListDomId:function(channel){return"channel_"+channel.id+"_member_list"},makeFileDomId:function(file){return"file_"+file.id},makeFileCommentsDomId:function(file){return"file_comments_"+file.id},makeFileContentsDomId:function(file){return"file_contents_"+file.id},makeUnreadJustDomId:function(parent){return"unread_just_"+parent.id},makeUnreadHighlightDomId:function(parent){if(!parent)return;return"unread_highlight_"+parent.id},makeMemberPresenceDomClass:function(member_id){return"member_presence_"+member_id},makeMemberPresenceStateClass:function(member){var presence=member.presence;if(TS.members.isMemberInDnd(member))presence+=" dnd";return presence},makeMemberPresenceIcon:function(member){var presence_class=TS.templates.makeMemberPresenceDomClass(member.id);var presence_icon_class="ts_icon_presence";if(member.is_ultra_restricted){presence_class+=" ura";presence_icon_class="ts_icon_presence_ura"}else if(member.is_restricted){presence_class+=" ra";presence_icon_class="ts_icon_presence_ra"}else if(member.is_slackbot){presence_icon_class="ts_icon_heart"}var presence_icon='<i class="ts_icon '+presence_icon_class+' presence_icon"></i>';var presence=TS.templates.makeMemberPresenceStateClass(member);var html='<span data-member-presence="'+member.id+'" class="presence '+presence+" "+presence_class+'" title="'+member.presence+'">'+presence_icon+"</span>";return html},makeMemberStatusDomClass:function(member_id){return"member_status_"+member_id},memberUserColorChanged:function(member){var cls="color_"+member.id;if(member.color==member.member_color){var style_id="color_rule_"+cls;var $style=$("#"+style_id);$style.remove();return}TS.templates.makeUserColorRule(member)},makeUserColorRule:function(member){var cls="color_"+member.id;var color="#"+TS.utility.htmlEntities(member.member_color);var rule;if(TS.client){rule="				."+cls+":not(.nuc), 				#col_channels ul li:not(.active):not(.away) > ."+cls+":not(.nuc), 				#col_channels:not(.show_presence) ul li > ."+cls+":not(.nuc) {					color:"+color+";				}				"}else{rule="			."+cls+":not(.nuc) {				color:"+color+";			}			"}var style_id="color_rule_"+cls;var $style=$("#"+style_id);if($style.length){$style.text(rule)}else{$('<style type="text/css" id="'+style_id+'">'+rule+"</style>").appendTo("body")}},sidebarBehaviorPrefChanged:function(){TS.templates.makeSidebarBehaviorRule()},makeSidebarBehaviorRule:function(){var rule;var style_id="sidebar_behavior";var $style=$("#"+style_id);var separated_channels_rule=TS.templates.channel_list_separator();if(TS.model.prefs.sidebar_behavior=="hide_read_channels"){rule="				.channels_list_holder ul li:not(.unread):not(.active):not(.show_in_list_even_though_no_unreads) {					display: none;			}";rule+=separated_channels_rule}else if(TS.model.prefs.sidebar_behavior=="hide_read_channels_unless_starred"){rule="				.channels_list_holder div:not(#starred_div)>ul li:not(.unread):not(.active):not(.show_in_list_even_though_no_unreads) {					display: none;			}";rule+=separated_channels_rule}else if(TS.model.prefs.sidebar_behavior=="shrink_left_column"){rule="				.real_names .im_name {					font-size: 0.7rem;				}				.channels_list_holder ul li a {					height: auto;				}				.channels_list_holder ul li {					height: auto;					font-size: .7rem;				}				.channels_list_holder ul li {					height: auto;					line-height: .8rem;				}				.channels_list_holder .section_holder {					margin: .3rem 0 .4rem;				}				.slackbot_icon, .channels_list_holder ul li.group i.prefix {					font-size: 0.4rem;					margin-top: 4px;				}				.channels_list_holder .unread_highlight {					background: none repeat scroll 0 0 #eb4d5c;					font-size: 0.5rem;					font-weight: 700;					line-height: 10px;					padding: 0 9px;				}				#im-list .presence i.presence_icon, #starred-list .presence i.presence_icon {					font-size: 7px;				}				.channels_list_holder h2, .list_more {					font-size: .6rem;			}"}if(rule){if($style.length){$style.text(rule)}else{$('<style type="text/css" id="'+style_id+'">'+rule+"</style>").appendTo("head")}}else{$("#"+style_id).remove()}},makeMsgDomIdInConversation:function(ts){return TS.templates.makeMsgDomId(ts)+"_conversation"},makeMsgDomIdInSearch:function(ts,main_msg){return TS.templates.makeMsgDomId(ts)+"_"+TS.templates.makeMSRDomId(main_msg)}});var _redrawRetinaAssets=function(){var id,size,omit_link,$el;$(".member_image").each(function(){$el=$(this);id=$el.data("member-id");size=$el.data("thumb-size");omit_link=!$el.is("a");if(id&&size)$(this).replaceWith(TS.templates.builders.makeMemberPreviewLinkImage(id,size,false,omit_link))});$el=null};var _load=function(){var start=Date.now();Object.keys(TS.raw_templates).forEach(function(template_name){TS.templates[template_name]=_compile(template_name,TS.raw_templates[template_name])});var elapsed=Date.now()-start;TS.log(2,elapsed+"ms spent compiling templates");Handlebars.registerPartial("channel",TS.raw_templates.channel);Handlebars.registerPartial("member",TS.raw_templates.member);Handlebars.registerPartial("member",TS.raw_templates.member);Handlebars.registerPartial("team_list_item",TS.raw_templates.team_list_item);Handlebars.registerPartial("team_list_item_divider",TS.raw_templates.team_list_item_divider);Handlebars.registerPartial("team_list_item_member_details",TS.raw_templates.team_list_item_member_details);Handlebars.registerPartial("comment",TS.raw_templates.comment);Handlebars.registerPartial("search_message_results_item",TS.templates.search_message_results_item);Handlebars.registerPartial("file_snippet",TS.templates.file_snippet);Handlebars.registerPartial("file_post",TS.templates.file_post);Handlebars.registerPartial("file_email",TS.templates.file_email);Handlebars.registerPartial("file_image",TS.templates.file_image);Handlebars.registerPartial("file_generic",TS.templates.file_generic);Handlebars.registerPartial("inline_edit_file_title",TS.templates.inline_edit_file_title);Handlebars.registerPartial("file_header_detailed",TS.templates.file_header_detailed);Handlebars.registerPartial("fs_modal_file_viewer",TS.templates.fs_modal_file_viewer);Handlebars.registerPartial("fs_modal_file_viewer_header",TS.templates.fs_modal_file_viewer_header);Handlebars.registerPartial("fs_modal_file_viewer_content_image",TS.templates.fs_modal_file_viewer_content_image);Handlebars.registerPartial("fs_modal_file_viewer_comments",TS.templates.fs_modal_file_viewer_comments);Handlebars.registerPartial("file_public_link",TS.templates.file_public_link);Handlebars.registerPartial("message_actions",TS.templates.message_actions);Handlebars.registerPartial("message_file_preview_actions",TS.templates.message_file_preview_actions);Handlebars.registerPartial("message_file_preview_footer",TS.templates.message_file_preview_footer);if(TS.boot_data.feature_spaces){Handlebars.registerPartial("spaces_connected_member_count",TS.raw_templates.spaces_connected_member_count)}Handlebars.registerPartial("admin_invite_channel_picker",TS.templates.admin_invite_channel_picker);Handlebars.registerPartial("admin_invite_summary",TS.templates.admin_invite_summary);Handlebars.registerPartial("admin_invite_switcher",TS.templates.admin_invite_switcher);Handlebars.registerPartial("channel_page_member_row",TS.templates.channel_page_member_row);Handlebars.registerPartial("channel_conversation_or_group",TS.templates.channel_page_channel_conversation_or_group);if(TS.create){Handlebars.registerPartial("signup_email_body",TS.templates.signup_email_body);Handlebars.registerPartial("signup_team_name_body",TS.templates.signup_team_name_body);Handlebars.registerPartial("signup_url_body",TS.templates.signup_url_body);Handlebars.registerPartial("signup_names_body",TS.templates.signup_names_body);Handlebars.registerPartial("signup_username_body",TS.templates.signup_username_body);Handlebars.registerPartial("create_team_body",TS.templates.create_team_body);Handlebars.registerPartial("signup_invite_body",TS.templates.signup_invite_body)}if(TS.boot_data.feature_subteams){Handlebars.registerPartial("user_group_list_item",TS.templates.user_group_list_item);Handlebars.registerPartial("user_group_tip",TS.templates.user_group_tip);Handlebars.registerPartial("user_group_channel_list_item",TS.templates.user_group_channel_list_item);Handlebars.registerPartial("user_group_list",TS.templates.user_group_list)}Handlebars.registerPartial("channel_kb_nav_label",TS.templates.channel_kb_nav_label);Handlebars.registerPartial("im_browser_tokens",TS.templates.im_browser_tokens);Handlebars.registerPartial("admin_edit_team_profile_option_row",TS.templates.admin_edit_team_profile_option_row);Handlebars.registerPartial("fs_modal_sidebar",TS.templates.fs_modal_sidebar);Handlebars.registerPartial("prefs_emoji_preview",TS.templates.prefs_emoji_preview);if(TS.boot_data.feature_shared_channels_ui){Handlebars.registerPartial("shared_channels_invites_shared_invites",TS.templates.shared_channels_invites_shared_invites);Handlebars.registerPartial("shared_channels_invites_invite",TS.templates.shared_channels_invites_invite);Handlebars.registerPartial("shared_channels_invites_emailed_invitations",TS.templates.shared_channels_invites_emailed_invitations);Handlebars.registerPartial("shared_channels_invites_sent_emails",TS.templates.shared_channels_invites_sent_emails);Handlebars.registerPartial("shared_channels_invites_channel",TS.templates.shared_channels_invites_channel)}if(TS.boot_data.feature_calls){Handlebars.registerPartial("calls_spinner",TS.templates.calls_spinner);Handlebars.registerPartial("calls_participant",TS.templates.calls_participant)}delete TS.raw_templates};var _TEMPLATE_LOG_THROTTLE=1e3;var _template_log_times={};var _compile=function(name,html){if(!html){TS.warn(name+" was passed no html");return null}if(TS.boot_data.experiment_measure_template_perf){var compiled=Handlebars.compile(html);return function(){var date_now=Date.now();var since_prev_log=date_now-(_template_log_times[name]||0);if(since_prev_log<_TEMPLATE_LOG_THROTTLE){return compiled.apply(this,arguments)}_template_log_times[name]=date_now;var measure_label="handlebars_render_"+name;var mark_label="start_"+measure_label+"_"+Date.now();TS.timing.mark(mark_label);var html=compiled.apply(this,arguments);TS.timing.measureAndClear(measure_label,mark_label);return html}}return Handlebars.compile(html)}})();(function(){"use strict";TS.registerModule("templates.builders",{onStart:function(){},debug_items:{},debug_items_index:0,fileHTML:function(file,config){config=config||{};var member=_getEntityFromFile(file);var actions=TS.files.getFileActions(file);var html;var template_args={member:member,file:file,for_search:config.for_search,for_files_list:TS.boot_data.feature_files_list&&!config.for_share_dialog,icon_class:TS.utility.getImageIconClass(file,"thumb_80"),is_email:file.mode=="email",is_space:file.mode=="space",is_post:file.mode=="post",is_snippet:file.mode=="snippet",is_hosted_or_external:file.mode=="hosted"||file.mode=="external",can_share:!!actions.share};if(TS.client){template_args.info_pane_visible=TS.model.ui_state.flex_name==="details"}template_args.supports_line_clamp=TS.model.supports_line_clamp;if(file.mode=="external")template_args.external_filetype_html=TS.templates.builders.makeExternalFiletypeHTML(file);if(file.mode=="email"){template_args.to_more_count=file.to.length-1;template_args.cc_more_count=file.cc.length-1}html=TS.templates.file_list_item(template_args);return html},buildMsgHTML:function(args,log){if(TS.boot_data.feature_refactor_buildmsghtml){return TS.templates.builders.buildMsgHTMLNew(args)}if(log)TS.dir(0,args);try{var dont_show_dupe_bot_users=true;var msg=args.msg;if(false&&msg.text){msg=TS.utility.clone(msg);msg.text+=" <slack-action://BSLACKBOT/help/files/D026MK7NF|testing>"}var model_ob=args.model_ob;var prev_msg=args.prev_msg;var highlight=!!args.highlight;var no_attachments=!!args.no_attachments;var standalone=!!args.standalone;var full_date=!!args.full_date;if(TS.model.prefs.fuller_timestamps&&!full_date)full_date=!TS.utility.date.sameDay(TS.utility.date.toDateObject(msg.ts),new Date);var jump_link=args.jump_link;var starred_items_list=!!args.starred_items_list;var starred_items_actions=args.starred_items_actions;var rxn_options=args.rxn_options||{};var container_id_with_hash=args.container_id?"#"+args.container_id:"";var enable_slack_action_links=!!args.enable_slack_action_links;var theme=args.theme;if(!theme)theme=TS.model.prefs.theme;var html="";var member=_getEntityFromMessage(msg);var replies_enabled=TS.replies&&TS.replies.isEnabledForModelOb(model_ob);var is_in_conversation=replies_enabled&&!!args.is_in_conversation;var show_user=true;var show_divider=!standalone&&!is_in_conversation;var first_in_block=false;var unread=false;var msg_date=TS.utility.date.toDateObject(msg.ts);var new_day=false;var last_time_divider=false;var unprocessed=!!msg.rsp_id;var hide_user_name=false;var current_speaker=msg.user;var is_ephemeral=msg.is_ephemeral;if(!current_speaker&&dont_show_dupe_bot_users)current_speaker=TS.templates.builders.getBotIdentifier(msg);var is_bot=TS.utility.msgs.shouldHaveBotLabel(msg,member);var prev_speaker;if(prev_msg){prev_speaker=prev_msg.subtype=="file_comment"&&prev_msg.comment?prev_msg.comment.user:prev_msg.user;if(!prev_speaker&&dont_show_dupe_bot_users){prev_speaker=TS.templates.builders.getBotIdentifier(prev_msg)}}if(!msg.no_display&&!standalone){if(prev_msg){var last_rendered_msg_date=TS.utility.date.toDateObject(prev_msg.ts);if(model_ob.last_read<=prev_msg.ts)unread=true;if(msg.subtype&&msg.subtype=="file_comment"&&msg.comment){current_speaker=msg.comment.user}if(TS.utility.msgs.automated_subtypes.indexOf(msg.subtype)!=-1){show_divider=true;show_user=true}else if(prev_speaker==current_speaker&&TS.utility.msgs.automated_subtypes.indexOf(prev_msg.subtype)===-1){if(!msg.subtype&&prev_msg.subtype&&prev_msg.subtype=="file_comment"){show_divider=true;show_user=true}else{if(theme=="light"&&msg.subtype=="file_share"||msg.subtype=="file_mention"){show_divider=true}else{show_divider=false}if(!prev_msg.subtype||TS.templates.builders.getBotIdentifier(prev_msg)&&dont_show_dupe_bot_users){if(replies_enabled){var prev_thread_ts=prev_msg.thread_ts||prev_msg.ts;var is_part_of_same_convo=msg.thread_ts==prev_thread_ts;var neither_are_part_of_convo=!msg.thread_ts&&!prev_msg.thread_ts;if(is_part_of_same_convo||neither_are_part_of_convo){show_user=false}}else{show_user=false}}if(TS.utility.msgs.isTempMsg(msg)&&(msg.type=="bot_message"||msg.user=="USLACKBOT")){show_user=true}}}if(!unprocessed&&!TS.utility.date.sameDay(msg_date,last_rendered_msg_date)&&!is_in_conversation){if(!$(container_id_with_hash+' div.day_divider[data-date="'+TS.utility.date.toCalendarDate(msg.ts)+'"]').length){try{html+=TS.templates.messages_day_divider({ts:msg.ts})}catch(err){if(!err.message)err.message="";err.message+=" msg.ts:"+(msg?msg.ts:"no msg?");TS.logError(err,"Problem with TS.templates.messages_day_divider 1.1")}}new_day=true;var $dividers=$(container_id_with_hash+" div.day_divider");if($dividers.length>0){var new_messages_day_divider_html;var $last_divider=$($dividers[$dividers.length-1]);if($last_divider.length){new_messages_day_divider_html="";try{new_messages_day_divider_html=TS.templates.messages_day_divider({ts:$last_divider.data("ts")})}catch(err){if(!err.message)err.message="";err.message+=" $last_divider.data('ts'):"+$last_divider.data("ts");TS.logError(err,"Problem with TS.templates.messages_day_divider 2.1")}$last_divider.replaceWith(new_messages_day_divider_html)}if($dividers.length>1){var $second_last_divider=$($dividers[$dividers.length-2]);if($second_last_divider.length){new_messages_day_divider_html="";try{new_messages_day_divider_html=TS.templates.messages_day_divider({ts:$second_last_divider.data("ts")})}catch(err){if(!err.message)err.message="";err.message+=" $second_last_divider.data('ts'):"+$second_last_divider.data("ts");TS.logError(err,"Problem with TS.templates.messages_day_divider 3.1")}$second_last_divider.replaceWith(new_messages_day_divider_html)}}}}if(!unprocessed&&TS.utility.date.distanceInMinutes(msg_date,last_rendered_msg_date)>TS.model.msg_activity_interval){last_time_divider=true;model_ob.last_time_divider=msg_date}}else if(!is_in_conversation){if(!$(container_id_with_hash+' div.day_divider[data-date="'+TS.utility.date.toCalendarDate(msg.ts)+'"]').length){try{html+=TS.templates.messages_day_divider({ts:msg.ts})}catch(err){if(!err.message)err.message="";err.message+=" msg.ts:"+(msg?msg.ts:"no msg?");TS.logError(err,"Problem with TS.templates.messages_day_divider 4.1")}}last_time_divider=true;model_ob.last_time_divider=msg_date}}if(last_time_divider){show_user=true;first_in_block=true}if(msg.type!="message")show_user=true;if(msg.subtype=="bot_message"){if(TS.templates.builders.getBotIdentifier(msg)){if(!dont_show_dupe_bot_users)show_user=true}else{show_user=false}}if(msg.subtype=="me_message"||prev_msg&&prev_msg.subtype=="me_message"){show_user=true;show_divider=true}var do_inline_imgs=true;if(standalone)do_inline_imgs=false;var actions=TS.utility.msgs.getMsgActions(msg,model_ob);var show_actions_cog=false;if(actions.edit_msg||actions.delete_msg||actions.pin_msg||actions.unpin_msg||actions.add_rxn||actions.add_file_rxn||actions.add_file_comment_rxn){show_actions_cog=true}var hidden=TS.utility.msgs.isMessageUserHidden(msg);var minimal_view=false;if(hidden){if(prev_speaker==current_speaker)return"";minimal_view=true}var has_rxns=false;var rxns=TS.rxns.getExistingRxnsByKey(msg._rxn_key);if(rxns)has_rxns=true;if(args.for_mention_rxn_display)show_user=false;var highlight_as_new=!!(args&&args.highlight_as_new);var msg_dom_id=TS.templates.makeMsgDomId(msg.ts);if(TS.boot_data.feature_message_replies){msg_dom_id=args.msg_dom_id||msg_dom_id}var template_args={msg:msg,actions:actions,show_actions_cog:show_actions_cog,member:member,show_user:show_user,hide_user_name:hide_user_name,show_divider:show_divider,first_in_block:first_in_block,unread:unread,unprocessed:unprocessed,highlight:highlight,model_ob:model_ob,do_inline_imgs:do_inline_imgs,msg_dom_id:msg_dom_id,standalone:standalone,full_date:full_date,jump_link:jump_link,show_resend_controls:msg.ts in TS.model.display_unsent_msgs,starred_items_list:starred_items_list,starred_items_actions:starred_items_actions,rxn_options:rxn_options,theme:theme,no_attachments:no_attachments,is_ephemeral:is_ephemeral,enable_slack_action_links:enable_slack_action_links,minimal_view:minimal_view,is_bot:is_bot,highlight_as_new:highlight_as_new,show_star:!starred_items_list&&!is_ephemeral,has_rxns:has_rxns,for_mention_display:args.for_mention_display,for_mention_rxn_display:args.for_mention_rxn_display,for_search_display:args.for_search_display,ts_tip_delay_class:"ts_tip_delay_600",is_root_msg:args.is_root_msg,is_in_conversation:is_in_conversation};if(TS.boot_data.feature_jumbomoji&&TS.model.prefs.jumbomoji){if(msg.comment){template_args.only_emoji=TS.utility.msgs.isOnlySingleEmoji(msg.comment.comment)}else{template_args.only_emoji=TS.utility.msgs.isOnlySingleEmoji(msg.text)}}if(actions.add_rxn||actions.add_file_rxn||actions.add_file_comment_rxn){template_args.show_rxn_action=true}template_args.star_html=TS.templates.builders.buildStar("message",msg,model_ob);if(TS.replies){var selectable=true;if(standalone)selectable=false;if(TS.utility.msgs.isFileMsg(msg))selectable=false;template_args.selectable=selectable;if(is_in_conversation){template_args.show_reply_action=false;template_args.show_jump_action=true;template_args.msg_dom_id=TS.templates.makeMsgDomIdInConversation(msg.ts)}else{template_args.show_reply_action=TS.replies.canReplyToMsg(model_ob,msg)&&!args.is_root_msg}if(msg.parent_ts){template_args.is_reply_to_your_msg=msg.parent_user_id==TS.boot_data.user_id;template_args.parent_permalink=TS.utility.msgs.constructMsgPermalink(model_ob,msg.parent_ts);var reply_follows_parent_or_sibling=false;if(args.for_search_display){if(args.search_result_type==="extract"){reply_follows_parent_or_sibling=false}else if(prev_msg){reply_follows_parent_or_sibling=prev_msg.ts===msg.parent_ts||prev_msg.parent_ts===msg.parent_ts}}else{reply_follows_parent_or_sibling=!standalone&&TS.ui.replies.doesMessageImmediatelyFollowParentOrSibling(msg,model_ob)}template_args.reply_follows_parent_or_sibling=reply_follows_parent_or_sibling;var parent_msg=!standalone&&TS.replies.getMessage(model_ob,msg.parent_ts);if(parent_msg)template_args.parent_msg=parent_msg}template_args.msg_has_nonconsecutive_reply=TS.ui.replies.doesMessageHaveNonConsecutiveReply(msg,model_ob);var is_root_msg=msg.ts==msg.thread_ts;template_args.show_reply_icon=!is_root_msg&&!!msg.parent_ts}if(!msg.subtype&&args.for_search_display&&msg.file){if(msg.comment){template_args.star_html=TS.templates.builders.buildStar("file_comment",msg.comment,msg.file)}else{template_args.star_html=TS.templates.builders.buildStar("file",msg.file,null)}}if(!TS.utility.msgs.isTempMsg(msg)&&!msg.is_ephemeral){template_args.permalink=TS.utility.msgs.constructMsgPermalink(model_ob,msg.ts);template_args.abs_permalink=TS.utility.msgs.constructAbsoluteMsgPermalink(model_ob,msg.ts)}if(msg.subtype=="file_share"||msg.subtype=="file_mention"){if(!msg.file){}else{template_args.file=msg.file;template_args.abs_permalink=msg.file.permalink;if(!starred_items_list){template_args.star_html=TS.templates.builders.buildStar("file",msg.file,null)}template_args.lightbox=false;if(msg.file.thumb_360_w==360||msg.file.thumb_360_h==360){template_args.lightbox=true}$.extend(template_args,TS.files.getFileTemplateArguments(msg.file,360));
template_args.is_message=true;template_args.image_lazyload=!!TS.client;template_args.lightbox=true;if(msg.subtype=="file_share"&&msg.upload){if(msg.file.mode=="email")template_args.is_added=true;template_args.icon_class=TS.utility.getImageIconClass(msg.file,"thumb_80")}else if(msg.file.user!=msg.user){template_args.uploader=_getEntityFromFile(msg.file)}if(msg.subtype=="file_mention"){template_args.share_verb="mentioned"}else if(msg.subtype=="file_share"&&msg.upload){template_args.share_verb="uploaded";if(/(snippet)/.test(msg.file.mode))template_args.share_verb="added";if(msg.file.initial_comment){template_args.share_verb+=" and commented on";template_args.show_initial_comment=true;if(TS.boot_data.feature_jumbomoji&&TS.model.prefs.jumbomoji){template_args.only_emoji=TS.utility.msgs.isOnlySingleEmoji(msg.file.initial_comment.comment)}}}else{template_args.share_verb="shared"}template_args.share_determiner="a";template_args.share_noun="file";if(/(snippet)/.test(msg.file.mode)){template_args.share_noun=msg.file.pretty_type+" snippet";var needs_an=["A","E","O","X"];if(needs_an.indexOf(template_args.share_noun.charAt(0))>-1||template_args.share_noun=="HTML snippet"){template_args.share_determiner="an"}}if(/(email)/.test(msg.file.mode)){template_args.share_determiner="an";template_args.share_noun="email"}if(/(post|space)/.test(msg.file.mode))template_args.share_noun="Post";if((msg.file.thumb_360||msg.file.thumb_360_gif)&&!(msg.file.external_type==="gdrive"&&msg.file.mimetype.indexOf("image/")<0)){template_args.share_determiner="an";template_args.share_noun="image"}html+=TS.templates.message(template_args)}}else if(msg.subtype=="file_comment"){if(prev_msg&&!prev_msg.no_display&&prev_msg.file&&msg.file&&msg.file.id==prev_msg.file.id){template_args["show_divider"]=false;if(!new_day)template_args["is_file_convo_continuation"]=true}template_args["show_comment_quote_icon"]=true;if(prev_msg&&!prev_msg.no_display&&prev_msg.file&&msg.file&&msg.file.id==prev_msg.file.id){if(prev_msg.subtype=="file_share"&&prev_msg.upload&&prev_msg.file.initial_comment){if(!new_day)template_args["show_comment_quote_icon"]=false}if(prev_msg.subtype=="file_comment"){if(!new_day)template_args["show_comment_quote_icon"]=false}}template_args["file"]=msg.file;template_args["icon_class"]=TS.utility.getImageIconClass(msg.file,"thumb_40");template_args["comment"]=msg.comment;template_args["member"]=_getEntityFromMessage(msg);if(msg.file&&msg.file.user!=msg.comment.user){template_args["uploader"]=_getEntityFromFile(msg.file)}if(!starred_items_list){template_args.star_html=TS.templates.builders.buildStar("file_comment",msg.comment,msg.file)}html+=TS.templates.message(template_args)}else{html+=TS.templates.message(template_args)}html=html.replace(/\ue000/g,"").replace(/\ue001/g,"");return html}catch(err){var extra="";if(msg){extra="msg.ts:"+msg.ts;delete args.model_ob;try{args.msg=TS.utility.clone(msg);args.msg.text="REDACTED";extra+=" "+JSON.stringify(args,null,"  ")}catch(err_again){}}if(!err.message)err.message="";err.message+=" "+extra;TS.logError(err,"Problem in buildMsgHTML with_args");return""}},buildMsgHTMLNew:function(args){TS.log(8,"buildMsgHTMLNew");try{var msg=args.msg;var dont_show_dupe_bot_users=true;var model_ob=args.model_ob;var prev_msg=args.prev_msg;var highlight=!!args.highlight;var no_attachments=!!args.no_attachments;var standalone=!!args.standalone;var full_date=!!args.full_date;if(TS.model.prefs.fuller_timestamps&&!full_date)full_date=!TS.utility.date.sameDay(TS.utility.date.toDateObject(msg.ts),new Date);var jump_link=args.jump_link;var starred_items_list=!!args.starred_items_list;var starred_items_actions=args.starred_items_actions;var rxn_options=args.rxn_options||{};var container_id_with_hash=args.container_id?"#"+args.container_id:"";var enable_slack_action_links=!!args.enable_slack_action_links;var theme=args.theme;if(!theme)theme=TS.model.prefs.theme;var html="";var member=_getEntityFromMessage(msg);var replies_enabled=TS.replies&&TS.replies.isEnabledForModelOb(model_ob);var is_in_conversation=replies_enabled&&!!args.is_in_conversation;var show_user=true;var show_divider=!standalone&&!is_in_conversation;var first_in_block=false;var unread=false;var msg_date=TS.utility.date.toDateObject(msg.ts);var new_day=false;var last_time_divider=false;var unprocessed=!!msg.rsp_id;var hide_user_name=false;var current_speaker=msg.user;var is_ephemeral=msg.is_ephemeral;if(!current_speaker&&dont_show_dupe_bot_users)current_speaker=TS.templates.builders.getBotIdentifier(msg);var is_bot=TS.utility.msgs.shouldHaveBotLabel(msg,member);var prev_speaker;if(prev_msg){prev_speaker=prev_msg.subtype=="file_comment"&&prev_msg.comment?prev_msg.comment.user:prev_msg.user;if(!prev_speaker&&dont_show_dupe_bot_users){prev_speaker=TS.templates.builders.getBotIdentifier(prev_msg)}}if(!msg.no_display&&!standalone){if(prev_msg){var last_rendered_msg_date=TS.utility.date.toDateObject(prev_msg.ts);if(model_ob.last_read<=prev_msg.ts)unread=true;if(msg.subtype&&msg.subtype=="file_comment"&&msg.comment){current_speaker=msg.comment.user}if(TS.utility.msgs.automated_subtypes.indexOf(msg.subtype)!=-1){show_divider=true;show_user=true}else if(prev_speaker==current_speaker&&TS.utility.msgs.automated_subtypes.indexOf(prev_msg.subtype)===-1){if(!msg.subtype&&prev_msg.subtype&&prev_msg.subtype=="file_comment"){show_divider=true;show_user=true}else{if(theme=="light"&&msg.subtype=="file_share"||msg.subtype=="file_mention"){show_divider=true}else{show_divider=false}if(!prev_msg.subtype||TS.templates.builders.getBotIdentifier(prev_msg)&&dont_show_dupe_bot_users){if(replies_enabled){var prev_thread_ts=prev_msg.thread_ts||prev_msg.ts;var is_part_of_same_convo=msg.thread_ts==prev_thread_ts;var neither_are_part_of_convo=!msg.thread_ts&&!prev_msg.thread_ts;if(is_part_of_same_convo||neither_are_part_of_convo){show_user=false}}else{show_user=false}}if(TS.utility.msgs.isTempMsg(msg)&&(msg.type=="bot_message"||msg.user=="USLACKBOT")){show_user=true}}}if(!unprocessed&&!TS.utility.date.sameDay(msg_date,last_rendered_msg_date)&&!is_in_conversation){if(!$(container_id_with_hash+' div.day_divider[data-date="'+TS.utility.date.toCalendarDate(msg.ts)+'"]').length){try{html+=TS.templates.messages_day_divider({ts:msg.ts})}catch(err){if(!err.message)err.message="";err.message+=" msg.ts:"+(msg?msg.ts:"no msg?");TS.logError(err,"Problem with TS.templates.messages_day_divider 1.1")}}new_day=true;var $dividers=$(container_id_with_hash+" div.day_divider");if($dividers.length>0){var new_messages_day_divider_html;var $last_divider=$($dividers[$dividers.length-1]);if($last_divider.length){new_messages_day_divider_html="";try{new_messages_day_divider_html=TS.templates.messages_day_divider({ts:$last_divider.data("ts")})}catch(err){if(!err.message)err.message="";err.message+=" $last_divider.data('ts'):"+$last_divider.data("ts");TS.logError(err,"Problem with TS.templates.messages_day_divider 2.1")}$last_divider.replaceWith(new_messages_day_divider_html)}if($dividers.length>1){var $second_last_divider=$($dividers[$dividers.length-2]);if($second_last_divider.length){new_messages_day_divider_html="";try{new_messages_day_divider_html=TS.templates.messages_day_divider({ts:$second_last_divider.data("ts")})}catch(err){if(!err.message)err.message="";err.message+=" $second_last_divider.data('ts'):"+$second_last_divider.data("ts");TS.logError(err,"Problem with TS.templates.messages_day_divider 3.1")}$second_last_divider.replaceWith(new_messages_day_divider_html)}}}}if(!unprocessed&&TS.utility.date.distanceInMinutes(msg_date,last_rendered_msg_date)>TS.model.msg_activity_interval){last_time_divider=true;model_ob.last_time_divider=msg_date}}else if(!is_in_conversation){if(!$(container_id_with_hash+' div.day_divider[data-date="'+TS.utility.date.toCalendarDate(msg.ts)+'"]').length){try{html+=TS.templates.messages_day_divider({ts:msg.ts})}catch(err){if(!err.message)err.message="";err.message+=" msg.ts:"+(msg?msg.ts:"no msg?");TS.logError(err,"Problem with TS.templates.messages_day_divider 4.1")}}last_time_divider=true;model_ob.last_time_divider=msg_date}}if(last_time_divider){show_user=true;first_in_block=true}if(msg.type!="message")show_user=true;if(msg.subtype=="bot_message"){if(TS.templates.builders.getBotIdentifier(msg)){if(!dont_show_dupe_bot_users)show_user=true}else{show_user=false}}if(msg.subtype=="me_message"||prev_msg&&prev_msg.subtype=="me_message"){show_user=true;show_divider=true}var do_inline_imgs=true;if(standalone)do_inline_imgs=false;var actions=TS.utility.msgs.getMsgActions(msg,model_ob);var show_actions_cog=false;if(actions.edit_msg||actions.delete_msg||actions.pin_msg||actions.unpin_msg||actions.add_rxn||actions.add_file_rxn||actions.add_file_comment_rxn){show_actions_cog=true}var hidden=TS.utility.msgs.isMessageUserHidden(msg);var minimal_view=false;if(hidden){if(prev_speaker==current_speaker)return"";minimal_view=true}var has_rxns=false;var rxns=TS.rxns.getExistingRxnsByKey(msg._rxn_key);if(rxns)has_rxns=true;if(args.for_mention_rxn_display)show_user=false;var highlight_as_new=!!(args&&args.highlight_as_new);var msg_dom_id=TS.templates.makeMsgDomId(msg.ts);if(TS.boot_data.feature_message_replies){msg_dom_id=args.msg_dom_id||msg_dom_id}var template_args={msg:msg,actions:actions,show_actions_cog:show_actions_cog,member:member,show_user:show_user,hide_user_name:hide_user_name,show_divider:show_divider,first_in_block:first_in_block,unread:unread,unprocessed:unprocessed,highlight:highlight,model_ob:model_ob,do_inline_imgs:do_inline_imgs,msg_dom_id:msg_dom_id,standalone:standalone,full_date:full_date,jump_link:jump_link,show_resend_controls:msg.ts in TS.model.display_unsent_msgs,starred_items_list:starred_items_list,starred_items_actions:starred_items_actions,rxn_options:rxn_options,theme:theme,no_attachments:no_attachments,is_ephemeral:is_ephemeral,enable_slack_action_links:enable_slack_action_links,minimal_view:minimal_view,is_bot:is_bot,highlight_as_new:highlight_as_new,show_star:!starred_items_list&&!is_ephemeral,has_rxns:has_rxns,for_mention_display:args.for_mention_display,for_mention_rxn_display:args.for_mention_rxn_display,for_search_display:args.for_search_display,ts_tip_delay_class:"ts_tip_delay_600",is_root_msg:args.is_root_msg,is_in_conversation:is_in_conversation};if(TS.boot_data.feature_jumbomoji&&TS.model.prefs.jumbomoji){if(msg.comment){template_args.only_emoji=TS.utility.msgs.isOnlySingleEmoji(msg.comment.comment)}else{template_args.only_emoji=TS.utility.msgs.isOnlySingleEmoji(msg.text)}}if(actions.add_rxn||actions.add_file_rxn||actions.add_file_comment_rxn){template_args.show_rxn_action=true}template_args.star_html=TS.templates.builders.buildStar("message",msg,model_ob);if(TS.replies){var selectable=true;if(standalone)selectable=false;if(TS.utility.msgs.isFileMsg(msg))selectable=false;template_args.selectable=selectable;if(is_in_conversation){template_args.show_reply_action=false;template_args.show_jump_action=true;template_args.msg_dom_id=TS.templates.makeMsgDomIdInConversation(msg.ts)}else{template_args.show_reply_action=TS.replies.canReplyToMsg(model_ob,msg)&&!args.is_root_msg}if(msg.parent_ts){template_args.is_reply_to_your_msg=msg.parent_user_id==TS.boot_data.user_id;template_args.parent_permalink=TS.utility.msgs.constructMsgPermalink(model_ob,msg.parent_ts);template_args.reply_follows_parent_or_sibling=TS.ui.replies.doesMessageImmediatelyFollowParentOrSibling(msg,model_ob);var parent_msg=TS.replies.getMessage(model_ob,msg.parent_ts);if(parent_msg)template_args.parent_msg=parent_msg}template_args.msg_has_nonconsecutive_reply=TS.ui.replies.doesMessageHaveNonConsecutiveReply(msg,model_ob);var is_root_msg=msg.ts==msg.thread_ts;template_args.show_reply_icon=!is_root_msg&&!!msg.parent_ts}if(!msg.subtype&&args.for_search_display&&msg.file){if(msg.comment){template_args.star_html=TS.templates.builders.buildStar("file_comment",msg.comment,msg.file)}else{template_args.star_html=TS.templates.builders.buildStar("file",msg.file,null)}}if(!TS.utility.msgs.isTempMsg(msg)&&!msg.is_ephemeral){template_args.permalink=TS.utility.msgs.constructMsgPermalink(model_ob,msg.ts);template_args.abs_permalink=TS.utility.msgs.constructAbsoluteMsgPermalink(model_ob,msg.ts)}if(msg.subtype=="file_share"||msg.subtype=="file_mention"){if(!msg.file){}else{template_args.file=msg.file;template_args.abs_permalink=msg.file.permalink;if(!starred_items_list){template_args.star_html=TS.templates.builders.buildStar("file",msg.file,null)}template_args.lightbox=false;if(msg.file.thumb_360_w==360||msg.file.thumb_360_h==360){template_args.lightbox=true}$.extend(template_args,TS.files.getFileTemplateArguments(msg.file,360));template_args.is_message=true;template_args.image_lazyload=!!TS.client;template_args.lightbox=true;if(msg.subtype=="file_share"&&msg.upload){if(msg.file.mode=="email")template_args.is_added=true;template_args.icon_class=TS.utility.getImageIconClass(msg.file,"thumb_80")}else if(msg.file.user!=msg.user){template_args.uploader=_getEntityFromFile(msg.file)}if(msg.subtype=="file_mention"){template_args.share_verb="mentioned"}else if(msg.subtype=="file_share"&&msg.upload){template_args.share_verb="uploaded";if(/(snippet)/.test(msg.file.mode))template_args.share_verb="added";if(msg.file.initial_comment){template_args.share_verb+=" and commented on";template_args.show_initial_comment=true;if(TS.boot_data.feature_jumbomoji&&TS.model.prefs.jumbomoji){template_args.only_emoji=TS.utility.msgs.isOnlySingleEmoji(msg.file.initial_comment.comment)}}}else{template_args.share_verb="shared"}template_args.share_determiner="a";template_args.share_noun="file";if(/(snippet)/.test(msg.file.mode)){template_args.share_noun=msg.file.pretty_type+" snippet";var needs_an=["A","E","O","X"];if(needs_an.indexOf(template_args.share_noun.charAt(0))>-1||template_args.share_noun=="HTML snippet"){template_args.share_determiner="an"}}if(/(email)/.test(msg.file.mode)){template_args.share_determiner="an";template_args.share_noun="email"}if(/(post|space)/.test(msg.file.mode))template_args.share_noun="Post";if((msg.file.thumb_360||msg.file.thumb_360_gif)&&!(msg.file.external_type==="gdrive"&&msg.file.mimetype.indexOf("image/")<0)){template_args.share_determiner="an";template_args.share_noun="image"}html+=TS.templates.message(template_args)}}else if(msg.subtype=="file_comment"){if(prev_msg&&!prev_msg.no_display&&prev_msg.file&&msg.file&&msg.file.id==prev_msg.file.id){template_args["show_divider"]=false;if(!new_day)template_args["is_file_convo_continuation"]=true}template_args["show_comment_quote_icon"]=true;if(prev_msg&&!prev_msg.no_display&&prev_msg.file&&msg.file&&msg.file.id==prev_msg.file.id){if(prev_msg.subtype=="file_share"&&prev_msg.upload&&prev_msg.file.initial_comment){if(!new_day)template_args["show_comment_quote_icon"]=false}if(prev_msg.subtype=="file_comment"){if(!new_day)template_args["show_comment_quote_icon"]=false}}template_args["file"]=msg.file;template_args["icon_class"]=TS.utility.getImageIconClass(msg.file,"thumb_40");template_args["comment"]=msg.comment;template_args["member"]=_getEntityFromMessage(msg);if(msg.file&&msg.file.user!=msg.comment.user){template_args["uploader"]=_getEntityFromFile(msg.file)}if(!starred_items_list){template_args.star_html=TS.templates.builders.buildStar("file_comment",msg.comment,msg.file)}html+=TS.templates.message(template_args)}else{html+=TS.templates.message(template_args)}html=html.replace(/\ue000/g,"").replace(/\ue001/g,"");return html}catch(err){var extra="";if(msg){extra="msg.ts:"+msg.ts;delete args.model_ob;try{args.msg=TS.utility.clone(msg);args.msg.text="REDACTED";extra+=" "+JSON.stringify(args,null,"  ")}catch(err_again){}}if(!err.message)err.message="";err.message+=" "+extra;TS.logError(err,"Problem in buildMsgHTML with_args");return""}},formatSoundUrl:function(attachment,msg){return""},buildAttachmentHTML:function(args){var msg_dom_id=TS.templates.makeMsgDomId(args.msg.ts);if(TS.boot_data.feature_message_replies){msg_dom_id=args.msg_dom_id||msg_dom_id}var attachment=args.attachment;var model_ob=TS.shared.getActiveModelOb();if(TS.templates.builders.shouldDoSimpleAttachment(attachment,args.msg)){if(attachment.video_html){return TS.templates.builders.buildInlineVideoTogglerAndDiv(attachment.from_url,msg_dom_id)}else if(attachment.image_url){return TS.templates.builders.buildInlineImgTogglerAndDiv(attachment.from_url,msg_dom_id,args)}else if(attachment.audio_url){return" "+TS.templates.builders.formatSoundUrl(attachment,args.msg)}}var expand_it=true;var caret_html="";var real_src="";if(args.show_initial_caret||args.show_media_caret){if(attachment.video_html){var inline_video=TS.model.inline_videos[attachment.from_url||attachment.thumb_url];if(inline_video){var no_title_in_toggler=true;caret_html=TS.templates.builders.buildInlineVideoToggler(attachment.from_url||attachment.thumb_url,msg_dom_id,no_title_in_toggler);real_src=attachment.thumb_url;expand_it=TS.inline_videos.shouldExpand(msg_dom_id,inline_video)}}else if(attachment.audio_html||attachment.audio_url){var inline_audio=TS.model.inline_audios[attachment.audio_html||attachment.audio_url];if(inline_audio){caret_html=TS.templates.builders.buildInlineAudioToggler(attachment.audio_html||attachment.audio_url,msg_dom_id);real_src=attachment.audio_html||attachment.audio_url;expand_it=TS.inline_audios.shouldExpand(msg_dom_id,inline_audio)}}else if(attachment.other_html){var inline_other=TS.model.inline_others[attachment.other_html];if(inline_other){caret_html=TS.templates.builders.buildInlineOtherToggler(attachment.other_html,msg_dom_id);real_src=attachment.other_html;expand_it=TS.inline_others.shouldExpand(msg_dom_id,inline_other)}}else if(attachment.image_url){var inline_img=TS.model.inline_imgs[attachment.from_url||attachment.image_url];if(inline_img){var no_bytes_in_toggler=!args.show_media_caret;caret_html=TS.templates.builders.buildInlineImgToggler(attachment.from_url||attachment.image_url,msg_dom_id,no_bytes_in_toggler);real_src=attachment.image_url;expand_it=TS.inline_imgs.shouldExpand(msg_dom_id,inline_img)}}else{var inline_attachment=TS.model.inline_attachments[attachment.from_url];if(inline_attachment){real_src=attachment.from_url;caret_html=TS.templates.builders.buildInlineAttachmentToggler(attachment.from_url,msg_dom_id);expand_it=TS.inline_attachments.shouldExpand(msg_dom_id,inline_attachment)}else{TS.warn("no inline_attachment for "+attachment.from_url)}}}if(attachment.color){if(typeof attachment.color=="number")attachment.color=attachment.color.toString();if(!attachment.color.indexOf){TS.warn("msg "+args.msg.ts+" has an invalid (non string) color:"+attachment.color+" (removed in client)");delete attachment.color}else{if(attachment.color.indexOf("#")!=-1){TS.warn("msg "+args.msg.ts+" has an invalid color:"+attachment.color+" (fixed in client)")}attachment.color=attachment.color.replace(/\#/g,"")}}var short_fields=[];var long_fields=[];if(attachment.fields){var f;var new_row;var last;for(var i=0;i<attachment.fields.length;i++){new_row=true;f=attachment.fields[i];if(last&&f["short"]&&last["short"]&&last._new_row){new_row=false}f._new_row=new_row;last=f;if(f["short"]){short_fields.push(f)}else{long_fields.push(f)}}}var should_expand=attachment._short_text&&!TS.inline_attachments.shouldExpandText(TS.templates.makeMsgAttachmentTextExpanderDomId(args.msg.ts,attachment._index));var has_more=!!attachment.more;var ts_link=attachment.from_url||attachment.ts_link||attachment.title_link||attachment.author_link;var thumb_link=attachment.thumb_link||ts_link;var can_delete=false;if(!model_ob){TS.warn("need to get model_ob passed in here somehow! for expanding messages in activity feed")}else if(args.can_delete!==false){can_delete=(attachment.id||attachment.id===0)&&(attachment.from_url||args.msg.text)&&(TS.model.user.is_admin&&!model_ob.is_im||TS.model.user.id==args.msg.user)&&args.msg.subtype!=="pinned_item"}var small_thumb=attachment.thumb_url&&!attachment.image_url&&!attachment.video_html&&!attachment.audio_html;var small_thumb_url=small_thumb?attachment.proxied_thumb_url||attachment.thumb_url:null;return TS.templates.message_attachment({is_text_collapsed:should_expand,has_more:has_more,attachment:attachment,short_fields:short_fields,long_fields:long_fields,url:args.url,msg:args.msg,initial_caret_html:args.show_initial_caret?caret_html:"",media_caret_html:args.show_media_caret?caret_html:"",msg_dom_id:msg_dom_id,expand_it:args.show_initial_caret?expand_it:true,expand_media:args.show_media_caret?expand_it:true,real_src:real_src,bg_color:attachment.color||"e3e4e6",is_standalone:!args.msg.text||args.msg.ignore_if_attachments_supported||!attachment.pretext,show_fields_table:TS.qs_args["show_fields_table"]!="0",thumb_at_top:!window.attach_thumb_align_title,can_delete:can_delete,ts_link:ts_link,thumb_link:thumb_link,small_thumb:small_thumb,small_thumb_url:small_thumb_url,max_width_class:small_thumb?"right_thumb_max_w":"",show_fallback:TS.model.show_attachment_fallback,enable_slack_action_links:args.enable_slack_action_links===true,show_action_links:args.enable_slack_action_links===true})},buildAttachmentActionButtonHTML:function(action){var button_defaults={name:"",value:"",text:"",style:"default",behavior:"single",disabled:false,clicked:false,id:""};var style_to_class={"default":"",primary:"btn_primary",danger:"btn_danger"};var current_text=action.clicked&&action.clicked_text?action.clicked_text:action.text;var formatted_text=TS.emoji.graphicReplace(current_text);var button=_.merge({},button_defaults,action);button.current_text=new Handlebars.SafeString(formatted_text);button.btn_class=style_to_class[button.style];return TS.templates.attachment_actions_button(button)},shouldDoSimpleAttachment:function(attachment,msg){var do_simple=false;if((attachment.image_url||attachment.audio_url)&&attachment.from_url){if(msg&&msg.text){if(msg.text.indexOf(attachment.from_url)!=-1){do_simple=true}if(TS.model.ampersands_are_inconsistent_in_from_urls){if(msg.text.indexOf(attachment.from_url.replace(/\&/g,"&amp;"))!=-1){do_simple=true}}}if(attachment.service_name||attachment.title)do_simple=false}return do_simple},formatAttachments:function(msg,enable_slack_action_links,msg_dom_id){enable_slack_action_links=enable_slack_action_links===true;var model_ob=TS.shared.getActiveModelOb();var html="";if(!msg.attachments)return html;var attachment;for(var i=0;i<msg.attachments.length;i++){attachment=msg.attachments[i];if(!attachment){TS.info("formatAttachments bad attach");TS.dir(0,msg);continue}if(attachment.from_url&&(TS.boot_data.feature_attachments_inline||TS.templates.builders.shouldDoSimpleAttachment(attachment,msg))){html+="";continue}if(attachment.ts){attachment.ts_link=TS.utility.msgs.constructMsgPermalink(model_ob,attachment.ts.toString())}if(!TS.inline_attachments.shouldShow(attachment,msg)){html+="";continue}if(TS.boot_data.feature_attachment_actions&&attachment.actions&&attachment.actions.length){var action;var legacy_actions=[];var new_actions=[];for(var j=0;j<attachment.actions.length;j++){action=attachment.actions[j];if(action.type!=="button"){legacy_actions.push(action)}else{new_actions.push(action)}}if(legacy_actions.length){attachment.legacy_actions=legacy_actions}if(new_actions.length){attachment.actions=new_actions}}html+=TS.templates.builders.buildAttachmentHTML({attachment:attachment,url:null,msg:msg,msg_dom_id:TS.boot_data.feature_message_replies&&msg_dom_id,show_initial_caret:TS.templates.builders.shouldDoSimpleAttachment(attachment,msg),show_media_caret:attachment.video_html||attachment.image_url||attachment.audio_html||attachment.audio_url||attachment.other_html,enable_slack_action_links:enable_slack_action_links})}return html},buildJoinLeaveRollUpStr:function(ob){var str="";if(ob.is_in){if(ob.joined&&ob.left){str="left and rejoined"}else{str="joined"}}else{if(ob.joined&&ob.left){str="joined and left"}else{str="left"}}return str},buildSHRoomAttachment:function(room){if(!TS.boot_data.feature_screenhero&&!TS.boot_data.feature_calls)return"<div>The screenhero/calls feature flag is not turned on in this env.</div>";var did_room_start_in_channel=room.channels&&room.channels[0]===TS.model.active_c_id;var participants=room.participants.map(function(participant_id){return TS.members.getMemberById(participant_id)});var dm_member=TS.model.active_im_id&&TS.members.getMemberById(TS.ims.getImById(TS.model.active_im_id).user);var share_url_prefix=TS.boot_data.feature_calls?TS.utility.calls.share_url_prefix:TS.utility.screenhero.share_url_prefix;var is_call_window_ready=TS.boot_data.feature_calls?TS.utility.calls.isCallWindowReady():TS.utility.screenhero.canMakeCalls();return TS.templates.message_screenhero_attachment({room:room,participants:participants,share_url_prefix:share_url_prefix,did_room_start_in_channel:did_room_start_in_channel,dm_member_name:dm_member&&(dm_member.profile.real_name||dm_member.name),expand_it:TS.inline_room_previews.shouldExpand(room.id),currently_in_call:room.participants.indexOf(TS.model.user.id)>=0,duration:room.date_end-room.date_start,is_creator:room.created_by===TS.model.user.id,is_call_window_ready:is_call_window_ready})},formatMessageByType:function(msg,do_inline_imgs,enable_slack_action_links,model_ob){var html="";var txt;if(msg.ignore_if_attachments_supported){return html}do_inline_imgs=do_inline_imgs===true;enable_slack_action_links=enable_slack_action_links===true;var channel,group,inviter,room;if(msg._jl_rollup_hash&&msg.user in msg._jl_rollup_hash.users){channel=model_ob;inviter=TS.members.getMemberById(msg.inviter);var user_ob=msg._jl_rollup_hash.users[msg.user];var str=TS.templates.builders.buildJoinLeaveRollUpStr(user_ob);str+=channel?" #"+channel.name:" the channel";if(user_ob.is_in&&inviter){str+=" by invitation from <@"+inviter.id+"|"+inviter.name+">"}var alsoA=[];var otherA=[];var also_str="along with";var ob;for(var k in msg._jl_rollup_hash.users){if(k==msg.user)continue;ob=msg._jl_rollup_hash.users[k];if(ob.is_in===user_ob.is_in){if(ob.is_in){if(ob.inviter==msg.user)also_str="and invited";if(ob.inviter&&(ob.inviter==user_ob.inviter||ob.inviter==msg.user)){alsoA.push("<@"+k+">")}else{otherA.push("<@"+k+"> "+TS.templates.builders.buildJoinLeaveRollUpStr(ob))}}else{alsoA.push("<@"+k+">")}}else{otherA.push("<@"+k+"> "+TS.templates.builders.buildJoinLeaveRollUpStr(ob))}}if(alsoA.length){str+=", "+also_str+" "+alsoA.join(", ")}if(otherA.length){str+=". Also, "+otherA.join(", ")+"."}html=TS.format.formatNoHighlightsNoSpecials(str)}else if(msg.subtype=="channel_join"){channel=model_ob;inviter=TS.members.getMemberById(msg.inviter);if(inviter){txt="joined"+(channel?" #"+channel.name:" the channel")+" from an invitation by <@"+inviter.id+"|"+inviter.name+">";html=TS.format.formatNoHighlightsNoSpecials(txt,msg)}else{html="joined"+(channel?" #"+channel.name:" the channel")}}else if(msg.subtype=="channel_leave"){channel=model_ob;html="left"+(channel?" #"+channel.name:" the channel")}else if(msg.subtype=="channel_name"){html='renamed the channel from "'+msg.old_name+'" to "'+msg.name+'"'}else if(msg.subtype=="channel_topic"){if(!msg.topic){html="cleared the channel topic"}else{html='set the channel topic: <span class="topic">'+TS.format.formatNoHighlightsNoSpecials(msg.topic,msg)+"</span>"}}else if(msg.subtype=="channel_purpose"){if(!msg.purpose){html="cleared the channel purpose"}else{html='set the channel purpose: <span class="purpose">'+TS.format.formatNoHighlightsNoSpecials(msg.purpose,msg)+"</span>"}}else if(msg.subtype=="group_join"){group=model_ob;inviter=TS.members.getMemberById(msg.inviter);if(inviter){txt="from an invitation by <@"+inviter.id+"|"+inviter.name+">";html="joined"+(group?" "+TS.model.group_prefix+group.name:" the "+TS.templates.builders.groupCopy())+" "+TS.format.formatNoHighlightsNoSpecials(txt,msg)}else{html="joined"+(group?" "+TS.model.group_prefix+group.name:" the "+TS.templates.builders.groupCopy())}}else if(msg.subtype=="group_leave"){group=model_ob;html="left"+(group?" "+TS.model.group_prefix+group.name:" the "+TS.templates.builders.groupCopy())}else if(msg.subtype=="group_name"){html="renamed the "+TS.templates.builders.groupCopy()+' from "'+msg.old_name+'" to "'+msg.name+'"'}else if(msg.subtype=="group_topic"){if(!msg.topic){html="cleared the "+TS.templates.builders.groupCopy({skip_private:true})+" topic"}else{html="set the "+TS.templates.builders.groupCopy({skip_private:true})+" topic: "+TS.format.formatNoHighlightsNoSpecials(msg.topic,msg)}}else if(msg.subtype=="group_purpose"){if(!msg.purpose){html="cleared the "+TS.templates.builders.groupCopy({skip_private:true})+" purpose"}else{html="set the "+TS.templates.builders.groupCopy({skip_private:true})+" purpose: "+TS.format.formatNoHighlightsNoSpecials(msg.purpose,msg)}}else if(msg.subtype=="group_archive"){group=model_ob;html="archived"+(group?" "+TS.model.group_prefix+group.name:" the "+TS.templates.builders.groupCopy());if(TS.client&&group&&group.is_archived){if(TS.model.archive_view_is_showing){html+='. The contents will still be available in search and browsable in the <a target="_blank" href="/archives/'+group.name+'?force-browser=1">archives</a>.'}else{var method="TS.shared.closeArchivedChannel";html+='. The contents will still be available in search and browsable in the <a target="_blank" href="/archives/'+group.name+'?force-browser=1">archives</a>. 						It can also be un-archived at any time. To close it now, <a onclick="'+method+"('"+group.id+"')\">click here</a>."}}}else if(msg.subtype=="group_unarchive"){group=model_ob;html="un-archived"+(group?" "+TS.model.group_prefix+group.name:" the "+TS.templates.builders.groupCopy())}else if(msg.subtype=="channel_archive"){channel=model_ob;html="archived"+(channel?" #"+channel.name:" the channel");if(TS.client&&channel&&channel.is_archived){if(TS.model.archive_view_is_showing){html+='. The contents will still be available in search and browsable in the <a target="_blank" href="/archives/'+channel.name+'?force-browser=1">archives</a>.'}else{html+='. The contents will still be available in search and browsable in the <a target="_blank" href="/archives/'+channel.name+'?force-browser=1">archives</a>. 						It can also be un-archived at any time. To close it now, <a onclick="TS.channels.closeArchivedChannel(\''+channel.id+"')\">click here</a>."}}}else if(msg.subtype=="channel_unarchive"){channel=model_ob;html="un-archived"+(channel?" #"+channel.name:" the channel")}else if(msg.subtype=="me_message"){html="<i>"+TS.format.formatWithOptions(msg.text,msg,{do_inline_imgs:do_inline_imgs})+"</i>"}else if(msg.subtype=="play_sound"){html='played "'+msg.sound+'"'}else if(msg.subtype=="sh_room_shared"||msg.subtype=="sh_room_created"){if(msg.subtype=="sh_room_shared"){}else{}if(msg._room_id&&(room=TS.rooms.getRoomById(msg._room_id))){html+=TS.templates.builders.buildSHRoomAttachment(room)}else{}}else if(msg.subtype==="bot_add"||msg.subtype==="bot_enable"||msg.subtype==="bot_updated"||msg.subtype==="bot_disable"||msg.subtype==="bot_remove"){html=TS.format.formatWithOptions(msg.text,msg,{do_inline_imgs:do_inline_imgs,enable_slack_action_links:enable_slack_action_links,no_highlights:true})}else if(msg.subtype==="reminder_add"||msg.subtype==="reminder_delete"){html=TS.format.formatWithOptions(msg.text,msg,{do_inline_imgs:do_inline_imgs,enable_slack_action_links:enable_slack_action_links,no_highlights:true})}else if(msg.subtype==="pinned_item"&&!msg.no_display){if(msg.item_type==="F"){var uploader=_getEntityFromFile(msg.item);html=TS.templates.message_pinned_file({file:msg.item,own_file:!!msg.item&&msg.item.user===msg.user,theme:TS.model.prefs.theme,uploader:uploader,model_ob:model_ob,display_name:TS.members.getMemberDisplayName(uploader)})}else if(msg.item_type==="Fc"){html=TS.templates.message_pinned_comment({theme:TS.model.prefs.theme,model_ob:model_ob});var commenter;if(msg.item)commenter=TS.members.getMemberById(msg.item.user);if(commenter&&msg.item.comment){html+=TS.templates.builders.buildAttachmentHTML({attachment:{author_icon:commenter.profile.image_24,author_name:commenter.profile.real_name,
author_subname:commenter.name,color:"D0D0D0",ts:msg.item.timestamp,text:msg.item.comment,mrkdwn_in_hash:{text:true}},msg:msg})}}else if(msg.item_type==="C"||msg.item_type==="G"||msg.item_type==="D"){html=TS.templates.message_pinned_message({theme:TS.model.prefs.theme,model_ob:model_ob});var author;if(msg.item)author=TS.members.getMemberById(msg.item.user);if(author&&msg.item.text){html+=TS.templates.builders.buildAttachmentHTML({attachment:{author_icon:author.profile.image_24,author_name:author.profile.real_name,author_subname:author.name,color:"D0D0D0",ts:msg.item.ts,text:msg.item.text,mrkdwn_in_hash:{text:true}},msg:msg})}}}else{html=TS.format.formatWithOptions(msg.text,msg,{do_inline_imgs:do_inline_imgs,enable_slack_action_links:enable_slack_action_links})}if(!html&&html!==""){TS.warn("no html msg.subtype:"+msg.subtype);return""}html=TS.utility.msgs.handleSearchHighlights(html);return html},msgHtmlForSearch:function(msg,model_ob,result_type,main_msg,prev_msg){if(msg.subtype!=="bot_message"){msg.subtype=null}var html="";if(result_type==="extract"){html+='<div class="search_result_with_extract">';html+='<div class="extract_expand_icons"><i class="ts_icon ts_icon_chevron_up up_arrow"></i><i class="ts_icon ts_icon_chevron_down down_arrow"></i></div>'}else if(result_type==="context"){html+='<div class="search_result_for_context">'}else{html+='<div class="search_result_for_extra_context">'}html+=TS.templates.builders.buildMsgHTML({msg:msg,msg_dom_id:TS.boot_data.feature_message_replies&&TS.templates.makeMsgDomIdInSearch(msg.ts,main_msg),model_ob:model_ob,container_id:"search_message_results",standalone:true,for_search_display:true,search_result_type:result_type,prev_msg:TS.boot_data.feature_message_replies&&prev_msg});html+="</div>";return html},buildMsgHTMLForSearch:function(main_msg){var model_ob=main_msg.channel;var html="";var messages=[];if(main_msg.previous_2)messages.push(main_msg.previous_2);if(main_msg.previous)messages.push(main_msg.previous);messages.push(main_msg);if(main_msg.next)messages.push(main_msg.next);if(main_msg.next_2)messages.push(main_msg.next_2);if(main_msg.next_2&&!main_msg.next_2.user&&main_msg.next_2.subtype==="file_comment"){var workaround=/^<@(U\w+)|/.exec(main_msg.next_2.text);if(workaround&&workaround.length===2){var user_id=workaround[1];var member=TS.members.getMemberById(user_id);if(member){main_msg.next_2.user=member.id;main_msg.next_2.username=member.name}}}if(messages.length>1&&!TS.search.view.resultHasExtracts(main_msg)){main_msg.force_extract_type="extract";if(main_msg.previous)main_msg.previous.force_extract_type="context";if(main_msg.next)main_msg.next.force_extract_type="context"}var prev_msg;messages.forEach(function(msg,inx){var result_type;if(msg.force_extract_type){result_type=msg.force_extract_type}else{result_type=TS.search.view.determineMessageResultType(messages,inx)}html+=TS.templates.builders.msgHtmlForSearch(msg,model_ob,result_type,main_msg,prev_msg);prev_msg=msg});return html},search_ellipsis:'<span class="extract_ellipsis">&hellip;</span>',buildStar:function(type,ob,parent_ob){if(!type)return"";if(type=="channel"&&ob&&typeof ob=="string"){ob=TS.channels.getChannelById(ob)}else if(type=="group"&&ob&&typeof ob=="string"){ob=TS.groups.getGroupById(ob)}else if(type=="im"&&ob&&typeof ob=="string"){ob=TS.ims.getImById(ob)}else if(type=="mpim"&&ob&&typeof ob=="string"){ob=TS.mpims.getMpimById(ob)}if(!ob)return"";if(type=="message"&&parent_ob&&typeof parent_ob=="string"){var c_id=parent_ob;parent_ob=TS.channels.getChannelById(c_id);if(!parent_ob)parent_ob=TS.ims.getImById(c_id);if(!parent_ob)parent_ob=TS.groups.getGroupById(c_id)}var html_attrs={};var html="";var attributes=[];var class_names=[];class_names=["star","ts_icon","ts_icon_star_o","ts_icon_inherit"];var id=ob.id||ob.ts;var parent_id=parent_ob?parent_ob.id:null;if(type=="message"){if(!parent_id)return"";html_attrs["data-msg-id"]=id;html_attrs["data-c-id"]=parent_id;if(TS.utility.msgs.isTempMsg(ob)){class_names.push("hidden")}}else if(type=="file"){html_attrs["data-file-id"]=id}else if(type=="file_comment"){html_attrs["data-comment-id"]=id;html_attrs["data-file-id"]=parent_id;class_names.push("star_comment")}else if(type=="channel"){html_attrs["data-channel-id"]=id}else if(type=="group"){html_attrs["data-group-id"]=id}else if(type=="im"){html_attrs["data-im-id"]=id}else if(type=="mpim"){html_attrs["data-mpim-id"]=id}else{TS.error("buildStar needs to handle star item type:"+type);return""}if(ob.is_starred){class_names.push("starred","ts_icon_star");class_names.splice(class_names.indexOf("ts_icon_star_o"),1)}class_names.push("star_"+type);$.each(html_attrs,function(key,value){attributes.push(key+'="'+value+'"')});html="<span "+attributes.join(" ")+' class="'+class_names.join(" ")+'"></span>';return html},buildMentionHTML:function(mention){var msg=mention.message;var html="";if(!msg)return html;if(msg.subtype=="file_share"||msg.subtype=="file_mention"||msg.subtype=="file_comment"){if(!msg.file)return html}var model_ob=TS.shared.getModelObById(mention.channel);if(!model_ob)return html;var rxns;var max_rxns_to_display=4;var rxns_to_display=[];var others="";var jump_link="";var msg_html="";var for_mention_rxn_display=mention.type=="reaction";jump_link=TS.templates.builders.strBuilder('<a class="msg_right_link msg_jump" data-cid="${cid}">Jump</a>',{cid:model_ob.id});msg_html=TS.templates.builders.buildMsgHTML({msg:msg,model_ob:model_ob,standalone:true,jump_link:jump_link,no_attachments:!!msg.text,for_mention_display:true,for_mention_rxn_display:for_mention_rxn_display});html=msg_html;if(for_mention_rxn_display){rxns=TS.rxns.getExistingRxnsByKey(msg._rxn_key);if(!rxns)return"";var newest_rxn=rxns[rxns.length-1];var newest_rxn_member_id=newest_rxn.users[newest_rxn.users.length-1];if(!TS.rxns.getRxnFromRxns(rxns,newest_rxn.name))return"";var all_rxners_but_newest=TS.rxns.getAllUniqueRxners(rxns,newest_rxn_member_id);var total_count=all_rxners_but_newest.length+1;if(total_count==2){var other_member=TS.members.getMemberById(all_rxners_but_newest[0]);others=" & "+TS.templates.builders.makeMemberPreviewLink(other_member)}else if(total_count>2){others=" & "+(total_count-1)+" others"}rxns.forEach(function(rxn,index){if(index<max_rxns_to_display){rxns_to_display.push(TS.emoji.graphicReplace(":"+rxn.name+":"))}});var newest_member=TS.members.getMemberById(newest_rxn_member_id);html=TS.templates.mentions_rxn({ts:msg.ts,rxns_to_display:rxns_to_display,msg_html:msg_html,rxn_members:TS.templates.builders.makeMemberPreviewLink(newest_member,true)+others,jump_link:jump_link,jump_link_html:jump_link})}return html},buildMentions:function(){TS.mentions.weaveInRxnRecords();var html="";var prev_mention=null;var member=TS.model.user;if(!member.mentions||!member.mentions.length)return html;$.each(member.mentions,function(i,mention){var h=TS.templates.builders.buildMentionHTML(mention);if(!h)return;var before_html="";var model_ob=TS.shared.getModelObById(mention.channel);var msg=mention.message;var showing_day_divider=!prev_mention;if(prev_mention&&!TS.utility.date.sameDay(TS.utility.date.toDateObject(prev_mention.rxn_ts||prev_mention.message.ts),TS.utility.date.toDateObject(mention.rxn_ts||msg.ts))){showing_day_divider=true}if(showing_day_divider){if(prev_mention){before_html="</div>"}before_html+='<div class="mention_day_container_div">'+TS.templates.messages_day_divider({ts:mention.rxn_ts||msg.ts})}else{before_html+='<hr class="spacer">'}var prev_cid=prev_mention&&prev_mention.channel;if(model_ob&&(model_ob.is_channel||model_ob.is_mpim||model_ob.is_group)){if(prev_cid!=model_ob.id||showing_day_divider){before_html+=TS.templates.mentions_item({model_ob:model_ob})}}html+=before_html+h;prev_mention=mention});if(html){html+="</div>"}return html},buildStarredItemHTML:function(star){var html="<div class='star_item'>";var template_args={star:star,current_user_id:TS.model.user.id};var model_ob;if(star.type=="message"){var msg=star.message;var im_with_disabled_user=false;model_ob=TS.shared.getModelObById(star.channel);if(!model_ob){TS.warn("channel "+star.channel+" for this starred message was probably deleted");return""}if(model_ob.is_im){var recipient=TS.members.getMemberById(model_ob.user);star["message"]["recipient"]=recipient;if(TS.ims.isImWithDeletedMember(model_ob)){im_with_disabled_user=true}}var jump_link="";if(!im_with_disabled_user){if(TS.boot_data.feature_files_list){jump_link='<a class="star_jump msg_right_link btn btn_outline" data-cid="'+model_ob.id+'">Jump</a>'}else{jump_link='<a class="star_jump msg_right_link" data-cid="'+model_ob.id+'">Jump</a>'}}if(!TS.boot_data.feature_files_list){var subtype=msg.subtype;if(subtype==="file_share"||subtype==="file_mention"||subtype==="file_comment"){html+=TS.templates.builders.buildStar("message",msg,model_ob)}}html+=TS.templates.builders.buildMsgHTML({msg:msg,model_ob:model_ob,standalone:true,starred_items_list:true,starred_items_actions:TS.boot_data.feature_files_list,jump_link:jump_link,no_attachments:!!msg.text,full_date:true})}else if(star.type=="file"){if(!TS.boot_data.feature_files_list){html+=TS.templates.builders.buildStar("file",star.file)}html+=TS.templates.builders.fileHTML(star.file)}else if(star.type=="channel"||star.type=="group"){model_ob=TS.channels.getChannelById(star.channel);if(!model_ob)model_ob=TS.groups.getGroupById(star.channel);if(!model_ob){TS.warn("channel or group "+star.channel+" was probably deleted");return""}template_args["model_ob"]=model_ob;html+=TS.templates.star_item(template_args)}else{template_args.from_starred_item=TS.boot_data.feature_files_list;html+=TS.templates.star_item(template_args)}html+="</div>";return html},buildInlineImgTogglerAndDiv:function(key,container_id,args){var inline_img=TS.model.inline_imgs[key];if(!inline_img)return"";return TS.templates.builders.buildInlineImgToggler(key,container_id)+" "+TS.templates.builders.buildInlineImgDiv(key,container_id,undefined,args)},buildInlineImgToggler:function(key,container_id,no_bytes){var inline_img=TS.model.inline_imgs[key];if(!inline_img){console.warn("buildInlineImgToggler did not find anything in TS.model.inline_imgs for key:"+key);return""}var expand_it=TS.inline_imgs.shouldExpand(container_id,inline_img);var link_url=inline_img.link_url||key;var too_many_b=inline_img.bytes&&inline_img.bytes>TS.model.inline_img_byte_limit;var too_many_px=inline_img.width&&inline_img.height&&inline_img.width*inline_img.height>TS.model.inline_img_pixel_limit;var show_expander=!too_many_px;var too_large_explain="";if(!expand_it&&(!TS.model.prefs.obey_inline_img_limit||too_many_b)||too_many_px){var would_expand=!inline_img.internal_file_id&&TS.model.prefs.expand_inline_imgs&&TS.model.expandable_state["img_"+container_id+inline_img.src]!==false;if(would_expand&&too_many_px){show_expander=false;too_large_explain='<span class="too_large_for_auto_expand"> (Not automatically expanded because '+inline_img.width+"x"+inline_img.height+" is too large to display inline.)</span>"}else if(would_expand&&too_many_b){too_large_explain='<span class="too_large_for_auto_expand"> (Not automatically expanded because '+TS.utility.convertFilesize(inline_img.bytes)+' is too large. You can <a class="cursor_pointer too_large_but_expand_anyway" data-real-src="'+TS.utility.htmlEntities(inline_img.src)+'">expand it anyway</a> or <a '+TS.utility.makeRefererSafeLink(link_url)+' target="_blank" title="Open original in new tab">open it in a new window</a>.';if(TS.model.show_inline_img_size_pref_reminder&&!TS.model.shown_inline_img_size_pref_reminder_once){too_large_explain+=" You can also <a class=\"cursor_pointer\" onclick=\"TS.ui.prefs_dialog.start('messages_media', '#prefs_inline_media')\">change your preferences</a> to allow images of any file size to auto expand.)";TS.model.shown_inline_img_size_pref_reminder_once=true}too_large_explain+="</span>"}}var bytes=inline_img.bytes&&no_bytes!==true?'<span class="inline_img_bytes '+(too_large_explain?"hidden":"")+'"> ('+TS.utility.convertFilesize(inline_img.bytes)+")</span>":"";return bytes+too_large_explain+(show_expander?'<i data-real-src="'+TS.utility.htmlEntities(inline_img.src)+'" class="msg_inline_img_collapser ts_icon ts_icon_caret_down '+(expand_it?"":"hidden")+'"></i>'+'<i data-real-src="'+TS.utility.htmlEntities(inline_img.src)+'" class="msg_inline_img_expander ts_icon ts_icon_caret_right '+(expand_it?"hidden":"")+'"></i>':"")},buildInlineImgDiv:function(key,container_id,force_expand_it,args){var inline_img=TS.model.inline_imgs[key];if(!inline_img)return"";var expand_it=force_expand_it===true||TS.inline_imgs.shouldExpand(container_id,inline_img);var link_url=inline_img.link_url||key;var preserve_aspect_ratio=inline_img.width>0&&inline_img.height>0&&TS.utility.cssCalcSupported();var file;if(inline_img.internal_file_id)file=TS.files.getFileById(inline_img.internal_file_id);var hide_by_default=!!TS.client;var html="";var div_class="clear_both msg_inline_img_holder msg_inline_holder";if(!expand_it)div_class+=" hidden";var overflow_buttons_height=inline_img.height<50;var overflow_buttons_width=inline_img.width<200;var overflow_buttons=overflow_buttons_width||overflow_buttons_height;if(overflow_buttons){div_class+=" overflow_preview_actions";if(overflow_buttons_width){div_class+=" overflow_preview_actions_width"}}if(file){div_class+=" file_container"}div_class+=" msg_inline_holder_rounded";if(!preserve_aspect_ratio)div_class+=" file_container_fixed_dimensions";html+='<div data-real-src="'+TS.utility.htmlEntities(inline_img.src)+'" class="'+div_class+'" ';if(inline_img.internal_file_id)html+='data-file-id="'+inline_img.internal_file_id+'" ';if(preserve_aspect_ratio)html+='style="width:'+inline_img.width+'px;" ';html+=">";var cmd_key="ctrl";if(TS.model.is_mac)cmd_key="cmd";var may_show_lightbox=args&&args.hasOwnProperty("maybe_show_lightbox")?args.maybe_show_lightbox:true;var show_lightbox_link;if(inline_img.internal_file_id){if(file&&file.mimetype.indexOf("image/")===0){show_lightbox_link=may_show_lightbox;if(file.external_type=="dropbox"||file.external_type=="gdrive"||file.external_type=="box"||file.external_type=="onedrive"){var file_to_show=file.thumb_720?file.thumb_720:file.thumb_360;html+="<a "+TS.utility.makeRefererSafeLink(link_url)+' target="_blank" title="cmd+click to open original in new tab" class="lightbox_external_link" data-src="'+TS.utility.htmlEntities(file_to_show)+'"data-link-url="'+link_url+'">'}else{if(show_lightbox_link){html+='<a href="'+link_url+'" target="_blank" class="lightbox_channel_link lightbox_link" data-file-id="'+inline_img.internal_file_id+'">'}else{html+='<a href="'+link_url+'" target="_blank" title="'+cmd_key+'+click to open original in new tab" class="file_preview_link thumbnail_link" data-file-id="'+inline_img.internal_file_id+'">'}}}else{html+="<a "+TS.utility.makeRefererSafeLink(link_url)+' target="_blank" class="'+file.filetype+'">'}}else{var img_class="";var img_title="";if(may_show_lightbox){img_class="lightbox_external_link"}else{img_title="Click to open original in new tab"}html+="<a "+TS.utility.makeRefererSafeLink(link_url)+' target="_blank" title="'+img_title+'" class="'+img_class+'" data-src="'+TS.utility.htmlEntities(inline_img.src)+'" data-link-url="'+inline_img.link_url+'"';if(inline_img.width)html+=' data-width="'+inline_img.width+'"';if(inline_img.height)html+=' data-height="'+inline_img.height+'"';html+=">"}if(preserve_aspect_ratio)html=html.replace("<a ",'<a style="width:'+inline_img.width+'px;" ');html+='<div class="msg_inline_img_container">';html+='<div class="file_preview_preserve_aspect_ratio" ';if(preserve_aspect_ratio){if(!file||!overflow_buttons){var css_calc_string="calc("+inline_img.height+" / "+inline_img.width+" * 100% )";html+='style="padding-top: -moz-'+css_calc_string+"; padding-top: -webkit-"+css_calc_string+"; padding-top: "+css_calc_string+';" '}else{html+='style="padding-top: '+inline_img.height+'px;" '}}html+=">";var src=TS.utility.htmlEntities(inline_img.proxied_src||inline_img.src);var figure_class=hide_by_default?"msg_inline_img msg_inline_child hidden":"msg_inline_img msg_inline_child";var figure_attr=hide_by_default?'data-real-background-image="'+src+'"':'style="background-image:url('+src+');"';var img_attr=hide_by_default?'data-real-src="'+src+'"':'src="'+src+'"';html+='<figure class="'+figure_class+'" '+figure_attr+">";html+="<img "+img_attr+" />";html+="</figure>";html+="</div>";html+="</div>";html+="</a>";if(file){html+=TS.templates.message_file_preview_actions({file:file,download:file.mode==="hosted",new_window:true})}html+="</div>";return html},buildInlineEmailDiv:function(file_id,container_id){var file=TS.files.getFileById(file_id);if(!file)return"";var template_args={file:file,is_message:true,to_more_count:file.to.length-1,cc_more_count:file.cc.length-1,msg_dom_id:container_id};var html=TS.templates.file_email(template_args);return html},buildInlineAttachmentToggler:function(key,container_id){var inline_attachment=TS.model.inline_attachments[key];if(!inline_attachment)return"";var expand_it=TS.inline_attachments.shouldExpand(container_id,inline_attachment);var template_args={real_src:inline_attachment.from_url,expand_it:expand_it};var html=TS.templates.inline_attachment_toggler({inline_attachment:template_args});return html},buildInlineFilePreviewToggler:function(file_id,container_id,options){var expand_it=TS.inline_file_previews.shouldExpand(container_id,file_id);var hide_title_when_expanded=options.hash.hide_title_when_expanded;return" "+'<i class="msg_inline_file_preview_collapser ts_icon ts_icon_caret_down'+(expand_it?"":" hidden")+(hide_title_when_expanded?" title_hidden":"")+'" data-file-id="'+file_id+'"></i>'+'<i class="msg_inline_file_preview_expander ts_icon ts_icon_caret_right'+(expand_it?" hidden":"")+'" data-file-id="'+file_id+'"></i>'},buildInlineRoomPreviewToggler:function(room_id){var expand_it=TS.inline_room_previews.shouldExpand(room_id);var hide_title_when_expanded=true;return" "+'<i class="msg_inline_room_preview_collapser ts_icon ts_icon_caret_down'+(expand_it?"":" hidden")+(hide_title_when_expanded?" title_hidden":"")+'"></i>'+'<i class="msg_inline_room_preview_expander ts_icon ts_icon_caret_right'+(expand_it?" hidden":"")+'"></i>'},makeMemberImage:function(id,size,lazy,with_title){var member=TS.members.getMemberById(id);if(!member||!member.profile)return"";lazy=lazy===true;with_title=with_title===true;var img_src,img_class;switch(size){case 16:img_src=member.profile.image_24;img_class="thumb_16";break;case 20:img_src=member.profile.image_24;img_class="thumb_20";break;case 24:img_src=member.profile.image_24;img_class="thumb_24";break;case 32:img_src=member.profile.image_32;img_class="thumb_32";break;case 36:img_src=member.profile.image_48;img_class="thumb_36";break;case 48:img_src=member.profile.image_48;img_class="thumb_48";break;case 72:img_src=member.profile.image_72;img_class="thumb_72";break;case 192:img_src=member.profile.image_192;img_class="thumb_192";break;default:img_src=member.profile.image_48;img_class="thumb_48";break}var title=with_title?'title="'+TS.members.getMemberDisplayName(member,true)+'"':"";var html;if(lazy){html='<img data-original="'+img_src+'" class="lazy member_image '+img_class+' member_preview_image" data-member-id="'+member.id+'" '+title+" />"}else{html='<img src="'+img_src+'" class="member_image '+img_class+' member_preview_image" data-member-id="'+member.id+'" '+title+" />"}return html},buildInlineAudioToggler:function(key,container_id){var inline_audio=TS.model.inline_audios[key];if(!inline_audio)return"";var expand_it=TS.inline_audios.shouldExpand(container_id,inline_audio);var template_args={src:inline_audio.src,expand_it:expand_it};var html=TS.templates.attachment_inline_audio_toggler({inline_audio:template_args});return html},buildInlineAudioDiv:function(key,container_id,content,force_expand_it){var inline_audio=TS.model.inline_audios[key];if(!inline_audio)return"";var expand_it=force_expand_it===true||TS.inline_audios.shouldExpand(container_id,inline_audio);var template_args={src:inline_audio.src,expand_it:expand_it,content:content};var html=TS.templates.attachment_inline_audio_div({inline_audio:template_args});return html},buildInlineOtherToggler:function(key,container_id){var inline_other=TS.model.inline_others[key];if(!inline_other)return"";var expand_it=TS.inline_others.shouldExpand(container_id,inline_other);var template_args={src:inline_other.src,expand_it:expand_it};var html=TS.templates.inline_other_toggler({inline_other:template_args});return html},buildInlineOtherDiv:function(key,container_id,content,force_expand_it){var inline_other=TS.model.inline_others[key];if(!inline_other)return"";var expand_it=force_expand_it===true||TS.inline_others.shouldExpand(container_id,inline_other);return'<div data-real-src="'+TS.utility.htmlEntities(inline_other.src)+'" class="clear_both msg_inline_other_holder msg_inline_holder '+(expand_it?"":"hidden")+'">'+content+"</div>"},buildInlineVideoTogglerAndDiv:function(key,container_id){var inline_video=TS.model.inline_videos[key];if(!inline_video)return"";return TS.templates.builders.buildInlineVideoToggler(key,container_id)+" "+TS.templates.builders.buildInlineVideoDiv(key,container_id)},buildInlineVideoToggler:function(key,container_id,no_title){var inline_video=TS.model.inline_videos[key];if(!inline_video)return"";var expand_it=TS.inline_videos.shouldExpand(container_id,inline_video);var template_args={src:inline_video.src,expand_it:expand_it,no_title:no_title,title:inline_video.title};var html=TS.templates.attachment_inline_video_toggler({inline_video:template_args});return html},buildInlineVideoDiv:function(key,container_id,force_expand_it){var inline_video=TS.model.inline_videos[key];if(!inline_video)return"";var expand_it=force_expand_it===true||TS.inline_videos.shouldExpand(container_id,inline_video);var link_url=inline_video.link_url||key;var hide_by_default=!!TS.client;var show_play=true;if(!inline_video.html){show_play=false}var template_args={real_src:inline_video.src,data_url:key,referrer_safe_url_attributes:TS.utility.makeRefererSafeLink(link_url),hide_by_default:hide_by_default,show_play:show_play,proxied_src_or_src:inline_video.proxied_src||inline_video.src,display_w:inline_video.display_w,display_h:inline_video.display_h,expand_it:expand_it};var html=TS.templates.message_inline_video({inline_video:template_args});return html},buildComments:function(file){var comments=file.comments;var html="";for(var i=0;i<comments.length;i++){html+=TS.templates.builders.buildCommentHTML({file:file,comment:comments[i],show_comment_actions:true})}return html},buildCommentHTML:function(template_args){if(TS.boot_data.feature_jumbomoji&&TS.model.prefs.jumbomoji){template_args.only_emoji=TS.utility.msgs.isOnlySingleEmoji(template_args.comment.comment)}return TS.templates.comment(template_args)},buildCommentStandalone:function(comment,file){var entity=_getEntityFromFile(file);return TS.templates.comment_standalone({comment:comment,file:file,entity:entity,current_user_id:TS.model.user.id})},buildTeamListHTML:function(all_members,is_long_list_view){is_long_list_view=is_long_list_view===true;var team_list_members=TS.members.allocateTeamListMembers(all_members);var members=team_list_members.members;var disabled_members=team_list_members.disabled_members;var deleted_bots=team_list_members.deleted_bots;var bots=team_list_members.bots;var restricted_members=team_list_members.restricted_members;var ultra_restricted_members=team_list_members.ultra_restricted_members;var show_bots=false;if(bots.length||deleted_bots.length){show_bots=true}var show_restricted_members=false;if(restricted_members.length||ultra_restricted_members.length){show_restricted_members=true}var show_user_groups=false;var show_user_groups_help=false;var user_groups;if(TS.boot_data.feature_subteams){show_user_groups=TS.model.team.plan!==""&&!TS.model.user.is_restricted;user_groups=TS.model.user_groups.filter(function(ug){return!ug.date_delete});show_user_groups_help=!user_groups.length;var $team_tabs=$("#team_tabs");var show_user_groups_edit=TS.members.canUserEditUserGroups();var show_user_groups_add=TS.members.canUserCreateAndDeleteUserGroups();$team_tabs.html(TS.templates.user_group_tabs({members:members,show_restricted_members:show_restricted_members,restricted_members:restricted_members.concat(ultra_restricted_members),disabled_members:disabled_members,show_user_groups:show_user_groups,user_groups:user_groups,show_user_groups_edit:show_user_groups_edit,show_user_groups_add:show_user_groups_add}));TS.members.view.bindTeamFilter("#team_filter","#team_list_scroller",true);$("#team_filter input").bind("focus",function(){$("#team_filter .icon_search").addClass("indifferent_grey")}).bind("blur",function(){$("#team_filter .icon_search").removeClass("indifferent_grey")});if(show_user_groups){var $team_tab_actions=$team_tabs.find(".tab_action:not(#search)");var $team_block=$("#team_block");$team_tabs.find("li a").on("click",function(){var action=$(this).data("action");var show_user_groups_edit=TS.members.canUserEditUserGroups();var show_user_groups_add=TS.members.canUserCreateAndDeleteUserGroups();$team_tab_actions.addClass("hidden");if(action==="user_group_edit"){if(!show_user_groups_edit&&!show_user_groups_add)return;$team_tab_actions.removeClass("hidden");$team_block.addClass("hidden")}else{$team_block.removeClass("hidden")}$team_tabs.find("#"+action).removeClass("hidden")})}}else{$("#team_tabs").html(TS.templates.team_tabs({members:members,show_restricted_members:show_restricted_members,restricted_members:restricted_members.concat(ultra_restricted_members),disabled_members:disabled_members}))}$("#team_tabs").find("li.tab").on("click",function(e){var target_name=$(e.currentTarget).find("a").data("name");TS.model.ui_state.tab_name=target_name;TS.storage.storeUIState(TS.model.ui_state);var $search=$("#search");if(TS.client)TS.client.ui.updateClosestMonkeyScroller($("#team_list_members"));if(TS.web&&TS.web.members&&TS.web.members.lazyload){TS.web.members.lazyload.trigger("resize")}$("#team_list_members").trigger("resize");if(target_name=="user_groups"){TS.view.rebuildUserGroupList();$search.toggleClass("hidden",!TS.model.user_groups.length)}else{$search.removeClass("hidden")}});return TS.templates.team_list({members:members,bots:bots,show_bots:show_bots,show_restricted_members:show_restricted_members,restricted_members:restricted_members,ultra_restricted_members:ultra_restricted_members,disabled_members:disabled_members,deleted_bots:deleted_bots,show_user_groups:show_user_groups,user_groups:user_groups,show_user_groups_help:show_user_groups_help,is_long_list_view:is_long_list_view})},buildUserGroupHTML:function(user_group,is_flexpane){return TS.templates.user_group_list_item({user_group:user_group,is_flexpane:is_flexpane})},buildUserGroupListHTML:function(all_user_groups,is_flexpane){var user_group;var user_groups=[];var disabled_user_groups=[];var show_delete=TS.boot_data.feature_subteams_hard_delete;var show_toggle=TS.members.canUserCreateAndDeleteUserGroups();for(var i=0;i<all_user_groups.length;i++){user_group=all_user_groups[i];if(user_group.date_delete){user_group.can_delete=!user_group.auto_type&&!user_group.is_external;disabled_user_groups.push(user_group)}else{user_groups.push(user_group)}}var show_user_groups_help=!is_flexpane&&!user_groups.length&&!disabled_user_groups.length||is_flexpane&&!user_groups.length;return TS.templates.user_group_list({user_groups:user_groups,disabled_user_groups:disabled_user_groups,show_delete:show_delete,show_toggle:show_toggle,is_flexpane:is_flexpane,show_user_groups_help:show_user_groups_help})},makeInternalChannelLink:function(channel){if(!channel)return"ERROR: MISSING CHANNEL";var target=TS.utility.shouldLinksHaveTargets()?'target="/archives/'+channel.name+'"':"";return'<a href="/archives/'+channel.name+'" '+target+' class="internal_channel_link" data-channel-id="'+channel.id+'"><span class="normal">#</span>'+channel.name+"</a>"},makeInternalGroupLink:function(group){if(!group)return"ERROR: MISSING GROUP";var target=TS.utility.shouldLinksHaveTargets()?'target="/archives/'+group.name+'"':"";return'<a href="/archives/'+group.name+'" '+target+'" class="internal_group_link" data-group-id="'+group.id+'">'+TS.model.group_prefix+group.name+"</a>"},makeChannelLink:function(channel){if(!channel)return"ERROR: MISSING CHANNEL";var target=TS.utility.shouldLinksHaveTargets()?'target="/archives/'+channel.name+'"':"";return'<a href="/archives/'+channel.name+'" '+target+' class="channel_link" data-channel-id="'+channel.id+'"><span class="normal">#</span>'+channel.name+"</a>"},makeGroupLink:function(group){if(!group)return"ERROR: MISSING GROUP";var target=TS.utility.shouldLinksHaveTargets()?'target="/archives/'+group.name+'"':"";return'<a href="/archives/'+group.name+'" '+target+' class="group_link" data-group-id="'+group.id+'">'+TS.model.group_prefix+group.name+"</a>"},makeTeamsThatHaveComplianceExportsBlurb:function(teams){if(!teams||!teams.length){TS.logError({message:"Missing teams"});return""}var blurb="";var exports_teams=teams.filter(function(team){return team.team.has_compliance_export});exports_teams.forEach(function(team,index){if(index>0){if(exports_teams.length>2)blurb+=", ";if(index===exports_teams.length-1)blurb+=" and "}blurb+=team.name});if(exports_teams.length>1){blurb+=" have"}else{blurb+=" has"}blurb+=' <a href="https://get.slack.help/hc/en-us/articles/204897248-Understanding-Slack-data-exports" target="_blank">Compliance Exports</a> enabled which allows their team owners to export communication history.';return blurb},makeMpimLink:function(mpim,with_title){if(!mpim)return"ERROR: MISSING MPIM";var target;var title;var href=TS.mpims.getMpimArchivesPath(mpim);if(TS.utility.shouldLinksHaveTargets())target=TS.mpims.getMpimArchivesPath(mpim);if(with_title)title=TS.mpims.getTooltipText(mpim);return TS.templates.mpim_link({target:target,href:href,title:title,mpim:mpim})},makeMemberPreviewLink:function(member,show_you_for_current_user){if(!member)return"";if(show_you_for_current_user!==true)show_you_for_current_user=false;var safe_name=TS.utility.htmlEntities(member.name);var member_color_class=TS.templates.builders.makeMemberColorClass(member);var html;var target;var member_type_badge;if(member.is_service){target=TS.utility.shouldLinksHaveTargets()?'target="/services/'+member.id+'"':"";html='<a href="/services/'+member.id+'" '+target+' class="message_sender service_link '+member_color_class+'" data-service-id="'+member.id+'">'}else{target=TS.utility.shouldLinksHaveTargets()?'target="/team/'+safe_name+'"':"";member_type_badge=TS.templates.builders.makeMemberTypeBadgeClass(member);html='<a href="/team/'+safe_name+'" '+target+' class="message_sender member member_preview_link '+member_color_class+" "+member_type_badge+'" data-member-id="'+member.id+'">'}if(show_you_for_current_user&&member.id==TS.model.user.id){html+="You"}else{html+=TS.utility.htmlEntities(TS.members.getMemberDisplayName(member,false))}if(TS.boot_data.feature_cross_team_ui){html+=TS.templates.builders.makeMemberTypeBadgeCompact(member)}html+="</a>";if(member.is_bot||member.is_service){html+='<span class="bot_label">BOT</span>'}return html},makeProfileImage:function(entity,options){if(!entity){return false}var is_lazy=options.hash.is_lazy||false;var image_set=entity.profile||entity.icons||{};var default_size;if(image_set.emoji){default_size="64"}else{default_size="48"}var desired_size=options.hash.size||default_size;var size=Object.keys(TS.constants.avatar_size_map).reduce(function(carry_size,current_size){if(current_size===desired_size&&_getImage(image_set,current_size)){return current_size}else{return carry_size}},default_size);var template_data={entity:entity,size:desired_size,css_classes:_getClasses(entity,desired_size),image:_formatImageURI(entity,_getImage(image_set,size)),is_lazy:is_lazy,is_targettable:TS.utility.shouldLinksHaveTargets()};function _formatImageURI(entity,image){var image_uri=[];if(entity.is_restricted||entity.is_ultra_restricted){
if(TS.model.is_retina){image_uri.push("url('"+cdn_url+"/0180/img/avatar_overlays_@2x.png"+"')")}else{image_uri.push("url('"+cdn_url+"/0180/img/avatar_overlays.png"+"')")}}image_uri.push("url('"+image+"')");return image_uri.join(",")}function _getImage(imageset,size){var key="image_"+size;if(imageset.hasOwnProperty(key)){if(TS.model.is_retina){return imageset[TS.constants.avatar_size_map[size].retina]||imageset[TS.constants.avatar_size_map[size].standard]}else{return imageset[TS.constants.avatar_size_map[size].standard]}}else{return false}}function _getClasses(entity,size){var classes=[];classes.push("thumb_"+size);if(entity.is_bot){classes.push("is_bot")}return classes.join(" ")}return new Handlebars.SafeString(TS.templates.member_profile_image(template_data))},makeMemberPreviewLinkImage:function(id,size,lazy,omit_link,omit_badge,omit_restricted_overlay){var member=TS.members.getMemberById(id);if(!member||!member.profile)return"";lazy=lazy===true;omit_link=omit_link===true;omit_badge=omit_badge===true;omit_restricted_overlay=omit_restricted_overlay===true;var img_src,avatar_class,badge_html;var bg_img_style,bg_img_urls;badge_html="";bg_img_style="background-image: ";bg_img_urls=[];switch(size){case 20:if(TS.model.is_retina){img_src=member.profile.image_48}else{img_src=member.profile.image_24}avatar_class="thumb_20";break;case 24:if(TS.model.is_retina){img_src=member.profile.image_48}else{img_src=member.profile.image_24}avatar_class="thumb_24";break;case 32:if(TS.model.is_retina){img_src=member.profile.image_72}else{img_src=member.profile.image_32}avatar_class="thumb_32";break;case 36:if(TS.model.is_retina){img_src=member.profile.image_72}else{img_src=member.profile.image_48}avatar_class="thumb_36";break;case 48:if(TS.model.is_retina){img_src=member.profile.image_72}else{img_src=member.profile.image_48}avatar_class="thumb_48";break;case 72:if(TS.model.is_retina){img_src=member.profile.image_192}else{img_src=member.profile.image_72}avatar_class="thumb_72";break;case 192:img_src=member.profile.image_192;avatar_class="thumb_192";break;case 512:img_src=member.profile.image_512||member.profile.image_192;avatar_class="thumb_512";break;default:if(TS.model.is_retina){img_src=member.profile.image_72}else{img_src=member.profile.image_48}avatar_class="thumb_48";break}if(TS.boot_data.feature_shared_channels_ui){if(!omit_badge){var badge_size;switch(size){case 20:case 24:badge_size=10;break;case 32:case 36:case 48:badge_size=16;break;case 72:badge_size=24;break;case 192:badge_size=48;break;case 512:badge_size=96;break;default:badge_size=16}badge_html=TS.templates.builders.makeMemberTypeBadge(member,badge_size,true)}}else{if(member.is_restricted&&!omit_restricted_overlay){if(TS.model.is_retina){bg_img_urls.push("url('"+cdn_url+"/0180/img/avatar_overlays_@2x.png"+"')")}else{bg_img_urls.push("url('"+cdn_url+"/0180/img/avatar_overlays.png"+"')")}}if(member.is_ultra_restricted&&!omit_restricted_overlay){avatar_class+=" ura"}else if(member.is_restricted&&!omit_restricted_overlay){avatar_class+=" ra"}else if(member.is_bot){avatar_class+=" bot"}}var html;var target=TS.utility.shouldLinksHaveTargets()?'target="/team/'+member.name+'"':"";bg_img_urls.push("url('"+img_src+"')");if(size===512){var pre_bg_img_src=TS.model.is_retina?member.profile.image_72:member.profile.image_48;bg_img_urls.push("url('"+pre_bg_img_src+"')")}if(lazy){bg_img_style=bg_img_urls.length?bg_img_urls.join(", "):"";if(omit_link){html='<span class="lazy member_preview_link member_image '+avatar_class+'" data-member-id="'+member.id+'" data-thumb-size="'+size+'" data-original="'+bg_img_style+'" style="background-color: #f6f6f6" aria-hidden="true">'+badge_html+"</span>"}else{html='<a href="/team/'+member.name+'" '+target+' class="lazy member_preview_link member_image '+avatar_class+'" data-member-id="'+member.id+'" data-thumb-size="'+size+'" data-original="'+bg_img_style+'" style="background-color: #f6f6f6" aria-hidden="true">'+badge_html+"</a>"}}else{bg_img_style=bg_img_urls.length?bg_img_style+bg_img_urls.join(", "):"";if(omit_link){html='<span class="member_preview_link member_image '+avatar_class+'" data-member-id="'+member.id+'" data-thumb-size="'+size+'" style="'+bg_img_style+'" aria-hidden="true">'+badge_html+"</span>"}else{html='<a href="/team/'+member.name+'" '+target+' class="member_preview_link member_image '+avatar_class+'" data-member-id="'+member.id+'" data-thumb-size="'+size+'" style="'+bg_img_style+'" aria-hidden="true">'+badge_html+"</a>"}}return html},makeMemberPreviewCardLinkImage:function(id){var member=TS.members.getMemberById(id);if(!member||!member.profile)return"";var bg_img=TS.templates.builders.makeMemberPreviewCardLinkImageBackground(id);var target=TS.utility.shouldLinksHaveTargets()?'target="/team/'+member.name+'"':"";return['<a href="/team/',member.name,'" ',target,' class="member_preview_link member_image thumb_512" data-member-id="',member.id,'" data-thumb-size="512" style="background-image: ',bg_img,'" aria-hidden="true"></a>'].join("")},makeMemberPreviewCardLinkImageBackground:function(id){var member=TS.members.getMemberById(id);if(!member||!member.profile)return"";var img_src=member.profile.image_512||member.profile.image_192;var pre_bg_img_src=TS.model.is_retina?member.profile.image_72:member.profile.image_48;var gradient_prefix=TS.model.is_mac_10_7||TS.model.is_mac_10_8?"-webkit-":"";var bg_img_components=[gradient_prefix+"linear-gradient(rgba(0,0,0,0), rgba(0,0,0,0) 34%, rgba(0,0,0,0.2) 66%, rgba(0,0,0,0.2) 83%, rgba(0,0,0,0.6))","url('"+img_src+"')","url('"+pre_bg_img_src+"')"];return bg_img_components.join(", ")},newWindowName:function(text){if(TS.boot_data.app=="web"){return"_self"}return"new_"+_session_ms.toString()},getBotIdentifier:function(msg){if(!msg.bot_id&&!msg.username)return null;var bot=msg.bot_id?TS.bots.getBotById(msg.bot_id):null;var name=!msg.username&&bot&&bot.name?bot.name:msg.username;var id=bot?bot.id:"NOBOTID";return id+"_"+name},getBotName:function(msg){var username=msg.username;if(!username){var bot=msg.bot_id?TS.bots.getBotById(msg.bot_id):null;if(bot&&bot.name){username=bot.name}}return username},getBotNameWithLink:function(msg){var username=msg.username;var bot=msg.bot_id?TS.bots.getBotById(msg.bot_id):null;var bot_link=TS.templates.builders.makeBotLink(bot,msg.username);if(!username){if(bot&&bot.name){username=bot.name}}return bot_link.start_a+TS.utility.htmlEntities(username)+bot_link.end_a},makeBotLink:function(bot,username){var link_always=false;var start_a="";var end_a="";var class_extras=link_always?"bot_sender ":"";var link_extras=link_always?' data-bot-identifier="'+(bot&&!bot.deleted?bot.id:username)+'"':" ";if(bot&&!bot.deleted){if(TS.boot_data.feature_bot_profile){link_extras+='data-service-id="'+bot.id+'"';class_extras+="service"}start_a="<a"+link_extras+' class="'+class_extras+'" target="/services/'+bot.id+'" href="/services/'+bot.id+'">';end_a="</a>"}else if(link_always){start_a="<a"+link_extras+">";end_a="</a>"}return{start_a:start_a,end_a:end_a}},makeFiletypeHTML:function(file){if(file.external_type)return TS.templates.builders.makeExternalFiletypeHTML(file);var html="";html+='<a href="'+file.url_private_download+'" ';html+='target="'+file.url_private_download+'" ';html+='title="Download this file" ';html+='data-file-id="'+file.id+'" ';html+='class="subtle_silver file_ssb_download_link">';html+=TS.utility.convertFilesize(file.size)+" ";html+="<span>"+file.pretty_type+"</span>";if(file.mode==="snippet")html+=" snippet";html+="</a>";return html},makeExternalFiletypeHTML:function(file){if(!file.is_external)return;var external_filetype_html="";switch(file.external_type){case"gdrive":switch(file.filetype){case"gsheet":external_filetype_html="Spreadsheet";break;case"gdoc":external_filetype_html="Document";break;case"gpres":external_filetype_html="Presentation";break;case"gdraw":external_filetype_html="Drawing";break;default:external_filetype_html=["<span>","</span>"].join(file.pretty_type)}external_filetype_html+=" from Google Drive";break;case"dropbox":external_filetype_html=["<span>","</span> from Dropbox"].join(file.pretty_type);break;case"box":external_filetype_html=["<span>","</span> from Box"].join(file.pretty_type);break;case"onedrive":external_filetype_html=["<span>","</span> from OneDrive"].join(file.pretty_type);break;default:external_filetype_html="File"}return external_filetype_html},makeUnshareLink:function(channel_or_group,file){var title=channel_or_group.is_channel?"Unshare from #"+channel_or_group.name:"Unshare from "+channel_or_group.name;return'<a class="unshare_link ts_tip ts_tip_top ts_tip_float ts_tip_unshare_link" onclick="TS.files.promptForFileUnshare(\''+file.id+"', '"+channel_or_group.id+'\')"><span class="ts_tip_tip">'+title+'</span><i class="ts_icon ts_icon_minus_circle_small"></i></a>'},updateFileShareLabels:function(file){var labels=$('.file_share_label[data-file-id="'+file.id+'"]');labels.each(function(){$(this).replaceWith(TS.templates.builders.makeFileShareLabel(file))});if(file.is_shared){$('.file_share_shared_label[data-file-id="'+file.id+'"]').removeClass("hidden");$('.file_share_unshared_label[data-file-id="'+file.id+'"]').addClass("hidden")}else{$('.file_share_shared_label[data-file-id="'+file.id+'"]').addClass("hidden");$('.file_share_unshared_label[data-file-id="'+file.id+'"]').removeClass("hidden")}if(file.is_public){$('.file_share_private_label[data-file-id="'+file.id+'"]').addClass("hidden");$('.file_share_public_label[data-file-id="'+file.id+'"]').removeClass("hidden")}else{$('.file_share_private_label[data-file-id="'+file.id+'"]').removeClass("hidden");$('.file_share_public_label[data-file-id="'+file.id+'"]').addClass("hidden")}},makeFileShareLabel:function(file){var html='<span class="file_share_label" data-file-id="'+file.id+'">';var share_list=TS.templates.builders.makeFileGroupChannelList(file);if(!share_list.length){if(!file.is_public&&file.user!==TS.model.user.id){html+="shared with you"}}else{html+="in "+share_list}html+="</span>";return html},makeFileGroupChannelList:function(file){var linksA=[];var html;var channel,i;for(i=0;i<file.channels.length;i++){channel=TS.channels.getChannelById(file.channels[i]);if(!channel)continue;html='<span class="no_wrap">';html+=TS.templates.builders.makeChannelLink(channel,file);html+="&nbsp;"+TS.templates.builders.makeUnshareLink(channel,file);html+="</span>";linksA.push(html)}var group;for(i=0;i<file.groups.length;i++){group=TS.groups.getGroupById(file.groups[i]);if(!group)continue;html='<span class="no_wrap">';html+=TS.templates.builders.makeGroupLink(group,file);html+="&nbsp;"+TS.templates.builders.makeUnshareLink(group,file);html+="</span>";linksA.push(html)}if(!linksA.length)return"";return linksA.join(", ")},makeMessageShareLabelSafe:function(model_ob){var html='<span class="message_share_label">';if(model_ob.is_channel){html+="in "+TS.templates.builders.makeChannelLink(model_ob)}else if(model_ob.is_group){html+="in "+TS.templates.builders.makeGroupLink(model_ob)}html+="</span>";return new Handlebars.SafeString(html)},makeMessageLinkLabelSafe:function(url){var html="From URL: "+"<a "+TS.utility.makeRefererSafeLink(url)+' class="external_link"'+'title="'+url+'"'+'target="_blank">'+url+"</a>";return new Handlebars.SafeString(html)},makeSHRoomParticipantList:function(room){var participants=room.date_end?room.participant_history:room.participants;return _.compact(participants.map(function(participant){var member=TS.members.getMemberById(participant);if(member){return TS.members.getMemberDisplayName(member)}})).join(", ")},makeSHRoomSharedList:function(room){if(!room.channels||!room.channels.length)return"";var linksA=[];var html;var member;var model_ob;for(var i=0;i<room.channels.length;i++){model_ob=TS.shared.getModelObById(room.channels[i]);if(!model_ob)continue;if(model_ob.is_channel){html=TS.templates.builders.makeChannelLink(model_ob)}else if(model_ob.is_group){html=TS.templates.builders.makeGroupLink(model_ob)}else if(model_ob.is_im){member=TS.members.getMemberById(model_ob.user);if(!member)continue;html=TS.templates.builders.makeMemberPreviewLink(member)}else{continue}linksA.push(html)}if(!linksA.length)return"";return linksA.join(", ")},buildFileSharingControls:function(file,hide_checkbox,comment,has_title,selection){var share_context;var model_ob;if(TS.client){model_ob=TS.shared.getActiveModelOb()}else if(TS.web&&TS.web.space){model_ob=TS.shared.getModelObById(TS.web.space.getOriginChannel())}if(!model_ob||model_ob.is_channel){share_context="channel"}else if(model_ob.is_im){share_context="im"}else if(TS.boot_data.feature_mpim_client&&model_ob.is_mpim){share_context="mpim"}else if(model_ob.is_group){share_context="group"}if(model_ob&&model_ob.is_general&&!TS.members.canUserPostInGeneral()){model_ob={}}var channels=[];var groups=[];var members=[];if(share_context=="group"&&(groups&&!groups.length))share_context="channel";comment=comment||"";$("#file_sharing_div").remove();var is_owner=false;if(!file){is_owner=true}else if(file.user===TS.model.user.id){is_owner=true}var enable_collab_editing=TS.boot_data.feature_pass_the_baton&&TS.web&&TS.web.space&&is_owner&&!file.channels.concat(file.groups).concat(file.ims).length;return TS.templates.file_sharing({share_context:share_context,channels:channels,groups:groups,members:members,model_ob:model_ob,file:file,is_owner:is_owner,has_title:has_title,hide_checkbox:hide_checkbox,comment:comment,selection:selection,show_channel_join_note:model_ob&&model_ob.is_channel&&!model_ob.is_member&&!model_ob.is_archived,display_real_names:TS.members.shouldDisplayRealNames(),enable_collab_editing:enable_collab_editing})},buildNonDefaultNotificationBlock:function(classes){classes=classes||"";var html="";var i;var ob=TS.notifs.getCorGsNotUsingGlobalNotificationSetting();if(ob.everything.length){html+='<div class="'+classes+'">Set to notify for <b>all activity</b>:';for(i=0;i<ob.everything.length;i++)html+=" "+(ob.everything[i].id.charAt(0)==="C"?"#":"")+ob.everything[i].name+(i!=ob.everything.length-1?",":"");html+="</div>"}if(ob.mentions.length){html+='<div class="'+classes+'">Set to notify only for <b>Highlight Words</b>:';for(i=0;i<ob.mentions.length;i++)html+=" "+(ob.mentions[i].id.charAt(0)==="C"?"#":"")+ob.mentions[i].name+(i!=ob.mentions.length-1?",":"");html+="</div>"}if(ob.nothing.length){html+='<div class="'+classes+'">Set to <b>never notify</b>:';for(i=0;i<ob.nothing.length;i++)html+=" "+(ob.nothing[i].id.charAt(0)==="C"?"#":"")+ob.nothing[i].name+(i!=ob.nothing.length-1?",":"");html+="</div>"}return html},strBuilder:function(str,args){return str.replace(/\${([a-z_]+)}/g,function(m,$1){if($1.indexOf("_html")>-1)return args[$1];return TS.utility.htmlEntities(args[$1])})},buildRxnTitle:function(args){var subtitle='<span class="subtle_silver"> reacted with :'+TS.utility.htmlEntities(args.name)+":</span>";if(args.count==1){if(args.user_reacted){return"You (click to remove)"+subtitle}else{return TS.utility.htmlEntities(TS.members.getMemberDisplayNameById(args.member_ids[0]))+subtitle}}var final_name;var was_already_truncated=args.member_ids.length!=args.count;var names=args.member_ids.map(function(id){return TS.model.user.id===id?"You":TS.members.getMemberDisplayNameById(id)});final_name=was_already_truncated?"others":names.pop();return TS.utility.htmlEntities(names.join(", ")+" and "+final_name)+subtitle},buildRxnHtml:function(args){var emoji_html=TS.emoji.graphicReplace(":"+args.name+":");var title=TS.templates.builders.buildRxnTitle(args);return TS.templates.rxns_rxn({name:args.name,css_classes:args.user_reacted?"user_reacted":"",emoji_html:emoji_html,title:title,count:args.count})},updateRxnHtml:function($reaction_div,args){var $rxn=$reaction_div.find('.emoji_rxn.emoji_rxn_real[data-emoji="'+args.name+'"]');if($rxn.length){$rxn.find(".emoji_rxn_count").text(args.count);$rxn.toggleClass("user_reacted",args.user_reacted);var title=TS.templates.builders.buildRxnTitle(args);var existing_title;var $tip_el=$rxn.find(".ts_tip_tip_inner");if(!$tip_el.length)$tip_el=$rxn.find(".ts_tip_multiline_inner");if($tip_el.length){existing_title=$tip_el.html();if(existing_title!=title){TS.tips.updateTipTitle($rxn,title)}}else{existing_title=$rxn.prop("title");if(existing_title!=title){TS.tips.updateTipTitle($rxn,title)}}if(args.animate_it_dramatically){setTimeout(args.animate_callback,0)}else if(args.animate_it){setTimeout(args.animate_callback,0)}}else{$reaction_div.find(".emoji_rxn_spacer").before($(TS.templates.builders.buildRxnHtml(args)));$rxn=$reaction_div.find('.emoji_rxn.emoji_rxn_real[data-emoji="'+args.name+'"]');if(args.animate_it_dramatically){$rxn.css("opacity",0).transition({opacity:1},300,args.animate_callback)}else if(args.animate_it){$rxn.css("opacity",0).transition({opacity:1},300,args.animate_callback)}}},updateRxnPanels:function(rxn_key,changed_rxn_name,actor_id){var rxns=TS.rxns.getExistingRxnsByKey(rxn_key);var $reaction_divs=$("."+TS.templates.makeRxnKeyDomId(rxn_key));$reaction_divs.each(function(i,el){var $reaction_div=$(el);var animate_it;var animate_it_dramatically;if(rxns){$reaction_div.toggleClass("no_rxns",false);$reaction_div.closest(".message_actions_container").toggleClass("has_rxns",true);rxns.forEach(function(rxn){animate_it=rxn.name==changed_rxn_name;animate_it_dramatically=animate_it&&actor_id==TS.model.user.id;TS.templates.builders.updateRxnHtml($reaction_div,{animate_it:animate_it,animate_it_dramatically:animate_it_dramatically,name:rxn.name,count:rxn.count,user_reacted:TS.rxns.doesRxnsHaveRxnFromUser(rxns,rxn.name),member_ids:rxn.users})})}var $emoji_rxn_real=$reaction_div.find(".emoji_rxn.emoji_rxn_real");if($emoji_rxn_real.length){$emoji_rxn_real.each(function(i,el){var $rxn=$(el);var name=String($rxn.data("emoji"));if(!TS.rxns.doesRxnsHaveRxn(rxns,name)){$rxn.addClass("going_away");$rxn.transition({opacity:0},300,function(){$rxn.remove();if(!rxns){$reaction_div.toggleClass("no_rxns",true);$reaction_div.closest(".message_actions_container").toggleClass("has_rxns",false)}})}})}else{$reaction_div.toggleClass("no_rxns",true);$reaction_div.closest(".message_actions_container").toggleClass("has_rxns",false)}})},rxnPanel:function(rxn_key,rxn_options){if(!rxn_key){return}var rxns=TS.rxns.getExistingRxnsByKey(rxn_key);var rxns_html="";if(rxns){rxns.forEach(function(rxn){rxns_html+=TS.templates.builders.buildRxnHtml({name:rxn.name,count:rxn.count,user_reacted:TS.rxns.doesRxnsHaveRxnFromUser(rxns,rxn.name),member_ids:rxn.users})})}var classesA=[TS.templates.makeRxnKeyDomId(rxn_key)];if(!rxns)classesA.push("no_rxns");var classesA_css=classesA.join(" ");return TS.templates.rxns_panel({classesA_css:classesA_css,rxn_key:rxn_key,rxns_html:rxns_html})},filePreviewBackIcon:function(){return'<i class="ts_icon ts_icon_chevron_medium_left back_icon"></i>'},buildQuickSwitcherBtnHtml:function(){var html=!TS.model.is_mac&&(TS.model.is_our_app||TS.model.prefs.k_key_omnibox)?'<i class="ts_icon ts_icon_filter"></i><span id="quick_switcher_label" class="quick_switcher_label_windows_alignment">Quick Switcher</span>':'<i class="ts_icon ts_icon_filter"></i><span id="quick_switcher_label">Quick Switcher</span>';if(TS.model.is_our_app||TS.model.prefs.k_key_omnibox){return[html,'<span id="quick_switcher_shortcut">',TS.model.is_mac?"&#8984K":"Ctrl+K","</span>"].join("")}return html},channelsAndGroupsCopy:function(options){var caps=options&&!!options.caps;if(caps){return"Channels"}else{return"channels"}},channelsAndPrivateGroupsCopy:function(options){var caps=options&&!!options.caps;if(caps){return"Channels"}else{return"channels"}},channelsOrGroupsCopy:function(options){var caps=options&&!!options.caps;if(caps){return"Channels"}else{return"channels"}},channelOrGroupCopy:function(options){var caps=options&&!!options.caps;if(caps){return"Channel"}else{return"channel"}},channelOrPrivateGroupCopy:function(options){var caps=options&&!!options.caps;if(caps){return"Channel"}else{return"channel"}},privateGroupsCopy:function(options){var caps=options&&!!options.caps;if(caps){return"Private Channels"}else{return"private channels"}},privateGroupCopy:function(options){var caps=options&&!!options.caps;if(caps){return"Private Channel"}else{return"private channel"}},groupCopy:function(options){var caps=options&&!!options.caps;var skip_private=options&&!!options.skip_private;var name;if(caps){name="Channel"}else{name="channel"}if(skip_private)return name;if(caps)return"Private "+name;return"private "+name},channelDmOrGroupCopy:function(){return"channel or DM"},channelsDmsOrGroupsCopy:function(){return"channels or DMs"},channelsDmsAndPrivateGroupsCopy:function(){return"channels and DMs"},channelGroupOrDirectMessageCopy:function(){return"channel or direct message"},raLabel:function(old_label){var new_label=old_label;if(TS.boot_data.feature_rename_ra){switch(old_label){case"Restricted Account":new_label="Multi-Channel Guest";break;case"restricted account":new_label="multi-channel guest";break;case"Restricted account":new_label="Multi-channel guest";break;case"Restricted Accounts":new_label="Multi-Channel Guests";break;case"restricted accounts":new_label="multi-channel guests";break;case"Restricted accounts":new_label="Multi-channel guests";break;case"guest and restricted accounts":new_label="guest accounts";break;case"Restricted Accounts & Single-Channel Guests":case"Guest or Restricted Accounts":new_label="guest accounts";break;case"Restricted & Guest Accounts":new_label="Guest Accounts";break}}return new_label},makeMemberTypeBadge:function(member,size,with_border,with_tooltip){if(!TS.boot_data.feature_shared_channels_ui)return"";var args={size:"member_type_badge_"+size,big:size>=20,with_border:with_border,with_tooltip:with_tooltip,enterprise:TS.model.enterprise};if(member._is_external)return TS.templates.member_type_external_badge(args);if(member._is_from_org)return TS.templates.member_type_org_badge(args);if(member.is_ultra_restricted)return TS.templates.member_type_guest_badge(args);if(member.is_restricted)return TS.templates.member_type_restricted_badge(args);return""},makeMemberTypeBadgeClass:function(member){if(!TS.boot_data.feature_cross_team_ui)return"";if(!member._is_external&&!member._is_from_org&&!member.is_restricted)return"";return"has_member_type_badge"},makeMemberColorClass:function(member){var color_class="color_";if(member){color_class+=member.id+" color_"+member.color}else{color_class+="unknown"}return color_class},makeMemberTypeBadgeCompact:function(member,with_tooltip){if(!TS.boot_data.feature_cross_team_ui)return"";var args={icon_class:"",with_tooltip:with_tooltip,tooltip:{member_type:"",type_description:""}};if(member._is_external){args.icon_class="ts_icon_external_channel";args.tooltip.member_type="External Guests";args.tooltip.type_description="are not on your team and can only see a partial team directory, messages, and files of the shared channels they are in.";return TS.templates.member_type_icon(args)}else if(member._is_from_org){args.icon_class="ts_icon_shared_channel";if(TS.model.enterprise){args.tooltip.member_type=TS.model.enterprise.name+" members"}else{args.tooltip.member_type="Members"}args.tooltip.type_description="are part of your organization but are not on this team. They can access the team directory and message members directly, but cannot see other messages or files.";return TS.templates.member_type_icon(args)}else if(member.is_ultra_restricted){args.icon_class="ts_icon_single_channel_guest";args.tooltip.member_type="Single-Channel Guests";args.tooltip.type_description="see a partial team directory and can only access messages and files from the channel they belong to.";return TS.templates.member_type_icon(args)}else if(member.is_restricted){args.icon_class="ts_icon_restricted_user";args.tooltip.member_type=TS.templates.builders.raLabel("Restricted Accounts");args.tooltip.type_description="see only a partial team directory and can only access messages and files from selected channels.";return TS.templates.member_type_icon(args)}else{return""}},getMemberTypeClass:function(member){if(!TS.boot_data.feature_shared_channels_ui)return"";if(member._is_external)return"feature_shared_channels_ui ext";if(member.is_restricted)return"feature_shared_channels_ui ra";if(member._is_from_org)return"feature_shared_channels_ui org";return""}});function _getEntityFromMessage(message){if(!message){return false}var member;if(message.user==="USLACKBOT"&&message.file&&message.file.bot_id){member=_getEntityFromFile(message.file)}else{member=message.comment?TS.members.getMemberById(message.comment.user):TS.members.getMemberById(message.user)}return member}function _getEntityFromFile(file){if(!file){return false}var member;if(file.user==="USLACKBOT"&&file.bot_id){member=TS.bots.getBotById(file.bot_id);if(!member)member={};member.is_bot=true;member.is_service=true}else{member=TS.members.getMemberById(file.user)}return member}var _session_ms=Date.now()})();(function(){"use strict";TS.registerModule("templates.helpers",{onStart:function(){TS.templates.helpers.register()},register:function(){Handlebars.registerHelper("isClient",function(options){if(TS.boot_data.app=="client"){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("isChrome",function(options){if(TS.model.is_chrome){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("isFF",function(options){if(TS.model.is_FF){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("isSafariDesktop",function(options){if(TS.model.is_safari_desktop){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("isWeb",function(options){if(TS.boot_data.app=="web"||TS.boot_data.app=="mobile"||TS.boot_data.app=="space"){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("isMobileWeb",function(options){if(TS.boot_data.app=="mobile"){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("isMac",function(options){if(TS.model.is_mac){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("isOurApp",function(options){if(TS.model.is_our_app){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("supportsSpeech",function(options){if(TS.ui.growls.canSpeak()){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("feature",function(options){var flag=options.hash.flag;if(TS.qs_args[flag]==1||TS.boot_data[flag]==1){return options.fn(this)}return options.inverse(this)});Handlebars.registerHelper("comments",TS.templates.builders.buildComments);Handlebars.registerHelper("comment_standalone",TS.templates.builders.buildCommentStandalone);Handlebars.registerHelper("star",TS.templates.builders.buildStar);Handlebars.registerHelper("inlineImgTogglerAndDiv",TS.templates.builders.buildInlineImgTogglerAndDiv);Handlebars.registerHelper("inlineImgDiv",TS.templates.builders.buildInlineImgDiv);Handlebars.registerHelper("inlineImgToggler",TS.templates.builders.buildInlineImgToggler);Handlebars.registerHelper("inlineEmailDiv",TS.templates.builders.buildInlineEmailDiv);Handlebars.registerHelper("inlineVideoDiv",TS.templates.builders.buildInlineVideoDiv);Handlebars.registerHelper("inlineAudioDiv",TS.templates.builders.buildInlineAudioDiv);Handlebars.registerHelper("inlineOtherDiv",TS.templates.builders.buildInlineOtherDiv);Handlebars.registerHelper("inlineFilePreviewToggler",TS.templates.builders.buildInlineFilePreviewToggler);Handlebars.registerHelper("inlineRoomPreviewToggler",TS.templates.builders.buildInlineRoomPreviewToggler);Handlebars.registerHelper("isInlineFilePreviewExpanded",function(options){var container_id=options.hash.container_id;var file_id=options.hash.file_id;var max_image_size=360;var should_expand=false;var src=_inlineImgSrcForFile(file_id,max_image_size);if(src){should_expand=TS.inline_imgs.shouldExpand(container_id,TS.model.inline_imgs[src])}else{should_expand=TS.inline_file_previews.shouldExpand(container_id,file_id)}if(should_expand){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("isInlineFilePreviewFullContent",function(options){var container_id=options.hash.container_id;var file_id=options.hash.file_id;if(TS.inline_file_previews.showingFullContent(container_id,file_id)){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("unlessInlineFilePreviewFullContent",function(options){return Handlebars.helpers["isInlineFilePreviewFullContent"].call(this,{fn:options.inverse,inverse:options.fn,hash:options.hash})});Handlebars.registerHelper("shouldTruncateInlineFilePreview",function(file,options){if(typeof file==="string")file=TS.files.getFileById(file);if(file&&TS.inline_file_previews.shouldTruncate(file)){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("shouldNotTruncateInlineFilePreview",function(file,options){return Handlebars.helpers["shouldTruncateInlineFilePreview"].call(this,file,{fn:options.inverse,inverse:options.fn,hash:options.hash})});Handlebars.registerHelper("isInlineFilePreviewTruncated",function(container_id,file,options){if(typeof file==="string")file=TS.files.getFileById(file);if(file&&TS.inline_file_previews.isTruncated(container_id,file)){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("isInlineFilePreviewNotTruncated",function(container_id,file,options){return Handlebars.helpers["isInlineFilePreviewTruncated"].call(this,container_id,file,{fn:options.inverse,inverse:options.fn,hash:options.hash})});Handlebars.registerHelper("formatActionLink",function(action,msg,enable_slack_action_links){if(!action)return"";var text="<"+action.url+"|"+action.title+">";var html=TS.format.formatWithOptions(text,msg,{no_highlights:true,no_specials:true,enable_slack_action_links:enable_slack_action_links===true});return html});Handlebars.registerHelper("formatSoundUrl",TS.templates.builders.formatSoundUrl);Handlebars.registerHelper("ellipsize",function(str,len){TS.info("len"+len);return TS.utility.ellipsize(str,len)});Handlebars.registerHelper("stripWhitespace",function(str){return str.replace(/\s+/g,"")});Handlebars.registerHelper("pluralize",function(number,singular,plural){number=parseInt(number);if(number===1){return singular}else{return typeof plural==="string"?plural:singular+"s"}});Handlebars.registerHelper("pluralCount",function(number,singular,plural){return number+" "+Handlebars.helpers.pluralize.apply(this,arguments)});Handlebars.registerHelper("possessive",function(str){if(str.substr(-1,str.length)=="s"){return"'"}else{return"'s"}});Handlebars.registerHelper("possessiveForMemberById",function(id){var member=TS.members.getMemberById(id);if(!member)return"";return Handlebars.helpers.possessiveForMember(member)});Handlebars.registerHelper("possessiveForMember",function(member){var str=TS.members.getMemberDisplayName(member);if(str.substr(-1,str.length)=="s"){return"'"}else{return"'s"}});Handlebars.registerHelper("concatStr",function(){return Array.prototype.slice.call(arguments,0,arguments.length-1).join("")});Handlebars.registerHelper("json",function(obj){if(typeof obj==="object"&&obj!==null&&obj.name==="json"){return JSON.stringify(this)}else{return JSON.stringify(obj)}});Handlebars.registerHelper("currentTeamName",function(){return TS.model.team.name||""});Handlebars.registerHelper("canUserAtEveryone",function(options){return TS.members.canUserAtEveryone()?options.fn(this):options.inverse(this)});Handlebars.registerHelper("canUserAtChannelOrAtGroup",function(options){return TS.members.canUserAtChannelOrAtGroup()?options.fn(this):options.inverse(this)});Handlebars.registerHelper("canUserCreateChannels",function(options){return TS.members.canUserCreateChannels()?options.fn(this):options.inverse(this)});Handlebars.registerHelper("canUserArchiveChannels",function(options){return TS.members.canUserArchiveChannels()?options.fn(this):options.inverse(this)});Handlebars.registerHelper("canUserCreateGroups",function(options){
return TS.members.canUserCreateGroups()?options.fn(this):options.inverse(this)});Handlebars.registerHelper("canUserCreateMpims",function(options){return TS.members.canUserCreateMpims()?options.fn(this):options.inverse(this)});Handlebars.registerHelper("canUserPostInGeneral",function(options){return TS.members.canUserPostInGeneral()?options.fn(this):options.inverse(this)});Handlebars.registerHelper("canUserKickFromChannels",function(options){return TS.members.canUserKickFromChannels()?options.fn(this):options.inverse(this)});Handlebars.registerHelper("canUserKickFromGroups",function(options){return TS.members.canUserKickFromGroups()?options.fn(this):options.inverse(this)});Handlebars.registerHelper("canUserCreateSharedChannels",function(options){return TS.members.canUserCreateSharedChannels()?options.fn(this):options.inverse(this)});Handlebars.registerHelper("numberWithMax",function(number,max){if(number>=max){return max-1+"+"}else{return number}});Handlebars.registerHelper("convertFilesize",function(size){return TS.utility.convertFilesize(size)});Handlebars.registerHelper("toDate",function(ts){return TS.utility.date.toDate(ts)});Handlebars.registerHelper("toCalendarDate",function(ts){return TS.utility.date.toCalendarDate(ts)});Handlebars.registerHelper("toCalendarDateWords",function(ts){return TS.utility.date.toCalendarDateWords(ts)});Handlebars.registerHelper("toCalendarDateShort",function(ts){return TS.utility.date.toCalendarDate(ts,true)});Handlebars.registerHelper("toCalendarDateOrNamedDay",function(ts){return TS.utility.date.toCalendarDateOrNamedDay(ts)});Handlebars.registerHelper("toCalendarDateOrNamedDayWords",function(ts){return TS.utility.date.toCalendarDateOrNamedDayWords(ts)});Handlebars.registerHelper("toCalendarDateIfYesterdayOrToday",function(ts){return TS.utility.date.toCalendarDateIfYesterdayOrToday(ts)});Handlebars.registerHelper("toCalendarDateOrNamedDayShort",function(ts){return TS.utility.date.toCalendarDateOrNamedDayShort(ts)});Handlebars.registerHelper("toTime",function(ts,ampm,seconds){return TS.utility.date.toTime(ts,ampm!==false,seconds===true)});Handlebars.registerHelper("toTimeWords",function(ts,ampm,seconds){return TS.utility.date.toTimeWords(ts,ampm!==false,seconds===true)});Handlebars.registerHelper("toTimeAgo",function(ts){return TS.utility.date.toTimeAgo(ts)});Handlebars.registerHelper("toTimeDuration",function(ts){return TS.utility.date.toTimeDuration(ts)});Handlebars.registerHelper("msgTsTitle",function(msg){var title=(TS.utility.date.toCalendarDateOrNamedDayShort(msg.ts)+" at "+TS.utility.date.toTime(msg.ts,true,true)).replace(/\s/g,"&nbsp;");var ephemeral_or_temp=msg.is_ephemeral||TS.utility.msgs.isTempMsg(msg);if(TS.client&&!ephemeral_or_temp)title+="<br>Click to open in archives";return title});Handlebars.registerHelper("toHour",function(ts){return TS.utility.date.toHour(ts)});Handlebars.registerHelper("timezoneLabel",function(member,include_local_time){return TS.utility.date.timezoneLabel(member,include_local_time)});Handlebars.registerHelper("memberLocalTime",function(member){return TS.utility.date.memberLocalTime(member)});Handlebars.registerHelper("memberUTCOffset",function(member){return TS.utility.date.memberUTCOffset(member)});Handlebars.registerHelper("isInDifferentTimeZone",function(member,options){if(member.tz_offset!==TS.model.user.tz_offset)return options.fn(this);return options.inverse(this)});Handlebars.registerHelper("isToday",function(member,options){if(TS.utility.date.isToday(TS.utility.date.toDateObject(member)))return options.fn(this);return options.inverse(this)});Handlebars.registerHelper("if_equal",function(context,options){options=_optionsFnInverseBooleanHelper(options);if(context==options.hash.compare)return options.fn(this);return options.inverse(this)});Handlebars.registerHelper("if_not_equal",function(context,options){options=_optionsFnInverseBooleanHelper(options);if(context!=options.hash.compare)return options.fn(this);return options.inverse(this)});Handlebars.registerHelper("if_gt",function(context,options){if(context>options.hash.compare)return options.fn(this);return options.inverse(this)});Handlebars.registerHelper("or",function(a,b,options){options=_optionsFnInverseBooleanHelper(options);if(a||b){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("and",function(a,b,options){options=_optionsFnInverseBooleanHelper(options);if(a&&b){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("foreach",function(arr,options){if(options.inverse&&!arr.length)return options.inverse(this);return arr.map(function(item,index){var obj={index:index,value:item,length:arr.length};obj.first=index===0;obj.last=index===arr.length-1;return options.fn(obj)}).join("")});Handlebars.registerHelper("repeat",function(n,block){var accum="";for(var i=0;i<n;i++){accum+=block.fn(i)}return accum});Handlebars.registerHelper("makeDayDividerDomId",function(ts){return TS.templates.makeDayDividerDomId(ts)});Handlebars.registerHelper("formatFileTitle",function(file){if(!file||!file.title)return"";return TS.format.formatNoSpecials(file.title)});Handlebars.registerHelper("formatMessageByType",TS.templates.builders.formatMessageByType);Handlebars.registerHelper("formatAttachments",TS.templates.builders.formatAttachments);Handlebars.registerHelper("formatMessage",function(text,msg){return TS.format.formatDefault(text,msg)});Handlebars.registerHelper("formatNoHighlightsNoSpecials",function(text,msg){return TS.format.formatNoHighlightsNoSpecials(text,msg)});Handlebars.registerHelper("formatMessageAttachmentPart",function(text,msg,do_highlighting,do_specials,enable_slack_action_links){var formatted_msg=TS.format.formatWithOptions(text,msg,{no_highlights:do_highlighting!==true,no_specials:do_specials!==true,enable_slack_action_links:enable_slack_action_links===true});formatted_msg=TS.utility.msgs.handleSearchHighlights(formatted_msg);return formatted_msg});Handlebars.registerHelper("formatTopicOrPurpose",function(text){return TS.utility.formatTopicOrPurpose(text)});Handlebars.registerHelper("unFormatMessage",function(text,msg){return TS.format.unFormatMsg(text,msg)});Handlebars.registerHelper("formatMessageResult",function(text){text=TS.format.formatJustText(text);text=TS.utility.msgs.handleSearchHighlights(text);return text});Handlebars.registerHelper("formatStarredMessageAndTruncate",function(msg,length){var text=msg.text;if(msg.subtype=="channel_topic"){if(msg.text){text="channel topic: "+msg.text}else{text="channel topic cleared"}}else if(msg.subtype=="channel_purpose"){if(msg.text){text="channel purpose: "+msg.text}else{text="channel purpose cleared"}}else if(msg.subtype=="channel_join"){text="joined channel"}else if(msg.subtype=="channel_leave"){text="left channel"}else if(msg.subtype=="group_topic"){if(msg.text){text="group topic: "+msg.text}else{text="group topic cleared"}}else if(msg.subtype=="group_purpose"){if(msg.text){text="group purpose: "+msg.text}else{text="group purpose cleared"}}else if(msg.subtype=="group_join"){text="joined group"}else if(msg.subtype=="group_leave"){text="left group"}else if(msg.subtype=="group_archive"){text="archived group"}else if(msg.subtype=="group_unarchive"){text="un-archived group"}else if(msg.subtype=="channel_archive"){text="archived channel"}else if(msg.subtype=="channel_unarchive"){text="un-archived channel"}var truncated_msg=truncate(TS.format.formatDefault(text,msg),length);if(msg.permalink){var read_more_link=' <a target="'+TS.templates.builders.newWindowName()+'" href="'+msg.permalink+'" class="normal tiny">read more</a>';return truncated_msg+read_more_link}else{return truncated_msg}});Handlebars.registerHelper("formatMessageExcerpt",function(msg,length){if(!length)length=50;var text=TS.format.unFormatMsg(msg.text,msg);text=TS.utility.htmlEntities(text);text=TS.emoji.graphicReplace(text);var truncated=truncate(text,length);return new Handlebars.SafeString(truncated)});Handlebars.registerHelper("rxnPanel",function(rxn_key,rxn_options){return TS.templates.builders.rxnPanel(rxn_key,rxn_options||{})});Handlebars.registerHelper("fileActionsCog",function(file){return'<a class="file_actions file_actions_cog ts_icon ts_icon_cog" data-file-id="'+file.id+'"></a>'});Handlebars.registerHelper("fileActionsBtn",function(file){return'<a class="file_actions ts_icon ts_icon_chevron_medium_down" data-file-id="'+file.id+'"></a>'});Handlebars.registerHelper("fileActionsLink",function(file){return'<a class="file_actions file_actions_link" data-file-id="'+file.id+'">Actions <i class="ts_icon ts_icon_caret_down ts_icon_inherit"></i></a>'});Handlebars.registerHelper("makeRefererSafeLink",function(options){if(typeof options.hash.url!=="string")return"";return TS.utility.makeRefererSafeLink(options.hash.url)});Handlebars.registerHelper("makeSafeForDomId",TS.utility.makeSafeForDomId);Handlebars.registerHelper("makeMsgAttachmentTextExpanderDomId",TS.templates.makeMsgAttachmentTextExpanderDomId);Handlebars.registerHelper("makeMsgDomId",TS.templates.makeMsgDomId);Handlebars.registerHelper("makeMsgLabelDomId",TS.templates.makeMsgLabelDomId);Handlebars.registerHelper("makeMSRDomId",TS.templates.makeMSRDomId);Handlebars.registerHelper("makeSHRoomClass",TS.templates.makeSHRoomClass);Handlebars.registerHelper("makeMsgSubtypeDomClass",function(msg){var domClass="";if(!msg.subtype)return domClass;if(msg.subtype=="channel_join"||msg.subtype=="group_join"){domClass+="joined automated"}else if(msg.subtype=="channel_leave"||msg.subtype=="group_leave"){domClass+="left automated"}else if(msg.subtype=="channel_topic"||msg.subtype=="group_topic"){domClass+="topic automated"}else if(msg.subtype=="channel_name"||msg.subtype=="group_name"){domClass+="rename automated"}else if(msg.subtype=="channel_purpose"||msg.subtype=="group_purpose"){domClass+="purpose automated"}else if(msg.subtype=="channel_archive"||msg.subtype=="group_archive"){domClass+="archived automated"}else if(msg.subtype=="channel_unarchive"||msg.subtype=="group_unarchive"){domClass+="unarchived automated"}else if(msg.subtype=="bot_message"){domClass+="bot_message"}else if(msg.subtype==="pinned_item"){domClass+="pinned"}else if(msg.subtype==="sh_room_shared"){domClass+="sh_shared automated"}else if(msg.subtype==="sh_room_created"){domClass+="sh_created automated"}else if(msg.subtype==="bot_add"||msg.subtype==="bot_remove"||msg.subtype==="bot_enable"||msg.subtype==="bot_disable"){domClass+="bot_change automated"}else if(msg.subtype==="reminder_add"||msg.subtype==="reminder_delete"){domClass+="reminder_change automated"}return domClass});Handlebars.registerHelper("buildMsgHTMLForSearch",TS.templates.builders.buildMsgHTMLForSearch);Handlebars.registerHelper("ifExtracts",function(msg,options){if(msg.previous||msg.previous_2||msg.next||msg.next_2){return options.fn(this)}return options.inverse(this)});Handlebars.registerHelper("willForceExtracts",function(msg,options){if(!msg.previous&&!msg.next||TS.search.view.resultHasExtracts(msg))return options.inverse(this);var query=TS.search.query_string;var words=query.split(" ");var i,word;var has_search_term=false;for(i=0;i<words.length;i++){word=$.trim(words[i]);if(word.length>0&&!TS.search.keyword_modifier_pair_regex.test(word)){has_search_term=true;break}}if(!has_search_term)return options.fn(this);return options.inverse(this)});Handlebars.registerHelper("formatAttachmentExtracts",function(attachment,message){var bg_color=attachment.color||"e3e4e6";return TS.templates.search_attachment_extracts({attachment:attachment,message:message,bg_color:bg_color})});Handlebars.registerHelper("concatMsgExtracts",function(message){if(!message.extracts||message.extracts.length===0)return"";var extract_texts=[];var ellipsis=TS.templates.builders.search_ellipsis;message.extracts.forEach(function(extract){if(extract.text)extract.text=extract.text.replace(/&&gt;t;>&gt;/g,"&gt;&gt;&gt;");var formatted_msg=TS.format.formatDefault(extract.text,message);formatted_msg=TS.utility.msgs.handleSearchHighlights(formatted_msg);extract_texts.push(formatted_msg)});var html=extract_texts.join(ellipsis);if(message.extracts[0].truncated_head)html=ellipsis+html;if(message.extracts[message.extracts.length-1].truncated_tail)html+=ellipsis;return html});Handlebars.registerHelper("concatAttachmentExtracts",function(attachment,message){var extract_texts=[];var extracts=attachment.extracts;var last_extract;var ellipsis=TS.templates.builders.search_ellipsis;if(!extracts)return"";["title","text"].forEach(function(key){if(extracts[key]){extracts[key].forEach(function(extract){var formatted_msg=TS.format.formatDefault(extract.text,message);formatted_msg=TS.utility.msgs.handleSearchHighlights(formatted_msg);if(extract_texts.length===0&&extract.truncated_head)formatted_msg=ellipsis+formatted_msg;last_extract=extract;extract_texts.push(formatted_msg)})}});var concatenated=extract_texts.join(ellipsis);if(concatenated&&last_extract&&last_extract.truncated_tail)concatenated+=ellipsis;if(!concatenated&&extracts.fields&&!extracts.fallback){extracts.fields.forEach(function(field){var value=TS.utility.htmlEntities(field.value.text);value=TS.utility.msgs.handleSearchHighlights(value);if(field.value.truncated_head)value=ellipsis+value;if(field.value.truncated_tail)value+=ellipsis;concatenated+="<strong>"+TS.utility.htmlEntities(field.title)+"</strong> &bull; "+value+"<br>"})}if(!concatenated&&attachment.fallback){var fallback_text=attachment.fallback;if(extracts.fallback&&extracts.fallback.length>0)fallback_text=extracts.fallback[0].text;var fallback=TS.format.formatDefault(fallback_text,message);fallback=TS.utility.msgs.handleSearchHighlights(fallback);return fallback}return concatenated});Handlebars.registerHelper("newWindowName",TS.templates.builders.newWindowName);Handlebars.registerHelper("nl2br",function(text){if(!text)return text;text=TS.utility.htmlEntities(text);return text.replace(/\n/g,"<br />").replace(/&amp;#95;/g,"_")});Handlebars.registerHelper("smartnl2br",function(text){if(!text)return text;text=TS.utility.htmlEntities(text);text=text.replace(/\n\r\n\r/g,'<span class="para_break"><br /></span>');text=text.replace(/\n\r\n/g,'<span class="para_break"><br /></span>');text=text.replace(/\n\n/g,'<span class="para_break"><br /></span>');text=text.replace(/\n/g,"<br />");return text.replace(/&amp;#95;/g,"_")});Handlebars.registerHelper("truncate",function(text,length){var truncated_text=truncate(text,length);return truncated_text.replace(/&#64;/g,"@")});Handlebars.registerHelper("truncateToNearestWordBoundary",TS.utility.truncateToNearestWordBoundary);Handlebars.registerHelper("proxyImgUrls",function(html){var $html=$("<div>"+html+"</div>");$html.find("img").each(function(){var original_src=$(this).attr("src");var original_w=$(this).attr("width");var original_h=$(this).attr("height");var proxied_url;if(original_w&&original_h){proxied_url=TS.utility.getImgProxyURL(original_src,original_w,original_h)}else{proxied_url=TS.utility.getImgProxyURL(original_src)}$(this).attr("src",proxied_url)});return $html.html()});Handlebars.registerHelper("generalName",function(){var chan=TS.channels.getGeneralChannel();return chan?chan.name:""});Handlebars.registerHelper("makeChannelDomId",function(channel){return TS.templates.makeChannelDomId(channel)});Handlebars.registerHelper("ChannelNameMaxLength",function(channel){return TS.model.channel_name_max_length});Handlebars.registerHelper("ChannelPurposeMaxLength",function(){return TS.model.channel_purpose_max_length});Handlebars.registerHelper("ChannelTopicMaxLength",function(){return TS.model.channel_topic_max_length});Handlebars.registerHelper("makeUnreadJustDomId",function(channel){return TS.templates.makeUnreadJustDomId(channel)});Handlebars.registerHelper("getCorGNameWithPrefixById",function(id,hide_unknown_groups){var channel=TS.channels.getChannelById(id);if(channel)return"#"+channel.name;var group=TS.groups.getGroupById(id);if(group)return TS.model.group_prefix+group.name;if(hide_unknown_groups){return}else{return id}});Handlebars.registerHelper("makeChannelLink",TS.templates.builders.makeChannelLink);Handlebars.registerHelper("makeChannelLinkById",function(id){var channel=TS.channels.getChannelById(id);if(channel)return TS.templates.builders.makeChannelLink(channel)});Handlebars.registerHelper("makeUnreadHighlightDomId",function(channel){return TS.templates.makeUnreadHighlightDomId(channel)});Handlebars.registerHelper("makeChannelDomClass",function(channel){var domClass="";if(TS.model.active_channel_id==channel.id)domClass+="active ";if(channel.unread_cnt>0)domClass+="unread ";if(channel.unread_highlight_cnt>0)domClass+="mention ";if(TS.notifs.isCorGMuted(channel.id))domClass+="muted_channel ";if(channel._show_in_list_even_though_no_unreads)domClass+="show_in_list_even_though_no_unreads ";return domClass});Handlebars.registerHelper("makeChannelOrGroupLinkById",function(id){var ob=TS.shared.getModelObById(id);if(ob.is_channel){return TS.templates.builders.makeChannelLink(ob)}else if(ob.is_mpim){return TS.templates.builders.makeMpimLink(ob,false)}else if(ob.is_group){return TS.templates.builders.makeGroupLink(ob)}});Handlebars.registerHelper("makeChannelOrGroupSSBLinkById",function(id){var ob=TS.shared.getModelObById(id);if(!ob)return;var text;var url="slack://channel?team="+TS.model.team.id+"&id="+id;if(ob.is_channel){var channel=TS.channels.getChannelById(id);text="#"+channel.name;return"<a href="+url+">"+text+"</a>"}else if(ob.is_group){text=TS.model.group_prefix+ob.name;return"<a href="+url+">"+text+"</a>"}});Handlebars.registerHelper("makeInternalChannelOrGroupLinkById",function(id){var ob=TS.shared.getModelObById(id);if(!ob)return;if(ob.is_channel){return TS.templates.builders.makeInternalChannelLink(ob)}else if(ob.is_group){return TS.templates.builders.makeInternalGroupLink(ob)}});Handlebars.registerHelper("isTeamInOrg",function(team,options){if(!TS.boot_data.feature_shared_channels_ui||!TS.boot_data.page_needs_enterprise)return options.inverse(this);var is_in_org=TS.model.enterprise._teams.some(function(enterprise_team){return enterprise_team.id===team.id});return is_in_org?options.fn(this):options.inverse(this)});Handlebars.registerHelper("isThereComplianceExportsTeam",function(channel,options){if(!TS.boot_data.feature_shared_channels_ui||!TS.boot_data.page_needs_enterprise)return options.inverse(this);var does_a_team=false;if(channel.is_shared){does_a_team=channel.shares.some(function(team){return team.team.has_compliance_export})}return does_a_team?options.fn(this):options.inverse(this)});Handlebars.registerHelper("makeTeamsThatHaveComplianceExportsBlurb",TS.templates.builders.makeTeamsThatHaveComplianceExportsBlurb);Handlebars.registerHelper("isEnterpriseTeam",function(options){if(!TS.boot_data.feature_shared_channels_ui)return options.inverse(this);return TS.boot_data.page_needs_enterprise?options.fn(this):options.inverse(this)});Handlebars.registerHelper("makeGroupDomId",function(group){return TS.templates.makeGroupDomId(group)});Handlebars.registerHelper("groupPrefix",function(group){return TS.model.group_prefix});Handlebars.registerHelper("makeGroupLink",TS.templates.builders.makeGroupLink);Handlebars.registerHelper("makeGroupLinkById",function(id){var group=TS.groups.getGroupById(id);if(group)return TS.templates.builders.makeGroupLink(group)});Handlebars.registerHelper("makeGroupDomClass",function(group){var domClass="";if(TS.model.active_group_id==group.id)domClass+="active ";if(group.unread_cnt>0)domClass+="unread ";if(group.unread_highlight_cnt>0)domClass+="mention ";if(group.is_starred)domClass+="starred ";if(TS.notifs.isCorGMuted(group.id))domClass+="muted_channel ";if(group._show_in_list_even_though_no_unreads)domClass+="show_in_list_even_though_no_unreads ";return domClass});Handlebars.registerHelper("mpimMemberCount",function(mpim){return TS.mpims.getMemberCount(mpim)});Handlebars.registerHelper("mpimDisplayName",function(mpim,for_header,show_last_initial){return TS.mpims.getDisplayName(mpim,for_header===true,show_last_initial===true)});Handlebars.registerHelper("makeMpimDomClass",function(mpim){var dom_class="";if(!mpim)return dom_class;if(mpim.id===TS.model.active_mpim_id)dom_class+="active ";if(mpim.unread_cnt>0||mpim.unread_highlight_cnt>0)dom_class+="unread mention ";if(TS.notifs.isCorGMuted(mpim.id))dom_class+="muted_channel ";return dom_class});Handlebars.registerHelper("makeMpimDomId",function(mpim){return TS.templates.makeMpimDomId(mpim)});Handlebars.registerHelper("makeMpimLink",function(mpim,with_title){return TS.templates.builders.makeMpimLink(mpim,with_title)});Handlebars.registerHelper("mpimArchivesPath",function(mpim){return TS.mpims.getMpimArchivesPath(mpim)});Handlebars.registerHelper("isCorGMuted",function(id,options){if(TS.notifs.isCorGMuted(id)){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("currentUserId",function(){return TS.model.user.id});Handlebars.registerHelper("makeMemberDomId",function(member){return TS.templates.makeMemberDomId(member)});Handlebars.registerHelper("makeChannelListDomId",function(channel){return TS.templates.makeChannelListDomId(channel)});Handlebars.registerHelper("makeMemberPresenceDomClass",function(member){return TS.templates.makeMemberPresenceDomClass(member.id)});Handlebars.registerHelper("makeMemberPresenceIcon",function(member){return TS.templates.makeMemberPresenceIcon(member)});Handlebars.registerHelper("makeMemberStatusDomClass",function(member){return TS.templates.makeMemberStatusDomClass(member.id)});Handlebars.registerHelper("makeMemberDomClass",function(member){var domClass="";if(!member)return domClass;if(!member.is_self&&member.presence=="away")domClass+="away ";if(TS.model.active_im_id){var active_ims=TS.ims.getImById(TS.model.active_im_id);if(active_ims.user==member.id){domClass+="active "}}var im=TS.ims.getImByMemberId(member.id);if(im){if(im.unread_cnt>0||im.unread_highlight_cnt>0)domClass+="unread mention "}return domClass});Handlebars.registerHelper("makeMemberListDomClass",function(member){var domClass="member ";if(member.presence=="away")domClass+="away ";return domClass});Handlebars.registerHelper("makeMemberPreviewLink",TS.templates.builders.makeMemberPreviewLink);Handlebars.registerHelper("makeMemberPreviewLinkById",function(id,show_you_for_current_user){if(show_you_for_current_user!==true)show_you_for_current_user=false;var member=TS.members.getMemberById(id)||TS.bots.getBotById(id);if(!member)return id;return TS.templates.builders.makeMemberPreviewLink(member,show_you_for_current_user)});Handlebars.registerHelper("makeMemberPreviewLinkImage",TS.templates.builders.makeMemberPreviewLinkImage);Handlebars.registerHelper("makeMemberPreviewCardLinkImage",TS.templates.builders.makeMemberPreviewCardLinkImage);Handlebars.registerHelper("makeProfileImage",TS.templates.builders.makeProfileImage);Handlebars.registerHelper("emojiGraphicReplace",function(emoji,force_style){var options={};if(force_style){options.force_style=force_style}return TS.emoji.graphicReplace(emoji,options)});Handlebars.registerHelper("emojiGraphicReplaceByName",function(name){return TS.emoji.graphicReplace(":"+name+":")});Handlebars.registerHelper("makeMemberImage",TS.templates.builders.makeMemberImage);Handlebars.registerHelper("makeUsernameImage",function(msg,size){var img_src,size_class,emoji_str,default_img_src;var bot_icons;var bot=msg.bot_id?TS.bots.getBotById(msg.bot_id):null;if(msg.icons){bot_icons=msg.icons}else{if(bot&&bot.icons){bot_icons=bot.icons}else{}}if(bot_icons){if(bot_icons.image_36&&!TS.model.is_retina){img_src=bot_icons.image_36}else if(bot_icons.image_72&&TS.model.is_retina){img_src=bot_icons.image_72}else if(bot_icons.image_48){img_src=bot_icons.image_48}else if(bot_icons.emoji&&bot_icons.emoji.substr(0,1)==":"&&bot_icons.emoji.substr(bot_icons.emoji.length-1,1)==":"){emoji_str=bot_icons.emoji}}var bot_link=TS.templates.builders.makeBotLink(bot,msg.username);var member_for_default=msg&&msg.is_ephemeral&&msg.username=="slackbot"?TS.members.getMemberById("USLACKBOT"):null;switch(size){case 24:size_class="thumb_24";default_img_src="https://i0.wp.com/slack-assets2.s3-us-west-2.amazonaws.com/8390/img/avatars/ava_0002-24.png?ssl=1";if(member_for_default){default_img_src=member_for_default.profile.image_24}break;case 32:size_class="thumb_32";default_img_src="https://i0.wp.com/slack-assets2.s3-us-west-2.amazonaws.com/8390/img/avatars/ava_0002-32.png?ssl=1";if(member_for_default){default_img_src=member_for_default.profile.image_32}break;case 36:size_class="thumb_36";default_img_src="https://i0.wp.com/slack-assets2.s3-us-west-2.amazonaws.com/8390/img/avatars/ava_0002-48.png?ssl=1";if(member_for_default){default_img_src=member_for_default.profile.image_48}break;case 72:size_class="thumb_72";default_img_src="https://i0.wp.com/slack-assets2.s3-us-west-2.amazonaws.com/8390/img/avatars/ava_0002-72.png?ssl=1";if(member_for_default){default_img_src=member_for_default.profile.image_72}break;case 192:size_class="thumb_192";default_img_src="https://i0.wp.com/slack-assets2.s3-us-west-2.amazonaws.com/8390/img/avatars/ava_0002-192.png?ssl=1";if(member_for_default){default_img_src=member_for_default.profile.image_192}break;default:size_class="thumb_48";default_img_src="https://i0.wp.com/slack-assets2.s3-us-west-2.amazonaws.com/8390/img/avatars/ava_0002-48.png?ssl=1";if(member_for_default){default_img_src=member_for_default.profile.image_48}break}var html;if(img_src){html=bot_link.start_a+'<img style="border: 0" src="'+img_src+'" class="member_image '+size_class+'" />'+bot_link.end_a}else if(emoji_str){html=bot_link.start_a+'<div style="border: 0" class="member_image '+size_class+'">'+TS.emoji.graphicReplace(TS.utility.htmlEntities(emoji_str))+"</div>"+bot_link.end_a}else{if(member_for_default){html=bot_link.start_a+'<img src="'+default_img_src+'" class="member_image '+size_class+'" />'+bot_link.end_a}else{html=bot_link.start_a+'<img src="'+default_img_src+'" class="member_image bot_icon_default '+size_class+'" />'+bot_link.end_a}}return html});Handlebars.registerHelper("getMemberNameById",function(id){var member=TS.members.getMemberById(id);return member?member.name:id});Handlebars.registerHelper("getMemberDisplayNameById",function(id){return TS.members.getMemberDisplayNameById(id)});Handlebars.registerHelper("getMemberDisplayName",function(member){return TS.members.getMemberDisplayName(member)});Handlebars.registerHelper("getMemberUsernameAndRealNameInCorrectOrder",function(member){var display_name=TS.members.getMemberDisplayName(member);var names_in_correct_order_html="";if(display_name===member.name){names_in_correct_order_html="<span class='member_username'>"+member.name+"</span>";if(member.real_name&&member.real_name!==member.name)names_in_correct_order_html+="<span class='member_real_name'>"+TS.utility.htmlEntities(member.real_name)+"</span>"}else{if(member.real_name&&member.real_name!==member.name)names_in_correct_order_html="<span class='member_real_name'>"+TS.utility.htmlEntities(member.real_name)+"</span>";names_in_correct_order_html+="<span class='member_username'>"+member.name+"</span>"}return names_in_correct_order_html});Handlebars.registerHelper("getDisplayNameOfUserForIm",function(im){if(!im)return"MISSING_IM";return TS.ims.getDisplayNameOfUserForIm(im)});Handlebars.registerHelper("getIMIdByMemberId",function(member_id){var im=TS.ims.getImByMemberId(member_id);return im?im.id:""});Handlebars.registerHelper("memberHasIm",function(options){var member=options.hash.member;var has_im=false;if(member){if(TS.ims.getImByMemberId(member.id))has_im=true}if(has_im){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("memberHasImUnreadCount",function(options){var member=options.hash.member;var has_unreads=false;if(member){var im=TS.ims.getImByMemberId(member.id);if(im&&im.unread_cnt)has_unreads=true}if(has_unreads){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("getUnreadCountForIMByMemberId",function(id){var im=TS.ims.getImByMemberId(id);if(im){return im.unread_cnt}else{return""}});Handlebars.registerHelper("makeMemberLinksWithDisplayNames",function(member_ids_string){if(!member_ids_string)return"";return member_ids_string.split(/\s*\,\s*/).map(function(id){return TS.templates.builders.makeMemberPreviewLink(TS.members.getMemberById(id))}).join(", ")});function makeIMLink(im){var member=TS.members.getMemberById(im.user);var template_args={im_exists:!TS.ims.isImWithDeletedMember(im),im_name:im.name,im_id:im.id,member_color:"color_"+(member?member.id+" color_"+member.color:"unknown")};if(TS.utility.shouldLinksHaveTargets()){var target=TS.ims.isImWithDeletedMember(im)?TS.templates.builders.newWindowName():"/messages/@"+im.name;template_args.target=target}return TS.templates.search_im_link(template_args)}Handlebars.registerHelper("makeIMLink",makeIMLink);Handlebars.registerHelper("makeIMLinkById",function(id){var im=TS.ims.getImById(id);if(im)return makeIMLink(im)});function getBotNameAndIcon(msg){var username=TS.utility.htmlEntities(msg.username);var bot_icons;var bot=msg.bot_id?TS.bots.getBotById(msg.bot_id):null;if(msg.icons){bot_icons=msg.icons}else{if(bot&&bot.icons){bot_icons=bot.icons}else{}}if(!username&&bot&&bot.name){username=TS.utility.htmlEntities(bot.name)}var bot_link=TS.templates.builders.makeBotLink(bot,msg.username);if(!bot_icons){return bot_link.start_a+username+bot_link.end_a}var html;if(bot_icons.emoji&&bot_icons.emoji.substr(0,1)==":"&&bot_icons.emoji.substr(bot_icons.emoji.length-1,1)==":"){html=bot_link.start_a+TS.emoji.graphicReplace(TS.utility.htmlEntities(bot_icons.emoji))+bot_link.end_a+" "+bot_link.start_a+username+bot_link.end_a}else if(bot_icons.image_36&&!TS.model.is_retina){html=bot_link.start_a+'<img src="'+bot_icons.image_36+'" class="inline_bot_icon">'+bot_link.end_a+" "+bot_link.start_a+username+bot_link.end_a}else if(bot_icons.image_72&&TS.model.is_retina){html=bot_link.start_a+'<img src="'+bot_icons.image_72+'" class="inline_bot_icon">'+bot_link.end_a+" "+bot_link.start_a+username+bot_link.end_a}else if(bot_icons.image_48){html=bot_link.start_a+'<img src="'+bot_icons.image_48+'" class="inline_bot_icon">'+bot_link.end_a+" "+bot_link.start_a+username+bot_link.end_a}else{html=bot_link.start_a+username+bot_link.end_a}return html}Handlebars.registerHelper("getBotNameAndIcon",getBotNameAndIcon);Handlebars.registerHelper("getBotName",TS.templates.builders.getBotName);Handlebars.registerHelper("getBotNameWithLink",TS.templates.builders.getBotNameWithLink);function getBotColorClassByUserName(username){if(!username)return"color_unknown";return"color_bot_"+TS.utility.makeSafeForDomClass(username)}Handlebars.registerHelper("getBotColorClassByUserName",getBotColorClassByUserName);function getMemberColorClassById(id){var member=TS.members.getMemberById(id);if(!member)return"color_unknown";return"color_"+member.id+" color_"+member.color}Handlebars.registerHelper("getMemberColorClassById",getMemberColorClassById);Handlebars.registerHelper("getMemberColorClassByImId",function(im_id){var im=TS.ims.getImById(im_id);if(!im)return"color_unknown";return getMemberColorClassById(im.user)});Handlebars.registerHelper("msgIsFromSelf",function(options){var msg=options.hash.msg;var id=msg.user;if(!id&&msg.subtype=="file_comment"&&msg.comment)id=msg.comment.user;var member=TS.members.getMemberById(id);if(!member)return options.inverse(this);if(member.is_self){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("memberIsSelf",function(options){var member=TS.members.getMemberById(options.hash.id);if(!member)return options.inverse(this);if(member.is_self){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("memberIsAdmin",function(options){var member=TS.members.getMemberById(options.hash.id);if(!member)return options.inverse(this);if(member.is_admin){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("currentUserIsAdmin",function(options){
if(TS.model.user.is_admin){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("currentUserIsOwner",function(options){if(TS.model.user.is_owner){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("currentUserIsRA",function(options){if(TS.model.user.is_restricted){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("currentUserIsURA",function(options){if(TS.model.user.is_ultra_restricted){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("tinyspeck",function(options){if(TS.model.team.domain=="tinyspeck"){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("makeUnshareLinkById",function(id){var file=TS.files.getFileById(TS.web.file.file_id);var ob=TS.shared.getModelObById(id);if(ob)return TS.templates.builders.makeUnshareLink(ob,file)});Handlebars.registerHelper("makeUnshareLink",function(ob){var file=TS.files.getFileById(TS.web.file.file_id);return TS.templates.builders.makeUnshareLink(ob,file)});Handlebars.registerHelper("makeFileDomId",function(file){return TS.templates.makeFileDomId(file)});Handlebars.registerHelper("makeFileCommentsDomId",function(file){return TS.templates.makeFileCommentsDomId(file)});Handlebars.registerHelper("makeFileContentsDomId",function(file){return TS.templates.makeFileContentsDomId(file)});Handlebars.registerHelper("makeFileHeader",function(file,member){var is_post_or_space=file.mode=="space"||file.mode=="post";var is_snippet=file.mode=="snippet";return TS.templates.file_header({file:file,download:file.mode==="hosted",edit:(is_post_or_space||is_snippet)&&file.user===TS.model.user.id,member:member,is_post_or_space:is_post_or_space})});Handlebars.registerHelper("makeFilePreviewHeader",function(file,member){var is_post=file.mode=="post";var is_post_or_space=file.mode=="space"||file.mode=="post";var is_snippet=file.mode=="snippet";return TS.templates.file_header({file:file,download:file.mode==="hosted",edit_link:is_post?file.edit_link:file.permalink,edit:(is_post_or_space||is_snippet)&&file.user===TS.model.user.id,member:member,is_post:is_post,is_post_or_space:is_post_or_space,is_snippet:is_snippet,preview:true})});Handlebars.registerHelper("makeFileSize",function(file){return TS.utility.convertFilesize(file.size)+" "+file.pretty_type});Handlebars.registerHelper("formatSpaceHtml",function(html){function replace_emoji(root_node){if(root_node.childNodes){for(var i=0;i<root_node.childNodes.length;i++){replace_emoji(root_node.childNodes[i])}}if(root_node.nodeType==Node.TEXT_NODE){var safe_text_content=TS.utility.htmlEntities(root_node.textContent);var emojified_html=TS.emoji.graphicReplace(TS.emoji.replaceEmoticons(safe_text_content),{include_title:true,include_text:false});if(emojified_html!==safe_text_content){var emojified_node=$("<span>").html(emojified_html)[0];[].slice.apply(emojified_node.childNodes).forEach(function(new_node){root_node.parentNode.insertBefore(new_node,root_node)});root_node.parentNode.removeChild(root_node)}}}var $container=$("<div>").html(html);replace_emoji($container[0]);if(TS.client&&TS.client.ui){TS.client.ui.unfurlPlaceholders($container)}return $container.html()});Handlebars.registerHelper("fileIsImage",function(options){var file=TS.files.getFileById(options.hash.id);if(!file)return options.inverse(this);if(file.mimetype&&file.mimetype.indexOf("image/")===0){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("mimeTypeIsImage",function(options){if(options.hash.type&&options.hash.type.indexOf("image/")===0){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("fileDefaultIsNewWindow",function(options){options=_optionsFnInverseBooleanHelper(options);var file=TS.files.getFileById(options.hash.id);if(!file)return options.inverse(this);var new_window_for_mimetype=file.mimetype&&file.mimetype.indexOf("image/")===0&&file.mimetype.indexOf("svg")===-1;var new_window_for_filetype=file.filetype==="pdf";if(new_window_for_mimetype||new_window_for_filetype){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("fileIconTypeDownload",function(){var args=Array.prototype.slice.call(arguments);var options=_optionsFnInverseBooleanHelper(args.pop());var file=args[0];if(typeof file==="string")file=TS.files.getFileById(file);if(!file)return options.inverse(this);var new_window_for_mode=file.mode==="external";var new_window_for_mimetype=file.mimetype&&file.mimetype.indexOf("image/")===0&&file.mimetype.indexOf("svg")===-1;var new_window_for_filetype=file.filetype==="pdf";if(new_window_for_mode||new_window_for_mimetype||new_window_for_filetype){return options.inverse(this)}else{return options.fn(this)}});Handlebars.registerHelper("makeFilePrivacyLabel",function(file){var label="";if(file.is_public){label="Shared"}else{if(file.groups.length>0||file.ims.length>0){label="Private"}else{label="Draft"}}return label});Handlebars.registerHelper("makeExternalFiletypeHTML",function(file){return TS.templates.builders.makeExternalFiletypeHTML(file)});Handlebars.registerHelper("makeFileShareLabel",function(file){return TS.templates.builders.makeFileShareLabel(file)});Handlebars.registerHelper("makeFileGroupChannelList",function(file){return TS.templates.builders.makeFileGroupChannelList(file)});Handlebars.registerHelper("nl2brAndHighlightSearchMatches",function(text){if(!text)return;text=TS.utility.htmlEntities(text);text=text.replace(/\n/g,"<br />");return TS.utility.msgs.handleSearchHighlights(text)});Handlebars.registerHelper("maybeGetIconForTeamProfileField",function(label){var icons=["slack","apple","android","twitter","github","google","windows","youtube","skype","facebook","asana","linkedin","tumblr","instagram","soundcloud","flickr","pinterest","tripit","hangouts","viber","line"];label=label.toLowerCase();if(~icons.indexOf(label))return'<i class="ts_icon ts_icon_'+label+'"></i>'});Handlebars.registerHelper("getVisibleTeamProfileFieldsForMember",function(member){var fields=TS.team.getVisibleTeamProfileFieldsForMember(member);return TS.templates.team_profile_fields({fields:fields})});Handlebars.registerHelper("isSkypeTeamProfileField",function(field,options){if(field.type==="text"&&field.label.toLocaleLowerCase()==="skype"){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("getSafeSkypeURLComponent",function(name){var match=name.match(/^[a-zA-Z][a-zA-Z0-9\.,\-_]{5,31}/);return match?match[0]:""});Handlebars.registerHelper("highlightSearchMatches",function(text){if(!text)return;text=TS.utility.htmlEntities(text);return TS.utility.msgs.handleSearchHighlights(text)});Handlebars.registerHelper("highlightSearchMatchesInSpacesHtml",function(html){if(!html)return;var formatted_html=Handlebars.helpers.formatSpaceHtml(html);return TS.utility.msgs.handleSearchHighlights(formatted_html)});Handlebars.registerHelper("highlightSearchMatchesInFileTitle",function(text){if(!text)return;text=TS.emoji.graphicReplace(text);return TS.utility.msgs.handleSearchHighlights(text)});Handlebars.registerHelper("searchFilter",function(){if(!TS.search.filter)return;return TS.search.filter});Handlebars.registerHelper("searchSort",function(){if(!TS.search.sort)return;return TS.search.sort});Handlebars.registerHelper("makeUnreadMessagesDomId",function(item){return TS.templates.makeUnreadMessagesDomId(item)});Handlebars.registerHelper("makeUnreadGroupMessagesDomId",function(item){return TS.templates.makeUnreadGroupMessagesDomId(item)});Handlebars.registerHelper("makeUnreadDmsDomId",function(item){return TS.templates.makeUnreadDmsDomId(item)});Handlebars.registerHelper("makeSentMessagesDomId",function(item){return TS.templates.makeSentMessagesDomId(item)});Handlebars.registerHelper("makeSentGroupMessagesDomId",function(item){return TS.templates.makeSentGroupMessagesDomId(item)});Handlebars.registerHelper("makeSentDmsDomId",function(item){return TS.templates.makeSentDmsDomId(item)});Handlebars.registerHelper("makeIssueListDomId",function(date_str){return TS.templates.makeIssueListDomId(date_str)});Handlebars.registerHelper("addIndefiniteArticle",function(word_str){if(typeof word_str!=="string"){return word_str}var vowels=["a","e","i","o","u"];var first_letter=word_str.charAt(0).toLowerCase();var starts_with_vowel=vowels.some(function(vowel){return first_letter===vowel});return starts_with_vowel?"an "+word_str:"a "+word_str});Handlebars.registerHelper("math",function(lvalue,operator,rvalue,options){if(arguments.length<4){options=rvalue;rvalue=operator;operator="+"}lvalue=parseFloat(lvalue);rvalue=parseFloat(rvalue);return{"+":lvalue+rvalue,"-":lvalue-rvalue,"*":lvalue*rvalue,"/":lvalue/rvalue,"%":lvalue%rvalue}[operator]});Handlebars.registerHelper("loadingHTML",function(){var url=cdn_url+"/f85a/img/loading_hash_animation_@2x.gif";return new Handlebars.SafeString('<div class="loading_hash_animation"><img src="'+url+'" alt="Loading" /><br />loading...</div>')});Handlebars.registerHelper("versioned_loading_animation",function(){return cdn_url+"/272a/img/loading.gif"});Handlebars.registerHelper("versioned_loading_hash_animation",function(){return cdn_url+"/f85a/img/loading_hash_animation_@2x.gif"});Handlebars.registerHelper("versioned_mac_dock_badge",function(){return cdn_url+"/9135/img/prefs_mac_dock_badge@2x.png"});Handlebars.registerHelper("versioned_prefs_messages_clean",function(){return cdn_url+"/e5d8/img/prefs_messages_clean@2x.png"});Handlebars.registerHelper("versioned_prefs_messages_compact",function(){return cdn_url+"/e5d8/img/prefs_messages_compact@2x.png"});Handlebars.registerHelper("versioned_services_box_32",function(){return cdn_url+"/9a0a/plugins/auth/box/assets/auth_32.png"});Handlebars.registerHelper("versioned_services_gdrive_16",function(){return cdn_url+"/66f9/img/services/gdrive_16.png"});Handlebars.registerHelper("versioned_services_onedrive_32",function(){return cdn_url+"/da92/plugins/onedrive/assets/service_32.png"});Handlebars.registerHelper("versioned_slackbot_48",function(){return cdn_url+"/66f9/img/slackbot_48.png"});Handlebars.registerHelper("versioned_theme_thumb_brinjal",function(){return cdn_url+"/d7a0/img/themes/brinjal@2x.png"});Handlebars.registerHelper("versioned_theme_thumb_chocolate",function(){return cdn_url+"/d7a0/img/themes/chocolate@2x.png"});Handlebars.registerHelper("versioned_theme_thumb_default",function(){return cdn_url+"/d7a0/img/themes/aubergine@2x.png"});Handlebars.registerHelper("versioned_theme_thumb_hoth",function(){return cdn_url+"/d7a0/img/themes/hoth@2x.png"});Handlebars.registerHelper("versioned_theme_thumb_monument",function(){return cdn_url+"/d7a0/img/themes/monument@2x.png"});Handlebars.registerHelper("versioned_theme_thumb_ocean",function(){return cdn_url+"/d7a0/img/themes/ochin@2x.png"});Handlebars.registerHelper("versioned_theme_thumb_solanum",function(){return cdn_url+"/d7a0/img/themes/solanum@2x.png"});Handlebars.registerHelper("versioned_theme_thumb_workhard",function(){return cdn_url+"/d7a0/img/themes/workhard@2x.png"});Handlebars.registerHelper("pinnedFileType",function(file){if(!file)return"file";if(file.mode==="space")return"Post";if(file.mode==="snippet")return"text snippet";if(file.mode==="post")return"post";if(file.mode==="external"){var external_type=TS.templates.builders.makeExternalFiletypeHTML(file);if(external_type)return new Handlebars.SafeString(external_type)}return"file"});Handlebars.registerHelper("pinToLabel",function(model_ob){var text="";if(model_ob.is_channel)text+="#";if(model_ob.is_im||model_ob.is_mpim){text+="this conversation"}else{text+=TS.utility.htmlEntities(model_ob.name)}return new Handlebars.SafeString(text)});Handlebars.registerHelper("seeAllPinsLink",function(model_ob){var channel_type="channel";if(model_ob.is_im||model_ob.is_mpim){channel_type="conversation"}return new Handlebars.SafeString(TS.templates.see_all_pins_link({channel_type:channel_type}))});Handlebars.registerHelper("numberWithCommas",function(num){return TS.utility.numberWithCommas(num)});Handlebars.registerHelper("makeModelObHotnessIconSafe",function(model_ob){var html='<div class="'+TS.templates.makeHotnessIconDomClasses(model_ob)+'" id="'+TS.templates.makeHotnessIconDomId(model_ob)+'">'+TS.emoji.graphicReplace(":fire:")+"</div>";return new Handlebars.SafeString(html)});Handlebars.registerHelper("makeSHRoomParticipantList",TS.templates.builders.makeSHRoomParticipantList);Handlebars.registerHelper("makeSHRoomSharedList",TS.templates.builders.makeSHRoomSharedList);Handlebars.registerHelper("channelsAndGroupsCopy",function(options){return TS.templates.builders.channelsAndGroupsCopy(options.hash)});Handlebars.registerHelper("channelsAndPrivateGroupsCopy",function(options){return TS.templates.builders.channelsAndPrivateGroupsCopy(options.hash)});Handlebars.registerHelper("channelsOrGroupsCopy",function(options){return TS.templates.builders.channelsOrGroupsCopy(options.hash)});Handlebars.registerHelper("channelOrGroupCopy",function(options){return TS.templates.builders.channelOrGroupCopy(options.hash)});Handlebars.registerHelper("channelOrPrivateGroupCopy",function(options){return TS.templates.builders.channelOrPrivateGroupCopy(options.hash)});Handlebars.registerHelper("privateGroupsCopy",function(options){return TS.templates.builders.privateGroupsCopy(options.hash)});Handlebars.registerHelper("privateGroupCopy",function(options){return TS.templates.builders.privateGroupCopy(options.hash)});Handlebars.registerHelper("groupCopy",function(options){return TS.templates.builders.groupCopy(options.hash)});Handlebars.registerHelper("channelDmOrGroupCopy",function(options){return TS.templates.builders.channelDmOrGroupCopy(options.hash)});Handlebars.registerHelper("channelsDmsOrGroupsCopy",function(options){return TS.templates.builders.channelsDmsOrGroupsCopy(options.hash)});Handlebars.registerHelper("channelsDmsAndPrivateGroupsCopy",function(options){return TS.templates.builders.channelsDmsAndPrivateGroupsCopy(options.hash)});Handlebars.registerHelper("channelGroupOrDirectMessageCopy",function(options){return TS.templates.builders.channelGroupOrDirectMessageCopy(options.hash)});Handlebars.registerHelper("raLabel",function(old_label){if(!TS.boot_data.feature_rename_ra)return old_label;return TS.templates.builders.raLabel(old_label)});Handlebars.registerHelper("renderAttachmentActions",function(attachment){if(!TS.boot_data.feature_attachment_actions)return;var rendered_actions=attachment.actions.map(function(action){switch(action.type){case"button":return TS.templates.builders.buildAttachmentActionButtonHTML(action)}});var actions_html=rendered_actions.join("");return actions_html});Handlebars.registerHelper("getMemberTypeClass",TS.templates.builders.getMemberTypeClass)},test:function(){return{_optionsFnInverseBooleanHelper:_optionsFnInverseBooleanHelper,_inlineImgSrcForFile:_inlineImgSrcForFile}}});var _optionsFnInverseBooleanHelper=function(options){if(typeof options.fn!=="function"){options.fn=function(){return true}}if(typeof options.inverse!=="function"){options.inverse=function(){return false}}return options};var _inlineImgSrcForFile=function(file,max_image_size){if(typeof file==="string")file=TS.files.getFileById(file);if(!file)return false;if(!TS.files.fileIsImage(file))return false;if(!max_image_size)max_image_size=480;return TS.files.getThumbSrcForFile(file,{max_size:max_image_size})}})();(function(){"use strict";TS.registerModule("utility.date",{month_names:["January","February","March","April","May","June","July","August","September","October","November","December"],short_month_names:["Jan","Feb","March","April","May","June","July","Aug","Sept","Oct","Nov","Dec"],really_short_month_names:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],day_names:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],short_day_names:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],ones_digit_names:["zero","one","two","three","four","five","six","seven","eight","nine","ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"],tens_digit_names:["twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"],ones_digit_ordinal_names:["zeroth","first","second","third","fourth","fifth","sixth","seventh","eighth","ninth","tenth","eleventh","twelveth"],onStart:function(){},toDateObject:function(ts){var date;if(ts&&typeof ts=="string"&&ts.indexOf("-")>-1){var A=ts.split("-");if(A.length>=3){date=new Date(A[0],A[1]-1,A[2])}else{date=new Date(0)}}else{var ts_string=(ts||"0").toString();if(ts_string.indexOf(".")!=-1){date=new Date(ts_string.split(".")[0]*1e3)}else{date=new Date(ts*1e3)}}return date},toTime:function(ts,ampm,seconds){var date=TS.utility.date.toDateObject(ts);var hours=date.getHours();var minutes=date.getMinutes();var secs=date.getSeconds();var pm=false;if(TS.utility.date.do24hrTime()){if(hours<10){hours="0"+hours}}else{if(hours>=12){if(hours>12)hours=hours-12;pm=true}else if(hours===0){hours=12}}if(minutes<10){minutes="0"+minutes}var secs_string="";if(seconds){if(secs<10){secs_string=":0"+secs}else{secs_string=":"+secs}}var formatted_time=hours+":"+minutes+secs_string;if(ampm&&!TS.utility.date.do24hrTime()){if(pm){formatted_time+=" PM"}else{formatted_time+=" AM"}}return formatted_time},toTimeDuration:function(seconds){var time=TS.utility.date.toTimeAmount(Math.floor(seconds/60));time.s=seconds%60;var str="";if(time.w){var week_str=time.w===1?" week ":" weeks ";str+=time.w+week_str}if(time.d){var day_str=time.d===1?" day ":" days ";str+=time.d+day_str}if(time.h){var hour_str=time.h===1?" hour ":" hours ";str+=time.h+hour_str}if(time.mi)str+=time.mi+" min ";if(time.s||str.length===0)str+=time.s+" sec ";str=str.trim();return str},toTimeAmount:function(minutes){var time={w:TS.utility.date.toWeekAmount(minutes),d:TS.utility.date.toDayAmount(minutes)-TS.utility.date.toWeekAmount(minutes)*7,h:TS.utility.date.toHourAmount(minutes)-TS.utility.date.toDayAmount(minutes)*24,mi:minutes%60};return time},toWeekAmount:function(minutes){return Math.floor(minutes/10080)},toDayAmount:function(minutes){return Math.floor(minutes/1440)},toHourAmount:function(minutes){return Math.floor(minutes/60)},toDate:function(ts,exclude_time){var date=TS.utility.date.toDateObject(ts);var year=date.getFullYear();var month=date.getMonth();var day=date.getDate();var hours=date.getHours();var minutes=date.getMinutes();var pm=false;if(TS.utility.date.do24hrTime()){if(hours<10){hours="0"+hours}}else{if(hours>=12){if(hours>12)hours=hours-12;pm=true}else if(hours===0){hours=12}}if(day<10){day="0"+day}if(minutes<10){minutes="0"+minutes}month=("0"+(month+1)).slice(-2);var formatted_time=year+"-"+month+"-"+day;if(exclude_time)return formatted_time;formatted_time+=", "+hours+":"+minutes;if(!TS.utility.date.do24hrTime()){if(pm){formatted_time+=" PM"}else{formatted_time+=" AM"}}return formatted_time},toHumanReadableDateAndTime:function(ts){var relative_day=TS.utility.date.maybeGetRelativeDay(ts);if(relative_day){var include_ampm=true;var time=TS.utility.date.toTime(ts,include_ampm);return relative_day+" at "+time}return TS.utility.date.toCalendarDateOrNamedDayShort(ts)},shouldExcludeYear:function(ts){var date=TS.utility.date.toDateObject(ts);var now=new Date;var a_month=31*24*60*60*1e3;return date.getFullYear()==now.getFullYear()||now-date<=a_month},toCalendarDateOrNamedDayShort:function(ts){var exclude_year=TS.utility.date.shouldExcludeYear(ts);return TS.utility.date.toCalendarDateOrNamedDay(ts,true,exclude_year)},do24hrTime:function(){if(TS.model.user&&TS.model.prefs&&TS.model.prefs.time24){return true}return false},toFilenameFriendlyDate:function(ts){var date=TS.utility.date.toDateObject(ts);var year=date.getFullYear();var month=date.getMonth();var day=date.getDate();var hours=date.getHours();var minutes=date.getMinutes();var pm=false;if(!TS.utility.date.do24hrTime()){if(hours>=12){if(hours>12)hours=hours-12;pm=true}else if(hours===0){hours=12}}if(day<10){day="0"+day}if(hours<10){hours="0"+hours}if(minutes<10){minutes="0"+minutes}month=("0"+(month+1)).slice(-2);var formatted_time=year+"_"+month+"_"+day+" "+hours+"_"+minutes;if(!TS.utility.date.do24hrTime()){if(pm){formatted_time+=" PM"}else{formatted_time+=" AM"}}return formatted_time},toCalendarDate:function(ts,min,exclude_year,very_min){var date=TS.utility.date.toDateObject(ts);var year=date.getFullYear();var month=date.getMonth();var day=date.getDate();var formatted_time;if(very_min){formatted_time=TS.utility.date.really_short_month_names[month]+" "+day}else if(min){formatted_time=TS.utility.date.short_month_names[month]+" "+TS.utility.ordinalNumber(day)}else{formatted_time=TS.utility.date.month_names[month]+" "+TS.utility.ordinalNumber(day)}if(!exclude_year)formatted_time+=", "+year;return formatted_time},maybeGetRelativeDay:function(ts){var date=TS.utility.date.toDateObject(ts);var today=new Date;var yesterday=new Date;yesterday.setDate(today.getDate()-1);if(TS.utility.date.sameDay(date,today)){return"Today"}else if(TS.utility.date.sameDay(date,yesterday)){return"Yesterday"}},toCalendarDateOrNamedDay:function(ts,min,exclude_year){var formatted_time;var relative_day=TS.utility.date.maybeGetRelativeDay(ts);exclude_year=exclude_year||TS.utility.date.shouldExcludeYear(ts);if(relative_day){formatted_time=relative_day}else{formatted_time=TS.utility.date.toCalendarDate(ts,min,exclude_year)}return formatted_time},toCalendarDateIfYesterdayOrToday:function(ts,min){var date=TS.utility.date.toDateObject(ts);var today=new Date;var yesterday=new Date;yesterday.setDate(today.getDate()-1);var formatted_time="";if(TS.utility.date.sameDay(date,today)){formatted_time=TS.utility.date.toCalendarDate(ts,min)}else if(TS.utility.date.sameDay(date,yesterday)){formatted_time=TS.utility.date.toCalendarDate(ts,min)}return formatted_time},toHour:function(ts){var date=TS.utility.date.toDateObject(ts);var hours=date.getHours();var pm=false;if(TS.utility.date.do24hrTime()){if(hours<10){hours="0"+hours}}else{if(hours>=12){if(hours>12)hours=hours-12;pm=true}else if(hours===0){hours=12}}var formatted_time=hours;if(!TS.utility.date.do24hrTime()){if(pm){formatted_time+=" PM"}else{formatted_time+=" AM"}}return""+formatted_time},toDayOfTheWeek:function(ts){var date=TS.utility.date.toDateObject(ts);return TS.utility.date.day_names[date.getDay()]},toTimeAgo:function(ts){var date=TS.utility.date.toDateObject(ts);var today=new Date;var raw_seconds=TS.utility.date.distanceInSeconds(today,date);var is_future=raw_seconds<0;var seconds=Math.abs(raw_seconds);var minutes=seconds/60;var hours=minutes/60;var days=hours/24;var months=days/(365/12);var years=days/365;var output="",prefix="",suffix="";if(seconds<45){output="less than a minute"}else if(seconds<90){output="about a minute"}else if(minutes<45){output=Math.round(minutes)+" minutes"}else if(minutes<90){output="about an hour"}else if(hours<24){output="about "+Math.round(hours)+" hours"}else if(hours<42){output="a day"}else if(days<30){output=Math.round(days)+" days"}else if(days<45){output="about a month"}else if(days<365){output=Math.round(months)+" months"}else if(years<1.5){output="about a year"}else{output=Math.round(years)+" years"}is_future?prefix="in ":suffix=" ago";return prefix+output+suffix},timezoneLabel:function(member,include_local_time){var tz_label="Pacific Standard Time";var tz_offset=-28800;if(typeof member.tz_label!="undefined")tz_label=member.tz_label;if(typeof member.tz_offset!="undefined")tz_offset=member.tz_offset;var tz_label_html="<span title='"+tz_label+"'><i class='ts_icon ts_icon_clock_o'></i> ";if(member.id==TS.model.user.id){if(TS.client){tz_label_html+=tz_label+" (<a href='/account/settings' target='new'>change</a>)"}else{tz_label_html+=tz_label+" (<a href='/account/settings'>change</a>)"}}else{var hours_offset_from_user=(TS.model.user.tz_offset-tz_offset)/60/60;if(include_local_time){tz_label_html+=TS.utility.date.memberLocalTime(member)+" / "}if(hours_offset_from_user===0){tz_label_html+="in your timezone"}else{tz_label_html+=Math.abs(hours_offset_from_user)+" hour";if(Math.abs(hours_offset_from_user)!=1)tz_label_html+="s"}if(hours_offset_from_user>0){tz_label_html+=" behind you"}else if(hours_offset_from_user<0){tz_label_html+=" ahead of you"}tz_label_html+=" "+TS.utility.date.memberUTCOffset(member)}tz_label_html+="</span>";return tz_label_html},memberLocalTime:function(member,as_text){var tz_offset=_memberTzOffset(member);var date=new Date;var utc=date.getTime()+date.getTimezoneOffset()*6e4;var member_date=new Date(utc+36e5*(tz_offset/3600));var local_time=TS.utility.date.toTime(member_date/1e3,true);var local_time_str;if(as_text){local_time_str=local_time}else{local_time_str='<span class="timezone_value">'+local_time+"</span> local time"}return local_time_str},memberUTCOffset:function(member){var tz_offset=_memberTzOffset(member);var hours_offset_from_utc=tz_offset/60/60;var html="";if(hours_offset_from_utc===0){html+="(UTC)"}else if(hours_offset_from_utc<0){html+="(UTC"+hours_offset_from_utc+")"}else if(hours_offset_from_utc>0){html+="(UTC+"+hours_offset_from_utc+")"}return html},fake_ts_unique_padder:"x",makeTsStamp:function(d,padder,unique_num){d=d||Date.now();padder=padder||TS.utility.date.fake_ts_unique_padder;unique_num=unique_num===undefined||unique_num===null?_getNewFakeTsUniquePart():unique_num;var unixtime=Math.floor(d/1e3).toString();var unique_str=TS.utility.padNumber(unique_num,6,padder);return unixtime+"."+unique_str},sameDay:function(date_a,date_b){return date_a.getFullYear()==date_b.getFullYear()&&date_a.getMonth()==date_b.getMonth()&&date_a.getDate()==date_b.getDate()},sameHour:function(date_a,date_b){return date_a.getFullYear()==date_b.getFullYear()&&date_a.getMonth()==date_b.getMonth()&&date_a.getDate()==date_b.getDate()&&date_a.getHours()==date_b.getHours()},distanceInSeconds:function(date_a,date_b){var diff_in_seconds=Math.round(date_a.getTime()/1e3)-Math.round(date_b.getTime()/1e3);return diff_in_seconds},distanceInMinutes:function(date_a,date_b){var diff_in_mins=TS.utility.date.distanceInSeconds(date_a,date_b)/60;return diff_in_mins},isToday:function(date_a){var today=new Date;return TS.utility.date.sameDay(date_a,today)},getNextActivityDayStamp:function(day_stamp){var date=TS.utility.date.toDateObject(day_stamp);var next_date=new Date(date.getTime()+864e5);var new_stamp=next_date.getFullYear()+"-"+TS.utility.padNumber(next_date.getMonth()+1,2,"0")+"-"+TS.utility.padNumber(next_date.getDate(),2,"0");return new_stamp},getPrevActivityDayStamp:function(day_stamp){var date=TS.utility.date.toDateObject(day_stamp);var next_date=new Date(date.getTime()-864e5);var new_stamp=next_date.getFullYear()+"-"+TS.utility.padNumber(next_date.getMonth()+1,2,"0")+"-"+TS.utility.padNumber(next_date.getDate(),2,"0");return new_stamp},toTimeWords:function(ts,ampm,seconds){var date=TS.utility.date.toDateObject(ts);var hours=date.getHours();var minutes=date.getMinutes();var secs=date.getSeconds();var pm=hours>=12;var oclock=minutes===0;var hours_words="";var minutes_words="";var minutes_prefix="";var seconds_words="";var ampm_words="";if(oclock&&(secs===0||!seconds)){if(hours===0)return"midnight";if(hours===12)return"noon"}if(!TS.utility.date.do24hrTime()){if(hours>=12){hours=hours-12}else if(hours===0){hours=12}}hours_words=TS.utility.date.numberToWords(hours);if(oclock){if(hours>12&&TS.utility.date.do24hrTime()){hours_words+=" hundred"}else{hours_words+=" o'clock"}}if(minutes!==0){minutes_prefix=" ";if(minutes<10)minutes_prefix+="oh-";minutes_words=TS.utility.date.numberToWords(minutes)}if(seconds&&secs!==0)seconds_words=" and "+TS.utility.date.numberToWords(secs)+" second"+(secs===1?"":"s");if(ampm&&!TS.utility.date.do24hrTime()){ampm_words=pm?" PM":" AM"}if(TS.utility.date.do24hrTime()&&hours===0){return minutes_words+" minute"+(minutes===1?"":"s")+seconds_words+" past midnight"}return hours_words+minutes_prefix+minutes_words+seconds_words+ampm_words},toCalendarDateWords:function(ts,exclude_year){var date=TS.utility.date.toDateObject(ts);var year=date.getFullYear();var month=date.getMonth();var day=date.getDate();var day_words=TS.utility.date.numberToWords(day,true);var month_words=TS.utility.date.month_names[month];var year_words="";if(!exclude_year){year_words=", ";if(year%1e3===0){year_words+=TS.utility.date.numberToWords(year/1e3)+"-thousand"}else if(year%100===0){year_words+=TS.utility.date.numberToWords(year/100)+" hundred"}else if(year%1e3<10){year_words+=TS.utility.date.numberToWords((year-year%1e3)/1e3)+"-thousand and "+TS.utility.date.numberToWords(year%1e3)}else{year_words+=TS.utility.date.numberToWords((year-year%100)/100)+" "+(year%100<10?"oh-":"")+TS.utility.date.numberToWords(year%100)}}return month_words+" "+day_words+year_words},toCalendarDateOrNamedDayWords:function(ts,exclude_year){var date=TS.utility.date.toDateObject(ts);var today=new Date;var yesterday=new Date;yesterday.setDate(today.getDate()-1);var formatted_time;if(TS.utility.date.sameDay(date,today)){formatted_time="Today"}else if(TS.utility.date.sameDay(date,yesterday)){formatted_time="Yesterday"}else{formatted_time=TS.utility.date.toCalendarDateWords(ts,exclude_year)}return formatted_time},numberToWords:function(num,ordinal){var tens,ones,result="";if(ordinal){if(num<TS.utility.date.ones_digit_ordinal_names.length){result=TS.utility.date.ones_digit_ordinal_names[num]}else{tens=Math.floor(num/10);ones=num%10;if(num<TS.utility.date.ones_digit_names.length){result=TS.utility.date.ones_digit_names[num]+"th"}else if(tens<=9){if(ones===0){result=TS.utility.date.tens_digit_names[tens-2].replace(/y$/,"ieth")}else{result=TS.utility.date.tens_digit_names[tens-2];result+="-"+TS.utility.date.ones_digit_ordinal_names[ones]}}}}else{if(num<TS.utility.date.ones_digit_names.length){result=TS.utility.date.ones_digit_names[num]}else{tens=Math.floor(num/10);ones=num%10;if(tens<=9){result=TS.utility.date.tens_digit_names[tens-2];if(ones>0){result+="-"+TS.utility.date.ones_digit_names[ones]}}}}return result},formatDate:function(string,unix_time,fallback_string){var date_obj=new Date(unix_time*1e3);var today=new Date;var ts=TS.utility.date.makeTsStamp(date_obj);var distance_in_minutes=TS.utility.date.distanceInMinutes(date_obj,today);var exclude_year=distance_in_minutes>-182*24*60&&distance_in_minutes<182*24*60;var capitalize=false,invalid_token_found=false;if(!fallback_string)fallback_string=string;if(isNaN(date_obj.getTime()))return fallback_string;string=string.replace(/{(.*?)}/g,function(match,token){var replacement;switch(token){case"date_num":return TS.utility.date.toDate(ts,true);case"date_long":return TS.utility.date.toDayOfTheWeek(ts)+", "+TS.utility.date.toCalendarDate(ts,false,exclude_year);case"date_long_pretty":replacement=TS.utility.date.prettifyDateString(ts,TS.utility.date.toDayOfTheWeek(ts)+", "+TS.utility.date.toCalendarDate(ts,false,exclude_year));if(!capitalize&&string.indexOf("{date_long_pretty}")===0&&["today","yesterday","tomorrow"].indexOf(replacement)!==-1)capitalize=true;return replacement;case"date":return TS.utility.date.toCalendarDate(ts,false,exclude_year);case"date_pretty":replacement=TS.utility.date.prettifyDateString(ts,TS.utility.date.toCalendarDate(ts,false,exclude_year));if(!capitalize&&string.indexOf("{date_pretty}")===0&&["today","yesterday","tomorrow"].indexOf(replacement)!==-1)capitalize=true;return replacement;case"date_short":return TS.utility.date.toCalendarDate(ts,true,exclude_year,true);case"date_short_pretty":replacement=TS.utility.date.prettifyDateString(ts,TS.utility.date.toCalendarDate(ts,true,exclude_year,true));if(!capitalize&&string.indexOf("{date_short_pretty}")===0&&["today","yesterday","tomorrow"].indexOf(replacement)!==-1)capitalize=true;return replacement;case"time":return TS.utility.date.toTime(ts,true);case"time_secs":return TS.utility.date.toTime(ts,true,true);case"ago":replacement=TS.utility.date.toTimeAgo(ts);if(!capitalize&&string.indexOf("{ago}")===0)capitalize=true;return replacement;
default:invalid_token_found=true;return""}});if(invalid_token_found)return fallback_string;if(capitalize)string=string.charAt(0).toUpperCase()+string.slice(1);return string},prettifyDateString:function(ts,fallback_date_string){var date=TS.utility.date.toDateObject(ts);var today=new Date;var yesterday=new Date((new Date).valueOf()-1e3*60*60*24);var tomorrow=new Date((new Date).valueOf()+1e3*60*60*24);if(TS.utility.date.sameDay(date,today))return"today";if(TS.utility.date.sameDay(date,yesterday))return"yesterday";if(TS.utility.date.sameDay(date,tomorrow))return"tomorrow";return fallback_date_string},millisecondsToPrettifiedTime:function(milliseconds){var s=Math.floor(milliseconds/1e3);var hours=Math.floor(s/3600);var minutes=Math.floor((s-hours*3600)/60);var seconds=s-hours*3600-minutes*60;var time="";if(hours!==0)time=hours+":";time+=minutes<10?"0"+minutes:String(minutes);time+=":";time+=seconds<10?"0"+seconds:String(seconds);return time},daysToYearsPretty:function(d){var days=parseInt(d);if(days<365&&days>1||days===0)return days+" days";if(days===1)return"1 day";var years,output="";if(days%365===0){years=days/365;days=0}else{years=Math.floor(days/365);days=days%365}output=years>1?years+" years":years+" year";if(days>1){output+=", "+days+" days"}else if(days===1){output+=", 1 day"}return output}});var _fake_ts_unique_incrementer=1;var _memberTzOffset=function(member){var tz_offset=-28800;if(typeof member.tz_offset!="undefined")tz_offset=member.tz_offset;return tz_offset};var _getNewFakeTsUniquePart=function(){_fake_ts_unique_incrementer++;if(_fake_ts_unique_incrementer>=1e5)_fake_ts_unique_incrementer=1;return _fake_ts_unique_incrementer}})();(function(){"use strict";TS.registerModule("utility.msgs",{automated_subtypes:["channel_join","channel_leave","channel_topic","channel_purpose","channel_archive","channel_unarchive","group_join","group_leave","group_topic","group_purpose","group_archive","group_unarchive","group_name","channel_name","play_sound","pinned_item","unpinned_item","sh_room_shared","sh_room_created","bot_enable","bot_disable","bot_add","bot_remove","reminder_add","reminder_delete"],file_subtypes:["file_comment","file_mention","file_share","file_upload"],allowed_embed_attributes:["class","name","id","src","width","oldwidth","height","oldheight","frameborder","title","scrolling","allowtransparency","allowfullscreen","oallowfullscreen","msallowfullscreen","webkitallowfullscreen","mozallowfullscreen","controls","autoplay","loop","muted","poster","preload","webkit-playsinline","type"],ephemeral_msgs_map:{},onStart:function(){},appendMsg:function(msgs,msg){msgs.unshift(TS.utility.msgs.makeSureMsgObIsValid(msg))},setMsgs:function(model_ob,msgs){for(var i=0;i<msgs.length;i++){msgs[i]=TS.utility.msgs.makeSureMsgObIsValid(msgs[i])}TS.utility.msgs.sortMsgs(msgs);model_ob.msgs=msgs;TS.utility.msgs.maybeStoreMsgs(model_ob.id,model_ob.msgs);return model_ob.msgs},spliceMsg:function(msgs,msg){var i=msgs.indexOf(msg);if(i>-1){msgs.splice(i,1)}},getNonTempMsgFromUserMatchingText:function(text,user_id,msgs){if(!text&&text!==0)return null;var msg;for(var i=0;i<msgs.length;i++){msg=msgs[i];if(msg.user!=user_id)continue;if(TS.utility.msgs.isTempMsg(msg))continue;if(msg.text==text)return msg}return null},getMsgByProp:function(name,value,msgs){if(!value&&value!==0)return null;var msg;for(var i=0;i<msgs.length;i++){msg=msgs[i];if(msg[name]==value)return msg}return null},getEditableMsgByProp:function(name,value,msgs){if(!value&&value!==0)return null;var msg;for(var i=0;i<msgs.length;i++){msg=msgs[i];if(msg.subtype&&msg.subtype!="me_message")continue;if(msg[name]==value)return msg}return null},sortMsgs:function(msgs){function compare(a,b){if(a.ts<b.ts)return 1;if(a.ts>b.ts)return-1;return 0}msgs.sort(compare)},getPrevDisplayedMsg:function(ts,msgs){var msg;var return_next_displayable_msg=false;for(var i=0;i<msgs.length;i++){msg=msgs[i];if(return_next_displayable_msg){if(!msg.no_display&&!msg._jl_rolled_up_in){return msg}}else if(msg.ts==ts){return_next_displayable_msg=true}}return null},getDisplayedMsgs:function(msgs){var A=[];var msg;for(var i=0;i<msgs.length;i++){msg=msgs[i];if(!msg.no_display&&!msg._jl_rolled_up_in){A.push(msg)}}return A},getDisplayedMsgAfterTS:function(ts,msgs){var msg;for(var i=msgs.length-1;i>-1;i--){msg=msgs[i];if(msg.ts>ts){if(!msg.no_display&&!msg._jl_rolled_up_in){return msg}}}return null},getDisplayedMsgBeforeTS:function(ts,msgs){var msg;for(var i=0;i<msgs.length;i++){msg=msgs[i];if(msg.ts<ts){if(!msg.no_display&&!msg._jl_rolled_up_in){return msg}}}return null},getUnreadCountableMsgAfterTS:function(ts,msgs){var msg;for(var i=msgs.length-1;i>-1;i--){msg=msgs[i];if(msg.ts>ts){if(TS.utility.msgs.msgCanCountAsUnread(msg)){return msg}}}return null},getMarkMsgForUnreadPoint:function(id,msgs){var mark_msg=TS.utility.msgs.getPrevDisplayedMsg(id,msgs)||TS.utility.msgs.getMsg(id,msgs);if(!mark_msg){TS.log(471,"getMarkMsgForUnreadPoint was passed an invalid id:"+id);return null}while(mark_msg&&!TS.utility.msgs.getUnreadCountableMsgAfterTS(mark_msg.ts,msgs)){mark_msg=TS.utility.msgs.getPrevDisplayedMsg(mark_msg.ts,msgs)}if(!mark_msg){TS.log(471,"getMarkMsgForUnreadPoint could not find any messages after id:"+id+" that could count as unread");return null}return mark_msg},getMsg:function(id,msgs){if(!msgs)return null;return TS.utility.msgs.getMsgByProp("ts",id,msgs)},getMsgByRspId:function(rsp_id,msgs){if(!msgs)return null;return TS.utility.msgs.getMsgByProp("rsp_id",rsp_id,msgs)},canEditMsg:function(msg){if(msg.user!==TS.model.user.id)return false;if(TS.model.team.prefs.msg_edit_window_mins>-1&&(Date.now()-TS.utility.date.toDateObject(msg.ts))/6e4>TS.model.team.prefs.msg_edit_window_mins){return false}if(TS.utility.msgs.isAutomatedMsg(msg))return false;if(TS.utility.msgs.isFileMsg(msg))return false;return true},isAutomatedMsg:function(msg){return TS.utility.msgs.automated_subtypes.indexOf(msg.subtype)>=0},isFileMsg:function(msg){return msg&&TS.utility.msgs.file_subtypes.indexOf(msg.subtype)>=0},getMsgActions:function(msg,model_ob){if(!msg)return;model_ob=model_ob||TS.shared.getActiveModelOb();var actions={edit_msg:TS.utility.msgs.canEditMsg(msg),delete_msg:true};var msg_belongs_to_user=false;if(msg.user==TS.model.user.id)msg_belongs_to_user=true;if(msg.file&&msg.file.mode==="email"){actions.open_original=true}if(!TS.model.team.prefs.allow_message_deletion){if(!TS.model.user.is_admin){actions.delete_msg=false}else if(TS.model.active_im_id&&!msg_belongs_to_user){actions.delete_msg=false}}else{if(TS.model.active_im_id){if(!msg_belongs_to_user&&msg.user!="USLACKBOT"&&msg.subtype!="bot_message"){actions.delete_msg=false}}else if(!msg_belongs_to_user){if(!TS.model.user.is_admin){actions.delete_msg=false}}else if(TS.utility.msgs.isAutomatedMsg(msg)){if(!TS.model.user.is_admin&&msg.subtype!=="pinned_item"&&msg.subtype!=="sh_room_created"&&msg.subtype!=="sh_room_shared"){actions.delete_msg=false}}}if(msg.is_ephemeral){actions.delete_msg=true}else{if(TS.client&&msg.subtype!=="pinned_item"&&msg.subtype!=="unpinned_item"){if(TS.pins.canUserPinHere(model_ob)){if(TS.pins.isMessagePinned(msg,model_ob)){actions.unpin_msg=true}else{actions.pin_msg=true}}}if(msg.subtype=="file_comment"){actions.add_file_comment_rxn=true}else if(TS.utility.msgs.isFileMsg(msg)){actions.add_file_rxn=true}else{actions.add_rxn=true}if(TS.clipboard.canWriteText()){actions.copy_link=true}}if(TS.client)actions.mark_unread=true;if(TS.replies&&TS.replies.isEnabled()){actions.jump_to_original=true;if(TS.replies.canReplyToMsg(model_ob,msg)){actions.reply=true}}if(TS.boot_data.feature_reminders_v3_ui){actions.remind_me=true;if(actions.jump_to_original||actions.copy_link||actions.mark_unread||actions.remind_me){actions.has_private_actions=true}if(actions.copy_link||actions.add_rxn||actions.add_file_rxn||actions.add_file_comment_rxn||actions.pin_msg||actions.unpin_msg){actions.has_public_actions=true}}return actions},maybeStoreMsgs:function(id,msgs,force){if(!TS.client)return;msgs=TS.utility.msgs.prepareMsgsForLS(msgs,id);var existing=!force&&TS.storage.fetchMsgsRaw(id);if(force||!existing||!TS.utility.areSimpleObjectsEqual(existing,msgs,"msgs of c_id:"+id)){TS.storage.storeMsgs(id,msgs)}},validateMsg:function(id,msg,msgs){if(!msg.ts){TS.error("msg lacks a ts ("+id+")");TS.dir(0,msg);return false}if(TS.utility.msgs.getMsg(msg.ts,msgs)){TS.warn("msg "+msg.ts+" already exists! ("+id+")");TS.dir(0,msg);return false}return true},findMsg:function(ts,c_id){var model_ob=TS.shared.getModelObById(c_id);var msg=model_ob&&model_ob.msgs&&TS.utility.msgs.getMsg(ts,model_ob.msgs);if(msg)return msg;msg=model_ob&&model_ob._archive_msgs&&TS.utility.msgs.getMsg(ts,model_ob._archive_msgs);if(msg)return msg;var mention=TS.mentions.getMentionByMsgId(ts);if(mention)return mention.message;return null},replaceMsg:function(model_ob,new_msg,might_not_exist){var original_msg=TS.utility.msgs.getMsg(new_msg.ts,model_ob.msgs);if(!original_msg&&model_ob._archive_msgs){original_msg=TS.utility.msgs.getMsg(new_msg.ts,model_ob._archive_msgs)}if(!original_msg){if(!might_not_exist)TS.error("unknown msg:"+new_msg.ts+" in "+model_ob.id);return}new_msg._rxn_key=original_msg._rxn_key;if(!new_msg.pinned_to){new_msg.pinned_to=original_msg.pinned_to}if(!("is_starred"in new_msg)){new_msg.is_starred=original_msg.is_starred}var comment=null;if(new_msg.comment&&new_msg.file){var file=TS.files.getFileById(new_msg.file.id);if(file){TS.files.editCommentOnFile(new_msg.comment,file);comment=TS.files.getFileCommentById(file,new_msg.comment.id)}}new_msg=TS.utility.msgs.processImsg(new_msg,model_ob.id);if(comment)new_msg.comment=comment;var changed_keys=_.union(Object.keys(new_msg),Object.keys(original_msg)).filter(function(key){return new_msg[key]!=original_msg[key]});if(!changed_keys.length){TS.info("Not signalling message change because it doesn't look like anything has changed");return}var k;for(k in original_msg){delete original_msg[k]}for(k in new_msg){original_msg[k]=new_msg[k]}if(TS.boot_data.feature_message_replies){if(model_ob.is_channel){TS.channels.message_changed_sig.dispatch(model_ob,original_msg,changed_keys)}else if(model_ob.is_im){TS.ims.message_changed_sig.dispatch(model_ob,original_msg,changed_keys)}else if(model_ob.is_group&&model_ob.is_mpim){TS.mpims.message_changed_sig.dispatch(model_ob,original_msg,changed_keys)}else if(model_ob.is_group&&!model_ob.is_mpim){TS.groups.message_changed_sig.dispatch(model_ob,original_msg,changed_keys)}}else{if(model_ob.id==TS.model.active_im_id){TS.ims.message_changed_sig.dispatch(model_ob,original_msg,changed_keys)}else if(model_ob.id==TS.model.active_channel_id){TS.channels.message_changed_sig.dispatch(model_ob,original_msg,changed_keys)}else if(model_ob.id==TS.model.active_group_id){TS.groups.message_changed_sig.dispatch(model_ob,original_msg,changed_keys)}else if(model_ob.id==TS.model.active_mpim_id){TS.mpims.message_changed_sig.dispatch(model_ob,original_msg,changed_keys)}}TS.utility.msgs.maybeStoreMsgs(model_ob.id,model_ob.msgs)},removeEphemeralMsg:function(c_id,ephemeral_msg_ts){var model_ob=TS.groups.getGroupById(c_id)||TS.channels.getChannelById(c_id);if(!model_ob)return;if(model_ob.is_channel){TS.channels.removeMsg(c_id,TS.utility.msgs.getMsg(ephemeral_msg_ts,model_ob.msgs))}else if(TS.boot_data.feature_mpim_client&&model_ob.is_mpim){TS.mpims.removeMsg(c_id,TS.utility.msgs.getMsg(ephemeral_msg_ts,model_ob.msgs))}else if(model_ob.is_group){TS.groups.removeMsg(c_id,TS.utility.msgs.getMsg(ephemeral_msg_ts,model_ob.msgs))}},getMemberFromMemberMarkup:function(match){var id=TS.utility.msgs.getMemberIdFromMemberMarkup(match);var m=TS.members.getMemberById(id);if(!m)m=TS.members.getMemberByName(id);return m},getMemberIdFromMemberMarkup:function(match){var id=match.substr(1);if(id)id=id.split("|")[0];return id},makeSureMsgObIsValid:function(ob){return ob},api_url_prefix:"api::",doApiUrl:function(url){if(!TS.client){alert("This link will not work in the archives.");return}url=url.replace(TS.utility.msgs.api_url_prefix,"");var A=url.split("?");var method=A[0];var args={};if(A.length>1){var pairs=A[1].split("&");for(var i=0;i<pairs.length;i++){var p=pairs[i].indexOf("=");if(p!=-1){var name=pairs[i].substring(0,p);var value=pairs[i].substring(p+1);args[name]=unescape(value)}}}TS.api.call(method,args)},new_api_url_prefix:"slack-action://",doNewApiUrl:function(url){if(!TS.client){alert("This link will not work in the archives.");return}var parts=url.replace(TS.utility.msgs.new_api_url_prefix,"").split("/");var bot=parts.shift();var payload=parts.join("/");TS.api.call("chat.action",{bot:bot,payload:decodeURIComponent(payload)})},getHighlightWordsRegex:function(){if(!TS.model.highlight_words_regex){TS.utility.msgs.makeHighlightWordsRegex()}return TS.model.highlight_words_regex},makeHighlightWordsRegex:function(){var word;var words=[];for(var i=0;i<TS.model.highlight_words.length;i++){word=TS.format.swapOutAts(TS.model.highlight_words[i]);word=TS.utility.regexpEscape(word);if(word=="don")word+="(?![']t)";words.push(word)}TS.model.highlight_words_regex=new RegExp("(\\b|_|\\s|^)("+words.join("|")+")(\\b|_|\\s|$)","i")},msgContainsMention:function(msg,ignore_at_here_mentions){var highlight_rx=TS.utility.msgs.getHighlightWordsRegex();var dont_check_highlight_words=msg.subtype=="bot_message";function check(txt){if(!txt)return false;if(TS.model.you_regex.test(txt))return true;if(TS.model.here_regex.test(txt)&&!ignore_at_here_mentions)return true;if(TS.model.everyone_regex.test(txt))return true;if(TS.model.channel_regex.test(txt))return true;if(TS.model.group_regex.test(txt))return true;if(TS.boot_data.feature_subteams){for(var k in TS.model.your_user_group_regex){if(TS.model.your_user_group_regex[k].test(txt)){return true}}}if(dont_check_highlight_words)return false;if(TS.boot_data.feature_subteams)txt=txt.replace(/<\!subteam\^(\w+\d+)\|@(.+)>/g,"");txt=TS.format.swapOutAts(txt);if(highlight_rx.test(txt))return true;return false}if(!msg.ignore_if_attachments_supported&&check(msg.text))return true;var attachment;var field;if(msg.attachments){for(var i=0;i<msg.attachments.length;i++){attachment=msg.attachments[i];if(attachment.from_url)continue;if(check(attachment.title))return true;if(check(attachment.pretext))return true;if(check(attachment.text))return true;if(check(attachment.footer))return true;if(!attachment.fields||!attachment.fields.length)continue;for(var m=0;m<attachment.fields.length;m++){field=attachment.fields[m];if(check(field.value))return true}}}return false},getMsgMentionData:function(msg){var ret={mentions:false,non_channel_mentions:false};var highlight_rx=TS.utility.msgs.getHighlightWordsRegex();var dont_check_highlight_words=msg.subtype=="bot_message";function check(txt){if(checkNonChannelMentions(txt)){ret.non_channel_mentions=true;ret.mentions=true;return true}if(checkChannelMentions(txt)){ret.mentions=true}return false}function checkNonChannelMentions(txt){if(!txt)return false;if(TS.model.you_regex.test(txt))return true;if(dont_check_highlight_words)return false;txt=TS.format.swapOutAts(txt);if(highlight_rx.test(txt))return true;return false}function checkChannelMentions(txt){if(!txt)return false;if(TS.model.everyone_regex.test(txt))return true;if(TS.model.channel_regex.test(txt))return true;if(TS.model.group_regex.test(txt))return true;return false}if(!msg.ignore_if_attachments_supported&&check(msg.text))return ret;var attachment;var field;if(msg.attachments){for(var i=0;i<msg.attachments.length;i++){attachment=msg.attachments[i];if(attachment.from_url)continue;if(check(attachment.title))return ret;if(check(attachment.pretext))return ret;if(check(attachment.text))return ret;if(check(attachment.footer))return ret;if(!attachment.fields||!attachment.fields.length)continue;for(var m=0;m<attachment.fields.length;m++){field=attachment.fields[m];if(check(field.value))return ret}}}return ret},msgCanCountAsUnread:function(msg){if(msg.no_display)return false;if(msg.subtype=="channel_join"&&msg.inviter&&msg.user==TS.model.user.id)return true;if(msg.subtype=="group_join"&&msg.inviter&&msg.user==TS.model.user.id)return true;if(msg.user==TS.model.user.id)return false;if(msg.subtype=="channel_join")return false;if(msg.subtype=="channel_leave")return false;if(msg.subtype=="group_join")return false;if(msg.subtype=="group_leave")return false;if(msg.subtype=="mpim_notify_disabled")return false;if(msg.comment&&msg.comment.user==TS.model.user.id)return false;if(msg.dnd_suppressed)return false;return true},countAllUnreads:function(){if(_is_in_bulk_unread_calc_mode)return;TS.model.all_unread_highlights_cnt=0;TS.model.all_unread_cnt=0;var i;var im;var channel;var group;var mpim;var channels=TS.channels.getChannelsForUser();for(i=0;i<channels.length;i++){channel=channels[i];if(channel.is_archived&&!channel.was_archived_this_session||TS.notifs.isCorGMuted(channel.id))continue;TS.model.all_unread_cnt+=parseInt(channel.unread_cnt)||0;TS.model.all_unread_highlights_cnt+=parseInt(channel.unread_highlight_cnt)||0}for(i=0;i<TS.model.groups.length;i++){group=TS.model.groups[i];if(group.is_archived&&!group.was_archived_this_session||TS.notifs.isCorGMuted(group.id))continue;TS.model.all_unread_cnt+=parseInt(group.unread_cnt)||0;TS.model.all_unread_highlights_cnt+=parseInt(group.unread_highlight_cnt)||0}for(i=0;i<TS.model.ims.length;i++){im=TS.model.ims[i];TS.model.all_unread_cnt+=parseInt(im.unread_cnt)||0;TS.model.all_unread_highlights_cnt+=parseInt(im.unread_cnt)||0}if(TS.boot_data.feature_mpim_client){for(i=0;i<TS.model.mpims.length;i++){mpim=TS.model.mpims[i];TS.model.all_unread_cnt+=parseInt(mpim.unread_cnt)||0;TS.model.all_unread_highlights_cnt+=parseInt(mpim.unread_cnt)||0}}},doesMsgHaveRxnFromUser:function(msg,name){return TS.rxns.doesRxnsHaveRxnFromUser(TS.rxns.getExistingRxnsByKey(msg._rxn_key),name)},doesMsgHaveRxn:function(msg,name){return TS.rxns.doesRxnsHaveRxn(TS.rxns.getExistingRxnsByKey(msg._rxn_key),name)},recordEmojiInHash:function(str,hash){if(!str)return false;if(!hash)return false;var unique=true;var A=TS.utility.findAllTeamEmojiInStr(str,unique);if(!A.length)return false;var added=false;var name;for(var i=0;i<A.length;i++){name=TS.emoji.isValidName(A[i]);if(!name){TS.error(A[i]+" invalid");continue}if(!parseInt(hash[name])){hash[name]=0}hash[name]++;added=true}return added},populateEmojiUsePrefFromExistingMsgs:function(){TS.model.emoji_use={};TS.utility.msgs.countAllExistingEmoji(TS.shared.getAllModelObsForUser(),TS.model.emoji_use,TS.model.user.id,{});TS.dir(888,TS.model.emoji_use,"TS.model.emoji_use is now:");TS.utility.callFuncWhenApiQisEmpty(TS.prefs.saveEmojiUse)},populateEmojiUsePrefFromAllHistory:function(){TS.model.emoji_use={};var user_id=TS.model.user.id;var after_ts=TS.utility.date.makeTsStamp(TS.model.user.created*1e3);var deduper_map={};var model_ob_deduper_map={};var total_count=0;var per_user_count=0;var per_model_ob_count=0;var model_ob_count=0;var getModelOb=function(){per_model_ob_count=0;model_ob_count++;var model_obs=TS.shared.getAllModelObsForUser();for(var i=0;i<model_obs.length;i++){if(model_ob_deduper_map[model_obs[i].id])continue;model_ob_deduper_map[model_obs[i].id]=true;return model_obs[i]}return null};var getHistoryInABit=function(model_ob,latest){setTimeout(getHistory,parseInt(TS.qs_args.delay)||3e3,model_ob,latest)};var getHistory=function(model_ob,latest){if(!model_ob){TS.log(888,"done getting all messages");return}TS.api.call(TS.shared.getHistoryApiMethodForModelOb(model_ob),{channel:model_ob.id,count:1e3,latest:latest||""},function(ok,data,args){if(!ok||!data||!data.messages){TS.error("failed to get history");getHistoryInABit(getModelOb());return}if(window.stahp){TS.error("stahp");return}data.messages.forEach(function(msg){total_count++;per_model_ob_count++;if(user_id&&msg.user!=user_id)return;var id=model_ob.id+"_"+msg.ts;if(deduper_map){if(deduper_map[id])return;deduper_map[id]=true}TS.prefs.recordEmojiUse(msg.text);per_user_count++});TS.log(888,"getHistory ["+model_ob_count+" of "+TS.shared.getAllModelObsForUser().length+"] "+model_ob.name+" model_ob:"+per_model_ob_count+" total:"+total_count+" user:"+per_user_count);if(!data.messages.length){TS.error("no data.messages? so moving on");getHistoryInABit(getModelOb())}else{var oldest_ts=data.messages[data.messages.length-1].ts;if(oldest_ts<after_ts){TS.log(888,"oldest_ts:"+oldest_ts+" < after_ts:"+after_ts+" so moving on");getHistoryInABit(getModelOb())}else if(data.has_more){getHistoryInABit(model_ob,oldest_ts)}else{getHistoryInABit(getModelOb())}}})};getHistoryInABit(getModelOb())},countAllExistingEmoji:function(model_obs,hash,member_id,deduper_map){model_obs=model_obs||TS.channels.getChannelsForUser();hash=hash||{};model_obs.forEach(function(model_ob){if(!model_ob.msgs)return;model_ob.msgs.forEach(function(msg){var id=model_ob.id+"_"+msg.ts;if(deduper_map){if(deduper_map[id])return;deduper_map[id]=true}var rxns=TS.rxns.getExistingRxnsByKey(msg._rxn_key);if(rxns){rxns.forEach(function(rxn){if(member_id&&TS.rxns.doesRxnsHaveRxnFromMember(rxns,rxn.name,member_id))return;TS.utility.msgs.recordEmojiInHash(rxn.name,hash)})}if(member_id&&msg.user!=member_id)return;TS.utility.msgs.recordEmojiInHash(msg.text,hash)})});return hash},isOnlySingleEmoji:function(text){return _only_emoji_rx.test(text)},reCalcAndCountAllUnreads:function(){var i;var im;var mpim;var channel;var group;var channels=TS.channels.getChannelsForUser();TS.utility.msgs.startBatchUnreadCalc();for(i=0;i<channels.length;i++){channel=channels[i];if(channel.is_archived&&!channel.was_archived_this_session)continue;TS.channels.calcUnreadCnts(channel)}for(i=0;i<TS.model.groups.length;i++){group=TS.model.groups[i];if(group.is_archived&&!group.was_archived_this_session)continue;TS.groups.calcUnreadCnts(group)}for(i=0;i<TS.model.ims.length;i++){im=TS.model.ims[i];TS.ims.calcUnreadCnts(im)}if(TS.boot_data.feature_mpim_client){for(i=0;i<TS.model.mpims.length;i++){mpim=TS.model.mpims[i];TS.mpims.calcUnreadCnts(mpim)}}TS.utility.msgs.finishBatchUnreadCalc()},startBatchUnreadCalc:function(){if(TS.qs_args["unread_batch"]=="0")return;_is_in_bulk_unread_calc_mode=true},finishBatchUnreadCalc:function(){_is_in_bulk_unread_calc_mode=false;TS.utility.msgs.countAllUnreads()},whatisunread:function(){var i;var im;var mpim;var channel;var group;var A=[];for(i=0;i<TS.model.channels.length;i++){channel=TS.model.channels[i];if(channel.unread_cnt)A.push("C:"+channel.name+" "+channel.unread_cnt)}for(i=0;i<TS.model.groups.length;i++){group=TS.model.groups[i];if(group.unread_cnt)A.push("G:"+group.name+" "+group.unread_cnt)}for(i=0;i<TS.model.ims.length;i++){im=TS.model.ims[i];if(im.unread_cnt)A.push("D:"+im.name+" "+im.unread_cnt)}if(TS.boot_data.feature_mpim_client){for(i=0;i<TS.model.mpims.length;i++){mpim=TS.model.mpims[i];if(mpim.unread_cnt)A.push("G:"+mpim.name+" "+mpim.unread_cnt)}}TS.info("unreads: "+A.join(","))},maybeSetOldestMsgsTsAfterMsgAdded:function(model_ob){if(model_ob.oldest_msg_ts)return;if(model_ob.latest)return;TS.utility.msgs.setOldestMsgsTs(model_ob)},setOldestMsgsTs:function(model_ob){var oldest_valid_ts=TS.utility.msgs.getOldestValidTs(model_ob.msgs);if(oldest_valid_ts){model_ob.oldest_msg_ts=oldest_valid_ts;TS.storage.storeOldestTs(model_ob.id,model_ob.oldest_msg_ts)}},resetOldestMsgsTs:function(model_ob){model_ob.oldest_msg_ts=null;TS.storage.storeOldestTs(model_ob.id,null)},getOlderMsgsStatus:function(model_ob){var msgs=model_ob.msgs;var oldest_msg_ts=model_ob.oldest_msg_ts;var latest_msg_ts=TS.shared.getLatestMsgTs(model_ob)||null;var have_oldest_msg=false;var text="ERROR";var can_fetch_more=false;var code=0;if(oldest_msg_ts&&TS.utility.msgs.getMsg(oldest_msg_ts,msgs)){have_oldest_msg=true}if(!latest_msg_ts){if(msgs.length){can_fetch_more=false;code=1;text="There are NOT older messages than these."}else{can_fetch_more=false;code=2;text="THIS IS A BRAND NEW CHANNEL SAY SOMETHING"}}else{if(have_oldest_msg||model_ob.is_limited){can_fetch_more=false;code=3;text="We have the oldest msg: "+oldest_msg_ts+". is_limited:"+model_ob.is_limited}else{can_fetch_more=true;code=4;if(oldest_msg_ts){text="There are older messages than these. oldest_msg_ts: "+oldest_msg_ts}else{text="There are older messages than these. oldest_msg_ts: unknown"}}}return{text:text,more:can_fetch_more,code:code,is_limited:model_ob.is_limited}},getMostRecentValidTs:function(msgs){var msg;for(var i=0;i<msgs.length;i++){msg=msgs[i];if(!TS.utility.msgs.isTempMsg(msg)){return msg.ts}}return null},getOldestValidTs:function(msgs){var msg;for(var i=msgs.length-1;i>-1;i--){msg=msgs[i];if(!TS.utility.msgs.isTempMsg(msg)){return msg.ts}}return null},getHistoryFetchJobKey:function(latest,oldest){var key=latest;if(oldest){key+="_"+oldest}return key},processImsg:function(imsg,c_id){TS.utility.msgs._slurpExtraData(imsg,c_id);return TS.utility.msgs._makeInternalMsgObject(imsg,c_id)},processImsgFromHistory:function(imsg,c_id){var msg=TS.utility.msgs.processImsg(imsg,c_id);imsg.channel=c_id;if(imsg.subtype=="message_deleted"){TS.ms.msg_handlers.subtype__message_deleted(imsg)}else if(imsg.subtype=="message_changed"){TS.ms.msg_handlers.subtype__message_changed(imsg)}return msg},_makeInternalMsgObject:function(imsg,c_id){var new_msg={type:"message",ts:imsg.ts};if(TS.boot_data.feature_message_replies&&imsg.thread_ts){new_msg.thread_ts=imsg.thread_ts;new_msg.parent_ts=imsg.parent_ts;new_msg.parent_user_id=imsg.parent_user_id;if(imsg.hasOwnProperty("reply_count")){new_msg.reply_count=parseInt(imsg.reply_count,10)}}if(imsg.type=="channel_topic"||imsg.type=="channel_purpose"||imsg.type=="channel_join"||imsg.type=="channel_leave"){imsg.subtype=imsg.type}if(imsg.subtype=="group_join"||imsg.subtype=="group_purpose"||imsg.subtype=="group_topic"){var model_ob=TS.shared.getModelObById(c_id);if(model_ob&&model_ob.is_mpim){new_msg.no_display=true}}if(imsg.inviter){new_msg.inviter=imsg.inviter}if(imsg.hidden){new_msg.hidden=imsg.hidden}if(imsg.no_notifications){new_msg.no_notifications=imsg.no_notifications}if(imsg.ignore_if_attachments_supported){new_msg.ignore_if_attachments_supported=imsg.ignore_if_attachments_supported}if(imsg.hidden||imsg.no_display){new_msg.no_display=true}if(imsg.ignore_if_attachments_supported&&(!imsg.attachments||!imsg.attachments.length)){new_msg.no_display=true}if(imsg.edited){new_msg.edited=imsg.edited}if(imsg.user){new_msg.user=imsg.user}if(imsg.attachments){new_msg.attachments=imsg.attachments}if(imsg.img_vids){new_msg.img_vids=imsg.img_vids}var url;if(imsg.imgs){new_msg.img_vids=new_msg.img_vids||{};var img;for(url in imsg.imgs){if(new_msg.img_vids[url])continue;img=imsg.imgs[url];img.img_vid_type="img";new_msg.img_vids[url]=img}}if(imsg.videos){new_msg.img_vids=new_msg.img_vids||{};var video;for(url in imsg.videos){if(new_msg.img_vids[url])continue;video=imsg.videos[url];video.img_vid_type="video";new_msg.img_vids[url]=video}}if(imsg.icons){new_msg.icons=imsg.icons}if(imsg.bot_id){new_msg.bot_id=imsg.bot_id}if(imsg.is_ephemeral){new_msg.is_ephemeral=imsg.is_ephemeral}if(imsg._alert_even_though_temp){new_msg._alert_even_though_temp=imsg._alert_even_though_temp}if(imsg.is_starred){new_msg.is_starred=imsg.is_starred}if(imsg.reactions){delete imsg.reactions}if(imsg._rxn_key){new_msg._rxn_key=imsg._rxn_key}if(imsg.pinned_to){new_msg.pinned_to=imsg.pinned_to}if(imsg.topic){new_msg.topic=imsg.topic}if(imsg.name){new_msg.name=imsg.name}if(imsg.old_name){new_msg.old_name=imsg.old_name}if(imsg.purpose){new_msg.purpose=imsg.purpose}if(imsg.text){new_msg.text=imsg.text}if(imsg.sound){new_msg.sound=imsg.sound}if("mrkdwn"in imsg){new_msg.mrkdwn=!!imsg.mrkdwn}if("hex_swatches"in imsg){new_msg.hex_swatches=!!imsg.hex_swatches}if(imsg.dnd_suppressed){new_msg.dnd_suppressed=imsg.dnd_suppressed}if(imsg.subtype){new_msg.subtype=imsg.subtype;if(new_msg.subtype=="bot_message"){if(imsg.username){new_msg.username=imsg.username}}if(imsg.subtype=="sh_room_created"||imsg.subtype=="sh_room_shared"){if(imsg._room_id){new_msg._room_id=imsg._room_id}else if(imsg.room){var room=TS.rooms.getRoomById(imsg.room.id);if(room){new_msg._room_id=room.id}else{TS.error("no room, no_display = true "+new_msg.ts);new_msg.no_display=true}}else{new_msg.no_display=true}}if(imsg.subtype=="file_share"||imsg.subtype=="file_mention"||imsg.subtype=="file_comment"){if(imsg.upload){new_msg.upload=true}if(imsg.file){var file=TS.files.getFileById(imsg.file.id);if(file){new_msg.file=file}else{TS.error("no file, no_display = true "+new_msg.ts);new_msg.no_display=true}}else{new_msg.no_display=true}if(imsg.subtype=="file_comment"){if(imsg.comment){if(new_msg.file){new_msg.comment=TS.files.addCommentToFile(imsg.comment,new_msg.file)}else{new_msg.comment=imsg.comment}}else{new_msg.no_display=true}}}if(imsg.subtype==="pinned_item"){if(imsg.item_type)new_msg.item_type=imsg.item_type;if(imsg.item_type==="F"){if(imsg.item){var file_item=TS.files.getFileById(imsg.item.id);new_msg.item=file_item}}else if(imsg.item_type==="Fc"||imsg.item_type==="C"||imsg.item_type==="G"||imsg.item_type==="D"){new_msg.item=imsg.item}else{new_msg.no_display=true}}}return new_msg},fetchInitialMsgsFromLS:function(model_ob){var msgs=TS.storage.fetchMsgs(model_ob.id);var max=TS.model.initial_msgs_cnt;if(msgs.length>max){msgs.length=max}return msgs},processAttachments:function(attachments){if(!attachments)return;var attachment;for(var i=0;i<attachments.length;i++){attachment=attachments[i];if(!attachment){TS.warn("attachment is null!");continue}if(attachment.slack_file_id&&!attachment._slack_file_is_deleted){var file=TS.files.getFileById(attachment.slack_file_id);if(file){attachment._slack_file=file}else if(attachment._slack_file){attachment._slack_file=TS.files.upsertFile(attachment._slack_file).file}}if(attachment.mrkdwn_in&&$.isArray(attachment.mrkdwn_in)&&attachment.mrkdwn_in.length){attachment.mrkdwn_in_hash={};for(var k=0;k<attachment.mrkdwn_in.length;k++){attachment.mrkdwn_in_hash[attachment.mrkdwn_in[k]]=true}}if(!attachment.mrkdwn_in_hash)attachment.mrkdwn_in_hash={};delete attachment.mrkdwn_in;attachment.hex_swatches=!!attachment.hex_swatches;if(attachment.audio_html||attachment.audio_url){TS.inline_audios.makeInternalInlineAudio(attachment.audio_html||attachment.audio_url,attachment)}if(attachment.other_html){TS.inline_others.makeInternalInlineOther(attachment)}else if(attachment.video_html){var thumb_w=attachment.video_html_width&&parseInt(attachment.video_html_width)>parseInt(attachment.thumb_width)?attachment.video_html_width:attachment.thumb_width;var thumb_h=attachment.video_html_height&&parseInt(attachment.video_html_height)>parseInt(attachment.thumb_height)?attachment.video_html_height:attachment.thumb_height;TS.inline_videos.makeInternalInlineVideo(attachment.from_url||attachment.thumb_url,{title:attachment.title,html:TS.utility.msgs.filterHTMLForEmbeds(attachment.video_html),thumbnail:{url:attachment.thumb_url,width:thumb_w,height:thumb_h,link_url:attachment.from_url||attachment.title_url}})}else if(attachment.image_url){TS.inline_imgs.makeInternalInlineImg(attachment.from_url||attachment.image_url,{src:attachment.image_url,width:attachment.image_width,height:attachment.image_height,link_url:attachment.from_url||attachment.title_url||attachment.image_url,bytes:attachment.image_bytes})}else if(attachment.from_url){TS.inline_attachments.makeInternalInlineAttachment(attachment.from_url,attachment)}TS.inline_attachments.massageAttachment(attachment,i)}},_slurpExtraData:function(imsg,c_id){TS.utility.msgs.processAttachments(imsg.attachments);imsg._rxn_key=TS.rxns.getRxnKey("message",imsg.ts,c_id);if(imsg.reactions){TS.rxns.upsertRxnsFromDataAndUpdateUI(imsg._rxn_key,imsg.reactions);delete imsg.reactions}var url;if(imsg.img_vids){var img_vid;for(url in imsg.img_vids){img_vid=imsg.img_vids[url];if(img_vid.img_vid_type=="img"){TS.inline_imgs.makeInternalInlineImg(url,img_vid)}else if(img_vid.img_vid_type=="video"){TS.inline_videos.makeInternalInlineVideo(url,img_vid)}}}if(imsg.imgs){for(url in imsg.imgs){imsg.imgs[url].from_url=url;TS.inline_imgs.makeInternalInlineImg(url,imsg.imgs[url])}}if(imsg.videos){for(url in imsg.videos){
imsg.videos[url].from_url=url;TS.inline_videos.makeInternalInlineVideo(url,imsg.videos[url])}}if(imsg.subtype=="file_share"||imsg.subtype=="file_mention"||imsg.subtype=="file_comment"){if(imsg.file&&!imsg.file.id){TS.error("WTF no file id on file in imsg.subtype:"+imsg.subtype+" "+imsg.ts)}else if(imsg.file){TS.files.upsertAndSignal(imsg.file);if(imsg.subtype=="file_share"||imsg.subtype=="file_mention"){}if(imsg.subtype=="file_comment"){if(imsg.comment){var file=TS.files.getFileById(imsg.file.id);if(file){TS.files.addCommentToFile(imsg.comment,file)}else{TS.warn("WTF no file? id:"+imsg.file.id)}}else{TS.error("WTF no comment in imsg.subtype:"+imsg.subtype+" "+imsg.ts)}}}else{}}if(imsg.subtype=="sh_room_created"||imsg.subtype=="sh_room_shared"){if(imsg.room&&!imsg.room.id){TS.error("WTF no room id on room in imsg.subtype:"+imsg.subtype+" "+imsg.ts)}else if(imsg.room){TS.rooms.upsertAndSignal(imsg.room)}else{TS.error("WTF no room on imsg.subtype:"+imsg.subtype+" "+imsg.ts)}}if(imsg.subtype=="pinned_item"){if(imsg.item_type==="F"&&imsg.item&&imsg.item.id&&!imsg.item.is_deleted)TS.files.upsertAndSignal(imsg.item)}},constructMsgPermalink:function(model_ob,ts){if(model_ob.is_im||model_ob.is_mpim){return"/archives/"+model_ob.id+"/p"+ts.replace(".","")}return"/archives/"+model_ob.name+"/p"+ts.replace(".","")},constructAbsoluteMsgPermalink:function(model_ob,ts){var abs_permalink=TS.boot_data.team_url.slice(0,-1)+TS.utility.msgs.constructMsgPermalink(model_ob,ts);return abs_permalink},isTempMsg:function(msg){return!msg.ts||msg.ts.indexOf(TS.utility.date.fake_ts_unique_padder)>-1},shouldMarkUnreadsOnMessageFetch:function(){if(TS.qs_args["no_unread_marking_on_msgs_fetch"]=="1")return false;return true},ipsum:function(){var ipsum=["Build Something People Want","We know that we have built something which is genuinely useful: almost any team which adopts Slack as their central application for communication would be significantly better off than they were before.","That means we have something people want.","However, almost all of them have no idea that they want Slack.","How could they?","Theyve never heard of it.","And only a vanishingly small number will have imagined it on their own.","They think they want something different (if they think they want anything at all).","They definitely are not looking for Slack.","(But then no-one was looking for Post-it notes or GUIs either.)","Just as much as our job is to build something genuinely useful, something which really does make peoples working lives simpler, more pleasant and more productive, our job is also to understand what people think they want and then translate the value of Slack into their terms.","A good part of that is just marketing, but even the best slogans, ads, landing pages, PR campaigns, etc., will fall down if they are not supported by the experience people have when they hit our site, when they sign up for an account, when they first begin using the product and when they start using it day in, day out.","Therefore, understanding what people think they want and then translating the value of Slack into their terms is something we all work on.","It is the sum of the exercise of all our crafts.","We do it with copy accompanying signup forms, with fast-loading pages, with good welcome emails, with comprehensive and accurate search, with purposeful loading screens, and with thoughtfully implemented and well-functioning features of all kinds.","Marketing from Both Ends","Much has been written about product-market fit in the last few years, probably as a result of the popularity of the lean startup movement (though the idea has been around much longer).","The term refers to the degree to which a product could be successful, given sufficient promotion, appropriate pricing, adequate customer support and so on (before you find that fit, all the pushing in the world wont get you up the hill).","In this classic post on Marc Andreessens old blog, he calls getting to product-market fit the only thing that matters for startups and offers a way of thinking about the life of the startup that divides it into two distinct phases: before product-market fit and after.","Once the product fits the market, a company is able to step on the gas, spending to promote a product that will actually sell.","The things you need to do before are very different from the things you need to do after (generally test & iterate vs scale & optimize).","We are right in the middle of that first phase.","It seems we are doing well and there are many encouraging signs, but were definitely still in the first phase and it is very, very hard to tell how far we have to go to cross over into the promised land (the last 10% is 90% of the work, etc.)","So, we should be working carefully from both the product end and the market end:","Doing a better and better job of providing what people want (whether they know it or not)","Communicating the above more and more effectively (so that they know they want it)","In the best case, there is a dialectic at play here: the product itself and the way people use it should suggest new ways of articulating the valueand refinements to how we communicate the value should lead to principles which clarify decision-making around product features and design.","Our position is different than the one many new companies find themselves in: we are not battling it out in a large, well-defined market with clear incumbents (which is why we cant get away with Other group chat products are poisonous. Slack is toasted.).","Despite the fact that there are a handful of direct competitors and a muddled history of superficially similar tools, we are setting out to define a new market.","And that means we cant limit ourselves to tweaking the product; we need to tweak the market too.","Sell the innovation, not the product","The bestmaybe the only?real, direct measure of innovation is change in human behaviour.","In fact, it is useful to take this way of thinking as definitional: innovation is the sum of change across the whole system, not a thing which causes a change in how people behave.","No small innovation ever caused a large shift in how people spend their time and no large one has ever failed to do so.","By that measure, Slack is a real and large innovation.","It is not as eye-catching as self-driving cars or implantable chipsit is not basic research-y kind of stuff.","But, for organizations that adopt it, there will be a dramatic shift in how time is spent, how communication happens, and how the teams archives are utilized.","There will be changes in how team members relate to one another and, hopefully, significant changes in productivity.","We are unlikely to be able to sell a group chat system very well: there are just not enough people shopping for group chat system (and, as pointed out elsewhere, our current fax machine works fine).","Thats why what were selling is organizational transformation.","What we are selling is not the software productthe set of all the features, in their specific implementationbecause there are just not many buyers for this software product.","(People buy software to address a need they already know they have or perform some specific task they need to perform, whether that is tracking sales contacts or editing video.)","However, if we are selling a reduction in the cost of communication or zero effort knowledge management or making better decisions, faster or all your team communication, instantly searchable, available wherever you go or 75% less email or some other valuable result of adopting Slack, we will find many more buyers.","Thats why what were selling is organizational transformation.","The software just happens to be the part were able to build & ship (and the means for us to get our cut).","Were selling a reduction in information overload, relief from stress, and a new ability to extract the enormous value of hitherto useless corporate archives.","Were selling better organizations, better teams.","Thats a good thing for people to buy and it is a much better thing for us to sell in the long run.","We will be successful to the extent that we create better teams.","To see why, consider the hypothetical Acme Saddle Company.","They could just sell saddles, and if so, theyd probably be selling on the basis of things like the quality of the leather they use or the fancy adornments their saddles include; they could be selling on the range of styles and sizes available, or on durability, or on price.","Or, they could sell horseback riding.","Being successful at selling horseback riding means they grow the market for their product while giving the perfect context for talking about their saddles.","It lets them position themselves as the leader and affords them different kinds of marketing and promotion opportunities (e.g., sponsoring school programs to promote riding to kids, working on land conservation or trail maps).","It lets them think big and potentially be big.","Because the best possible way to find product-market fit is to define your own market.","This isnt a new idea.","There are many brands whose marketing activities or positioning has them selling something other than (and usually larger than) their product: Harley Davidson sells motorcycle riding, but it especially sells freedom and independence.","Most luxury brands sell something that comes down to being better than you are (richer, better looking, more attractive to those you find desirable, etc.)","My favorite recent example is Lululemon: when they started, there was not a large market for yoga-specific athletic wear and accessories.","They sold yoga like crazy: helping people find yoga studios near their homes, hosting free classes, sponsorships and scholarships, local ambassadors and training, etc.","And as a result, they sold just under $1.4 billion worth of yoga-specific athletic wear and accessories in their most recent fiscal year.","But going back to the Acme Saddle Company, the better analogy to what we are doing now is to imagine them selling horseback riding  about 4,000 years ago.","It is almost inevitable that centralized internal communication systems will gradually replace email for most organizations over the next 10-20 years and we should do what we can to accelerate the trend and own it.","We are at the beginning of a transition.","We have an opportunity to both define the category and push hard for the whole markets growth.","Wed be crazy not to take it, because the best possible way to find product-market fit is to define your own market."];return ipsum},removeFileSharesAndMentions:function(model_ob,file){if(!TS.client)return;var msgs=model_ob.msgs;var m;for(var i=msgs.length-1;i>-1;i--){m=msgs[i];if((m.subtype=="file_share"||m.subtype=="file_mention")&&m.file&&m.file.id==file.id){if(model_ob.is_channel){TS.channels.removeMsg(model_ob.id,m)}else if(TS.boot_data.feature_mpim_client&&model_ob.is_mpim){TS.mpims.removeMsg(model_ob.id,m)}else if(model_ob.is_group){TS.groups.removeMsg(model_ob.id,m)}else{TS.ims.removeMsg(model_ob.id,m)}}}},removeFileComments:function(model_ob,file){if(!TS.client)return;var msgs=model_ob.msgs;var m;for(var i=msgs.length-1;i>-1;i--){m=msgs[i];if(m.subtype=="file_comment"&&m.file&&m.file.id==file.id){if(model_ob.is_channel){TS.channels.removeMsg(model_ob.id,m)}else if(TS.boot_data.feature_mpim_client&&model_ob.is_mpim){TS.mpims.removeMsg(model_ob.id,m)}else if(model_ob.is_group){TS.groups.removeMsg(model_ob.id,m)}else{TS.ims.removeMsg(model_ob.id,m)}}}},removeFileReferences:function(model_ob,file_id){if(!TS.client)return;var msgs=model_ob.msgs;var m;for(var i=msgs.length-1;i>-1;i--){m=msgs[i];if(m.attachments){var attach=TS.inline_attachments.getAttachmentBySlackFileId(m.attachments,file_id);if(attach&&!attach._slack_file_is_deleted){attach._slack_file_is_deleted=true;delete attach._slack_file;if(model_ob.id==TS.model.active_im_id){TS.ims.message_changed_sig.dispatch(model_ob,m)}else if(model_ob.id==TS.model.active_channel_id){TS.channels.message_changed_sig.dispatch(model_ob,m)}else if(model_ob.id==TS.model.active_group_id){TS.groups.message_changed_sig.dispatch(model_ob,m)}else if(model_ob.id==TS.model.active_mpim_id){TS.mpims.message_changed_sig.dispatch(model_ob,m)}TS.utility.msgs.maybeStoreMsgs(model_ob.id,msgs)}}}},updateFileMsgs:function(model_ob,file){var msgs=model_ob.msgs;var m;var msgHasFileReferenceAttachMent=function(m){if(!m)return false;if(!m.attachments)return false;if(!m.attachments.length)return false;if(TS.inline_attachments.getAttachmentBySlackFileId(m.attachments,file.id))return true;return false};for(var i=msgs.length-1;i>-1;i--){m=msgs[i];if(!file.is_deleted&&(m.subtype=="file_share"||m.subtype=="file_mention"||m.subtype=="file_comment")&&m.file&&m.file.id==file.id){}else if(msgHasFileReferenceAttachMent(m)){}else{continue}if(model_ob.id==TS.model.active_im_id){TS.ims.message_changed_sig.dispatch(model_ob,m)}else if(model_ob.id==TS.model.active_channel_id){TS.channels.message_changed_sig.dispatch(model_ob,m)}else if(model_ob.id==TS.model.active_group_id){TS.groups.message_changed_sig.dispatch(model_ob,m)}else if(model_ob.id==TS.model.active_mpim_id){TS.mpims.message_changed_sig.dispatch(model_ob,m)}}},tryToEditLastMsgFromShortcut:function(ob){var model_ob=TS.shared.getActiveModelOb();if(!model_ob){return}var msg=TS.utility.msgs.getEditableMsgByProp("user",TS.model.user.id,model_ob.msgs);if(!msg){TS.sounds.play("beep");alert("Found no recent messages from you to edit :(");return}var text=TS.format.unFormatMsg(msg.text,msg);var new_text=TS.utility.msgs.wordReplace(text,ob);if(text==new_text){TS.sounds.play("beep");return}TS.msg_edit.commitEdit(msg,TS.shared.getActiveModelOb(),new_text)},getEditLastShortcutCmd:function(txt){var parts=txt.split("/");if(parts.length!=5&&parts.length!=4)return;if(parts[1]!="s")return;var str=parts[2];var rpl=parts[3];var g=parts.length==5&&(parts[4]=="g"||parts[4]=="gi"||parts[4]=="ig");var i=parts.length==5&&(parts[4]=="i"||parts[4]=="gi"||parts[4]=="ig");if(!str){return}return{str:str,rpl:rpl,g:g,i:i}},wordReplace:function(text,replace_object){if(!replace_object){return text}var rx_opts=(replace_object.g?"g":"")+(replace_object.i?"i":"");var word_delimiter="[\\s\\n\\r\\t.,'\"+!?\\-_|]";var escaped_word=TS.utility.regexpEscape(replace_object.str);var rx=new RegExp("(^|"+word_delimiter+"+)(?:"+escaped_word+")(?="+word_delimiter+"+|$)",rx_opts);return text.replace(rx,"$1"+replace_object.rpl)},maybeTruncateMsgs:function(model_ob){if(!model_ob)return;if(!model_ob.msgs)return;if(!model_ob.msgs.length)return;if(!TS.model.active_cid||!TS.shared.getActiveModelOb())return;var msg_limit=TS.model.initial_msgs_cnt+1;var max_msg_limit=Math.min(TS.model.hard_msg_limit,msg_limit*2);var scroll_top_limit=1e3;var ms_since_last_activated_limit=0;var ms_last_scrollback_history_load_limit=1e3*20;var msgs=model_ob.msgs;var displayed_msgs=TS.utility.msgs.getDisplayedMsgs(msgs);var now=Date.now();var ms_since_last_scrollback_history_load=model_ob.has_fetched_history_after_scrollback?now-model_ob.fetched_history_after_scrollback_time:now;if(displayed_msgs.length>max_msg_limit&&(model_ob.id!=TS.shared.getActiveModelOb().id||model_ob.scroll_top<scroll_top_limit&&ms_since_last_scrollback_history_load>ms_last_scrollback_history_load_limit)){msg_limit=max_msg_limit}else{if(displayed_msgs.length-50<=msg_limit){return}if(model_ob.last_made_active){var ms_since_last_activated=now-model_ob.last_made_active;if(ms_since_last_activated<ms_since_last_activated_limit){return}}if(!TS.boot_data.feature_no_unread_counts){if(model_ob.unread_cnt&&model_ob.unread_count&&!model_ob.all_read_this_session_once){return}}if(model_ob.scroll_top!=-1){return}}if(model_ob.history_is_being_fetched){return}var msgs_to_remove_from_view=[];while(TS.utility.msgs.getDisplayedMsgs(msgs).length>msg_limit){msgs_to_remove_from_view.push(msgs.pop())}if(model_ob.is_limited){TS.info("Truncated "+model_ob.id+" and reset is_limited");model_ob.is_limited=false}if(model_ob.id==TS.shared.getActiveModelOb().id){TS.view.removeMsgsAfterTruncation(msgs_to_remove_from_view)}TS.storage.storeMsgs(model_ob.id,TS.utility.msgs.prepareMsgsForLS(msgs,model_ob.id))},checkForMsgsToTruncate:function(){if(!TS.model)return;if(!TS.model.channels)return;var channels=TS.model.channels;var channel;var i;for(i=0;i<channels.length;i++){channel=channels[i];if(channel.id==TS.model.active_channel_id)continue;if(!channel.is_member)continue;if(channel.is_archived)continue;TS.utility.msgs.maybeTruncateMsgs(channel)}var ims=TS.model.ims;var im;for(i=0;i<ims.length;i++){im=ims[i];if(im.id==TS.model.active_im_id)continue;TS.utility.msgs.maybeTruncateMsgs(im)}var groups=TS.model.groups;var group;for(i=0;i<groups.length;i++){group=groups[i];if(group.id==TS.model.active_group_id)continue;if(group.is_archived)continue;TS.utility.msgs.maybeTruncateMsgs(group)}if(TS.boot_data.feature_mpim_client){var mpims=TS.model.mpims;var mpim;for(i=0;i<mpims.length;i++){mpim=mpims[i];if(mpim.id==TS.model.active_mpim_id)continue;TS.utility.msgs.maybeTruncateMsgs(mpim)}}},getEphemeralMsgsByCidAndType:function(c_id,ephemeral_type){var msg;var ob;var A=[];var model_ob=TS.shared.getModelObById(c_id);if(!model_ob)return A;for(var ts in TS.utility.msgs.ephemeral_msgs_map){ob=TS.utility.msgs.ephemeral_msgs_map[ts];if(ob.ephemeral_type==ephemeral_type&&ob.c_id==c_id){msg=TS.utility.msgs.getMsg(ts,model_ob.msgs);if(!msg)continue;A.push(msg)}}return A},removeAllEphemeralMsgsByType:function(ephemeral_type,c_id){var model_ob;var ob;var msg;for(var ts in TS.utility.msgs.ephemeral_msgs_map){ob=TS.utility.msgs.ephemeral_msgs_map[ts];if(ob.ephemeral_type==ephemeral_type){if(c_id&&c_id!=ob.c_id)continue;model_ob=TS.shared.getModelObById(ob.c_id);if(!model_ob)continue;msg=TS.utility.msgs.getMsg(ts,model_ob.msgs);if(!msg)continue;if(model_ob.is_im){TS.ims.removeMsg(model_ob.id,msg)}else if(model_ob.is_channel){TS.channels.removeMsg(model_ob.id,msg)}else if(TS.boot_data.feature_mpim_client&&model_ob.is_mpim){TS.mpims.removeMsg(model_ob.id,msg)}else if(model_ob.is_group){TS.groups.removeMsg(model_ob.id,msg)}delete TS.utility.msgs.ephemeral_msgs_map[ts]}}},prepareMsgsForLS:function(msgs,c_id){if(!msgs)return msgs;var new_msgs=[];var new_msg;var msg;var rxns;var room;var k;var m;for(var i=0;i<msgs.length;i++){msg=msgs[i];new_msg={};new_msgs.push(new_msg);for(k in msg){if(k=="file"&&msg.file){new_msg.file={};for(m in msg.file){if(m=="content")continue;if(m=="content_html")continue;if(m=="simplified_html")continue;if(m=="content_highlight_html")continue;if(m=="comments")continue;if(m=="_rxn_key"){rxns=TS.rxns.getExistingRxnsByKey(msg.file._rxn_key);if(rxns){new_msg.file.reactions=rxns}}new_msg.file[m]=msg.file[m]}}else if(k=="comment"&&msg.comment){new_msg.comment={};for(m in msg.comment){if(m=="_rxn_key"){rxns=TS.rxns.getExistingRxnsByKey(msg.comment._rxn_key);if(rxns){new_msg.comment.reactions=rxns}}new_msg.comment[m]=msg.comment[m]}}else if(k=="_room_id"){room=TS.rooms.getRoomById(msg._room_id);if(room)new_msg.room=room}else if(k=="_rxn_key"){rxns=TS.rxns.getExistingRxnsByKey(msg._rxn_key);if(rxns){new_msg.reactions=rxns}}else{new_msg[k]=msg[k]}}}return new_msgs},hasImgs:function(msg){if(!msg)return false;if(msg.img_vids){var img_vid;var url;for(url in msg.img_vids){img_vid=msg.img_vids[url];if(img_vid.img_vid_type=="img"){return true}}}else if(msg.attachments){for(var i=0;i<msg.attachments.length;i++){if(msg.attachments[i].image_url){return true}}}return false},ingestMessagesFromBootData:function(model_ob){if(!TS.boot_data.msgs)return;var msgs=TS.boot_data.msgs[model_ob.id];var A=[];if(msgs){var imsg;for(var i=0;i<msgs.length;i++){imsg=msgs[i];if(!imsg.ts)continue;A.push(TS.utility.msgs.processImsg(imsg,model_ob.id))}}TS.utility.msgs.setMsgs(model_ob,A)},handleSearchHighlights:function(html){html=html.replace(/\ue000/g,'<span class="match">').replace(/\ue001/g,"</span>");return html},findAllMsgsBySubtype:function(subtype){var i;var m;var model_ob;var model_obs=TS.shared.getAllModelObsForUser();var results={};for(i=0;i<model_obs.length;i++){model_ob=model_obs[i];if(!model_ob.msgs)continue;for(m=0;m<model_ob.msgs.length;m++){if(subtype!=model_ob.msgs[m].subtype)continue;results[model_ob.name]=results[model_ob.name]||{id:model_ob.id};results[model_ob.name]["msg_index_"+m]=model_ob.msgs[m]}}TS.info(JSON.stringify(results,null,"	"))},isMessageUserHidden:function(msg){if(msg.user)return TS.model.user_hiddens.indexOf(msg.user)>-1;if(msg.bot_id)return TS.model.user_hiddens.indexOf(msg.bot_id)>-1;if(msg.username)return TS.model.user_hiddens.indexOf(msg.username)>-1},hideMessagesFrom:function(key){var i=TS.model.user_hiddens.indexOf(key);if(i==-1){TS.model.user_hiddens.push(key)}if(TS.client)TS.client.msg_pane.rebuildMsgs();if(TS.web)TS.web.channel.renderMsgs(TS.shared.getActiveModelOb())},unHideMessagesFrom:function(key){var i=TS.model.user_hiddens.indexOf(key);if(i>-1){TS.model.user_hiddens.splice(i,1)}if(TS.client)TS.client.msg_pane.rebuildMsgs();if(TS.web)TS.web.channel.renderMsgs(TS.shared.getActiveModelOb())},handleFailedMsgSend:function(msg_id,model_ob,resend){var temp_msg=TS.utility.msgs.getMsg(msg_id,model_ob.msgs);if(temp_msg){if(model_ob.is_channel){TS.channels.removeMsg(model_ob.id,temp_msg);if(resend)TS.channels.sendMsg(model_ob.id,TS.format.unFormatMsg(temp_msg.text,temp_msg))}else if(TS.boot_data.feature_mpim_client&&model_ob.is_mpim){TS.mpims.removeMsg(model_ob.id,temp_msg);if(resend)TS.mpims.sendMsg(model_ob.id,TS.format.unFormatMsg(temp_msg.text,temp_msg))}else if(model_ob.is_group){TS.groups.removeMsg(model_ob.id,temp_msg);if(resend)TS.groups.sendMsg(model_ob.id,TS.format.unFormatMsg(temp_msg.text,temp_msg))}else{TS.ims.removeMsg(model_ob.id,temp_msg);if(resend)TS.ims.sendMsg(model_ob.id,TS.format.unFormatMsg(temp_msg.text,temp_msg))}delete TS.model.unsent_msgs[temp_msg.ts];delete TS.model.display_unsent_msgs[temp_msg.ts]}else{TS.error("no msg?: "+msg_id)}},msgMightBeRolledUp:function(msg){return msg.subtype&&TS.model.join_leave_subtypes.indexOf(msg.subtype)!=-1},msgRollUpWorker:function(i,msg,msgs,jl_rolled_up_msgs){delete msg._jl_rollup_hash;delete msg._jl_rolled_up_in;if(!TS.utility.msgs.msgMightBeRolledUp(msg))return;jl_rolled_up_msgs.push(msg);if(i!==0&&TS.utility.msgs.msgMightBeRolledUp(msgs[i-1])){return"continue"}else{var hash=jl_rolled_up_msgs[0]._jl_rollup_hash={msg_ids:[],users:{}};var jl_msg;for(var m=0;m<jl_rolled_up_msgs.length;m++){jl_msg=jl_rolled_up_msgs[m];var ob=hash.users[jl_msg.user]=hash.users[jl_msg.user]||{};hash.msg_ids.push(jl_msg.ts);jl_msg._jl_rolled_up_in=jl_rolled_up_msgs[0].ts;if(jl_msg.subtype=="channel_join"||jl_msg.subtype=="group_join"){ob.inviter=jl_msg.inviter;ob.joined=true;ob.is_in=true}else if(jl_msg.subtype=="channel_leave"||jl_msg.subtype=="group_leave"){ob.left=true;ob.is_in=false}}return"swap"}},shouldHaveBotLabel:function(msg,member){return msg.subtype&&msg.subtype=="bot_message"&&msg.username!="slackbot"||member&&member.is_bot&&!member.is_slackbot},maybeStoreMsgsForMany:function(c_ids){if(!c_ids)return;var i;var model_ob;c_ids=TS.utility.dedupeArray(c_ids);for(i=0;i<c_ids.length;i++){model_ob=TS.shared.getModelObById(c_ids[i]);if(model_ob&&(!model_ob.is_channel||model_ob.is_member)&&model_ob.msgs&&model_ob.msgs.length){TS.utility.msgs.maybeStoreMsgs(model_ob.id,model_ob.msgs)}}},checkConsistencyViaApi:function(c_id){if(!TS.boot_data.feature_msg_consistency)return;if(!TS.model.ms_connected)return;var model_ob=TS.shared.getModelObById(c_id);if(!model_ob||!model_ob.msgs||!model_ob.msgs.length)return;if(model_ob.is_archived)return;if(model_ob.history_is_being_fetched)return;if(model_ob._consistency_has_been_checked)return;if(model_ob._consistency_is_being_checked)return;var oldest_ts_we_have=TS.utility.msgs.getOldestValidTs(model_ob.msgs);if(!oldest_ts_we_have)return;TS.log(773,"checkConsistencyViaApi for:"+c_id+" "+TS.shared.getDisplayNameForModelOb(model_ob));model_ob._consistency_is_being_checked=true;TS.api.call(TS.shared.getHistoryApiMethodForModelOb(model_ob),{channel:model_ob.id,oldest:oldest_ts_we_have,count:1e3,inclusive:true}).then(function(res){var was_inconsistent=TS.utility.msgs.checkConsistency(c_id,res.data.messages);if(was_inconsistent){TS.timing.store("inconsistent_history_cnt",++_inconsistent_history_cnt,{is_count:true});TS.error("checkConsistencyViaApi for:"+c_id+" "+TS.shared.getDisplayNameForModelOb(model_ob)+" NOT GOOD!")}else{model_ob._consistency_has_been_checked=true;TS.log(773,"checkConsistencyViaApi for:"+c_id+" "+TS.shared.getDisplayNameForModelOb(model_ob)+" all good!")}}).catch(function(err){TS.error("checkConsistencyViaApi for:"+c_id+" "+TS.shared.getDisplayNameForModelOb(model_ob)+" err:"+err)}).finally(function(){delete model_ob._consistency_is_being_checked})},checkConsistency:function(c_id,from_msgs){var model_ob=TS.shared.getModelObById(c_id);if(!model_ob||!model_ob.msgs||!model_ob.msgs.length)return;var missing_msgs=[];TS.log(773,"checkConsistency for:"+c_id+" "+TS.shared.getDisplayNameForModelOb(model_ob)+" from_msgs.length:"+from_msgs.length+" model_ob.msgs.length:"+model_ob.msgs.length);from_msgs.forEach(function(msg,i){if(!TS.utility.msgs.getMsg(msg.ts,model_ob.msgs)){msg=TS.utility.msgs.processImsg(msg,c_id);missing_msgs.push(msg);TS.error("checkConsistency for:"+c_id+" "+TS.shared.getDisplayNameForModelOb(model_ob)+" found and fixed an inconsistency at i:"+i);TS.dir(0,msg," at i:"+i)}});if(!missing_msgs.length)return false;if(missing_msgs.length==1){if(model_ob.is_channel){TS.channels.addMsg(c_id,missing_msgs[0])}else if(model_ob.is_mpim){TS.mpims.addMsg(c_id,missing_msgs[0])}else if(model_ob.is_group){TS.groups.addMsg(c_id,missing_msgs[0])}else if(model_ob.is_im){TS.ims.addMsg(c_id,missing_msgs[0])}}else{TS.shared.addMsgs(model_ob,missing_msgs)}return true},filterHTMLForEmbeds:function(html){if(!html)return html;var $good_tags;var parser=new DOMParser;var parsed=parser.parseFromString(html,"text/html")||parser.parseFromString(html,"text/xml");var result="";var $doc;if(parsed)$doc=$(parsed.body);if(!$doc)return html;if($doc){$good_tags=$doc.find(_allowed_tags_selector);if($good_tags.length){result=TS.utility.sanitizeHTML($good_tags.first()[0].outerHTML,_allowed_tags,TS.utility.msgs.allowed_embed_attributes)}else{}}else{}parser=null;parsed=null;$doc=null;$good_tags=null;return result}});var _is_in_bulk_unread_calc_mode=false;var _allowed_tags=["video","iframe","source"];var _allowed_tags_selector=_allowed_tags.join(",");var _inconsistent_history_cnt=0;var _only_emoji_rx=new RegExp(/^:[a-zA-Z0-9-_+]+:(:skin-tone-[2-6]:)*(\s)*$/i)})();(function(){"use strict";TS.registerModule("utility",{keymap:{alt:18,ctrl:17,cmd_ff:224,cmd_other:91,cmd_right:93,esc:27,shift:16,tab:9,del:8,enter:13,left:37,up:38,right:39,down:40,pageup:33,pagedown:34,end:35,home:36,space:32,semicolon:59,equals_sign:187,minus_sign:189,comma:188,period:190,left_square_bracket:219,right_square_bracket:221,V:86,insert:45},keymap_reverse:{18:"alt",17:"ctrl",224:"cmd_ff",91:"cmd_other",93:"cmd_right",27:"esc",16:"shift",9:"tab",8:"del",13:"enter",37:"left",38:"up",39:"right",40:"down",187:"equals_sign",189:"minus_sign",188:"comma",190:"period",219:"left_square_bracket",221:"right_square_bracket",86:"V",45:"insert"},email_regex:new RegExp("^[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?$","i"),onStart:function(){},isRetina:function(windowObject){windowObject=windowObject||window;return"devicePixelRatio"in windowObject&&windowObject.devicePixelRatio>1},regexpEscape:function(text,len_limit){text=text||"";len_limit=len_limit||5e5;len_limit=Math.min(len_limit,5e5);if(text.length>len_limit){text=text.substr(0,len_limit)}return text.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")},randomInt:function(lo,hi){lo=parseInt(lo);hi=parseInt(hi);return lo+Math.floor(Math.random()*(1+hi-lo))},compactArray:function(arr){return arr.filter(Boolean)},randomFromArray:function(A){return A[TS.utility.randomInt(0,A.length-1)]},removeFromArray:function(A,val){var i=A.indexOf(val);if(i==-1)return false;A.splice(i,1);return true},ensureInArray:function(A,val){if(A.indexOf(val)>-1)return false;A.push(val);return true},doRectsOverlap:function(r1,r2){return!(r2.left>r1.right||r2.right<r1.left||r2.top>r1.bottom||r2.bottom<r1.top)},getObjectWithPropValueFromArray:function(prop,value,A){if(!A)return null;if(!A.length)return null;if(!prop)return null;for(var i in A){if(A[i]&&A[i].hasOwnProperty(prop)&&A[i][prop]===value)return A[i]}return null},doesRectContainRect:function(r1,r2,tolerance,vertical_only){tolerance=tolerance||0;if(r2.top<r1.top-tolerance)return false;if(r2.bottom>r1.bottom+tolerance)return false;if(vertical_only)return true;if(r2.left<r1.left-tolerance)return false;if(r2.right>r1.right+tolerance)return false;return true},clamp:function(val,min,max){return Math.max(min,Math.min(max,val))},inArray:function(a,v){if(!a)return false;if(!v&&v!==0)return false;for(var i=0;i<a.length;i++){if(a[i]==v)return true}return false},shouldLinksHaveTargets:function(){return!!(TS.client||TS.web&&TS.web.space)},clone:function(obj){if(obj===null)return obj;return JSON.parse(JSON.stringify(obj))},parseJSONOrElse:function(json_str,fallback){try{return JSON.parse(json_str)}catch(err){if(typeof fallback=="function"){return fallback(err)}else{return fallback}}},padNumber:function(number,length,padder){padder=(padder||"0").toString();var str=number.toString();while(str.length<length){str=padder+str}return str},ordinalNumber:function(number){number=number.toString();var suffix=number.substr(-Math.min(number.length,2))>3&&number.substr(-Math.min(number.length,2))<21?"th":["th","st","nd","rd","th"][Math.min(Number(number)%10,4)];return number+suffix},getChannelNameFromUrl:function(url){var pathA=TS.utility._getPathAFromUrl(url);if(pathA&&pathA.length>0){return decodeURIComponent(pathA[0])}return""},getFlexNameFromUrl:function(url){var pathA=TS.utility._getPathAFromUrl(url);if(pathA&&pathA.length>1){return decodeURIComponent(pathA[1])}return""},getFlexExtraFromUrl:function(url){var pathA=TS.utility._getPathAFromUrl(url);if(pathA&&pathA.length>2){var flex_extra=pathA[2];flex_extra=decodeURIComponent(flex_extra);flex_extra=flex_extra.replace(/%2F/g,"/");return flex_extra}return""},_getPathAFromUrl:function(url){if(url.indexOf("/messages/")==-1){return null}var urlA=url.split("/messages/");var restA=urlA[1].split("?");var pathA=restA[0].split("/");return pathA},refashionUrl:function(url,c_name,flex_name,flex_extra){var urlA=url.split(/\.com\/+messages/);var base=urlA[0]+".com";var restA=urlA[1].split("?");var pathA=restA[0].split("/");var qs=restA[1]?"?"+restA[1]:"";pathA.length=2;pathA[0]=c_name;pathA[1]=flex_name;if(flex_extra){pathA.length=3;pathA[2]=flex_extra}if(!pathA[1]){pathA.length=1}return base+"/messages/"+pathA.join("/")+"/"+qs},dataURItoBlob:function(dataURI){return TS.utility.base64StrtoBlob(TS.utility.base64StrFromDataURI(dataURI))},base64StrFromDataURI:function(dataURI){return dataURI.split(",")[1]},base64StrtoBlob:function(str){var byteString=atob(str);var arrayBuffer=new ArrayBuffer(byteString.length);var _ia=new Uint8Array(arrayBuffer);for(var i=0;i<byteString.length;i++){_ia[i]=byteString.charCodeAt(i)}var dataView=new DataView(arrayBuffer);var blob=new Blob([dataView]);return blob},ellipsize:function(str,len){if(!str)return str;if(!len||!parseInt(len))len=50;if(str.length>len){var prefix=str.substr(0,len/2);var suffix=str.substr(-(len/2),str.length);str=prefix+"..."+suffix}return str},makeSafeForDomId:function(str){return String(str).replace(/\./g,"_")},makeSafeForDomClass:function(str){return str.replace(/\s/g,"_")},getImageIconClass:function(image,defaultClass){var icon_class=defaultClass;var max_width=80;var max_height=80;if(image&&(image.thumb_360_w<max_width||image.thumb_360_h<max_height)){if(image.thumb_360_w>image.thumb_360_h){
icon_class="landscape"}else if(image.thumb_360_w<image.thumb_360_h){icon_class="portrait"}else{icon_class="square"}}return icon_class},convertFilesize:function(size){size=parseInt(size);if(size===0)return"0 bytes";var units=["b","KB","MB","GB"];var power=parseInt(Math.floor(Math.log(size)/Math.log(1024)));var calc_size=size/Math.pow(1024,power);var rounded_size=Math.round(calc_size,2);if(rounded_size>999){rounded_size=1;power++}return rounded_size+units[power]},numberWithCommas:function(x){if(x===undefined)return"";var parts=x.toString().split(".");parts[0]=parts[0].replace(/\B(?=(\d{3})+(?!\d))/g,",");return parts.join(".")},numberWithK:function(x){if(x>999){x=Math.round(x/1e3*10)/10;return TS.utility.numberWithCommas(x)+"K"}else{return TS.utility.numberWithCommas(x)}},cleanChannelName:function(name){name=name.toLowerCase();while(name.substr(0,1)=="#")name=name.substr(1);name=name.replace(/ /g,"-");name=name.replace(/[^a-z0-9-_]/g,"_");name=name.replace(/\-+/g,"-");name=name.replace(/\_+/g,"_");return name},openInNewTab:function(url,target){url=TS.utility.htmlEntities(url);if(url.indexOf("/")===0&&TS.boot_data.team_url){var team_url=TS.boot_data.team_url;team_url=team_url.substr(0,team_url.length-1);url=team_url+url}var action=url;var fields="";if(TS.utility.urlNeedsRefererHiding(url)){fields='<input type="hidden" name="url" value="'+TS.utility.htmlEntities(url)+'">';action=(TS.boot_data.feature_referer_policy?"https://":"http://")+TS.boot_data.redir_domain+"/link"}else{var queryIndex=action.indexOf("?");if(queryIndex!==-1){var query=action.substring(queryIndex+1,action.length);action=action.substring(0,queryIndex);if(query.length){var params=query.split("&amp;");for(var i=0;i<params.length;i++){var pair=params[i].split("=");fields+='<input type="hidden" name="'+TS.utility.htmlEntities(pair[0])+'" value="'+(pair.length>1?TS.utility.htmlEntities(pair[1]):"")+'">'}}}}$("<form>"+fields+"</form>").attr({method:"GET",action:action,target:target}).appendTo("body").submit().remove()},isScalar:function(mixed_var){return/boolean|number|string/.test(typeof mixed_var)},sanitizeHTML:function(html,valid_tags,valid_attrs){var _sanitizeNode=function(node){var tag_name=node.tagName.toLowerCase();if(valid_tags.indexOf(tag_name)<0){return null}Array.prototype.slice.apply(node.attributes).forEach(function(attr){if(valid_attrs.indexOf(attr.name)<0){node.attributes.removeNamedItem(attr.name)}});Array.prototype.slice.apply(node.children).forEach(function(childNode){var sanitized_child=_sanitizeNode(childNode);if(!sanitized_child){node.removeChild(childNode)}});return node};var parser=new DOMParser;var doc=parser.parseFromString(html,"text/html")||parser.parseFromString(html,"text/xml");var body=doc.body;if(body.children.length!=1){return""}var sanitized=_sanitizeNode(body.children[0]);return sanitized?sanitized.outerHTML:""},getAttributesFromHTMLString:function(html){var parser=new DOMParser;var doc=parser.parseFromString(html,"text/html")||parser.parseFromString(html,"text/xml");var body=doc.body;if(body.children.length!=1){return{}}var attrs={};[].slice.apply(body.children[0].attributes).forEach(function(attr){attrs[attr.name]=attr.value});return attrs},replaceUrls:function(string,callback){return string.toString().replace(URL_REGEXP,callback)},findUrls:function(string){return string.match(URL_REGEXP)||[]},linkify:function(string,target,recognize_www,internal){if(!string)return string;string=TS.utility.replaceUrls(string,function(match){var uri;if(match.toLowerCase().indexOf("www.")===0){if(!recognize_www){return match}uri="http://"+match}else{uri=match}if(internal){return"<"+uri+"|"+match+">"}else{return"<a "+TS.utility.makeRefererSafeLink(uri)+' target="'+(target||"")+'">'+match+"</a>"}});return string},linkifyInternal:function(string,recognize_www){return TS.utility.linkify(string,"",recognize_www,true)},cssCalcSupported:function(){if(_css_calc_supported!==null){return _css_calc_supported}var $el=$('<div style="position:absolute;visibility:hidden; height:-webkit-calc(1px + 1em); height:-moz-calc(1px + 1em); height:calc(1px + 1em);"></div>').appendTo(document.body);_css_calc_supported=$el.height()>0;$el.remove();return _css_calc_supported},cssPropertySupported:function(property){var style=document.createElement("css_property_supported").style;var css_prefixes=["-webkit-","-moz-","-o-","-ms-",""];var js_prefixes=["Webkit","Moz","O","ms",""];var css_prefix_regexp=new RegExp("^(-*"+css_prefixes.slice(0,css_prefixes.length-1).join("|-*")+")");var js_prefix_regexp=new RegExp("^("+js_prefixes.slice(0,js_prefixes.length-1).join("|")+")");property=property.replace(js_prefix_regexp,"").replace(/([A-Z]+)([A-Z][a-z])/g,"$1-$2").replace(/([a-z\d])([A-Z])/g,"$1-$2").replace(css_prefix_regexp,"").toLowerCase();property=TS.utility.camelCaseStringBySeparator(property,"-");var capitalized_property=TS.utility.capitalize(property);if(style[property]!==undefined){return true}return js_prefixes.some(function(prefix){return style[prefix+capitalized_property]!==undefined||style[prefix+property]!==undefined})},getCursorPosition:function(selector){var el,pos,sel;if(selector instanceof HTMLElement){el=selector}else{el=$(selector).get(0)}pos={start:0,end:0,length:0};if("selectionStart"in el){pos.start=el.selectionStart;pos.end=el.selectionEnd;pos.length=Math.abs(el.selectionEnd-el.selectionStart)}else if("selection"in document){el.focus();sel=document.selection.createRange();pos.length=document.selection.createRange().text.length;sel.moveStart("character",-el.value.length);pos.start=sel.text.length-pos.length;pos.end=pos.start+pos.length}return pos},setCursorPosition:function(selector,pos,length){var el,range;el=$(selector).get(0);if(el){if(el.createTextRange){range=el.createTextRange();if(length){range.moveStart("character",pos);range.moveEnd("character",length-pos)}else{range.move("character",pos)}range.select()}else{el.focus();if(length){el.setSelectionRange(pos,pos+length)}else{el.setSelectionRange(pos,pos)}}}},isAnyTextSelected:function(){return window.getSelection().toString().trim()!=""},htmlEntities:function(str){if(!str&&str!==0)return"";return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},unHtmlEntities:function(str){if(!str&&str!==0)return"";return String(str).replace(/\&lt\;/g,"<").replace(/\&gt\;/g,">").replace(/\&amp\;/g,"&").replace(/\&quot;/g,'"')},jsString:function(str){return JSON.stringify(""+str)},preg_quote:function(str){return(str+"").replace(/([\\\.\+\*\?\[\^\]\$\(\)\{\}\=\!\<\>\|\:])/g,"\\$1")},getActiveElementProp:function(name){if(!document)return"";if(!document.activeElement)return"";if(name=="NODENAME"){if(!document.activeElement.nodeName)return"";return document.activeElement.nodeName.toUpperCase()}return document.activeElement[name]},isArrowNavUnSafe:function(){var worker=function(){if(!document)return false;if(!document.activeElement)return false;var NODENAME=TS.utility.getActiveElementProp("NODENAME");if(NODENAME=="INPUT")return true;if(NODENAME=="SELECT")return true;if(NODENAME=="TEXTAREA"){if($&&$("#message-input").is(":focus")&&!$("#message-input").val()){return false}return true}return false};var ret=worker();return ret},isTabCompleteShowing:function(){if(!TS.utility.isFocusOnInput())return false;var $input=$(document.activeElement);if(!$input.tab_complete_ui)return false;if(!$input.tab_complete_ui("instance"))return false;if($input.tab_complete_ui("isShowing")||$input.tab_complete_ui("wasJustHidden")){return true}return false},isFocusOnInput:function(){if(!document)return false;if(!document.activeElement)return false;var NODENAME=TS.utility.getActiveElementProp("NODENAME");if(NODENAME=="INPUT")return true;if(NODENAME=="TEXTAREA")return true;if(NODENAME=="SELECT")return true;var content_editable=document.activeElement.getAttribute("contenteditable");if(content_editable=="true")return true;return false},formatTopicOrPurpose:function(txt){txt=TS.format.unFormatMsg(txt);txt=TS.format.cleanMsg(txt);txt=TS.utility.linkifyInternal(txt,true);txt=TS.format.formatJustText(txt);return txt},capitalize:function(str){return str.charAt(0).toUpperCase()+str.slice(1)},camelCaseStringBySeparator:function(str,sep){var str_split_by_sep,camel_cased_string,i,len;sep=sep||"_";str_split_by_sep=str.split(sep);len=str_split_by_sep.length;if(len===1)return str;camel_cased_string=str_split_by_sep[0].toLowerCase();for(i=1;i<len;i+=1){camel_cased_string+=str_split_by_sep[i].substr(0,1).toUpperCase()+str_split_by_sep[i].substr(1).toLowerCase()}return camel_cased_string},concatNames:function(names){if(!names||names.length===0)return"";if(names.length===1)return names[0];if(names.length===2)return names[0]+" and "+names[1];var s=names.slice(0,names.length-1).join(", ");s+=", and "+names[names.length-1];return s},populateInput:function(input,txt){input.val(txt);input.data("textchange_lastvalue",txt);TS.utility.queueRAF(function populateInputRAF(){input.trigger("autosize").trigger("autosize-resize").trigger("textchange")})},diff:function(str1,str2){function escape(s){var n=s;n=n.replace(/&/g,"&amp;");n=n.replace(/</g,"&lt;");n=n.replace(/>/g,"&gt;");n=n.replace(/"/g,"&quot;");return n}function diffString(o,n){o=o.replace(/\s+$/,"");n=n.replace(/\s+$/,"");var out=diff(o==""?[]:o.split(/\s+/),n==""?[]:n.split(/\s+/));var str="";var oSpace=o.match(/\s+/g);if(oSpace==null){oSpace=["\n"]}else{oSpace.push("\n")}var nSpace=n.match(/\s+/g);if(nSpace==null){nSpace=["\n"]}else{nSpace.push("\n")}if(out.n.length===0){for(var i=0;i<out.o.length;i++){str+="<del>"+escape(out.o[i])+oSpace[i]+"</del>"}}else{if(out.n[0].text==null){for(n=0;n<out.o.length&&out.o[n].text==null;n++){str+="<del>"+escape(out.o[n])+oSpace[n]+"</del>"}}for(var i=0;i<out.n.length;i++){if(out.n[i].text==null){str+="<ins>"+escape(out.n[i])+nSpace[i]+"</ins>"}else{var pre="";for(n=out.n[i].row+1;n<out.o.length&&out.o[n].text==null;n++){pre+="<del>"+escape(out.o[n])+oSpace[n]+"</del>"}str+=" "+out.n[i].text+nSpace[i]+pre}}}return str}function diff(o,n){var ns=new Object;var os=new Object;for(var i=0;i<n.length;i++){if(ns[n[i]]==null){ns[n[i]]={rows:new Array,o:null}}ns[n[i]].rows.push(i)}for(var i=0;i<o.length;i++){if(os[o[i]]==null){os[o[i]]={rows:new Array,n:null}}os[o[i]].rows.push(i)}for(var i in ns){if(ns[i].rows.length==1&&typeof os[i]!="undefined"&&os[i].rows.length==1){n[ns[i].rows[0]]={text:n[ns[i].rows[0]],row:os[i].rows[0]};o[os[i].rows[0]]={text:o[os[i].rows[0]],row:ns[i].rows[0]}}}for(var i=0;i<n.length-1;i++){if(n[i].text!=null&&n[i+1].text==null&&n[i].row+1<o.length&&o[n[i].row+1].text==null&&n[i+1]==o[n[i].row+1]){n[i+1]={text:n[i+1],row:n[i].row+1};o[n[i].row+1]={text:o[n[i].row+1],row:i+1}}}for(var i=n.length-1;i>0;i--){if(n[i].text!=null&&n[i-1].text==null&&n[i].row>0&&o[n[i].row-1].text==null&&n[i-1]==o[n[i].row-1]){n[i-1]={text:n[i-1],row:n[i].row-1};o[n[i].row-1]={text:o[n[i].row-1],row:i-1}}}return{o:o,n:n}}return diffString(str1.replace(/</g,"&lt;").replace(/\,/g,", "),str2.replace(/</g,"&lt;").replace(/\,/g,", "))},urlNeedsRefererHiding:function(url){if(!url)return false;url=url.toLowerCase();if(url.indexOf("https://")!==0&&url.indexOf("http://")!==0)return false;url=url.replace(/^https:\/\//,"").replace(/^http:\/\//,"");var wl=getRefererHidingWhiteList();for(var i=0;i<wl.length;i++){if(url==wl[i]||url.indexOf(wl[i]+"/")===0)return false}return true},referer_safe_url_map:{},makeRefererSafeLink:function(url){if(typeof url!=="string"){TS.error("Expected url to be a string, got: "+typeof url);return}url=url.replace(/\ue000/g,"").replace(/\ue001/g,"");var url_un_amp_encoded=url.replace(/\&amp\;/g,"&");var html_url=TS.utility.htmlEntities(url_un_amp_encoded);if(html_url.indexOf("javascript:")===0)html_url=html_url.replace("javascript:","");var html='href="'+html_url+'"';var on_method="onclick";if(!TS.model||!TS.model.is_our_app){if(_referer_policy&&_referer_policy.rewrite_on_right_click){on_method="onmousedown"}}if(!TS.utility.urlNeedsRefererHiding(url))return html;if(TS.utility.externalURLsNeedRedirecting()){var encoded_url=encodeURIComponent(url_un_amp_encoded);var proxy_url=(TS.boot_data.feature_referer_policy?"https://":"http://")+TS.boot_data.redir_domain+"/link?url="+encoded_url+(TS.boot_data.feature_referer_policy&&_referer_policy&&_referer_policy.redirect_type?"&v="+_referer_policy.redirect_type:"");var map_key=TS.utility.htmlEntities(encoded_url);TS.utility.referer_safe_url_map[map_key]=url_un_amp_encoded;html+=' data-referer-safe="1" '+on_method+'="this.href=&quot;'+proxy_url+'&quot;" onmouseover="this.href=TS.utility.referer_safe_url_map[&quot;'+map_key+'&quot;]" data-referer-original-href="'+url+'" rel="noreferrer"'}else{html+=' rel="noreferrer"'}return html},makeSureAllExternalLinksAreRefererSafe:function($el){var start=Date.now();var bads=[];if(TS.utility.externalURLsNeedRedirecting()){$el.find("a[href]:not([data-referer-safe])").each(function(){var a=$(this);var href=a.attr("href");if(!TS.utility.urlNeedsRefererHiding(href))return;bads.push(this.outerHTML);a.removeAttr("href");var new_html=this.outerHTML.replace("<a",function(){return"<a "+TS.utility.makeRefererSafeLink(href)+" "});a.replaceWith(new_html);bads[bads.length-1]+="\n->\n"+new_html});if(TS.model&&TS.model.team&&TS.model.team.domain=="tinyspeck"){if(bads.length){TS.log(365,"#"+$el.attr("id")+" had "+bads.length+" LINKS WITH EXT HREFS BUT NOT data-referer-safe! to fix it took "+(Date.now()-start)+"ms");TS.dir(365,bads)}else{TS.log(365,"#"+$el.attr("id")+" had "+bads.length+" LINKS WITH EXT HREFS BUT NOT data-referer-safe! to check it took "+(Date.now()-start)+"ms")}}}else{$el.find("a[href]:not([rel])").each(function(){var a=$(this);var href=a.attr("href");if(href.indexOf("mailto")===0||href.indexOf("skype")===0)return;if(href&&href!="#"){if(TS.utility.urlNeedsRefererHiding(href)){bads.push(this.outerHTML);a.attr("rel","noreferrer");bads[bads.length-1]+="\n->\n"+this.outerHTML}}else{a.removeAttr("href")}});if(TS.model&&TS.model.team&&TS.model.team.domain=="tinyspeck"){if(bads.length){TS.log(365,"#"+$el.attr("id")+" had "+bads.length+' LINKS WITH EXT HREFS BUT WITHOUT rel="noreferrer"! to add rel it took '+(Date.now()-start)+"ms");TS.dir(365,bads)}else{TS.log(365,"#"+$el.attr("id")+" had "+bads.length+' LINKS WITH EXT HREFS BUT WITHOUT rel="noreferrer"! to check it took '+(Date.now()-start)+"ms")}}}},makeSureAllLinksHaveTargets:function($el){var start=Date.now();var bads=[];$el.find("a[href]:not([target])").each(function(){var a=$(this);var href=a.attr("href");if(href.indexOf("mailto")===0||href.indexOf("skype")===0)return;if(href&&href!="#"){bads.push(this.outerHTML);a.attr("target",href);bads[bads.length-1]+="\n->\n"+this.outerHTML}else{a.removeAttr("href")}});if(TS.model&&TS.model.team&&TS.model.team.domain=="tinyspeck"){if(bads.length){TS.log(365,"#"+$el.attr("id")+" had "+bads.length+" LINKS WITH HREFS BUT WITHOUT TARGETS! to add targets it took "+(Date.now()-start)+"ms");TS.dir(365,bads)}else{TS.log(365,"#"+$el.attr("id")+" had "+bads.length+" LINKS WITH HREFS BUT WITHOUT TARGETS! to check it took "+(Date.now()-start)+"ms")}}TS.utility.makeSureAllExternalLinksAreRefererSafe($el)},sortTable:function(table,td_index,order,subsort_index,subsort_order){order=order=="desc"?"desc":"asc";subsort_order=subsort_order=="desc"?"desc":"asc";function sortFunc(index){return function(td1,td2){var a=getCellValue(td1,index);var b=getCellValue(td2,index);if($.isNumeric(a)&&$.isNumeric(b)){if(a==b&&subsort_index){a=getCellValue(td1,subsort_index);b=getCellValue(td2,subsort_index);if($.isNumeric(a)&&$.isNumeric(b)){if(subsort_order!=order){return b-a}else{return a-b}}else{if(subsort_order!=order){return b.localeCompare(a)}else{return a.localeCompare(b)}}}return a-b}else{return a.localeCompare(b)}}}function getCellValue(tr,index){return $(tr).children("td").eq(index).attr("data-sort-val")}var rows=table.find("tr:gt(0)").toArray().sort(sortFunc(td_index));if(order=="desc")rows=rows.reverse();for(var i=0;i<rows.length;i++){table.append(rows[i])}},getPercSmartly:function(x,y){if(!x||!y)return"0%";var perc=x/y*100;if(perc!=100&&Math.round(perc)==100)return"99%";if(perc<.7)return"<1%";return Math.round(perc)+"%"},isCursorWithinTBTs:function(input){var p=TS.utility.getCursorPosition(input);var val=input.val();var text_before=val.substr(0,p.end);var tbt_before=text_before.match(/```/g);if(!tbt_before)return false;var tbt_before_cnt=tbt_before.length;if(tbt_before_cnt%2)return true;return false},getLowerCaseValue:function(str){return str&&str.toLowerCase?str.toLowerCase():""},rgb2hex:function(rgb){if(/^#[0-9A-F]{6}$/i.test(rgb))return rgb;var rgb_match=rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);if(!rgb_match){rgb_match=rgb.match(/^rgba\((\d+),\s*(\d+),\s*(\d+),\s*(\d*\.?\d+)\)$/)}if(!rgb_match){return}function hex(x){return("0"+parseInt(x).toString(16)).slice(-2)}return"#"+hex(rgb_match[1])+hex(rgb_match[2])+hex(rgb_match[3])},setImmediate:function(fn){_set_immediate_fn(fn)},immediateDebounce:function(fn){var scheduled=false;return function(){if(scheduled){return}var self=this;var args=arguments;scheduled=true;_set_immediate_fn(function(){scheduled=false;fn.apply(self,args)})}},debounce:function(fn,delay){var timer;return function(){var self=this;var args=arguments;clearTimeout(timer);timer=setTimeout(function(){fn.apply(self,args)},delay)}},throttleFunc:function(func,ms,always_wait){var data={};var funcReplacement=function funcReplacement(){var args=Array.prototype.slice.apply(arguments);if(!args.every(TS.utility.isScalar)){TS.error("You're passing non-scalar arguments to a function throttled with TS.utility.throttleFunc; it will likely not work as you want")}var key="f-"+args.join("-");if(data[key]&&data[key].context!==this){throw new Error("Cannot use this function with different `this` contexts across different calls "+this+" "+data[key].context)}data[key]=data[key]||{requested:Date.now(),timeout:0,context:this};if(data[key].timeout||funcReplacement.always_wait){data[key].requested=Date.now()}else{func.apply(data[key].context,args)}if(data[key].timeout)return;data[key].timeout=setTimeout(function timerFunc(){var elapsed=Date.now()-data[key].requested;if(elapsed>=ms){func.apply(data[key].context,args);delete data[key]}else{data[key].timeout=setTimeout(timerFunc,ms-elapsed)}},ms)};funcReplacement.always_wait=!!always_wait;return funcReplacement},onlyRunFuncOnce:function(func){var ran;var result;if(typeof func!=="function")return;return function(){if(ran){return result}ran=true;result=func.apply(this,arguments);func=null;return result}},cmdKey:function(e){if(!e)return false;if(TS.model.is_mac){return!!e.metaKey}else{return!!e.ctrlKey}},throttle:function(){var defaults,data;defaults={delay:200,timer_group:"generic"};data={timers:{},queues:{}};function processQueue(timer_group){var i,j;if(data.timers[timer_group]){if(data.queues[timer_group]){for(i=0,j=data.queues[timer_group].length;i<j;i++){if(data.queues[timer_group][i]){data.queues[timer_group][i]()}}}data.queues[timer_group]=null;data.timers[timer_group]=null}}function method(func,timer_group,delay){if(!func){return false}timer_group=timer_group||defaults.timer_group;if(!data.timers[timer_group]){delay=delay||defaults.delay;data.timers[timer_group]=window.setTimeout(function(){processQueue(timer_group)},delay)}if(!data.queues[timer_group]){data.queues[timer_group]=[]}if(data.queues[timer_group].indexOf){if(data.queues[timer_group].indexOf(func)===-1){data.queues[timer_group].push(func)}}else{data.queues[timer_group].push(func)}}return{method:method}}(),getImgProxyURL:function(url,w,h){if(!url)return url;if(!TS.boot_data.image_proxy_url)return url;var image_proxy_url=TS.boot_data.image_proxy_url;if(url.indexOf(image_proxy_url)===0)return url;var i,j;var whitelist=getRefererHidingWhiteList();var test_url;if(url.indexOf("https://")===0){test_url=url.replace(/^https:\/\//,"");for(i=0,j=whitelist.length;i<j;i++){if(test_url.indexOf(whitelist[i]+"/")===0){return url}}}var proxy_url=image_proxy_url+"?url="+encodeURIComponent(url);w=parseInt(w);h=parseInt(h);if(w&&h){proxy_url+="&width="+w+"&height="+h}return proxy_url},rAF:function(){var vendors=["ms","moz","webkit","o"];var requestAnimationFrame=window.requestAnimationFrame;var x;for(x=0;x<vendors.length&&!requestAnimationFrame;x++){requestAnimationFrame=window[vendors[x]+"RequestAnimationFrame"]}if(!requestAnimationFrame){var last_time=0;return function(callback){var curr_time=Date.now();var time_to_call=Math.max(0,16-(curr_time-last_time));var id=window.setTimeout(function(){callback(curr_time+time_to_call)},time_to_call);last_time=curr_time+time_to_call;return id}}return function(fn){return requestAnimationFrame.call(window,fn)}}(),cancelRAF:function(){var vendors=["ms","moz","webkit","o"];var cancelAnimationFrame=window.cancelAnimationFrame;var x;for(x=0;x<vendors.length&&!cancelAnimationFrame;x++){cancelAnimationFrame=window[vendors[x]+"CancelAnimationFrame"]||window[vendors[x]+"CancelRequestAnimationFrame"]}if(!cancelAnimationFrame){return function(id){clearTimeout(id)}}return function(id){cancelAnimationFrame.call(window,id)}}(),queueRAF:function(rafCallback){if(TS.boot_data&&TS.boot_data.feature_js_raf_queue){_rafQueue.add(rafCallback)}else{rafCallback()}},startAnimation:function(callback){return _animationManager.subscribe(callback)},loadUrlInWindowIfOnline:function(url,doc){doc=doc||document;TS.api.call("api.test",{},function(ok,data,args){if(ok){$("body").addClass("hidden");doc.location=url}else{TS.generic_dialog.alert("You can't perform that action because you are not online :(")}})},externalURLsNeedRedirecting:function(){if(TS.boot_data.feature_no_redirects_in_ssb){if(TS.model.team.prefs.hide_referers&&!TS.model.is_our_app)return true}else{if(TS.model.team.prefs.hide_referers)return true}return false},swapInRedirUrlForIframe:function(html,referer_policy){referer_policy=referer_policy||_referer_policy;if(!referer_policy)return html;if(!referer_policy.iframe_redirect_type)return html;var $html=$(html);var src=$html.attr("src");if(!src)return html;if(TS.qs_args["test_iframe_referers"]=="1"){src="https://"+document.location.host+"/referertester.html?"+Date.now()}src="https://"+TS.boot_data.redir_domain+"/link?v="+referer_policy.iframe_redirect_type+"&url="+encodeURIComponent(src);$html.attr("src",src);html=$html[0].outerHTML;if(TS.qs_args["test_iframe_referers"]=="1"){TS.info("html with redir:"+html)}return html},getPlaceholderHTMLFromIframe:function(html){html=html.replace(/<iframe/,"<div").replace(/<\/iframe/,"</div");var $html=$(html);$html.css("height",$html.attr("height")+"px").css("width",$html.attr("width")+"px").attr("data-real-src",$html.attr("src")).attr("src","").addClass("iframe_placeholder");html=$html[0].outerHTML;return html},getIframeHTMLFromPlaceholder:function(html){html=html.replace(/<div/,"<iframe").replace(/<\/div/,"</iframe");var $html=$(html);$html.attr("src",$html.data("real-src")).removeClass("iframe_placeholder");html=$html[0].outerHTML;return html},isArrowKey:function(which){var keymap=TS.utility.keymap;if(which==keymap.down)return true;if(which==keymap.up)return true;if(which==keymap.right)return true;if(which==keymap.left)return true;return false},isPageKey:function(which){var keymap=TS.utility.keymap;if(which==keymap.pageup)return true;if(which==keymap.pagedown)return true;if(which==keymap.home)return true;if(which==keymap.end)return true;return false},getFileIDFromURL:function(url){if(!url)return null;url=TS.utility.normalizeDevHost(String(url));var files_url_parser=document.createElement("a");files_url_parser.href=TS.model.files_url;var files_url_hostname=files_url_parser.host;var input_url_parser=document.createElement("a");input_url_parser.href=url;var pathname=input_url_parser.pathname;while(pathname.indexOf("/")===0){pathname=pathname.substr(1)}var valid_hostnames=[files_url_hostname,"files.dev.slack.com","files.staging.slack.com","files.slack.com"];if(valid_hostnames.indexOf(input_url_parser.host)===-1){return null}var file_id;var pathname_parts;if(pathname.indexOf("files/")===0){pathname_parts=pathname.split("/");if(pathname_parts.length<3)return null;var member_name=pathname_parts[1];if(!member_name)return null;if(!TS.members.getMemberByName(member_name))return null;file_id=pathname_parts[2]}else if(pathname.indexOf("files-pri/")===0){pathname_parts=pathname.split("/");if(pathname_parts.length<3)return null;var file_desc=pathname_parts[1];if(file_desc.indexOf("-")<0)return null;var file_desc_elems=file_desc.split("-");if(file_desc_elems.length!==2)return null;file_id=file_desc_elems[1]}else{return null}if(!file_id)return null;if(file_id.substr(0,1)!="F")return null;if(file_id.length<2)return null;if(file_id.length>15)return null;return file_id},getBotIDFromURL:function(url){if(!url)return null;url=TS.utility.normalizeDevHost(String(url));url=url.replace("https://","").replace("http://","");var bots_url=TS.model.bots_url.replace("https://","").replace("http://","");if(url.indexOf(bots_url)===0){url=url.replace(bots_url,"services")}while(url.indexOf("/")===0){url=url.substr(1)}if(url.indexOf("services/")!==0)return null;var A=url.split("/");if(A.length<2)return null;var bot_id=A[1];if(!bot_id)return null;if(bot_id.substr(0,1)!="B")return null;if(bot_id.length<2)return null;if(bot_id.length>15)return null;return bot_id},getMemberIdFromURL:function(url){if(!url)return null;url=TS.utility.normalizeDevHost(String(url));url=url.replace("https://","").replace("http://","");var team_url=TS.model.team_url.replace("https://","").replace("http://","");if(url.indexOf(team_url)===0){url=url.replace(team_url,"team")}while(url.indexOf("/")===0){url=url.substr(1)}if(url.indexOf("team/")!==0)return null;var A=url.split("/");if(A.length<2)return null;var member_name=A[1];if(!member_name)return null;var member=TS.members.getMemberByName(member_name);if(member)return member.id;return null},normalizeDevHost:function(url){return url.replace(/\.dev[0-9]*.slack.com/i,".dev.slack.com").replace(/\.staging.slack.com/i,".slack.com")},platformSupportsHtmlNotifications:function(){if(TS.model.win_ssb_version&&window.winssb){if(window.winssb.app.canShowHtmlNotifications){return winssb.app.canShowHtmlNotifications()}else{return winssb.app.willUseHwAcceleration!==false}}return false},platformSupportsImgEmojiInHtmlNotifications:function(){return TS.model.win_ssb_version&&(TS.model.win_ssb_version>.9||TS.model.win_ssb_version==.9&&TS.model.win_ssb_version_minor>=5)},ensureArray:function(val){return $.isArray(val)?val:[]},findAllTeamEmojiInStr:function(str,unique){str=$.trim(str);var A=[];if(!str)return A;A=str.match(TS.emoji.getColonsRx())||A;var extras=[];A=A.filter(function(colon_name){if(TS.emoji.isValidName(colon_name)){return true}colon_name.split("::").forEach(function(partial_colon_name){var name=TS.emoji.isValidName(partial_colon_name);if(!name)return;extras.push(":"+name+":")});return false});A=A.concat(extras);if(unique)A=TS.utility.dedupeArray(A);TS.dir(248,A);return A},dedupeArray:function(A){return A.filter(function(item,index,A){return A.indexOf(item)===index})},callFuncWhenApiQisEmpty:function(func){if(TS.api.hasPendingRequests()){if(!TS.api.Q_empty_sig.has(func)){TS.api.Q_empty_sig.addOnce(func)}}else{func()}},equal_stats:{agree:0,agree_true:0,agree_false:0,disagree:0,json_true:0,comp_true:0,json_ms:0,comp_ms:0},areSimpleObjectsEqual:function recurse(x,y){if(x===y)return true;if(x===undefined&&y)return false;if(y===undefined&&x)return false;if(typeof x!==typeof y)return false;if(x===null&&y)return false;if(y===null&&x)return false;if(x.length!==y.length)return false;var p;for(p in y){if(typeof x[p]=="undefined"&&typeof y[p]!="undefined")return false;if(y[p]){switch(typeof y[p]){case"object":if(!recurse(x[p],y[p]))return false;break;case"function":if(String(y[p])!=String(x[p]))return false;break;default:if(y[p]!==x[p])return false}}else{if(x[p])return false}}for(p in x){if(typeof y[p]=="undefined"&&typeof x[p]!="undefined")return false}return true},areSimpleObjectsEqualWithLogging:function(x,y,name){name="[ "+(name||(x&&x.id?x.id:"root"))+" ]";var stats=TS.utility.equal_stats;var now;var log_strA=[];var x_json;var y_json;var json_says;var json_time;var comp_says;var comp_time;var p;var log_all=TS.shouldLog(283);var log_inequalities=log_all||TS.shouldLog(282);var log_pri=function(){if(log_inequalities||log_all)return log_all?283:282;return 0}();var falseLogger=function(path,reason,x,y){if(log_inequalities){log_strA.push(reason+" FAIL "+path+"\n	x:"+x+"\n	y:"+y+"\n")}return false};var comparator=function comparator(x,y,json_compare,path){if(x===y)return true;if(json_compare){x_json=JSON.stringify(x||null);y_json=JSON.stringify(y||null);return x_json==y_json}if(typeof x!==typeof y)return falseLogger(path,"TYPEOF",typeof x,typeof y);if(x===null&&y)return falseLogger(path,"X NULL",x,y);if(y===null&&x)return falseLogger(path,"Y NULL",x,y);if(x===undefined&&y)return falseLogger(path,"X UND",x,y);if(y===undefined&&x)return falseLogger(path,"Y UND",x,y);if(x.length!==y.length)return falseLogger(path,"LENGTH",x.length,y.length);for(p in y){if(typeof x[p]=="undefined"&&typeof y[p]!="undefined")return falseLogger(path+"[ "+p+" ]","UNDEFINED",x[p],y[p]);if(y[p]){switch(typeof y[p]){case"object":if(!comparator(x[p],y[p],json_compare,path+"[ "+p+" ]"))return false;break;case"function":if(String(y[p])!=String(x[p]))return falseLogger(path+"[ "+p+" ]","FUNCTION",x[p],y[p]);break;default:if(y[p]!==x[p])return falseLogger(path+"[ "+p+" ]","EQUALITY",x[p],y[p])}}else{if(x[p])return falseLogger(path+"[ "+p+" ]","EXISTENCE IN X",x[p],y[p])}}for(p in x){if(typeof y[p]=="undefined"&&typeof x[p]!="undefined")return falseLogger(path+"[ "+p+" ]","EXISTENCE IN Y",x[p],y[p])}return true};now=Date.now();json_says=comparator(x,y,true,name);json_time=Date.now()-now;stats.json_ms+=json_time;now=Date.now();comp_says=comparator(x,y,false,name);comp_time=Date.now()-now;stats.comp_ms+=comp_time;if(json_says!=comp_says){if(!log_inequalities){log_all=log_inequalities=true;comparator(x,y,true,name);comparator(x,y,false,name)}log_strA.push("");log_strA.push("json_says: "+json_says);log_strA.push("x_json.length: "+x_json.length);log_strA.push("y_json.length: "+y_json.length);if(x_json.length<100){log_strA.push("x_json: "+x_json);log_strA.push("y_json: "+y_json)}log_strA.push("comp_says: "+comp_says);log_strA.push("json_time: "+json_time);log_strA.push("comp_time: "+comp_time);stats.disagree++;if(json_says){stats.json_true++}else{stats.comp_true++}}else{if(log_inequalities&&!json_says){log_strA.push("")}else if(log_all){log_strA.push("")}stats.agree++;if(json_says){stats.agree_true++}else{stats.agree_false++}}if(log_strA.length){log_strA.push(JSON.stringify(TS.utility.equal_stats,null,2));TS.log(log_pri,name+"\n"+log_strA.join("\n"))}return comp_says&&json_says},appendLogToUrlWithLimit:function(url,log){if(!url)return url;url+=url.indexOf("?")==-1?"?":"&";if(!log)return url;var log_limit=2e3-url.length;return url+log.substr(0,log_limit)},isDocumentHidden:function(){if(document.hidden||document.webkitHidden||document.mozHidden||document.msHidden)return true;return false},makeWebWorker:function(worker_func_str,onmessage){var url=URL.createObjectURL(new Blob(["(",worker_func_str,")()"],{type:"application/javascript"}));var worker=new Worker(url);URL.revokeObjectURL(url);worker.onmessage=onmessage;return worker},getMutationObserver:function(handler){var MutationObserver=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver;if(MutationObserver)return new MutationObserver(handler);return null},extractAllModelObIds:function(ob,source){source=source&&String(source)||"";var is_search=source.substr(0,7)=="search.";var c_ids=[];var seens=[];var isPropertyAChannelIdThatNeedsChecking=function(name,parent_name){if(name=="channel")return true;if(name=="id"&&is_search&&parent_name=="channel")return true;return false};var worker=function(ob,parent_name){if(typeof ob!=="object")return;seens.push(ob);var k;var val;for(k in ob){val=ob[k];if(typeof val==="string"){
if(isPropertyAChannelIdThatNeedsChecking(k,parent_name)){if(TS.utility.strLooksLikeAChannelId(val)){TS.utility.ensureInArray(c_ids,val)}}else{TS.format.extractIds(val).c_ids.forEach(function(id){TS.utility.ensureInArray(c_ids,id)})}}}for(k in ob){val=ob[k];if(typeof val==="object"){if(seens.indexOf(val)!=-1)continue;if(Array.isArray(val)&&(k==="channels"||k==="ims"||k==="groups")){val.forEach(function(c_id){if(typeof c_id==="string"){TS.utility.ensureInArray(c_ids,c_id)}})}else{worker(val,k)}}}};worker(ob,"_DATA");if(TS.shouldLog("794")){_doubleCheckIdExtraction(ob,source,c_ids,_double_check_ids_channel_rx)}return c_ids},extractAllMemberIds:function(ob,source,channel_id){source=source&&String(source)||"";var m_ids=[];var c_ids=[];var t_ids=[];var seens=[];var isPropertyAMemberIdThatNeedsChecking=function(name,parent_name){if(name=="user")return true;if(name=="inviter")return true;if(name=="accepted_user")return true;return false};var worker=function(ob,parent_name){if(typeof ob!=="object")return;seens.push(ob);var k;var val;for(k in ob){val=ob[k];if(typeof val==="string"){if(isPropertyAMemberIdThatNeedsChecking(k,parent_name)){if(TS.utility.strLooksLikeAMemberId(val)){if(TS.utility.ensureInArray(m_ids,val)){c_ids.push(typeof ob.channel=="string"&&ob.channel||typeof ob.channel=="object"&&ob.channel&&ob.channel.id||channel_id||undefined);t_ids.push(typeof ob.team=="string"&&ob.team||typeof ob.team=="object"&&ob.team&&ob.team.id||undefined)}}}else{TS.format.extractIds(val).m_ids.forEach(function(id){if(TS.utility.ensureInArray(m_ids,id)){c_ids.push(undefined);t_ids.push(undefined)}})}}}for(k in ob){val=ob[k];if(typeof val==="object"){if(seens.indexOf(val)!=-1)continue;if(Array.isArray(val)&&(k==="members"||k==="users")){val.forEach(function(m_id){if(TS.utility.strLooksLikeAMemberId(m_id)){if(TS.utility.ensureInArray(m_ids,m_id)){c_ids.push(typeof ob.id=="string"&&ob.channel||channel_id||undefined);t_ids.push(typeof ob.team=="string"&&ob.team||typeof ob.team=="object"&&ob.team&&ob.team.id||undefined)}}})}else{worker(val,k)}}}};worker(ob,"_DATA");if(TS.shouldLog("794")){_doubleCheckIdExtraction(ob,source,m_ids,_double_check_ids_member_rx)}return{c_ids:c_ids,t_ids:t_ids,m_ids:m_ids}},strLooksLikeAChannelId:function(str){if(typeof str!=="string"||str.length<9)return false;if(str&&TS.model.channel_id_prefixes.indexOf(str.charAt(0))>-1)return true;return false},strLooksLikeAMemberId:function(str){if(typeof str!=="string"||str.length<9)return false;if(str&&str.charAt(0)=="U")return true;return false},truncateToNearestWordBoundary:function(str,len){if(str.length<=len)return str;var ellipsis="";var truncated_str=str.substring(0,len);var last_space_idx=truncated_str.lastIndexOf(" ");if(last_space_idx>0&&last_space_idx>len-5){return truncated_str.substring(0,last_space_idx)+ellipsis}return truncated_str.substring(0,truncated_str.length-1)+ellipsis},truncateAndEscape:function(str,len){if(str.length<=len)return TS.utility.htmlEntities(str);return TS.utility.htmlEntities(str.substring(0,len-1))+"&hellip;"},isSpaceClickEventSafe:function(e,check_only){if(TS.boot_data.feature_spaces&&e.target){var $link=$(e.target).closest("[href]");if(!$link[0])return true;if(!$link.closest(".post_body").length&&!$link.closest("ts-rocket").length)return true;var protocol=$link[0].protocol;if(protocol&&/^https?:$/.test(protocol)===false){TS.warn("not following bad link from a post preview");e.preventDefault();return false}if($link.data("original-href")){TS.warn("not following possibly spoofed link from a post preview");e.preventDefault();var url=$link.data("referer-original-href")||$link.attr("href");if(!check_only)_spaceUnsafeLinkDialog($link.data("original-href"),$link.attr("href"),url);return false}}return true},overrideMethod:function(object,method_name,callback){object[method_name]=callback(object[method_name])},getCachedScript:function(url,options){options=$.extend(options||{},{dataType:"script",cache:true,url:url});return jQuery.ajax(options)}});var _double_check_ids_channel_rx=/(?:"|<#)([CGD][0-9a-zA-Z]{8,10})(?:"|\||\>)/g;var _double_check_ids_member_rx=/(?:"|<@)(U[0-9a-zA-Z]{8,10})(?:"|\||\>)/g;var _spaceUnsafeLinkDialog=function(originalUrl,actionUrl,safeUrl){var title="",body="";title+='<ts-icon class="ts_icon_warning yolk_orange small_right_margin"></ts-icon> ';title+="Caution: Tricky Link";body+="<p>";body+='  <span class="inline_block">The link you clicked (<strong>'+safeUrl+"</strong>) is tricky.</span>";body+='  <span class="inline_block">It has been formatted to look like another web address (<strong>'+originalUrl+"</strong>).</span>";body+="</p>";body+="<p>Are you sure you want to follow it?</p>";TS.generic_dialog.start({title:title,body:body,show_cancel_button:false,show_secondary_go_button:true,secondary_go_button_text:"Lets risk it",secondary_go_button_class:"btn_outline",onSecondaryGo:function(){window.open(actionUrl)},go_button_text:"Take me back to safety",esc_for_ok:true,enter_always_gos:true})};var _doubleCheckIdExtraction=function(ob,source,ids,rx){var trueMatches=function(str,rx){var A=[];var match;while(match=rx.exec(str)){A.push(match[1])}return A};var json_str=JSON.stringify(ob);var A=TS.utility.dedupeArray(trueMatches(json_str,rx));if(A.length!=ids.length){TS.warn(source+"   A: "+A.join(", "));TS.info(source+" ids: "+ids.join(", "));if(A.length>ids.length){TS.info(source+" dif: "+_.difference(A,ids).join(", "))}else{TS.info(source+" dif: "+_.difference(ids,A).join(", "))}}};var _referer_policy=function(){var data=window.boot_data;if(!data){TS.warn("window.boot_data not available");return null}if(!data.feature_referer_policy&&TS.qs_args["test_iframe_referers"]!="1"){return null}var def={iframe_redirect_type:4,redirect_type:3,rewrite_on_right_click:true};var can_warn=window.console!==undefined&&console.warn;if(!window.bowser){if(can_warn)console.warn("window.bowser undefined, defaulting to restrictive referrer policy");return def}if(bowser.chrome&&bowser.version>=4.1||bowser.opera&&bowser.version>=15){return{iframe_redirect_type:4,redirect_type:null,rewrite_on_right_click:false}}if(bowser.ie){return{iframe_redirect_type:4,redirect_type:3,rewrite_on_right_click:true}}if(bowser.firefox){return{iframe_redirect_type:bowser.version>=36?4:2,redirect_type:3,rewrite_on_right_click:bowser.version>=36?false:true}}if(bowser.safari&&bowser.version>=5||navigator.userAgent.match(/(Slack_SSB)/g)){return{iframe_redirect_type:2,redirect_type:null,rewrite_on_right_click:false}}if(can_warn)console.warn("browser not recognized, defaulting to restrictive referrer policy");return def}();var _referer_hiding_whitelist=null;window.getRefererHidingWhiteList=function(){if(_referer_hiding_whitelist)return _referer_hiding_whitelist;_referer_hiding_whitelist=[TS.model.team.domain+".dev.slack.com",TS.model.team.domain+".staging.slack.com",TS.model.team.domain+".slack.com","files.staging.slack.com","files.dev.slack.com","files.slack.com","dev.slack-files.com","staging.slack-files.com","www.slack-files.com","slack-files.com","slack-imgs.com","slack.com",TS.boot_data.redir_domain,"my.slack.com","www.slack.com"];for(var i=0;i<200;i++){_referer_hiding_whitelist.push(TS.model.team.domain+".dev"+i+".slack.com");_referer_hiding_whitelist.push("files.dev"+i+".slack.com");_referer_hiding_whitelist.push("dev"+i+".slack-files.com")}return _referer_hiding_whitelist};var URL_REGEXP=/((ftp|http|https)\:\/\/|\bw{3}\.)[a-z0-9\-\.]+[a-z]+(:[a-z0-9]*)?\/?([@a-z0-9\-\._\?\,\'\/\\\+&amp;%\:!$#\=~])*/gi;var _set_immediate_fn=window.setImmediate;if(!_set_immediate_fn){if(window.MutationObserver){var hiddenDiv=document.createElement("div");var callbacks=[];new MutationObserver(function(records){var cbList=callbacks.slice();callbacks.length=0;cbList.forEach(function(callback){callback()})}).observe(hiddenDiv,{attributes:true});_set_immediate_fn=function(callback){if(!callbacks.length){hiddenDiv.setAttribute("yes","no")}callbacks.push(callback)}}else{_set_immediate_fn=function(fn){setTimeout(fn,0)}}}var _css_calc_supported=null;var _rafQueue=function(){var items=[];var is_running=false;function processItems(){items.forEach(function(animation){animation()});items=[];is_running=false}function addItem(fn,allow_duplicate){if(allow_duplicate||items.indexOf(fn)===-1){items.push(fn)}if(!is_running&&items.length){is_running=true;TS.utility.rAF(processItems)}}return{add:addItem}}();var _animationManager=function(){var is_running=false;var subscribers=[];function redrawLoop(){if(!is_running){return}subscribers.forEach(function(animation){animation()});TS.utility.rAF(redrawLoop)}function subscribe(fn){var ret={start:function(){subscribers.push(fn);if(!is_running){is_running=true;TS.utility.rAF(redrawLoop)}},stop:function(){subscribers.splice(subscribers.indexOf(fn),1);if(!subscribers.length){is_running=false}}};ret.start();return ret}return{subscribe:subscribe,subscribers:subscribers,isRunning:function(){return is_running}}}()})();(function(){"use strict";TS.registerModule("format",{hex_rx:/(\W|^)(#[A-Fa-f0-9]{6})(\b)/g,onStart:function(){},cleanMsg:function(txt){if(!txt)return"";txt=TSF.getTokensString(txt,"CLEAN");txt=txt.replace(/(^|\s|\(|&gt;|\*|_)(@[\w|.|-]+)/g,function(m,$1,$2){var extra="";var lc=$2.toLowerCase();var cmd;if(/^@everyone[\.|\-|_]*$/.test(lc)){cmd="<!everyone>";extra=lc.substr("!everyone".length)}else if(/^@here[\.|\-|_]*$/.test(lc)){cmd="<!here|@here>";extra=lc.substr("!here".length)}else if(/^@channel[\.|\-|_]*$/.test(lc)){cmd="<!channel>";extra=lc.substr("!channel".length)}else if(/^@group[\.|\-|_]*$/.test(lc)){cmd="<!group>";extra=lc.substr("!group".length)}if(cmd){return $1+cmd+extra}m=TS.members.getMemberByName($2);var specials=[".","..","...","....","-","--","_"];var special;var s=0;while(!m&&s<specials.length){special=specials[s];if($2&&$2.substr($2.length-special.length,special.length)==special){var stripped=$2.substr(0,$2.length-special.length);extra=special;m=TS.members.getMemberByName(stripped)}s++}if(m){return $1+"<@"+m.id+">"+extra}if(TS.boot_data.feature_subteams){var ug=TS.user_groups.getUserGroupsByHandle($2);s=0;while(!ug&&s<specials.length){special=specials[s];if($2&&$2.substr($2.length-special.length,special.length)==special){var ug_stripped=$2.substr(0,$2.length-special.length);extra=special;ug=TS.user_groups.getUserGroupsByHandle(ug_stripped)}s++}if(ug){return $1+"<!subteam^"+ug.id+"|@"+ug.handle+">"+extra}}return $1+$2});txt=txt.replace(/(^|\s|\(|&gt;|\*|_)(#[a-zA-Z0-9\-_]+)/g,function(m,$1,$2){var c=TS.channels.getChannelByName($2);var extra="";var specials=["-","--","_"];var special;var s=0;while(!c&&s<specials.length){special=specials[s];if($2&&$2.substr($2.length-special.length,special.length)==special){var stripped=$2.substr(0,$2.length-special.length);extra=special;c=TS.channels.getChannelByName(stripped);if(c)extra=special}s++}if(c){return $1+"<#"+c.id+">"+extra}return $1+$2});if(TS.model.prefs.convert_emoticons&&TS.model.prefs.emoji_mode!="as_text"){txt=TS.format.doEmoticonConversion(txt)}return txt},doEmoticonConversion:function(str){_emoticon_conversion_token_map.length=0;str=str.replace(_special_pre_rx,_emoticonConversionTokenReplacer);str=str.replace(_special_code_rx,_emoticonConversionTokenReplacer);str=str.replace(_special_quote_rx,_emoticonConversionTokenReplacer);str=TS.emoji.replaceEmoticons(str);str=TS.format.deTokenizeStr(_emoticon_conversion_token_map,str);return str},tokenizeStr:function(token_map,str,boundary){if(!str)return"";boundary=boundary||"";var nl=str.indexOf("\n")===0?"\n":"";var token=_encodeSpecialFormattingCharsAndColon(nl+_token_base+_token_cnt++ +Date.now());token=boundary+token+boundary;token_map.push({str:str,token:token});return token},deTokenizeStr:function(token_map,str){var item;var i=token_map.length-1;for(i;i>-1;i--){item=token_map[i];str=str.replace(item.token,item.str.replace(/\$/g,"$$$$"))}return str},unFormatMsg:function(txt,msg){if(!txt)return"";return _calculateOptionsAndFormat(txt,msg,{for_edit:true})},formatJustText:function(txt){return _calculateOptionsAndFormat(txt)},formatDefault:function(txt,msg){return _calculateOptionsAndFormat(txt,msg)},formatNoHighlightsNoSpecials:function(txt,msg){return _calculateOptionsAndFormat(txt,msg,{no_highlights:true,no_specials:true})},formatNoHighlightsNoSpecialsNoInlineImgs:function(txt,msg){return _calculateOptionsAndFormat(txt,msg,{no_highlights:true,no_specials:true,do_inline_imgs:false})},formatNoHighlightsNoInlineImgs:function(txt,msg){return _calculateOptionsAndFormat(txt,msg,{do_inline_imgs:false,no_highlights:true})},formatNoSpecials:function(txt,msg){return _calculateOptionsAndFormat(txt,msg,{no_specials:true})},formatNotification:function(txt,msg){return _calculateOptionsAndFormat(txt,msg,{for_growl:true})},extractIds:function(txt){var c_ids=[];var m_ids=[];var matches=txt.match(/<[#@]+(.*?)>/g);if(matches){matches.forEach(function(item){var guts;var id;if(item.indexOf("<@")===0){guts=item.replace(/<|>/g,"");id=TS.utility.msgs.getMemberIdFromMemberMarkup(guts);if(TS.utility.strLooksLikeAMemberId(id)){TS.utility.ensureInArray(m_ids,id)}}else if(item.indexOf("<#")===0){guts=item.replace(/<|>|#/g,"");id=guts.split("|")[0];if(TS.utility.strLooksLikeAChannelId(id)){TS.utility.ensureInArray(c_ids,id)}}})}return{c_ids:c_ids,m_ids:m_ids}},formatWithOptions:function(txt,msg,opts){return _calculateOptionsAndFormat(txt,msg,opts)},at_symbol_token:"thisreplacementtokenallowsustotreatatsymbolsasiftheywerewordcharactersinregex".split("").sort(function(){return.5-Math.random()}).join(""),dash_symbol_token:"thisreplacementtokenallowsustotreatdashesasiftheywerewordcharactersinregex".split("").sort(function(){return.5-Math.random()}).join(""),underscore_symbol_token:"thisreplacementtokenallowsustotreatdashesasiftheywerewordcharactersinregex".split("").sort(function(){return.5-Math.random()}).join(""),swapInAts:function(txt){if(!txt)return txt;return txt.replace(new RegExp(TS.format.at_symbol_token,"g"),"@").replace(new RegExp(TS.format.dash_symbol_token,"g"),"-").replace(new RegExp(TS.format.underscore_symbol_token,"g"),"_")},swapOutAts:function(txt){if(!txt)return txt;return txt.replace(/@/g,TS.format.at_symbol_token).replace(/\-/g,TS.format.dash_symbol_token).replace(/\_/g,TS.format.underscore_symbol_token)},test:function(){return{TSF_token_map:_TSF_token_map}}});var _at_commands=["everyone","channel","group","here"];var _theme_rx=/((?:#[A-Fa-f0-9]{6} {0,1}, {0,1}) {7})(#[A-Fa-f0-9]{6})(\b)/g;var _special_pre_rx=/(^|\s|[_*\?\.,\-!\^;:{(\[%$#+=\u2000-\u206F\u2E00-\u2E7F"])```([\s\S]*?)?```(?=$|\s|[_*\?\.,\-!\^;:})\]%$#+=\u2000-\u206F\u2E00-\u2E7F"])/g;var _special_code_rx=/(^|\s|[\?\.,\-!\^;:{(\[%$#+=\u2000-\u206F\u2E00-\u2E7F"])\`(.*?\S *)?\`/g;var _special_quote_rx=/(^|\n)&gt;(?![\W_](?:&lt;|&gt;|[\|\/\\\[\]{}\(\)Dpb](?=\s|$)))(([^\n]*)(\n&gt;[^\n]*)*)/g;var _TSF_token_map={"<B:START>":'<b>&#8203;<span class="copyonly">&ast;</span>',"<B:END>":'<span class="copyonly">&ast;</span>&#8203;</b>',"<STRIKE:START>":'<strike>&#8203;<span class="copyonly">&tilde;</span>',"<STRIKE:END>":'<span class="copyonly">&tilde;</span>&#8203;</strike>',"<PRE:START>":'<pre class="special_formatting"><span class="copyonly">&#96;&#96;&#96;</span>',"<PRE:END>":'<span class="copyonly">&#96;&#96;&#96;</span></pre>',"<CODE:START>":'<code class="special_formatting"><span class="copyonly">&#96;</span codecopyonly>',"<CODE:END>":'<span class="codecopyonly copyonly">&#96;</span></code>',"<I:START>":'<i>&#8203;<span class="copyonly">&#95;</span>',"<I:END>":'<span class="copyonly">&#95;</span>&#8203;</i>',"<QUOTE:START>":'<div class="special_formatting_quote"><div class="quote_bar"><div class="shim"></div></div><div class="content dynamic_content_max_width">',"<QUOTE:PREFIX>":'<span class="copyonly">&gt;</span>',"<LONGQUOTE:PREFIX>":'<span class="copyonly">&gt;&gt;&gt;</span>',"<QUOTE:END>":"</div></div>","<LINK:END>":"</a>","<LINE:BREAK>":"<br>","<PARA:BREAK>":'<span class="para_break"><i class="copy_only"><br></i></span>',"<SPACE:HARD>":"&nbsp;"};var _emoticon_conversion_token_map=[];var _token_cnt=0;var _token_base="^$-+!?][{}^$-+!?][{}^$-+!?][{}^$-+!?][{}^$-+!?][{}^$-+!?][{}^$-+!?][{}".split("").sort(function(){return.5-Math.random()}).join("");var _emoticonConversionTokenReplacer=function(m){return TS.format.tokenizeStr(_emoticon_conversion_token_map,m)};var _doHighlighting=function(new_txt){var word;var rx;var A=TS.model.highlight_words.concat();A.sort(function compare(a,b){var a_srt=a.length;var b_srt=b.length;if(a_srt<b_srt)return 1;if(a_srt>b_srt)return-1;return 0});var has_ats=false;if(new_txt.indexOf("@")!=-1){has_ats=true;new_txt=TS.format.swapOutAts(new_txt)}for(var i=0;i<A.length;i++){word=A[i];if(has_ats){word=TS.format.swapOutAts(A[i])}word=TS.utility.regexpEscape(word);if(word=="don")word+="(?![']t)";rx=new RegExp("(\\b|_|\\s|^)("+word+")(\\b|_|\\s|$)","ig");var last_good_pos=0;new_txt=new_txt.replace(rx,function(m,$0,$1,$2,offset,str){if(str.substr(0,offset).match(/</)){for(var i=offset;i>=last_good_pos;i--){if(str.charAt(i)=="<"){return $0+$1+$2}if(str.charAt(i)==">"){break}}}last_good_pos=offset+m.length;return $0+'<span class="mention">'+$1+"</span>"+$2})}if(has_ats){return TS.format.swapInAts(new_txt)}else{return new_txt}};var _encodeSpecialFormattingChars=function(txt){txt=txt||"";return txt.replace(/\*/g,"&ast;").replace(/\_/g,"&#95;").replace(/\`/g,"&#96;")};var _encodeSpecialFormattingCharsAndColon=function(txt){txt=txt||"";return _encodeSpecialFormattingChars(txt).replace(/\:/g,"&#58;")};var _calculateOptionsAndFormat=function(txt,msg,opts){var do_inline_imgs=opts&&!!opts.do_inline_imgs||undefined;var for_growl=opts&&!!opts.for_growl||undefined;var for_edit=opts&&!!opts.for_edit||undefined;var no_highlights=opts&&!!opts.no_highlights||undefined;var no_specials=opts&&!!opts.no_specials||undefined;var enable_slack_action_links=opts&&!!opts.enable_slack_action_links||undefined;no_highlights=msg&&"no_highlights"in msg?!!msg.no_highlights:!!no_highlights;if(no_specials===true||no_specials===false){no_specials=no_specials}else if(msg&&"mrkdwn"in msg){no_specials=msg.mrkdwn===false}else{no_specials=false}if(for_edit)no_specials=true;var no_emoji=msg&&msg.no_emoji;var no_hex_colors=!(do_inline_imgs&&(!msg||msg.subtype!="bot_message"));var do_theme_install_buttons=!no_hex_colors&&TS.client&&TS.model.team&&TS.model.team.domain=="tinyspeck";if(!txt||!$.trim(txt)){return""}var tsf_mode="NORMAL";if(no_specials)tsf_mode="NOMRKDWN";if(for_growl)tsf_mode="GROWL";if(for_edit)tsf_mode="EDIT";var new_txt=_format(txt,msg,tsf_mode,no_specials,no_highlights,no_emoji,no_hex_colors,do_inline_imgs,enable_slack_action_links,do_theme_install_buttons);return new_txt};var _format=function(txt,msg,mode,no_specials,no_highlights,no_emoji,no_hex_colors,do_inline_imgs,enable_slack_action_links,do_theme_install_buttons){var map=_TSF_token_map;var html_token_map=[];if(do_theme_install_buttons){txt=txt.replace(_theme_rx,function(m,$1,$2){return $1+TS.format.tokenizeStr(html_token_map,"<nobr>",",")+$2+" "+TS.format.tokenizeStr(html_token_map,_getThemeInstallButtonHtml(m)+"</nobr>")})}var str="";var A=TSF.getTokensArray($.trim(txt),mode);var c;var guts;var item;var i;var id;var m;var partsA;var target;var cmd;var cmd_label;var cmd_A;var cmd_args;var unix_time;var cmd_template;var cmd_url;var anchor_start;var anchor_end;var ug;if(mode=="GROWL"||mode=="EDIT"){for(i=0;i<A.length;i++){item=A[i];if(item.indexOf("<")===0){if(map[item]){TS.error('unexpected: mode == "GROWL" || "EDIT", and yet we got something in the formatting map? '+item)}else if(item.indexOf("<!")===0){guts=item.replace(/<|>/g,"");cmd_A=(guts||"").split("|");cmd=cmd_A[0].substr(1);if(TS.utility.inArray(_at_commands,cmd)){str+="@"+cmd}else{cmd_label=cmd_A[1]?cmd_A[1]:cmd;if(cmd.indexOf("^")!==-1){cmd_args=cmd.split("^");cmd=cmd_args[0];if(cmd==="date"&&cmd_args.length>=3){unix_time=cmd_args[1];cmd_template=cmd_args[2];str+=TS.utility.date.formatDate(cmd_template,unix_time,cmd_label)}else if(TS.boot_data.feature_subteams&&cmd==="subteam"&&cmd_args.length===2){ug=TS.user_groups.getUserGroupsById(cmd_args[1]);if(ug)str+="@"+ug.handle}else{str+="<"+cmd_label+">"}}else{str+="<"+cmd_label+">"}}}else if(item.indexOf("<@")===0){guts=item.replace(/<|>/g,"");m=TS.utility.msgs.getMemberFromMemberMarkup(guts);if(m){str+="@"+m.name}else if(mode=="EDIT"){str+=guts}else if(mode=="GROWL"){str+=item}}else if(item.indexOf("<#")===0){guts=item.replace(/<|>|#/g,"");partsA=guts.split("|");id=partsA[0];c=TS.channels.getChannelById(id);if(c){str+="#"+c.name}else{if(partsA.length>1&&partsA[1]){str+="#"+partsA[1]}else if(TS.model.user.is_restricted){str+="#unknown-channel"}else{str+="#deleted-channel"}}}else if(item.indexOf(TSF.LINK_START.split(" ")[0])===0){TS.error('unexpected: mode == "GROWL" || "EDIT", and yet we got '+item)}else if(item.indexOf(TSF.EMOJI_COLONS.split(" ")[0])===0){TS.error('unexpected: mode == "GROWL" || "EDIT", and yet we got '+item)}else if(item.indexOf(TSF.HEX_BLOCK.split(" ")[0])===0){TS.error('unexpected: mode == "GROWL" || "EDIT", and yet we got '+item)}else{TS.error("markup token not handled:"+item)}}else if(item.indexOf("<")==-1){if(mode=="EDIT"){str+=TS.utility.unHtmlEntities(item)}else if(mode=="GROWL"){if(TS.utility.platformSupportsHtmlNotifications()){if(TS.utility.platformSupportsImgEmojiInHtmlNotifications()){str+=TS.emoji.graphicReplace(item,{force_img:true})}}else{var safe_str=TS.utility.unHtmlEntities(item);safe_str=TS.emoji.maybeUnifiedReplace(safe_str);str+=safe_str}}}else{TS.error("token has a < in it but it is not the first character!\n"+item)}}}else{var attach_html="";var js_url;var display_name;var last_item_was_bot_url;for(i=0;i<A.length;i++){item=A[i];if(item.indexOf("<")===0){if(map[item]){str+=map[item];if(item==TSF.LINK_END){str+=attach_html;attach_html=""}}else if(item.indexOf("<!")===0){guts=item.replace(/<|>/g,"");cmd_A=(guts||"").split("|");cmd=cmd_A[0].substr(1);if(TS.utility.inArray(_at_commands,cmd)){str+='<b class="mention">@'+cmd+"</b>"}else{cmd_label=cmd_A[1]?cmd_A[1]:cmd;if(cmd.indexOf("^")!==-1){cmd_args=cmd.split("^");cmd=cmd_args[0];if(cmd==="date"&&cmd_args.length>=3){unix_time=cmd_args[1];cmd_template=cmd_args[2];cmd_url=cmd_args.length>3?cmd_args[3]:"";anchor_start=cmd_url===""?"":"<a "+TS.utility.makeRefererSafeLink(cmd_url)+' target="_blank">';anchor_end=cmd_url===""?"":_TSF_token_map["<LINK:END>"];str+=anchor_start+TS.utility.date.formatDate(cmd_template,unix_time,cmd_label)+anchor_end}else if(TS.boot_data.feature_subteams&&cmd==="subteam"&&cmd_args.length===2){ug=TS.user_groups.getUserGroupsById(cmd_args[1]);if(ug&&ug.handle){target=TS.utility.shouldLinksHaveTargets()?'target="/usergroups/'+ug.id+'" ':" ";var handle=TS.utility.htmlEntities(ug.handle);display_name=no_highlights?"@"+handle:_doHighlighting("@"+handle);str+='<a href="/usergroups/'+ug.id+'" '+target+'data-user-group-id="'+ug.id+'" class="internal_user_group_link">'+display_name+_TSF_token_map["<LINK:END>"]}else{str+=cmd_label}}else{str+="&lt;"+cmd_label+"&gt;"}}else{str+="&lt;"+cmd_label+"&gt;"}}}else if(item.indexOf("<@")===0){guts=item.replace(/<|>/g,"");m=TS.utility.msgs.getMemberFromMemberMarkup(guts);if(m){if(TS.members.canUserSeeMember(m)){target=TS.utility.shouldLinksHaveTargets()?'target="/team/'+m.name+'" ':" ";display_name=no_highlights?"@"+m.name:_doHighlighting("@"+m.name);str+='<a href="/team/'+m.name+'" '+target+'data-member-name="'+m.name+'" class="internal_member_link">'+display_name+_TSF_token_map["<LINK:END>"]}else{str+="@"+m.name}}else{str+=guts}}else if(item.indexOf("<#")===0){guts=item.replace(/<|>|#/g,"");partsA=guts.split("|");id=partsA[0];c=TS.channels.getChannelById(id);if(c){target=TS.utility.shouldLinksHaveTargets()?'target="/archives/'+c.name+'"':"";str+='<a href="/archives/'+c.name+'" '+target+' data-channel-name="'+c.name+'" data-channel-id="'+c.id+'" class="internal_channel_link">#'+c.name+_TSF_token_map["<LINK:END>"]}else{if(partsA.length>1&&partsA[1]){str+="#"+partsA[1]}else if(TS.model.user.is_restricted){str+="#unknown-channel"}else{str+="#deleted-channel"}}}else if(item.indexOf(TSF.LINK_START.split(" ")[0])===0){var url=function(item){var temp=$.trim(item.replace(TSF.LINK_START.split(" ")[0],""));return temp.substr(0,temp.length-1)}(item);var bot_id;var bot;if((bot_id=TS.utility.getBotIDFromURL(url))&&(bot=TS.bots.getBotById(bot_id))){last_item_was_bot_url=true;target=TS.utility.shouldLinksHaveTargets()?'target="'+url+'" ':"";display_name=no_highlights?bot.name:_doHighlighting(bot.name);if(A[i+1]&&A[i+1]==url)display_name=url;display_name=display_name.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");str+='<a href="'+url+'" '+target+'data-bot-id="'+bot_id+'" class="internal_bot_link">'+display_name}else if(url.indexOf(TS.utility.msgs.api_url_prefix+"chat.help")===0){if(enable_slack_action_links){js_url=TS.utility.htmlEntities(TS.utility.jsString(url));str+='<a onclick="TS.utility.msgs.doApiUrl('+js_url+')" class="api_url">'}else{str+='<a class="api_url muted">(Disabled) '}}else if(url.indexOf(TS.utility.msgs.new_api_url_prefix)===0){if(enable_slack_action_links){js_url=TS.utility.htmlEntities(TS.utility.jsString(url));str+='<a onclick="TS.utility.msgs.doNewApiUrl('+js_url+')" class="api_url">'}else{str+='<a class="api_url muted">(Disabled) '}}else if(url.indexOf("javascript:")===0){str+='<a onclick="TS.client.msg_pane.maybeClick(this)" data-maybe-click="'+url.replace("javascript:","")+'">'}else if(TS.client&&TS.client.core_url&&url.indexOf(TS.client.core_url)===0){str+='<a target="_self" href="'+url+'">'}else{var file_id=TS.utility.getFileIDFromURL(url);var css_class=file_id?' class="file_preview_link"':"";var data_file_id=file_id?' data-file-id="'+file_id+'"':"";str+="<a "+TS.utility.makeRefererSafeLink(url)+' target="_blank"'+css_class+data_file_id+">";if(attach_html){TS.error("WTF we should have no attach_html")}attach_html="";var attachment;if(msg&&msg.ts&&do_inline_imgs){attachment=TS.inline_attachments.getAttachmentByFromUrl(msg.attachments,url);if(attachment){if(TS.boot_data.feature_attachments_inline||TS.templates.builders.shouldDoSimpleAttachment(attachment,msg)){attach_html=TS.templates.builders.buildAttachmentHTML({attachment:attachment,url:url,msg:msg,show_initial_caret:true})}}}}}else if(item.indexOf(TSF.EMOJI_COLONS.split(" ")[0])===0){var colons=item.split(" ")[1].replace(">","");if(!no_emoji){var emoji_str=TS.emoji.graphicReplace(colons,{obey_emoji_mode_pref:true,include_title:true,include_text:true});if(emoji_str==colons){if(no_highlights){str+=colons}else{str+=_doHighlighting(colons)}}else{str+=TS.emoji.graphicReplace(colons,{obey_emoji_mode_pref:true,include_title:true,include_text:true})}}else{str+=colons}}else if(item.indexOf(TSF.HEX_BLOCK.split(" ")[0])===0){var hex=item.split(" ")[1].replace(">","");if(!no_hex_colors){str+=' <div class="inline_color_block" style="background:'+hex+';"></div>'}}else{TS.error("markup token not handled:"+item)}}else if(item.indexOf("<")==-1){if(last_item_was_bot_url){last_item_was_bot_url=false}else{if(no_highlights){str+=item}else{str+=_doHighlighting(item)}}}else{TS.error("token has a < in it but it is not the first character!\n"+item)}}}if((TS.boot_data.feature_screenhero||TS.boot_data.feature_calls)&&msg&&(msg.subtype==="sh_room_created"||msg.subtype==="sh_room_shared")){var from_name=TS.ui.growls.extractFromNameFromCorGMessage(msg);if(from_name)from_name=from_name+": ";str=msg.subtype==="sh_room_created"?from_name+"Started a call":from_name+"Shared a call"}str=TS.format.deTokenizeStr(html_token_map,str);return str};var _getThemeInstallButtonHtml=function(theme,name){name=name?" to "+name:"";return'<a data-theme="'+TS.utility.htmlEntities(theme)+'" class="btn btn_small tiny_right_margin theme_installer_btn" style="padding: 0px 7px 1px;"><i class="ts_icon ts_icon_cog align_middle"></i> Switch'+name+"</a>"}})();(function(){"use strict";TS.registerModule("emoji_menu",{active_emoji_group:null,is_showing:false,is_dirty:true,onStart:function(){if(TS.boot_data.page_needs_emoji_menu){if(TS.web)TS.web.login_sig.add(_waitAndBuild);if(TS.client)TS.client.login_sig.add(_waitAndBuild)}TS.prefs.emoji_mode_changed_sig.add(function(){_updateSkinButton()});TS.prefs.show_all_skin_tones_changed_sig.add(_skinTonePrefChanged);TS.prefs.preferred_skin_tone_changed_sig.add(_skinTonePrefChanged)},startEmoForRxn:function(e,rxn_key){var $trigger=$(e&&e.target);var closed=_closeIfNeeded($trigger,function(){TS.emoji_menu.startEmoForRxn(e,rxn_key)});if(closed)return;_rxn_key=rxn_key;if(!_rxn_key){_rxn_key=null;TS.error("no _rxn_key for rxn_key:"+rxn_key)}var callback=function(name){var adding=!TS.rxns.doesRxnsHaveRxnFromUser(TS.rxns.getExistingRxnsByKey(rxn_key),name);TS.rxns.changeRxnsFromUserAction(rxn_key,name,adding)};_$trigger=$trigger;_$trigger.closest(".menu_rxn").addClass("active");_$trigger.closest(".rxn_panel").addClass("active");_$trigger.closest("ts-message").addClass("active");_$trigger.addClass("active");_start(e,null,callback)},startEmo:function(e,input_selector,callback){var $trigger=$(e&&e.target);var closed=_closeIfNeeded($trigger,function(){TS.emoji_menu.startEmo(e,input_selector,callback)});if(closed)return;_$trigger=$trigger;_$trigger.closest("a.emo_menu").addClass("active");_start(e,input_selector,callback)},setDirtyAndMaybeRender:function(){TS.emoji_menu.is_dirty=true;if(TS.emoji_menu.is_showing)return;if(!_is_built){_build();return}_render()}});var _default_emoji_group="grinning";var _input_selector="#message-input";var _input_selector_default="#message-input";var _first_load=true;var _in_search_mode=false;var _in_key_mode=false;var _key_mode_mouse_tracker;var _key_mode_last_el_over;var _$key_nav_els=null;var _key_nav_index=-1;var _scroll_tim=0;var _one_search_result=null;var _emoji_menu_appended=false;var _emoji_events_assigned=false;var _rxn_key=null;var _default_emo=":smile:";var _$trigger;var _$parent=TS.client?$("#client-ui"):$("body");var _$menu;var _$header;var _$items_div;var _$emoji_div_default_rxns;var _$footer;var _$input;var _$emoji_preview_img;var _$emoji_name;var _$emoji_aliases;var _$headers;var _$uls;var _$lis;var _$emoji_search_results_h3;var _$emoji_zero_results;var _$emoji_tip;var _$emoji_skin_picker;var _$emoji_skin_button;var _$emoji_skin_tip;var _$scroller;var _name_to_li_map;var _cached_scroller_rect;var _reusable_top_scroller_rect={right:0,left:0};var _reusable_header_rect={right:0,left:0};var _header_ranges;var _header_ranges_map;var _callback;var _height_caches={normal:0,rxns:0};var _rect_caches={normal:null,rxns:null};var _getWrecked=function(for_rxns){var which_rect=for_rxns?"rxns":"normal";var rect=_rect_caches[which_rect]=_rect_caches[which_rect]||_$menu.dimensions_rect();rect.right=rect.left+rect.width;rect.bottom=rect.top+rect.height;return rect};var _getOuterHeight=function(for_rxns){var which_height=for_rxns?"rxns":"normal";_height_caches[which_height]=_height_caches[which_height]||_$menu.outerHeight();return _height_caches[which_height]};var _waitAndBuild=function(){setTimeout(function(){if(!_is_built)_build()},5e3)};var _is_built=false;var _build=function(){_is_built=true;var default_rxns={};TS.model.default_rxns.forEach(function(name){default_rxns[name]={html:TS.emoji.graphicReplace(":"+name+":"),name:":"+name+":",names:":"+name+":"}});_$parent.append(TS.templates.emoji_menu({default_rxns:default_rxns}));_$menu=$("#emoji_menu");TS.emoji_menu.$menu=_$menu;_$scroller=_$menu.find("#emoji_menu_items_scroller");var debug=TS.qs_args["debug_scroll"]=="1";_$scroller.monkeyScroll({debug:debug});_default_emo="";_default_emoji_group="mine";_$scroller.bind("scroll",_onScroll);_$header=_$menu.find("#emoji_menu_header");_$items_div=_$menu.find("#emoji_menu_items_div");_$emoji_div_default_rxns=_$menu.find("#emoji_div_default_rxns");_$footer=_$menu.find("#emoji_menu_footer");_$emoji_preview_img=$("#emoji_preview_img");_$emoji_name=$("#emoji_name");_$emoji_aliases=$("#emoji_aliases");_$emoji_skin_button=$("#emoji_skin_button");_$emoji_skin_tip=$("#emoji_skin_tip");_$emoji_skin_picker=$("#emoji_skin_picker");
_$emoji_skin_tip.removeClass("hidden");_updateSkinButton();_$emoji_skin_button.removeClass("hidden").on("click",function(){_startSkinPicker()});_updateSkinPicker();_$emoji_skin_picker.removeClass("hidden").on("click",">span",function(e){_endSkinPicker();var val=$(e.currentTarget).attr("skin-tone")||"1";if(val=="all"){TS.prefs.onPrefChanged({name:"show_all_skin_tones",value:true});TS.prefs.setPrefByAPI({name:"show_all_skin_tones",value:true})}else{TS.prefs.onPrefChanged({name:"preferred_skin_tone",value:val});TS.prefs.setPrefByAPI({name:"preferred_skin_tone",value:val});if(_doShowAllSkinTones()){TS.prefs.onPrefChanged({name:"show_all_skin_tones",value:false});TS.prefs.setPrefByAPI({name:"show_all_skin_tones",value:false})}}if(_in_search_mode)_onInputTextchange()});_updateSkinClass();_render();_$menu.detach()};var _start=function(e,input_selector,callback){if(!_is_built){_build()}if(input_selector)_input_selector=input_selector;if(TS.client&&TS.client.ui.$msg_input.prop("disabled")&&input_selector!==null){var replies_enabled=TS.replies&&TS.replies.isEnabled();var triggered_from_inline_reply=replies_enabled&&$(input_selector).closest("ts-conversation").length>0;if(!triggered_from_inline_reply){return}}_callback=callback;var mark_label="start_emoji_menu_open";TS.timing.mark(mark_label);TS.emoji_menu.active_emoji_group=TS.emoji_menu.active_emoji_group||_default_emoji_group;if(TS.emoji_menu.is_dirty){TS.info("TS.emoji_menu.is_dirty = true");_render()}_updateFooter(_default_emo);if(!_emoji_menu_appended){_$menu.appendTo(_$parent);_emoji_menu_appended=true}_$emoji_div_default_rxns.toggleClass("hidden",!_isOpenForRxn());var offset;var x,y;if(_$trigger&&(_$trigger.hasClass("ts_icon_add_reaction")||_$trigger.hasClass("add_rxn_menu_item"))){offset={top:e.clientY-20,left:e.clientX-20}}else if(_$trigger&&_$trigger.closest("#message-form").length){offset={top:window.innerHeight-(TS.view.last_input_container_height+25),left:284};if(_$trigger.hasClass("ts_icon_happy_smile")){if(TS.model.ui_state.flex_visible){offset.left+=TS.view.last_msgs_div_width-132}else{offset.left+=TS.view.last_msgs_div_width-452}}}else{offset=_$trigger.offset()}if(offset){x=parseInt(offset.left-8);y=parseInt(offset.top-(_getOuterHeight(_isOpenForRxn())+6))}TS.emoji_menu.is_showing=true;_endSearchMode();_endKeyMode();_$menu.css({top:y,left:x});_$menu.css("opacity",1);if(TS.ui.fs_modal_file_viewer&&TS.ui.fs_modal_file_viewer.is_showing||TS.boot_data.feature_popover_dismiss_only){_$menu.addClass("fsfv_open")}else{_$menu.removeClass("fsfv_open")}var rect=_getWrecked(_isOpenForRxn());rect.top=y;rect.left=x;_keepInBounds();if(TS.view){TS.view.resize_sig.add(_keepInBounds)}else{$(window).bind("resize",_keepInBounds)}$(window.document).bind("keydown",_onKeyDown);$("html").bind("mousedown",_onMouseDown);TS.timing.measure("emoji_menu_open",mark_label);if(_first_load){TS.timing.measure("emoji_menu_first_open",mark_label);_first_load=false}TS.tips.hideAll();setTimeout(_resetScrollCrap,20)};var _resetScrollCrap=function(){_$scroller.scrollTop(0);_$scroller.data("monkeyScroll").updateFunc();_cached_scroller_rect=_$scroller.dimensions_rect();_reusable_top_scroller_rect.top=0;_reusable_top_scroller_rect.bottom=_cached_scroller_rect.height*.4;_calcHeaderRanges();if(!TS.model.supports_sticky_position){$("#emoji_h3_"+TS.emoji_menu.active_emoji_group).scrollintoview({offset:"top",px_offset:0,duration:0})}_$input.focus();_resetTab(true)};var _startKeyMode=function(key,from_input){if(_in_key_mode)return;_in_key_mode=true;_$menu.addClass("key_mode");_$input.blur();_$key_nav_els=_$lis.filter(":visible");if(!from_input&&_key_mode_last_el_over&&_$key_nav_els.index(_key_mode_last_el_over)>-1){_setKeySelectionIndex(_$key_nav_els.index(_key_mode_last_el_over));_changeKeyModeSelectionLiByArrow(key)}else{_animateScroll(0);_setKeySelectionIndex(0)}$("body").bind("mousedown.emoji_key_mode",function(){_endKeyMode()});_$scroller.bind("mousemove.emoji_key_mode",function(e){if(!_key_mode_mouse_tracker){_key_mode_mouse_tracker={x:e.pageX,y:e.pageY};return}if(Math.abs(e.pageX-_key_mode_mouse_tracker.x)>1||Math.abs(e.pageY-_key_mode_mouse_tracker.y)>1){_endKeyMode()}});_$emoji_div_default_rxns.bind("mousemove.emoji_key_mode",function(e){_endKeyMode()})};var _changeKeyModeSelectionLiByArrow=function(key){if(_$key_nav_els.length==1)return;var keymap=TS.utility.keymap;var $li=_$key_nav_els.eq(_key_nav_index);var new_index;if(_$key_nav_els.length<=TS.model.emoji_menu_columns){if(key==keymap.up)key=keymap.left;if(key==keymap.down)key=keymap.right}if(key==keymap.up||key==keymap.down){if(key==keymap.up){new_index=_key_nav_index-TS.model.emoji_menu_columns}else{new_index=_key_nav_index+TS.model.emoji_menu_columns}if(_in_search_mode){if(new_index>=_$key_nav_els.length){var row_count=Math.ceil(_$key_nav_els.length/TS.model.emoji_menu_columns);var row_index=Math.ceil((_$key_nav_els.index($li)+1)/TS.model.emoji_menu_columns)-1;if(row_count==row_index+1){new_index=0}else{new_index=_$key_nav_els.length-1}}}else{var col=$li.data("col");var row=$li.data("row");var new_row_index=key==keymap.up?row-1:row+1;var $new_row=_$key_nav_els.filter('[data-row="'+new_row_index+'"]');var $new_li=$new_row.filter('[data-col="'+col+'"]');if($new_li.length){new_index=_$key_nav_els.index($new_li)}else{new_index=_$key_nav_els.index($new_row.last())}}}else if(key==keymap.right){new_index=_key_nav_index+1}else if(key==keymap.left){new_index=_key_nav_index-1}else{TS.error("invalid key passed to _changeKeyModeSelectionLiByArrow:"+key);return}if((key==keymap.up||key==keymap.left)&&new_index<0){new_index=_$key_nav_els.length-1}else if((key==keymap.down||key==keymap.right)&&(new_index==-1||new_index>=_$key_nav_els.length)){new_index=0}_setKeySelectionIndex(new_index)};var _setKeySelectionIndex=function(new_index){var last_key_nav_index=_key_nav_index;if(last_key_nav_index>-1){_$key_nav_els.eq(last_key_nav_index).removeClass("key_selection")}_key_nav_index=new_index;var $new_li=_$key_nav_els.eq(_key_nav_index);var $a=$new_li.find("a");_swapHighlightClass($a);_updateFooter($a.data("name"),$a.data("names"));$new_li.addClass("key_selection").scrollintoview({offset:_key_nav_index<last_key_nav_index?"top":"bottom",px_offset:_key_nav_index<last_key_nav_index?26:-6,duration:100})};var _endKeyMode=function(){if(!_in_key_mode)return;_in_key_mode=false;_key_mode_mouse_tracker=null;_$menu.removeClass("key_mode");_$key_nav_els.removeClass("key_selection");_key_nav_index=-1;$("body").unbind("mousedown.emoji_key_mode");_$scroller.unbind("mousemove.emoji_key_mode");_$emoji_div_default_rxns.unbind("mousemove.emoji_key_mode")};var _startSearchMode=function(){if(_in_search_mode)return;_in_search_mode=true;_endKeyMode();_$headers.addClass("hidden");_$emoji_search_results_h3.removeClass("hidden");_$uls.css("display","inline");$(".emoji_section_div").css("display","inline");_$emoji_tip.addClass("hidden");_$emoji_zero_results.addClass("hidden")};var _endSearchMode=function(){if(!_in_search_mode)return;_in_search_mode=false;_one_search_result=null;_$headers.removeClass("hidden");_$emoji_search_results_h3.addClass("hidden");_$uls.css("display","block");$(".emoji_section_div").css("display","block");_$emoji_tip.removeClass("hidden");_$emoji_zero_results.addClass("hidden");_$input.val("");_$lis.removeClass("hidden");_$scroller.scrollTop(0);_$scroller.data("monkeyScroll").updateFunc();_calcHeaderRanges()};var _calcHeaderRanges=function(){_header_ranges=[];_header_ranges_map={};var range;var next_range;var group_name;var index=-1;_$headers.each(function(i,h3){var $h3=$(h3);group_name=$h3.data("group-name");if(!TS.model.supports_sticky_position){$h3.css("top",0)}if($h3.hasClass("hidden"))return;index++;_header_ranges_map[group_name]=_header_ranges[index]={index:index,$el:$h3,id:$h3.attr("id"),group_name:group_name,rect:$h3.dimensions_rect(),vis:{top:0,bottom:0,max_top:0,set_top:0}}});for(var i=0;i<_header_ranges.length;i++){range=_header_ranges[i];next_range=_header_ranges[i+1];range.vis.top=range.rect.top-_cached_scroller_rect.top;range.vis.bottom=next_range?next_range.rect.top-_cached_scroller_rect.top:1e11;range.vis.max_top=range.vis.bottom-range.vis.top-range.rect.height;delete range.rect}};var _addRowAndColToLis=function(){var col=0;var row=0;var $li;_$lis.each(function(i,li){$li=$(li);$li.attr("data-col",col);$li.attr("data-row",row);if(!_doShowAllSkinTones()){if($li.hasClass("skin_tone")&&!$li.hasClass("skin_tone_6")){return}}if(col+1==TS.model.emoji_menu_columns||$li[0]==$li.parent().find("li").last()[0]){row++;col=0}else{col++}})};var _render=function(){TS.emoji_menu.is_dirty=false;_$header.html(TS.templates.emoji_header({emoji_groups:TS.model.emoji_groups,active_group:TS.emoji_menu.active_emoji_group}));var html=TS.templates.menu_emoticons({emoji_groups:TS.model.emoji_groups,active_group:TS.emoji_menu.active_emoji_group});if(!TS.model.user.is_restricted){if(!TS.model.team.prefs.emoji_only_admins||TS.model.user.is_admin){html+='<i class="ts_icon ts_icon_plus ts_icon_inherit"></i> &nbsp;You can <a href="/admin/emoji" target="_blank">add custom emoji here</a>'}}html+="</div>";_$items_div.html(html);_$input=_$items_div.find("#emoji_input");_$input.bind("textchange",_onInputTextchange);_$headers=_$items_div.find("h3");_$uls=_$items_div.find("ul");_$lis=_$uls.find("li");_addRowAndColToLis();_$emoji_search_results_h3=_$items_div.find("#emoji_search_results_h3");_$emoji_zero_results=_$items_div.find("#emoji_zero_results");_$emoji_tip=_$items_div.find("#emoji_tip");_name_to_li_map={};var $search_lis=_$items_div.find("ul:not(#emoji_ul_mine)").find("li");$search_lis.each(function(index,li){var $li=$(li);var names=$li.data("names");if(!names)return;var namesA=names.split(" ");var name;for(var i=0;i<namesA.length;i++){name=TS.emoji.stripWrappingColons(namesA[i]);if(!_name_to_li_map.hasOwnProperty(name)){_name_to_li_map[name]={$li:$li,names:$li.data("names")}}}});if(TS.emoji_menu.is_showing){_calcHeaderRanges()}if(!_emoji_events_assigned){_emoji_events_assigned=true;_$items_div.on("click.emoji_menu",".emoji_ul a",_onEmoClick);_$items_div.on("mouseenter",".emoji_ul a",_onMouseEnterA);_$items_div.on("mouseleave",".emoji_ul a",_onMouseLeaveA);_$emoji_div_default_rxns.on("click.emoji_menu",".emoji_ul a",_onEmoClick);_$emoji_div_default_rxns.on("mouseenter",".emoji_ul a",_onMouseEnterA);_$emoji_div_default_rxns.on("mouseleave",".emoji_ul a",_onMouseLeaveA);_$header.on("click.emoji_menu","a.emoji_grouping_tab",_onHeaderClick)}_$emoji_div_default_rxns.removeClass("hidden");_getWrecked(true);_getOuterHeight(true);_$emoji_div_default_rxns.addClass("hidden");_getWrecked(false);_getOuterHeight(false)};var _onScroll=function(e){if(!TS.model.supports_sticky_position){_getActiveGroupAndMaybePositionHeaders()}clearTimeout(_scroll_tim);_scroll_tim=setTimeout(_resetTab,50)};var _resetTab=function(force){var active_emoji_group=_getActiveGroupAndMaybePositionHeaders();if(force||active_emoji_group!=TS.emoji_menu.active_emoji_group){TS.emoji_menu.active_emoji_group=active_emoji_group;$(".emoji_grouping_tab").removeClass("active");$('.emoji_grouping_tab[data-group-name="'+TS.emoji_menu.active_emoji_group+'"]').addClass("active")}};var _getActiveGroupAndMaybePositionHeaders=function(){var sc=_$scroller.scrollTop();var range;var active_emoji_group;for(var i=0;i<_header_ranges.length;i++){range=_header_ranges[i];if(sc+i===0)active_emoji_group=range.group_name;if(sc>=range.vis.top&&sc<=range.vis.bottom){active_emoji_group=range.group_name;if(!TS.model.supports_sticky_position){range.set_top=Math.min(sc-range.vis.top,range.vis.max_top);range.$el.css("top",range.set_top)}}else if(range.set_top&&!TS.model.supports_sticky_position){range.set_top=0;range.$el.css("top",range.set_top)}_reusable_header_rect.top=range.vis.top-sc;_reusable_header_rect.bottom=_reusable_header_rect.top+25;if(sc>0&&TS.utility.doesRectContainRect(_reusable_top_scroller_rect,_reusable_header_rect,0,true)){active_emoji_group=range.group_name}else if(parseInt(_$scroller.css("height"))+sc+40>=_$scroller[0].scrollHeight){active_emoji_group=_header_ranges[_header_ranges.length-1].group_name}}return active_emoji_group};var _onInputTextchange=function(e,prev_txt){var val=$.trim(_$input.val());var start=Date.now();TS.log(96,"--- _onInputTextchange ---");if(!val){_endSearchMode();return}_startSearchMode();TS.log(96,"after _startSearchMode "+(Date.now()-start));_$lis.addClass("hidden");TS.log(96,"after hiding all "+(Date.now()-start));var terms=val.split(" ");var term;var matches=[];var preview_emoji;var preview_names;var name;var name_for_matching;var rx;var rx_str;var i;names_loop:for(var m=0;m<TS.model.emoji_names.length;m++){name=TS.model.emoji_names[m];name_for_matching=name.replace(/(\:skin-tone-[2-6])/,"");if(!_doShowAllSkinTones()){name=name_for_matching}for(i=0;i<terms.length;i++){term=terms[i];if(term.substr(0,1)==":"){rx_str="^"+TS.utility.regexpEscape(TS.emoji.stripWrappingColons(term));if(term.length>1&&term.substr(-1,1)==":"){rx_str+="$"}}else{rx_str=TS.utility.regexpEscape(term)}rx=new RegExp(rx_str,"i");if(rx.test(name_for_matching)){matches[matches.length]=name;continue names_loop}}}TS.log(96,"after regex "+(Date.now()-start));if(TS.boot_data.feature_emoji_keywords){for(i=0;i<terms.length;i++){term=terms[i];if(term.substr(0,1)!=":"){TS.emoji.findByKeyword(terms[i]).forEach(function(name){TS.utility.ensureInArray(matches,name)})}}}var item;var one_shown=false;var two_plus_shown=false;for(name in _name_to_li_map){if(matches.indexOf(name)===-1)continue;if(!_doShowAllSkinTones()&&TS.emoji.isNameSkinToneModifiable(name)){var tone=TS.emoji.getChosenSkinTone();if(tone)name+="::"+tone}item=_name_to_li_map[name];if(!item){TS.error(name);continue}two_plus_shown=one_shown;one_shown=true;preview_emoji=":"+name+":";preview_names=item.names;item.$li.removeClass("hidden")}TS.log(96,"after show/hide "+(Date.now()-start));if(!TS.model.supports_sticky_position){_$emoji_search_results_h3.css("top",0);TS.log(96," after _$emoji_search_results_h3.css "+(Date.now()-start))}_$emoji_zero_results.toggleClass("hidden",one_shown);TS.log(96," after emoji_zero_results.toggleClass "+(Date.now()-start));if(_$scroller[0]["scrollTop"])_$scroller[0]["scrollTop"]=0;TS.log(96,"after scroller[0].scrollTop = 0 "+(Date.now()-start));_calcHeaderRanges();TS.log(96,"after _calcHeaderRanges "+(Date.now()-start));setTimeout(_$scroller.data("monkeyScroll").updateFunc,0);_one_search_result=null;if(two_plus_shown){preview_names=preview_emoji=_default_emo}else if(one_shown){_one_search_result=preview_emoji;preview_emoji=preview_emoji;preview_names=preview_names}else{preview_names=preview_emoji=":cry:"}_updateFooter(preview_emoji,preview_names);TS.log(96,"end "+(Date.now()-start))};var _updateFooter=function(colon_name,colon_names){if(colon_name){_$footer.addClass("previewing");_$emoji_preview_img.html(TS.emoji.graphicReplace(colon_name));_$emoji_name.html(TS.emoji.stripWrappingColons(colon_name.replace(/(\:\:skin-tone-[2-6]\:)/g,":")));_$emoji_aliases.html((colon_names||"").replace(/(\:\:skin-tone-[2-6]\:)/g,":").replace(/\: /g,":&nbsp;&nbsp;"))}else{_$footer.removeClass("previewing")}};var _selectionMade=function(emo,e){if(!TS.emoji_menu.is_showing){return}if(_callback){setTimeout(_callback,0,emo);if(!e||!e.shiftKey)_end();return}if(!_input_selector){TS.error("WTF no _input_selector?");return}var current_pos=TS.utility.getCursorPosition(_input_selector).start;var new_pos=current_pos+emo.length;var current_val=$(_input_selector).val();var new_val=current_val.substr(0,current_pos)+emo+current_val.substr(current_pos);$(_input_selector).val(new_val).trigger("autosize").trigger("autosize-resize").trigger("textchange");if(!e||!e.shiftKey){setTimeout(TS.utility.setCursorPosition,0,_input_selector,new_pos);_end()}};var _onKeyDown=function(e){var keymap=TS.utility.keymap;if(_in_key_mode){if(TS.utility.isArrowKey(e.which)){_changeKeyModeSelectionLiByArrow(e.which);e.preventDefault();return}if(e.which==keymap.shift||e.which==keymap.alt||e.which==keymap.ctrl||e.which==keymap.cmd_ff||e.which==keymap.cmd_other||e.which==keymap.cmd_right){return}if(e.which==keymap.esc){e.preventDefault();_endKeyMode();_end();return}if(e.which==keymap.enter){_selectionMade(_$key_nav_els.eq(_key_nav_index).find("a").data("name"),e);e.preventDefault();e.stopPropagation();return}_endKeyMode()}var focus_is_on_an_input=TS.utility.isFocusOnInput();var focus_is_on_our_input=focus_is_on_an_input&&_$input[0]===document.activeElement;var focus_is_on_other_input=focus_is_on_an_input&&!focus_is_on_our_input;if(focus_is_on_other_input){if(e.which==keymap.enter){_end();return}else if(e.which==keymap.semicolon&&e.shiftKey){_end();return}}else{if(focus_is_on_our_input){if(e.which==keymap.down){var cp=_$input.getCursorPosition();var tl=_$input.val().length;if(cp==tl){_startKeyMode(e.which,true);e.preventDefault();return}}if(!_$input.val()&&TS.utility.isArrowKey(e.which)){_startKeyMode(e.which);e.preventDefault()}}if(TS.utility.isArrowKey(e.which)){_startKeyMode(e.which);e.preventDefault();return}}if(focus_is_on_our_input){if(e.which==keymap.enter){if(_in_search_mode&&_one_search_result){_selectionMade(_one_search_result,e);e.preventDefault();e.stopPropagation()}return}}if(e.which==keymap.esc||e.which==keymap.tab||e.which==keymap.enter&&!e.shiftKey){_end();e.preventDefault();return}if(!focus_is_on_an_input&&(!TS.client||TS.client.ui.isUserAttentionOnChat())&&!TS.utility.isArrowKey(e.which)&&!TS.utility.isPageKey(e.which)&&!e.metaKey&&!e.ctrlKey&&!e.altKey&&e.which!=keymap.shift){_$input.focus()}};var _keepInBounds=function(){var allowance_v=10;var allowance_h=18;var rect;var top;if(TS.web){rect=_$menu.dimensions_rect();top=_$menu.offset().top}else{rect=_getWrecked(_isOpenForRxn());top=rect.top}var allow_rect={top:0+allowance_v,right:window.innerWidth-allowance_h,bottom:window.innerHeight-(allowance_v+14),left:0+allowance_h};var all_good=TS.utility.doesRectContainRect(allow_rect,rect);if(all_good)return;if(rect.left<allow_rect.left){rect.left=parseInt(allow_rect.left);_$menu.css("left",rect.left)}else if(rect.right>allow_rect.right){rect.left=parseInt(Math.max(allow_rect.left,allow_rect.right-rect.width));_$menu.css("left",rect.left)}if(rect.top<allow_rect.top){rect.top=parseInt(top+(allow_rect.top-rect.top));_$menu.css("top",rect.top)}else if(rect.bottom>allow_rect.bottom){var diff=rect.bottom-Math.max(allow_rect.top,allow_rect.bottom-rect.width);rect.top=parseInt(top-diff);_$menu.css("top",rect.top)}};var _isOpenForRxn=function(){return!!_rxn_key};var _end=function(callback){TS.emoji_menu.is_showing=false;_rxn_key=null;_$scroller.scrollTop(0);_getActiveGroupAndMaybePositionHeaders();_resetTab();_resetScrollCrap();TS.tips.unhideAll();_endSkinPicker();_$menu.stop().transition({opacity:0},150,function(){_$menu.detach();_emoji_menu_appended=false;_endSearchMode();_endKeyMode();if(callback)callback()});_$input.blur();_callback=null;_$trigger.closest("a.emo_menu, .menu_rxn, .rxn_panel").removeClass("active");_$trigger.closest("ts-message").removeClass("active");_$trigger.removeClass("active");_input_selector=_input_selector_default;if(TS.view){TS.view.resize_sig.remove(_keepInBounds)}else{$(window).unbind("resize",_keepInBounds)}$(window.document).unbind("keydown",_onKeyDown);$("html").unbind("mousedown",_onMouseDown);_$trigger=null};var _onMouseDown=function(e){var $target=$(e.target);var isClickOnEmojiMenuAffordance=function(){if($target.closest(".emo_menu").length!==0)return true;if($target.closest(".menu_rxn").length!==0)return true;if($target.closest('[data-action="reaction"]').length!==0)return true;return false};if($target.closest("#emoji_menu").length===0&&!isClickOnEmojiMenuAffordance()||$target.hasClass("popover_mask")){_end()}else if($target.closest("#emoji_skin_picker").length===0){_endSkinPicker()}};var _onEmoClick=function(e){var emo=$(this).data("icon");_selectionMade(emo,e)};var _onMouseLeaveA=function(e){_key_mode_last_el_over=null;_updateFooter()};var _onMouseEnterA=function(e){var $a=$(this);var name=$a.data("name");var names=$a.data("names");_swapHighlightClass($a);_key_mode_last_el_over=$a.parent();_endSkinPicker();_updateFooter(name,names)};var _swapHighlightClass=function($el){$el.removeClass(_highlight_classes.join(" "));var highlight_class;while(!highlight_class||highlight_class==_last_highlight_class){highlight_class=TS.utility.randomFromArray(_highlight_classes)}$el.addClass(highlight_class);_last_highlight_class=highlight_class};var _onHeaderClick=function(e){_activateTab($(this))};var _activateTab=function($tab){TS.emoji_menu.active_emoji_group=$tab.data("group-name");if(TS.emoji_menu.is_dirty){_render()}else{_endSearchMode()}var range=_header_ranges_map[TS.emoji_menu.active_emoji_group];if(range){var dest=range.index===0?0:range.vis.top;_animateScroll(dest)}$(".emoji_grouping_tab").removeClass("active");$tab.addClass("active")};var _animateScroll=function(dest){var diff=Math.abs(dest-_$scroller.scrollTop());var d=50*(diff/300);_$scroller.stop().animate({scrollTop:dest},d)};var _closeIfNeeded=function($trigger,reopener){if(TS.emoji_menu.is_showing){if(_$trigger&&_$trigger[0]===$trigger[0]){reopener=null}_end(reopener);return true}return false};var _last_highlight_class;var _highlight_classes=["green","yellow","blue","pink"];var _startSkinPicker=function(){_updateSkinPicker();_$emoji_skin_picker.addClass("shown");_$emoji_skin_tip.addClass("shown")};var _endSkinPicker=function(){_$emoji_skin_picker.removeClass("shown");_$emoji_skin_tip.removeClass("shown")};var _skin_picker_base=":hand:";var _skin_picker_choices=function(){return[{id:"all",colons:":rainbow:"},{id:1,colons:_skin_picker_base},{id:2,colons:_skin_picker_base+":skin-tone-2:"},{id:3,colons:_skin_picker_base+":skin-tone-3:"},{id:4,colons:_skin_picker_base+":skin-tone-4:"},{id:5,colons:_skin_picker_base+":skin-tone-5:"},{id:6,colons:_skin_picker_base+":skin-tone-6:"}]}();var _updateSkinClass=function(){if(!_$menu)return;_$menu.removeClass("skin_tone_1 skin_tone_2 skin_tone_3 skin_tone_4 skin_tone_5 skin_tone_6");if(TS.boot_data.feature_all_skin_tones){setTimeout(function(){if(_$headers){var sc=_$scroller.scrollTop();_$scroller.scrollTop(0);_$scroller.data("monkeyScroll").updateFunc();_calcHeaderRanges();_$scroller.scrollTop(sc);_$scroller.data("monkeyScroll").updateFunc();_getActiveGroupAndMaybePositionHeaders()}},0)}if(!_doShowAllSkinTones()){var id=TS.model.prefs.preferred_skin_tone||"1";_$menu.addClass("skin_tone_"+id)}};var _updateSkinButton=function(){if(!_$emoji_skin_button||!_$emoji_skin_button.length)return;var chosen=_doShowAllSkinTones()?_skin_picker_choices[0].colons:_skin_picker_base+TS.emoji.getChosenSkinToneModifier();chosen=TS.utility.htmlEntities(chosen);var options=_shouldForceEmojiStyle()?{force_style:"apple"}:{};_$emoji_skin_button.html(TS.emoji.graphicReplace(chosen,options))};var _shouldForceEmojiStyle=function(){return TS.model.prefs.emoji_mode!="apple"&&TS.model.prefs.emoji_mode!="twitter"};var _updateSkinPicker=function(){var chosen_id=_doShowAllSkinTones()?"all":TS.model.prefs.preferred_skin_tone||"1";var chosen;var choices=_skin_picker_choices.filter(function(item){if(item.id!=chosen_id)return true;chosen=item;return false});if(chosen)choices.push(chosen);choices=choices.map(function(item){if(!TS.boot_data.feature_all_skin_tones&&item.id=="all")return"";return'<span skin-tone="'+item.id+'">'+item.colons+"</span>"});var options=_shouldForceEmojiStyle()?{force_style:"apple"}:{};_$emoji_skin_picker.html(TS.emoji.graphicReplace(choices.join(""),options))};var _skinTonePrefChanged=function(){_updateSkinButton();_updateSkinClass();if(_$emoji_skin_picker&&_$emoji_skin_picker.hasClass("shown")){_updateSkinPicker()}if(_in_search_mode)_onInputTextchange()};var _doShowAllSkinTones=function(){return TS.boot_data.feature_all_skin_tones&&TS.model.prefs.show_all_skin_tones}})();(function(){"use strict";TS.registerModule("menu",{$menu:null,$submenu:null,$submenu_origin:null,$menu_header:null,$menu_items:null,$menu_footer:null,menu_lazy_load:null,channel:null,member:null,user_group:null,end_tim:0,$target_element:null,$secondary_target_element:null,members_html_cache:null,large_list_trigger:1500,large_dom_trigger:500,watching_members_model:false,menu_items_hidden:true,has_submenu:false,onStart:function(){_initZeroClipboard()},startWithChannel:function(e,channel_id){if(TS.menu.isRedundantClick(e))return;if(TS.client.ui.checkForEditing(e))return;if(TS.model.menu_is_showing)return;_buildIfNeeded();TS.menu.clean();TS.menu.channel=TS.channels.getChannelById(channel_id);var channel=TS.menu.channel;var show_email_item=TS.model.team.prefs.allow_email_ingestion;TS.menu.$menu_header.addClass("hidden").empty();var template_args={channel:channel,user:TS.model.user,show_email_item:show_email_item};if(!channel.is_general||TS.members.canUserPostInGeneral()){if(channel.purpose.last_set===0&&!TS.model.user.is_ultra_restricted&&channel.is_member)template_args.show_purpose_item=true}var invite_members=TS.channels.makeMembersWithPreselectsForTemplate(TS.channels.getActiveMembersNotInThisChannelForInviting(channel_id));if(invite_members.length===0){template_args.disable_invite=true}if(TS.boot_data.feature_channel_header_refresh){if(TS.notifs.isCorGMuted(channel.id))template_args.channel_is_muted=true}if(channel.is_member&&(!channel.is_general||TS.members.canUserPostInGeneral()))template_args.show_advanced_item=true;if(TS.boot_data.feature_shared_channels_ui){if(channel.is_shared){template_args.is_not_allowed_integrations=true}}TS.menu.$menu_items.html(TS.templates.menu_channel_items(template_args));if(!TS.boot_data.feature_channel_header_refresh){TS.menu.$menu_footer.html(TS.templates.menu_channel_footer({channel:channel,user:TS.model.user,show_topic:channel.is_member&&!TS.model.user.is_restricted&&(!channel.is_general||TS.members.canUserPostInGeneral())}))}TS.menu.$menu_header.bind("click.menu",TS.menu.onChannelHeaderClick);TS.menu.$menu_items.on("click.menu","li",TS.menu.onChannelItemClick);TS.kb_nav.setSubmitItemHandler(TS.menu.onChannelItemClick);TS.menu.start(e);TS.menu.$menu.attr("data-qa","channel_menu");$("#menu_channel_topic_input").bind("keydown",_handleTopicKeydown);if(!TS.boot_data.feature_channel_header_refresh){TS.menu.positionAt($("#active_channel_name .name"),24,47)}else{TS.menu.positionAt($("#channel_actions_toggle"),6,30)}if(template_args.disable_invite){$("#channel_invite_item a").tooltip({title:"Everyone on your team is already in this channel",delay:{show:500,hide:0}})}},onChannelHeaderClick:function(e){e.preventDefault()},onChannelItemClick:function(e){var id=$(this).attr("id");if($(this).hasClass("disabled")){TS.menu.end();return}if(id=="channel_join_item"){e.preventDefault();if(TS.model.archive_view_is_showing&&TS.client.archives.current_model_ob.id==TS.menu.channel.id){TS.channels.join(TS.client.archives.current_model_ob.name)}else{TS.channels.displayChannel(TS.menu.channel.id)}}else if(id=="channel_display_item"){e.preventDefault();TS.channels.displayChannel(TS.menu.channel.id)}else if(id=="channel_close_archived_item"){e.preventDefault();TS.channels.closeArchivedChannel(TS.menu.channel.id)}else if(id=="channel_leave_item"){e.preventDefault();TS.channels.leave(TS.menu.channel.id)}else if(id=="channel_star_item"){e.preventDefault();TS.stars.checkForStarClick(e)}else if(id=="channel_email_item"){}else if(id=="channel_advanced_item"){e.preventDefault();TS.ui.channel_options_dialog.start(TS.menu.channel.id)}else if(id=="channel_unarchive_item"){e.preventDefault();TS.api.call("channels.unarchive",{channel:TS.menu.channel.id},function(ok,data,args){if(ok)return;var err_str='Un-archiving failed with error "'+data.error+'"';if(data.error=="restricted_action"){err_str="<p>You don't have permission to un-archive channels.</p><p>Talk to your team owner.</p>"}setTimeout(TS.generic_dialog.alert,100,err_str)})}else if(id=="channel_archives_item"){}else if(id=="channel_mute_item"){e.preventDefault();TS.client.channel_header.muteOrUnmuteChannel(TS.menu.channel.id)}else if(id=="channel_files_item"){TS.client.ui.openFlexTab("search");TS.search.setFilter("files");TS.view.resizeManually("TS.key_triggers");var txt="in:"+TS.shared.getActiveModelOb().name+" ";TS.search.setInputVal(txt)}else if(id=="channel_rename_item"){e.preventDefault();TS.ui.channel_create_dialog.start(TS.menu.channel.name,TS.menu.channel)}else if(id=="channel_purpose_item"){e.preventDefault();TS.ui.purpose_dialog.start(TS.menu.channel.name,TS.menu.channel)}else if(id=="channel_invite_item"){e.preventDefault();TS.ui.channel_invite_modal.startInviteToChannelModal(TS.menu.channel.id)}else if(id=="channel_prefs"){e.preventDefault();TS.ui.channel_prefs_dialog.start(TS.menu.channel.id)}else if(id=="channel_add_service_item"){}else{TS.warn("not sure what to do with clicked element id:"+id);return}TS.menu.end()},startWithGroup:function(e,group_id){if(TS.menu.isRedundantClick(e))return;if(TS.client.ui.checkForEditing(e))return;if(TS.model.menu_is_showing)return;_buildIfNeeded();TS.menu.clean();var group=TS.menu.group=TS.groups.getGroupById(group_id);var show_email_item=TS.model.team.prefs.allow_email_ingestion;TS.menu.$menu_header.addClass("hidden").empty();var template_args={group:group,user:TS.model.user,show_email_item:show_email_item,leave_action:TS.groups.getLeaveAction(group_id)};if(group.purpose.last_set===0&&!TS.model.user.is_ultra_restricted)template_args.show_purpose_item=true;var invite_members=TS.channels.makeMembersWithPreselectsForTemplate(TS.groups.getActiveMembersNotInThisGroupForInviting(group_id));if(invite_members.length===0){template_args.disable_invite=true}if(TS.boot_data.feature_channel_header_refresh){if(TS.notifs.isCorGMuted(group.id))template_args.group_is_muted=true}if(TS.boot_data.feature_shared_channels_ui){if(group.is_shared){template_args.is_not_allowed_integrations=true}}TS.menu.$menu_items.html(TS.templates.menu_group_items(template_args));if(!TS.boot_data.feature_channel_header_refresh){TS.menu.$menu_footer.html(TS.templates.menu_group_footer({group:group,user:TS.model.user}))}TS.menu.$menu_header.bind("click.menu",TS.menu.onGroupHeaderClick);TS.menu.$menu_items.on("click.menu","li",TS.menu.onGroupItemClick);TS.menu.start(e);TS.menu.$menu.attr("data-qa","group_menu");$("#menu_group_topic_input").bind("keydown",_handleTopicKeydown);if(!TS.boot_data.feature_channel_header_refresh){TS.menu.positionAt($("#active_channel_name .name"),24,53)}else{TS.menu.positionAt($("#channel_actions_toggle"),6,30)}if(template_args.disable_invite){$("#group_invite_item a").tooltip({title:"Everyone on your team is already in this "+TS.templates.builders.groupCopy(),delay:{show:500,hide:0}})}},onGroupHeaderClick:function(e){e.preventDefault()},onGroupItemClick:function(e){var id=$(this).attr("id");if($(this).hasClass("disabled")){TS.menu.end();return}if(id=="group_display_item"){e.preventDefault();TS.groups.displayGroup(TS.menu.group.id)}else if(id=="group_star_item"){e.preventDefault();TS.stars.checkForStarClick(e)}else if(id=="group_mute_item"){e.preventDefault();TS.client.channel_header.muteOrUnmuteChannel(TS.menu.group.id)}else if(id=="group_email_item"){}else if(id=="group_files_item"){TS.client.ui.openFlexTab("search");TS.search.setFilter("files");TS.view.resizeManually("TS.key_triggers");var txt="in:"+TS.shared.getActiveModelOb().name+" ";TS.search.setInputVal(txt)}else if(id=="group_leave_item"){e.preventDefault();TS.groups.leave(TS.menu.group.id)}else if(id=="group_unarchive_item"){e.preventDefault();TS.api.call("groups.unarchive",{channel:TS.menu.group.id})}else if(id=="group_archives_item"){}else if(id=="group_advanced_item"){e.preventDefault();TS.ui.channel_options_dialog.start(TS.menu.group.id)}else if(id=="group_purpose_item"){e.preventDefault();TS.ui.purpose_dialog.start(TS.menu.group.name,TS.menu.group)}else if(id=="group_invite_item"){e.preventDefault();TS.ui.channel_invite_modal.startInviteToChannelModal(TS.menu.group.id)}else if(id=="group_prefs"){e.preventDefault();TS.ui.channel_prefs_dialog.start(TS.menu.group.id)}else if(id=="group_add_service_item"){}else{
TS.warn("not sure what to do with clicked element id:"+id);return}TS.menu.end()},startWithMpim:function(e,mpim_id){if(TS.menu.isRedundantClick(e))return;if(TS.client.ui.checkForEditing(e))return;if(TS.model.menu_is_showing)return;_buildIfNeeded();TS.menu.clean();var mpim=TS.menu.mpim=TS.mpims.getMpimById(mpim_id);if(mpim.members.length>4){$("#active_channel_name").find(".name").tooltip("disable")}TS.menu.$menu_header.addClass("hidden").empty();var template_args={mpim:mpim,user:TS.model.user,show_mpim_create:TS.members.canUserCreateMpims(),show_mpim_convert:TS.members.canUserCreateGroups()};TS.menu.$menu_header.addClass("hidden").empty();if(TS.boot_data.feature_channel_header_refresh){if(TS.notifs.isCorGMuted(mpim.id))template_args.mpim_is_muted=true}TS.menu.$menu_items.html(TS.templates.menu_mpim_items(template_args));TS.menu.$menu_header.bind("click.menu",TS.menu.onMpimHeaderClick);TS.menu.$menu_items.on("click.menu","li",TS.menu.onMpimItemClick);TS.menu.start(e);TS.menu.$menu.attr("data-qa","mpim_menu");if(!TS.boot_data.feature_channel_header_refresh){TS.menu.positionAt($("#active_channel_name .name"),24,53)}else{TS.menu.positionAt($("#channel_actions_toggle"),6,30)}if(template_args.disable_invite){$("#mpim_invite_item a").tooltip({title:"Everyone on your team is already in this conversation",delay:{show:500,hide:0}})}},onMpimHeaderClick:function(e){e.preventDefault()},onMpimItemClick:function(e){var id=$(this).attr("id");var mpim=TS.menu.mpim;if($(this).hasClass("disabled")){TS.menu.end();return}if(id=="mpim_star_item"){e.preventDefault();TS.stars.checkForStarClick(e)}else if(id=="mpim_archives_item"){}else if(id=="mpim_mute_item"){e.preventDefault();TS.client.channel_header.muteOrUnmuteChannel(TS.menu.mpim.id)}else if(id=="mpim_prefs"){e.preventDefault();TS.ui.channel_prefs_dialog.start(TS.menu.mpim.id)}else if(id=="mpim_files_item"){TS.client.ui.openFlexTab("search");TS.search.setFilter("files");TS.view.resizeManually("TS.key_triggers");var txt="in:"+TS.shared.getActiveModelOb().name+" ";TS.search.setInputVal(txt)}else if(id=="mpim_create_mpim_item"){e.preventDefault();setTimeout(function(){TS.ui.im_browser.startWithMpim(mpim)},1)}else if(TS.boot_data.feature_convert_mpim_client&&id=="convert_to_private_channel"){e.preventDefault();var model_ob=TS.shared.getActiveModelOb();TS.ui.mpim_conversion_modal.startMpimConversionModal(model_ob)}else{TS.warn("not sure what to do with clicked element id:"+id);return}TS.menu.end()},startWithGroups:function(e){if(TS.menu.isRedundantClick(e))return;if(TS.client.ui.checkForEditing(e))return;if(TS.model.menu_is_showing)return;_buildIfNeeded();TS.menu.clean();var nondisplayed_groups=[];var archived_c=0;var group;for(var i=0;i<TS.model.groups.length;i++){group=TS.model.groups[i];if(group.is_archived){archived_c++;continue}if(TS.model.prefs.sidebar_behavior=="hide_read_channels"){if(group.unread_cnt)continue;nondisplayed_groups.push(group)}else if(TS.model.prefs.sidebar_behavior=="hide_read_channels_unless_starred"){if(group.unread_cnt||group.is_starred)continue;nondisplayed_groups.push(group)}else{nondisplayed_groups.push(group)}}TS.menu.$menu_header.html(TS.templates.menu_groups_header());TS.menu.$menu_items.html(TS.templates.menu_groups_items({nondisplayed_groups:nondisplayed_groups,show_archived_item:archived_c,user:TS.model.user}));TS.menu.$menu_items.on("click.menu","li",TS.menu.onGroupsItemClick);TS.menu.start(e)},onGroupsItemClick:function(e){var id=$(this).attr("id");if(id=="new_group_item"){TS.menu.onNewGroupClick(e)}else if(id=="groups_archives_item"){}else if(id=="about_groups_item"){e.preventDefault();TS.coachmark.start(TS.coachmarks.coachmarks.private_groups_ura)}else{e.preventDefault();var group_id=$(this).data("group-id");if(group_id){TS.groups.displayGroup(group_id)}}TS.menu.end()},onNewGroupClick:function(e){e.preventDefault();TS.ui.group_create_dialog.start();TS.menu.end()},reported_no_file_reader:false,startWithNewFileOptions:function(e,el){if(TS.menu.isRedundantClick(e))return;if(TS.client.ui.checkForEditing(e))return;if(TS.model.menu_is_showing)return;_buildIfNeeded();TS.menu.clean();TS.menu.$menu.addClass("file_menu");TS.menu.$menu_header.addClass("hidden").empty();var items=[];var should_show_upload_file_option=window.File&&TS.model.team.prefs.disable_file_uploads!=="disable_all";if(should_show_upload_file_option){var upload_file_text=TS.model.team.prefs.disable_file_uploads==="disable_all_except_images"?"Upload an image":"Upload a file";items.push('<li data-which="choose" class="file_menu_item"><a><i class="file_menu_icon ts_icon ts_icon_upload"></i>'+upload_file_text+"</a></li>")}else{if(!TS.menu.reported_no_file_reader){TS.menu.reported_no_file_reader=true;TS.logError({message:"navigator.userAgent: "+navigator.userAgent},"TS.menu: No File support?")}}if(TS.boot_data.feature_email_ingestion&&TS.model.team.prefs.allow_email_ingestion){items.push('<li data-which="email" class="file_menu_item"><a target="_blank" href="/account/settings"><i class="file_menu_icon ts_icon ts_icon_share_email"></i> Import an email</a></li>')}items.push('<li data-which="snippet" class="file_menu_item"><a target="_blank" href="/files/create/snippet"><i class="file_menu_icon ts_icon ts_icon_create_snippet"></i> Create a Snippet</a></li>');if(TS.boot_data.feature_spaces){items.push('<li data-which="space" class="file_menu_item"><a target="_blank" href="/files/create/space"><i class="file_menu_icon ts_icon ts_icon_create_post"></i> Create a Post</a></li>')}if(!TS.boot_data.feature_spaces){items.push('<li data-which="post" class="file_menu_item"><a target="_blank" href="/files/create/post"><i class="file_menu_icon ts_icon ts_icon_create_post"></i> Create a post</a></li>')}if(TS.utility.box.isBrowserSupported()&&TS.model.prefs.box_enabled){items.push('<li data-which="box" class="file_menu_item"><a><i class="file_menu_icon ts_icon ts_icon_box"></i> Import from Box</a></li>')}if(window.Dropbox&&Dropbox.isBrowserSupported()&&TS.model.prefs.dropbox_enabled){items.push('<li data-which="dropbox" class="file_menu_item"><a><i class="file_menu_icon ts_icon ts_icon_dropbox"></i> Import from Dropbox</a></li>')}TS.menu.$menu_items.html(items.join("\n"));TS.menu.$menu_items.on("click.menu","li",TS.menu.onNewFileOptionsItemClick);TS.kb_nav.setSubmitItemHandler(TS.menu.onNewFileOptionsItemClick);TS.menu.start(e);TS.menu.$menu.attr("data-qa","file_menu");if(el.attr("id")=="primary_file_button"){TS.menu.positionAt(el,1,-(TS.menu.$menu.height()+6))}else{TS.menu.positionAt(el,el.width()-TS.menu.$menu.width(),el.outerHeight()+10)}},onNewFileOptionsItemClick:function(e){var which=$(this).data("which");if(which=="choose"){e.preventDefault();$("#file-upload").trigger("click")}else if(which=="email"){}else if(which=="snippet"){e.preventDefault();TS.client.ui.startSnippetFromChatInput()}else if(which=="post"){}else if(which=="box"){e.preventDefault();TS.files.openBoxChooser()}else if(which=="dropbox"){e.preventDefault();TS.files.openDropboxChooser()}else if(which=="space"&&TS.boot_data.feature_spaces){e.preventDefault();var open_in_browser=e&&(e.ctrlKey&&!TS.model.is_mac||e.metaKey&&TS.model.is_mac);TS.files.createAndOpenNewSpace(null,open_in_browser)}else{e.preventDefault();TS.warn("not sure what to do with clicked element:"+which)}TS.menu.end()},startWithService:function(e,config){if(TS.menu.isRedundantClick(e)||TS.client.ui.checkForEditing(e)||TS.model.menu_is_showing||typeof config==="undefined"){return false}_buildIfNeeded();var bot=TS.bots.getBotById(config.service_id);TS.menu.clean();TS.menu.$menu.addClass("profile_preview");var header_data={avatar:bot.icons.image_48,name:bot.name,integration_type:"Twitter",details:"Posts tweets sent to @slackhq to #slackhq",added_by:"James Sherrett",label:"SlackHQ Tweets"};var body_data={id:bot.id,files:false};var header_html=TS.templates.service_preview_header(header_data);var body_html=TS.templates.service_preview_body(body_data);TS.menu.$menu_header.html(header_html);TS.menu.$menu_items.html(body_html);TS.menu.start(e,config.position_by_click)},onServiceClick:function(e,dataset){},startWithMember:function(e,member_id,position_by_click,is_header_menu,is_im_menu){if(TS.menu.isRedundantClick(e))return;if(TS.client.ui.checkForEditing(e))return;if(TS.model.menu_is_showing)return;_buildIfNeeded();var member=TS.menu.member=TS.members.getMemberById(member_id);if(!member)return;if(!TS.members.canUserSeeMember(member))return;var show_email_item=TS.model.team.prefs.allow_email_ingestion;TS.menu.clean();var template_args={member:member,show_dm_item:!is_im_menu,show_hide_messages_item:TS.boot_data.feature_user_hidden_msgs&&TS.model.user_hiddens.indexOf(member.id)==-1,show_unhide_messages_item:TS.boot_data.feature_user_hidden_msgs&&TS.model.user_hiddens.indexOf(member.id)>-1,show_email_item:show_email_item,show_group_create:TS.members.canUserCreateGroups()&&!member.is_ultra_restricted};if(is_im_menu){TS.menu.$menu_header.addClass("hidden").empty();template_args.im=TS.ims.getImByMemberId(member_id);template_args.channel_header_refresh=TS.boot_data.feature_channel_header_refresh}else{TS.menu.$menu_header.html(TS.templates.menu_member_header(template_args));TS.client.flex_pane.startLocalTimeInterval()}if(is_header_menu&&member_id==TS.model.user.id){template_args.other_accounts=TS.boot_data.other_accounts;template_args.logout_url=TS.boot_data.logout_url;template_args.signin_url=TS.boot_data.signin_url}if(!member.deleted&&!member.is_slackbot&&member_id!=TS.model.user.id){if(!TS.model.user.is_ultra_restricted&&!member.is_ultra_restricted){var invite_channels=TS.members.getMyChannelsThatThisMemberIsNotIn(member_id);if(invite_channels.length){template_args.show_channel_invite=true}if(TS.model.allow_invite_to_group_from_person){template_args.show_group_invite=true}}}var model_ob=TS.shared.getActiveModelOb();if(TS.model.active_channel_id||TS.model.active_group_id){if((!model_ob.is_general||member.is_restricted)&&member_id!=TS.model.user.id&&model_ob.members&&model_ob.members.indexOf(member_id)!=-1){if(!member.is_ultra_restricted){if(model_ob.is_group&&TS.members.canUserKickFromGroups()||model_ob.is_channel&&TS.members.canUserKickFromChannels()){template_args.channel_kick_name=(TS.model.active_channel_id?"#":"")+model_ob.name}}}}if(member_id=="USLACKBOT"){var show_slackbot_responses_item=false;if(TS.model.user.is_admin){show_slackbot_responses_item=true}else if(!TS.model.team.prefs.slackbot_responses_disabled&&!TS.model.team.prefs.slackbot_responses_only_admins){show_slackbot_responses_item=true}template_args.show_slackbot_responses_item=show_slackbot_responses_item}if(TS.boot_data.feature_calls&&TS.utility.calls.isEnabled()&&!member.is_bot&&member_id!="USLACKBOT"){template_args.show_call_action=true;if(TS.boot_data.feature_shared_channels_ui){var team=TS.model.team;if(team&&team.id!==member.team_id)template_args.show_call_action=false}}TS.menu.$menu_items.html(TS.templates.menu_member_items(template_args));if(member_id==TS.model.user.id){var menu_user_footer_html=TS.templates.menu_user_footer({user:member});if(TS.boot_data.feature_dm_yahself){menu_user_footer_html+=TS.templates.menu_member_footer({member:member})}TS.menu.$menu_footer.html(menu_user_footer_html)}else{if(!is_im_menu){TS.menu.$menu_footer.html(TS.templates.menu_member_footer({member:member}))}}TS.menu.start(e,position_by_click);var keymap=TS.utility.keymap;$("#menu_member_dm_input").bind("keydown",function(e){var input=$(this);if(e.which==keymap.enter&&!e.shiftKey){if($.trim(input.val())!==""){e.preventDefault();TS.ims.startImByMemberId(member.id,false,input.val());TS.menu.end()}}});if(member.is_self){TS.menu.$menu_header.find(".member_timezone_value a").on("click.timezone",function(e){e.stopPropagation();TS.menu.end()})}TS.menu.$menu_header.bind("click.menu",TS.menu.onMemberHeaderClick);TS.menu.$menu_items.on("click.menu","li",TS.menu.onMemberItemClick);TS.kb_nav.setSubmitItemHandler(TS.menu.onMemberItemClick);if(is_im_menu){if(!TS.boot_data.feature_channel_header_refresh){TS.menu.positionAt($("#active_channel_name .name"),24,47)}else{TS.menu.positionAt($("#channel_actions_toggle"),6,30)}TS.menu.$menu.attr("data-qa","member_menu")}$("#menu_user_status_input").select();if(is_im_menu){TS.view.setFlexMenuSize()}else{TS.menu.keepInBounds()}},onMemberHeaderClick:function(e){e.preventDefault();TS.client.ui.previewMember(TS.menu.member.id);TS.menu.end()},onMemberItemClick:function(e){var id=$(this).attr("id");clearTimeout(TS.menu.end_time);if(id=="member_photo_item"){}else if(id=="member_archives_item"){}else if(id=="member_star_item"){e.preventDefault();TS.stars.checkForStarClick(e)}else if(id=="member_email_item"){}else if(id=="member_skype_item"){}else if(id=="member_account_item"){}else if(id=="member_prefs_item"){e.preventDefault();TS.ui.prefs_dialog.start()}else if(id=="member_files_item"){e.preventDefault();TS.view.fileClearFilter();TS.client.ui.filterFileList(TS.menu.member.id)}else if(id=="member_im_files_item"){TS.client.ui.openFlexTab("search");TS.search.setFilter("files");TS.view.resizeManually("TS.key_triggers");var txt="in:"+TS.shared.getActiveModelOb().name+" ";TS.search.setInputVal(txt)}else if(id=="member_dm_item"){e.preventDefault();TS.ims.startImByMemberId(TS.menu.member.id)}else if(id=="member_invite_channel_item"){e.preventDefault();TS.ui.invite.showInviteMemberToChannelDialog(TS.menu.member.id)}else if(id=="member_invite_group_item"){e.preventDefault();TS.ui.invite.showInviteMemberToGroupDialog(TS.menu.member.id)}else if(id=="member_create_group_item"){e.preventDefault();TS.ui.new_channel_modal.start("",false,[TS.menu.member.id])}else if(id=="member_profile_item"){e.preventDefault();if(TS.menu.member.is_self){TS.ui.edit_member_profile.start()}else{TS.client.ui.previewMember(TS.menu.member.id)}}else if(id=="member_presence"){e.preventDefault();TS.members.toggleUserPresence();TS.menu.end_time=setTimeout(function(){TS.menu.end()},1e3);return}else if(id=="logout"){e.preventDefault();if(TS.client)TS.client.windows.closeAll();TS.utility.loadUrlInWindowIfOnline(TS.boot_data.logout_url)}else if($(this).hasClass("switch_team")){e.preventDefault();var team_id=$(this).data("team-id");if(TSSSB.call("displayTeam",team_id)){e.preventDefault()}else{var href=$(this).find("a").attr("href");if(href&&href.indexOf("?")==-1){$(this).find("a").attr("href",href+="?"+TS.getQsArgsForUrl())}}}else if(id=="member_kick_channel_item"){e.preventDefault();if(TS.model.active_channel_id){TS.channels.kickMember(TS.model.active_channel_id,TS.menu.member.id)}else if(TS.model.active_group_id){TS.groups.kickMember(TS.model.active_group_id,TS.menu.member.id)}}else if(id=="member_hide_messages_item"){TS.utility.msgs.hideMessagesFrom(TS.menu.member.id)}else if(id=="member_unhide_messages_item"){TS.utility.msgs.unHideMessagesFrom(TS.menu.member.id)}else if(id=="member_slackbot_responses"){}else if(id=="member_open_profile_item"){}else if(id=="member_call_item"){TS.utility.calls.startCallInModelOb(TS.menu.member)}else{e.preventDefault();TS.warn("not sure what to do with clicked element id:"+id);return}TS.menu.end()},startWithMemberPreview:function(e,member_id,is_team_page,is_member_preview){if(TS.menu.isRedundantClick(e))return;if(TS.client&&TS.client.ui.checkForEditing(e))return;if(TS.model.menu_is_showing)return;_buildIfNeeded();TS.menu.clean();var $btn=$(e.target).closest(".member_preview_menu_target");if(!member_id){member_id=$btn.closest("[data-member-id]").data("member-id")}var member=TS.menu.member=TS.members.getMemberById(member_id);var im=TS.ims.getImByMemberId(member_id);var template_args={member:member,is_team_directory:true,im_id:im&&im.id,hide_view_profile:is_member_preview,show_group_create:TS.members.canUserCreateGroups()&&!member.is_ultra_restricted};TS.menu.$menu_header.addClass("hidden").empty();if(!member.deleted&&!member.is_slackbot&&member_id!=TS.model.user.id){if(!TS.model.user.is_ultra_restricted&&!member.is_ultra_restricted){var invite_channels=TS.members.getMyChannelsThatThisMemberIsNotIn(member_id);if(invite_channels.length){template_args.show_channel_invite=true}if(TS.model.allow_invite_to_group_from_person){template_args.show_group_invite=true}}if(TS.boot_data.feature_shared_channels_ui){var team=TS.model.team;if(team&&team.id!==member.team_id)template_args.show_call_action=false}}if(is_team_page){TS.menu.$menu_items.html(TS.templates.menu_member_items_short(template_args))}else{TS.menu.$menu_items.html(TS.templates.menu_member_items(template_args));TS.menu.$menu_items.on("click.menu","li",TS.menu.onMemberItemClick)}TS.menu.start(e);TS.kb_nav.setSubmitItemHandler(TS.menu.onMemberItemClick);var left_offset=$btn.outerWidth()-TS.menu.$menu.width()-1;TS.menu.positionAt($btn,left_offset,$btn.outerHeight()+5);TS.menu.keepInBounds()},startWithMembers:function(e){if(TS.menu.isRedundantClick(e))return;if(TS.client.ui.checkForEditing(e))return;if(TS.model.menu_is_showing)return;_buildIfNeeded();TS.menu.clean();var show_filter=false;var list_members=TS.members.getActiveMembersWithSlackbotAndNotSelf();if(list_members.length>5)show_filter=true;var is_large_team=false;if(TS.menu.large_list_trigger>0&&list_members.length>TS.menu.large_list_trigger){is_large_team=true}TS.menu.$menu_header.html(TS.templates.menu_members_header({show_filter:show_filter,large_team:is_large_team}));if(is_large_team){TS.menu.$menu_items[0].style.display="none";TS.menu.$menu_header.find(".show_all").one("click",function(e){TS.menu.large_list_trigger=0;$("#dms_filter_show_all").remove();TS.menu.$menu_items[0].style.display="block";var $input=$("#dms_filter").find(".member_filter");var input_val=$input.val();$input.focus();if(input_val&&input_val.length){$input.val("");$input.trigger("update-team-filter")}else{var monkey_scroll=TS.menu.$menu.find("#menu_items_scroller").data("monkeyScroll");if(monkey_scroll){monkey_scroll.updateFunc(true)}TS.menu.$menu_items.trigger("scroll.lazyload")}TS.menu.keepInBounds();e.preventDefault();return false})}else{TS.menu.$menu_items[0].style.display="block"}if(!TS.menu.members_html_cache){TS.menu.members_html_cache=TS.templates.menu_members_items({members:list_members})}TS.menu.$menu_items.html(TS.menu.members_html_cache);TS.menu.$menu_footer.html(TS.templates.menu_members_footer());TS.menu.$menu_items.on("click.menu","li",TS.menu.onMembersItemClick);TS.menu.start(e);$("#about_dms_link").on("click",function(e){e.preventDefault();TS.menu.end();TS.coachmark.start(TS.coachmarks.coachmarks.direct_messages)});if(show_filter){TS.members.view.bindTeamFilter("#dms_filter","#menu_items_scroller");$("#dms_filter").find(".member_filter").focus();TS.members.view.team_filter_changed_sig.add(TS.kb_nav.clearHighlightedItem,TS.kb_nav);TS.members.view.team_filter_changed_sig.add(TS.menu.filterChanged,TS.menu);TS.kb_nav.setAllowHighlightWithoutBlurringInput(true)}if(!TS.menu.watching_members_model){TS.members.members_for_user_changed_sig.add(TS.menu.membersModelChanged,TS.menu);TS.members.changed_name_sig.add(TS.menu.membersModelChanged,TS.menu);TS.members.changed_deleted_sig.add(TS.menu.membersModelChanged,TS.menu);TS.members.presence_changed_sig.add(TS.menu.membersModelChanged,TS.menu);TS.menu.watching_members_model=true}},filterChanged:function(query,result_count){if(!TS.menu.$menu_items)return;if(TS.menu.large_list_trigger>0&&result_count>TS.menu.large_list_trigger&&(!query||!query.length)){if(!TS.menu.menu_items_hidden){TS.menu.$menu_items[0].style.display="none";TS.menu.menu_items_hidden=true}}else{if(TS.menu.menu_items_hidden){TS.menu.$menu_items[0].style.display="block";TS.menu.menu_items_hidden=false}}TS.menu.keepInBounds()},membersModelChanged:function(){TS.menu.members_html_cache=null;if(!TS.model.menu_is_showing||!$("#menu_items .dm_list_item").length){TS.members.members_for_user_changed_sig.remove(TS.menu.membersModelChanged,TS.menu);TS.members.changed_name_sig.remove(TS.menu.membersModelChanged,TS.menu);TS.members.changed_deleted_sig.remove(TS.menu.membersModelChanged,TS.menu);TS.members.presence_changed_sig.remove(TS.menu.membersModelChanged,TS.menu);TS.menu.watching_members_model=false;return}},onMembersItemClick:function(e){e.preventDefault();var member_id=$(this).data("member-id");if(member_id){TS.ims.startImByMemberId(member_id)}TS.menu.end()},startWithFileFilter:function(e,search_filter){if(TS.menu.isRedundantClick(e))return;if(TS.model.menu_is_showing)return;_buildIfNeeded();TS.menu.clean();var active_type="all";if(TS.model.file_list_types){active_type=TS.model.file_list_types[0]}var show_email_item=TS.boot_data.feature_email_ingestion&&TS.model.team.prefs.allow_email_ingestion||TS.model.team.plan;TS.menu.$menu_header.addClass("hidden").empty();TS.menu.$menu_items.html(TS.templates.menu_file_filter_items({active_type:active_type,show_email_item:show_email_item}));if(search_filter){TS.menu.$menu_items.on("click.menu","li",TS.menu.onSearchFileFilterItemClick)}else{TS.menu.$menu_items.on("click.menu","li",TS.menu.onFileFilterItemClick)}TS.menu.start(e);if(search_filter){TS.menu.positionAt($("#search_results_container"),8,74)}else{TS.menu.positionAt($("#file_list_container"),8,44)}},onFileFilterItemClick:function(e){e.preventDefault();TS.client.ui.filterFileList($(this).data("filetype"));TS.view.fileSetButtonState($(this).data("filetype"));TS.menu.end()},onSearchFileFilterItemClick:function(e){e.preventDefault();TS.search.setFiletypeFilter($(this).data("filetype"));TS.view.fileSetButtonState($(this).data("filetype"));TS.menu.end()},startWithFileMemberFilter:function(e,search_filter){var i,j,members,humans,bots;if(TS.menu.isRedundantClick(e))return;if(TS.model.menu_is_showing)return;_buildIfNeeded();TS.menu.clean();TS.menu.$menu_header.html(TS.templates.menu_file_member_header());members=TS.members.getMembersForUser();humans=[];bots=[];for(i=0,j=members.length;i<j;i++){if(members[i].is_bot||members[i].is_slackbot){bots.push(members[i])}else{humans.push(members[i])}}members=humans.concat(bots);TS.menu.$menu_items.html(TS.templates.menu_file_member_filter_items({members:members}));if(search_filter){TS.menu.$menu_items.on("click.menu","li",TS.menu.onSearchFileMemberFilterItemClick)}else{TS.menu.$menu_items.on("click.menu","li",TS.menu.onFileMemberFilterItemClick)}TS.menu.start(e);if(search_filter){TS.menu.positionAt($("#search_results_container"),102,100)}else{var $btn=$("#file_list_toggle_user");TS.menu.positionAt($("#file_list_toggle_user"),0,$btn.outerHeight())}TS.members.view.bindTeamFilter("#file_member_filter","#menu_items_scroller");$("#file_member_filter").find(".member_filter").focus().keydown(function(e){if(e.which==TS.utility.keymap.enter){var visible_members=$("#menu_items .member_item.active");if(visible_members.length==1){visible_members.find("a").click()}}});TS.members.view.team_filter_changed_sig.add(TS.kb_nav.clearHighlightedItem,TS.kb_nav);TS.kb_nav.setAllowHighlightWithoutBlurringInput(true)},onFileMemberFilterItemClick:function(e){e.preventDefault();var id=$(this).data("member-id");TS.client.ui.toggleFileList(id);TS.menu.end()},onSearchFileMemberFilterItemClick:function(e){e.preventDefault();var id=$(this).data("member-id");TS.search.setMember(id);TS.menu.end()},startWithMessageActions:function(e,msg_ts,msgs,model_ob){if(TS.client&&!TS.model.ms_connected){TS.sounds.play("beep");return}if(TS.menu.isRedundantClick(e))return;if(TS.model.menu_is_showing)return;_buildIfNeeded();TS.menu.clean();var msg=TS.utility.msgs.getMsg(msg_ts,msgs);model_ob=model_ob||TS.shared.getActiveModelOb();if(!msg&&TS.replies&&TS.replies.isEnabledForModelOb(model_ob)){msg=model_ob._replies_msgs[msg_ts]}var actions=TS.utility.msgs.getMsgActions(msg,model_ob);var allow_mark_unread=TS.client&&TS.utility.msgs.getMarkMsgForUnreadPoint(msg_ts,msgs)&&!TS.model.archive_view_is_showing&&!msg.is_ephemeral;actions.mark_unread=!!allow_mark_unread;var template_args={msg:msg,actions:actions,model_ob:model_ob};template_args.abs_permalink=TS.utility.msgs.constructAbsoluteMsgPermalink(model_ob,msg.ts);if(msg.subtype=="file_share"||msg.subtype=="file_mention"){if(msg.file){template_args.abs_permalink=msg.file.permalink}}if(TS.replies&&TS.replies.isEnabled()){template_args.is_in_conversation=$(e.target).closest("ts-conversation").length>0}TS.menu.$menu_header.addClass("hidden").empty();TS.menu.$menu_items.html(TS.templates.menu_message_action_items(template_args));TS.menu.$menu_items.on("click.menu","li",TS.menu.onMessageActionClick);if(TS.boot_data.feature_reminders_v3_ui){TS.log("enabled reminders msg action menu");TS.menu.has_submenu=true;var $remind_me=TS.menu.$menu_items.find("#remind_me");$remind_me.on("highlighted",function(){$remind_me.submenu({items_html:TS.templates.remind_me_items(),onclick:TS.menu.onMessageActionClick})}).on("unhighlighted",function(){if(TS.menu.$submenu&&!TS.menu.$submenu.hasClass("kb_active"))$remind_me.submenu("destroy")})}TS.menu.start(e);var $el=$(e.target);TS.menu.$target_element=$el.closest("[data-action]");TS.menu.$target_element.addClass("active");TS.menu.$secondary_target_element=$el.closest("ts-message");TS.menu.$secondary_target_element.addClass("active");var top_offset=0;var left_offset=$el.width()+10;if(TS.client&&!TS.model.ui_state.flex_visible)left_offset=-(TS.menu.$menu.width()+10);var $center_item=TS.menu.$menu.find("#edit_link");if($center_item.length===0)$center_item=TS.menu.$menu.find("#rxn_link");if($center_item.length>0){var menu_top=TS.menu.$menu.offset().top;var center_item_top=$center_item.offset().top;top_offset=-(center_item_top-menu_top+$center_item.height()/2-5)}TS.menu.positionAt($el,left_offset,top_offset);TS.menu.keepInBounds()},onMessageActionClick:function(e){e.preventDefault();var $target=$(this);var id=$target.attr("id");var msg_ts=$target.data("msg-ts");var model_ob_id=$target.data("model-ob-id");var rxn_key=$target.data("rxn-key");var model_ob=model_ob_id?TS.shared.getModelObById(model_ob_id):TS.shared.getActiveModelOb();if(id=="edit_link"){var edit_state=$target.data("edit-state");TS.msg_edit.startEdit(msg_ts,model_ob,edit_state)}else if(id=="delete_link"){TS.msg_edit.startDelete(msg_ts,model_ob)}else if(id=="jump_to_original_link"){TS.client.ui.tryToJump(model_ob.id,msg_ts)}else if(id=="reply_link"){var $msg_el=TS.client.msg_pane.getCanonicalDivForMsg(msg_ts);var msg=TS.utility.msgs.getMsg(msg_ts,model_ob.msgs);if($msg_el.length&&TS.replies&&TS.replies.canReplyToMsg(model_ob,msg)){TS.ui.messages.selectMsgEl($msg_el)}}else if(id==="pin_link"){TS.pins.startPinMessage(msg_ts,model_ob)}else if(id==="unpin_link"){TS.pins.unPinMessage(msg_ts,model_ob)}else if(id==="rxn_link"){TS.emoji_menu.startEmoForRxn(e,rxn_key)}else if(id==="mark_unread"){TS.client.msg_pane.setUnreadPoint(msg_ts)}else if(id==="copy_link"){TS.clipboard.writeText($(this).data("permalink"))}else if(id==="open_original_link"){}else if($(e.target).data("msg-action")==="remind"){var $e_target=$(e.target);var $copy_link=$("#copy_link");TS.api.call("reminders.add",{text:$copy_link.data("permalink"),time:$e_target.data("remind-length"),message_channel:model_ob.id,message_ts:$copy_link.data("msg-ts")},function(ok,data,args){})}TS.menu.end()},startWithCommentActions:function(e,file_id,comment_id){if(TS.client&&!TS.model.ms_connected){TS.sounds.play("beep");return}if(TS.menu.isRedundantClick(e))return;if(TS.model.menu_is_showing)return;_buildIfNeeded();TS.menu.clean();var file=TS.files.getFileById(file_id);if(!file)return;var comment=TS.files.getFileCommentById(file,comment_id);if(!comment)return;var model_ob=TS.shared.getActiveModelOb();var actions=TS.files.getFileCommentActions(comment,file);TS.menu.$menu_header.addClass("hidden").empty();TS.menu.$menu_items.html(TS.templates.menu_comment_action_items({model_ob:model_ob,file:file,comment:comment,actions:actions}));var $el=$(e.target);TS.menu.$menu_items.on("click.menu","li",function(menu_item_event){var $original_cog_clicked=$el.closest(".comment_actions");TS.menu.onCommentActionClick(menu_item_event,$original_cog_clicked)});TS.menu.start(e);var top_offset=0;var left_offset=-(TS.menu.$menu.width()+10);var $center_item=TS.menu.$menu.find("#edit_file_comment");if($center_item.length===0)$center_item=TS.menu.$menu.find("#rxn_file_comment");if($center_item.length>0){var menu_top=TS.menu.$menu.offset().top;var center_item_top=$center_item.offset().top;top_offset=-(center_item_top-menu_top+$center_item.height()/2-5)}TS.menu.positionAt($el,left_offset,top_offset);TS.menu.keepInBounds()},onCommentActionClick:function(e,$menu_target){e.preventDefault();var $target=$(e.target).closest("[id]");var id=$target.attr("id");var rxn_key=$target.data("rxn-key");var model_ob=TS.shared.getActiveModelOb();if(id=="edit_file_comment"){TS.ui.comments.startEdit($target.data("file-id"),$target.data("comment-id"),$menu_target)}else if(id=="delete_file_comment"){TS.ui.comments.startDelete($target.data("file-id"),$target.data("comment-id"))}else if(id=="rxn_file_comment"){TS.emoji_menu.startEmoForRxn(e,rxn_key)}else if(id=="pin_comment"&&model_ob){TS.pins.startPinFileComment($target.data("comment-id"),$target.data("file-id"),model_ob)}else if(id=="unpin_comment"&&model_ob){TS.pins.unPinFileComment($target.data("comment-id"),$target.data("file-id"),model_ob)}else{TS.warn("not sure what to do with clicked element id:"+id);return}TS.menu.end()},file_list_menu_up:false,startWithFileActions:function(e,file_id){if(TS.client&&!TS.model.ms_connected){TS.sounds.play("beep");return}if(TS.menu.isRedundantClick(e))return;if(TS.model.menu_is_showing)return;_buildIfNeeded();TS.menu.clean();var file=TS.files.getFileById(file_id);if(!file)return;var actions=TS.files.getFileActions(file);var $el=$(e.target);var $actions=$el.closest(".file_actions");if(actions.comment&&$actions.data("exclude-comment"))actions.comment=false;if(actions.download&&$actions.data("exclude-download"))actions.download=false;if(actions.open_original&&$actions.data("exclude-original"))actions.open_original=false;if(actions.rxn_file&&$actions.data("exclude-rxn"))actions.rxn_file=false;if(actions.pin_file&&($actions.data("exclude-pin")||$actions.data("exclude-pin-file")))actions.pin_file=false;if(actions.unpin_file&&($actions.data("exclude-pin")||$actions.data("exclude-unpin-file")))actions.unpin_file=false;if(actions.edit&&$actions.data("exclude-edit"))actions.edit=false;if(actions.edit_title&&$actions.data("exclude-edit-title"))actions.edit_title=false;if(actions.print&&$actions.data("exclude-print"))actions.print=false;if(actions.create_public_link&&$actions.data("exclude-create-public-link"))actions.create_public_link=false;if(actions.revoke_public_link&&$actions.data("exclude-revoke-public-link"))actions.revoke_public_link=false;if($actions.data("include-open-flexpane"))actions.open_in_flexpane=true;if($actions.data("include-open-file-page"))actions.open_file_page=true;if($actions.data("include-copy-file-link")&&TS.clipboard.canWriteText())actions.copy_file_link=true;if($actions.data("include-copy-file-link")&&_useZeroClipboard())actions.copy_file_link_flash=true;if($actions.data("include-view-public-link"))actions.view_public_link=true;var in_file_list=$el.closest(".file_list_item").length>0;if(in_file_list){if(TS.model.ui_state.flex_name!=="details"||!TS.boot_data.feature_files_list)actions.share=false;TS.menu.file_list_menu_up=true}var file_container=$el.closest(".inline_file_preview_container, .file_container");if(file_container.length>0){file_container.addClass("file_menu_open");actions.new_window=false}TS.menu.$menu_header.addClass("hidden").empty();var show_workflow_divider=false;if(actions.edit||TS.client&&actions.edit_title||actions.create_public_link||actions.revoke_public_link||actions.print||actions.save_to_dropbox||actions.refresh){show_workflow_divider=true}var template_args={file:file,actions:actions,is_refreshing:TS.files.waiting_for_refresh[file.id],model_ob:TS.shared.getActiveModelOb(),show_workflow_divider:show_workflow_divider};if(TS.client)template_args.info_pane_visible=TS.model.ui_state.flex_name==="details";TS.menu.$menu_items.html(TS.templates.menu_file_action_items(template_args));if(TS.boot_data.feature_fix_files){
TS.menu.$menu.addClass("no_icons")}if(TS.web){TS.menu.$menu_items.on("click.menu","li",TS.menu.onFileActionClickWeb)}else if(TS.client){TS.menu.$menu_items.on("click.menu","li",TS.menu.onFileActionClickClient)}TS.menu.start(e);$el.closest(".file_list_item").addClass("active");TS.menu.positionAt($el,-(TS.menu.$menu.width()+6),0);TS.menu.keepInBounds();if(_useZeroClipboard()){var $copy_link=$("#copy_file_link_flash");_zero_clipboard_client=new ZeroClipboard($copy_link);_zero_clipboard_client.on("ready",function(){$copy_link.removeClass("hidden");TS.menu.keepInBounds()})}},onFileActionClickClient:function(e){var id=$(this).attr("id");var rxn_key=$(this).data("rxn-key");var file=TS.files.getFileById($(this).data("file-id"));var model_ob=TS.shared.getActiveModelOb();if(!file){TS.error("no file id:"+$(this).data("file-id"));return}if(id=="share_file"){e.preventDefault();TS.view.shareFileInCurrentChannelOrIM(file.id)}else if(id=="edit_file_snippet"){if(!file.is_truncated){e.preventDefault();TS.ui.snippet_dialog.startEdit(file.id)}}else if(id=="edit_file_post"){}else if(id=="edit_file_space"||id=="open_new_window"){if(TS.client.windows.openFileWindow(file.id))e.preventDefault()}else if(id=="edit_file_title"){e.preventDefault();if(TS.model.previewed_file_id!=file.id){TS.client.ui.previewFile(file.id,"file_list")}TS.files.editFileTitle(file.id)}else if(id=="delete_file"){e.preventDefault();TS.view.deleteFile(file.id)}else if(id=="create_public_link"){e.preventDefault();if(TS.model.team.prefs.disallow_public_file_urls){TS.generic_dialog.alert("An administator has disabled public file URL creation. You will not be able to create a public URL for this file.");return}TS.files.createPublicURL(file,function(ok,data,args){if(ok){if(TS.model.previewed_file_id)$("#file_preview_scroller").find(".file_actions_link").scrollintoview({duration:500,offset:"top",px_offset:-50});$(".file_public_link_"+file.id).highlightText();TS.ui.fileShowPublicUrlDialog(file)}})}else if(id=="revoke_public_link"){e.preventDefault();TS.ui.fileRevokePublicLink(file.id)}else if(id=="view_public_link"){e.preventDefault();TS.ui.fileShowPublicUrlDialog(file)}else if(id=="refresh_file"){e.preventDefault();TS.files.refreshFile(file.id);TS.menu.$menu.find("#refresh_file").find(".item_label").text("Refreshing...").end();return}else if(id=="download_file"){if(TS.client&&TS.client.downloads.startDownload(file)){e.preventDefault()}}else if(id=="open_original_file"){}else if(id=="comment_file"){e.preventDefault();if(TS.model.previewed_file_id!=file.id){TS.client.ui.previewFile(file.id,"file_list",false,true)}else{$("#file_comment").focus()}}else if(id=="save_to_dropbox"){return TS.api.callImmediately("files.getTempURL",{file:file.id},function(ok,data,args){if(ok){Dropbox.save(data.url,file.name)}})}else if(id==="rxn_file"){e.preventDefault();TS.emoji_menu.startEmoForRxn(e,rxn_key)}else if(id==="share_private_file"){e.preventDefault();TS.files.shareOrReshareFile(file.id)}else if(id==="pin_file"&&model_ob){e.preventDefault();TS.pins.startPinFile(file.id,model_ob)}else if(id==="unpin_file"&&model_ob){e.preventDefault();TS.pins.unPinFile(file.id,model_ob)}else if(id==="open_in_flexpane"){e.preventDefault();TS.client.ui.previewFile(file.id)}else if(id==="copy_file_link"){e.preventDefault();if(TS.clipboard.canWriteText()){TS.clipboard.writeText(file.permalink)}else{TS.warn("User clicked copy link, but we can't write to the clipboard right now")}}else if(id==="copy_file_link_flash"){return}else if(id==="star_file"){e.preventDefault();TS.stars.checkForStarClick(e)}else{e.preventDefault();TS.warn("not sure what to do with clicked element id:"+id);return}TS.menu.end()},onFileActionClickWeb:function(e){var id=$(this).attr("id");var rxn_key=$(this).data("rxn-key");var file=TS.files.getFileById($(this).data("file-id"));var model_ob=TS.shared.getActiveModelOb();if(!file){TS.error("no file id:"+$(this).data("file-id"));return}if(id=="share_file"){e.preventDefault();TS.ui.share_dialog.start(file.id)}else if(id==="share_private_file"){e.preventDefault();TS.files.shareOrReshareFile(file.id)}else if(id=="edit_file_snippet"){}else if(id=="edit_file_post"){}else if(id=="edit_file_space"||id=="open_new_window"){}else if(id=="edit_file_title"){}else if(id=="delete_file"){e.preventDefault();TS.web.file.deleteFile(file.id)}else if(id=="create_public_link"){e.preventDefault();if(!TS.model.team.prefs.disallow_public_file_urls){TS.api.callImmediately("files.sharedPublicURL",{file:file.id},function(ok,data,args){if(ok){var $share_link=$(".file_public_link_shared");$share_link.slideToggle(100);TS.files.upsertAndSignal({id:file.id,public_url_shared:true});if($share_link.length===0)TS.ui.fileShowPublicUrlDialog(file)}else if(data.error&&data.error==="not_allowed"){TS.model.team.prefs.disallow_public_file_urls=true;TS.generic_dialog.alert("An administator has disabled public file URL creation. You will not be able to create a public URL for this file.")}})}}else if(id=="revoke_public_link"){e.preventDefault();if(TS.web.file){TS.web.file.revokePublicURL(file)}else{TS.ui.fileRevokePublicLink(file.id)}}else if(id=="view_public_link"){e.preventDefault();TS.ui.fileShowPublicUrlDialog(file)}else if(id=="refresh_file"){e.preventDefault();TS.files.refreshFile(file.id);TS.menu.$menu.find("#refresh_file").find(".item_label").text("Refreshing...").end();return}else if(id=="download_file"){}else if(id=="print_file"){window.print();e.preventDefault()}else if(id=="open_original_file"){}else if(id=="comment_file"){e.preventDefault();$("#file_comment").focus()}else if(id=="save_to_dropbox"){return TS.api.callImmediately("files.getTempURL",{file:file.id},function(ok,data,args){if(ok){Dropbox.save(data.url,file.name)}})}else if(id==="rxn_file"){e.preventDefault();TS.emoji_menu.startEmoForRxn(e,rxn_key)}else if(id==="pin_file"&&model_ob){e.preventDefault();TS.pins.startPinFile(file.id,model_ob)}else if(id==="unpin_file"&&model_ob){e.preventDefault();TS.pins.unPinFile(file.id,model_ob)}else if(id==="open_file_page"){}else{e.preventDefault();TS.warn("not sure what to do with clicked element id:"+id);return}TS.menu.end()},startWithSpaceWeb:function(e,file_id,user_id){var SPACING_BETWEEN_TARGET_AND_MENU=5;if(TS.menu.isRedundantClick(e))return;if(TS.model.menu_is_showing)return;_buildIfNeeded();TS.menu.clean();var file=TS.files.getFileById(file_id);if(!file)return;var actions=TS.files.getFileActions(file);var shared_in=file.channels.concat(file.groups).concat(file.ims);var can_enable_collab_editing=TS.boot_data.feature_pass_the_baton&&file.user==user_id&&shared_in.length;var template_args={file:file,actions:actions,can_write_to_clipboard:TS.clipboard.canWriteText(),can_enable_collab_editing:can_enable_collab_editing,collab_enabled:file.state!="locked"};TS.menu.$menu_header.addClass("hidden").empty();TS.menu.$menu_items.html(TS.templates.menu_space_action_items(template_args));TS.menu.$menu_items.on("click.menu","li",TS.menu.onSpaceClickWeb);TS.kb_nav.setSubmitItemHandler(TS.menu.onSpaceClickWeb);TS.menu.start(e);var $menu_target=$(".space_btn_more");$("#toggle_input").bind("change",function(){e.preventDefault();var $menu_item=$("#toggle_collab_editing");var $checkbox=$(this);$menu_item.addClass("disabled");$checkbox.prop("disabled",true);TS.web.space.lockEditingPrivilegesWithCallback($checkbox.prop("checked"),function(response){var file=response&&response.data;var check=file?file.state!=="locked":!$checkbox.prop("checked");$menu_item.removeClass("disabled");$checkbox.prop("disabled",false);$checkbox.prop("checked",check)})});var x_offset=-TS.menu.$menu.outerWidth()+$menu_target.outerWidth();var y_offset=$menu_target.outerHeight()+SPACING_BETWEEN_TARGET_AND_MENU;TS.menu.positionAt($menu_target,x_offset,y_offset)},onSpaceClickWeb:function(e){var id=$(this).attr("id");var file=TS.files.getFileById($(this).data("file-id"));if(!file)return;if(id=="keyboard_shortcuts"){e.preventDefault();TS.ui.shortcuts_dialog.start(true)}else if(id=="learn_more"){e.preventDefault();if(file.mode==="space"){TS.web.space.learnMore()}}else if(id=="feedback"){e.preventDefault();TS.web.space.provideFeedback()}else if(id=="delete_space"){e.preventDefault();TS.web.file.deleteFile(file.id)}else if(id=="copy_space_link"){e.preventDefault();if(TS.clipboard.canWriteText()){TS.clipboard.writeText(file.permalink)}else{TS.warn("User clicked copy link, but we can't write to the clipboard right now")}}else if(id=="create_public_space_link"){e.preventDefault();TS.files.createPublicURL(file)}else if(id=="view_public_space_link"){e.preventDefault();TS.web.space.showPublicUrlDialog()}else if(id=="print_space"){window.print();e.preventDefault()}else if(id=="toggle_collab_editing"){return}else{e.preventDefault();TS.warn("not sure what to do with clicked element id:"+id);return}TS.menu.end()},startWithTeamAndUser:function(e){if(TS.menu.isRedundantClick(e))return;if(TS.client.ui.checkForEditing(e))return;if(TS.model.menu_is_showing)return;_buildIfNeeded();TS.menu.clean();var is_tinyspeck=TS.model&&TS.model.team&&TS.model.team.domain=="tinyspeck";var is_dev=TS.boot_data.version_ts=="dev";var show_version_info=is_tinyspeck||is_dev;var template_args={user:TS.model.user,team_name:TS.model.team.name,logout_url:TS.boot_data.logout_url,signin_url:TS.boot_data.signin_url,help_url:TS.boot_data.help_url,show_version_info:show_version_info,can_invite:TS.ui.admin_invites.canInvite()};if(Object.keys(TS.boot_data.other_accounts).length)template_args.other_accounts=TS.boot_data.other_accounts;TS.menu.$menu.addClass("team_menu");TS.menu.$menu.attr("data-qa","team_menu");TS.menu.$menu_header.addClass("hidden").empty();TS.menu.$menu_items.html(TS.templates.menu_team_and_user_items(template_args));TS.menu.$menu_items.on("click.menu","li",TS.menu.onTeamAndUserItemClick);TS.menu.$menu_items.on("mouseenter.section_header","> div.section_header",TS.kb_nav.clearHighlightedItem);TS.kb_nav.setSubmitItemHandler(TS.menu.onTeamAndUserItemClick);TS.menu.start(e);if(TS.boot_data.feature_channel_header_refresh){TS.menu.positionAt($("#team_menu"),10,55)}else{TS.menu.positionAt($("#team_menu"),10,65)}TS.view.setFlexMenuSize()},onTeamAndUserItemClick:function(e){clearTimeout(TS.menu.end_time);var subroutine=$(this).attr("id");if(!subroutine&&$(this).hasClass("switch_team"))subroutine="switch_team";switch(subroutine){case"shared_channels":e.preventDefault();TS.ui.shared_channels_invites.start();break;case"version_info":e.preventDefault();TS.ui.showVersionInfo();break;case"member_account_item":e.preventDefault();TS.client.ui.previewMember(TS.model.user.id);break;case"team_settings":case"manage_team":case"team_billing":case"team_services":case"team_customize":case"team_apps":break;case"team_invitations":e.preventDefault();TS.ui.admin_invites.start();break;case"member_prefs_item":e.preventDefault();TS.ui.prefs_dialog.start();break;case"team_help":e.preventDefault();TS.help_dialog.start();break;case"team_home":e.preventDefault();TS.client.ui.showTeamList();break;case"add_team":if(TSSSB.call("signInTeam"))e.preventDefault();break;case"member_presence":e.preventDefault();TS.members.toggleUserPresence();TS.menu.end_time=setTimeout(TS.menu.end,1e3);return;case"logout":e.preventDefault();if(TS.client)TS.client.windows.closeAll();TS.utility.loadUrlInWindowIfOnline(TS.boot_data.logout_url);break;case"switch_team":var team_id=$(this).data("user-id");if(TSSSB.call("displayTeam",team_id)){e.preventDefault()}else{var href=$(this).find("a").attr("href");if(href&&href.indexOf("?")==-1)$(this).find("a").attr("href",[href,TS.getQsArgsForUrl()].join("?"))}break;default:e.preventDefault();return}TS.menu.end()},startWithNotificationsMenu:function(e){if(TS.menu.isRedundantClick(e))return;if(TS.client.ui.checkForEditing(e))return;if(TS.model.menu_is_showing)return;_buildIfNeeded();TS.menu.clean();var status=TS.dnd.memberDndStatus();var template_args={user:TS.model.user,model_ob:TS.shared.getActiveModelOb(),in_dnd:status.in_dnd,is_snoozing:status.snoozed,readable_end_time:status.readable_end_time};TS.menu.has_submenu=true;TS.menu.$menu.addClass("notifications_menu");TS.menu.$menu_header.html(TS.templates.notifications_header(template_args));TS.menu.$menu_items.html(TS.templates.notifications_items(template_args));TS.menu.$menu_items.on("click.menu","li",TS.menu.onNotificationsMenuItemClick);var $adjust=TS.menu.$menu_items.find("#adjust_snooze_time");$adjust.on("highlighted",function(){$adjust.submenu({items_html:TS.templates.snooze_items(),onclick:TS.menu.onNotificationsMenuItemClick})}).on("unhighlighted",function(){if(TS.menu.$submenu&&!TS.menu.$submenu.hasClass("kb_active"))$adjust.submenu("destroy")});TS.menu.start(e);TS.menu.positionAt($("#team_menu .notifications_menu_btn"),-10,50)},onNotificationsMenuItemClick:function(e){var $action=$(e.target).closest("[data-dnd-menu-action]");if(!$action.length)return;var action=$action.data("dnd-menu-action");var status=TS.dnd.memberDndStatus();if(action==="turn_off"){if(status.snoozed){TS.dnd.endSnooze()}else if(status.in_dnd){TS.dnd.endDnd()}}else if(action==="snooze"){var minutes=parseInt($action.data("snooze-length"));if(minutes&&!isNaN(minutes)){TS.dnd.setSnooze(minutes)}}else if(action==="dnd_schedule"){TS.ui.prefs_dialog.start("notifications",null,"prefs_dnd")}else if(action==="channel_settings"){var model_ob=TS.shared.getActiveModelOb();TS.ui.channel_prefs_dialog.start(model_ob.id)}else if(action==="notif_prefs"){TS.ui.prefs_dialog.start("notifications")}TS.menu.end()},startWithFlexMenu:function(e){if(TS.menu.isRedundantClick(e))return;if(TS.model.menu_is_showing)return;_buildIfNeeded();TS.menu.clean();TS.menu.$menu_header.addClass("hidden").empty();TS.menu.$menu_items.html(TS.templates.menu_flexpane_items({special_flex_panes:TS.boot_data.special_flex_panes,show_downloads:TS.model.supports_downloads}));TS.menu.$menu_items.on("click.menu","li",TS.menu.onFlexMenuItemClick);TS.menu.start(e);TS.menu.$menu.addClass("flex_menu");TS.menu.$menu.attr("data-qa","flex_menu");TS.utility.queueRAF(function flexToggleRAF(){TS.menu.positionAt($("#flex_menu_toggle"),-(TS.menu.$menu.width()-$("#flex_menu_toggle").width()),37)});TS.help.updateIcon();TS.client.whats_new.updateIcon();$("#flex_menu_toggle").addClass("menu_open");if(!TS.boot_data.feature_channel_header_refresh){$("#flex_menu_toggle").attr("title","Close Flexpane Menu")}$("#flex_menu_callout").bind("click",function(e){TS.menu.end()});TS.view.setFlexMenuSize()},onFlexMenuItemClick:function(e){var delay_ms=200;var tab_id=$(this).data("tab-id");if(tab_id){var flex_name=tab_id;setTimeout(function(){TS.client.ui.cleanupFlexExcluding(flex_name);if(flex_name=="files"){TS.client.ui.toggleFileList("all");TS.client.ui.filterFileList("all")}else if(flex_name=="team"){TS.client.ui.showTeamList()}else{TS.client.ui.openFlexTab(flex_name)}},delay_ms)}else if($(this).data("filetype")){var filetype=$(this).data("filetype");var $file_list=$("#file_list");if(!$file_list.length||!$file_list.children().length){if(TS.view.last_files_html){TS.view.last_files_html=""}}setTimeout(function(){TS.client.ui.cleanupFlexExcluding("files");TS.client.ui.toggleFileList("all");TS.client.ui.filterFileList(filetype);TS.view.fileSetButtonState(filetype)},delay_ms)}else{var id=$(this).attr("id");if(id=="help"){e.preventDefault();setTimeout(function(){TS.help_dialog.start()},delay_ms)}}TS.menu.end()},startWithUserGroupMenu:function(e,user_group_id){if(TS.menu.isRedundantClick(e))return;if(TS.model.menu_is_showing)return;_buildIfNeeded();TS.menu.clean();TS.menu.user_group=TS.user_groups.getUserGroupsById(user_group_id);TS.menu.$menu.addClass("no_min_width");var show_user_groups_disable=TS.members.canUserCreateAndDeleteUserGroups()&&!TS.menu.user_group.date_delete;var show_user_groups_enable=TS.members.canUserCreateAndDeleteUserGroups()&&TS.menu.user_group.date_delete;var show_user_group_delete=TS.boot_data.feature_subteams_hard_delete&&!TS.menu.user_group.auto_type&&!TS.menu.user_group.is_external;TS.menu.$menu_header.addClass("hidden").empty();TS.menu.$menu_items.html(TS.templates.user_group_items({show_user_groups_edit:TS.members.canUserEditUserGroups(),show_user_groups_disable:show_user_groups_disable,show_user_groups_enable:show_user_groups_enable,show_user_group_delete:show_user_group_delete}));TS.menu.$menu_items.on("click.menu","li",TS.menu.onUserGroupMenuItemClick);TS.menu.start(e);TS.utility.queueRAF(function flexToggleRAF(){TS.menu.positionAt($("#user_group_menu_toggle"),-(TS.menu.$menu.width()-$("#user_group_menu_toggle").width()),37)})},onUserGroupMenuItemClick:function(e){var action=$(this).data("action");if(action==="edit_info"){TS.ui.admin_user_groups.editInfo(TS.menu.user_group)}else if(action==="edit_members"){TS.ui.admin_user_groups.editMembers(TS.menu.user_group)}else if(action==="disable"){TS.ui.admin_user_groups.disable(TS.menu.user_group)}else if(action==="enable"){TS.ui.admin_user_groups.enable(TS.menu.user_group)}else if(action==="delete"){TS.ui.admin_user_groups.remove(TS.menu.user_group)}TS.menu.end()},startWithChannelPickerForChange:function(e,user_id){if(TS.menu.isRedundantClick(e))return;_buildIfNeeded();TS.menu.clean();var member=TS.members.getMemberById(user_id);var channels_for_ura=[],groups_for_ura=[];$.each(TS.channels.getUnarchivedChannelsForUser(),function(index,channel){if(!member.channels.hasOwnProperty(channel.id)){channels_for_ura.push(channel)}});$.each(TS.groups.getUnarchivedGroups(),function(index,group){if(!member.groups.hasOwnProperty(group.id)){groups_for_ura.push(group)}});var template_args={user_id:user_id,channels:channels_for_ura,groups:groups_for_ura};TS.menu.$menu_header.html(TS.templates.menu_channel_picker_header(template_args));TS.menu.$menu_items.html(TS.templates.menu_channel_picker(template_args)).css("max-height",274);TS.menu.$menu_items.on("click.menu","li",TS.menu.onChannelPickerItemClickChangeChannel);TS.menu.start(e);var $el=$(e.target).closest(".pill");if(TS.boot_data.app=="mobile"){TS.menu.positionAt($el,-$el.offset().left+16,0)}else{TS.menu.positionAt($el,-TS.menu.$menu.width()+$el.outerWidth(),$el.height()+4)}TS.menu.$menu.scrollintoview({duration:500,offset:"bottom",px_offset:-25});_bindChannelFilterStart();TS.kb_nav.setAllowHighlightWithoutBlurringInput(true)},onChannelPickerItemClickChangeChannel:function(e){var user_id=$(this).data("user-id"),channel_id=$(this).data("channel-id"),group_id=$(this).data("group-id");if(channel_id){TS.api.call("users.admin.changeURAChannel",{user:user_id,channel:channel_id},TS.web.admin.onMemberURAChanged)}else if(group_id){TS.api.call("users.admin.changeURAChannel",{user:user_id,channel:group_id},TS.web.admin.onMemberURAChanged)}TS.menu.end()},startWithChannelPickerForInvite:function(e,user_id){if(TS.menu.isRedundantClick(e))return;_buildIfNeeded();TS.menu.clean();var member=TS.members.getMemberById(user_id);var channels_for_ra=[],groups_for_ra=[];$.each(TS.channels.getUnarchivedChannelsForUser(),function(index,channel){if(!member.channels.hasOwnProperty(channel.id)){channels_for_ra.push(channel)}});$.each(TS.groups.getUnarchivedGroups(),function(index,group){if(!member.groups.hasOwnProperty(group.id)){groups_for_ra.push(group)}});var template_args={user_id:user_id,channels:channels_for_ra,groups:groups_for_ra};TS.menu.$menu_header.html(TS.templates.menu_channel_picker_header(template_args));TS.menu.$menu_items.html(TS.templates.menu_channel_picker(template_args)).css("max-height",274);TS.menu.$menu_items.on("click.menu","li",TS.menu.onChannelPickerItemClickInviteChannel);TS.menu.start(e);var $el=$(e.target).closest(".pill");if(TS.boot_data.app=="mobile"){TS.menu.positionAt($el,-$el.offset().left+16,0)}else{TS.menu.positionAt($el,-$el.width()+10,$el.height()+4)}TS.menu.$menu.scrollintoview({duration:500,offset:"bottom",px_offset:-25});_bindChannelFilterStart();TS.kb_nav.setAllowHighlightWithoutBlurringInput(true)},onChannelPickerItemClickInviteChannel:function(e){var user_id=$(this).data("user-id"),channel_id=$(this).data("channel-id"),group_id=$(this).data("group-id");if(channel_id){TS.api.call("channels.invite",{user:user_id,channel:channel_id},TS.web.admin.onMemberInviteChannel)}else if(group_id){TS.api.call("groups.invite",{user:user_id,channel:group_id},TS.web.admin.onMemberInviteGroup)}TS.menu.end()},startWithChannelPicker:function(e,model_obs,item_selected_callback){if(TS.menu.isRedundantClick(e))return;_buildIfNeeded();TS.menu.clean();var channels=[];var groups=[];var mpims=[];model_obs.forEach(function(model_ob){if(model_ob.is_channel){channels.push(model_ob)}else if(model_ob.is_mpim){mpims.push(model_ob)}else if(model_ob.is_group){groups.push(model_ob)}});var template_args={user_id:TS.model.user.id,channels:channels,groups:groups,mpims:mpims};TS.menu.$menu_header.html(TS.templates.menu_channel_picker_header(template_args));TS.menu.$menu_items.html(TS.templates.menu_channel_picker(template_args)).css("max-height",274);TS.menu.$menu_items.on("click.menu","li",item_selected_callback);TS.menu.start(e);_bindChannelFilterStart();TS.kb_nav.setAllowHighlightWithoutBlurringInput(true)},startWithSearchFilter:function(e){if(TS.menu.isRedundantClick(e))return;if(TS.model.menu_is_showing)return;_buildIfNeeded();var template_args={search_exclude_bots:TS.model.prefs.search_exclude_bots,search_only_my_channels:TS.model.prefs.search_only_my_channels,result_type:TS.search.filter==="messages"?"messages":"files"};TS.menu.clean();TS.menu.$menu_header.addClass("hidden").empty();TS.menu.$menu.addClass("search_filter_menu");TS.menu.$menu_items.html(TS.templates.menu_search_filter_items(template_args));TS.menu.start(e);_convertToPopoverMenu();var $menu_anchor=$("#search_filter_menu_label");TS.menu.positionAt($menu_anchor,-8,$menu_anchor.height()+10);$("#search_only_my_channels_cb").bind("change",function(){TS.prefs.setPrefByAPI({name:"search_only_my_channels",value:!$(this).prop("checked")})});$("#search_exclude_bots_cb").bind("change",function(){TS.prefs.setPrefByAPI({name:"search_exclude_bots",value:!$(this).prop("checked")})});TS.menu.search_filter_is_showing=true;$("#search_filter_menu_label").addClass("active")},startWithMentionsFilter:function(e){if(TS.menu.isRedundantClick(e))return;if(TS.model.menu_is_showing)return;_buildIfNeeded();var template_args={exclude_at_channels:TS.model.prefs.mentions_exclude_at_channels,exclude_at_user_groups:TS.model.prefs.mentions_exclude_at_user_groups,show_user_group_filter:TS.boot_data.feature_subteams};TS.menu.clean();TS.menu.$menu_header.addClass("hidden").empty();TS.menu.$menu.addClass("search_filter_menu");TS.menu.$menu_items.html(TS.templates.menu_mentions_filter_items(template_args));TS.menu.start(e);_convertToPopoverMenu();var $menu_anchor=$("#mentions_filter_menu_label");TS.menu.positionAt($menu_anchor,-8,$menu_anchor.height()+10);$("#exclude_at_channels_cb").bind("change",function(){TS.prefs.setPrefByAPI({name:"mentions_exclude_at_channels",value:!$(this).prop("checked")})});$("#exclude_at_user_groups_cb").bind("change",function(){TS.prefs.setPrefByAPI({name:"mentions_exclude_at_user_groups",value:!$(this).prop("checked")})});$("#mentions_filter_menu_label").addClass("active")},startWithEditTeamProfileListActions:function(e,onclick){if(TS.menu.isRedundantClick(e))return;if(TS.model.menu_is_showing)return;_buildIfNeeded();var $el=$(e.target);var field=TS.team.getTeamProfileFieldById($el.data("id"));var template_args={id:field.id,hidden:!!(field&&field.is_hidden)};TS.menu.clean();TS.menu.$menu_header.addClass("hidden").empty();TS.menu.$menu_items.html(TS.templates.admin_menu_edit_team_profile_list_action_items(template_args));TS.menu.$menu_items.on("click.menu","li",onclick);TS.menu.start(e);TS.menu.positionAt($el.find('[data-action="edit_team_profile_list_menu"]'),-(TS.menu.$menu.width()+6),0);TS.menu.keepInBounds()},startWithEditMemberProfilePhotoActions:function(e,onclick){if(TS.menu.isRedundantClick(e))return;if(TS.model.menu_is_showing)return;_buildIfNeeded();var $el=$(e.target);var is_button=$el.is(".btn");var template_args={show_delete:!!TS.model.user.profile.image_original&&!is_button,is_iOS:TS.model.is_iOS};TS.menu.clean();TS.menu.$menu_header.addClass("hidden").empty();TS.menu.$menu_items.html(TS.templates.menu_edit_member_profile_photo_action_items(template_args));TS.menu.$menu_items.on("click.menu","li",onclick);TS.menu.start(e);if(is_button){TS.menu.positionAt($el,0,$el.outerHeight()+5)}else{TS.menu.positionAt($el.closest('[data-action="edit_member_profile_photo_menu"]'),36,156)}TS.menu.keepInBounds()},startWithEnterpriseMemberHeader:function(e){var SPACING_BETWEEN_TARGET_AND_MENU=15;if(TS.menu.isRedundantClick(e))return;if(TS.model.menu_is_showing)return;_buildIfNeeded();TS.menu.clean();var template_args={enterprise_name:$("[data-enterprise-name]").val(),signout_url:TS.boot_data.signout_url};TS.menu.$menu_header.addClass("hidden").empty();TS.menu.$menu_items.html(TS.templates.menu_enterprise_member_header(template_args));TS.menu.$menu_items.on("click.menu","li",TS.menu.onEnterpriseMemberHeaderClick);TS.kb_nav.setSubmitItemHandler(TS.menu.onEnterpriseMemberHeaderClick);TS.menu.start(e);var $menu_target=$("[data-header-menu-toggle]");var x_offset=-TS.menu.$menu.outerWidth()+$menu_target.outerWidth();var y_offset=$menu_target.outerHeight()+SPACING_BETWEEN_TARGET_AND_MENU;TS.menu.positionAt($menu_target,x_offset,y_offset)},onEnterpriseMemberHeaderClick:function(e){var id=$(this).attr("id");if(id=="sign_out"){return}else if(id=="view_account"){return}else{e.preventDefault();TS.warn("not sure what to do with clicked element id:"+id);return}TS.menu.end()},positionAt:function($el,x_plus,y_plus){x_plus=x_plus||0;y_plus=y_plus||0;var offset=$el.offset();var x=offset.left+x_plus;var y=offset.top+y_plus;TS.menu.$menu.css({top:y,left:x})},isRedundantClick:function(e){if(e&&TS.menu.last_e&&(e.target==TS.menu.last_e.target||e.currentTarget==TS.menu.last_e.currentTarget))return true;return false},isLarge:function(){return TS.menu&&TS.menu.$menu&&TS.menu.$menu.find("li").length>TS.menu.large_dom_trigger},start:function(e,position_by_click){TS.menu.last_e=e;var offset=$(e.target).offset();var x=offset.left+$(e.target).width()+10;var y=offset.top;if(position_by_click){x=e.pageX+10;y=e.pageY+10}$(".tooltip").hide();TS.tips.hideAll();$(e.currentTarget).addClass("active");TS.menu.$target_element=$(e.currentTarget);TS.model.menu_is_showing=true;var $menu=TS.menu.$menu;var is_large_list=TS.menu.isLarge();$menu.css({top:y,left:x});var $menu_items_scroller=$menu.find("#menu_items_scroller");$menu_items_scroller.scrollTop(0);if(TS.ui.fs_modal_file_viewer&&TS.ui.fs_modal_file_viewer.is_showing||TS.boot_data.feature_popover_dismiss_only){$menu.addClass("fsfv_open")}else{$menu.removeClass("fsfv_open")}if(TS.client){$menu.appendTo($("#client-ui"))}else{$menu.appendTo($("body"))}if(!is_large_list){$menu.css("opacity",0);$menu.stop().transition({opacity:1},200)}else{$menu.css("opacity",1)}$menu.find(".menu_close").on("click",TS.menu.end);TS.menu.keepInBounds();var monkey_scroll=$menu_items_scroller.data("monkeyScroll");if(monkey_scroll){var force=true;monkey_scroll.updateFunc(force)}if(TS.menu.menu_lazy_load&&TS.menu.menu_lazy_load.detachEvents){TS.menu.menu_lazy_load.detachEvents()}TS.menu.menu_lazy_load=TS.menu.$menu_items.find(".lazy").lazyload({container:$("#menu_items_scroller"),all_images_same_size:true,throttle:250});$(window).bind("resize",TS.menu.keepInBounds);$(window.document).bind("keydown",TS.menu.onKeyDown);$("html").bind("mousedown touchstart",TS.menu.onMouseDown);if(TS.menu.has_submenu){TS.kb_nav.start($menu.find("#menu_items"),"li:not(.divider)",$menu,{onLeftKeyDownIfSubmenuExists:TS.menu.onLeftKeyDownIfSubmenuExists,onRightKeyDownIfSubmenuExists:TS.menu.onRightKeyDownIfSubmenuExists})}else{TS.kb_nav.start($menu.find("#menu_items"),"li:not(.divider)")}},clean:function(){TS.menu.$menu_footer.empty();TS.menu.$menu_header.removeClass("hidden");TS.menu.$menu.removeClass("no_min_width no_max_width profile_preview flex_menu search_filter_menu popover_menu no_icons team_menu file_menu notifications_menu").css("max-height","");TS.menu.$menu.removeAttr("data-qa");TS.menu.$menu.find("#menu_items_scroller").css("max-height","");TS.menu.$menu.find(".arrow, .arrow_shadow").remove();TS.menu.$menu_items.off("mouseenter.section_header")},end:function(){TS.model.menu_is_showing=false;TS.menu.menu_items_hidden=true;TS.menu.has_submenu=false;var $menu=TS.menu.$menu;var menu_end=function(){if(TS.model.menu_is_showing)return;setTimeout(function(){if(!TS.model.menu_is_showing)TS.menu.last_e=null},50);$menu.detach();TS.menu.$menu_header.empty();TS.menu.$menu_footer.empty();TS.menu.$menu_items.empty();TS.menu.clean()};if(!TS.menu.isLarge()){$menu.stop().transition({opacity:0},200,menu_end)}else{menu_end()}if(TS.menu.$target_element){TS.menu.$target_element.removeClass("active");TS.menu.$target_element=null}if(TS.menu.$secondary_target_element){TS.menu.$secondary_target_element.removeClass("active");TS.menu.$secondary_target_element=null}if(TS.boot_data.feature_mpim_client&&TS.menu.mpim&&TS.menu.mpim.members.length>4){$("#active_channel_name").find(".name").tooltip("enable")}TS.menu.member=null;TS.menu.channel=null;TS.menu.mpim=null;TS.menu.user_group=null;TS.menu.$menu_header.unbind("click.menu");TS.menu.$menu_items.off("click.menu");$(window).unbind("resize",TS.menu.keepInBounds);$(window.document).unbind("keydown",TS.menu.onKeyDown);$("html").unbind("mousedown touchstart",TS.menu.onMouseDown);TS.members.view.team_filter_changed_sig.remove(TS.kb_nav.clearHighlightedItem);TS.members.view.team_filter_changed_sig.remove(TS.menu.filterChanged,TS.menu);$(".file_list_item.active").removeClass("active");TS.tips.unhideAll();TS.menu.search_filter_is_showing=false;$("#search_filter_menu_label").removeClass("active");$("#mentions_filter_menu_label").removeClass("active");$("#flex_menu_toggle").removeClass("menu_open");if(!TS.boot_data.feature_channel_header_refresh){$("#flex_menu_toggle").attr("title","Open Flexpane Menu")}if(_zero_clipboard_client){_zero_clipboard_client.destroy();_zero_clipboard_client=null}setTimeout(function(){TS.menu.file_list_menu_up=false;$(".inline_file_preview_container.file_menu_open, .file_container.file_menu_open").removeClass("file_menu_open")},100);if(TS.menu.menu_lazy_load&&TS.menu.menu_lazy_load.detachEvents){TS.menu.menu_lazy_load.detachEvents();TS.menu.menu_lazy_load=null}TS.kb_nav.end();if(TS.client&&TS.model.ui.active_tab_id!="team"&&TS.model.ui.active_tab_id!="details")TS.client.flex_pane.stopLocalTimeInterval()},onKeyDown:function(e){var keymap=TS.utility.keymap;var key=e.which;var modifier_pressed=e.metaKey||e.ctrlKey||e.altKey;if(key==keymap.esc){e.stopPropagation();e.preventDefault();TS.menu.end();return}else if(!modifier_pressed&&!TS.utility.isArrowKey(key)&&key!=keymap.tab&&key!=keymap.enter){TS.kb_nav.clearHighlightedItem();if(key==keymap.enter){setTimeout(function(){$("#menu_member_dm_input").focus()},0)}else{$("#menu_member_dm_input").focus()}}},onLeftKeyDownIfSubmenuExists:function(e){var prevent_kb_default=false;if(TS.menu.$submenu&&TS.menu.$submenu.hasClass("kb_active")){TS.menu.$submenu.removeClass("kb_active");TS.kb_nav.end();TS.kb_nav.highlightItemWithKey(TS.menu.$submenu_origin);TS.kb_nav.start(TS.menu.$menu.find("#menu_items"),"li:not(.divider)",TS.menu.$menu,{onLeftKeyDownIfSubmenuExists:TS.menu.onLeftKeyDownIfSubmenuExists,onRightKeyDownIfSubmenuExists:TS.menu.onRightKeyDownIfSubmenuExists});TS.menu.$submenu_origin.submenu("destroy");prevent_kb_default=true}return prevent_kb_default},onRightKeyDownIfSubmenuExists:function(e){var prevent_kb_default=false;if(TS.kb_nav.getHighlightedItem()&&TS.kb_nav.getHighlightedItem().data("has-submenu")){if(!TS.menu.$submenu){TS.kb_nav.getHighlightedItem().submenu({items_html:TS.templates.snooze_items(),onclick:TS.menu.onNotificationsMenuItemClick})}}if(TS.menu.$submenu){if(TS.menu.$submenu.hasClass("kb_active")){TS.menu.$submenu.removeClass("kb_active");TS.menu.end()}else{TS.menu.$submenu.addClass("kb_active");TS.kb_nav.end();TS.kb_nav.highlightItemWithKey(TS.menu.$submenu.find("li").first());
TS.kb_nav.start(TS.menu.$submenu.find("ul"),"li:not(.divider)",TS.menu.$submenu,{onLeftKeyDownIfSubmenuExists:TS.menu.onLeftKeyDownIfSubmenuExists,onRightKeyDownIfSubmenuExists:TS.menu.onRightKeyDownIfSubmenuExists})}prevent_kb_default=true}return prevent_kb_default},onMouseDown:function(e){var $target=$(e.target);if($target.closest("#menu, .submenu").length===0||$target.hasClass("popover_mask")){TS.menu.end()}},keepInBounds:function(){if(window.requestAnimationFrame){window.requestAnimationFrame(TS.menu.keepInBoundsThrottled)}else{TS.menu.keepInBoundsThrottled()}},keepInBoundsThrottled:function(){var $menu=TS.menu.$menu;var allowance=10;var rect=$menu.dimensions_rect();var allow_rect={top:0+allowance,right:$(window).width()-allowance,bottom:$(window).height()-(allowance+14),left:0+allowance};if(TS.utility.doesRectContainRect(allow_rect,rect))return;if(rect.left<allow_rect.left){$menu.css("left",allow_rect.left)}else if(rect.right>allow_rect.right){$menu.css("left",Math.max(allow_rect.left,allow_rect.right-rect.width))}if(rect.top<allow_rect.top){$menu.css("top",allow_rect.top)}else if(rect.bottom>allow_rect.bottom){$menu.css("top",Math.max(allow_rect.top,allow_rect.bottom-rect.height+$(window).scrollTop()))}}});var _zero_clipboard_client;var _bindChannelFilterStart=function(){var $none_found=TS.menu.$menu.find(".no_results");var $close_icon=TS.menu.$menu.find(".icon_close");var $filter=TS.menu.$menu.find(".menu_filter");var prev_query="";$close_icon.click(function(){$filter.val("").trigger("change");$filter.focus()});TS.menu.$menu_items.children("li").each(function(){var channel_id=$(this).data("channel-id");if(channel_id){var channel=TS.channels.getChannelById(channel_id);if(channel){$(this).data("name","#"+channel.name)}return}var group_id=$(this).data("group-id");if(group_id){var group=TS.groups.getGroupById(group_id);if(group){$(this).data("name",group.name)}}if(TS.boot_data.feature_mpim_client){var mpim_id=$(this).data("mpim-id");if(mpim_id){var mpim=TS.mpims.getMpimById(mpim_id);if(mpim)$(this).data("mpim",mpim)}}});$filter.on("keyup change paste",TS.utility.debounce(function(e){var query=$(this).val();if(query){if(prev_query!==query){var any_found=false;var name_regex=new RegExp(TS.utility.regexpEscape(query),"i");var prefix_regexes=[];if(TS.boot_data.feature_mpim_client){var queries=query.split(/[,| ]/).filter(function(i){return!!i});for(var i=0;i<queries.length;i++){prefix_regexes.push(new RegExp("^"+TS.utility.regexpEscape(queries[i]),"i"))}}$close_icon.removeClass("hidden");TS.menu.$menu_items.children("li").removeClass("hidden").each(function(){var name=$(this).data("name");var mpim=$(this).data("mpim");if(name){var match=name.match(name_regex);if(match){any_found=true;return}}else if(mpim){if(TS.mpims.checkMpimMatch(mpim,prefix_regexes)){any_found=true;return}}$(this).addClass("hidden")});if(any_found){$none_found.addClass("hidden")}else{$none_found.removeClass("hidden");$none_found.find(".query").text(query)}TS.kb_nav.clearHighlightedItem()}}else{TS.menu.$menu_items.children("li.hidden").removeClass("hidden");$none_found.addClass("hidden");$close_icon.addClass("hidden");if(prev_query!==query){TS.kb_nav.clearHighlightedItem()}}prev_query=query;if(TS.menu.$menu.find("#menu_items_scroller").data("monkeyScroll")){var force=true;TS.menu.$menu.find("#menu_items_scroller").data("monkeyScroll").updateFunc(force)}},250));$filter.focus()};var _convertToPopoverMenu=function(){var $menu=TS.menu.$menu;$menu.addClass("popover_menu");$menu.prepend('<span class="arrow"></span><span class="arrow_shadow"></span>')};var _useZeroClipboard=function(){if(TS.clipboard.canWriteText())return false;if(window.ZeroClipboard&&window.FlashDetect&&FlashDetect.installed)return true;return false};var _initZeroClipboard=function(){if(!_useZeroClipboard())return;ZeroClipboard.config({swfPath:"/img/zc/ZeroClipboard.swf",hoverClass:"highlighted",forceHandCursor:true});_zero_clipboard_client=new ZeroClipboard;_zero_clipboard_client.on("ready",function(){if(_zero_clipboard_client)_zero_clipboard_client.destroy();_zero_clipboard_client=null})};var _handleTopicKeydown=function(e){var keymap=TS.utility.keymap;if(e.which==keymap.enter&&!e.shiftKey&&!e.altKey){var input=$(e.target);var model_ob=TS.shared.getActiveModelOb();var new_val=$.trim(input.val());if(model_ob.topic.value===new_val){TS.menu.end();return}if(model_ob.is_group){TS.groups.setTopic(model_ob.id,new_val)}else if(model_ob.is_channel){TS.channels.setTopic(model_ob.id,new_val)}TS.menu.end()}};var _buildIfNeeded=_.once(function(){var $menu=TS.menu.$menu=$(TS.templates.menu());if(TS.boot_data.app!="mobile"&&TS.qs_args["new_scroll"]!="0"){if(TS.client){$menu.appendTo($("#client-ui"))}else{$menu.appendTo($("body"))}var debug=TS.qs_args["debug_scroll"]=="1";$menu.find("#menu_items_scroller").monkeyScroll({debug:debug});$menu.detach()}TS.menu.$menu_header=$menu.find("#menu_header");TS.menu.$menu_items=$menu.find("#menu_items");TS.menu.$menu_footer=$menu.find("#menu_footer")});$.widget("TS.submenu",{_create:function(){this.element.data("has-submenu",true);var html='<div class="menu submenu" data-origin-id="'+this.element.attr("id")+'"><ul aria-hidden="true" aria-label="submenu">'+this.options.items_html+"</ul></div>";var X_OFFSET=7;var Y_OFFSET=11;var x=TS.menu.$menu.offset().left+TS.menu.$menu.width()+X_OFFSET;var y=this.element.offset().top-Y_OFFSET;this.$submenu=$(html);this.$submenu.appendTo("body");TS.menu.$submenu=this.$submenu;TS.menu.$submenu_origin=this.element;if(x+this.$submenu.width()>window.innerWidth){x=TS.menu.$menu.offset().left-this.$submenu.width()-X_OFFSET}if(y+this.$submenu.height()>window.innerHeight){y=window.innerHeight-this.$submenu.height()-Y_OFFSET}this.$submenu.css({position:"absolute",left:x+"px",top:y+"px"});this.$submenu.on("click",function(e){this.options.onclick(e)}.bind(this))},_destroy:function(){TS.menu.$submenu=null;TS.menu.$submenu_origin=null;this.$submenu.remove()}})})();(function(){"use strict";TS.registerModule("cmd_handlers",{server_cmds:null,onStart:function(){var always_wait=true;_resetUpCmdsThrottled=TS.utility.throttleFunc(_resetUpCmdsThrottled,3e3,always_wait);TS.prefs.team_allow_calls_changed_sig.add(_maybeUpdateCallsCommand)},setUpCmds:function(){if(!TS.boot_data.page_needs_custom_cmds){_maybeUpdateCallsCommand();return Promise.resolve()}var ls_cmds=TS.storage.fetchCmds();if(ls_cmds&&TS.model.commands_cache_ts==ls_cmds.cache_ts){TS.model.did_we_load_with_cmd_cache=true;TS.cmd_handlers.mergeInServerCmds(ls_cmds.data);_maybeUpdateCallsCommand();return Promise.resolve()}var unused_deprecated_handler;var dont_set_active=true;return TS.api.call("commands.list",{},unused_deprecated_handler,dont_set_active).then(function(resp){if(!resp.data.commands){return}TS.model.commands_cache_ts=resp.data.cache_ts;TS.storage.storeCmds({data:resp.data.commands,cache_ts:TS.model.commands_cache_ts});TS.cmd_handlers.mergeInServerCmds(resp.data.commands);_maybeUpdateCallsCommand()}).catch($.noop)},resetUpCmds:function(){TS.storage.storeCmds("");_resetUpCmdsThrottled()},sortNames:function(names){var sorted_names=names.sort(function(a,b){return a.localeCompare(b)});function filterByTypes(names,types){return names.filter(function(name){return types.indexOf(TS.cmd_handlers[name].type)!==-1})}var slack_commands=filterByTypes(sorted_names,["client","core"]);var team_commands=filterByTypes(sorted_names,["custom"]);var app_commands=filterByTypes(sorted_names,["app","service"]);var app_commands_with_name=app_commands.filter(function(name){var cmd=TS.cmd_handlers[name];return!!(cmd.app||cmd.service_name)});app_commands_with_name.sort(function(a,b){var a_cmd=TS.cmd_handlers[a];var b_cmd=TS.cmd_handlers[b];var a_name=a_cmd.service_name||TS.model.apps[a_cmd.app].name;var b_name=b_cmd.service_name||TS.model.apps[b_cmd.app].name;return TS.apps.compareNames(a_name,b_name)});var app_commands_without_name=app_commands.filter(function(name){var cmd=TS.cmd_handlers[name];return!(cmd.app||cmd.service_name)});app_commands_without_name.sort();var flattened=[].concat(slack_commands,team_commands,app_commands_with_name,app_commands_without_name);return flattened},getAppNameForCmdName:function(cmd_name){var cmd=TS.cmd_handlers[cmd_name];if(!cmd)return"";var app_name;if(cmd.app&&TS.model.apps[cmd.app]){app_name=TS.model.apps[cmd.app].name}else if(cmd.service_name){app_name=cmd.service_name}return app_name},mergeInServerCmds:function(cmds){TS.cmd_handlers.server_cmds=cmds;var cmd_name;for(var k in TS.cmd_handlers){if(k.indexOf("/")!==0)continue;if(TS.cmd_handlers[k].type=="client"){delete TS.cmd_handlers[k].override}else{TS.log(65,'mergeInCmds is removing the server command "'+k+'" from cmd_handlers');delete TS.cmd_handlers[k]}}for(cmd_name in cmds){if(cmd_name.indexOf("/")!==0)continue;if(TS.cmd_handlers[cmd_name]){if(TS.cmd_handlers[cmd_name].can_be_overridden_by_server_cmd){TS.log(65,'mergeInCmds is overriding client command "'+cmd_name+'" with a server command')}else{TS.cmd_handlers[cmd_name].override=true;TS.log(65,'mergeInCmds is NOT overwriting a client command for "'+cmd_name+'"');continue}}TS.cmd_handlers[cmd_name]=TS.cmd_handlers.makeInternalCmdObject(cmds[cmd_name])}for(cmd_name in cmds){if(cmd_name.indexOf("/")!==0)continue;if(!TS.cmd_handlers[cmd_name].alias_of)continue;var aliased_to=TS.cmd_handlers[TS.cmd_handlers[cmd_name].alias_of];if(!aliased_to){TS.log(65,'mergeInCmds is NOT adding an alias of "'+cmd_name+'" to "'+TS.cmd_handlers[cmd_name].alias_of+'" because it was not found');continue}if(aliased_to.type=="client"){TS.log(65,'mergeInCmds is NOT adding an alias of "'+cmd_name+'" to "'+TS.cmd_handlers[cmd_name].alias_of+'" because it is not a server command');continue}TS.log(65,'mergeInCmds is adding on alias of "'+cmd_name+'" to "'+TS.cmd_handlers[cmd_name].alias_of+'"');if(!aliased_to.aliases)aliased_to.aliases=[];aliased_to.aliases.push(cmd_name)}},makeInternalCmdObject:function(cmd){return{autocomplete:true,alias_of:cmd.alias_of?cmd.alias_of:null,aliases:null,usage:cmd.usage||"",desc:cmd.desc||"",help_text:cmd.help_text||"",type:cmd.type||"",app:cmd.app||"",service_name:cmd.service_name||""}},addTempEphemeralFeedback:function(text,input_txt){if(input_txt)TS.client.ui.$msg_input.val(input_txt);TS.client.ui.addOrFlashEphemeralBotMsg({text:text,ephemeral_type:"temp_slash_cmd_feedback"})},addEphemeralFeedback:function(text,input_txt){if(input_txt)TS.client.ui.$msg_input.val(input_txt);TS.utility.msgs.removeAllEphemeralMsgsByType("temp_slash_cmd_feedback",TS.model.active_cid);TS.client.ui.addEphemeralBotMsg({text:text})},runCommand:function(cmd,rest,words,e,in_reply_to_msg,model_ob){if(!TS.cmd_handlers[cmd])return;if(TS.model.last_active_cid){TS.utility.msgs.removeAllEphemeralMsgsByType("temp_slash_cmd_feedback",TS.model.last_active_cid)}TS.cmd_handlers[cmd].func(cmd,rest,words,e,in_reply_to_msg,model_ob)},"/status":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.members.setUserStatus(rest)}},"/away":{type:"client",autocomplete:true,alias_of:null,aliases:null,desc:'Toggle your "away" status',func:function(cmd,rest,words,e,in_reply_to_msg){TS.members.toggleUserPresence().then(function(){TS.cmd_handlers.addEphemeralFeedback(":white_check_mark: You are now marked as *"+TS.model.user.presence+"*.")}).catch($.noop);if(rest)TS.members.setUserStatus(rest)}},"/prefs":{type:"client",autocomplete:true,alias_of:null,aliases:null,desc:"Open the preferences dialog",func:function(cmd,rest,words,e,in_reply_to_msg){TS.ui.prefs_dialog.start()}},"/shortcuts":{type:"client",autocomplete:true,alias_of:null,aliases:["/keys"],desc:"Open the keyboard shortcuts dialog",func:function(cmd,rest,words,e,in_reply_to_msg){TS.ui.shortcuts_dialog.start()}},"/keys":{type:"client",autocomplete:true,alias_of:"/shortcuts",aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.cmd_handlers["/shortcuts"].func(cmd,rest,words,e)}},"/open":{type:"client",autocomplete:true,alias_of:null,aliases:["/join"],desc:"Open a channel",args:[{name:"channel",optional:true}],func:function(cmd,rest,words,e,in_reply_to_msg){if(words.length==1){TS.ui.channel_browser.start()}else{var channel_name=TS.utility.cleanChannelName(rest);var channel=TS.channels.getChannelByName(channel_name);var group=TS.groups.getGroupByName(channel_name);if(channel){if(channel.is_member){TS.channels.displayChannel(channel.id)}else if(!TS.model.user.is_restricted){TS.channels.join(channel.name)}}else if(group){if(!group.is_archived||group.was_archived_this_session){TS.groups.displayGroup(group.id)}}else{if(TS.members.canUserCreateChannels()){TS.ui.new_channel_modal.start(channel_name)}else{TS.cmd_handlers.addEphemeralFeedback("I couldn't find a channel named \""+channel_name+'", sorry :disappointed:')}}}}},"/join":{type:"client",autocomplete:true,alias_of:"/open",aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.cmd_handlers["/open"].func(cmd,rest,words,e)}},"/msg":{type:"client",autocomplete:true,alias_of:null,aliases:["/dm"],desc:"Send a DM message to another user",args:[{name:"@user",optional:false},{name:"your message",optional:true}],func:function(cmd,rest,words,e,in_reply_to_msg){var name=words.length>1?words[1]:"";var m=TS.members.getMemberByName(name);var c_or_g;if(!m){if(name){var c_name=name.replace("#","");c_or_g=TS.channels.getChannelByName(c_name);if(!c_or_g)c_or_g=TS.groups.getGroupByName(c_name);if(!c_or_g){TS.cmd_handlers.addTempEphemeralFeedback("A valid team member name is required.",cmd+" "+rest);return}}else{$("#direct_messages_header").trigger("click.open_dialog").scrollintoview({duration:500})}}var text_to_send=rest.replace(name,"");if(m){if(m.deleted){TS.cmd_handlers.addTempEphemeralFeedback("That user has been deactivated :disappointed:",cmd+" "+rest);return}TS.ims.startImByMemberId(m.id,false,text_to_send)}else if(c_or_g){if(c_or_g.is_archived){TS.cmd_handlers.addTempEphemeralFeedback("That "+(c_or_g.is_channel?"channel":TS.templates.builders.groupCopy())+" has been archived :disappointed:");return}if(c_or_g.is_channel){TS.channels.displayChannel(c_or_g.id,text_to_send)}else{TS.groups.displayGroup(c_or_g.id,text_to_send)}}}},"/invite":{type:"client",autocomplete:true,alias_of:null,aliases:null,desc:"Invite another member to a channel",args:[{name:"@user",optional:false},{name:"channel",optional:true}],func:function(cmd,rest,words,e,in_reply_to_msg){var name=words.length>1?words[1]:"";var m=TS.members.getMemberByName(name);var ug;if(TS.boot_data.feature_subteams&&name){ug=TS.user_groups.getUserGroupsByHandle(name)}if(!m&&!ug&&name){TS.cmd_handlers.addTempEphemeralFeedback("A valid team member name is required.",cmd+" "+rest);return}if(m&&m.deleted){TS.cmd_handlers.addTempEphemeralFeedback("That user has been deactivated :disappointed:",cmd+" "+rest);return}if(m&&m.is_ultra_restricted){TS.cmd_handlers.addTempEphemeralFeedback(TS.utility.htmlEntities(name)+" is a single channel guest.",cmd+" "+rest);return}var channel_name=words.length>2?words[2]:"";if(channel_name){if(!m&&!ug){TS.cmd_handlers.addTempEphemeralFeedback("A valid channel name is required.",cmd+" "+rest);return}var c=TS.channels.getChannelByName(channel_name);var g=TS.groups.getGroupByName(channel_name);if(c){if(m){if(c.members.indexOf(m.id)!==-1){TS.cmd_handlers.addTempEphemeralFeedback("@"+m.name+" is already in this channel.",cmd+" "+rest);return}TS.api.call("channels.invite",{channel:c.id,user:m.id})}if(TS.boot_data.feature_subteams&&ug){var users_to_invite=ug.users.filter(function(member_id){return c.members.indexOf(member_id)===-1});users_to_invite.forEach(function(member_id){TS.api.call("channels.invite",{channel:c.id,user:member_id})})}}else if(g){if(m){if(g.members.indexOf(m.id)!==-1){TS.cmd_handlers.addTempEphemeralFeedback("@"+m.name+" is already in this group.",cmd+" "+rest);return}TS.ui.invite.showInviteMembersPreSelected(g.id,[m.id])}if(TS.boot_data.feature_subteams&&ug){var users_to_invite=ug.users.filter(function(member_id){return g.members.indexOf(member_id)===-1});TS.ui.invite.showInviteMembersPreSelected(g.id,users_to_invite)}}else{TS.cmd_handlers.addTempEphemeralFeedback("A valid channel name is required.",cmd+" "+rest);return}}else{if(TS.model.active_channel_id){if(m){var channel=TS.channels.getChannelById(TS.model.active_channel_id);if(channel&&channel.members.indexOf(m.id)!==-1){TS.cmd_handlers.addTempEphemeralFeedback("@"+m.name+" is already in this channel.",cmd+" "+rest);return}TS.api.call("channels.invite",{channel:TS.model.active_channel_id,user:m.id})}else if(TS.boot_data.feature_subteams&&ug){var channel=TS.channels.getChannelById(TS.model.active_channel_id);if(channel){var users_to_invite=ug.users.filter(function(member_id){return channel.members.indexOf(member_id)===-1});users_to_invite.forEach(function(member_id){TS.api.call("channels.invite",{channel:TS.model.active_channel_id,user:member_id})})}}else{if(e&&e.which==TS.utility.keymap.enter){$(window.document).bind("keyup.wait_for_invite",function(e){TS.ui.channel_invite_modal.startInviteToChannelModal(TS.model.active_channel_id);$(window.document).unbind("keyup.wait_for_invite")})}else{TS.ui.channel_invite_modal.startInviteToChannelModal(TS.model.active_channel_id)}}}else if(TS.model.active_group_id){if(m){var group=TS.groups.getGroupById(TS.model.active_group_id);if(group&&group.members.indexOf(m.id)!==-1){TS.cmd_handlers.addTempEphemeralFeedback("@"+m.name+" is already in this group.",cmd+" "+rest);return}TS.ui.invite.showInviteMembersPreSelected(TS.model.active_group_id,[m.id])}else if(TS.boot_data.feature_subteams&&ug){var group=TS.groups.getGroupById(TS.model.active_group_id);if(group){var users_to_invite=ug.users.filter(function(member_id){return group.members.indexOf(member_id)===-1});TS.ui.invite.showInviteMembersPreSelected(TS.model.active_group_id,users_to_invite)}}else{if(e&&e.which==TS.utility.keymap.enter){$(window.document).bind("keyup.wait_for_invite",function(e){TS.ui.channel_invite_modal.startInviteToChannelModal(TS.model.active_group_id);$(window.document).unbind("keyup.wait_for_invite")})}else{TS.ui.channel_invite_modal.startInviteToChannelModal(TS.model.active_group_id)}}}else if(TS.model.active_mpim_id){var mpim=TS.mpims.getMpimById(TS.model.active_mpim_id);if(m){TS.ui.im_browser.startWithMpim(mpim,[m.id])}else{TS.ui.im_browser.startWithMpim(mpim)}}else{TS.cmd_handlers.addTempEphemeralFeedback("A valid channel name is required.",cmd+" "+rest);return}}}},"/invite_people":{type:"client",autocomplete:true,alias_of:null,aliases:null,desc:"Invite people to your Slack team",args:[{name:"name@domain.com, ...",optional:true}],func:function(cmd,rest,words,e,in_reply_to_msg){if(TS.ui.admin_invites.canInvite()){rest=rest&&rest.trim();if(rest){TS.ui.admin_invites.populateInvites(rest.split(/\s*,\s*|\s+/).map(function(word){return{email:word}}))}TS.ui.admin_invites.start()}else{TS.cmd_handlers.addTempEphemeralFeedback("You don't have permission to invite people.")}}},"/dm":{type:"client",autocomplete:true,alias_of:"/msg",aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.cmd_handlers["/msg"].func(cmd,rest,words,e)}},"/archive":{type:"client",autocomplete:true,alias_of:null,aliases:null,desc:"Archive the current channel",func:function(cmd,rest,words,e,in_reply_to_msg){var model_ob=TS.shared.getActiveModelOb();if(model_ob.is_archived||model_ob.is_general)return;if(TS.model.active_channel_id){if(!TS.members.canUserArchiveChannels())return;var channel=TS.channels.getChannelById(TS.model.active_channel_id);TS.channels.ui.showArchiveChannelDialog(channel)}else if(TS.model.active_group_id){if(TS.model.user.is_restricted)return;var group=TS.groups.getGroupById(TS.model.active_group_id);TS.channels.ui.showArchiveGroupDialog(group)}}},"/leave":{type:"client",autocomplete:true,alias_of:null,aliases:["/close","/part"],desc:"Leave a channel or DM",func:function(cmd,rest,words,e,in_reply_to_msg){if(words.length==1){var model_ob=TS.shared.getActiveModelOb();if(TS.model.active_channel_id){if(model_ob.is_archived){TS.channels.closeArchivedChannel(TS.model.active_channel_id)}else{TS.channels.leave(TS.model.active_channel_id)}}else if(TS.model.active_im_id){TS.ims.closeIm(TS.model.active_im_id)}else if(TS.boot_data.feature_mpim_client&&TS.model.active_mpim_id){TS.mpims.closeMpim(TS.model.active_mpim_id)}else if(TS.model.active_group_id){if(model_ob.is_archived){TS.shared.closeArchivedChannel(model_ob.id)}else{TS.groups.leave(model_ob.id)}}else{TS.cmd_handlers.addTempEphemeralFeedback("A valid channel or team member name is required.")}}else{var channel=TS.channels.getChannelByName(rest);if(channel){TS.channels.leave(channel.id)}else{TS.cmd_handlers.addTempEphemeralFeedback("A valid channel name is required.")}}}},"/close":{type:"client",autocomplete:true,alias_of:"/leave",aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.cmd_handlers["/leave"].func(cmd,rest,words,e)}},"/part":{type:"client",autocomplete:true,alias_of:"/leave",aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.cmd_handlers["/leave"].func(cmd,rest,words,e)}},"/topic":{type:"client",autocomplete:true,alias_of:null,aliases:null,desc:"Set the channel topic",args:[{name:"new topic",optional:true}],func:function(cmd,rest,words,e,in_reply_to_msg){if(TS.model.user.is_restricted||TS.shared.getActiveModelOb().is_general&&!TS.members.canUserPostInGeneral()){TS.cmd_handlers.addTempEphemeralFeedback("Setting the topic is a restricted action.",cmd+" "+rest);return}if(rest.length>TS.model.channel_topic_max_length){TS.cmd_handlers.addTempEphemeralFeedback("Topics cannot exceed "+TS.model.channel_topic_max_length+" characters.",cmd+" "+rest);return}if(TS.model.active_channel_id){if(rest){TS.channels.setTopic(TS.model.active_channel_id,rest)}else{$("#active_channel_name .name, #group_actions").trigger("click.channel_actions");$("#menu_channel_topic_input").focus().select()}}else if(TS.model.active_group_id){if(rest){TS.groups.setTopic(TS.model.active_group_id,rest)}else{$("#active_channel_name .name, #group_actions").trigger("click.channel_actions");$("#menu_channel_topic_input").focus().select()}}else{TS.cmd_handlers.addTempEphemeralFeedback("Regrettably, DMs do not have topics :disappointed:")}}},"/togglethemes":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.prefs.setPrefByAPI({name:"messages_theme",value:TS.model.prefs.messages_theme=="light_with_avatars"?"dense":"light_with_avatars"})}},"/search":{type:"client",autocomplete:false,alias_of:null,aliases:["/s"],desc:"Perform a search",args:[{name:"your text",optional:true}],func:function(cmd,rest,words,e,in_reply_to_msg){var $input=$("#search_terms");TS.client.ui.openFlexTab("search");TS.view.resizeManually("TS.search.view.showResults");$input.autocomplete("preventMenuOnNextFocus");$input.val(rest).removeClass("placeholder").focus();$input.closest("form").submit()}},"/s":{type:"client",autocomplete:true,alias_of:"/search",aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.cmd_handlers["/search"].func(cmd,rest,words,e)}},"/rename":{type:"client",autocomplete:true,alias_of:null,aliases:null,desc:"Rename a channel",args:[{name:"new name",optional:true}],func:function(cmd,rest,words,e,in_reply_to_msg){if(TS.model.user.is_restricted){TS.cmd_handlers.addTempEphemeralFeedback("You don't have permission to rename.");return}if(!TS.model.active_channel_id&&!TS.model.active_group_id){TS.cmd_handlers.addTempEphemeralFeedback("IM channels cannot be renamed :disappointed:");return}var model_ob=TS.shared.getActiveModelOb();if(TS.model.active_channel_id||TS.model.active_group_id){if(!TS.model.user.is_admin&&model_ob.creator!=TS.model.user.id){TS.cmd_handlers.addTempEphemeralFeedback("Only team admins (or the channel creator) are allowed to rename channels. :disappointed:");return}}TS.ui.channel_create_dialog.start(TS.utility.htmlEntities(rest)||model_ob.name,model_ob)}},"/trigger_w":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.model.collapse_trigger_w=parseInt(rest);alert("collapse_trigger_w = "+TS.model.collapse_trigger_w)}},"/beep":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.sounds.play("new_message")}},"/upload":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){var blob=TS.utility.base64StrtoBlob(rest);TS.client.ui.file_pasted_sig.dispatch(blob)}},"/colors":{type:"client",autocomplete:false,alias_of:null,aliases:["/colours"],desc:"View any custom colors you have set for other members",func:function(cmd,rest,words,e,in_reply_to_msg){var members=TS.members.getMembersForUser();var member;var str="";for(var i=0;i<members.length;i++){member=members[i];if(member.member_color!=member.color){str+=member.name+": "+member.member_color+"\n"}}TS.cmd_handlers.addEphemeralFeedback(str?"You have overridden colors as follows:\n"+str:"No user color overrides have been set.")}},"/colours":{type:"client",autocomplete:true,alias_of:"/colors",aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.cmd_handlers["/colors"].func(cmd,rest,words,e)}},"/color":{type:"client",autocomplete:false,alias_of:null,aliases:["/colour"],desc:"Set a custom color for another member",func:function(cmd,rest,words,e,in_reply_to_msg){var name=words.length>1?words[1]:"";var color=words.length>2?words[2].replace(/\#/g,""):"";var m=TS.members.getMemberByName(name);if(!m){TS.cmd_handlers.addTempEphemeralFeedback("A valid team member name is required.",cmd+" "+rest);return}if(color&&(color.length!=6||!("#"+color).match(TS.format.hex_rx))){TS.cmd_handlers.addTempEphemeralFeedback("A valid 6 character hex code is required, like `FF0000`.",cmd+" "+rest);return}TS.members.setMemberUserColor(m,color);TS.model.prefs.user_colors=JSON.stringify(TS.model.user_colors);TS.prefs.setPrefByAPI({name:"user_colors",value:TS.model.prefs.user_colors});if(color){TS.cmd_handlers.addEphemeralFeedback("You've set your custom color for @"+m.name+" to #"+color)}else{TS.cmd_handlers.addEphemeralFeedback("You've removed your custom color for @"+m.name+".")}}},"/colour":{type:"client",autocomplete:true,alias_of:"/color",aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.cmd_handlers["/color"].func(cmd,rest,words,e)}},"/colortest":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){var colors=null;if(rest){try{colors=JSON.parse(rest)}catch(ex){TS.cmd_handlers.addTempEphemeralFeedback("Not a good value for colors: "+rest);return}}if(!colors||!colors.length){colors=["#DDCFFA","#2EF645","#F38303","#E702AE","#3C986D","#9D6158","#F43368","#97C10A","#7491F9","#9E63A3","#FACE41","#35A5CC","#39A93E","#4FECA8","#CA5B34","#E2A974","#2BCFCB","#F89BA7","#89868A","#6A7841","#ADC498","#B1DBDD","#B849C3","#9CDB81","#E72F36","#A16A28","#F68CCF","#317C84","#58851C","#FC4A97","#5774BB","#97B7FE","#C64D97","#CB4A5C","#F68B6B","#81EE4F","#B7ED6D","#756D8E","#3AED69","#81E7FB","#91ECB7","#ED8947","#57AF19","#28BC89","#4A9788","#D645DF","#B498FE","#71C8F9","#C07B1D","#16BD60","#EFCAE3","#A4E0BB","#478AAF","#59953E","#886CA7","#F0C3F1","#29AF70","#80A5F8","#636BB8"]}var i;for(i=0;i<colors.length;i++){colors[i]=colors[i].replace("#","")}var members=TS.members.getMembersForUser();for(i=0;i<members.length;i++){TS.members.setMemberUserColor(members[i],colors[TS.utility.randomInt(0,colors.length-1)])}}},"/discon":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.ms.disconnect()}},"/sleep":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.ms.sleep()}},"/wake":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.ms.wake()}},"/discon2":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.model.break_token=true;TS.ms.disconnect()}},"/discon3":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.model.break_reconnections=true;TS.ms.disconnect()}},"/overloaddontdothiseverpleaseyouwillbesorry":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){if(TS.model.user.is_restricted)return;var count=rest||10;var i=0;var ms=TS.members.getActiveMembersWithSelfAndNotSlackbot();var interv=setInterval(function(){i++;TS.ms.msg_handlers.message({channel:TS.channels.getGeneralChannel().id,type:"message",user:ms[TS.utility.randomInt(0,ms.length-1)].id,ts:TS.utility.date.makeTsStamp(null,"0"),text:"overload #"+i});if(i>=count)clearInterval(interv)},0)}},"/babbledontdothiseverpleaseyouwillbesorry":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){if(TS.model.team.domain!=="tinyspeck")return;var ipsum=TS.utility.msgs.ipsum();var i=1;var count=rest;var speak_interval;var speak=function(){var lorem="("+i+") "+ipsum[TS.utility.randomInt(0,ipsum.length-1)];var post_message=true;if(parseInt(count)){if(i>parseInt(count)){clearInterval(speak_interval);post_message=false}}if(post_message){if(TS.model.active_channel_id){TS.channels.sendMsg(TS.model.active_channel_id,lorem)}else if(TS.model.active_im_id){TS.ims.sendMsg(TS.model.active_im_id,lorem)}else if(TS.model.active_group_id){TS.groups.sendMsg(TS.model.active_group_id,lorem)}}i++};if(parseInt(count)){speak();speak_interval=setInterval(speak,1e3)}else{if(confirm("You sure you want to do this? It will put a lot of crap messages into this channel, y'know? Also, it can't be stopped without a reload.")){speak();speak_interval=setInterval(speak,1e3)}}}},"/msg_replies":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){if(!TS.boot_data.feature_message_replies)return;var msg_replies=TS.utility.parseJSONOrElse(TS.model.prefs.msg_replies,{});var accepted_options_msg="Accepted options are: flexpane.";switch(rest){case"flexpane":msg_replies.flexpane=true;TS.cmd_handlers.addTempEphemeralFeedback("OK, using flexpane for conversations.");break;case"":var current_mode="flexpane";TS.cmd_handlers.addTempEphemeralFeedback(accepted_options_msg+" Your current mode is "+current_mode+".");break;default:TS.cmd_handlers.addTempEphemeralFeedback("Unknown msg_replies pref. "+accepted_options_msg);break}TS.prefs.setPrefByAPI({name:"msg_replies",value:JSON.stringify(msg_replies)})}},"/emo":{type:"client",autocomplete:false,alias_of:null,aliases:["/emote","/emoji"],desc:"",func:function(cmd){var e={target:$("#message-form")};TS.emoji_menu.startEmo(e)}},"/emoji":{type:"client",autocomplete:false,alias_of:"/emo",aliases:null,desc:"",func:function(cmd){TS.cmd_handlers["/emo"].func(cmd)}},"/emote":{type:"client",autocomplete:false,alias_of:"/emo",aliases:null,desc:"",func:function(cmd){TS.cmd_handlers["/emo"].func(cmd)}},"/editlast":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"Edit the last message you posted",func:function(cmd,rest,words,e,in_reply_to_msg){var model_ob=TS.shared.getActiveModelOb();if(!model_ob){return}rest=$.trim(rest);if(!rest){TS.cmd_handlers.addTempEphemeralFeedback("You must enter some text!",cmd+" "+rest);return}var msg=TS.utility.msgs.getEditableMsgByProp("user",TS.model.user.id,model_ob.msgs);if(!msg){TS.cmd_handlers.addTempEphemeralFeedback("Found no recent messages from you to edit :disappointed:",cmd+" "+rest);return}TS.msg_edit.commitEdit(msg,TS.shared.getActiveModelOb(),rest)}},"/deletelast":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"Delete the last message you posted",func:function(cmd,rest,words,e,in_reply_to_msg){
var model_ob=TS.shared.getActiveModelOb();if(!model_ob){return}var msg=TS.utility.msgs.getEditableMsgByProp("user",TS.model.user.id,model_ob.msgs);if(!msg){TS.cmd_handlers.addTempEphemeralFeedback("Found no recent messages from you to delete :disappointed:");return}TS.msg_edit.startDelete(msg.ts)}},"/collapse":{type:"client",autocomplete:true,alias_of:null,aliases:null,desc:"Collapse all files in the current channel (opposite of /expand)",func:function(cmd,rest,words,e,in_reply_to_msg){TS.inline_imgs.collapseAllInCurrent();TS.inline_videos.collapseAllInCurrent();TS.inline_attachments.collapseAllInCurrent();TS.inline_audios.collapseAllInCurrent();TS.inline_others.collapseAllInCurrent();TS.inline_file_previews.collapseAllInCurrent();TS.cmd_handlers.addEphemeralFeedback("I've collapsed all files in this channel for you.")}},"/expand":{type:"client",autocomplete:true,alias_of:null,aliases:null,desc:"Expand all files in the current channel (opposite of /collapse)",func:function(cmd,rest,words,e,in_reply_to_msg){TS.inline_imgs.expandAllInCurrent();TS.inline_videos.expandAllInCurrent();TS.inline_attachments.expandAllInCurrent();TS.inline_audios.expandAllInCurrent();TS.inline_others.expandAllInCurrent();TS.inline_file_previews.expandAllInCurrent();TS.cmd_handlers.addEphemeralFeedback("I've expanded all files in this channel for you.")}},"/attach_align":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){$("body").toggleClass("attachments_flush_with_avatar")}},"/attach_thumb_align":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){window.attach_thumb_align_title=!window.attach_thumb_align_title;TS.client.msg_pane.rebuildMsgs()}},"/remove":{type:"client",autocomplete:true,alias_of:null,aliases:["/kick"],desc:"Remove a person from the current channel",args:[{name:"@user",optional:false}],func:function(cmd,rest,words,e,in_reply_to_msg){if(TS.model.active_channel_id&&!TS.members.canUserKickFromChannels()){TS.cmd_handlers.addTempEphemeralFeedback("Removing from channels is a restricted action.");return}if(TS.model.active_group_id&&!TS.members.canUserKickFromGroups()){TS.cmd_handlers.addTempEphemeralFeedback("Removing from "+TS.templates.builders.groupCopy()+"s is a restricted action.");return}if(TS.model.active_im_id||TS.model.active_mpim_id){TS.cmd_handlers.addTempEphemeralFeedback("You can't remove someone from a DM.");return}var model_ob=TS.shared.getActiveModelOb();if(model_ob.is_archived){TS.cmd_handlers.addTempEphemeralFeedback("You can't remove anyone from *"+(TS.model.active_channel_id?"#":"")+model_ob.name+"* while it is archived.");return}rest=$.trim(rest);if(!rest){TS.cmd_handlers.addTempEphemeralFeedback("Please specify someone to remove!",cmd+" "+rest);return}var member=TS.members.getMemberByName(rest);if(!member){TS.cmd_handlers.addTempEphemeralFeedback("*"+TS.utility.htmlEntities(rest)+"* is not a recognized member name.",cmd+" "+rest);return}if(model_ob.is_general&&!member.is_restricted&&!member.is_bot){TS.cmd_handlers.addTempEphemeralFeedback("You can't remove this member from *"+(TS.model.active_channel_id?"#":"")+model_ob.name+"*!");return}if(model_ob.members.indexOf(member.id)==-1){TS.cmd_handlers.addTempEphemeralFeedback("*"+TS.utility.htmlEntities(rest)+"* is not a member of this "+(TS.model.active_channel_id?"channel":TS.templates.builders.groupCopy())+".",cmd+" "+rest);return}if(member.is_self){TS.client.ui.onSubmit("/leave");return}if(TS.model.active_channel_id){TS.channels.kickMember(TS.model.active_channel_id,member.id)}else if(TS.model.active_group_id){TS.groups.kickMember(TS.model.active_group_id,member.id)}else{return}}},"/kick":{type:"client",autocomplete:true,alias_of:"/remove",aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.cmd_handlers["/remove"].func(cmd,rest,words,e)}},"/feedback":{type:"client",autocomplete:true,alias_of:null,aliases:null,desc:"Send feedback to Slack",args:[{name:"your message",optional:false}],func:function(cmd,rest,words,e,in_reply_to_msg){if(!rest){TS.cmd_handlers.addTempEphemeralFeedback("Looks like you are trying to send us some feedback, but you didn't say anything!",cmd+" "+rest);return}TS.generic_dialog.start({title:"Send feedback",body:'<p class="bold">Looks like you are trying to send us some feedback! Yes?</p>',show_cancel_button:true,show_go_button:true,go_button_text:"Yes, send it",onGo:function(){TS.api.call("chat.command",{agent:"webapp",command:cmd,text:rest,channel:TS.model.active_cid},TS.client.ui.onAPICommand)},onCancel:function(){TS.client.ui.$msg_input.val(cmd+" "+rest)}})}},"/shrug":{type:"client",autocomplete:true,alias_of:null,aliases:null,desc:"Appends \\_()_/ to your message",args:[{name:"your message",optional:true}],func:function(cmd,rest,words,e,in_reply_to_msg,model_ob){var txt=rest||"";if(txt&&txt.substr(txt.length-1)!=" "){txt+=" "}txt+="\\_()_/ ";if(!model_ob)model_ob=TS.shared.getActiveModelOb();if(model_ob.is_channel){TS.channels.sendMsg(model_ob.id,txt,in_reply_to_msg)}else if(model_ob.is_im){TS.ims.sendMsg(model_ob.id,txt,in_reply_to_msg)}else if(model_ob.is_group&&!model_ob.is_mpim){TS.groups.sendMsg(model_ob.id,txt,in_reply_to_msg)}else if(model_ob.is_mpim){TS.mpims.sendMsg(model_ob.id,txt,in_reply_to_msg)}}},"/showfallbacks":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.model.show_attachment_fallback=!TS.model.show_attachment_fallback;TS.client.msg_pane.rebuildMsgs()}},"/macgap.app.enableDeveloperTools()":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){if(window.macgap&&window.macgap.app&&window.macgap.app.enableDeveloperTools){macgap.app.enableDeveloperTools()}}},"/toggle_debugging_prefs":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.ui.prefs_dialog.start("advanced","#prefs_debug")}}});var _resetUpCmdsThrottled=function(){TS.cmd_handlers.setUpCmds()};var _maybeUpdateCallsCommand=function(){if(!TS.boot_data.feature_calls){return}if(TS.cmd_handlers["/call"]&&TS.cmd_handlers["/call"].type!="client"){return}if(!TS.utility.calls.isEnabled()){return}TS.cmd_handlers["/call"]={type:"client",autocomplete:true,alias_of:null,aliases:null,desc:"Start a call",args:[{name:"help",optional:true}],can_be_overridden_by_server_cmd:true,func:function(cmd,rest,words,e,in_reply_to_msg){var model_ob=TS.shared.getActiveModelOb();var member=TS.members.getMemberById(model_ob.user);if(TS.boot_data.feature_shared_channels_ui){var team=TS.model.team;if(model_ob.is_shared||member&&team&&member.team_id!==team.id){TS.cmd_handlers.addTempEphemeralFeedback("You are not allowed to use this command here.");return}}if(rest.trim()=="help"){if(TS.utility.calls.isCurrentContextMultiParty()&&!TS.utility.calls.isMultiPartyEnabled()){TS.cmd_handlers.addTempEphemeralFeedback("To call a teammate, use `/call` from your Direct Message conversation with that person.");return}var help_message;if(model_ob.is_mpim){help_message="To call "+TS.shared.getDisplayNameForModelOb(model_ob)+", use `/call` in this group conversation."}else if(model_ob.is_im){help_message="To call "+TS.shared.getDisplayNameForModelOb(model_ob)+", use `/call` in this Direct Message conversation."}else{help_message="To start a call in "+TS.shared.getDisplayNameForModelOb(model_ob)+", use `/call` here"}TS.cmd_handlers.addTempEphemeralFeedback(help_message);return}if(TS.utility.calls.isCurrentContextMultiParty()&&!TS.utility.calls.isMultiPartyEnabled()){TS.cmd_handlers.addTempEphemeralFeedback("Group calls aren't available on the free plan. Try using `/call` in a Direct Message conversation!");return}else if(model_ob.is_slackbot_im){var slackbot_responses=["I'm on the other line. Sorry!","Thanks for calling me! I'm afraid I only accept calls from my mother, Sundays at 2pm.","I'm washing my hair right nowcan't come to the phone!","It's awfully nice of you to try calling me. But  shh!  I'm quite afraid of the phone! :grimacing:","Thank you so much for calling, but I can't talk right now, I'm watching my stories."];var random_slackbot_response=_.shuffle(slackbot_responses)[0];TS.cmd_handlers.addTempEphemeralFeedback(random_slackbot_response);return}else if(member&&member.is_bot){TS.cmd_handlers.addTempEphemeralFeedback("Unfortunately, "+TS.members.getMemberDisplayName(member,false,true)+" is busy right now, and can't answer your call.");return}TS.utility.calls.startCallInModelOb(model_ob)}}}})();(function(){"use strict";TS.registerModule("stars",{member_stars_fetched_sig:new signals.Signal,member_stars_being_fetched_sig:new signals.Signal,onStart:function(){TS.files.team_file_changed_sig.add(_teamFileChanged)},maybeUpdateUserStarredList:function(){if(!TS.client)return;if(!TS.model.team)return;if(_stars_being_fetched){_stars_needs_fetched=true;return}_updateUserStarredList()},fetchUserStarredItems:function(page){var api_args=_starsListArgs();api_args.page=page||1;TS.api.call("stars.list",api_args,_onFetchUserStarredItems)},userStarStatusHasChanged:function(starred,item,parent_type){_slurpStarItem(item,parent_type);if(item.type=="message"){_updateMsgStar(item.message.ts,item.channel,starred)}else if(item.type=="file"){if(item.file.is_starred!=starred){_updateFileStar(item.file.id,starred)}}else if(item.type=="file_comment"){if(item.comment.is_starred!=starred){_updateFileCommentStar(item.comment.id,item.file.id,starred)}}else if(item.type=="channel"){var channel=TS.channels.getChannelById(item.channel);if(!channel){TS.warn("userStarStatusHasChanged channel_id:"+item.channel+" not found")}else{if(channel.is_starred!=starred){_updateChannelStar(item.channel,starred)}}}else if(item.type=="group"){var model_ob=TS.groups.getGroupById(item.channel);if(!model_ob){model_ob=TS.mpims.getMpimById(item.channel)}if(!model_ob){TS.warn("userStarStatusHasChanged group_id:"+item.channel+" not found")}else{if(model_ob.is_starred!=starred){if(model_ob.is_mpim&&TS.boot_data.feature_mpim_client){_updateMpimStar(item.channel,starred)}else{_updateGroupStar(item.channel,starred)}}}}else if(item.type=="im"){var im=TS.ims.getImById(item.channel);if(!im){TS.warn("userStarStatusHasChanged im_id:"+item.channel+" not found")}else{if(im.is_starred!=starred){_updateImStar(item.channel,starred)}}}else{TS.error("userStarStatusHasChanged needs to handle star item type:"+item.type)}},checkForStarClick:function(e){if(!e.target)return;var $el=$(e.target);var $star;if($el.closest(".star").length){$star=$el.closest(".star")}else{$star=$el.closest(".star_link")}if(!$star||!$star.length){if($el.is("button.file_star")){$star=$el.children(".star")}}if(!$star||!$star.length)return;if($star.hasClass("not-clickable"))return;var currently_starred=$star.hasClass("starred");var api_args={};var updateFunc;if($star.hasClass("star_message")){api_args.channel=$star.data("c-id");api_args.timestamp=$star.data("msg-id");updateFunc=function(starred){_updateMsgStar(api_args.timestamp,api_args.channel,starred)}}else if($star.hasClass("star_file")){api_args.file=$star.data("file-id");updateFunc=function(starred){_updateFileStar(api_args.file,starred)}}else if($star.hasClass("star_file_comment")){api_args.file_comment=$star.data("comment-id");updateFunc=function(starred){_updateFileCommentStar(api_args.file_comment,$star.data("file-id"),starred)}}else if($star.hasClass("star_channel")){api_args.channel=$star.data("channel-id");updateFunc=function(starred){_updateChannelStar(api_args.channel,starred)}}else if($star.hasClass("star_group")){api_args.channel=$star.data("group-id");updateFunc=function(starred){_updateGroupStar(api_args.channel,starred)}}else if($star.hasClass("star_im")){api_args.channel=$star.data("im-id");updateFunc=function(starred){_updateImStar(api_args.channel,starred)}}else if($star.hasClass("star_mpim")){api_args.channel=$star.data("mpim-id");updateFunc=function(starred){_updateMpimStar(api_args.channel,starred)}}else{TS.error("checkForStarClick doesn't know what to do with a click on "+$star[0].outerHTML);return}updateFunc(!currently_starred);if(currently_starred){TS.api.call("stars.remove",api_args,function(ok,data,args){if(ok)return;if(data.error=="not_starred"){updateFunc(false)}else{updateFunc(true)}})}else{TS.api.call("stars.add",api_args,function(ok,data,args){if(ok)return;if(data.error=="already_starred"){updateFunc(true)}else{updateFunc(false)}})}},updateFileStar:function(file_id,starred){_updateFileStar(file_id,starred)}});var _stars_being_fetched=false;var _stars_needs_fetched=false;var _updateUserStarredList=function(){_stars_being_fetched=true;_stars_needs_fetched=false;TS.stars.member_stars_being_fetched_sig.dispatch(TS.model.user,true);var dont_set_active=true;var api_args=_starsListArgs();TS.api.call("stars.list",api_args,_onFetchUserStarredItems,dont_set_active)};var _teamFileChanged=function(file){if(file.hasOwnProperty("is_starred")){_updateFileStar(file.id,file.is_starred,file.id);TS.files.updateFileListItem(file,$(".star_item"))}};var _onFetchUserStarredItems=function(ok,data,args){_stars_being_fetched=false;TS.stars.member_stars_being_fetched_sig.dispatch(TS.model.user,false);if(_stars_needs_fetched){TS.stars.maybeUpdateUserStarredList();return}if(!ok){TS.error("failed fetchUserStarredItems");return}for(var i=0;i<data.items.length;i++){var item=data.items[i];TS.stars.userStarStatusHasChanged(true,item,"stars.list")}if(args.start_ts){TS.model.user.stars=TS.model.user.stars.concat(data.items)}else{TS.model.user.stars=data.items}TS.stars.member_stars_fetched_sig.dispatch(TS.model.user)};var _starsListArgs=function(){var args={user:TS.model.user.id};args.exclude="Ch,Gh,Dh";return args};var _slurpStarItem=function(item,parent_type){var upsert;if(item.type=="message"){item.message._rxn_key=TS.rxns.getRxnKey("message",item.message.ts,item.channel);if(item.message.type=="channel_topic"||item.message.type=="channel_purpose"||item.message.type=="channel_join"||item.message.type=="channel_leave"){item.message.subtype=item.message.type}item.message.type="message"}else if(item.type=="file"||item.type=="file_comment"){if(item.file){upsert=TS.files.upsertAndSignal(item.file);item.file=upsert.file;if(item.type=="file_comment"){if(item.comment){item.comment=TS.files.addCommentToFile(item.comment,item.file)}else{TS.error("WTF no comment in type "+item.type+" in "+parent_type);return false}}}else{TS.error("WTF no file in type "+item.type+" in "+parent_type);return false}}else if(item.type=="channel"){}else if(item.type=="group"){}else if(item.type=="im"){}else{TS.error("need to handle star item type:"+item.type+" in "+parent_type);return false}return true};var _updateMsgStar=function(ts,c_id,starred){var model_ob=TS.shared.getModelObById(c_id);var msg;if(model_ob){msg=TS.utility.msgs.getMsg(ts,model_ob.msgs)}var selector='.star_message[data-msg-id="'+ts+'"][data-c-id="'+c_id+'"]';_updateStar($(selector),starred,msg,selector);if(TS.client){if(model_ob){TS.utility.msgs.maybeStoreMsgs(model_ob.id,model_ob.msgs)}}};var _updateFileCommentStar=function(comment_id,file_id,starred){var file=TS.files.getFileById(file_id);var comment;if(!file){TS.warn("updateFileCommentStar file_id:"+file_id+" not found")}else{comment=TS.files.getFileCommentById(file,comment_id)}var selector='.star_comment[data-comment-id="'+comment_id+'"]';_updateStar($(selector),starred,comment,selector);TS.files.makeSureReferencesGetSavedToLS(file_id)};var _updateFileStar=function(file_id,starred){var file=TS.files.getFileById(file_id);if(!file){TS.warn("updateFileStar file_id:"+file_id+" not found")}var selector='.star_file[data-file-id="'+file_id+'"]';_updateStar($(selector),starred,file,selector);TS.files.makeSureReferencesGetSavedToLS(file_id)};var _updateChannelStar=function(channel_id,starred){var channel=TS.channels.getChannelById(channel_id);if(!channel){TS.warn("updateChannelStar channel_id:"+channel_id+" not found")}var selector='.star_channel[data-channel-id="'+channel_id+'"]';_updateStar($(selector),starred,channel,selector);if(TS.client){TS.client.channel_pane.rebuildChannelList();TS.client.channel_pane.rebuildStarredList()}};var _updateGroupStar=function(group_id,starred){var group=TS.groups.getGroupById(group_id);if(!group){TS.warn("updateGroupStar group_id:"+group_id+" not found")}var selector='.star_group[data-group-id="'+group_id+'"]';_updateStar($(selector),starred,group,selector);if(TS.client){TS.client.channel_pane.rebuildGroupList();TS.client.channel_pane.rebuildStarredList()}};var _updateImStar=function(im_id,starred){var im=TS.ims.getImById(im_id);if(!im){TS.warn("updateImStar im_id:"+im_id+" not found")}var selector='.star_im[data-im-id="'+im_id+'"]';_updateStar($(selector),starred,im,selector);if(TS.client){TS.client.channel_pane.rebuildImList();TS.client.channel_pane.rebuildStarredList()}};var _updateMpimStar=function(mpim_id,starred){var mpim=TS.mpims.getMpimById(mpim_id);if(!mpim){TS.warn("updateMpimStar mpim_id:"+mpim_id+" not found")}var selector='.star_mpim[data-mpim-id="'+mpim_id+'"]';_updateStar($(selector),starred,mpim,selector);if(TS.client){TS.client.channel_pane.rebuildImAndMpimList();TS.client.channel_pane.rebuildStarredList()}};var _updateStar=function($star,starred,ob,selector){if(starred){if(!$star.hasClass("starred")){$star.addClass("starred ts_icon_star").removeClass("ts_icon_star_o")}}else{$star.removeClass("starred ts_icon_star").addClass("ts_icon_star_o")}if(ob){ob.is_starred=starred}else{}}})();(function(){"use strict";TS.registerModule("mentions",{mention_changed_sig:new signals.Signal,mention_removed_sig:new signals.Signal,mentions_fetched_sig:new signals.Signal,mentions_being_fetched_sig:new signals.Signal,mentions_being_fetched:false,mentions_needs_fetched:false,has_more:false,after_ts:null,fetched_once:false,onStart:function(){TS.prefs.mentions_exclude_at_channels_changed_sig.add(_excludeAtChannelsPrefChanged);TS.prefs.mentions_exclude_at_user_groups_changed_sig.add(_excludeUserGroupsPrefChanged)},maybeUpdateMentions:function(){if(TS.boot_data.app!="client")return;if(!TS.model.team)return;if(TS.mentions.mentions_being_fetched||!TS.mentions.fetched_once||TS.model.ui_state.flex_name!=="mentions"){TS.mentions.mentions_needs_fetched=true;return}TS.mentions.updateMentions()},updateMentions:function(){TS.mentions.mentions_being_fetched=true;TS.mentions.mentions_needs_fetched=false;TS.mentions.mentions_being_fetched_sig.dispatch();var dont_set_active=true;TS.api.call("activity.mentions",_activityMentionsArgs(),TS.mentions.onFetchMentions,dont_set_active)},fetchMoreMentions:function(){TS.mentions.fetchMentions(TS.mentions.after_ts)},fetchMentions:function(after_ts){TS.mentions.mentions_needs_fetched=false;TS.mentions.fetched_once=true;var args=_activityMentionsArgs();after_ts=after_ts||"";args.after_ts=after_ts;TS.api.call("activity.mentions",args,TS.mentions.onFetchMentions)},getMentionByMsgId:function(id,replace_message_with,and_remove_it){for(var i=0;i<TS.model.user.mentions.length;i++){var mention=TS.model.user.mentions[i];if(!mention.message)continue;if(mention.message.ts==id){if(replace_message_with){TS.model.user.mentions[i].message=replace_message_with}else if(and_remove_it){TS.model.user.mentions.splice(i,1)}return mention}}return null},onFetchMentions:function(ok,data,args){TS.mentions.mentions_being_fetched=false;if(TS.mentions.mentions_needs_fetched){setTimeout(TS.mentions.maybeUpdateMentions,100)}if(!ok){TS.error("failed fetchMentions");return}var mentions=[];var existing_rxns;for(var i=0;i<data.mentions.length;i++){var mention=data.mentions[i];if(mention.type=="reaction"){if(mention.item.type=="message"){mention.rxn_ts=mention.ts;mention.channel=mention.item.channel;mention.message=mention.item.message;mention.item.message._rxn_key=TS.rxns.getRxnKey("message",mention.item.message.ts,mention.item.channel);delete mention.item}else{continue}}var msg=mention.message;if(!msg)continue;var file=msg.file;var comment=msg.comment;if(msg.subtype=="file_share"||msg.subtype=="file_mention"||msg.subtype=="file_comment"){if(!file)continue;if(msg.subtype=="file_comment"){if(!comment)continue}}if(msg.ts=="0000000000.000000"){TS.warn("bad mention! msg.ts == 0000000000.000000");continue}if(msg.subtype=="file_share"||msg.subtype=="file_mention"||msg.subtype=="file_comment"){file._rxn_key=TS.rxns.getRxnKey("file",file.id);existing_rxns=TS.rxns.getExistingRxnsByKey(file._rxn_key);if(existing_rxns&&!file.reactions){TS.warn("file:"+file.id+" has reactions in local model, but we got an object in mentions that does NOT have reactions, which seems suspicious")}else{TS.rxns.upsertRxnsFromDataAndUpdateUI(file._rxn_key,file.reactions)}if(msg.subtype=="file_comment"){comment._rxn_key=TS.rxns.getRxnKey("file_comment",comment.id);existing_rxns=TS.rxns.getExistingRxnsByKey(comment._rxn_key);if(existing_rxns&&!comment.reactions){TS.warn("comment:"+comment.id+" has reactions in local model, but we got an object in mentions that does NOT have reactions, which seems suspicious")}else{TS.rxns.upsertRxnsFromDataAndUpdateUI(comment._rxn_key,comment.reactions)}}}else{msg._rxn_key=TS.rxns.getRxnKey("message",msg.ts,mention.channel);existing_rxns=TS.rxns.getExistingRxnsByKey(msg._rxn_key);if(existing_rxns&&!msg.reactions){TS.warn("msg:"+msg.ts+" has reactions in local model, but we got an object in mentions that does NOT have reactions, which seems suspicious")}else{TS.rxns.upsertRxnsFromDataAndUpdateUI(msg._rxn_key,msg.reactions)}var model_ob=TS.shared.getModelObById(mention.channel);var existing_msg=model_ob&&TS.utility.msgs.getMsg(msg.ts,model_ob.msgs);if(existing_msg){msg.is_starred=existing_msg.is_starred}}if(TS.mentions.getMentionByMsgId(msg.ts,msg)){continue}mentions.push(mention)}TS.model.user.mentions=TS.model.user.mentions.concat(mentions);TS.mentions.sortMentions();if(TS.mentions.after_ts===null||args.after_ts){TS.mentions.has_more=data.has_more;if(TS.model.user.mentions.length){TS.mentions.after_ts=TS.model.user.mentions[TS.model.user.mentions.length-1].message.ts}}TS.mentions.mentions_fetched_sig.dispatch()},sortMentions:function(){var a_val;var b_val;function compare(a,b){a_val=a.rxn_ts||a.message.ts;b_val=b.rxn_ts||b.message.ts;if(a_val<b_val)return 1;if(a_val>b_val)return-1;return 0}TS.model.user.mentions.sort(compare)},replaceMsg:function(imsg){var mention=TS.mentions.getMentionByMsgId(imsg.ts,imsg);if(mention){TS.mentions.mention_changed_sig.dispatch(mention)}},removeMsg:function(ts){var mention=TS.mentions.getMentionByMsgId(ts,null,true);if(mention){TS.mentions.mention_removed_sig.dispatch(ts)}},setExcludeAtChannelsPref:function(value){value=!!value;TS.model.prefs.mentions_exclude_at_channels=value;TS.prefs.setPrefByAPI({name:"mentions_exclude_at_channels",value:value});_excludeAtChannelsPrefChanged()},setExcludeAtUserGroupsPref:function(value){value=!!value;TS.model.prefs.mentions_exclude_at_user_groups=value;TS.prefs.setPrefByAPI({name:"mentions_exclude_at_user_groups",value:value});_excludeUserGroupsPrefChanged()},weaveInRxnRecords:function(){var rxn_records=TS.rxns.getRxnRecords();var key_parts;var rxn_key;var mention_item;var model_ob;var existing_msg;TS.model.user.mentions=TS.model.user.mentions.filter(function(m){return m.type!="rxn"});for(var i=0;i<rxn_records.length;i++){rxn_key=rxn_records[i].rxn_key;key_parts=TS.rxns.getRxnKeyParts(rxn_key);if(key_parts.type=="message"){model_ob=TS.shared.getModelObById(key_parts.c_id);existing_msg=model_ob&&TS.utility.msgs.getMsg(key_parts.id,model_ob.msgs);if(!existing_msg)continue;TS.mentions.getMentionByMsgId(key_parts.id,null,true);mention_item={channel:key_parts.c_id,type:"reaction",rxn_ts:rxn_records[i].last_update,message:TS.utility.clone(existing_msg)};mention_item.message._rxn_key=rxn_key}else if(key_parts.type=="file"){continue}else if(key_parts.type=="file_comment"){continue}else{continue}TS.model.user.mentions.push(mention_item)}TS.mentions.sortMentions()}});var _activityMentionsArgs=function(){var args={count:100,reactions:1};var exclude=[];if(TS.model.prefs.mentions_exclude_at_channels){exclude.push("everyone");exclude.push("channel")}if(TS.boot_data.feature_subteams&&TS.model.prefs.mentions_exclude_at_user_groups){exclude.push("user_group")}if(exclude.length>0){args.exclude=exclude.join(",")}return args};var _excludeAtChannelsPrefChanged=function(){var value=TS.model.prefs.mentions_exclude_at_channels;if(value){_removeMentionTypeMsgs(["everyone","channel"]);TS.mentions.mentions_fetched_sig.dispatch()}else{TS.mentions.maybeUpdateMentions()}};var _excludeUserGroupsPrefChanged=function(){var value=TS.model.prefs.mentions_exclude_at_user_groups;if(value){_removeMentionTypeMsgs(["user_group"]);TS.mentions.mentions_fetched_sig.dispatch()}else{TS.mentions.maybeUpdateMentions()}};var _removeMentionTypeMsgs=function(types){var mention;for(var i=TS.model.user.mentions.length-1;i>=0;i--){mention=TS.model.user.mentions[i];if(types.indexOf(mention.type)!==-1){TS.model.user.mentions.splice(i,1)}}}})();(function(){"use strict";TS.registerModule("inline_videos",{no_scrolling:false,onStart:function(){},shouldExpand:function(container_id,inline_video){if(TS.model.expandable_state["vid_"+container_id+inline_video.src])return true;if(TS.model.expandable_state["vid_"+container_id+inline_video.src]===false)return false;if(inline_video.internal_file_id)return TS.model.prefs.expand_internal_inline_imgs;return TS.model.prefs.expand_inline_imgs},expandAllInCurrent:function(){TS.inline_videos.no_scrolling=true;$(".msg_inline_video_expander").trigger("click");TS.inline_videos.no_scrolling=false;if(TS.client){TS.client.ui.instaScrollMsgsToBottom(false)}},collapseAllInCurrent:function(){$(".msg_inline_video_collapser").trigger("click")},expand:function(container_id,src){TS.model.expandable_state["vid_"+container_id+src]=true;TS.storage.storeExpandableState(TS.model.expandable_state);var selector="#"+TS.utility.makeSafeForDomId(container_id);var $el=$(selector);if(!$el.length)return;var was_at_bottom=TS.client&&TS.client.ui.areMsgsScrolledToBottom();var filter=function(i){return $(this).data("real-src")==src};var $holder=TS.boot_data.feature_attachments_inline?$el.find(".inline_attachment").filter(filter):null;if(!$holder||!$holder.length)$holder=$el.find(".msg_inline_video_holder").filter(filter);$holder.find(".msg_inline_video_thumb_div").removeClass("hidden");$holder.removeClass("hidden");$el.find(".msg_inline_video_expander").filter(filter).addClass("hidden");$el.find(".msg_inline_video_collapser").filter(filter).removeClass("hidden");if(TS.client)TS.client.ui.checkInlineImgsAndIframesEverywhere();$holder.css("opacity",0).stop().animate({opacity:1},300);if(!TS.inline_videos.no_scrolling){if(TS.client&&was_at_bottom){TS.client.ui.instaScrollMsgsToBottom(false);$el.children().first().scrollintoview({duration:0,offset:"top",px_offset:10,direction:"y"})}else{$el.find(".msg_inline_video").last().scrollintoview({duration:200,offset:"bottom",px_offset:-10,direction:"y"})}}if(TS.client)TS.client.ui.checkInlineImgsAndIframesEverywhere()},collapse:function(container_id,src){TS.model.expandable_state["vid_"+container_id+src]=false;TS.storage.storeExpandableState(TS.model.expandable_state);var selector="#"+TS.utility.makeSafeForDomId(container_id);var $el=$(selector);if(!$el.length)return;var filter=function(i){return $(this).data("real-src")==src};var $holder=TS.boot_data.feature_attachments_inline?$el.find(".inline_attachment").filter(filter):null;if(!$holder||!$holder.length)$holder=$el.find(".msg_inline_video_holder").filter(filter);$holder.css("visibility","hidden");$el.find(".msg_inline_video_expander").filter(filter).removeClass("hidden");$el.find(".msg_inline_video_collapser").filter(filter).addClass("hidden");$holder.find(".msg_inline_video_iframe_div").html("");setTimeout(function(){$holder.addClass("hidden");$holder.css("visibility","visible")},200)},enCommentHTML:function(html){if(!html)return"";var parser=new DOMParser;var body_html="<body>"+html+"</body>";var doc=parser.parseFromString(body_html,"text/html")||parser.parseFromString(body_html,"text/xml");if(!doc||!doc.body)return"";if(doc.body.childNodes.length===0){return""}if(doc.body.childNodes.length==1&&doc.body.childNodes[0].nodeType==Node.COMMENT_NODE){return doc.body.innerHTML}var comment=document.createComment(html);return $("<div>").append(comment).html()},unCommentHTML:function(html){if(!html)return"";var parser=new DOMParser;var doc=parser.parseFromString("<body>"+html+"</body>","text/html");if(!doc||!doc.body)return"";if(doc.body.childNodes.length!=1)return"";var comment=doc.body.childNodes[0];if(comment.nodeType!=Node.COMMENT_NODE)return"";return comment.textContent},checkForInlineVideoClick:function(e,match){if(!e.target)return;var $el=$(e.target);var container_id;if(TS.boot_data.feature_message_replies){var $message=$el.closest(".message");container_id=$message.attr("id");if(!container_id)return}else{var msg_id=$el.closest(".message").data("ts");container_id=TS.templates.makeMsgDomId(msg_id);if(!msg_id&&match){msg_id=$el.closest(".search_message_result").data("ts");container_id=TS.templates.makeMSRDomId(match)}if(!msg_id)return}var msg_inline_video_expander_el=$el.closest(".msg_inline_video_expander");if(msg_inline_video_expander_el.length){e.preventDefault();TS.inline_videos.expand(container_id,msg_inline_video_expander_el.data("real-src"));return}var msg_inline_video_collapser_el=$el.closest(".msg_inline_video_collapser");if(msg_inline_video_collapser_el.length){e.preventDefault();TS.inline_videos.collapse(container_id,msg_inline_video_collapser_el.data("real-src"));return}var $msg_inline_video_play_button=$el.closest(".msg_inline_video_play_button");if($msg_inline_video_play_button.length){var $msg_inline_video_holder=$msg_inline_video_play_button.closest(".msg_inline_video_holder");var $msg_inline_video_iframe_div=$msg_inline_video_holder.find(".msg_inline_video_iframe_div");$msg_inline_video_iframe_div.removeClass("hidden");$msg_inline_video_holder.find(".msg_inline_video_thumb_div").addClass("hidden");var url=$msg_inline_video_iframe_div.data("url");var inline_video=TS.model.inline_videos[url];if(!inline_video){var corrected_url=url.replace(/\&/g,"&amp;");inline_video=TS.model.inline_videos[corrected_url]}if(inline_video){$msg_inline_video_iframe_div.html(TS.inline_videos.unCommentHTML(inline_video.html))}else{$msg_inline_video_iframe_div.html('<div style="padding:10px; color:white">Error: unable to find "'+TS.utility.htmlEntities(url)+'" in TS.model.inline_videos</div>')}return}},makeInternalInlineVideo:function(key,video){var max_w=400;var max_h=500;TS.model.inline_videos[key]=video;video.src=video.thumbnail.url||key;video.width=video.display_w=parseInt(video.thumbnail.width);video.height=video.display_h=parseInt(video.thumbnail.height);if(video.display_w>max_w){video.display_w=max_w;video.display_h=parseInt(video.height*(video.display_w/video.width))}if(video.display_h>max_h){video.display_h=max_h;video.display_w=parseInt(video.width*(video.display_h/video.height))}if(!video.html)video.html="MISSING video.html";if(video.html.indexOf("gfycat.com/ifr")>-1){video.html=_maybeRewriteGfyCatHtml(video.html)}video.html=video.html.replace("http://","//");if(video.html.indexOf("oldwidth")==-1){video.html=video.html.replace(" width=",' width="'+video.display_w+'" oldwidth=');video.html=video.html.replace(" height=",' height="'+video.display_h+'" oldheight=')}video.html=TS.inline_videos.enCommentHTML(video.html);video.html=TS.utility.swapInRedirUrlForIframe(video.html);var proxied_src=TS.utility.getImgProxyURL(video.src,video.display_w,video.display_h);if(proxied_src!=video.src){video.proxied_src=proxied_src}else{delete video.proxied_src}},test:function(){return{maybeRewriteGfyCatHtml:_maybeRewriteGfyCatHtml}}});var GFYCAT_KEY_REGEXP=/^[a-zA-Z0-9]+$/;var _maybeRewriteGfyCatHtml=function(html){var gfycat_attrs=TS.utility.getAttributesFromHTMLString(html);var gfycat_src=gfycat_attrs.src;
if(!gfycat_src){return html}var gfycat_key=gfycat_src.split("ifr/")[1]||"";if(!gfycat_key.match(GFYCAT_KEY_REGEXP)){return html}var gfycat_w=parseInt(gfycat_attrs.width,10);var gfycat_h=parseInt(gfycat_attrs.height,10);if(!gfycat_w||!gfycat_h){return html}gfycat_attrs.src="https://"+document.location.host+"/gfycat_iframe.php?key="+gfycat_key+"&w="+gfycat_w+"&h="+gfycat_h+"&"+Date.now();var $gfycat_ifr=$("<iframe>").attr(gfycat_attrs);return $gfycat_ifr[0].outerHTML}})();(function(){"use strict";TS.registerModule("inline_attachments",{no_scrolling:false,onStart:function(){},shouldExpand:function(container_id,inline_attachment){if(TS.model.expandable_state["attach_"+container_id+inline_attachment.from_url])return true;if(TS.model.expandable_state["attach_"+container_id+inline_attachment.from_url]===false)return false;return true},shouldShow:function(attachment,msg){if(!attachment.from_url)return true;if(msg&&msg.text){if(msg.text.indexOf(attachment.from_url)==-1){if(TS.model.ampersands_are_inconsistent_in_from_urls){if(msg.text.indexOf(attachment.from_url.replace(/\&/g,"&amp;"))==-1){return true}}else{return true}}}if(TS.model.prefs.expand_inline_imgs){if(attachment.audio_html)return true;if(attachment.other_html)return true;if(attachment.video_html)return true;if(attachment.image_url)return true;if(attachment.service_name&&attachment.service_name.toString().toLowerCase()=="twitter")return true}return!!TS.model.prefs.expand_non_media_attachments},expandAllInCurrent:function(){TS.inline_attachments.no_scrolling=true;$(".msg_inline_attachment_expander").trigger("click");TS.inline_attachments.no_scrolling=false;if(TS.client){TS.client.ui.instaScrollMsgsToBottom(false)}},collapseAllInCurrent:function(){$(".msg_inline_attachment_collapser").trigger("click")},expand:function(container_id,src){TS.model.expandable_state["attach_"+container_id+src]=true;TS.storage.storeExpandableState(TS.model.expandable_state);var selector="#"+TS.utility.makeSafeForDomId(container_id);var $el=$(selector);if(!$el.length)return;var was_at_bottom=TS.client&&TS.client.ui.areMsgsScrolledToBottom();var filter=function(i){return $(this).data("real-src")==src};var $holder=$el.find(".inline_attachment").filter(filter);$holder.removeClass("hidden");$el.find(".msg_inline_attachment_expander").filter(filter).addClass("hidden");$el.find(".msg_inline_attachment_collapser").filter(filter).removeClass("hidden");if(TS.client)TS.client.ui.checkInlineImgsAndIframesEverywhere();$holder.css("opacity",0).stop().animate({opacity:1},300);if(!TS.inline_attachments.no_scrolling){if(TS.client&&was_at_bottom){TS.client.ui.instaScrollMsgsToBottom(false);$el.children().first().scrollintoview({duration:0,offset:"top",px_offset:10,direction:"y"})}else{$holder.scrollintoview({duration:200,offset:"bottom",px_offset:-10,direction:"y"})}}if(TS.client)TS.client.ui.checkInlineImgsAndIframesEverywhere()},collapse:function(container_id,src){TS.model.expandable_state["attach_"+container_id+src]=false;TS.storage.storeExpandableState(TS.model.expandable_state);var selector="#"+TS.utility.makeSafeForDomId(container_id);var $el=$(selector);if(!$el.length)return;var filter=function(i){return $(this).data("real-src")==src};var $holder=$el.find(".inline_attachment").filter(filter);if(!$holder.length)$holder=$el.find(".msg_inline_attachment_holder").filter(filter);$holder.css("visibility","hidden");$el.find(".msg_inline_attachment_expander").filter(filter).removeClass("hidden");$el.find(".msg_inline_attachment_collapser").filter(filter).addClass("hidden");setTimeout(function(){$holder.addClass("hidden");$holder.css("visibility","visible")},200)},checkForInlineAttachmentClick:function(e,match){if(!e.target)return;var $el=$(e.target);var container_id,msg_id;if(TS.boot_data.feature_message_replies){var $message=$el.closest(".message");msg_id=$message.data("ts");container_id=$message.attr("id");if(!container_id)return}else{msg_id=$el.closest(".message").data("ts");container_id=TS.templates.makeMsgDomId(msg_id);if(!msg_id&&match){msg_id=$el.closest(".search_message_result").data("ts");container_id=TS.templates.makeMSRDomId(match)}if(!msg_id)return;msg_id=msg_id.toString()}var $msg_inline_attachment_expander=$el.closest(".msg_inline_attachment_expander");if($msg_inline_attachment_expander.length){e.preventDefault();TS.inline_attachments.expand(container_id,$msg_inline_attachment_expander.data("real-src"))}var $msg_inline_attachment_collapser=$el.closest(".msg_inline_attachment_collapser");if($msg_inline_attachment_collapser.length){e.preventDefault();TS.inline_attachments.collapse(container_id,$msg_inline_attachment_collapser.data("real-src"))}var $rest_text_expander=$el.closest(".rest_text_expander");if($rest_text_expander.length){e.preventDefault();var was_at_bottom=TS.client&&TS.client.ui.areMsgsScrolledToBottom();var $short_text=$rest_text_expander.parent().find(".short_text");var $rest_text_expander_text;var $more_text=$rest_text_expander.parent().find(".more_text");if($rest_text_expander.data("show-text")){if($more_text.length){$more_text.addClass("hidden");$rest_text_expander_text=$rest_text_expander.find("a span");$rest_text_expander.data("hide-text",$rest_text_expander_text.text());$rest_text_expander_text.text($rest_text_expander.data("show-text"));$rest_text_expander.data("show-text","");$rest_text_expander.find("a .ts_icon").removeClass("ts_icon_caret_down").addClass("ts_icon_caret_right")}}else{if($short_text.data("all-text")){$short_text.html($short_text.data("all-text"));$short_text.data("all-text","")}if($more_text.length)$more_text.removeClass("hidden");if($more_text.length&&$rest_text_expander.data("hide-text")){$rest_text_expander_text=$rest_text_expander.find("a span");$rest_text_expander.data("show-text",$rest_text_expander_text.text());$rest_text_expander_text.text($rest_text_expander.data("hide-text"));$rest_text_expander.data("hide-text","");$rest_text_expander.find("a .ts_icon").removeClass("ts_icon_caret_right").addClass("ts_icon_caret_down")}else{$rest_text_expander.css("display","none")}}$short_text.css("opacity",0).transition({opacity:1},300);TS.inline_attachments.rest_texts_expanded[$rest_text_expander.attr("id")]=true;if(TS.client)TS.client.ui.updateClosestMonkeyScroller($short_text);if(TS.client&&was_at_bottom){TS.client.ui.instaScrollMsgsToBottom(false);$short_text.scrollintoview({duration:0,offset:"top",px_offset:10,direction:"y"})}}var $delete_attachment_link=$el.closest(".delete_attachment_link");if($delete_attachment_link.length){e.preventDefault();var attach_id=$delete_attachment_link.data("attachment-id").toString();var model_ob=TS.shared.getActiveModelOb();if(!model_ob){alert("missing model_ob");return}if(!attach_id){alert("missing attachment-id");return}var c_id=model_ob.id;var msg=TS.utility.msgs.getMsg(msg_id,model_ob.msgs);var blacklist_html="";if(TS.model.user.is_admin){var attachment=TS.inline_attachments.getAttachmentById(msg.attachments,attach_id);if(attachment&&attachment.from_url){var select_html=TS.inline_attachments.makeBlackListSelect(attachment.from_url);blacklist_html='						<p class="large_left_margin '+(select_html?"no_bottom_margin":"")+'">							<label class="checkbox normal" style="font-size: 16px;">								<input id="attachment_blacklist_cb" type="checkbox" class="small_right_margin" />								Disable future attachments from this website?</label>';if(select_html)blacklist_html+=select_html;blacklist_html+="</p>"}}TS.generic_dialog.start({title:"Remove attachment",body:'<p class="'+(blacklist_html?"small_bottom_margin":"")+'">Are you sure you wish to remove this attachment from the message?</p>'+blacklist_html,go_button_text:"Yes, remove",onShow:function(){$("#attachment_blacklist_cb").bind("change",function(){var do_blacklist=!!$("#attachment_blacklist_cb").prop("checked");TS.info(do_blacklist);if(do_blacklist){$("#attachment_blacklist_select").prop("disabled",false)}else{$("#attachment_blacklist_select").prop("disabled",true)}})},onGo:function(){var do_blacklist=!!$("#attachment_blacklist_cb").prop("checked");var blacklist_type=do_blacklist?$("#attachment_blacklist_select").val():"none";var blacklist_url=do_blacklist?$("#attachment_blacklist_select").find(":selected").data("url"):"";var args={channel:c_id,ts:msg_id,attachment:attach_id,blacklist:do_blacklist,blacklist_type:blacklist_type,blacklist_url:blacklist_url};TS.dir(0,args);TS.api.call("chat.deleteAttachment",args,function(ok,data,args){if(ok){if(TS.web){msg.attachments=TS.inline_attachments.removeAttachmentById(msg.attachments,attach_id);TS.utility.msgs.replaceMsg(model_ob,msg)}}else{TS.generic_dialog.alert("Attachment removing failed!")}})}})}},makeBlackListSelect:function(url){if(!url)return"";url=TS.utility.htmlEntities(url).replace("https://","").replace("http://","");var html="";var parts=url.split("/");var host=parts[0];var last=parts[parts.length-1];html+='<label class="select small full_width">\r';html+='<select id="attachment_blacklist_select" disabled="disabled" class="small" style="margin-bottom: 4px;">\r';html+='<option value="all" data-url="'+host+'">All links from '+host+"</option>\r";html+='<option value="just" data-url="'+url+'">Just the link '+url+"</option>\r";if(last!=host){TS.info(last);var new_parts=parts.concat();new_parts.length=new_parts.length-1;var host_path=new_parts.join("/");if(host_path!=host){host_path+="/";html+='<option value="under" data-url="'+host_path+'">All links under '+host_path+"</option>\r"}}html+="</select>\r";html+="</label>\r";return html},rest_texts_expanded:{},shouldExpandText:function(id){return!!TS.inline_attachments.rest_texts_expanded[id]},makeInternalInlineAttachment:function(key,attachment){var slack_author_id=TS.utility.getMemberIdFromURL(attachment.author_link);if(slack_author_id)attachment._slack_author_id=slack_author_id;TS.model.inline_attachments[key]=attachment},renderStandaloneAttachment:function(attachment){TS.inline_attachments.massageAttachment(attachment,0);if(attachment.image_url&&!TS.model.inline_imgs[attachment.from_url]){TS.inline_imgs.makeInternalInlineImg(attachment.from_url,{link_url:attachment.from_url,bytes:attachment.image_bytes,src:attachment.image_url,width:isNaN(attachment.image_width)?null:attachment.image_width,height:isNaN(attachment.image_height)?null:attachment.image_height,should_expand:true})}if(attachment.video_html&&!TS.model.inline_videos[attachment.from_url]){TS.inline_videos.makeInternalInlineVideo(attachment.from_url,{src:attachment.thumb_url,html:attachment.video_html,proxied_src:attachment.proxied_thumb_url,title:attachment.title,display_h:attachment.video_html_height,display_w:attachment.video_html_width,thumbnail:{link_url:attachment.from_url,url:attachment.thumb_url,height:attachment.thumb_height,width:attachment.thumb_width}})}var msg_id=TS.utility.date.makeTsStamp();var attachment_html=TS.templates.builders.buildAttachmentHTML({attachment:attachment,msg:{enable_slack_action_links:false,text:attachment["from_url"],ts:msg_id,url:attachment["from_url"]},can_delete:false,maybe_show_lightbox:false});var container_id=TS.templates.makeMsgDomId(msg_id);return'<div class="message standalone-attachment" id="'+container_id+'" data-ts="'+msg_id+'">'+attachment_html+"</div>"},massageAttachment:function(attachment,index){attachment._index=index;if("id"in attachment)attachment.id=attachment.id.toString();var short_text_limit=500;var short_text_br_limit=3;var short_text="";var short_text_display_length=0;if(attachment.text){var rest_text="";var markup_chunk="";var label="";var c;var br_count=0;var stop_at_next_space=false;for(var i=0;i<attachment.text.length;i++){c=attachment.text.charAt(i);if(markup_chunk||c=="<"){markup_chunk+=c;if(label||c=="|"){label+=c}if(c==">"){short_text+=markup_chunk;short_text_display_length+=label.length-2;if(short_text_display_length>short_text_limit){stop_at_next_space=true}markup_chunk="";label=""}}else{if(c=="\n"){br_count++}if(br_count>short_text_br_limit+1){rest_text=attachment.text.replace(short_text,"");break}short_text+=c;short_text_display_length++;if(short_text_display_length>short_text_limit){stop_at_next_space=true}if(stop_at_next_space&&c==" "){rest_text=attachment.text.replace(short_text,"");break}}}attachment._short_text=short_text==attachment.text?"":short_text;var tbt_before=short_text.match(/```/g);var tbt_after=rest_text.match(/```/g);if(tbt_before&&tbt_after){attachment._short_text+="```"}}attachment._floated_thumb_display_height=75;attachment._floated_thumb_display_width=75;if(attachment.thumb_height&&attachment.thumb_width){if(attachment.thumb_height>attachment.thumb_width){attachment._floated_thumb_display_width=parseInt(attachment.thumb_width*(attachment._floated_thumb_display_height/attachment.thumb_height))}else{attachment._floated_thumb_display_height=parseInt(attachment.thumb_height*(attachment._floated_thumb_display_width/attachment.thumb_width))}}var proxied_thumb_url=TS.utility.getImgProxyURL(attachment.thumb_url,attachment._floated_thumb_display_width,attachment._floated_thumb_display_height);if(proxied_thumb_url!=attachment.thumb_url){attachment.proxied_thumb_url=proxied_thumb_url}else{delete attachment.proxied_thumb_url}},getAttachmentByFromUrl:function(attachments,url){if(!attachments)return null;for(var i=0;i<attachments.length;i++){if(!attachments[i]){TS.info(url);TS.dir(0,attachments);continue}if(!attachments[i].from_url){continue}if(attachments[i].from_url==url){return attachments[i]}if(TS.model.ampersands_are_inconsistent_in_from_urls){if(attachments[i].from_url.replace(/\&/g,"&amp;")==url){return attachments[i]}}}return null},getAttachmentBySlackFileId:function(attachments,slack_file_id){if(!attachments)return null;if(!slack_file_id)return null;for(var i=0;i<attachments.length;i++){if(!attachments[i]){continue}if(attachments[i].slack_file_id==slack_file_id){return attachments[i]}}return null},removeAttachmentById:function(attachments,id){if(!attachments)return null;var A=[];for(var i=0;i<attachments.length;i++){if(attachments[i].id!=id){A.push(attachments[i])}}return A},getAttachmentById:function(attachments,id){if(!attachments)return null;for(var i=0;i<attachments.length;i++){if(attachments[i].id==id){return attachments[i]}}return null}})})();(function(){"use strict";TS.registerModule("inline_others",{no_scrolling:false,onStart:function(){},shouldExpand:function(container_id,inline_other){if(TS.model.expandable_state["vid_"+container_id+inline_other.src])return true;if(TS.model.expandable_state["vid_"+container_id+inline_other.src]===false)return false;if(inline_other.internal_file_id)return TS.model.prefs.expand_internal_inline_imgs;return TS.model.prefs.expand_inline_imgs},expandAllInCurrent:function(){TS.inline_others.no_scrolling=true;$(".msg_inline_other_expander").trigger("click");TS.inline_others.no_scrolling=false;if(TS.client){TS.client.ui.instaScrollMsgsToBottom(false)}},collapseAllInCurrent:function(){$(".msg_inline_other_collapser").trigger("click")},expand:function(container_id,src){TS.model.expandable_state["vid_"+container_id+src]=true;TS.storage.storeExpandableState(TS.model.expandable_state);var selector="#"+TS.utility.makeSafeForDomId(container_id);var $el=$(selector);if(!$el.length)return;var was_at_bottom=TS.client&&TS.client.ui.areMsgsScrolledToBottom();var filter=function(i){return $(this).data("real-src")==src};var $holder=TS.boot_data.feature_attachments_inline?$el.find(".inline_attachment").filter(filter):null;if(!$holder||!$holder.length)$holder=$el.find(".msg_inline_other_holder").filter(filter);$holder.removeClass("hidden");$el.find(".msg_inline_other_expander").filter(filter).addClass("hidden");$el.find(".msg_inline_other_collapser").filter(filter).removeClass("hidden");if(TS.client)TS.client.ui.checkInlineImgsAndIframesEverywhere();$holder.css("opacity",0).stop().animate({opacity:1},300);if(!TS.inline_others.no_scrolling){if(TS.client&&was_at_bottom){TS.client.ui.instaScrollMsgsToBottom(false);$el.children().first().scrollintoview({duration:0,offset:"top",px_offset:10,direction:"y"})}else{$el.find(".msg_inline_other").last().scrollintoview({duration:200,offset:"bottom",px_offset:-10,direction:"y"})}}if(TS.client)TS.client.ui.checkInlineImgsAndIframesEverywhere()},collapse:function(container_id,src){TS.model.expandable_state["vid_"+container_id+src]=false;TS.storage.storeExpandableState(TS.model.expandable_state);var selector="#"+TS.utility.makeSafeForDomId(container_id);var $el=$(selector);if(!$el.length)return;var filter=function(i){return $(this).data("real-src")==src};var $holder=TS.boot_data.feature_attachments_inline?$el.find(".inline_attachment").filter(filter):null;if(!$holder||!$holder.length)$holder=$el.find(".msg_inline_other_holder").filter(filter);$holder.css("visibility","hidden");$el.find(".msg_inline_other_expander").filter(filter).removeClass("hidden");$el.find(".msg_inline_other_collapser").filter(filter).addClass("hidden");$holder.find(".msg_inline_other_iframe_div").html("");setTimeout(function(){$holder.addClass("hidden");$holder.css("visibility","visible")},200)},checkForInlineOtherClick:function(e,match){if(!e.target)return;var $el=$(e.target);var container_id;if(TS.boot_data.feature_message_replies){var $message=$el.closest(".message");container_id=$message.attr("id");if(!container_id)return}else{var msg_id=$el.closest(".message").data("ts");container_id=TS.templates.makeMsgDomId(msg_id);if(!msg_id&&match){msg_id=$el.closest(".search_message_result").data("ts");container_id=TS.templates.makeMSRDomId(match)}if(!msg_id)return}var msg_inline_other_expander_el=$el.closest(".msg_inline_other_expander");if(msg_inline_other_expander_el.length){e.preventDefault();TS.inline_others.expand(container_id,msg_inline_other_expander_el.data("real-src"));return}var msg_inline_other_collapser_el=$el.closest(".msg_inline_other_collapser");if(msg_inline_other_collapser_el.length){e.preventDefault();TS.inline_others.collapse(container_id,msg_inline_other_collapser_el.data("real-src"));return}},makeInternalInlineOther:function(attachment){var max_w=400;var max_h=500;if(attachment.other_html_width>max_w){attachment.other_html_height=parseInt(attachment.other_html_height*(max_w/attachment.other_html_width));attachment.other_html_width=max_w}if(attachment.other_html_height>max_h){attachment.other_html_width=parseInt(attachment.other_html_width*(max_h/attachment.other_html_height));attachment.other_html_height=max_h}var google_map_config;if(attachment.google_map_config){google_map_config=TS.utility.parseJSONOrElse(attachment.google_map_config,undefined)}if(google_map_config&&google_map_config.center&&typeof google_map_config.center.lat!="string"){google_map_config.scrollwheel=false;var dom_id="googmap_"+_googmap_index++;attachment.other_html='<div class="google-maps" id="'+dom_id+'" style="width:100%; min-width:'+TS.utility.htmlEntities(attachment.other_html_width)+"px; height:"+TS.utility.htmlEntities(attachment.other_html_height)+'px;"></div>			<script>TS.inline_others.runGoogleMapCode("'+dom_id+"\", '"+JSON.stringify(google_map_config)+"')</script>";attachment.safe_other_html=attachment.other_html}else{if(attachment.other_html.indexOf("oldwidth")==-1){attachment.other_html=attachment.other_html.replace(" width=",' width="'+attachment.other_html_width+'" oldwidth=');attachment.other_html=attachment.other_html.replace(" height=",' height="'+attachment.other_html_height+'" oldheight=')}attachment.safe_other_html=attachment.other_html;attachment.safe_other_html=TS.utility.swapInRedirUrlForIframe(attachment.safe_other_html);if(TS.client)attachment.safe_other_html=TS.utility.getPlaceholderHTMLFromIframe(attachment.safe_other_html)}TS.model.inline_others[attachment.other_html]={src:TS.utility.htmlEntities(attachment.other_html),attachment:attachment}},runGoogleMapCode:function(map_id,config_str){if(!window.google)return;if(!config_str)return;var config=JSON.parse(config_str);var map=new google.maps.Map(document.getElementById(map_id),config);if(!config.query)return;var geocoder=new google.maps.Geocoder;var max_results=typeof config.max_results=="number"?config.max_results:10;if(max_results<0){max_results=Number.MAX_VALUE}var boundsChangedHandler=function(){google.maps.event.clearListeners(map,"bounds_changed");var bounds=map.getBounds();var markers_placed=0;var mapperFunction=function(maps_result){new google.maps.Marker({map:map,position:maps_result.geometry.location});markers_placed++};var geocodeHandler=function(results,status){var has_exact_match=false;if(status==google.maps.GeocoderStatus.OK){results.slice(0,max_results).map(function(result){mapperFunction(result);has_exact_match=has_exact_match||!result.partial_match})}else{TS.warn("Geocoder failed due to: "+status)}if(!has_exact_match&&markers_placed<max_results){var place=new google.maps.places.PlacesService(map);var nearbySearchHandler=function(results,status){if(status==google.maps.places.PlacesServiceStatus.OK){results.slice(0,max_results-markers_placed).map(mapperFunction)}else{TS.warn("PlacesService failed due to: "+status)}};place.nearbySearch({bounds:bounds,name:config.query},nearbySearchHandler)}};geocoder.geocode({address:config.query,bounds:bounds},geocodeHandler)};google.maps.event.addListener(map,"bounds_changed",boundsChangedHandler)}});var _googmap_index=0})();(function(){"use strict";TS.registerModule("msg_edit",{edit_started_sig:new signals.Signal,edit_ended_sig:new signals.Signal,editing:false,editing_in_msg_pane:false,deleting_from_editing:false,current_msg:null,current_model_ob:null,$msg:null,edit_interv:0,onStart:function(){},onCountDownInterval:function(){if(!TS.msg_edit.current_msg)return;if(TS.model.team.prefs.msg_edit_window_mins==-1){$("#edit_countdown").empty();return}var exp=TS.utility.date.toDateObject(TS.msg_edit.current_msg.ts).getTime()+TS.model.team.prefs.msg_edit_window_mins*60*1e3;var seconds=Math.floor((exp-Date.now())/1e3);if(seconds<1){$("#edit_countdown").html("(your time to edit ran out)&nbsp&nbsp&nbsp&nbsp")}else if(seconds<61){$("#edit_countdown").html("(you have <b>"+seconds+"</b> seconds)&nbsp&nbsp&nbsp&nbsp")}else{$("#edit_countdown").empty()}},cancelEditingINothingHasChanged:function(){if(!TS.msg_edit.editing)return true;var original_msg_text=TS.format.unFormatMsg(TS.msg_edit.current_msg.text);var edited_text=$("#message_edit_form").find("#msg_text").val();if(edited_text===original_msg_text){if(TS.model.team.domain=="tinyspeck")console.log("13921 cancelEditingINothingHasChanged: text has not changed, cancelling");TS.msg_edit.onCancelEdit();return true}return false},editExpiration:function(minutes){var expiration_text="<p>Oops&mdash;";if(minutes>0){var msg_edit_duration_text=_getReadableMessageEditDuration(minutes);expiration_text+="Messages can only be edited up to <b>"+msg_edit_duration_text+"</b> after posting.</p><p>Never mind, we all make mistakes. Post again!</p>";if(TS.model.user.is_admin){expiration_text+='<p>(To adjust the message editing window, visit <a href="/admin/settings#message_editing" target="_new">Team&nbsp;Settings</a>.)</p>'}}else{expiration_text+="You cannot edit your message after posting.</p>";if(TS.model.user.is_admin){expiration_text+='<p>(To enable message editing, visit <a href="/admin/settings#message_editing" target="_new">Team&nbsp;Settings</a>.)</p>'}}return expiration_text},startEdit:function(msg_ts,model_ob,edit_state){if($("#message_edit_form").length&&!TS.msg_edit.cancelEditingINothingHasChanged()){TS.msg_edit.promptEdit();return}if(!msg_ts){TS.error("no msg_ts?");return null}if(!model_ob){TS.error("no model_ob?");return null}if(!model_ob.msgs){TS.error("no model_ob.msgs?");return null}var msg=TS.utility.msgs.getMsg(msg_ts,_getMsgs(model_ob));if(!msg){TS.error("no msg in msgs?");return null}var original_msg_text=TS.format.unFormatMsg(msg.text);var is_reopening_after_failed_edit=edit_state&&edit_state.force_reopen;if(!is_reopening_after_failed_edit){if(TS.model.team.prefs.msg_edit_window_mins>=0&&(Date.now()-TS.utility.date.toDateObject(msg.ts))/6e4>TS.model.team.prefs.msg_edit_window_mins){TS.generic_dialog.alert(TS.msg_edit.editExpiration(TS.model.team.prefs.msg_edit_window_mins),"Editing Unavailable","Got It");return}}TS.msg_edit.current_msg=msg;TS.msg_edit.current_model_ob=model_ob;var was_at_bottom=TS.client&&TS.client.ui.areMsgsScrolledToBottom();var msg_el;if(edit_state=="convo"){var include_relatives=true;TS.msg_edit.editing_in_msg_pane=false;msg_el=TS.msg_edit.getDivForMsg(msg.ts,include_relatives).filter("ts-conversation ts-message")}else{TS.msg_edit.editing_in_msg_pane=true;msg_el=TS.msg_edit.getDivForMsg(msg.ts).not("ts-conversation ts-message")}TS.msg_edit.$msg=msg_el;msg_el.addClass("hidden");var edit_text=original_msg_text;if(edit_state&&edit_state.text){edit_text=edit_state.text}var html=TS.templates.message_edit_form({msg:msg,edit_text:edit_text,permalink:TS.utility.msgs.constructMsgPermalink(model_ob,msg.ts),first_in_block:msg_el.hasClass("first"),include_emo:!!TS.client});msg_el.after(html);var form=$("#message_edit_form");var input=form.find("#msg_text");TS.msg_edit.checkLengthOK(input);TS.info("message_edit_form added");TS.msg_edit.editing=true;TS.msg_edit.edit_started_sig.dispatch();form.bind("destroyed",function(){if(TS.model.team.domain=="tinyspeck")console.log("13921 message_edit_form removed");TS.info("message_edit_form removed");TS.msg_edit.editing=false;TS.msg_edit.editing_in_msg_pane=false;TS.msg_edit.edit_ended_sig.dispatch();TS.msg_edit.resetEditUI()});input.TS_tabComplete({complete_cmds:false,complete_channels:true,complete_user_groups:true,complete_emoji:true,complete_member_specials:true,no_tab_out:true,onComplete:function(txt){TS.utility.populateInput(input,txt)},sort_by_membership:true});input.tab_complete_ui({id:"msg_edit_tab_ui",scroll_with_element:!!TS.client});form.bind("submit",function(e){if(TS.model.team.domain=="tinyspeck")console.log("13921 message_edit_form submit");e.preventDefault();var edited_text=input.val();if(edited_text===original_msg_text){if(TS.model.team.domain=="tinyspeck")console.log("13921 message_edit_form submit no changes");TS.msg_edit.onCancelEdit();return}if(!edited_text){TS.msg_edit.startDelete(TS.msg_edit.current_msg.ts,TS.msg_edit.current_model_ob,TS.msg_edit.onCancelEdit,true);return}var blocked_keyword=TS.ui.needToBlockAtChannelKeyword(edited_text,null,TS.msg_edit.current_model_ob.id);if(blocked_keyword){TS.generic_dialog.alert("<p>A team owner has restricted the use of <b>"+TS.utility.htmlEntities(blocked_keyword)+"</b> messages.</p>");return}if(!$.trim(edited_text))return;TS.msg_edit.onConfirmEdit(edited_text)});input.bind("textchange",function(e,prev_txt){TS.msg_edit.checkLengthOK(input)}).bind("keyup",function(e){var selection;var msgs_scroller_dimensions=TS.client&&TS.client.ui.getCachedDimensionsRect("cached_msgs_scroller_rect",TS.client.ui.$msgs_scroller_div);if(window.getSelection){selection=window.getSelection();if(selection&&selection.toString&&!selection.toString()){if(!TS.client||form.outerHeight()<msgs_scroller_dimensions.height){$("#edit_controls").scrollintoview({px_offset:-50})}}}}).bind("keydown",function(e){if(e.which==TS.utility.keymap.enter&&(e.ctrlKey||e.altKey)){if(!TS.model.is_mac||TS.model.is_FF){var p=input.getCursorPosition();var val=input.val();input.val(val.substr(0,p)+"\n"+val.substr(p)).trigger("autosize.resize").setCursorPosition(p+1)}}else if(e.which==TS.utility.keymap.enter){if(TS.model.prefs.enter_is_special_in_tbt&&TS.utility.isCursorWithinTBTs(input)&&!e.shiftKey){return}else if(TS.model.prefs.enter_is_special_in_tbt&&TS.utility.isCursorWithinTBTs(input)&&e.shiftKey){e.preventDefault();TS.msg_edit.checkAndSubmit(input,form);return}else if(input.tab_complete_ui("isShowing")){e.preventDefault();return}else if(!e.shiftKey&&!e.altKey){e.preventDefault();TS.msg_edit.checkAndSubmit(input,form);return}}}).autosize({boxOffset:18});$("body").bind("keydown.close_message_edit_form",function(e){if(e.which==TS.utility.keymap.esc){if(input.tab_complete_ui("isShowing")||input.tab_complete_ui("wasJustHidden"))return;if(!TS.model.menu_is_showing&&!TS.model.dialog_is_showing)setTimeout(TS.msg_edit.onCancelEdit,0)}});form.find("#commit_edit").bind("click",function(){TS.msg_edit.checkAndSubmit(input,form)});form.find("#cancel_edit").bind("click",function(){TS.msg_edit.onCancelEdit()});var $emo_menu=form.find(".emo_menu");$emo_menu.removeClass("hidden");$emo_menu.bind("click.open_dialog",function(e){TS.emoji_menu.startEmo(e,"#msg_text")});if(TS.client&&was_at_bottom){TS.client.ui.instaScrollMsgsToBottom(false)}var msgs_scroller_dimensions=TS.client&&TS.client.ui.getCachedDimensionsRect("cached_msgs_scroller_rect",TS.client.ui.$msgs_scroller_div);if(!TS.client||form.outerHeight()<msgs_scroller_dimensions.height){$("#edit_controls").scrollintoview({duration:500,px_offset:-50,complete:function(){TS.msg_edit.focusAndSetCursorPosition(input,edit_state)}})}else{TS.msg_edit.focusAndSetCursorPosition(input,edit_state);$("#edit_controls").scrollintoview({duration:500,px_offset:-50})}$("#msg_text").attr("spellcheck",!!TS.model.prefs.webapp_spellcheck);TS.msg_edit.onCountDownInterval();TS.msg_edit.edit_interv=setInterval(TS.msg_edit.onCountDownInterval,1e3)},checkLengthOK:function(input){var too_long=input.val().length>TS.model.input_maxlength;if(too_long){$("#edit_warning").removeClass("hidden");$("#edit_saver").addClass("hidden");return false}else{$("#edit_warning").addClass("hidden");$("#edit_saver").removeClass("hidden");return true}},checkAndSubmit:function(input,form){if(TS.model.team.domain=="tinyspeck")console.log("13921 checkAndSubmit");if(TS.msg_edit.checkLengthOK(input)){form.submit()}},onConfirmEdit:function(edited_text){if(!TS.msg_edit.current_msg){TS.error("no TS.msg_edit.current_msg?");return null}if(!edited_text){TS.error("no edited_text?");return null}TS.msg_edit.commitEditInternal(edited_text);TS.msg_edit.resetEditUI()},onCancelEdit:function(){if(TS.model.team.domain=="tinyspeck")console.log("13921 onCancelEdit");if(!TS.msg_edit.current_msg){TS.error("no TS.msg_edit.current_msg?");return null}TS.msg_edit.resetEditUI();if(TS.view)TS.view.focusMessageInput()},resetEditUI:function(){if(TS.model.team.domain=="tinyspeck")console.log("13921 resetEditUI");clearInterval(TS.msg_edit.edit_interv);if(!TS.msg_edit.current_msg){TS.error("no TS.msg_edit.current_msg?");return null}if(TS.msg_edit.$msg)TS.msg_edit.$msg.removeClass("hidden");$("#message_edit_container").remove();$("body").unbind("keydown.close_message_edit_form");TS.msg_edit.$msg=null},getDivForMsg:function(ts,include_relatives){if(TS.replies&&TS.replies.isEnabled()&&$("ts-conversation").length){var $all_instances=$('ts-message[data-ts="'+ts+'"]');if(include_relatives){return $all_instances}var $non_relative_instances=$all_instances.not("ts-relatives ts-message");if($non_relative_instances.length){return $non_relative_instances}}return $("#"+TS.templates.makeMsgDomId(ts))},commitEditInternal:function(edited_text){TS.msg_edit.commitEdit(TS.msg_edit.current_msg,TS.msg_edit.current_model_ob,edited_text)},commitEdit:function(msg,model_ob,edited_text,attempts,delay_ms){if(!msg){TS.error("no msg?");return null}if(!model_ob){TS.error("no model_ob?");return null}if(!attempts)attempts=0;if(!delay_ms)delay_ms=100;TS.api.call("chat.update",{channel:model_ob.id,ts:msg.ts,text:TS.format.cleanMsg(edited_text),_attempts:attempts,_delay_ms:delay_ms},function(ok,data,args){if(ok){if(TS.web||model_ob.is_channel&&!model_ob.is_member){var new_msg=_.extend({},msg,{text:data.text,edited:{ts:TS.utility.date.makeTsStamp(null,"0")}});TS.utility.msgs.replaceMsg(model_ob,new_msg)}}else{if(!data||!data.error){TS.generic_dialog.alert("Sorry, something went wrong with editing your message. Try again in a moment.","Message editing failed")}else if(data.error=="message_not_found"){if(args._attempts<10){args._delay_ms*=1.75;setTimeout(function(){TS.msg_edit.commitEdit(msg,model_ob,edited_text,args._attempts,args._delay_ms)},args._delay_ms);return}if(model_ob.is_channel){TS.channels.removeMsg(model_ob.id,msg)}else if(model_ob.is_im){
TS.ims.removeMsg(model_ob.id,msg)}else if(TS.boot_data.feature_mpim_client&&model_ob.is_mpim){TS.mpims.removeMsg(model_ob.id,msg)}else if(model_ob.is_group){TS.groups.removeMsg(model_ob.id,msg)}TS.generic_dialog.alert("Sorry, something went wrong with editing your message. Try again in a moment.","Message editing failed")}else if(data.error=="edit_window_closed"){var error_text="<p>Sorry, but messages can only be edited for <b>"+_getReadableMessageEditDuration(TS.model.team.prefs.msg_edit_window_mins)+"</b> after posting.</p>";if(TS.model.user.is_admin){error_text+='<p>(To adjust the message editing window, visit <a href="/admin/settings#message_editing" target="_new">Team&nbsp;Settings</a>.)</p>'}TS.generic_dialog.alert(error_text,"Message editing failed")}else{TS.generic_dialog.alert("Sorry, something went wrong with editing your message. Try again in a moment.","Message editing failed")}TS.msg_edit.startEdit(msg.ts,model_ob,{text:edited_text,force_reopen:true})}})},promptEdit:function(){if($("#message_editing_info").css("display")!="none"){$("#message_edit_container").scrollintoview({duration:300,px_offset:0});return}$("#message_editing_info").css("display","");$("#message_editing_info").css("opacity",0);$("#message_edit_container").scrollintoview({duration:300,px_offset:0,complete:function(){$("#message_editing_info").transition({opacity:1},250)}})},startDelete:function(msg_ts,model_ob,onSuccessFunc,from_editing){if(!msg_ts){TS.error("no msg_ts?");return null}if(!model_ob){TS.error("no model_ob?");return null}if(!model_ob.msgs){TS.error("no model_ob.msgs?");return null}var msg=TS.utility.msgs.getMsg(msg_ts,_getMsgs(model_ob));if(!msg){TS.error("no msg in msgs?");return null}TS.msg_edit.deleting_from_editing=!!from_editing;TS.msg_edit.current_msg=msg;TS.msg_edit.current_model_ob=model_ob;var include_relatives=TS.replies&&TS.replies.isEnabledForModelOb(model_ob);var $msg_el=TS.msg_edit.getDivForMsg(msg.ts,include_relatives);var dialog_body='<p class="small_bottom_margin">Are you sure you want to delete this message? This cannot be undone.</p>';if(msg.subtype){var file_label;if(msg.file){file_label="file";if(msg.file.mode=="snippet"){file_label="snippet"}else if(msg.file.mode=="post"){file_label="post"}}var txt="";if(msg.subtype=="file_upload"){txt="Note that deleting this message will not delete the "+file_label+" that was uploaded."}else if(msg.subtype=="file_share"){txt="Note that deleting this message will not unshare the "+file_label+"."}else if(msg.subtype=="file_comment"){txt="Note that deleting this message will not delete the comment."}if(txt){dialog_body+="<p>"+txt+"</p>"}}$msg_el.addClass("delete_mode");TS.generic_dialog.start({title:"Delete Message",body:dialog_body+TS.templates.builders.buildMsgHTML({msg:msg,model_ob:model_ob,standalone:true}),go_button_text:"Yes, delete this message",go_button_class:"btn_danger",onGo:function(){if(TS.msg_edit.deleting_from_editing){TS.msg_edit.onCancelEdit()}TS.msg_edit.commitDeleteInternal(onSuccessFunc)},onCancel:function(){TS.msg_edit.onCancelDelete()}});TS.generic_dialog.div.find("img.msg_inline_img.hidden").each(function(index,element){var $element=$(element);$element.prop("src",$element.data("real-src"));$element.removeClass("hidden")})},onCancelDelete:function(){if(!TS.msg_edit.current_msg){TS.error("no TS.msg_edit.current_msg?");return null}var include_relatives=TS.replies&&TS.replies.isEnabled();var $msg_el=TS.msg_edit.getDivForMsg(TS.msg_edit.current_msg.ts,include_relatives);$msg_el.removeClass("delete_mode");if(TS.msg_edit.deleting_from_editing){$("#msg_text").focus()}},commitDeleteInternal:function(onSuccessFunc){TS.msg_edit.commitDelete(TS.msg_edit.current_msg,TS.msg_edit.current_model_ob,TS.msg_edit.onCancelDelete,onSuccessFunc)},commitDelete:function(msg,model_ob,onFailFunc,onSuccessFunc,no_fail_alert,attempts,delay_ms){if(!msg){TS.error("no msg?");return null}if(!model_ob){TS.error("no model_ob?");return null}var c_id=model_ob.id;if(!attempts)attempts=0;if(!delay_ms)delay_ms=100;if(msg.is_ephemeral||TS.utility.msgs.isTempMsg(msg)){if(model_ob.is_channel){TS.channels.removeMsg(model_ob.id,msg)}else if(model_ob.is_im){TS.ims.removeMsg(model_ob.id,msg)}else if(TS.boot_data.feature_mpim_client&&model_ob.is_mpim){TS.mpims.removeMsg(model_ob.id,msg)}else if(model_ob.is_group){TS.groups.removeMsg(model_ob.id,msg)}else{return}}else{if(msg._jl_rollup_hash&&msg._jl_rollup_hash.msg_ids){var msg_ids=msg._jl_rollup_hash.msg_ids;for(var i=0;i<msg_ids.length;i++){if(msg_ids[i]==msg.ts)continue;TS.api.call("chat.delete",{channel:c_id,ts:msg_ids[i],_attempts:attempts,_delay_ms:delay_ms},function(ok,data,args){if(ok||data.error=="message_not_found"){if(data.error=="message_not_found"){if(args._attempts<10){args._delay_ms*=1.75;setTimeout(function(){TS.msg_edit.commitDelete(msg,model_ob,onFailFunc,onSuccessFunc,no_fail_alert,args._attempts,args._delay_ms)},args._delay_ms);return}}if(TS.web||model_ob.is_channel&&!model_ob.is_member){if(model_ob.is_channel){TS.channels.removeMsg(model_ob.id,TS.utility.msgs.getMsg(args.ts,_getMsgs(model_ob)))}else if(model_ob.is_im){TS.ims.removeMsg(model_ob.id,TS.utility.msgs.getMsg(args.ts,_getMsgs(model_ob)))}else if(TS.boot_data.feature_mpim_client&&model_ob.is_mpim){TS.mpims.removeMsg(model_ob.id,TS.utility.msgs.getMsg(args.ts,_getMsgs(model_ob)))}else if(model_ob.is_group){TS.groups.removeMsg(model_ob.id,TS.utility.msgs.getMsg(args.ts,_getMsgs(model_ob)))}}}})}}TS.api.call("chat.delete",{channel:c_id,ts:msg.ts,_attempts:attempts,_delay_ms:delay_ms},function(ok,data,args){if(ok||data.error=="message_not_found"){if(data.error=="message_not_found"){if(args._attempts<10){args._delay_ms*=1.75;setTimeout(function(){TS.msg_edit.commitDelete(msg,model_ob,onFailFunc,onSuccessFunc,no_fail_alert,args._attempts,args._delay_ms)},args._delay_ms);return}}if(TS.web||model_ob.is_channel&&!model_ob.is_member){if(model_ob.is_channel){TS.channels.removeMsg(model_ob.id,msg)}else if(model_ob.is_im){TS.ims.removeMsg(model_ob.id,msg)}else if(TS.boot_data.feature_mpim_client&&model_ob.is_mpim){TS.mpims.removeMsg(model_ob.id,msg)}else if(model_ob.is_group){TS.groups.removeMsg(model_ob.id,msg)}}if(onSuccessFunc)onSuccessFunc()}else{if(onFailFunc)onFailFunc();if(!no_fail_alert){var txt="The message was not deleted.  The error was: "+(data&&data.error?data.error:"unknown");TS.generic_dialog.start({title:"Delete Message Failed",body:txt,show_cancel_button:false,esc_for_ok:true})}}if(TS.web){var all_deleted=!TS.utility.msgs.getDisplayedMsgs(model_ob.msgs).length;if(all_deleted){var prev_link=$(".pager .previous a");if(prev_link.attr("href")){window.location=prev_link.attr("href")}else{window.location.reload()}}}})}},$last_clicked_cb:null,startBatchDelete:function(){$("#msgs_div").addClass("selecting_messages");$("#channel_actions_div").addClass("hidden");$("#batch_delete_div").removeClass("hidden");TS.msg_edit.batchDeleteSelectionChanged()},cancelBatchDelete:function(){TS.msg_edit.selectNoneBatchDelete();$("#msgs_div").removeClass("selecting_messages");$("#channel_actions_div").removeClass("hidden");$("#batch_delete_div").addClass("hidden")},doBatchDelete:function(){var $cbs_checked=$("#msgs_div").find(".msg_select_cb:checked");var model_ob=TS.shared.getActiveModelOb();if($cbs_checked.length){var count=$cbs_checked.length;if(count==1){TS.msg_edit.startDelete($cbs_checked.eq(0).closest(".msg_actions").data("msg-ts"),model_ob,TS.msg_edit.cancelBatchDelete);return}var count_txt=count==1?"this message":"these "+count+" messages";var dialog_body='<p class="small_bottom_margin">Are you sure you want to delete '+count_txt+"? This cannot be undone! Note that deleting these messages will not delete any files or file comments.</p>";var prev_msg;var msg;for(var i=0;i<count;i++){if(msg&&!msg.no_display)prev_msg=msg;var msg_ts=$cbs_checked.eq(i).closest(".msg_actions").data("msg-ts");msg=TS.utility.msgs.getMsg(msg_ts,_getMsgs(model_ob));if(!msg)continue;dialog_body+=TS.templates.builders.buildMsgHTML({msg:msg,prev_msg:prev_msg,model_ob:model_ob,standalone:true})}var deleteThese=function(A){function deleteOne(msg){TS.msg_edit.commitDelete(msg,model_ob,next,next,true)}function next(){if(A.length){setTimeout(function(){deleteOne(A.pop())},100)}else{TS.generic_dialog.cancel();TS.generic_dialog.start({title:"",body:"Messages deleted.",show_cancel_button:false,esc_for_ok:true})}}TS.generic_dialog.start({title:"",body:"<P>Deleting messages...</p>",show_cancel_button:false,show_go_button:false});next()};TS.generic_dialog.start({title:"Delete Messages",body:dialog_body,go_button_text:"Yes, delete these messages",go_button_class:"btn_danger",onGo:function(){var A=[];for(var i=0;i<count;i++){var msg_ts=$cbs_checked.eq(i).closest(".message").data("ts");if(!msg_ts){alert("no msg_ts");return}var msg=TS.utility.msgs.getMsg(msg_ts,_getMsgs(model_ob));if(!msg){alert("no msg");return}A.push(msg)}TS.msg_edit.cancelBatchDelete();deleteThese(A)}})}else{}},batchDeleteSelectionChanged:function($cb,extend){var $last_clicked_cb=TS.msg_edit.$last_clicked_cb;if($last_clicked_cb&&$cb&&extend){var $cbs=$("#msgs_div").find(".msg_select_cb:visible");var start_i=$cbs.index($last_clicked_cb);var end_i=$cbs.index($cb);if(start_i>end_i){end_i=start_i;start_i=$cbs.index($cb)}var checked=$last_clicked_cb.prop("checked")=="checked";for(var i=start_i;i<=end_i;i++){$cbs.eq(i).prop("checked",checked)}}TS.msg_edit.$last_clicked_cb=$last_clicked_cb=$cb;var count_txt="0 messages";var $cbs_checked=$("#msgs_div").find(".msg_select_cb:checked");$("#msgs_div").find(".multi_delete_mode").removeClass("multi_delete_mode");if($cbs_checked.length){if($cbs_checked.length==1){count_txt="1 message"}else{count_txt=$cbs_checked.length+" messages"}$("#batch_delete_button").removeClass("disabled");$cbs_checked.each(function(){$(this).closest(".message").addClass("multi_delete_mode")})}else{$("#batch_delete_button").addClass("disabled")}$("#batch_delete_count_span").html(count_txt)},selectAllBatchDelete:function(){$("#msgs_div").find(".msg_select_cb:visible").prop("checked",true);TS.msg_edit.batchDeleteSelectionChanged()},selectNoneBatchDelete:function(){$("#msgs_div").find(".msg_select_cb:visible").prop("checked",false);TS.msg_edit.batchDeleteSelectionChanged()},pauseEditing:function(){if(!TS.msg_edit.editing)return;var $input=$("#msg_text");var text=$input.val();var cursor_start=$input.textrange("get","start");var cursor_length=$input.textrange("get","length");var edit_state={msg_ts:TS.msg_edit.current_msg.ts,model_ob:TS.msg_edit.current_model_ob,text:text,cursor_start:cursor_start,cursor_length:cursor_length};TS.msg_edit.resetEditUI();return edit_state},resumeEditing:function(edit_state){if(TS.msg_edit.editing)return;if(!edit_state)return;if(TS.model.active_cid!==edit_state.model_ob.id)return;if(!TS.msg_edit.getDivForMsg(edit_state.msg_ts))return;TS.msg_edit.startEdit(edit_state.msg_ts,edit_state.model_ob,edit_state)},focusAndSetCursorPosition:function(input,edit_state){input.focus();TS.utility.rAF(function(){if(edit_state&&_.isFinite(edit_state.cursor_start)&&_.isFinite(edit_state.cursor_length)){TS.utility.setCursorPosition("#msg_text",edit_state.cursor_start,edit_state.cursor_length)}else{TS.utility.setCursorPosition("#msg_text",1e8)}})}});var _getMsgs=function(model_ob){return TS.model.archive_view_is_showing&&model_ob._archive_msgs?model_ob._archive_msgs:model_ob.msgs};var _getReadableMessageEditDuration=function(minutes){if(minutes==1){return"1 minute "}var time=TS.utility.date.toTimeAmount(minutes);var expiration_text="";if(time.w>=1){expiration_text+=time.w+" week"+(time.w>1?"s ":" ")}if(time.d>=1){expiration_text+=time.d+" day"+(time.d>1?"s ":" ")}if(time.h>=1){expiration_text+=time.h+" hour"+(time.h>1?"s ":" ")}if(time.mi>=1){expiration_text+=time.mi+" minute"+(time.mi>1?"s ":" ")}return expiration_text}})();(function(){"use strict";TS.registerModule("ui.fs_modal",{is_showing:false,transition_duration:250,onStart:function(){},start:function(settings){if(TS.ui.fs_modal.is_showing)return void _swap(settings);if(settings){_current_settings=$.extend(TS.utility.clone(_default_settings),settings)}else{_current_settings=_default_settings}TS.ui.fs_modal.is_showing=true;_build();if(_current_settings.modal_class)_$div.addClass(_current_settings.modal_class);if(_current_settings.modal_contents_container_class)_$div.find(".contents_container").addClass(_current_settings.modal_contents_container_class);_$div_contents=_$div.find(".contents");_$div_sidebar=_$div.find("#fs_modal_sidebar");var body_html;if(_current_settings.body_template_html){body_html=_current_settings.body_template_html;if(_current_settings.body)TS.warn("Both body and body_template_html were passed in settings to TS.ui.fs_modal.start(). Using body_template.")}else{body_html=TS.templates.fs_modal_generic_contents({settings:_current_settings,fs_modal_header:_.includes(_current_settings.modal_class,"fs_modal_header"),fs_modal_footer:_.includes(_current_settings.modal_class,"fs_modal_footer")})}_$div_contents.html(body_html);if(_current_settings.sidebar_html)_$div_sidebar.html(_current_settings.sidebar_html);_$div.on("click",".dialog_go",_go);_$div.on("click",".dialog_secondary_go",_secondaryGo);_$div.on("click",".dialog_cancel",_cancel);$(window.document).on("keydown.fs_modal",_onKeyDown);_$div_close_btn.on("click",function(){if(_current_settings.esc_for_ok){_go()}else{_cancel()}});$("html").addClass("fs_modal_active");setTimeout(function(){_$bg.addClass("active");_$div.addClass("active")},0);if(_$div.find("input").length){_$div.find("input").first().focus()}else if(document.activeElement&&document.activeElement!==document.body){document.activeElement.blur()}if(_current_settings.onShow)_current_settings.onShow();if(_current_settings.onShowComplete){var triggered=false;var end_event=_getTransitionEndEventName();var show_complete_timer=setTimeout(function(){triggered=true;_current_settings.onShowComplete();_$div.off(end_event+".fs_modal_show_complete")},600);_$div.one(end_event+".fs_modal_show_complete",function(){if(!triggered){clearTimeout(show_complete_timer);_current_settings.onShowComplete()}})}document.activeElement.blur()},close:function(force_close){_cancel(force_close)},bindBackButton:function(callback){$("#fs_modal_back_btn").off("click.fs_modal").on("click.fs_modal",callback)},unbindBackButton:function(){$("#fs_modal_back_btn").off("click.fs_modal")},showBackButton:function(){$("#fs_modal_back_btn").removeClass("hidden")},hideBackButton:function(){$("#fs_modal_back_btn").addClass("hidden")},activate:function(){_$div.addClass("active");_$bg.addClass("active")},deactivate:function(){_$div.removeClass("active");_$bg.removeClass("active")}});var _$div;var _$bg;var _$div_close_btn;var _$div_contents;var _$div_sidebar;var _current_settings=null;var _default_settings={title:"",body:"",body_template_html:null,show_go_button:true,show_secondary_go_button:false,show_cancel_button:true,go_button_text:"OK",go_button_class:"",secondary_go_button_text:"OK 2",secondary_go_button_class:"",cancel_button_text:"Cancel",onGo:null,onSecondaryGo:null,onCancel:null,onEnd:null,esc_for_ok:false,onShow:null,enter_always_gos:false,fullscreen:false,modal_class:null,modal_contents_container_class:null,sidebar_html:null};var _build=function(){var template_data={settings:_current_settings,fs_modal_header:_.includes(_current_settings.modal_class,"fs_modal_header"),fs_modal_footer:_.includes(_current_settings.modal_class,"fs_modal_footer"),fs_modal_sidebar:_.includes(_current_settings.modal_class,"fs_modal_sidebar")};var html=TS.templates.fs_modal(template_data);$("body").append(html);_$bg=$("#fs_modal_bg");_$div=$("#fs_modal");_$div_close_btn=$("#fs_modal_close_btn")};var _go=function(){if(!TS.ui.fs_modal.is_showing){TS.error("not showing?");return}if(_current_settings.onGo){if(_current_settings.onGo()!==false){_cancel()}}else{_cancel()}};var _secondaryGo=function(e){if(!TS.ui.fs_modal.is_showing){TS.error("not showing?");return}if(_current_settings.onSecondaryGo){if(_current_settings.onSecondaryGo()!==false){_cancel()}}else{_cancel()}};var _onKeyDown=function(e){if(e.which==TS.utility.keymap.enter&&(TS.utility.getActiveElementProp("NODENAME")=="BODY"||_current_settings.enter_always_gos)){if(_current_settings.show_go_button){_go();e.preventDefault()}}else if(e.which==TS.utility.keymap.esc&&TS.utility.getActiveElementProp("NODENAME")=="BODY"){if(_current_settings.esc_for_ok){_go()}else{_cancel()}}};var _cancel=function(force_close){if(_canClose(force_close)){_$div.removeClass("active");_$bg.removeClass("active");setTimeout(function(){$("html").removeClass("fs_modal_active")},TS.ui.fs_modal.transition_duration);if(_current_settings.onCancel)_current_settings.onCancel();_end()}};var _end=function(){TS.ui.fs_modal.is_showing=false;setTimeout(function(){_$div.remove();_$bg.remove()},TS.ui.fs_modal.transition_duration);$(window.document).off("keydown.fs_modal").off("resize.fs_modal");if(_current_settings.onEnd)_current_settings.onEnd()};var _swap=function(settings){_$div.removeClass("active");if(_current_settings.onCancel)_current_settings.onCancel();TS.ui.fs_modal.is_showing=false;$(window.document).off("keydown.fs_modal").off("resize.fs_modal");var $bg=_$bg.attr("id",null).addClass("fs_modal_bg");setTimeout(function(){_$div.remove();TS.ui.fs_modal.start(settings);setTimeout($bg.remove.bind($bg),TS.ui.fs_modal.transition_duration)},TS.ui.fs_modal.transition_duration)};var _getTransitionEndEventName=function(){var event_names={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",transition:"transitionend"};for(var name in event_names){if(_$div[0].style[name]!==undefined){return event_names[name]}}};var _canClose=function(force_close){if(force_close)return true;if(TS.emoji_menu.is_showing)return false;if(TS.model.menu_is_showing)return false;if(TS.model.dialog_is_showing)return false;if(TS.utility.isTabCompleteShowing())return false;return true}})();(function(){"use strict";TS.registerModule("ui.admin_invites",{invites_sent_sig:new signals.Signal,emails_parsed_sig:new signals.Signal,onStart:function(){TS.ui.admin_invites.invites_sent_sig.add(_invitesSent,TS.ui.admin_invites);TS.ui.admin_invites.emails_parsed_sig.add(_emailsParsed,TS.ui.admin_invites);TS.team.team_email_domain_changed_sig.add(_setPlaceholderEmailAddress,TS.ui.admin_invites);TS.prefs.team_auth_mode_changed_sig.add(_applySSORestrictions,TS.ui.admin_invites);TS.prefs.team_sso_auth_restrictions_changed_sig.add(_applySSORestrictions,TS.ui.admin_invites);TS.prefs.team_invites_only_admins_changed_sig.add(TS.ui.admin_invites.maybeShowInviteLink,TS.ui.admin_invites);if(TS.web)TS.web.login_sig.add(TS.ui.admin_invites.onLogin,TS.ui.admin_invites);if(TS.client)TS.client.login_sig.add(TS.ui.admin_invites.onLogin,TS.ui.admin_invites);_unprocessed_invites=TS.storage.fetchInvitesState();$("body").on("click",'[data-action="admin_invites_modal"]',function(){_start($(this).data("account-type"))})},onLogin:function(){_setPlaceholderEmailAddress()},start:function(){if(_canInvite())_start()},switchToPicker:function(){if(_canInvite())_switchToPicker()},maybeShowInviteLink:function(){if(!TS.client)return;var show_invite_link=false;var show_invite_link_label=false;var dim_invite_link=false;if(_canInvite()&&TS.members.getActiveMembersWithSelfAndNotSlackbot().length<26){show_invite_link=true}if(_canInvite()&&TS.members.getActiveMembersExceptSelfAndSlackbot().length===0){show_invite_link_label=true}if(_canInvite()&&TS.members.getActiveMembersWithSelfAndNotSlackbot().length>=2){dim_invite_link=true}$("#channel_list_invites_link_label").toggleClass("hidden",!show_invite_link_label);$("#channel_list_invites_link").toggleClass("hidden",!show_invite_link).toggleClass("dim",dim_invite_link)},populateInvites:function(invites){if(!_canInvite())return;if(!invites)return;var invites_map=_unprocessed_invites.reduce(function(accumulator,invite){accumulator[invite.email]=true;return accumulator},{});invites.forEach(function(invite){if(!invites_map[invite.email]){invites_map[invite.email]=true;_unprocessed_invites.push(invite)}});TS.storage.storeInvitesState(_unprocessed_invites);if(_unprocessed_invites.length&&TS.ui.fs_modal.is_showing){_$div.find(".admin_invite_row").remove();_unprocessed_invites.forEach(function(invite){_addRow(invite)})}},canInvite:function(){return _canInvite()}});var _$div;var _row_index=0;var _queue_size=0;var _success_invites=[];var _error_invites=[];var _unprocessed_invites=[];var _placeholder_email_address_default="name@domain.com";var _placeholder_email_address=_placeholder_email_address_default;var _new_email_domains="";var _custom_message="";var _error_map={url_in_message:"Sorry, but URLs are not allowed in the custom message. Please remove it and try again!",invalid_email:"That doesn't look like a valid email address!",already_in_team:"This person is already on your team.",already_invited:"This person has already been invited to your team.",sent_recently:"This person was recently invited. No need to invite them again just yet.",invite_failed:"Something went wrong with this invite :(",ura_limit_reached:"You've reached your team limit for Single-channel Guests. You must invite more paid team members first.",user_limit_reached:"You've reached the maximum number of users for this team.",not_allowed:"You can't invite this type of account based on your current SSO settings.",domain_mismatch:"Your SSO settings prevent you from inviting people from this email domain."};var _start=function(account_type){account_type=TS.model.user.is_admin?account_type:"full";var body_template_html=TS.templates.admin_invite_modal({can_add_ura:TS.model.can_add_ura,team_has_paid:TS.model.team.plan!=="",team_name:TS.model.team.name,hide_full_member_option:TS.model.team.prefs.auth_mode=="saml"&&(TS.model.team.prefs.sso_auth_restrictions===0||TS.model.team.prefs.sso_auth_restrictions===1),team_signup_url:"https://"+TS.model.team.domain+".slack.com/signup"});var settings={body_template_html:body_template_html,onShow:_onShow,onCancel:_onCancel};if(TS.client)TS.ui.a11y.saveCurrentFocus();TS.ui.fs_modal.start(settings);if(account_type){setTimeout(function(){_switchAccountType(account_type)},0)}};var _onShow=function(){var $custom_message_container;_$div=$("#admin_invites_container");_$div.find("#admin_invites_switcher").find('[data-action="switch_type"]').on("click",function(e){var $el=$(e.target);if($el.is("a"))return;if($el.closest(".admin_invites_account_type_option").hasClass("disabled"))return;_switchAccountType($(this).data("account-type"))});_$div.find('[data-action="admin_invites_add_row"]').on("click",_addRow);_$div.find('a[data-action="admin_invites_switch_view"]').on("click",function(){_switchInviteView($(this).data("view"))});_$div.find('button[data-action="api_send_invites"]').on("click",function(e){e.preventDefault();_send()});_$div.find('[data-action="open_switcher"]').on("click",function(){_switchToPicker()});_$div.find('button[data-action="api_parse_emails"]').on("click",function(e){e.preventDefault();_parseEmails();$(this).find(".ladda-label").text("Processing email addresses ...")});$custom_message_container=_$div.find(".admin_invites_custom_message_container");_$div.find('a[data-action="admin_invites_show_custom_message"]').on("click",function(){_showCustomMessage()});_$div.find('[data-action="admin_invites_hide_custom_message"]').on("click",function(){_hideCustomMessage()}).hover(function(){$custom_message_container.addClass("delete_highlight")},function(){$custom_message_container.removeClass("delete_highlight")});_$div.find("#admin_invite_custom_message").on("input",_toggleSubmitButton);_$div.find("#bulk_emails").css("overflow","hidden").autogrow();_unprocessed_invites=TS.storage.fetchInvitesState();if(_unprocessed_invites.length){TS.ui.admin_invites.populateInvites(_unprocessed_invites)}else{_addRow()}};var _onCancel=function(){_row_index=0;_queue_size=0;_unprocessed_invites=_error_invites.length?[]:_prepareInvites();_success_invites=[];_error_invites=[];TS.storage.storeInvitesState(_unprocessed_invites);if(TS.client)TS.ui.a11y.restorePreviousFocus()};var _setPlaceholderEmailAddress=function(){_placeholder_email_address=_placeholder_email_address_default};var _addRow=function(email){var show_delete_btn=true;if(_$div.find(".admin_invite_row").length===0){show_delete_btn=false}else{_$div.find(".admin_invite_row").first().find(".delete_row").removeClass("hidden")}_$div.find("#invite_rows").append(TS.templates.admin_invite_row({index:_row_index,show_delete_btn:show_delete_btn,placeholder_email_address:_placeholder_email_address}));var $row=_$div.find("#invite_"+_row_index);$row.find('[data-action="admin_invites_delete_row"]').on("click",function(){_removeRow($row)}).hover(function(){$row.addClass("delete_highlight")},function(){$row.removeClass("delete_highlight")});if(email){$row.find('[name="email_address"]').val(email.email);$row.find('[name="first_name"]').val(email.first_name);$row.find('[name="last_name"]').val(email.last_name)}_updateSendButtonLabel();_row_index++};var _showCustomMessage=function(){_$div.find(".admin_invites_hide_custom_message").addClass("hidden");_$div.find(".admin_invites_show_custom_message").removeClass("hidden");_toggleSubmitButton()};var _hideCustomMessage=function(){_$div.find(".admin_invites_hide_custom_message").removeClass("hidden");_$div.find(".admin_invites_show_custom_message").addClass("hidden");_toggleSubmitButton()};var _toggleSubmitButton=function(){var custom_message=_$div.find("#admin_invite_custom_message").val().trim();var $show_custom_message=_$div.find(".admin_invites_show_custom_message");var disable_submit_btn=!!TS.utility.findUrls(custom_message).length&&!$show_custom_message.hasClass("hidden");_$div.find("#admin_invites_submit_btn").toggleClass("disabled",disable_submit_btn)};var _removeRow=function($row){if(!$row||!$row.length)return;$row.slideToggle(100,function(){$row.remove();var row_count=$(".admin_invite_row").length;if(row_count===0){_addRow()}else if(row_count===1){_$div.find(".admin_invite_row").first().find(".delete_row").addClass("hidden")}_updateSendButtonLabel()})};var _updateSendButtonLabel=function(){var invite_count=$(".admin_invite_row").length;var label="Invite "+invite_count+" ";var account_type=$("#account_type").val();if(account_type=="full"){if(invite_count===1){label+="Person"}else{label+="People"}}else if(account_type=="restricted"){label+=TS.templates.builders.raLabel("Restricted Account");if(invite_count>1)label+="s"}else if(account_type=="ultra_restricted"){label+="Single-Channel Guest";if(invite_count>1)label+="s";if($("#ultra_restricted_channel_picker").val()){label+=" to "+$("#ultra_restricted_channel_picker")[0].options[$("#ultra_restricted_channel_picker")[0].selectedIndex].text}}_$div.find('button[data-action="api_send_invites"]').find(".ladda-label").text(label)};var _applySSORestrictions=function(){var invite_type=_$div.find("#account_type").val();var show_google_auth_email_domain_notice=false;var show_sso_signup_notice=false;if((TS.model.team.prefs.auth_mode=="google"||TS.model.team.prefs.auth_mode=="saml")&&TS.model.team.prefs.sso_auth_restrictions===0){show_sso_signup_notice=true}if(TS.model.team.prefs.auth_mode=="google"){if(invite_type=="full"&&(TS.model.team.prefs.sso_auth_restrictions===0||TS.model.team.prefs.sso_auth_restrictions===1)){show_google_auth_email_domain_notice=true}else if((invite_type=="restricted"||invite_type=="ultra_restricted")&&TS.model.team.prefs.sso_auth_restrictions===0){show_google_auth_email_domain_notice=true}}else if(TS.model.team.prefs.auth_mode=="saml"){if(TS.model.team.prefs.sso_auth_restrictions===0||TS.model.team.prefs.sso_auth_restrictions===1){if(invite_type=="full"){var admin_invites_switcher_html=TS.templates.admin_invite_switcher({can_add_ura:TS.model.can_add_ura,team_has_paid:TS.model.team.plan!=="",hide_full_member_option:TS.model.team.prefs.auth_mode=="saml"&&(TS.model.team.prefs.sso_auth_restrictions===0||TS.model.team.prefs.sso_auth_restrictions===1),team_signup_url:"https://"+TS.model.team.domain+".slack.com/signup"});$("#admin_invites_switcher").html(admin_invites_switcher_html);_switchToPicker()}}}$("#google_auth_email_domain_notice").toggleClass("hidden",!show_google_auth_email_domain_notice);$("#sso_signup_notice").toggleClass("hidden",!show_sso_signup_notice)};var _selectRow=function(email){var $row;_$div.find('input[name="email_address"]').each(function(){if($(this).val()==email){$row=$(this).closest(".admin_invite_row")}});return $row};var _rowError=function($row,error){var error_msg=_error_map[error];if($row){$row.find("label.email").addClass("error").end().find(".error_msg").removeClass("hidden").text(error_msg).end().find("input").prop("disabled",false)}};var _rowValid=function($row){if($row){$row.find("label.email").removeClass("error").end().find(".error_msg").addClass("hidden").end().find("input").prop("disabled",false)}};var _resetIndividualForm=function(){setTimeout(function(){Ladda.stopAll();_$div.find(".admin_invite_row").remove();_success_invites=[];_error_invites=[];_updateSendButtonLabel();_addRow()},0)};var _resetBulkForm=function(){setTimeout(function(){Ladda.stopAll();_$div.find('button[data-action="api_parse_emails"]').find(".ladda-label").text("Add Invitees");_$div.find("#bulk_emails").prop("disabled",false)},0)};var _switchToPicker=function(){_$div.find("#admin_invites_header").removeClass("cursor_pointer").find(".admin_invites_header_type").removeClass("normal").text("people").end().find(".admin_invites_header_team_name").removeClass("hidden");_$div.find("#admin_invites_switcher").removeClass("hidden");_$div.find("#admin_invites_workflow").addClass("hidden");TS.ui.fs_modal.hideBackButton()};var _switchInviteView=function(view){if(view=="individual"){_$div.find("#individual_invites").removeClass("hidden");_$div.find("#bulk_invites, #bulk_notice").addClass("hidden");_$div.find("#bulk_emails").val("");_$div.find(".email_field").first().focus();_resetBulkForm()}else if(view=="bulk"){_$div.find("#bulk_invites").removeClass("hidden");_$div.find("#individual_invites").addClass("hidden");var $bulk_submit_btn=_$div.find('button[data-action="api_parse_emails"]');if(!$bulk_submit_btn.hasClass("ladda")){Ladda.bind('button[data-action="api_parse_emails"]');$bulk_submit_btn.addClass("ladda")}$bulk_submit_btn.find(".ladda-label").text("Add Invitees");var invites=_prepareInvites();if(invites){var invites_bulk="";$.each(invites,function(index,invite){if(invite.first_name)invites_bulk+=invite.first_name+" ";if(invite.last_name)invites_bulk+=invite.last_name+" ";invites_bulk+="<"+invite.email+">, "});_$div.find("#bulk_emails").val(invites_bulk).autogrow()}_$div.find("#bulk_emails").focus()}};var _switchAccountType=function(invite_type){var channels=TS.channels.getUnarchivedChannelsForUser();TS.boot_data.default_channels.forEach(function(default_channel){channels.forEach(function(channel){if(channel.id==default_channel.id){channel.is_default=true}})});var channel_picker_html=TS.templates.admin_invite_channel_picker({invite_type:invite_type,channels:channels,default_channels:TS.boot_data.default_channels,general_name:TS.channels.getGeneralChannel().name,groups:TS.groups.getUnarchivedGroups(),email_domains:TS.model.team.email_domain.split(","),is_admin:TS.model.user.is_admin});var invite_type_label="Full Members";if(invite_type=="restricted"){invite_type_label=TS.templates.builders.raLabel("Restricted Accounts")}else if(invite_type=="ultra_restricted"){invite_type_label="Single-Channel Guests"}_$div.find("#admin_invites_header").addClass("cursor_pointer").find(".admin_invites_header_type").addClass("normal").text(invite_type_label).end().find(".admin_invites_header_team_name").addClass("hidden");_$div.find("#admin_invites_channel_picker_container").html(channel_picker_html);_$div.find("#account_type").val(invite_type);_$div.find("#admin_invites_switcher, #admin_invites_workflow").toggleClass("hidden");_$div.find("#admin_invites_billing_notice").toggleClass("hidden",!(TS.model.team.plan!==""&&invite_type!="ultra_restricted"));
_$div.find("#ura_warning").toggleClass("hidden",invite_type!="restricted"&&invite_type!="ultra_restricted");_$div.find("#ultra_restricted_channel_picker").on("change",_updateSendButtonLabel);_$div.find(".email_field").first().focus();var $submit_btn=_$div.find('button[data-action="api_send_invites"]');if(!$submit_btn.hasClass("ladda")){Ladda.bind('button[data-action="api_send_invites"]');$submit_btn.addClass("ladda")}_updateSendButtonLabel();_applySSORestrictions();_$div.find("#defaultchannelsmulti, #ultra_restricted_channel_picker").filterSelect().addClass("hidden");if(TS.model.user.is_admin){TS.ui.fs_modal.bindBackButton(TS.ui.admin_invites.switchToPicker);TS.ui.fs_modal.showBackButton()}};var _prepareInvites=function(){var invites=[];var email,first_name,last_name;_$div.find(".admin_invite_row").each(function(){email=$.trim($(this).find('[name="email_address"]').val());first_name=$.trim($(this).find('[name="first_name"]').val());last_name=$.trim($(this).find('[name="last_name"]').val());if(email){var invite={};invite.email=email;if(first_name)invite.first_name=first_name;if(last_name)invite.last_name=last_name;invites.push(invite)}else{if($(".admin_invite_row").length>1){_removeRow($(this))}}});_unprocessed_invites=invites;TS.storage.storeInvitesState(_unprocessed_invites);return invites};var _send=function(){var validation_error=false;_$div.find(".admin_invite_row").each(function(){var email=$.trim($(this).find('[name="email_address"]').val());if(email){if(!TS.utility.email_regex.test(email)){_rowError($(this),"invalid_email");validation_error=true}else{_rowValid($(this))}}else{if($(".admin_invite_row").length>1){_removeRow($(this))}}});if(validation_error){setTimeout(Ladda.stopAll,0);return}var invites=_prepareInvites();if(!invites.length){_$div.find("#invite_notice").html('<i class="ts_icon ts_icon_info_circle"></i> Add at least one email address before sending invitations.').slideDown(100);setTimeout(Ladda.stopAll,0)}else if(invites){_$div.find(".admin_invite_row").find("input").prop("disabled",true);var account_type=_$div.find("#account_type").val();var $show_custom_message=_$div.find(".admin_invites_show_custom_message");var $custom_message=_$div.find("#admin_invite_custom_message");var channels;if(account_type=="full"||account_type=="restricted"){var default_channels=_$div.find("#defaultchannelsmulti").val();if(default_channels)channels=default_channels.join(",")}else if(account_type=="ultra_restricted"){channels=_$div.find("#ultra_restricted_channel_picker").val()}if(!$show_custom_message.hasClass("hidden")){_custom_message=$custom_message.val()}else{_custom_message=""}_queue_size=invites.length;$.each(invites,function(index,invite){var args={email:invite.email};if(channels)args.channels=channels;if(_custom_message)args.extra_message=_custom_message;if(invite.first_name)args.first_name=invite.first_name;if(invite.last_name)args.last_name=invite.last_name;if(account_type=="restricted"){args.restricted=1}else if(account_type=="ultra_restricted"){args.ultra_restricted=1}TS.api.call("users.admin.invite",args,_onInviteSent)})}};var _onInviteSent=function(ok,data,args){if(ok){_success_invites.push({email:args.email,first_name:args.first_name,last_name:args.last_name});var $row=_selectRow(args.email);_removeRow($row)}else{if(data.error=="requires_channel"){setTimeout(Ladda.stopAll,0);_$div.find("#ra_channel_picker_header").highlightText();_$div.find("#invite_notice").html('<i class="ts_icon ts_icon_info_circle"></i> Pick at least one '+TS.templates.builders.channelOrPrivateGroupCopy()+" before inviting "+TS.templates.builders.raLabel("Restricted Accounts")+".").slideDown(100);_$div.find(".admin_invite_row").find("input").prop("disabled",false);return}else if(data.error=="requires_one_channel"){setTimeout(Ladda.stopAll,0);_$div.find("#ura_channel_picker_header").highlightText();_$div.find("#invite_notice").html('<i class="ts_icon ts_icon_info_circle"></i> Pick a '+TS.templates.builders.channelOrPrivateGroupCopy()+" before inviting Single-Channel Guests.").slideDown(100);_$div.find(".admin_invite_row").find("input").prop("disabled",false);return}else{_error_invites.push({email:args.email,error:data.error,error_msg:_error_map[data.error]})}}_queue_size--;if(_queue_size===0){_unprocessed_invites=[];TS.storage.storeInvitesState(_unprocessed_invites);var done=function(){setTimeout(Ladda.stopAll,0);TS.ui.admin_invites.invites_sent_sig.dispatch()};_new_email_domains=_collectNewDomains(_success_invites);if(_new_email_domains){TS.api.call("team.checkEmailDomains",{email_domains:_new_email_domains}).then(function(response){if(response.data.ok){_new_email_domains=response.data.email_domains}else{_new_email_domains=""}},function(response){_new_email_domains=""}).finally(done)}else{done()}}};var _invitesSent=function(){var account_type=$("#account_type").val();var success_invites_html;var plural_str=_success_invites.length>1?"s":"";if(account_type=="full"){success_invites_html="<strong>"+_success_invites.length+" Full Member"+plural_str+"</strong>"}else if(account_type=="restricted"){success_invites_html="<strong>"+_success_invites.length+" "+TS.templates.builders.raLabel("Restricted Account")+plural_str+"</strong>"}else if(account_type=="ultra_restricted"){success_invites_html="<strong>"+_success_invites.length+" Single-Channel Guest"+plural_str+"</strong>"}var html=TS.templates.admin_invite_summary({success_invites_html:success_invites_html,success_invites:_success_invites,error_invites:_error_invites,team_name:TS.model.team.name,domains:_new_email_domains,paid_team:""!==TS.model.team.plan,is_admin:TS.model.user.is_admin});_$div.find("#invite_notice").slideUp(100);_$div.find("#admin_invites_workflow, #admin_invites_header").addClass("hidden");_$div.find("#admin_invites_success").html(html).removeClass("hidden");function resetAndSwitchToIndividualForm(){_resetIndividualForm();$("#admin_invites_workflow, #admin_invites_success").toggleClass("hidden");$("#admin_invites_header").removeClass("hidden");TS.ui.fs_modal.bindBackButton(TS.ui.admin_invites.switchToPicker)}_$div.find('button[data-action="admin_invites_reset"]').on("click",resetAndSwitchToIndividualForm);TS.ui.fs_modal.bindBackButton(resetAndSwitchToIndividualForm);_$div.find('button[data-action="admin_invites_try_again"]').on("click",function(){$.each(_error_invites,function(index,invite){var $row=_selectRow(invite.email);_rowError($row,invite.error)});$("#admin_invites_workflow, #admin_invites_success").toggleClass("hidden");$("#admin_invites_header").removeClass("hidden");TS.ui.fs_modal.bindBackButton(TS.ui.admin_invites.switchToPicker);_success_invites=[];_error_invites=[]});if(_canSaveDomains()){var $btn=_$div.find('button[data-action="add_signup_domains"]').on("click",_saveDomains);_$div.on("keyup","#invite_signup_domains",TS.ui.resetButtonSpinner.bind(Object.create(null),$btn.get(0)))}};var _parseEmails=function(){var emails=$.trim($("#bulk_emails").val().replace(/[\u200B-\u200D\uFEFF]/g,""));_$div.find("#bulk_emails").prop("disabled",true);TS.api.call("users.admin.parseEmails",{emails:emails},_onEmailsParsed)};var _onEmailsParsed=function(ok,data,args){if(!ok){TS.error("failed onEmailsParsed");_$div.find("#bulk_notice").html('<i class="ts_icon ts_icon_warning"></i> Oops! There was an error processing those emails. Please try again.').removeClass("hidden");_resetBulkForm();return}if(data.emails.length===0){_$div.find("#bulk_notice").html('<i class="ts_icon ts_icon_warning"></i> We couldn\'t find any email addresses in that text. Please try again.').removeClass("hidden");_resetBulkForm();return}TS.ui.admin_invites.emails_parsed_sig.dispatch(data.emails)};var _emailsParsed=function(emails){_$div.find(".admin_invite_row").remove();_switchInviteView("individual");var html;if(emails.length==1){html='<i class="ts_icon ts_icon_check_circle_o_large"></i> We found 1 email address to invite. We\'ve done our best to guess a name. See if it looks right, then press Invite.'}else{html='<i class="ts_icon ts_icon_check_circle_o_large"></i> We found '+emails.length+" email addresses to invite. We've done our best to guess a name for each one. See if everything looks right, then press Invite."}_$div.find("#invite_notice").html(html).slideDown(100);_$div.find(".admin_invite_row").each(function(){var email=$.trim($(this).find('[name="email_address"]').val());if(!email)_removeRow($(this))});$.each(emails,function(index,email){_addRow(email)});_unprocessed_invites=emails;TS.storage.storeInvitesState(_unprocessed_invites)};var _canSaveDomains=function(){var account_type=$("#account_type").val();return account_type=="full"&&TS.model.user.is_owner&&TS.model.team.prefs.auth_mode=="normal"};var _collectNewDomains=function(invites){if(!_canSaveDomains())return"";var domains=invites.map(function(invite){return invite.email.split("@")[1]});if(TS.model.team.email_domain){var map=TS.model.team.email_domain.split(",").reduce(function(accumulator,domain){accumulator[domain]=true;return accumulator},{});domains=_.uniq(domains.filter(function(domain){return!map[domain]}))}return domains.join(", ")};var _deduplicateDomains=function(domains){if(!domains)return domains;var map=domains.split(",").reduce(function(accumulator,domain){accumulator[domain]=true;return accumulator},{});return Object.keys(map).join(",")};var _saveDomains=function(e){TS.ui.startButtonSpinner(_$div.find('button[data-action="add_signup_domains"]').get(0));var domains=_$div.find("#invite_signup_domains").val();if(TS.model.team.email_domain)domains=[TS.model.team.email_domain,domains].join(",");domains=_deduplicateDomains(domains);var args={prefs:JSON.stringify({signup_mode:"email",signup_domains:domains})};TS.api.call("team.prefs.set",args).then(function(response){TS.ui.stopButtonSpinner(_$div.find('button[data-action="add_signup_domains"]').get(0),true);TS.model.team.email_domain=response.data.prefs.signup_domains},function(response){TS.ui.stopButtonSpinner(_$div.find('button[data-action="add_signup_domains"]').get(0),false);var msg="Sorry! Something went wrong. Please try again.";if(response.data.error==="signup_domains_missing"){msg="Please enter a domain"}else if(response.data.error==="bad_domain"){msg="Sorry! You can't use "+response.data.domain+"."}else if(response.data.error==="invalid_domain"){msg="Hmm, this doesn't look like a domain! Check for typos?"}$("#invite_signup_domains").focus().tooltip({title:msg,trigger:"manual"}).tooltip("show").on("blur",function(){$(this).tooltip("destroy")})})};var _canNonAdminInvite=function(){return TS.boot_data.feature_non_admin_invites&&!TS.model.team.prefs.invites_only_admins&&!TS.model.user.is_restricted};var _canInvite=function(){return TS.model.user.is_admin||_canNonAdminInvite()}})();(function(){"use strict";TS.registerModule("ui.admin_edit_team_profile",{onStart:function(){$("body").on("click",'[data-action="edit_team_profile_modal"]',TS.ui.admin_edit_team_profile.start)},start:function(){if(_userCanEditTeamProfile())_start()}});var _$div;var _$body;var _active_section_id;var _back_stack=[];var _start=function(){var settings={body_template_html:TS.templates.admin_edit_team_profile_modal(),onShow:_onShow,onCancel:_onCancel};TS.ui.fs_modal.start(settings)};var _onShow=function(){_$div=$("#edit_team_profile_container");_$body=$("body");_$div.on("click",'[data-action="edit_team_profile_to_custom"]',_switchToCustom);_$div.on("click",'[data-action="edit_team_profile_to_add"]',_switchToAdd);_$div.on("click",'[data-action="edit_team_profile_to_edit"]',_switchToEdit);_$div.on("click",'[data-action="edit_team_profile_to_hide"]',_switchToHide);_$div.on("click",'[data-action="edit_team_profile_to_delete"]',_switchToDelete);_$div.on("click",'[data-action="edit_team_profile_cancel"]',_switchToList);_$div.on("click",'[data-action="edit_team_profile_confirm_edit"]',_editField);_$div.on("click",'[data-action="edit_team_profile_confirm_hide"]',_hideField);_$div.on("click",'[data-action="edit_team_profile_confirm_delete"]',_deleteField);_$div.on("click",'[data-action="edit_team_profile_remove_option"]',_removeOption);_$div.on("click",'[data-action="edit_team_profile_add_option"]',_addOption);_$div.on("focusin",'[data-action="edit_team_profile_update_preview_label"], [data-action="edit_team_profile_update_preview_hint"], .option_header_row + .option_row [data-action="edit_team_profile_update_preview_option"]',_decoratePreview);_$div.on("focusout",'[data-action="edit_team_profile_update_preview_label"], [data-action="edit_team_profile_update_preview_hint"], .option_header_row + .option_row [data-action="edit_team_profile_update_preview_option"]',_undecoratePreview);_$div.on("input",'[data-action="edit_team_profile_update_preview_label"], [data-action="edit_team_profile_update_preview_hint"], .option_header_row + .option_row [data-action="edit_team_profile_update_preview_option"]',_updatePreviewValue);_$div.on("click",'[data-action="edit_team_profile_list_menu"]',_openListMenu);_$div.on("input","input",_toggleSave);_$body.on("keydown.admin_submit",_onKeydown);_ensureProfile().then(_switchToList).catch(TS.error)};var _onCancel=function(){_updateBackButton(true);_$div=null;_back_stack=[];_active_section_id=null;_$body.off("keydown.admin_submit");_$body=null;if(TS.web&&TS.web.account_profile)TS.web.account_profile.render();if(TS.web&&TS.web.members)TS.web.members.render()};var _onKeydown=function(e){if(e.which==TS.utility.keymap.enter){$(_active_section_id).find('button[type="submit"]').trigger("click");return false}};var _ensureProfile=function(){return TS.team.ensureTeamProfileFieldsForMembers()};var _apiCall=function(method,calling_args){if(!method)return;return TS.api.call(method,calling_args).then(function(response){if(TS.web){if(method==="team.profile.delete"){TS.team.upsertTeam({profile:JSON.parse(calling_args.profile)})}else{TS.team.upsertTeam(response.data)}}return Promise.resolve(response)},function(error){return Promise.reject(error)})};var _deleteField=function(e){var $el=$(e.target);var id=$el.data("id");if(!id)$el=$el.closest("[data-id]");id=$el.data("id");if(!id)return;var field=TS.team.getTeamProfileFieldById(id);if(!field)return;_saveProfile("team.profile.delete",[id]).then(function(){_switchToList();Ladda.stopAll()},$.noop)};var _hideField=function(e){_hideOrShowField(e,true)};var _showField=function(e){_hideOrShowField(e,false)};var _hideOrShowField=function(e,hide){var $el=$(e.target);var id=$el.data("id");if(!id)$el=$el.closest("[data-id]");id=$el.data("id");if(!id)return;var field=TS.team.getTeamProfileFieldById(id);if(!field)return;field=$.extend({},field);field.is_hidden=hide;if(hide)field.ordering=_makeOrdering();_saveProfile("team.profile.set",[field]).then(function(){_switchToList();_highlightInList(id);Ladda.stopAll()},$.noop)};var _editField=function(e){var $edit=_$div.find("#edit_team_profile_edit");if(!TS.ui.validation.validate($edit,{quiet:true,fast:true})){TS.ui.validation.validate($edit);Ladda.stopAll();$("#edit_team_profile_confirm_edit_btn").addClass("disabled");return}var $el=$(e.target);var id=$el.data("id");if(!id)$el=$el.closest("[data-id], [data-type]");id=$el.data("id");var $label=_$div.find('input[name="label"]');var $hint=_$div.find('input[name="hint"]');var field=TS.team.getTeamProfileFieldById(id)||{};var copy=JSON.stringify(field);field=$.extend({},field);field.type=field.type||$el.data("type")||"text";field.label=$label.val().trim();field.hint=$hint.val().trim();field.ordering=field.ordering!==undefined?field.ordering:_makeOrdering();if(field.type==="options_list"){field.possible_values=_$div.find('input[name^="option_"]').map(function(){return $(this).val().trim()}).toArray()}function resolve(){_switchToList();_highlightInList(id);Ladda.stopAll()}if(JSON.stringify(field)==copy){resolve()}else{_saveProfile("team.profile.set",[field]).then(resolve,$.noop)}};var _saveProfile=function(method,fields){fields=fields&&fields.length?fields:TS.model.team.profile.fields;var calling_args={profile:JSON.stringify({fields:fields})};return _apiCall(method,calling_args).catch(function(error){if(error.data.error==="no_perms"||error.data.error==="missing_scope"){TS.generic_dialog.start({body:"Sorry! An owner on your team has restricted who can customize your team's profile.",show_cancel_button:false,esc_for_ok:true,fullscreen:false,onEnd:TS.ui.fs_modal.close})}else{TS.error("Failed to customize profile: "+error.data.error);TS.generic_dialog.alert("Sorry! Something went wrong. Please try again.")}})};var _switchToList=function(){_back_stack.length=0;_back_stack.push({back:_switchToList});var template_args={};template_args.team_profile_fields=_getVisibleTeamProfileFields();template_args.hidden_team_profile_fields=_getHiddenTeamProfileFields();template_args.default_team_profile_fields=_getDefaultTeamProfileFields();var html=TS.templates.admin_edit_team_profile_list(template_args);_$div.find("#edit_team_profile_header").text("Customize profile").removeClass("hidden center_and_narrow");var note;if(TS.model.team.profile&&TS.model.team.profile.fields.length>=50){note='<div class="alert alert_info"><i class="ts_icon ts_icon_info_circle"></i> You have reached the maximum number of fields that can be added to profiles.</div>'}else{note="Expand your team's profiles by adding additional fields below"}_$div.find("#edit_team_profile_value_note").html(note).removeClass("hidden center_and_narrow");_$div.find("#edit_team_profile_list").html(html);_hideAllSectionsBut("#edit_team_profile_list");_enableDragAndDrop();_unflexContentsAndCenter();_updateBackButton(true)};var _switchToAdd=function(){_back_stack.push({back:_switchToAdd});var template_args={};template_args.default_team_profile_fields=_getDefaultTeamProfileFields();var html=TS.templates.admin_edit_team_profile_add(template_args);_$div.find("#edit_team_profile_header").text("Select a field type").removeClass("center_and_narrow");_$div.find("#edit_team_profile_value_note").addClass("hidden");_$div.find("#edit_team_profile_add").html(html);_hideAllSectionsBut("#edit_team_profile_add");_unflexContentsAndCenter();_updateBackButton()};var _switchToCustom=function(){_back_stack.push({back:_switchToCustom});var html=TS.templates.admin_edit_team_profile_custom();_$div.find("#edit_team_profile_header").text("Create a new field").removeClass("center_and_narrow");_$div.find("#edit_team_profile_value_note").text("Which type of field would you like to create?").removeClass("hidden center_and_narrow");_$div.find("#edit_team_profile_custom").html(html);_hideAllSectionsBut("#edit_team_profile_custom");_unflexContentsAndCenter();_updateBackButton();_makePeoplePicker()};var _switchToEdit=function(e){var $el=$(e.target);if($el.hasClass("ts_icon_grabby_patty"))return false;var id=$el.data("id");if(!id)$el=$el.closest("[data-id], [data-type]");id=$el.data("id");var template_args={};var header_text;if(!id){template_args.type=$el.data("type");template_args.label=$el.data("label");header_text="Customize profile field"}else{template_args=TS.team.getTeamProfileFieldById(id);if(!template_args)return;header_text="Edit profile field"}e.stopPropagation();_back_stack.push({back:_switchToEdit,event:e});var html=TS.templates.admin_edit_team_profile_edit(template_args);_$div.find("#edit_team_profile_header").text(header_text).removeClass("center_and_narrow");_$div.find("#edit_team_profile_value_note").addClass("hidden");_$div.find("#edit_team_profile_edit").html(html);_hideAllSectionsBut("#edit_team_profile_edit");_maybeShowOptionRemoveAction();_maybeUpdateOptionPreviewValue();_makePeoplePicker();Ladda.bind("#edit_team_profile_confirm_edit_btn");_unflexContentsAndCenter();_updateBackButton();_toggleSave()};var _switchToHide=function(e){var $el=$(e.target);var id=$el.data("id");if(!id)$el=$el.closest("[data-id]");id=$el.data("id");if(!id)return;var field=TS.team.getTeamProfileFieldById(id);if(!field)return;e.stopPropagation();_back_stack.push({back:_switchToHide,event:e});var html=TS.templates.admin_edit_team_profile_hide(field);var header_text='Disable "'+field.label+'"';_$div.find("#edit_team_profile_header").text(header_text).addClass("center_and_narrow");var note="All data entered for this field will no longer be visible on your team's profiles. You can re-enable it later.";_$div.find("#edit_team_profile_value_note").text(note).addClass("center_and_narrow").removeClass("hidden");_$div.find("#edit_team_profile_hide").html(html);_hideAllSectionsBut("#edit_team_profile_hide");Ladda.bind("#edit_team_profile_confirm_hide_btn");_flexContentsAndCenter();_updateBackButton()};var _switchToDelete=function(e){var $el=$(e.target);var id=$el.data("id");if(!id)$el=$el.closest("[data-id]");id=$el.data("id");if(!id)return;var field=TS.team.getTeamProfileFieldById(id);if(!field)return;e.stopPropagation();_back_stack.push({back:_switchToDelete,event:e});var html=TS.templates.admin_edit_team_profile_delete(field);var header_text='Delete "'+field.label+'"';_$div.find("#edit_team_profile_header").text(header_text).addClass("center_and_narrow");var note="<strong>Are you sure?</strong> All data associated with this field will be permanently deleted. This <strong>cannot be undone</strong>.";_$div.find("#edit_team_profile_value_note").html(note).addClass("center_and_narrow").removeClass("hidden");_$div.find("#edit_team_profile_delete").html(html);_hideAllSectionsBut("#edit_team_profile_delete");Ladda.bind("#edit_team_profile_confirm_delete_btn");_flexContentsAndCenter();_updateBackButton()};var _flexContentsAndCenter=function(){_$div.closest(".contents").addClass("display_flex flex_direction_column").css("height","70vh");_$div.css({margin:"auto 0",height:"auto","padding-top":0})};var _unflexContentsAndCenter=function(){_$div.closest(".contents").removeClass("display_flex flex_direction_column").css("height","");_$div.css({margin:"",height:"","padding-top":""})};var _userCanEditTeamProfile=function(){if(!(TS.model.team&&TS.model.team.plan))return false;var user=TS.model.user;if(!user)return false;if(TS.model.team.prefs.who_can_change_team_profile==="admin")return user.is_admin;if(TS.model.team.prefs.who_can_change_team_profile==="owner")return user.is_owner;return true};var _updateBackButton=function(unbind){if(unbind){TS.ui.fs_modal.unbindBackButton();TS.ui.fs_modal.hideBackButton()}else{TS.ui.fs_modal.bindBackButton(function(){_back_stack.pop();var go_back=_back_stack.pop();go_back.back(go_back.event)});TS.ui.fs_modal.showBackButton()}};var _maybeShowOptionRemoveAction=function(){var options=_$div.find(".option_row");if(options.length>=3)return void options.addClass("show_remove_action");options.removeClass("show_remove_action")};var _maybeUpdateOptionPreviewValue=function(){_updatePreviewValue({target:_$div.find('.option_header_row + .option_row [data-action="edit_team_profile_update_preview_option"]')})};var _removeOption=function(e){$(e.target).closest(".row.option_row").remove();_toggleSave();_maybeShowOptionRemoveAction();_maybeUpdateOptionPreviewValue();_maybeUpdateAddOptionAction()};var _addOption=function(e){var row=TS.templates.admin_edit_team_profile_option_row({index:_$div.find(".row.option_row").length});_$div.find("#option_rows").append(row).find(".row.option_row").last().find("input").focus();_toggleSave();_maybeShowOptionRemoveAction();_maybeUpdateAddOptionAction()};var _maybeUpdateAddOptionAction=function(){if(_$div.find(".row.option_row").length===50){_$div.find('[data-action="edit_team_profile_add_option"]').addClass("hidden").next().removeClass("hidden")}else{_$div.find('[data-action="edit_team_profile_add_option"]').removeClass("hidden").next().addClass("hidden")}};var _updatePreviewValue=function(e){var $el=$(e.target);var value=$el.val();if(value)value=value.trim();if(value!==undefined&&!value.length)value=$el.data("default");_$div.find('.profile_field_preview [data-id="'+$el.data("target")+'"]').text(value)};var _decoratePreview=function(e){var $el=_$div.find('.profile_field_preview [data-id="'+$(e.target).data("target")+'"]');var $select=$el.closest("select");if($select.length)$el=$select;$el.addClass("highlight_yellow_bg")};var _undecoratePreview=function(e){var $el=_$div.find('.profile_field_preview [data-id="'+$(e.target).data("target")+'"]');var $select=$el.closest("select");if($select.length)$el=$select;$el.removeClass("highlight_yellow_bg")};var _makePeoplePicker=function(){var filter_select=_$div.find(".edit_team_profile_filter_select");if(!filter_select.length)return;var options={append:true,classes:"normal_style disabled",preselected_ids:[TS.members.getMemberByName("slackbot").id]};TS.ui.people_picker.make(filter_select,options)};var _enableDragAndDrop=function(){_$div.find("#edit_team_profile_list_drag_and_drop_area").sortable({items:".visible_row[data-id]",handle:".ts_icon_grabby_patty",forcePlaceholderSize:true}).on("sortupdate",function(e,ui){e.stopPropagation();var dirty=[];$(this).find(".row[data-id]").each(function(index){var field=TS.team.getTeamProfileFieldById($(this).data("id"));if(field&&field.ordering!=index){field.ordering=index;dirty.push({id:field.id,ordering:index})}});TS.team.sortTeamProfileFieldsByOrdering();_saveProfile("team.profile.reorder",dirty)})};var _makeOrdering=function(){if(!TS.model.team.profile.fields.length)return 0;return _.max(TS.model.team.profile.fields.map(function(field){return field.ordering}))+1};var _openListMenu=function(e){e.stopPropagation();var real_target=$(e.target).closest("[data-id]").get(0);var menu_event=jQuery.Event("click",{target:real_target,currentTarget:real_target});TS.menu.startWithEditTeamProfileListActions(menu_event,_onListMenuClick)};var _onListMenuClick=function(e){e.preventDefault();var $id=$(e.target).closest("[data-id]");if($id.is('[data-action="edit_team_profile_to_show"]')){_showField(e)}else if($id.is('[data-action="edit_team_profile_to_hide"]')){_switchToHide(e)}else if($id.is('[data-action="edit_team_profile_to_delete"]')){_switchToDelete(e)}TS.menu.end()};var _hideAllSectionsBut=function(id){var sections=["#edit_team_profile_loading","#edit_team_profile_list","#edit_team_profile_add","#edit_team_profile_custom","#edit_team_profile_edit","#edit_team_profile_hide","#edit_team_profile_delete"].filter(function(section_id){return section_id!==id}).join(", ");_$div.find(sections).addClass("hidden");_$div.find(id).removeClass("hidden");_active_section_id=id};var _getVisibleTeamProfileFields=function(){var fields=TS.team.getVisibleTeamProfileFields();return fields.length?fields:null};var _getHiddenTeamProfileFields=function(){var fields=TS.team.getHiddenTeamProfileFields();return fields.length?fields:null};var _getLabelsMap=function(){return TS.model.team.profile.fields.reduce(function(accumulator,field){accumulator[field.label.toLowerCase()]=true;return accumulator},{})};var _getDefaultTeamProfileFields=function(){var map=_getLabelsMap();var fields=[{type:"text",label:"Address"},{type:"date",label:"Birthdate"},{type:"user",label:"Direct Reports"},{type:"link",label:"Facebook"},{type:"link",label:"Flickr"},{type:"link",label:"GitHub"},{type:"link",label:"Instagram"},{type:"link",label:"LinkedIn"},{type:"user",label:"Manager"},{type:"link",label:"Pinterest"},{type:"text",label:"Skype"},{type:"link",label:"SoundCloud"},{type:"date",label:"Start Date"},{type:"link",label:"Tumblr"},{type:"link",label:"Twitter"},{type:"link",label:"YouTube"}].filter(function(field){return!map[field.label.toLowerCase()]});return fields.length?fields:[]};var _highlightInList=function(id){var selector=id?"[data-id="+id+"]":".visible_row[data-id]";var $el=_$div.find("#edit_team_profile_list").find(selector).last();var offset=$el.outerHeight()*-2;$el.highlight(1500,"",null,0);$el.scrollintoview({duration:200,px_offset:offset,direction:"y"})};var _toggleSave=function(){$("#edit_team_profile_confirm_edit_btn").toggleClass("disabled",!TS.ui.validation.validate(_$div.find("#edit_team_profile_edit"),{quiet:true,fast:true}))}})();(function(){"use strict";TS.registerModule("ui.edit_member_profile",{onStart:function(){TS.members.changed_profile_sig.add(_maybeUpdateMemberPhoto);if(TS.view)TS.view.resize_sig.add(_maybeResizePhotoCrop);$("body").on("click",'[data-action="edit_member_profile_modal"]',TS.ui.edit_member_profile.start)},start:function(){_start()}});var _$div;var _$body;var _$progress;var _jcrop;var _image;var _timeout;var _active_section_id;var _back_stack=[];var _MIN_PROFILE_PHOTO_SIZE=512;var _start=function(){var settings={body_template_html:TS.templates.edit_member_profile_modal(),onShow:_onShow,onCancel:_onCancel};TS.ui.fs_modal.start(settings)};var _onShow=function(){_$div=$("#edit_member_profile_container");_$body=$("body");_$div.on("click",'[data-action="edit_member_profile_cancel"]',TS.ui.fs_modal.close);_$div.on("click",'[data-action="edit_member_profile_confirm_edit"]',_editMemberProfile);_$div.on("click",'[data-action="edit_member_profile_cancel_photo"]',_switchToList);_$div.on("click",'[data-action="edit_member_profile_confirm_photo_delete"]',_deletePhoto);_$div.on("click",'[data-action="edit_member_profile_confirm_photo_crop"]',_uploadPhoto);_$div.on("click",'[data-action="edit_member_profile_photo_menu"]',_maybeOpenPhotoMenu);_$body.on("change.photo",'[data-action="edit_member_profile_upload_photo"]',_preprocessPhoto);_$body.on("keydown.member_submit",_onKeydown);_$div.on("input","input",_toggleSave).on("change","select",_toggleSave);_$div.on("input",'[data-plastic-type="date"]',_displayHumanReadableDate);_ensureProfile().then(_switchToList).catch(TS.error)};var _onCancel=function(){_$div=null;_$progress=null;_jcrop=null;_image=null;_back_stack=[];_active_section_id=null;_$body.off("change.photo");_$body.off("keydown.member_submit");_$body=null;if(TS.web&&TS.web.account_profile)TS.web.account_profile.render();if(TS.web&&TS.web.members)TS.web.members.render()};var _onKeydown=function(e){if(e.which==TS.utility.keymap.enter){$(_active_section_id).find('button[type="submit"]').trigger("click");return false}};var _ensureProfile=function(){return TS.team.ensureTeamProfileFieldsForMembers()};var _deletePhoto=function(){$("#edit_member_profile_cancel_photo_delete_btn").addClass("disabled");$("#fs_modal").addClass("stop_pointer_events");_$body.on("keydown.deletePhoto",function(e){e.stopPropagation()});TS.api.call("users.deletePhoto").then(function(){if(TS.web){return TS.api.call("users.info",{user:TS.model.user.id}).then(function(response){delete response.data.ok;var self=$.extend(true,TS.model.user,response.data.user);TS.members.upsertMember(self);_switchToList()},_switchToList)}else{_switchToList()}},function(error){TS.warn("Unable to delete profile photo");TS.error(error);_handleUnexpectedError()}).finally(function(){Ladda.stopAll();_$body.off("keydown.deletePhoto");$("#fs_modal").removeClass("stop_pointer_events");$("#edit_member_profile_cancel_photo_delete_btn").removeClass("disabled")})};var _uploadPhoto=function(e){if(_jcrop)_jcrop.disable();$("#edit_member_profile_cancel_photo_crop_btn").addClass("disabled");$("#fs_modal").addClass("stop_pointer_events");_$body.on("keydown.uploadPhoto",function(e){e.stopPropagation()});var $el=$("#edit_member_profile_photo");var $cropbox=$("#cropbox");var calling_args=$cropbox.data("dimensions");calling_args.id=$el.data("src_id");TS.api.call("users.setPhoto",calling_args).then(function(response){if(TS.web){delete response.data.ok;var self=$.extend(true,TS.model.user,response.data);TS.members.upsertMember(self)}_switchToList()},function(error){TS.warn("Unable to upload cropped profile photo");TS.error(error);_handleUnexpectedError()}).finally(function(){Ladda.stopAll();_$body.off("keydown.uploadPhoto");$("#fs_modal").removeClass("stop_pointer_events");$("#edit_member_profile_cancel_photo_crop_btn").removeClass("disabled");$cropbox.removeData("dimensions")})};var _preprocessPhoto=function(){var $el=$(this);if(!$el.val()){if(TS.model.is_iOS)TS.menu.end();return}var files=$el.get(0).files;if(files){if(TS.model.is_iOS)TS.menu.end();if(!files.length)return;_switchToPhotoUpload();_updateProgress(0);$("#edit_member_profile_cancel_photo_upload_btn").off();
_readPhoto(files[0]).then(_validateFormat).then(_validateSize).then(_preparePhotoOnServer).then(_setupPhotoForCrop).then(_startPhotoCrop).catch(_handlePhotoRejects);_$div.find('[data-action="edit_member_profile_upload_photo"]').val("")}};var _readPhoto=function(file){return new Promise(function(resolve,reject){var reader=new FileReader;reader.onload=function(e){resolve({file:file,src:e.target.result})};reader.onabort=function(){TS.info("Profile photo file read aborted");reject(new Error("abort"))};reader.onerror=function(err){TS.warn("Unable to read profile photo file");TS.error(err);reject(err)};$("#edit_member_profile_cancel_photo_upload_btn").one("click",function(){reader.abort()});reader.readAsDataURL(file)})};var _validateFormat=function(data){return data.file.type.match(/image\/(?:gif|png|jpeg)/i)?Promise.resolve(data):Promise.reject(new Error("format"))};var _validateSize=function(data){return new Promise(function(resolve,reject){_image=new Image;_image.onload=function(){if(this.width>=_MIN_PROFILE_PHOTO_SIZE&&this.height>=_MIN_PROFILE_PHOTO_SIZE){resolve(data)}else{TS.warn("Profile photo file too small");reject(new Error("size"))}};_image.onerror=function(err){TS.warn("Unable to set profile photo file image src");TS.error(err);reject(err)};_image.src=data.src})};var _preparePhotoOnServer=function(data){var url=TS.model.api_url+"users.preparePhoto";var form_data=new FormData;form_data.append("image",data.file);form_data.append("token",TS.model.api_token);return new Promise(function(resolve,reject){var xhr=$.ajax({url:url,data:form_data,dataType:"json",cache:false,contentType:false,processData:false,type:"POST",xhr:function(){var xhr=jQuery.ajaxSettings.xhr();if(xhr.upload){xhr.upload.addEventListener("progress",function(evt){if(evt.lengthComputable){_updateProgress(evt.loaded/evt.total)}else{TS.info("Upload length not computable");_updateProgress(1)}},false)}return xhr}}).fail(function(xhr,text_status,error_thrown){reject(new Error(error_thrown))}).done(function(data,text_status,xhr){if(data.ok){resolve(data)}else{reject(new Error(data.error))}});$("#edit_member_profile_cancel_photo_upload_btn").one("click",function(){xhr.abort()})})};var _setupPhotoForCrop=function(data){return new Promise(function(resolve,reject){var $el=$("#edit_member_profile_photo");var el=$el.get(0);$el.attr("src",data.url).data("src_id",data.id);el.onload=function(){$("#edit_member_profile_photo_preview").css("background","url("+data.url+")");$el.css("opacity",0);_switchToPhotoCrop();resolve()};el.onerror=function(err){TS.warn("Unable to set crop photo file image src");TS.error(err);reject(err)}})};var _startPhotoCrop=function(){function updatePreview(dimensions){var size=$preview.width();var width=size*_image.width/dimensions.crop_w;var height=size*_image.height/dimensions.crop_w;var x=width*dimensions.crop_x*-1/_image.width;var y=height*dimensions.crop_y*-1/_image.height;$preview.css({"background-size":width+"px","background-position":x+"px "+y+"px"})}function updateSelection(crop){if(!_image)return;var dimensions={crop_x:Math.round(crop.x),crop_y:Math.round(crop.y),crop_w:Math.min(Math.round(crop.w),_image.height)};$cropbox.data("dimensions",dimensions);updatePreview(dimensions)}function selectAll(){_jcrop.animateTo(start_crop,function(){updateSelection(this.tellSelect())});_jcrop.focus()}var $cropbox=$("#cropbox");var $preview=$("#edit_member_profile_photo_preview");var $el=$("#edit_member_profile_photo");if(_image.width===_MIN_PROFILE_PHOTO_SIZE&&_image.height===_MIN_PROFILE_PHOTO_SIZE){$el.css("opacity",1);updateSelection({x:0,y:0,w:_MIN_PROFILE_PHOTO_SIZE});return}var box_width=$el.width();var box_height=$el.height();var start_crop;var min=Math.min(_image.width,_image.height);updatePreview({crop_x:(_image.width-min)/2,crop_y:(_image.height-min)/2,crop_w:min});$("#edit_member_profile_photo").css("opacity",0);$el.Jcrop({aspectRatio:1,allowSelect:false,minSize:[_MIN_PROFILE_PHOTO_SIZE,_MIN_PROFILE_PHOTO_SIZE],boxWidth:box_width,boxHeight:box_height,onSelect:updateSelection,onRelease:selectAll,bgColor:"white",trueSize:[_image.width,_image.height]},function(){_jcrop=this;var bounds=this.getBounds();var min=Math.min(bounds[0],bounds[1]);this.setOptions({minSize:[_MIN_PROFILE_PHOTO_SIZE,_MIN_PROFILE_PHOTO_SIZE]});var x=(bounds[0]-min)/2;var y=(bounds[1]-min)/2;start_crop=[x,y,min,min];selectAll()})};var _handlePhotoRejects=function(error){switch(error&&error.message){case"abort":_switchToList();break;case"size":_switchToPhotoSizeError();break;case"format":_switchToPhotoFormatError();break;case"bad_format":_switchToPhotoOversizeError();break;default:_handleUnexpectedError()}};var _handleUnexpectedError=function(){TS.generic_dialog.alert("Sorry! Something went wrong. Please try again.").then(_switchToList)};var _switchToList=function(){_back_stack.length=0;_back_stack.push({back:_switchToList});_maybeCleanUpPhotoCrop();_image=null;if(!_$div.find("#edit_member_profile_header_container").length){var template_args={member:TS.model.user,team:TS.model.team,can_edit_team_profile:_userCanEditTeamProfile(),team_member_profile_fields:TS.team.getVisibleTeamProfileFieldsForMember(TS.model.user,true)};var html=TS.templates.edit_member_profile_list(template_args);_$div.find("#edit_member_profile_list").html(html)}_hideAllSectionsBut("#edit_member_profile_list");Ladda.bind("#edit_member_profile_confirm_edit_btn");_toggleSave();_makePeoplePickers();_unflexContentsAndCenter();_updateBackButton(true)};var _switchToPhotoCrop=function(){_back_stack.push({back:_switchToList});_hideAllSectionsBut("#edit_member_profile_photo_crop");var $el=$("#edit_member_profile_photo_crop");if(_image.width===_MIN_PROFILE_PHOTO_SIZE&&_image.height===_MIN_PROFILE_PHOTO_SIZE){$el.find(".edit_member_profile_subheader").addClass("hidden");$el.find(".edit_member_profile_header").text("Wow, you look nice today!")}else{$el.find(".edit_member_profile_subheader").removeClass("hidden");$el.find(".edit_member_profile_header").text("Finish up by cropping your photo.")}Ladda.bind("#edit_member_profile_confirm_photo_crop_btn");_unflexContentsAndCenter();_updateBackButton()};var _switchToPhotoUpload=function(){_back_stack.push({back:_switchToList});if(!_$progress)_makeProgressCircle();_hideAllSectionsBut("#edit_member_profile_photo_upload");_unflexContentsAndCenter();_updateBackButton()};var _switchToPhotoDelete=function(){_back_stack.push({back:_switchToPhotoDelete});_hideAllSectionsBut("#edit_member_profile_photo_delete");Ladda.bind("#edit_member_profile_confirm_photo_delete_btn");_flexContentsAndCenter();_updateBackButton()};var _switchToPhotoSizeError=function(){_back_stack.push({back:_switchToList});_hideAllSectionsBut("#edit_member_profile_photo_size_error");_unflexContentsAndCenter();_updateBackButton()};var _switchToPhotoFormatError=function(){_back_stack.push({back:_switchToList});_hideAllSectionsBut("#edit_member_profile_photo_format_error");_unflexContentsAndCenter();_updateBackButton()};var _switchToPhotoOversizeError=function(){_back_stack.push({back:_switchToList});_hideAllSectionsBut("#edit_member_profile_photo_oversize_error");_unflexContentsAndCenter();_updateBackButton()};var _editMemberProfile=function(){if(!TS.ui.validation.validate(_$div,{quiet:true,fast:true})){TS.ui.validation.validate(_$div);Ladda.stopAll();$("#edit_member_profile_confirm_edit_btn").addClass("disabled");return}var field_names=["first_name","last_name","title","phone"];var calling_args={users:TS.model.user.id};var profile={};field_names.forEach(function(name){var $field=_$div.find('input[name="'+name+'"]');var value=$field.val();profile[name]=value&&value.trim();$field.val("").val(value)});(TS.model.team.profile.fields||[]).filter(function(field){return!field.is_hidden}).forEach(function(field){var $field=_$div.find('input[name="'+field.id+'"], select[name="'+field.id+'"]');var $alt_field=_$div.find('input[name="'+field.id+'_alt"]');var value=$field.val();var alt_value=$alt_field.val();profile.fields=profile.fields||{};profile.fields[field.id]={value:value&&value.trim(),alt:alt_value&&alt_value.trim()};if(field.type==="text"&&field.label.toLocaleLowerCase()==="skype")profile["skype"]=value&&value.trim();$field.val("").val(value);$alt_field.val("").val(alt_value)});calling_args.profile=JSON.stringify(profile);TS.api.call("users.profile.set",calling_args).then(function(response){$("#edit_member_profile_confirm_edit_btn").addClass("disabled");if(TS.web){var self=$.extend(true,TS.model.user);self.profile=response.data.profile;TS.members.upsertMember(self)}TS.ui.fs_modal.close()},function(error){$("#edit_member_profile_confirm_edit_btn").addClass("disabled");if(error.data.error==="ratelimited"){TS.generic_dialog.alert("You're changing your profile too often! You might have better luck if you try again in a few minutes.")}else{TS.generic_dialog.alert("Sorry! Something went wrong. Please try again.")}}).finally(Ladda.stopAll)};var _flexContentsAndCenter=function(){_$div.closest(".contents").addClass("display_flex flex_direction_column").css("height","70vh");_$div.css({margin:"auto 0",height:"auto","padding-top":0})};var _unflexContentsAndCenter=function(){_$div.closest(".contents").removeClass("display_flex flex_direction_column").css("height","");_$div.css({margin:"",height:"","padding-top":""})};var _maybeOpenPhotoMenu=function(e){e.stopPropagation();if((!TS.model.user.profile.image_original||$(e.target).is(".btn"))&&!TS.model.is_iOS){_$div.find('[data-action="edit_member_profile_upload_photo"]').trigger("click")}else{TS.menu.startWithEditMemberProfilePhotoActions(e,_onPhotoMenuClick)}};var _onPhotoMenuClick=function(e){var $el=$(e.target).closest("li");if($el.is('[data-action="edit_member_profile_upload_image"]')){if(!TS.model.is_iOS){e.preventDefault();_$div.find('[data-action="edit_member_profile_upload_photo"]').trigger("click");TS.menu.end()}}else if($el.is('[data-action="edit_member_profile_to_delete"]')){e.preventDefault();_switchToPhotoDelete();TS.menu.end()}};var _hideAllSectionsBut=function(id){var sections=["#edit_member_profile_loading","#edit_member_profile_list","#edit_member_profile_photo_upload","#edit_member_profile_photo_crop","#edit_member_profile_photo_delete","#edit_member_profile_photo_size_error","#edit_member_profile_photo_format_error","#edit_member_profile_photo_oversize_error"].filter(function(section_id){return section_id!==id}).join(", ");_$div.find(sections).addClass("hidden");_$div.find(id).removeClass("hidden");_active_section_id=id};var _updateBackButton=function(unbind){if(unbind){TS.ui.fs_modal.unbindBackButton();TS.ui.fs_modal.hideBackButton()}else{TS.ui.fs_modal.bindBackButton(function(){_back_stack.pop();var go_back=_back_stack.pop();go_back.back()});TS.ui.fs_modal.showBackButton()}};var _toggleSave=function(){$("#edit_member_profile_confirm_edit_btn").toggleClass("disabled",!TS.ui.validation.validate(_$div,{quiet:true,fast:true}))};var _makePeoplePickers=function(){_$div.find(".edit_member_profile_filter_select").each(function(index,el){var $el=$(el);var preselected_ids=$el.val().split(/\s*\,\s*/);TS.ui.people_picker.make($el,{preselected_ids:preselected_ids});$el.on("change",function(){var value=TS.ui.people_picker.value($el).map(function(item){return item.member.id}).join(",");$el.val(value);_toggleSave()})})};var _maybeUpdateMemberPhoto=function(){if(!_$div)return;$("#edit_member_profile_photo_container .member_image").replaceWith(TS.templates.builders.makeMemberPreviewLinkImage(TS.model.user.id,192,false,true))};var _makeProgressCircle=function(){_$progress=$("#edit_member_profile_progress_circle").circleProgress({value:0,size:64,fill:{gradient:["#50acf4","#41a6f5"]},startAngle:Math.PI/-2})};var _updateProgress=function(percent_done){var value=parseFloat(percent_done);if(!isNaN(value))_$progress.circleProgress({value:value.toFixed(2)})};var _maybeCleanUpPhotoCrop=function(){if(!_jcrop)return;_jcrop.destroy();_jcrop=null;$("#edit_member_profile_photo").css({width:"auto",height:"auto",display:"block",visibility:"visible",opacity:1})};var _maybeResizePhotoCrop=function(){if(_jcrop&&_jcrop.getOptions().disabled)return;_maybeCleanUpPhotoCrop();if(_timeout)clearTimeout(_timeout);_timeout=setTimeout(function(){if(_image&&!_jcrop)_startPhotoCrop()},300)};var _displayHumanReadableDate=function(e){var $field=$(e.target);var $alt_field=$('input[name="'+$field.attr("name")+'_alt"]');var value=$field.val();if(value)value=value.trim();if(TS.ui.validation.validate($field,{quiet:true,fast:true}))$alt_field.val(_convertISOtoUTCReadableDate(value))};var _convertISOtoUTCReadableDate=function(iso_date_string){var utc_string="";var ms=Date.parse(iso_date_string);if(!isNaN(ms)){var date=new Date(ms);utc_string+=["January","February","March","April","May","June","July","August","September","October","November","December"][date.getUTCMonth()];utc_string+=" "+TS.utility.ordinalNumber(date.getUTCDate());if(date.getUTCFullYear())utc_string+=", "+date.getUTCFullYear()}return utc_string};var _userCanEditTeamProfile=function(){if(!TS.model.team.plan)return false;var user=TS.model.user;if(!user)return false;if(TS.model.team.prefs.who_can_change_team_profile==="admin")return user.is_admin;if(TS.model.team.prefs.who_can_change_team_profile==="owner")return user.is_owner;return true}})();(function(){"use strict";TS.registerModule("ui.validation",{completed_sig:new signals.Signal,onStart:function(){$("body").on("input.validation paste.validation change.validation blur.validation","[data-validation]",TS.utility.debounce(function(e){_validate($(e.target),{},e)},250));$("body").on("submit.validation","form[data-validation-form]",function(e){var $form=$(e.target);var passed=TS.ui.validation.validate($form);if(!passed)e.preventDefault();TS.ui.validation.completed_sig.dispatch($form,{event:e,passed:passed})})},validate:function($el,options){options=options||{};var el=document;if($el){if($el.is("[data-validation]")){if($el.length===1)return _validate($el,options);return $el.toArray().every(function(el){return _validate($(el),options)})}el=$el.get(0)}var els=Array.prototype.slice.call(el.querySelectorAll("[data-validation]"));if(options&&options.fast){return els.every(function(el){return _validate($(el),options)})}else{return els.reduce(function(accumulator,el){return _validate($(el),options)&&accumulator},true)}},register:function(key,value){if(_validator_map[key])return void TS.warn(key+" cannot be registered because that key is already in use.");if(typeof value!=="function")return void TS.warn("Only functions can be registered as validators.");_validator_map[key]=value},showError:function($el,message,options,hide_after_ms){_showMessage($el,options.error_message||message,"validation_error",options,hide_after_ms)},showWarning:function($el,message,options,hide_after_ms){_showMessage($el,options.warning_message||message,"validation_warning",options,hide_after_ms)},showSuccess:function($el,message,options,hide_after_ms){_showMessage($el,options.success_message||message,"validation_success",options,hide_after_ms)},test:function(){return{validations:_validator_map}}});var OPTIONAL_PROTOCOL_URL_REGEXP=/((ftp|http|https)\:\/\/|\bw{3}\.)?[a-z0-9\-\.]+\.[a-z]+(:[a-z0-9]*)?\/?([@a-z0-9\-\._\?\,\'\/\\\+&amp;%\$#\=~:])*/gi;var _validator_map={dateandformat:_validateDateAndFormat,firstalphanumeric:_validateFirstAlphanumeric,hasnourl:_validateHasNoUrl,isurl:_validateIsUrl,lowercase:_validateLowercase,maxcsv:_validateMaxCSV,maxlength:_validateMaxLength,mincsv:_validateMinCSV,minlength:_validateMinLength,nospace:_validateNospace,required:_validateRequired,reservedwords:_validateReservedWords,username:_validateUsername,channel_name:_validateChannelName,is_email:_validateIsEmail};var _validate=function($el,options,e){options=options||{};if($el.is("[data-validation-for]"))options.custom_for=$el.attr("data-validation-for");if($el.is("[data-validation-success]"))options.success_message=$el.attr("data-validation-success");if($el.is("[data-validation-warning]"))options.warning_message=$el.attr("data-validation-warning");if($el.is("[data-validation-error]"))options.error_message=$el.attr("data-validation-error");if($el.is("input")||$el.is("textarea"))_clearCountdown($el,options);var every=_getValidators($el).every(function(validator){if(validator.indexOf("=")===-1){return _validator_map[validator.trim()]($el,options)}else{var validator_parts=validator.split("=");return _validator_map[validator_parts[0]]($el,options,validator_parts[1])}});TS.ui.validation.completed_sig.dispatch($el,{event:e,passed:every});if(_shouldShowSuccess($el,every,options))TS.ui.validation.showSuccess($el,"Nice, thanks!",options,3e3);return every};var _getValidators=function($el){if($el.is("[data-validation]")){return $el.attr("data-validation").replace(/\s*(,|=)\s*/g,"$1").split(/\s+/)}else{return[]}};function _validateRequired($el,options){if($el.is('input[type="radio"]')){if($(document.querySelectorAll('[name="'+$el.prop("name")+'"][data-validation]')).filter(":checked").length)return true;return void TS.ui.validation.showWarning($el,"Please select an option",options)}else if($el.is('input[type="checkbox"]')){if($(document.querySelectorAll('[name="'+$el.prop("name")+'"][data-validation]')).filter(":checked").length)return true;return void TS.ui.validation.showWarning($el,"Please select at least one option",options)}else if($el.is("select")){if($el.val())return true;return void TS.ui.validation.showWarning($el,"Please select an option",options)}else if($el.is("input")||$el.is("textarea")){if($el.val().trim())return true;return void TS.ui.validation.showWarning($el,"This field can't be empty",options)}else{return void TS.error("WTF: cannot validate")}}function _validateReservedWords($el,options,reserved){if($el.is('input[type="radio"]')||$el.is('input[type="checkbox"]')||$el.is("select"))return true;if($el.is("input")||$el.is("textarea")){var value=$el.val().trim().toLowerCase();var reserved_words=reserved.split(",");if(reserved_words.indexOf(value)===-1)return true;return void TS.ui.validation.showWarning($el,TS.utility.htmlEntities(value)+" is a reserved word. Try something else!",options)}else{return void TS.error("WTF: cannot validate")}}function _validateIsUrl($el,options,protocols){var error_message="This doesn't seem like a proper link. Sorry!";if($el.is('input[type="radio"]')||$el.is('input[type="checkbox"]')||$el.is("select"))return true;if($el.is("input")||$el.is("textarea")){var value=$el.val();if(!value)return true;var found=value.match(OPTIONAL_PROTOCOL_URL_REGEXP);if(found&&found.length===1&&found[0]===value){if(!protocols)return true;var allowed_protocols=protocols.split(",");for(var i=0;i<allowed_protocols.length;i++){if(found[0].indexOf(allowed_protocols[i])===0){return true}else if(allowed_protocols[i]=="https"){error_message="Please use https (for security)."}}}return void TS.ui.validation.showWarning($el,error_message,options)}else{return void TS.error("WTF: cannot validate")}}function _validateHasNoUrl($el,options){if($el.is('input[type="radio"]')||$el.is('input[type="checkbox"]')||$el.is("select"))return true;if($el.is("input")||$el.is("textarea")){var value=$el.val();if(!value)return true;if(!TS.utility.findUrls(value).length){return true}return void TS.ui.validation.showWarning($el,"Sorry, but URLs in your message are not allowed.",options)}else{return void TS.error("WTF: cannot validate")}}function _validateMinLength($el,options,length,hide_countdown){return _validateLength($el,"minlength",options,length,hide_countdown)}function _validateMaxLength($el,options,length,hide_countdown){return _validateLength($el,"maxlength",options,length,hide_countdown)}function _validateLength($el,key,options,length,hide_countdown){if($el.is('input[type="radio"]')||$el.is('input[type="checkbox"]')||$el.is("select"))return true;if($el.is("input")||$el.is("textarea")){var value=$el.val();length=+length;if(value===undefined||isNaN(length))return void TS.error("WTF: no length to validate");var plural_str=length>1?"s":"";if("minlength"===key){if(value.length>=length)return true;return void TS.ui.validation.showError($el,"This field can't be less than "+length+" character"+plural_str,options)}else if("maxlength"===key){if(!hide_countdown)_countdown($el,value.length,length,options);if(value.length<=length)return true;return void TS.ui.validation.showError($el,"This field can't be more than "+length+" character"+plural_str,options)}}else{return void TS.error("WTF: cannot validate")}}function _validateMinCSV($el,options,length){return _validateCSV($el,"mincsv",options,length)}function _validateMaxCSV($el,options,length){return _validateCSV($el,"maxcsv",options,length)}function _validateCSV($el,key,options,length){if($el.is('input[type="radio"]')||$el.is('input[type="checkbox"]')||$el.is("select"))return true;if($el.is("input")||$el.is("textarea")){var value=$el.val().trim();length=+length;if(value===undefined||isNaN(length))return void TS.error("WTF: no length to validate");var plural_str=length>1?"s":"";if("mincsv"===key){if(value.split(/\s*\,\s*/).length>=length)return true;return void TS.ui.validation.showError($el,"This field can't have less than "+length+" value"+plural_str,options)}else if("maxcsv"===key){if(value.split(/\s*\,\s*/).length<=length)return true;return void TS.ui.validation.showError($el,"This field can't have more than "+length+" value"+plural_str,options)}}else{return void TS.error("WTF: cannot validate")}}function _validateDateAndFormat($el,options,format){if($el.is('input[type="radio"]')||$el.is('input[type="checkbox"]')||$el.is("select"))return true;if($el.is("input")||$el.is("textarea")){var value=$el.val().trim();if(!value)return true;var ui_pattern,found,match,valid;switch(format){case"Y-m-d":ui_pattern="YYYY-MM-DD";found=value.match(/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/);match=found&&found.length===1&&found[0]===value;if(match)valid=_isValidISODate(value+"T00:00:00.000Z");break;case"m-d":ui_pattern="MM-DD";found=value.match(/^[0-9]{2}-[0-9]{2}$/);match=found&&found.length===1&&found[0]===value;if(match)valid=_isValidISODate("0000-"+value+"T00:00:00.000Z");break;default:return void TS.error("WTF: cannot validate")}if(match&&valid)return true;if(!match)return void TS.ui.validation.showWarning($el,"This needs to be in the format "+ui_pattern+". Sorry!",options);if(!valid)return void TS.ui.validation.showWarning($el,TS.utility.htmlEntities(value)+" doesn't appear to be a valid date. Sorry!",options)}else{return void TS.error("WTF: cannot validate")}}function _validateLowercase($el,options){var value=$el.val();var is_lowercase=value===value.toLocaleLowerCase();if(is_lowercase)return true;return void TS.ui.validation.showWarning($el,"This field must be lowercase only",options)}function _validateNospace($el,options){var value=$el.val();var has_spaces=/\s/.test(value);if(!has_spaces)return true;return void TS.ui.validation.showWarning($el,"This field can't contain spaces",options)}function _validateFirstAlphanumeric($el,options){var value=$el.val();var is_first_alphanumeric=/^[^\W_]/.test(value);if(is_first_alphanumeric)return true;return void TS.ui.validation.showWarning($el,"This first character must be a letter or number",options)}function _validateUsername($el,options){var max_length=21;var msgs={firstalphanumeric:"Usernames must start with a letter or number. Sorry about that!",lowercase:"Sorry, usernames must be lowercase!",maxlength:"Sorry, thats a bit too long! Usernames must be fewer than "+max_length+" characters.",required:"Please fill in a username.",specials:"Usernames cant contain special characters. Sorry about that!"};var quiet_options=$.extend({},options,{quiet:true});if(!_validateRequired($el,quiet_options))return void TS.ui.validation.showWarning($el,msgs.required,options);if(!_validateMaxLength($el,quiet_options,max_length,true))return void TS.ui.validation.showWarning($el,msgs.maxlength,options);if(!_validateNospace($el,quiet_options))return void TS.ui.validation.showWarning($el,msgs.specials,options);if(!_validatePattern($el,quiet_options,/^[\w\._-]+$/))return void TS.ui.validation.showWarning($el,msgs.specials,options);if(!_validateFirstAlphanumeric($el,quiet_options))return void TS.ui.validation.showWarning($el,msgs.firstalphanumeric,options);if(!_validateLowercase($el,quiet_options))return void TS.ui.validation.showWarning($el,msgs.lowercase,options);if(!_validateReservedWords($el,options,"slackbot"))return false;return true}function _validateChannelName($el,options){var max_length=21;var msgs={lowercase:"Sorry, channel names must be lowercase!",maxlength:"Sorry, channel names must be 21 characters or fewer!",required:"Channel names can't be empty",specials:"Sorry, channel names cannot contain spaces or periods!"};var quiet_options=$.extend({},options,{quiet:true});if(!_validateRequired($el,quiet_options))return void TS.ui.validation.showWarning($el,msgs.required,options);if(!_validateMaxLength($el,quiet_options,max_length,true))return void TS.ui.validation.showWarning($el,msgs.maxlength,options);if(!_validateNospace($el,quiet_options))return void TS.ui.validation.showWarning($el,msgs.specials,options);if(!_validatePattern($el,quiet_options,/^[^\.]+$/))return void TS.ui.validation.showWarning($el,msgs.specials,options);if(!_validateLowercase($el,quiet_options))return void TS.ui.validation.showWarning($el,msgs.lowercase,options);if($el.is('input[type="radio"]')||$el.is('input[type="checkbox"]')||$el.is("select"))return true;if($el.is("input")||$el.is("textarea")){var value=$el.val();if(!TS.channels.getChannelByName(value)&&!TS.groups.getGroupByName(value)&&!TS.members.getMemberByName(value))return true;return void TS.ui.validation.showWarning($el,TS.utility.htmlEntities(value)+" has already been taken. Try something else!",options)}else{return void TS.error("WTF: cannot validate")}}function _validateIsEmail($el,options,protocols){if($el.is('input[type="radio"]')||$el.is('input[type="checkbox"]')||$el.is("select"))return true;if($el.is("input")||$el.is("textarea")){var value=$el.val();if(!value)return true;var found=value.match(TS.utility.email_regex);if(found&&found.length===1&&found[0]===value)return true;return void TS.ui.validation.showWarning($el,"This doesn't seem like an email address. Sorry!",options)}else{return void TS.error("WTF: cannot validate")}}function _validatePattern($el,options,pattern){var value=$el.val();if(!pattern.test(value)){return void TS.ui.validation.showWarning($el,"This field contains invalid characters",options)}return true}var _isValidISODate=function(iso_date_string){if(!isNaN(Date.parse(iso_date_string))){var date=new Date(iso_date_string);return!date.toISOString().indexOf(iso_date_string)}};var _shouldShowSuccess=function($el,every,options){var $label=$(document.querySelector('label[for="'+(options.custom_for||$el.attr("name"))+'"]'));if(!$label.length)return;return!(options&&options.quiet)&&every&&$label.data("validation-ephemeral")===false};var _showMessage=function($el,message,validation_level,options,hide_after_ms){if(options&&options.quiet)return;var $label=$(document.querySelector('label[for="'+(options.custom_for||$el.attr("name"))+'"]'));if(!$label.length)return;var timeout=$label.data("validation-timeout");clearTimeout(timeout);var $message=$label.find(".validation_message");if(!$message.length){$message=$("<span />").addClass("validation_message overflow_ellipsis");if($el.is("select")){$message.insertBefore($label.find("select"))}else{$message.appendTo($label)}}_toggleValidationLevel($el,$label,validation_level);$message.get(0).title=message;$message.fadeIn(100);$label.data("validation-ephemeral",!!hide_after_ms);if(hide_after_ms){$label.data("validation-timeout",setTimeout(function(){$label.removeData("validation-ephemeral").removeData("validation-timeout");$message.fadeOut(100,function(){_toggleValidationLevel($el,$label);$message.remove()})},hide_after_ms))}};var _levels=["validation_error","validation_warning","validation_success"];var _toggleValidationLevel=function($el,$label,validation_level){if($label.hasClass(validation_level))return;$el.removeClass(_levels.join(" "));$el.addClass(validation_level);$label.removeClass(_levels.join(" "));$label.addClass(validation_level)};var _countdown=function($el,value_length,validation_length,options){if(validation_length-value_length<=6){_setCountdown($el,value_length,validation_length,options)}else{_clearCountdown($el,options)}};var _setCountdown=function($el,value_length,validation_length,options){var label=document.querySelector('label[for="'+(options.custom_for||$el.attr("name"))+'"]');if(!label)return;$(label).attr("data-countdown",[value_length,validation_length].join("/")).addClass("countdown");var styles=window.getComputedStyle(label,":after");if(!$el.data("countdown-padding-right"))$el.data("countdown-padding-right",parseFloat($el.css("padding-right")));$el.css("padding-right",parseFloat(styles.width)+parseFloat(styles.right)+$el.data("countdown-padding-right"))};var _clearCountdown=function($el,options){var label=document.querySelector('label[for="'+(options.custom_for||$el.attr("name"))+'"]');if(!label)return;$(label).removeClass("countdown");$el.removeData("countdown-padding-right");$el.css("padding-right","")}})();(function(){"use strict";TS.registerModule("ui.token_input",{onStart:function(){},make:function($container,onTokenChange){if(!($container&&$container.length))return;var $input=$container.find("input");if(!($input&&$input.length))return;$container.on("click",function(){$container.addClass("active");$input.focus()});$input.on("paste",function(e){setTimeout(function(){var val=$input.val().trim();if(!/\,/.test(val))return true;if(val)_tokenizeInput($container,$input,onTokenChange)},0)}).on("keydown",function(e){var length=$input.val().length;if(!length&&e.which===TS.utility.keymap.del){_untokenizeInput($container,$input,onTokenChange)}else if(length===1&&!$input.prev(".token").length){_untokenizeInput($container,$input,onTokenChange)}}).on("keyup",function(e){var length=$input.val().length;if(length&&e.which===TS.utility.keymap.comma){_tokenizeInput($container,$input,onTokenChange)}}).on("focusout",function(){_tokenizeInput($container,$input,onTokenChange);$container.removeClass("active")}).on("focusin",function(){$container.addClass("active")});$input.data("placeholder",$input.attr("placeholder"));if($container.find(".token").length)$input.attr("placeholder","")}});var _tokenizeInput=function($container,$input,onTokenChange){var val=$input.val().trim();var vals=val.split(/\s*\,\s*/);var has_tokens=false;vals.forEach(function(value){if(value){var $token=$("<span />").addClass("token").text(value);$input.before($token);has_tokens=true;if(onTokenChange)onTokenChange()}});if(has_tokens)$input.attr("placeholder","").val("")};var _untokenizeInput=function($container,$input,onTokenChange){var $token=$input.prev(".token");if($token.length){var val=$token.text();$token.remove();$input.val(val+" ")}else{$input.attr("placeholder",$input.data("placeholder"))}if(onTokenChange)onTokenChange()}})();(function(){"use strict";TS.registerModule("help",{issues_sorted_sig:new signals.Signal,issues:[],more_url:null,fake_api_rsps:false,max_title_chars:100,onStart:function(){if(!TS.client)return;TS.ms.connected_sig.addOnce(function(){TS.api.call("help.issues.list",{},TS.help.onListIssues)})},getIssueById:function(id){var issue;for(var i=0;i<TS.help.issues.length;i++){issue=TS.help.issues[i];if(issue.id==id){return issue}}return null},onListIssues:function(ok,data,args){if(TS.help.fake_api_rsps){TS.help.more_url="/help";TS.help.issues=[{id:"T00001",title:"issue 1",ts:"1111111111",short_text:"blah blah blah blah blah",state:"resolved"},{id:"T00002",title:"issue 2",ts:"1141111111",short_text:"I think this is ok",state:"open"},{id:"T00003",title:"issue 3",ts:"1121111111",short_text:"but I am not so sure abotu this",state:"unread"},{id:"T00004",title:"issue 4",ts:"1161111111",short_text:"what about that?",state:"open"},{id:"T00005",title:"issue 5",ts:"1151111111",short_text:"fuck it all to hell",state:"open"
},{id:"T00006",title:"issue 6",ts:"1171111111",short_text:"MORE BATTRY PLZ",state:"read"},{id:"T00007",title:"issue 7",ts:"1191111111",short_text:"halp",state:"unread"},{id:"T00008",title:"issue 8",ts:"191111111",short_text:"halp",state:"unread"},{id:"T00009",title:"issue 9",ts:"181111111",short_text:"halp",state:"unread"},{id:"T000010",title:"issue 10",ts:"171111111",short_text:"halp halp halp halp halp halp halp halp halp halp ...",state:"unread"}]}else if(ok){TS.help.issues=data.issues}TS.help.sortIssues();TS.help.updateIcon()},sortIssues:function(){var sort_map={unread:4,open:3,read:2,resolved:1};var issue;for(var i=0;i<TS.help.issues.length;i++){issue=TS.help.issues[i];issue._sorter=parseFloat((sort_map[issue.state]||5)+"."+issue.ts)}TS.help.issues.sort(function compare(a,b){if(a._sorter<b._sorter)return 1;if(a._sorter>b._sorter)return-1;return 0});TS.help.issues_sorted_sig.dispatch()},updateIcon:function(){var tab_css_class="normal";var unread_count=0;var open_count=0;var issue;for(var i=0;i<TS.help.issues.length;i++){issue=TS.help.issues[i];if(issue.state=="unread"){tab_css_class="unread";unread_count++}else if(issue.state=="open"){}}$("#help_icon").removeClass("normal open unread").addClass(tab_css_class);if(unread_count){$("#help_icon_circle_count").text(unread_count)}else{$("#help_icon_circle_count").text(open_count)}$("#flex_menu_toggle").removeClass("normal open unread").addClass(tab_css_class);$(".help_icon_circle_count").addClass("hidden");if(unread_count)$(".help_icon_circle_count").removeClass("hidden").text(unread_count)},createIssue:function(user_args,callback){var title=user_args["title"];var text=user_args["text"];if(!title)return;text=text||"";var args={title:title,text:text};if(user_args["tags"]){args["tags"]=user_args["tags"]}TS.api.call("help.issues.create",args,function(ok,data,args){if(ok){}else if(TS.help.fake_api_rsps){var issue={id:Date.now(),title:title,ts:Date.now()/1e3,short_text:text.substr(0,50),state:"open"};setTimeout(function(){TS.ms.handleMsg({type:"issue_created",issue:issue})},2e3)}if(callback)callback(ok,TS.help.makeErrStr(data))})},fetchIssueDetails:function(id,callback){var issue=TS.help.getIssueById(id);if(!issue){if(callback)callback(false,issue,"unknown issue");return}TS.api.call("help.issues.info",{id:id},function(ok,data,args){var iissue;if(TS.help.fake_api_rsps){ok=true;iissue=TS.utility.clone(issue);iissue.comments=[{ts:112211111,from:"eeric",text:"comment 1"},{ts:112214444,from:"whoop",text:"comment 2"}]}else if(ok){iissue=data.issue}TS.help.onIssueChange(iissue);if(callback)callback(ok,issue,TS.help.makeErrStr(data))})},markIssueRead:function(id,callback){var issue=TS.help.getIssueById(id);if(!issue){if(callback)callback(false,"unknown issue");return}if(issue.state!="unread"){if(callback)callback(true);return}TS.api.call("help.issues.markRead",{id:id},function(ok,data,args){if(ok){}else if(TS.help.fake_api_rsps){var clone=TS.utility.clone(issue);clone.state="read";setTimeout(function(){TS.ms.handleMsg({type:"issue_change",issue:clone})},2e3)}if(callback)callback(ok,TS.help.makeErrStr(data))})},replyToIssue:function(id,text,callback){TS.api.call("help.issues.replyTo",{id:id,text:text},function(ok,data,args){if(callback)callback(ok,TS.help.makeErrStr(data),data&&data.error?data.error:"")})},markIssueResolved:function(id,callback){var issue=TS.help.getIssueById(id);if(!issue){if(callback)callback(false,"unknown issue");return}TS.api.call("help.issues.markResolved",{id:id},function(ok,data,args){if(TS.help.fake_api_rsps||!ok&&data&&data.error=="ticket_closed"){ok=true;var clone=TS.utility.clone(issue);clone.state="resolved";setTimeout(function(){TS.ms.handleMsg({type:"issue_change",issue:clone})},1e3)}if(callback)callback(ok,TS.help.makeErrStr(data))})},onIssueChange:function(iissue){var issue=TS.help.getIssueById(iissue.id);if(issue){TS.help.updateIssue(iissue,issue)}else{TS.help.issues.push(iissue)}TS.help.sortIssues();TS.help.updateIcon()},updateIssue:function(iissue,issue){for(var k in iissue){issue[k]=iissue[k]}if(issue.comments){issue.comments.sort(function compare(a,b){if(a.ts<b.ts)return 1;if(a.ts>b.ts)return-1;return 0})}},makeErrStr:function(data){if(!data)return"missing data";if(data.ok)return null;if(data.error&&data.info&&TS.model.team.domain=="tinyspeck"){try{return'api error: "'+data.error+'"<br><br><div class="admin-section" style="word-wrap: break-word; word-break: break-word;">api rsp: '+JSON.stringify(data).replace(/\,/g,", ")+"</div>"}catch(error){}}if(data.error)return'api error: "'+data.error+'"'}})})();(function(){"use strict";TS.registerModule("ui.share_dialog",{div:null,showing:false,delegate:undefined,onStart:function(){},onKeydown:function(e){if(!TS.ui.share_dialog.showing)return;if(e.which==TS.utility.keymap.enter){if(TS.utility.getActiveElementProp("NODENAME")=="BODY"){TS.ui.share_dialog.go();e.preventDefault()}}else if(e.which==TS.utility.keymap.esc){if(TS.utility.getActiveElementProp("NODENAME")=="BODY"){TS.ui.share_dialog.cancel()}}},start:function(item_id,hide_file_preview,has_title){if(TS.client&&TS.client.ui.checkForEditing())return;var item=TS.files.getFileById(item_id);var type="file";if(item.mode=="post"){type="file_post"}else if(item.mode=="space"){type="file_space"}else if(item.mode=="snippet"){type="file_snippet"}var template_args={type:type,item:item,item_owner:TS.members.getMemberById(item.user),sharing_html:TS.templates.builders.buildFileSharingControls(item,true,null,has_title),file_html:hide_file_preview?"":TS.templates.builders.fileHTML(item,{for_share_dialog:true})};template_args["icon_class"]=TS.utility.getImageIconClass(item,"thumb_80");if(!TS.ui.share_dialog.div)TS.ui.share_dialog.build();var html=TS.templates.share_dialog(template_args);html=html.replace(/\ue000/g,"").replace(/\ue001/g,"");var div=TS.ui.share_dialog.div;div.html(html);var $file_comment_textarea=$("#file_comment_textarea");TS.ui.comments.bindInput($file_comment_textarea,TS.ui.share_dialog.go);$file_comment_textarea.autogrow();$file_comment_textarea=null;div.modal("show");div.find(".dialog_cancel").click(TS.ui.share_dialog.cancel);div.find(".dialog_go").click(TS.ui.share_dialog.go);TS.ui.bindFileShareDropdowns();TS.ui.bindFileShareShareToggle();TS.ui.bindFileShareCommentField()},go:function(){if(!TS.ui.share_dialog.showing){TS.error("not showing?");return}if(TS.ui.shouldBlockUploadDialogSubmission())return;var div=$("#share_dialog");var item_id=div.find("#share_item_id").val();var model_ob_id=div.find("#share_model_ob_id").val();if(!model_ob_id){var selected=$("#select_share_channels").filterSelect("value")[0];if(selected){model_ob_id=selected.model_ob.id}}if(!model_ob_id){TS.warn("model_ob_id is not set! "+$("#select_share_channels").val());return}var comment=TS.format.cleanMsg($("#file_comment_textarea").val());if($.trim(comment)==="")comment="";var share_fn=function(){TS.shared.getShareModelObId(model_ob_id,function(real_model_ob_id){var shared_from_msg=false;TS.files.shareFile(item_id,real_model_ob_id,comment,shared_from_msg)})};if(TS.ui.share_dialog.delegate&&typeof TS.ui.share_dialog.delegate.submit=="function"){TS.ui.share_dialog.delegate.submit(div,share_fn)}else{share_fn()}TS.ui.share_dialog.div.modal("hide")},cancel:function(){TS.ui.share_dialog.div.modal("hide")},end:function(){if(_thumbnail_lazy_load&&_thumbnail_lazy_load.detachEvents){_thumbnail_lazy_load.detachEvents()}_thumbnail_lazy_load=null;TS.ui.share_dialog.showing=TS.model.dialog_is_showing=false;TS.ui.comments.unbindInput($("#file_comment_textarea"));TS.ui.share_dialog.div.empty();$(window.document).unbind("keydown",TS.ui.share_dialog.onKeydown)},build:function(){$("body").append('<div id="share_dialog" class="modal hide fade"></div>');var div=TS.ui.share_dialog.div=$("#share_dialog");div.on("hidden",function(e){if(e.target!=this)return;TS.ui.share_dialog.end()});div.on("show",function(e){if(e.target!=this)return;TS.ui.share_dialog.showing=TS.model.dialog_is_showing=true});div.on("shown",function(e){if(e.target!=this)return;var preselected=$("#select_share_channels").filterSelect("value");if(preselected.length<1){$("#select_share_channels").filterSelect("getInstance").$input.focus()}else{$("#file_comment_textarea").focus()}$(window.document).bind("keydown",TS.ui.share_dialog.onKeydown);_thumbnail_lazy_load=TS.ui.share_dialog.div.find("img.lazy").lazyload()});div.on("click",function(e){if(TS.view)TS.view.doLinkThings(e)})}});var _thumbnail_lazy_load=null})();(function(){"use strict";TS.registerModule("pins",{pins_fetched_sig:new signals.Signal,pinned_status_changed_sig:new signals.Signal,pinned_message_changed_sig:new signals.Signal,pinned_message_deleted_sig:new signals.Signal,onStart:function(){TS.files.team_file_comment_deleted_sig.add(_fileCommentDeleted);TS.files.team_file_deleted_sig.add(_fileDeleted)},fetchPins:function(model_ob,callback){TS.api.call("pins.list",{channel:model_ob.id},function(ok,data,args){if(ok){var pinned_items=data.items;TS.pins.upsertPinnedItems(pinned_items);model_ob.pinned_items=pinned_items;model_ob.has_pins=pinned_items.length>0;TS.pins.pins_fetched_sig.dispatch(model_ob,pinned_items)}callback(ok,data,args)})},startPinFile:function(file_id,model_ob){var file=TS.files.getFileById(file_id);if(!file)return;_promptAddPin("file",model_ob,{file:file,type:"file"})},unPinFile:function(file_id,model_ob){var file=_getPinnedFile(file_id,model_ob);if(!file)return;var item={file:file,type:"file"};_promptRemovePin(item,model_ob,function(){_callPinsRemove(model_ob,item)})},startPinFileComment:function(comment_id,file_id,model_ob){var file=TS.files.getFileById(file_id);if(!file)return;var comment=TS.files.getFileCommentById(file,comment_id);if(!comment)return;_promptAddPin("comment",model_ob,{file:file,comment:comment,type:"file_comment"})},unPinFileComment:function(comment_id,file_id,model_ob){var comment=_getPinnedComment(comment_id,file_id,model_ob);var file=TS.files.getFileById(file_id);if(!comment||!file)return;var item={file:file,comment:comment,type:"file_comment"};_promptRemovePin(item,model_ob,function(){_callPinsRemove(model_ob,item)})},startPinMessage:function(msg_ts,model_ob){msg_ts=msg_ts.toString();var msg=TS.utility.msgs.getMsg(msg_ts,model_ob.msgs);if(!msg&&model_ob._archive_msgs)msg=TS.utility.msgs.getMsg(msg_ts,model_ob._archive_msgs);if(msg){if(msg.subtype==="file_comment"){TS.pins.startPinFileComment(msg.comment.id,msg.file.id,model_ob)}else if(msg.file){TS.pins.startPinFile(msg.file.id,model_ob)}else{_promptAddPin("message",model_ob,{message:msg,type:"message"})}}},unPinMessage:function(msg_ts,model_ob){msg_ts=msg_ts.toString();var msg=_getPinnedMsg(msg_ts,model_ob);if(msg){if(msg.subtype==="file_comment"){TS.pins.unPinFileComment(msg.comment.id,msg.file.id,model_ob)}else if(msg.file){TS.pins.unPinFile(msg.file.id,model_ob)}else{var item={message:msg,type:"message"};_promptRemovePin(item,model_ob,function(){_callPinsRemove(model_ob,item)})}}},isMessagePinned:function(msg,model_ob){if(msg.subtype==="file_comment"){if(!msg.comment)return false;return!!_getPinnedComment(msg.comment.id,msg.file.id,model_ob)}else if(msg.file){return!!_getPinnedFile(msg.file.id,model_ob)}else{return!!_getPinnedMsg(msg.ts,model_ob)}},pinStatusHasChanged:function(pinned,item,type,model_ob){var msg,file,comment;var item_changed,model_ob_changed,file_changes;if(type==="message"&&(model_ob.msgs||model_ob._archive_msgs)){msg=TS.utility.msgs.getMsg(item.message.ts,model_ob.msgs);if(!msg&&model_ob._archive_msgs)msg=TS.utility.msgs.getMsg(item.message.ts,model_ob._archive_msgs);if(msg){item.message=msg;item_changed=_updatePinnedStatus(pinned,msg,model_ob)}TS.utility.msgs.maybeStoreMsgs(model_ob.id,model_ob.msgs)}else if(type==="file_comment"){file_changes=TS.files.upsertFile(item.file);file=TS.files.getFileById(item.file.id);item.file=file;comment=TS.files.getFileCommentById(file,item.comment.id);if(comment){item.comment=comment;item_changed=_updatePinnedStatus(pinned,comment,model_ob)}else{comment=TS.files.addCommentToFile(item.comment,file);item.comment=comment}item_changed=item_changed||file_changes.status==="CHANGED"}else if(type==="file"){file_changes=TS.files.upsertFile(item.file);file=TS.files.getFileById(item.file.id);item.file=file;item_changed=_updatePinnedStatus(pinned,file,model_ob);item_changed=item_changed||file_changes.status==="CHANGED"}if(item.file)TS.files.makeSureReferencesGetSavedToLS(item.file.id);model_ob_changed=_updateModelPinnedItems(pinned,item,type,model_ob);if(item_changed||model_ob_changed)TS.pins.pinned_status_changed_sig.dispatch(model_ob,item)},upsertPinnedItems:function(pinned_items){pinned_items.forEach(function(item){if(item.type==="file"){TS.files.upsertFile(item.file);item.file=TS.files.getFileById(item.file.id)}else if(item.type==="file_comment"){TS.files.upsertFile(item.file);item.file=TS.files.getFileById(item.file.id);var comment=TS.files.getFileCommentById(item.file,item.comment.id);if(!comment)comment=TS.files.addCommentToFile(item.comment,item.file);item.comment=comment}})},replaceMsg:function(msg,model_ob){if(!model_ob.pinned_items)return;model_ob.pinned_items.forEach(function(item){if(item.type==="message"&&item.message.ts===msg.ts){item.message=msg;TS.pins.pinned_message_changed_sig.dispatch(model_ob,item)}})},removeMsg:function(msg_ts,model_ob){if(!model_ob.pinned_items)return;_updateModelPinnedItems(false,{message:{ts:msg_ts}},"message",model_ob);TS.pins.pinned_message_deleted_sig.dispatch(model_ob)},canUserPinHere:function(model_ob){if(!TS.client||!model_ob)return false;if(model_ob.is_general&&!TS.members.canUserPostInGeneral())return false;if(model_ob.is_channel&&!model_ob.is_member)return false;return true},test:function(){return{fileDeleted:_fileDeleted,fileCommentDeleted:_fileCommentDeleted}}});var _getPinnedFile=function(file_id,model_ob){var file=TS.files.getFileById(file_id);if(!file||!file.pinned_to)return null;var pinned=file.pinned_to.indexOf(model_ob.id)!==-1;return pinned?file:null};var _getPinnedComment=function(comment_id,file_id,model_ob){var file=TS.files.getFileById(file_id);if(!file)return null;var comment=TS.files.getFileCommentById(file,comment_id);if(!comment||!comment.pinned_to)return null;var pinned=comment.pinned_to.indexOf(model_ob.id)!==-1;return pinned?comment:null};var _getPinnedMsg=function(msg_ts,model_ob){if(model_ob.pinned_items){var item;for(var i=0;i<model_ob.pinned_items.length;i++){item=model_ob.pinned_items[i];if(item.type==="message"&&item.message.ts===msg_ts)return item.message}}var msg=TS.utility.msgs.getMsg(msg_ts,model_ob.msgs);if(!msg&&model_ob._archive_msgs)msg=TS.utility.msgs.getMsg(msg_ts,model_ob._archive_msgs);if(!msg)return null;if(msg.subtype==="file_comment"){if(_getPinnedComment(msg.comment.id,msg.file.id,model_ob))return msg}else if(msg.file){if(_getPinnedFile(msg.file.id,model_ob))return msg}else{if(msg.pinned_to&&msg.pinned_to.indexOf(model_ob.id)!==-1)return msg}return null};var _updatePinnedStatus=function(pinned,item,model_ob){var changed=false;if(!item.pinned_to)item.pinned_to=[];if(pinned){if(item.pinned_to.indexOf(model_ob.id)===-1){item.pinned_to.push(model_ob.id);changed=true}}else{var index=item.pinned_to.indexOf(model_ob.id);if(index!==-1){item.pinned_to.splice(index,1);changed=true}}return changed};var _updateModelPinnedItems=function(pinned,item,type,model_ob){var changed=false;if(!model_ob.pinned_items)model_ob.pinned_items=[];var pinned_items_index=-1;model_ob.pinned_items.some(function(pinned_item,index){var matches=false;if(type==="message"&&pinned_item.type==="message"){if(pinned_item.message.ts===item.message.ts)matches=true}else if(type==="file"&&pinned_item.type==="file"){if(pinned_item.file.id===item.file.id)matches=true}else if(type==="file_comment"&&pinned_item.type==="file_comment"){if(pinned_item.comment.id===item.comment.id)matches=true}if(matches){pinned_items_index=index;return true}});if(!pinned&&pinned_items_index!==-1){model_ob.pinned_items.splice(pinned_items_index,1);changed=true}else if(pinned&&pinned_items_index===-1){model_ob.pinned_items.unshift(item);changed=true}return changed};var _promptAddPin=function(type,model_ob,item){var template=Handlebars.compile("<p>Are you sure you want to pin this {{type}} to {{pinToLabel model_ob}}?</p>");var body=template({type:type,model_ob:model_ob});body+=TS.client.channel_page.pinnedItemHtml(item,model_ob);TS.generic_dialog.start({title:"Pin "+type,body:body,go_button_text:"Yes, pin this "+type,onGo:function(){_callPinsAdd(model_ob,item)}})};var _callPinsAdd=function(model_ob,item){var args=_apiArgs(model_ob,item);TS.api.call("pins.add",args,function(ok,data){if(!ok){if(data.error==="too_many_pins"){var type="message";if(item.type==="file")type="file";if(item.type==="file_comment")type="comment";TS.generic_dialog.start({title:"Couldn't pin "+type,body:"<p>Sorry! You've hit the limit on how many pins you can have in this "+(model_ob.is_channel?"channel":TS.templates.builders.groupCopy({skip_private:true}))+".</p>",show_cancel_button:false})}else{TS.logError(data.error,"pins.add got a not ok rsp")}if(data.error!=="already_pinned")return}TS.pins.pinStatusHasChanged(true,item,item.type,model_ob)})};var _callPinsRemove=function(model_ob,item){var args=_apiArgs(model_ob,item);TS.api.call("pins.remove",args,function(ok,data){if(!ok){if(data.error!=="not_pinned")return}TS.pins.pinStatusHasChanged(false,item,item.type,model_ob)})};var _apiArgs=function(model_ob,item){var args={channel:model_ob.id};if(item.type==="message"){args.timestamp=item.message.ts}else if(item.type==="file"){args.file=item.file.id}else if(item.type==="file_comment"){args.file_comment=item.comment.id}return args};var _promptRemovePin=function(item,model_ob,callback){TS.client.channel_page.highlightPinnedItemForRemoval(item);var html=TS.client.channel_page.pinnedItemHtml(item,model_ob);TS.generic_dialog.start({title:"Remove Pinned Item",body:"<p>Are you sure you want to remove this pinned item?</p>"+html,go_button_text:"Yes, remove this pinned item",onGo:callback,onCancel:function(){TS.client.channel_page.unHighlightPinnedItemForRemoval(item)}})};var _fileCommentDeleted=function(file,comment_id,deleted_comment){if(!deleted_comment||!deleted_comment.pinned_to)return;deleted_comment.pinned_to.forEach(function(model_ob_id){var model_ob=TS.shared.getModelObById(model_ob_id);if(!model_ob)return;var changed=_updateModelPinnedItems(false,{comment:deleted_comment},"file_comment",model_ob);if(changed)TS.pins.pinned_status_changed_sig.dispatch(model_ob)})};var _fileDeleted=function(file){if(!file)return;if(file.pinned_to){file.pinned_to.forEach(function(model_ob_id){var model_ob=TS.shared.getModelObById(model_ob_id);if(!model_ob)return;var changed=_updateModelPinnedItems(false,{file:file},"file",model_ob);if(changed)TS.pins.pinned_status_changed_sig.dispatch(model_ob)})}if(file.comments){file.comments.forEach(function(comment){_fileCommentDeleted(file,comment.id,comment)})}}})();(function(){"use strict";TS.registerModule("ui.toggle",{onStart:function(){$('input[type="checkbox"][data-style="toggle"]').each(function(){$(this).togglify()})},togglify:function($checkbox,settings){if(settings){settings=$.extend(TS.utility.clone(_default_settings),settings)}else{settings={};settings.initial_state=$checkbox.data("initial_state")?$checkbox.data("initial_state"):_default_settings.initial_state;settings.label=$checkbox.data("label")?$checkbox.data("label"):_default_settings.label;settings.on_class=$checkbox.data("on-class")?$checkbox.data("on-class"):_default_settings.on_class;settings.on_text=$checkbox.data("on-text")?$checkbox.data("on-text"):_default_settings.on_text;settings.off_text=$checkbox.data("off-text")?$checkbox.data("off-text"):_default_settings.off_text;settings.off_class=$checkbox.data("off-class")?$checkbox.data("off-class"):_default_settings.off_class;settings.off_label=$checkbox.data("off-label")?$checkbox.data("off-label"):_default_settings.off_label}if(settings.initial_state===null){settings.initial_state=$checkbox.is(":checked")?true:false}_create($checkbox,settings);return this}});var _default_settings={initial_state:null,label:"",on_text:"On",on_class:"",off_text:"Off",off_class:"",off_label:""};var _create=function($checkbox,settings){var $el_to_hide=$checkbox;var $label=$checkbox.closest("label");if($label.length){$el_to_hide=$label;var label_text=$.trim($label.text());if(label_text&&settings.label===_default_settings.label&&settings.off_label===_default_settings.off_label){settings.label=label_text}}var html=_build(settings);var $toggle=$(html);$el_to_hide.addClass("hidden").after($toggle);$toggle.on("click",function(){$(this).toggleClass("checked");$checkbox.prop("checked",$(this).hasClass("checked")).trigger("change");$(this).toggleClass(settings.on_class,$(this).hasClass("checked"));$(this).toggleClass(settings.off_class,!$(this).hasClass("checked"))})};var _build=function(settings){var html=TS.templates.toggle({settings:settings});return html}})();$.fn.togglify=function(settings){"use strict";return TS.ui.toggle.togglify($(this),settings)};(function(){"use strict";TS.registerModule("inline_file_previews",{onStart:function(){_startTimeAgoInterval()},checkForInlineFilePreviewClick:function(e){var $el=$(e.target);var file_id;var $msg=$el.closest(".message");if($msg.length===0)return;if($el.hasClass("service_link")||$el.closest(".service_link")>0)return;var container_id=$msg.attr("id");var $msg_inline_file_preview_toggler=$el.closest(".msg_inline_file_preview_toggler");if($msg_inline_file_preview_toggler.length>0){e.preventDefault();file_id=$msg_inline_file_preview_toggler.data("file-id");if($msg_inline_file_preview_toggler.hasClass("collapsed")){_inlineExpand(container_id,file_id)}else{_inlineCollapse(container_id,file_id)}return true}if($el.closest(".msg_inline_file_preview_expander").length>0){e.preventDefault();_inlineExpand(container_id,$el.closest(".msg_inline_file_preview_expander").data("file-id"));return true}if($el.closest(".msg_inline_file_preview_collapser").length>0){e.preventDefault();_inlineCollapse(container_id,$el.closest(".msg_inline_file_preview_collapser").data("file-id"));return true}var $container=$el.closest(".inline_file_preview_container, .file_container");if($container.length===0)return;if($el.closest(".preview_show.preview_show_more").length>0){e.preventDefault();_expandContent(e,$msg,$container);return true}if($el.closest(".preview_show.preview_show_less .preview_show_btn, .preview_show_less_header").length>0){e.preventDefault();_collapseContent(e,$msg,$container);return true}if($el.closest("a").length)return false;file_id=$container.data("file-id");var file=TS.files.getFileById(file_id);if(!file)return false;if(file.mode==="space"||file.mode==="post"||file.mode==="email"||file.mode==="snippet"){if($container.hasClass("inline_collapsed")){e.preventDefault();_expandContent(e,$msg,$container);return true}}return false},shouldTruncate:function(file){if(!file)return false;if(file.mode==="snippet"){if(file.lines_more>0)return true}else if(file.mode==="post"||file.mode==="space"){if(!file.preview)return false;if(file.preview.length>200)return true;if(file.preview.split(" ").length>50)return true;if(file.preview.split("\n").length>4)return true;var closing_tags=file.preview.match(/<\/(?:h\d|p|li|pre)>/g);if(closing_tags&&closing_tags.length>4)return true}else if(file.mode==="email"){return true}return false},isTruncated:function(msg_id,file){if(!file)return false;return!_expanded_content_state[msg_id+"_"+file.id]},showingFullContent:function(container_id,file_id){var state_id=container_id+"_"+file_id;var expanded=!!_expanded_content_state[state_id];if(!expanded)return false;var file=TS.files.getFileById(file_id);if(!file)return false;if(file.mode==="space"){if(!file.content_html)return false}else if(file.mode==="email"){if(!file.simplified_html&&file.attachments.length<1)return false}return expanded},expandableState:function(container_id,file_id){if(TS.model.expandable_state["inline_file_"+container_id+file_id])return true;if(TS.model.expandable_state["inline_file_"+container_id+file_id]===false)return false},shouldExpand:function(container_id,file_id){var expandable_state=TS.inline_file_previews.expandableState(container_id,file_id);if(typeof expandable_state==="boolean")return expandable_state;return true},expandAllInCurrent:function(){_no_scrolling=true;$(".msg_inline_file_preview_expander").trigger("click");$(".msg_inline_file_preview_toggler").each(function(i,el){var $el=$(el);var file_id=$el.data("file-id");var container_id=$el.closest(".message").attr("id");_inlineExpand(container_id,file_id)});_no_scrolling=false;if(TS.client)TS.client.ui.instaScrollMsgsToBottom(false)},collapseAllInCurrent:function(){$(".msg_inline_file_preview_collapser").trigger("click");$(".msg_inline_file_preview_toggler").each(function(i,el){var $el=$(el);var file_id=$el.data("file-id");var container_id=$el.closest(".message").attr("id");_inlineCollapse(container_id,file_id)})},test:function(){return{actuallyExpandContent:_actuallyExpandContent,updateSpacePreview:_updateSpacePreview}}});var _expanded_content_state={};var _no_scrolling=false;var _inlineExpand=function(container_id,file_id){TS.model.expandable_state["inline_file_"+container_id+file_id]=true;TS.storage.storeExpandableState(TS.model.expandable_state);var selector="#"+TS.utility.makeSafeForDomId(container_id);var $el=$(selector);if(!$el.length)return;var was_at_bottom=TS.client&&TS.client.ui.areMsgsScrolledToBottom();var filter=function(){return $(this).data("file-id")==file_id};var $holder=$el.find(".inline_file_preview_container, .file_container").filter(filter);$el.find(".msg_inline_file_preview_expander").filter(filter).addClass("hidden");$el.find(".msg_inline_file_preview_collapser").filter(filter).removeClass("hidden");$el.find(".msg_inline_file_title_hider").filter(filter).addClass("hidden");$el.find('.msg_inline_file_preview_toggler[data-file-id="'+file_id+'"]').removeClass("collapsed").addClass("expanded");$holder.removeClass("hidden");if(TS.client)TS.client.ui.checkInlineImgsAndIframesEverywhere();$holder.css("opacity",0).stop().animate({opacity:1},300);if(!_no_scrolling){if(TS.client&&was_at_bottom){TS.client.ui.instaScrollMsgsToBottom(false);$holder.scrollintoview({duration:0,offset:"top",px_offset:0,direction:"y"})}else{$holder.scrollintoview({duration:200,offset:"bottom",px_offset:0,direction:"y"})}}if(TS.client)TS.client.ui.updateClosestMonkeyScroller($el)};var _inlineCollapse=function(container_id,file_id){TS.model.expandable_state["inline_file_"+container_id+file_id]=false;TS.storage.storeExpandableState(TS.model.expandable_state);var selector="#"+TS.utility.makeSafeForDomId(container_id);var $el=$(selector);if(!$el.length)return;var filter=function(){return $(this).data("file-id")==file_id};var $holder=$el.find(".inline_file_preview_container, .file_container").filter(filter);$el.find(".msg_inline_file_preview_expander").filter(filter).removeClass("hidden");$el.find(".msg_inline_file_preview_collapser").filter(filter).addClass("hidden");$el.find(".msg_inline_file_title_hider").filter(filter).removeClass("hidden");$el.find('.msg_inline_file_preview_toggler[data-file-id="'+file_id+'"]').removeClass("expanded").addClass("collapsed");$holder.addClass("hidden");setTimeout(function(){if(TS.client)TS.client.ui.updateClosestMonkeyScroller($el)},0)};var _expandContent=function(e,$msg,$container){var file_id=$container.data("file-id");var file=TS.files.getFileById(file_id);if(!file)return;if(file.mode==="post"||file.mode==="space"||file.mode==="snippet"){var $btn=$container.find(".preview_show_more .preview_show_btn");$btn.data("stashed_text",$btn.html()).empty();var spinner=new Spinner({lines:9,length:0,width:4,radius:5,corners:1,rotate:0,direction:1,color:"#ffffff",speed:1,trail:25,shadow:false,hwaccel:false,className:"spinner",zIndex:2e9,top:"-8px",left:"-4px",opacity:.1});spinner.spin($btn.get(0));$container.addClass("loading");TS.files.fetchFileInfo(file_id,function(id,file){spinner.stop();$btn.html($btn.data("stashed_text"));$container.removeClass("loading");if(file.content_html||file.content_highlight_html)_actuallyExpandContent($msg,file)})}else if(file.mode==="email"){if(file.simplified_html){_actuallyExpandContent($msg,file)}else{$msg.find(".email_content").addClass("loading");var expand_timeout=setTimeout(function(){$msg.find(".inline_file_preview_container, .file_container").addClass("expanded")},1e3);TS.files.fetchFileInfo(file_id,function(id,fetched_file){clearTimeout(expand_timeout);_actuallyExpandContent($msg,fetched_file);$msg.find(".email_content").removeClass("loading")})}}};var _actuallyExpandContent=function($msg,file){var container_id=$msg.attr("id");var state_id=container_id+"_"+file.id;_expanded_content_state[state_id]=true;$msg.find(".inline_file_preview_container, .file_container").removeClass("inline_collapsed").addClass("inline_expanded");if(file.mode==="space"||file.mode==="post"){_updateSpacePreview($msg,file)}else if(file.mode==="email"){if(file.simplified_html===""){file.simplified_html="(This email does not have any content.)"}$msg.find(".email_content").html(file.simplified_html)}else if(file.mode==="snippet"){_updateSnippetPreview($msg,file)}if(TS.client)TS.client.ui.updateClosestMonkeyScroller($msg)};var _collapseContent=function(e,$msg,$container){var ts=$msg.attr("id");var file_id=$container.data("file-id");var file=TS.files.getFileById(file_id);if(!file)return;var state_id=ts+"_"+file_id;delete _expanded_content_state[state_id];$msg.find(".inline_file_preview_container, .file_container").removeClass("inline_expanded").addClass("inline_collapsed");if(file.mode==="space"||file.mode==="post"){_updateSpacePreview($msg,file)}else if(file.mode==="snippet"){_updateSnippetPreview($msg,file)}if(!_no_scrolling){$msg.scrollintoview({duration:0,offset:"top",px_offset:0,direction:"y"})}if(TS.client)TS.client.ui.updateClosestMonkeyScroller($msg)};var _timeAgoInterval;var _startTimeAgoInterval=function(){if(_timeAgoInterval)clearInterval(_timeAgoInterval);var updater=function(){var $times=$("#msgs_div .file_time_ago");var times=[];$times.each(function(){var file_id=$(this).data("file-id");var file=TS.files.getFileById(file_id);if(!file){times.push($(this).text());return}times.push(TS.utility.date.toTimeAgo(file.updated));file=null});$times.each(function(index,element){$(element).text(times[index]);element=null});$times=null};updater=TS.utility.throttleFunc(updater,5e3);_timeAgoInterval=setInterval(updater,6e4)};var _updateSpacePreview=function($msg,file){};var _updateSnippetPreview=function($msg,file){}})();(function(){"use strict";TS.registerModule("rxns",{rxn_records_changed_sig:new signals.Signal,member_rxns_fetched_sig:new signals.Signal,member_rxns_being_fetched_sig:new signals.Signal,need_alerts:{},onStart:function(){if(!TS.client)return;_dispatchSignalThrottled=function(){};var _throttledUpdateUI=function(){};TS.client.login_sig.add(function(){_dispatchSignalThrottled=TS.utility.throttleFunc(_dispatchSignal,100);_throttledUpdateUI=TS.utility.throttleFunc(_updateUI,1e3)});_updateUIThrottled=function(rxn_key){_throttledUpdateUI(rxn_key)}},upsertRxnsFromDataAndUpdateUI:function(rxn_key,rxns){var upsert=_upsertRxnsFromData(rxn_key,rxns);if(upsert.status!="NOOP"){_updateUIThrottled(rxn_key)}return upsert},getRxnKey:function(type,id,c_id){if(type=="message"&&!c_id)TS.error("getRxnKey: no c_id provided for message rxn_key");if(type!="message"&&c_id)TS.error("getRxnKey: c_id provided for but this is not a message rxn_key");return type+"-"+id+"-"+(c_id||"")},getRxnKeyByMsgType:function(msg){var rxn_key;if(msg.subtype=="file_upload"||msg.subtype=="file_share"||msg.subtype=="file_mention"){if(msg.file)rxn_key=msg.file._rxn_key}else if(msg.subtype=="file_comment"){if(msg.comment)rxn_key=msg.comment._rxn_key}else{rxn_key=msg._rxn_key}return rxn_key},getRxnKeyFromData:function(item){var id;if(item.type=="message"){id=item.ts||item.message.ts}else if(item.type=="file"){id=item.file.id||item.file}else if(item.type=="file_comment"){
id=item.file_comment||item.comment.id}else{throw"item.type not handled"}return TS.rxns.getRxnKey(item.type,id,item.channel)},getExistingRxnsByKey:function(rxn_key){return _rxns[rxn_key]||null},getRxnRecordByKey:function(rxn_key){if(_rxn_records_map[rxn_key])return _rxn_records_map[rxn_key];for(var i=_rxn_records.length-1;i>-1;i--){if(_rxn_records[i].rxn_key===rxn_key){_rxn_records_map[rxn_key]=_rxn_records[i];return _rxn_records_map[rxn_key]}}return null},getNextRxnRecordThatNeedsAlert:function(){var candidate;for(var i=_rxn_records.length-1;i>-1;i--){if(TS.rxns.need_alerts[_rxn_records[i].rxn_key]){candidate=_rxn_records[i]}else{break}}return candidate},getRxnsFromData:function(item){if(item.type=="message")return item.message&&item.message.reactions;if(item.type=="file")return item.file&&item.file.reactions;if(item.type=="file_comment")return item.comment&&item.comment.reactions;return null},doesRxnsHaveRxnFromMember:function(rxns,name,member_id){name=TS.emoji.nameToCanonicalName(name);if(!rxns)return false;var rxn=TS.rxns.getRxnFromRxns(rxns,name);if(!rxn)return false;if(!rxn.count)return false;if(!rxn.users)return false;return rxn.users.indexOf(member_id)!=-1},doesRxnsHaveRxnFromUser:function(rxns,name){return TS.rxns.doesRxnsHaveRxnFromMember(rxns,name,TS.model.user.id)},doesRxnsHaveRxn:function(rxns,name){if(!rxns)return false;return!!TS.rxns.getRxnFromRxns(rxns,name)},countAllRxns:function(rxns){if(!rxns)return 0;var t=0;rxns.forEach(function(rxn){t+=rxn.count||0});return t},countAllEmoji:function(rxns){if(!rxns)return 0;return rxns.length},countAllUsersRxns:function(rxns,user_id){if(!rxns)return 0;var t=0;rxns.forEach(function(rxn){if(rxn.users.indexOf(user_id)>-1){t++}});return t},getAllUniqueRxners:function(rxns,except){if(!rxns)return[];var rxners=[];rxns.forEach(function(rxn){if(!rxn)return;if(!rxn.count)return;if(!rxn.users)return;rxn.users.forEach(function(member_id){if(except==member_id)return;if(rxners.indexOf(member_id)!=-1)return;rxners.push(member_id)})});return rxners},getRxnFromRxns:function(rxns,name){if(!rxns)return null;return rxns.filter(function(val){return val.name==name})[0]||null},changeRxnsFromIMsg:function(imsg){if(!imsg.item)return;var simple_format=false;if(imsg.item.type=="message"&&imsg.item.ts){simple_format=true}else if(imsg.item.type=="file"&&typeof imsg.item.file=="string"){simple_format=true}else if(imsg.item.type=="file_comment"&&imsg.item.file_comment&&typeof imsg.item.file=="string"){simple_format=true}if(!simple_format)return;if(!_isReactionItemRelevant(imsg.item))return;var by_self=imsg.user==TS.model.user.id;var rxn_key=TS.rxns.getRxnKeyFromData(imsg.item);var existing_rxns=TS.rxns.getExistingRxnsByKey(rxn_key);var new_rxns;var adding=imsg.type=="reaction_added";new_rxns=_addOrRemoveRxnFromRxns(adding,TS.utility.clone(existing_rxns)||[],imsg.reaction,imsg.user);var upsert=_upsertRxnsFromData(rxn_key,new_rxns);TS.dir(888,upsert,"handleRxnChangeFromMS upsert status:"+upsert.status);_maybeUpdateRxnRecords(imsg);if(upsert.status=="NOOP")return;if(by_self&&!imsg._from_evt_log){_updateUI(rxn_key,imsg.reaction,imsg.user)}else{_updateUIThrottled(rxn_key)}},changeRxnsFromUserAction:function(rxn_key,name,adding){name=TS.emoji.nameToCanonicalName(name);TS.log(888,"changeRxnsFromUserAction rxn_key:"+rxn_key+" name:"+name+" adding:"+adding);if(!TS.emoji.isValidName(name)){TS.error('"'+name+'" is not a valid emoji');return}var existing_rxns=TS.rxns.getExistingRxnsByKey(rxn_key)||[];if(adding){var emoji_cnt=TS.rxns.countAllEmoji(existing_rxns);var rxns_cnt=TS.rxns.countAllUsersRxns(existing_rxns,TS.model.user.id);if(emoji_cnt>=50&&!TS.rxns.doesRxnsHaveRxn(existing_rxns,name)){_displayTooManyError(TOO_MANY_EMOJI);return}else if(rxns_cnt>=20){_displayTooManyError(TOO_MANY_REACTIONS);return}}var new_rxns=_addOrRemoveUserRxnFromRxns(adding,TS.utility.clone(existing_rxns),name);TS.dir(888,existing_rxns,"existing_rxns");TS.dir(888,new_rxns,"new_rxns");var upsert=_upsertRxnsFromUserAction(rxn_key,new_rxns);TS.dir(888,upsert,"changeRxnsFromUserAction upsert status:"+upsert.status);if(upsert.status=="NOOP"){TS.error("changeRxnsFromUserAction called but no NOOP?");return}_updateUI(rxn_key,name,TS.model.user.id);var method=adding?"reactions.add":"reactions.remove";var api_args=_getApiArgsFromKey(rxn_key,{name:name});_incrementPendingCnt(rxn_key);TS.api.call(method,api_args,function(ok,data,args){_decrementPendingCnt(rxn_key);var update_ui=false;if(ok){if(adding)TS.prefs.recordEmojiUse(":"+args.name+":")}else if(!adding&&data.error&&data.error=="no_reaction"){}else{if(data.error==TOO_MANY_EMOJI||data.error==TOO_MANY_REACTIONS){_displayTooManyError(data.error)}else if(data.error==INVALID_NAME){TS.generic_dialog.alert("Darn it, "+TS.emoji.graphicReplace(":"+args.name+":")+" doesn't work as a reaction yet! But rest assured, the full range of skin tones will be supported soon. Were working on it!"+TS.emoji.graphicReplace(":wrench:"),"Invalid Emoji Name")}var current_rxns=TS.rxns.getExistingRxnsByKey(rxn_key)||[];var undone_rxns=_addOrRemoveUserRxnFromRxns(!adding,TS.utility.clone(current_rxns),name);var upsert=_upsertRxnsFromUserAction(rxn_key,undone_rxns);TS.dir(888,upsert,"changeRxnsFromUserAction UNDO upsert status:"+upsert.status);if(upsert.status=="NOOP"){TS.log(888,"changeRxnsFromUserAction trying to undo because of API rsp, but no NOOP?")}else{update_ui=true}}var maybeUpdateModel=function(){TS.log(888,"maybeUpdateModel pending:"+_pending_counts[rxn_key]+" _pending_last:"+_pending_last[rxn_key]);if(_pending_counts[rxn_key])return false;if(!_pending_last.hasOwnProperty(rxn_key))return false;var upsert=_upsertRxnsFromUserAction(rxn_key,_pending_last[rxn_key]);delete _pending_last[rxn_key];TS.dir(888,upsert,"maybeUpdateModel status:"+upsert.status);if(upsert.status=="NOOP")return false;_updateUI(rxn_key);_fetchAndUpdateRxns(rxn_key);return true};if(!maybeUpdateModel()&&!update_ui)return;_updateUI(rxn_key)})},checkForRxnClick:function(e){if(!e||!e.target)return;var $el=$(e.target);var $emoji_rxn=$el.closest(".emoji_rxn");if(!$emoji_rxn.length)return;var name=String($emoji_rxn.data("emoji"));if($emoji_rxn.hasClass("emoji_rxn")){var $rxn_panel=$el.closest(".rxn_panel");var rxn_key=$rxn_panel.data("rxn-key");var adding;if($emoji_rxn.hasClass("menu_rxn")){TS.emoji_menu.startEmoForRxn(e,rxn_key)}else{adding=!$emoji_rxn.hasClass("user_reacted");if(!adding&&e.shiftKey){var rxns=TS.rxns.getExistingRxnsByKey(rxn_key);rxns.forEach(function(rxn){if(!TS.rxns.doesRxnsHaveRxnFromUser(rxns,rxn.name))return;TS.rxns.changeRxnsFromUserAction(rxn_key,rxn.name,adding)})}else{TS.rxns.changeRxnsFromUserAction(rxn_key,name,adding)}}}},getRxnRecords:function(){return _rxn_records},getRxnKeyParts:function(rxn_key){var keyA=rxn_key.split("-");return{type:keyA[0],id:keyA[1],c_id:keyA[2]}},test:function(){return{updateUI:_updateUI,addOrRemoveRxnFromRxns:_addOrRemoveRxnFromRxns,upsertRxnsFromData:_upsertRxnsFromData,upsertRxns:_upsertRxns,incrementPendingCnt:_incrementPendingCnt,decrementPendingCnt:_decrementPendingCnt,fetchAndUpdateRxns:_fetchAndUpdateRxns,displayTooManyError:_displayTooManyError}}});var _rxn_records=[];var _rxn_records_map={};var _rxns={};var _pending_counts={};var _pending_last={};var _updateUI=function(rxn_key,name,member_id){var was_at_bottom=TS.client&&TS.client.ui&&TS.client.ui.areMsgsScrolledToBottom();TS.templates.builders.updateRxnPanels(rxn_key,name,member_id);if(TS.client&&was_at_bottom){TS.client.ui.instaScrollMsgsToBottom(true)}};var _updateUIThrottled=function(rxn_key){_updateUI(rxn_key)};var _addOrRemoveUserRxnFromRxns=function(adding,rxns,name){return _addOrRemoveRxnFromRxns(adding,rxns,name,TS.model.user.id)};var _addOrRemoveRxnFromRxns=function(adding,rxns,name,member_id){var rxn=TS.rxns.getRxnFromRxns(rxns,name);if(adding){if(!rxn){rxns.push({users:[member_id],count:1,name:name})}else{if(TS.utility.ensureInArray(rxn.users,member_id)){rxn.count++}else{}}}else{if(rxn){if(TS.utility.removeFromArray(rxn.users,member_id)){rxn.count--;if(rxn.count<1||rxn.users.length===0){TS.utility.removeFromArray(rxns,rxn)}if(!rxns.length){rxns=null}}else{}}else{}}return rxns};var _upsertRxnsFromUserAction=function(rxn_key,rxns){return _upsertRxns(rxn_key,rxns,true)};var _upsertRxnsFromData=function(rxn_key,rxns){return _upsertRxns(rxn_key,rxns,false)};var _upsertRxns=function(rxn_key,rxns,force){var upsert={status:"NOOP",what_changed:[],rxns:rxns};if(!force&&_pending_counts[rxn_key]){_pending_last[rxn_key]=TS.utility.clone(rxns||null);TS.log(888,"_upsertRxns call ignored because !force && _pending_counts["+rxn_key+"]:"+_pending_counts[rxn_key]);return upsert}var existing_rxns=TS.rxns.getExistingRxnsByKey(rxn_key);var key_parts=TS.rxns.getRxnKeyParts(rxn_key);if(rxns){if(existing_rxns){if(!TS.utility.areSimpleObjectsEqual(existing_rxns,rxns,"rxn_key:"+rxn_key)){upsert.status="CHANGED";_rxns[rxn_key]=rxns}}else{upsert.status="ADDED";_rxns[rxn_key]=rxns}}else if(existing_rxns){upsert.status="CHANGED";delete _rxns[rxn_key]}upsert.rxns=_rxns[rxn_key]||null;if(upsert.status!="NOOP"){if(key_parts.type=="message"){if(!key_parts.c_id)TS.error("_upsertRxns: no c_id provided but type is message");var model_ob=TS.shared.getModelObById(key_parts.c_id);var msg=model_ob&&TS.utility.msgs.getMsg(key_parts.id,model_ob.msgs);if(!msg){TS.dir(888,upsert.rxns,"_upsertRxns no need to update msg reactions key:"+rxn_key)}else{TS.dir(888,upsert.rxns,"_upsertRxns updated msg reactions key:"+rxn_key);TS.utility.msgs.maybeStoreMsgs(key_parts.c_id,model_ob.msgs,true)}}else if(key_parts.type=="file"){TS.files.makeSureReferencesGetSavedToLS(key_parts.id)}else if(key_parts.type=="file_comment"){TS.files.makeSureReferencesGetSavedToLS(key_parts.id)}else{throw"type not handled"}}TS.dir(888,upsert,rxn_key);return upsert};var _incrementPendingCnt=function(rxn_key){if(!rxn_key)return;_pending_counts[rxn_key]=_pending_counts[rxn_key]||0;_pending_counts[rxn_key]++;TS.log(888,"_incrementPendingCnt "+rxn_key+": "+_pending_counts[rxn_key])};var _decrementPendingCnt=function(rxn_key){if(!_pending_counts[rxn_key]){TS.log(888,"_decrementPendingCnt "+rxn_key+": "+_pending_counts[rxn_key]);return}_pending_counts[rxn_key]--;if(_pending_counts[rxn_key]===0){delete _pending_counts[rxn_key]}TS.log(888,"_decrementPendingCnt "+rxn_key+": "+_pending_counts[rxn_key])};var _getApiArgsFromKey=function(rxn_key,args){args=args||{};var key_parts=TS.rxns.getRxnKeyParts(rxn_key);if(key_parts.type=="message"){args.channel=key_parts.c_id;args.timestamp=key_parts.id}else if(key_parts.type=="file"){args.file=key_parts.id}else if(key_parts.type=="file_comment"){args.file_comment=key_parts.id}else{throw"type not handled"}return args};var _fetchAndUpdateRxns=function(rxn_key,attempt){attempt=attempt||1;var max_attempts=2;var api_args=_getApiArgsFromKey(rxn_key,{full:true});TS.log(888,"_fetchAndUpdateRxns rxn_key:"+rxn_key+" attempt:"+attempt);_incrementPendingCnt(rxn_key);TS.api.call("reactions.get",api_args,function(ok,data,args){_decrementPendingCnt(rxn_key);if(ok){var rxns=TS.rxns.getRxnsFromData(data);var upsert=_upsertRxnsFromData(rxn_key,rxns);TS.dir(888,upsert,"_fetchAndUpdateRxns upsert status:"+upsert.status);if(upsert.status=="NOOP")return;_updateUI(rxn_key)}else{TS.error("_fetchAndUpdateRxns got an err:"+JSON.stringify(data||null))}if(attempt<max_attempts){_fetchAndUpdateRxns(rxn_key,++attempt)}})};var _getRxnRecordEntryByNameAndMemberId=function(record,name,member_id){if(!record)return null;if(!record.emoji)return null;if(!record.emoji.hasOwnProperty(name))return null;for(var i=0;i<record.emoji[name].length;i++){if(record.emoji[name][i].id===member_id)return record.emoji[name][i]}return null};var _isImsgRelevantToRxnRecords=function(imsg){if(!TS.client)return false;if(imsg.user==TS.model.user.id)return false;if(imsg.item.type=="message"&&typeof imsg.item.message!=="undefined"&&imsg.item.message.user!=TS.model.user.id)return false;if(imsg.item.type=="file"&&typeof imsg.item.file!=="undefined"&&imsg.item.file.user!=TS.model.user.id)return false;if(imsg.item.type=="file_comment"&&typeof imsg.item.comment!=="undefined"&&imsg.item.comment.user!=TS.model.user.id)return false;return true};var _maybeUpdateRxnRecords=function(imsg){if(!_isImsgRelevantToRxnRecords(imsg))return;var rxn_key=TS.rxns.getRxnKeyFromData(imsg.item);if(imsg.type=="reaction_added"){var and_alert=!imsg._from_evt_log&&imsg.item.type=="message";_addToRxnsRecord(imsg.reaction,rxn_key,imsg.user,imsg.event_ts,and_alert)}else{_removeFromRxnsRecord(imsg.reaction,rxn_key,imsg.user)}};var _isReactionItemRelevant=function(item){if(!item)return false;if(item.type=="message"){var msg=TS.utility.msgs.findMsg(item.ts,item.channel);if(!msg)return false;item.message=msg;return true}else if(item.type=="file"||item.type=="file_comment"){var file=TS.files.getFileById(item.file);if(!file)return false;item.file=file;if(item.type=="file_comment"){var comment=TS.files.getFileCommentById(file,item.file_comment);if(!comment)return false;item.comment=comment}return true}return false};var _addToRxnsRecord=function(name,rxn_key,member_id,when,and_alert){when=when||TS.utility.date.makeTsStamp();and_alert=!!and_alert;var added=false;var record=_rxn_records_map[rxn_key];if(!record){added=true;record=_rxn_records_map[rxn_key]=_rxn_records[_rxn_records.length]={rxn_key:rxn_key}}record.last_update=when;if(and_alert){TS.rxns.need_alerts[rxn_key]=TS.rxns.need_alerts[rxn_key]||when}record.emoji=record.emoji||{};var which=record.emoji[name]=record.emoji.hasOwnProperty(name)&&record.emoji[name]||[];var entry=_getRxnRecordEntryByNameAndMemberId(record,name,member_id)||(which[which.length]={id:member_id});entry.when=when;TS.dir(877,_rxn_records,name+" "+rxn_key+" "+member_id);var len=_rxn_records.length;if(added&&len>1&&_rxn_records[len-1].last_update<_rxn_records[len-2].last_update){_rxn_records.sort(function compare(a,b){if(a.last_update<b.last_update)return-1;if(a.last_update>b.last_update)return 1;return 0})}_dispatchSignalThrottled(and_alert)};var _dispatchSignal=function(and_alert){TS.rxns.rxn_records_changed_sig.dispatch(and_alert)};var _dispatchSignalThrottled=function(){_dispatchSignal()};var _removeFromRxnsRecord=function(name,rxn_key,member_id){var record=TS.rxns.getRxnRecordByKey(rxn_key);var entry=_getRxnRecordEntryByNameAndMemberId(record,name,member_id);if(entry&&record){TS.utility.removeFromArray(record.emoji[name],entry);if(!record.emoji[name].length){delete record.emoji[name]}if(!Object.keys(record.emoji).length){delete _rxn_records_map[rxn_key];TS.utility.removeFromArray(_rxn_records,record)}}TS.rxns.rxn_records_changed_sig.dispatch()};var _displayTooManyError=function(error){if(error==TOO_MANY_REACTIONS){TS.generic_dialog.alert("A message can contain up to 20 different emojis from a single person. Sorry, you cant add any more than this!","Reaction Limit Reached")}else if(error==TOO_MANY_EMOJI){TS.generic_dialog.alert("A message can contain up to 50 different emojis in its reactions. Sorry, you cant add any more than this!","Reaction Limit Reached")}else{return}};var TOO_MANY_REACTIONS="too_many_reactions";var TOO_MANY_EMOJI="too_many_emoji";var INVALID_NAME="invalid_name"})();(function(){"use strict";TS.registerModule("ui.new_channel_modal",{onStart:function(){},start:function(title,is_public,preselected_ids){if(!TS.members.canUserCreateChannels()&&!TS.members.canUserCreateGroups())return;TS.ui.fs_modal.start({body_template_html:'<div id="new_channel_modal_container"></div>',onShow:_onShow,onEnd:_onEnd});_$modal_container=$("#new_channel_modal_container");return TS.ui.new_channel_modal.startInContainer(_$modal_container,title,is_public,preselected_ids)},startInContainer:function($container,title,is_public,preselected_ids){if(!TS.members.canUserCreateChannels()&&!TS.members.canUserCreateGroups())return;_$modal_container=$container;_is_public=is_public!==false;if(!TS.members.canUserCreateChannels())_is_public=false;if(!TS.members.canUserCreateGroups())_is_public=true;var can_toggle_private=TS.members.canUserCreateChannels()&&TS.members.canUserCreateGroups();title=TS.utility.cleanChannelName(title||"").substr(0,TS.model.channel_name_max_length);preselected_ids=preselected_ids||[];var members_you_can_invite=TS.groups.getActiveMembersForInviting(TS.model.user.is_admin);var invite_members=TS.channels.makeMembersWithPreselectsForTemplate(members_you_can_invite,preselected_ids);_$modal_container.html(TS.templates.channel_new_modal({title:title,is_public:_is_public,can_toggle_private:can_toggle_private,compliance_exports_enabled_for_team:!!TS.model.team.prefs.compliance_export_start,is_ra:TS.model.user.is_restricted}));_ladda=Ladda.create(_$modal_container.find(".new_channel_go")[0]);invite_members.sort(function(a,b){return TS.members.memberSorterByName(a.member,b.member)});_bindUI(invite_members);return new Promise(function(resolve,reject){_deferred={resolve:resolve,reject:reject}})},go:function(){var validated=TS.channels.ui.channelCreateDialogValidateInput(_$modal_container);if(!validated)return;var title=_$modal_container.find(".title_input").val();var invited_members=$("#invite_members_container").filterSelect("value").map(function(item){return item.member.id});var purpose=$.trim(_$modal_container.find("#channel_purpose_input").val());if(_ladda)_ladda.start();if(_is_public){_createPublicChannel(title,invited_members,purpose)}else{_createPrivateChannel(title,invited_members,purpose)}},end:function(){_cleanup()},test:function(){return{createPublicChannel:_createPublicChannel,createPrivateChannel:_createPrivateChannel,showNameTakenAlert:_showNameTakenAlert}}});var _$modal_container;var _ladda;var _is_public;var _deferred;var _bindKeyboardShortcuts=function(){var people_picker_input=_$modal_container.find(".chzn-container").find("input")[0];var purpose_input=_$modal_container.find("#channel_purpose_input")[0];_$modal_container.on("keydown",function(e){if(e.which===TS.utility.keymap.enter&&document.activeElement!=people_picker_input&&document.activeElement!=purpose_input){TS.ui.new_channel_modal.go();e.preventDefault()}else if(e.which===TS.utility.keymap.esc){TS.ui.fs_modal.close();e.preventDefault()}})};var _bindPublicPrivateToggle=function(){var $toggle=$("#channel_public_private_toggle");$toggle.togglify();$toggle.bind("change",function(){_is_public=$toggle.is(":checked");if($toggle.is(":checked")){_$modal_container.find(".private_channel_item").addClass("hidden");_$modal_container.find(".public_channel_item").removeClass("hidden")}else{_$modal_container.find(".public_channel_item").addClass("hidden");_$modal_container.find(".private_channel_item").removeClass("hidden")}})};var _bindFilterSelect=function(members){var prev_query;var start_regex;var suffix_regex;$("#invite_members_container").filterSelect({append:true,data:members,per_page:50,placeholder_text:"Search by name",template:function(item){var html=TS.templates.channel_invite_member_small({member:item.member});return new Handlebars.SafeString(html)},tokenTemplate:function(item){var html=TS.templates.channel_invite_member_token({member:item.member});return new Handlebars.SafeString(html)},tokenClass:function(item){return TS.templates.builders.getMemberTypeClass(item.member)},filter:function(item,query){var member=item.member;if(prev_query!==query){start_regex=new RegExp("^"+TS.utility.regexpEscape(query),"i");suffix_regex=new RegExp("(-|_|\\+|\\s|\\.|@)"+TS.utility.regexpEscape(query),"i");prev_query=query}var match_names_only=true;return TS.members.checkMemberMatch(member,start_regex,match_names_only)||TS.members.checkMemberMatch(member,suffix_regex,match_names_only)},noResultsTemplate:function(query){if(!query){return"No one found"}else{return"No one found matching <strong>"+TS.utility.truncateAndEscape(query,50)+"</strong>"}}})};var _bindUI=function(members){_bindFilterSelect(members);_$modal_container.find(".new_channel_go").click(TS.ui.new_channel_modal.go);_bindKeyboardShortcuts();_bindPublicPrivateToggle();$("#channel_create_title").focus()};var _createPublicChannel=function(title,invited_members,purpose){TS.channels.join(title,function(ok,data,args){if(_ladda)_ladda.stop();if(!ok){if(data.error=="name_taken"){_showNameTakenAlert()}else if(data.error=="restricted_action"){_showError("Sorry! An admin on your team has restricted who can create public channels.")}else{TS.error("Failed to create private channel: "+data.error);_showError("Sorry! Something went wrong.")}return}if(purpose)TS.channels.setPurpose(data.channel.id,purpose);if(invited_members){for(var i=0;i<invited_members.length;i++){TS.api.call("channels.invite",{channel:data.channel.id,user:invited_members[i]})}}var resolve=_deferred&&_deferred.resolve;TS.ui.fs_modal.close();if(resolve)resolve(data.channel)})};var _createPrivateChannel=function(title,invited_members,purpose){TS.groups.create(title,invited_members,function(ok,data,args){if(_ladda)_ladda.stop();if(!ok){if(data.error=="name_taken"){_showNameTakenAlert()}else if(data.error=="restricted_action"){_showError("Sorry! An admin on your team has restricted who can create private channels.")}else{TS.error("Failed to create private channel: "+data.error);_showError("Sorry! Something went wrong.")}return}if(purpose)TS.groups.setPurpose(data.group.id,purpose);var resolve=_deferred&&_deferred.resolve;TS.ui.fs_modal.close();if(resolve)resolve(data.group)})};var _showNameTakenAlert=function(){TS.channels.ui.channelCreateDialogShowNameTakenAlert(_$modal_container)};var _showError=function(message){TS.channels.ui.channelCreateDialogShowOtherErrorAlert(_$modal_container,message)};var _unbindUI=function(){if(_$modal_container){_$modal_container.find(".new_channel_go").off("click");_$modal_container.find("#channel_public_private_toggle").off("change");_$modal_container.off("keydown")}};var _onShow=function(){};var _onEnd=function(){_cleanup()};var _cleanup=function(){_unbindUI();_$modal_container=null;_ladda=null;_deferred=null}})();(function(){"use strict";TS.registerModule("ui.filter_select",{onStart:function(){$("select[data-filter-select], label[data-filter-select] select").addClass("hidden").filterSelect()},make:function($select,settings){if($select.prop("tagName")==="SELECT"){if(typeof settings.single==="undefined"){settings.single=!$select.prop("multiple")}}var instance=$.extend({},_DEFAULT_SETTINGS,settings);var $container=$('<div class="filter_select">');if(instance.classes){$container.addClass(instance.classes)}if(instance.default_style){$container.addClass("default_style")}if(instance.single){$container.addClass("single")}if($select.prop("disabled"))instance.disabled=true;if(instance.disabled)$container.addClass("disabled");$container.html(TS.templates.filter_select_container({instance:instance}));if(instance.append){$container.appendTo($select)}else{$container.insertAfter($select)}instance.$container=$container;instance.$input_container=$container.find(".fsl_input_container");instance.$list_container=$container.children(".fsl_list_container");instance.$scroller=$container.find(".fsl_scroller");instance.$list=$container.find(".fsl_list");instance.$input=$container.find(".fsl_input");instance.$value=$container.find(".fsl_value");instance.$select=$select;instance.update=function(data){instance.data=data||_processSelect($select);instance._selected=[];_processIndices(instance);_processPreselected(instance);if(instance.$input.val().length){var query=instance.$input.val();instance._previous_val="";_runQuery(instance,query)}else{_populate(instance)}};instance.update(instance.data);_bindUI(instance);if(instance.always_visible)_showList(instance);if(instance.restrict_input_container_height){instance.$container.addClass("has_restricted_input_container_height");instance.$input_container.monkeyScroll()}return instance},getValue:function(instance){return instance._selected}});var _DEFAULT_SETTINGS={template:function(item){var text=item.toString();var addl_text;if(item instanceof jQuery||item instanceof HTMLElement){text=$(item).text();addl_text=TS.utility.htmlEntities($(item).attr("data-additional-search-field"))}text=TS.utility.htmlEntities(text);if(addl_text){text+=' <span class="addl_text">'+addl_text+"</span>"}return new Handlebars.SafeString(text)},filter:function(item,query){var text=item.toString();query=query.toLowerCase();if(item instanceof jQuery||item instanceof HTMLElement){text=$(item).text();var addl_text=$(item).attr("data-additional-search-field");if(addl_text&&addl_text.toLowerCase().indexOf(query)!==-1)return true}return text.toLowerCase().indexOf(query)!==-1},paginateTemplate:function(page,num_pages,per_page){return TS.templates.filter_select_pagination({page:page,num_pages:num_pages,per_page:per_page})},noResultsTemplate:function(query){return"No items matched <strong>"+TS.utility.htmlEntities(query)+"</strong>"},disabled:false,default_style:true,paginate:true,per_page:300,append:false,placeholder_text:"Type to filter",single:false,monkey_scroll:true,set_height:true,always_visible:false,tab_to_nav:false,restrict_input_container_height:false,onItemAdded:function(item){},onItemRemoved:function(item){},onKeyDown:function(e,handled){},_$active:null,_list_visible:false,_prevent_blur:false,_dimensions_set:false,_previous_val:"",_page:1,_num_pages:1,_current_data:null};var _mouse={};var _populate=function(instance,data){if(!data)data=instance.data;if(data.length===0){instance.$list_container.addClass("empty");instance.$list.empty();if(instance.$pagination)instance.$pagination.remove();instance.$list.html(instance.noResultsTemplate(instance.$input.val()));instance._$active=null;_updateMonkeyScroll(instance);return}instance.$list_container.removeClass("empty");instance._current_data=data;var start=(instance._page-1)*instance.per_page;instance._num_pages=Math.max(1,Math.ceil(data.length/instance.per_page));data=data.slice(start,start+instance.per_page);var builder="";var marked_active_item=[false];for(var i=0;i<data.length;i++){var item=data[i];var index;if(item.fsl_group){builder+=_buildGroup(item);for(var g=0;g<item.children.length;g++){var subitem=item.children[g];index=subitem.fsl_index.join(",");builder+=_buildItem(instance,subitem,marked_active_item,index,true)}}else{index=item.fsl_index.join(",");builder+=_buildItem(instance,item,marked_active_item,index,false)}}if(instance.$list)instance.$list.empty();if(instance.$pagination)instance.$pagination.remove();instance.$list.html(builder);var $pagination=instance.$pagination=$(instance.paginateTemplate(instance._page,instance._num_pages,instance.per_page));instance.$scroller.append($pagination);if(instance._previous_val!==""){instance._$active=instance.$list.find(".fsl_item.active")}else{instance._$active=null}_updateMonkeyScroll(instance);instance.$scroller.scrollTop(0)};var _buildItem=function(instance,item,marked_active_item,index,in_group,token){var selected=item.fsl_selected;var disabled=item.disabled||item.fsl_disabled;var active=instance._previous_val!==""&&!marked_active_item[0]&&!selected&&!disabled;if(active)marked_active_item[0]=true;var inner_content;if(token&&$.isFunction(instance.tokenTemplate)){inner_content=instance.tokenTemplate(item)}else{inner_content=instance.template(item)}var item_class="";if($(item).data("fsl-item-class")){item_class=$(item).data("fsl-item-class")}return TS.templates.filter_select_item({content:inner_content,active:active,selected:selected,disabled:disabled,index:index,in_group:in_group,token:token,item_class:item_class})};var _buildGroup=function(group){var label=TS.utility.htmlEntities(group.label);return'<div class="fsl_group">'+label+"</div>"};var _updateMonkeyScroll=function(instance){if(instance.restrict_input_container_height&&instance.$input_container.data("monkeyScroll")){instance.$input_container.data("monkeyScroll").updateFunc()}if(instance.monkey_scroll&&instance.$scroller.data("monkeyScroll")){_computeHeight(instance);instance.$scroller.data("monkeyScroll").updateFunc()}};var _processIndices=function(instance){var data=instance.data;for(var i=0;i<data.length;i++){var item=data[i];if(item.fsl_group){for(var g=0;g<item.children.length;g++){var index=[i,g];item.children[g].fsl_index=index}}else{item.fsl_index=[i]}}};var _processPreselected=function(instance){var builder="";var data=instance.data;var token=!instance.single;for(var i=0;i<data.length;i++){var item=data[i];var index;if(item.fsl_group){for(var g=0;g<item.children.length;g++){var subitem=item.children[g];if(!(subitem.preselected||subitem.selected))continue;subitem.fsl_selected=true;instance._selected.push(subitem);index=subitem.fsl_index.join(",");builder+=_buildItem(instance,subitem,false,index,true,token);if(instance.single)break}}else{if(!(item.preselected||item.selected))continue;item.fsl_selected=true;instance._selected.push(item);index=item.fsl_index.join(",");builder+=_buildItem(instance,item,false,index,false,token);if(instance.single)break}}if(builder.length>0){instance.$container.addClass("value");if(instance.single){instance.$value.html(builder)}else{$(builder).insertBefore(instance.$input);instance.$input_container.removeClass("empty");instance.$input.prop("placeholder","")}}};var _processSelect=function($select){var $children=$select.children("option, optgroup");var data=[];$children.each(function(){if($(this).prop("tagName")==="OPTGROUP"){var children=$(this).children("option");if($(this).prop("disabled")){children=children.map(function(){this.fsl_disabled=true;return this})}data.push({fsl_group:true,label:$(this).prop("label"),children:children})}else{data.push(this)}});return data};var _select=function(instance,direction){if(instance.disabled)return;if(!instance._list_visible){_showList(instance);return}var $to_select;if(!instance._$active){$to_select=instance.$list.find(".fsl_item:not(.selected, .disabled)").first()}else{$to_select=instance._$active[direction](".fsl_item:not(.selected, .disabled)").first()}if($to_select.length){$to_select.scrollintoview({duration:0});if(instance._$active)instance._$active.removeClass("active");$to_select.addClass("active");instance._$active=$to_select}};var _selectDown=function(instance){return _select(instance,"nextAll")};var _selectUp=function(instance){return _select(instance,"prevAll")};var _addSelected=function(instance,select_next){if(instance.disabled)return;var $active=instance._$active;if(!$active.length)return;if(!_selectable($active))return;if(instance.single&&instance._selected.length){instance._selected[0].fsl_selected=false;instance._selected.length=0;instance.$value.empty();instance.$list.find(".selected").removeClass("selected")}var data_item=_getData(instance,$active);data_item.fsl_selected=true;instance._selected.push(data_item);_updateVal(instance);$active.addClass("selected");$active.removeClass("active");instance._$active=null;var $token;if($.isFunction(instance.tokenTemplate)){var token_html=TS.templates.filter_select_item({content:instance.tokenTemplate(data_item),index:$active.attr("data-index"),token:true});$token=$(token_html)}else{$token=$active.clone()}if($.isFunction(instance.tokenClass)){$token.addClass(instance.tokenClass(data_item))}if(instance.single){$token.appendTo(instance.$value)}else{$token.addClass("fsl_token");$token.insertBefore(instance.$input)}if(!instance.single){instance.$input_container.removeClass("empty");instance.$input.prop("placeholder","")}instance.$container.addClass("value");if(select_next)_selectDown(instance);instance.onItemAdded(data_item);instance.$input.focus()};var _removeSelected=function(instance,$token){if(instance.disabled)return;var data_item=_getData(instance,$token);data_item.fsl_selected=false;instance._selected=instance._selected.filter(function(item){if(item!==data_item)return true});_updateVal(instance);var $list_item=instance.$list.find('[data-index="'+$token.attr("data-index")+'"]');$list_item.removeClass("selected");if(instance.$input.val().length+instance._selected.length===0){instance.$input_container.addClass("empty");instance.$input.prop("placeholder",instance.placeholder_text)}$token.remove();if(instance._selected.length===0)instance.$container.removeClass("value");
instance.onItemRemoved(data_item)};var _removeLastSelected=function(instance){var $token=instance.$input_container.find(".fsl_token").last();if($token.length)_removeSelected(instance,$token)};var _updateVal=function(instance){if(instance.append)return;var values=instance._selected.map(function(item){if(item instanceof HTMLOptionElement){return $(item).val()}});instance.$select.val(values).trigger("change")};var _selectable=function($item){return!($item.hasClass("selected")||$item.hasClass("disabled"))};var _getData=function(instance,$item){var index=$item.attr("data-index").split(",").map(function(i){return parseInt(i,10)});var data=instance.data;switch(index.length){case 1:return data[index[0]];case 2:return data[index[0]].children[index[1]]}return null};var _hideList=function(instance,force){if(!force&&(!instance._list_visible||instance.always_visible||instance.disabled))return;instance._list_visible=false;instance.$list_container.removeClass("visible");instance.$container.removeClass("list_visible");instance.$input_container.removeClass("active")};var _showList=function(instance,keep_value){if(instance.disabled)return;setTimeout(function(){instance.$input.focus()},0);if(instance._list_visible)return;instance._list_visible=true;instance.$list_container.addClass("visible");instance.$container.addClass("list_visible");instance.$input_container.addClass("active");if(instance.single&&!keep_value){instance.$input.val("");instance._previous_val="";instance.$input.focus();_populate(instance)}if(!instance._dimensions_set&&instance.set_height){_computeHeight(instance);if(instance.monkey_scroll)instance.$scroller.monkeyScroll();instance._dimensions_set=true}};var _computeHeight=function(instance){var list_height=instance.$list.height();var container_height=instance.$list_container.height();var padding=instance.$list_container.outerHeight()-container_height;var max_height=parseInt(instance.$list_container.css("max-height"),10);if(isNaN(max_height))max_height=container_height;max_height=max_height-padding;instance.$scroller.css({"max-height":Math.min(list_height,max_height)})};var _filterGroup=function(instance,query){var data=instance.data;var filtered=[];for(var i=0;i<data.length;i++){var item=data[i];if(item.fsl_group){var filtered_children=[];for(var j=0;j<item.children.length;j++){var subitem=item.children[j];if(instance.filter(subitem,query)){filtered_children.push(subitem)}}if(filtered_children.length>0){filtered.push({fsl_group:true,label:item.label,children:filtered_children})}}else{if(instance.filter(item,query)){filtered.push(item)}}}return filtered};var _disable=function(instance){if(instance.disabled)return;instance.disabled=true;instance.$container.addClass("disabled")};var _enable=function(instance){if(!instance.disabled)return;instance.disabled=false;instance.$container.removeClass("disabled")};var _runQuery=function(instance,query,keep_value){if(instance.disabled)return;if(query==instance._previous_val)return;instance._previous_val=query;_showList(instance,keep_value);var filtered=_filterGroup(instance,query);instance._page=1;_populate(instance,filtered);if(!instance.single){instance.$input.prop("size",instance.$input.val().length+1);if(instance.$input.val().length+instance._selected.length===0){instance.$input_container.addClass("empty");instance.$input.prop("placeholder",instance.placeholder_text)}else{instance.$input_container.removeClass("empty");instance.$input.prop("placeholder","")}}};var _bindUI=function(instance){instance.$input.on("input",function(){var query=$(this).val();_runQuery(instance,query,true)});instance.$input.on("keydown",function(e){if(instance.disabled)return;switch(e.keyCode){case TS.utility.keymap.down:e.stopPropagation();e.preventDefault();_selectDown(instance);break;case TS.utility.keymap.up:e.stopPropagation();e.preventDefault();_selectUp(instance);break;case TS.utility.keymap.enter:if(instance._$active&&instance._$active.length&&instance._list_visible){e.stopPropagation();e.preventDefault();_addSelected(instance,false);if($(this).val()!==""){$(this).val("");instance._previous_val="";_populate(instance)}_hideList(instance)}break;case TS.utility.keymap.del:if($(this).val()===""){e.stopPropagation();e.preventDefault();_removeLastSelected(instance)}break;case TS.utility.keymap.tab:if(instance.tab_to_nav){e.stopPropagation();e.preventDefault();if(e.shiftKey){_selectUp(instance)}else{_selectDown(instance)}}break;case TS.utility.keymap.esc:e.stopPropagation();e.preventDefault();_hideList(instance);instance.$input.blur();break}instance.onKeyDown(e,e.isDefaultPrevented())});instance.$input.on("blur",function(){if(!instance._prevent_blur){_hideList(instance)}});instance.$value.on("click",function(e){if(instance.disabled)return;e.stopPropagation();_showList(instance);instance._prevent_blur=false});instance.$value.on("mousedown",function(e){if(e.which===1)instance._prevent_blur=true});instance.$list_container.on("mousemove",".fsl_item",function(e){if(instance.disabled)return;if(e.clientX==_mouse.lastX&&e.clientY==_mouse.lastY)return;if(instance._$active)instance._$active.removeClass("active");if(!$(this).hasClass("active")&&_selectable($(this))){$(this).addClass("active");instance._$active=$(this)}_mouse.lastX=e.clientX;_mouse.lastY=e.clientY});instance.$list_container.on("mouseleave",".fsl_item.active",function(e){$(this).removeClass("active");instance._$active=null});instance.$list_container.on("click",".fsl_item",function(e){if(instance.disabled)return;e.preventDefault();if(!_selectable($(this))){return}instance._$active=$(this);_addSelected(instance);if(instance.$input.val()!==""){instance.$input.val("");instance._previous_val="";_populate(instance)}if(instance.single){_hideList(instance);e.stopPropagation()}instance._prevent_blur=false});instance.$list_container.on("mousedown",function(e){if(e.which===1)instance._prevent_blur=true});instance.$input_container.on("focus",function(){instance.$input_container.click();instance.$input.focus()});instance.$input_container.on("click",".fsl_token",function(e){if(instance.disabled)return;_removeSelected(instance,$(this));instance._prevent_blur=false});instance.$input_container.on("mousedown",".fsl_token",function(e){if(e.which===1)instance._prevent_blur=true});instance.$container.on("mouseleave",function(e){instance._prevent_blur=false});instance.$container.on("click",function(e){if(instance.disabled)return;_showList(instance)});instance.$list_container.on("click",".fsl_paginate_back",function(e){if(instance._page>1){instance._page--;_populate(instance,instance._current_data);instance.$input.focus()}});instance.$list_container.on("click",".fsl_paginate_forward",function(e){if(instance._page<instance._num_pages){instance._page++;_populate(instance,instance._current_data);instance.$input.focus()}});instance.$container.parents("label").on("click",function(e){if(instance.disabled)return;e.preventDefault();_showList(instance)})};$.widget("TS.filterSelect",{_create:function(){this.instance=TS.ui.filter_select.make(this.element,this.options)},_destroy:function(){this.instance.$container.remove();delete this.instance},value:function(){return this.instance._selected},setValue:function(val){var prev_selected_index=this.element[0].selectedIndex;while(this.instance.$input_container.find(".fsl_token").length>0){_removeLastSelected(this.instance)}this.element.val(val);if(this.element[0].selectedIndex<0){this.element[0].selectedIndex=0}var selected_option=this.element[0].options[this.element[0].selectedIndex];if(this.element[0].selectedIndex==prev_selected_index){return}var data_index=selected_option.fsl_index;this.instance.$container.find('.fsl_item[data-index="'+data_index+'"]').trigger("click")},clearValue:function(){while(this.instance.$input_container.find(".fsl_token").length>0){_removeLastSelected(this.instance)}},getInstance:function(){return this.instance},container:function(){return this.instance.$container},recomputeHeight:function(){_updateMonkeyScroll(this.instance)},showList:function(){_showList(this.instance)},hideList:function(){_hideList(this.instance,true)},update:function(data){this.instance.update(data)},disable:function(){_disable(this.instance)},enable:function(){_enable(this.instance)},disabled:function(){return this.instance.disabled}})})();(function(){"use strict";TS.registerModule("ui.people_picker",{onStart:function(){},make:function($el,options){options=options||{};var prev_query;var start_regex;var suffix_regex;if(!options.append)$el.addClass("hidden");$el.filterSelect({append:!!options.append,data:_makeMembersWithPreselectsForTemplate(options.members||TS.members.getActiveMembersWithSlackbotAndNotSelf(),options.preselected_ids||[]),per_page:50,placeholder_text:"Search by name",classes:options.classes||"normal_style",single:!!options.single,template:function(item){var html=TS.templates.member_small({member:item.member});return new Handlebars.SafeString(html)},tokenTemplate:function(item){var html=TS.templates.member_token({member:item.member});return new Handlebars.SafeString(html)},tokenClass:function(item){return TS.templates.builders.getMemberTypeClass(item.member)},filter:function(item,query){var member=item.member;if(prev_query!==query){start_regex=new RegExp("^"+TS.utility.regexpEscape(query),"i");suffix_regex=new RegExp("(-|_|\\+|\\s|\\.|@)"+TS.utility.regexpEscape(query),"i");prev_query=query}var match_names_only=true;return TS.members.checkMemberMatch(member,start_regex,match_names_only)||TS.members.checkMemberMatch(member,suffix_regex,match_names_only)},noResultsTemplate:function(query){if(!query){return"No one found"}else{return"No one found matching <strong>"+TS.utility.htmlEntities(query)+"</strong>"}}})},value:function($el){return $el.filterSelect("value")}});var _makeMembersWithPreselectsForTemplate=function(members,preselected_ids){return members&&members.map(function(member){return{member:member,preselected:preselected_ids.indexOf(member.id)!==-1}})}})();(function(){"use strict";TS.registerModule("ui.utility",{onStart:$.noop,preventElementFromScrolling:function($el,callback){if(!$el.length){callback();return}var initial_offset=$el.offset();callback();var now_top=$el.offset().top;var dist_moved=now_top-initial_offset.top;var $scroller=$el.closest(".monkey_scroller");if(!$scroller.length){$scroller=$el.closest(":scrollable(vertical)")}if($scroller.is("html"))$scroller=$("body");if(0!==dist_moved){var scroll_top=$scroller.scrollTop()+dist_moved;$scroller.scrollTop(Math.round(scroll_top))}if(TS.client)TS.client.ui.updateClosestMonkeyScroller($el)}})})();(function(){"use strict";TS.registerModule("dnd",{dnd_statuses_changed_sig:new signals.Signal,current_user_dnd_status_changed_sig:new signals.Signal,onStart:function(){if(!TS.client)return;TS.ms.connected_sig.add(_onConnected);TS.ms.disconnected_sig.add(_onDisconnected);var team_delay=TS.utility.randomInt(_TEAM_INFO_DELAY_MIN,_TEAM_INFO_DELAY_MAX);var single_user_delay=Math.round(team_delay*_SINGLE_USER_INFO_DELAY_SCALE);TS.dnd.setApiDelays(team_delay,single_user_delay);TS.members.joined_team_sig.add(_memberJoinedTeam);TS.members.changed_deleted_sig.add(_memberDeletedChanged);TS.dnd.debouncedCheckForChanges=TS.utility.throttleFunc(TS.dnd.checkForChanges,500,true)},memberDndStatus:function(){var in_dnd=TS.dnd.isMemberInDnd(TS.model.user);var snoozing=in_dnd&&TS.model.dnd.snooze_enabled;var end_time_ts=_endTime(TS.model.user);var readable_end_time;if(end_time_ts&&snoozing){readable_end_time=_snoozeReadableCountdown(end_time_ts)}else if(end_time_ts){readable_end_time=TS.utility.date.toTime(end_time_ts,true);if(!TS.utility.date.do24hrTime()){readable_end_time=readable_end_time.split(":00").join("")}}return{in_dnd:in_dnd,snoozed:snoozing,ends:end_time_ts,readable_end_time:readable_end_time}},setSnooze:function(num_minutes){return TS.api.call("dnd.setSnooze",{num_minutes:num_minutes},function(ok,data,args){if(!ok){TS.warn("dnd.setSnooze failed");return}_log("dnd.setSnooze to "+num_minutes+" minutes. New end time is "+_readableTs(data.snooze_endtime))})},endSnooze:function(){return TS.api.call("dnd.endSnooze",{},function(ok,data,args){if(!ok){TS.warn("dnd.endSnooze failed");return}_log("dnd.endSnooze succeeded")})},endDnd:function(){return TS.api.call("dnd.endDnd",{},function(ok,data,args){if(!ok){TS.warn("dnd.endDnd failed");return}_log("dnd.endDnd succeeded")})},isMemberInDnd:function(member,now){var is_in_dnd;if(!now)now=_now();var start=_startTime(member);var end=_endTime(member);if(member.is_self&&TS.model.dnd.snooze_enabled&&end){if(end>now)return true}if(null==start||null==end)return false;is_in_dnd=end>now&&(start<=now||start>end);return is_in_dnd},checkForChanges:function(){if(!TS.model.ms_connected)return;var self_changed=false;var all_members=TS.members.getMembersForUser();var now=_now();if(TS.model.dnd.snooze_enabled){if(now>=TS.model.dnd.snooze_endtime){TS.model.dnd.snooze_enabled=false;self_changed=true}}var members_with_stale_times=[];var members_with_updates=all_members.filter(function(member){if(member.deleted)return;var was_in_dnd=member._is_in_dnd||false;var is_in_dnd=TS.dnd.isMemberInDnd(member,now);var changed=false;if(was_in_dnd!=is_in_dnd){member._is_in_dnd=is_in_dnd;if(member.is_self)self_changed=true;changed=true}if(_memberHasStaleTimes(member,now)){members_with_stale_times.push(member)}return changed});if(self_changed&&!_.includes(members_with_updates,TS.model.user))members_with_updates.push(TS.model.user);if(members_with_updates.length>0)_log("Processing DND status changes for "+members_with_updates.length+" members");TS.dnd.dnd_statuses_changed_sig.dispatch(members_with_updates);if(self_changed)TS.dnd.current_user_dnd_status_changed_sig.dispatch();TS.dnd.kickOffNextEventTimer();return members_with_stale_times},debouncedCheckForChanges:function(){},kickOffNextEventTimer:function(){clearTimeout(_next_event_timer);var now=_now();var next_ts=_calcNextCheckTime(now);_log("next DND tick scheduled for "+_readableTs(next_ts));var in_ms=(next_ts-now)*1e3;_next_timer_time=next_ts;_next_event_timer=setTimeout(function(){var members_needing_new_data=TS.dnd.checkForChanges();var force_full_team=false;if(_team_info_first_boot_fail_time){if(_now()-_team_info_first_boot_fail_time>15*60)force_full_team=true}if(force_full_team||members_needing_new_data.length>_INDIVIDUAL_UPDATE_LIMIT){TS.dnd.fetchFullTeam()}else if(members_needing_new_data.length>1){TS.dnd.fetchMultipleMembers(members_needing_new_data)}else if(members_needing_new_data.length===1){TS.dnd.refreshMember(members_needing_new_data[0])}},in_ms)},fetchFullTeam:function(first_boot){var promise=_fetchTeamInfo(first_boot);if(promise)return promise.finally(TS.dnd.checkForChanges)},fetchMultipleMembers:function(members){var promise=_fetchUsersInfo(members);if(promise)return promise.finally(TS.dnd.checkForChanges)},refreshMember:function(member){var promise=_fetchUserInfo(member);if(promise)return promise.finally(TS.dnd.checkForChanges)},updateUserPropsAndSignal:function(user_id,props){_updateUserDndProps(user_id,props);if(user_id===TS.model.user.id){TS.dnd.checkForChanges()}else{TS.dnd.debouncedCheckForChanges()}},dndOverride:function(c_id,ts){var channel=TS.shared.getModelObById(c_id);if(!channel)return;var msg=TS.utility.msgs.getMsg(ts,channel.msgs);if(!msg)return;if(msg._ignore_dnd)return;msg._ignore_dnd=true;if(channel.is_im){TS.ui.growls.growlImMessage(channel,msg)}else{TS.ui.growls.growlchannelOrGroupMessage(channel,msg)}},debugInfo:function(){var logging=["DND debug info:"];logging.push("next timer fires at "+_readableTs(_next_timer_time));logging.push("_team_info_delay: "+_team_info_delay);logging.push("_single_user_info_delay: "+_single_user_info_delay);logging.push("_calcNextCheckTime: "+_readableTs(_calcNextCheckTime()));var output="\n"+logging.join("\n");TS.info(output)},debugMember:function(member){var logging=["DND member debugging:"];logging.push("is in DND: "+!!member._is_in_dnd+" ("+TS.dnd.isMemberInDnd(member)+")");logging.push("start: "+_readableTs(_startTime(member),true));logging.push("end  : "+_readableTs(_endTime(member),true));logging.push("next : "+_readableTs(_nextTime(member),true));logging.push("stale? "+_memberHasStaleTimes(member));var end=_endTime(member);if(end&&_timeWasProbablyASnooze(end)){logging.push("Probably a snooze")}else if(end){logging.push("Probably a scheduled DND")}var output="\n"+logging.join("\n");TS.info(output)},setApiDelays:function(team_delay,single_user_delay){_team_info_delay=team_delay;_single_user_info_delay=single_user_delay},test:function(){return{fetchUsersInfo:_fetchUsersInfo,calcNextCheckTime:_calcNextCheckTime,snoozeReadableCountdown:_snoozeReadableCountdown,updateUserDndProps:_updateUserDndProps,timeWasProbablyASnooze:_timeWasProbablyASnooze,memberHasStaleTimes:_memberHasStaleTimes}}});var _MIN_TIMER_DELAY=15;var _MAX_TIMER_DELAY=5*60;var _INDIVIDUAL_UPDATE_LIMIT=100;var _TEAM_INFO_DELAY_MAX=1500;var _TEAM_INFO_DELAY_MIN=10;var _SINGLE_USER_INFO_DELAY_SCALE=.01;var _team_info_delay=_TEAM_INFO_DELAY_MAX;var _single_user_info_delay=_TEAM_INFO_DELAY_MIN;var _next_event_timer;var _next_timer_time;var _team_info_first_boot_fail_time=null;var _onConnected=function(was_fast_reconnect){if(!was_fast_reconnect){var first_boot=true;setTimeout(function(){TS.dnd.fetchFullTeam(first_boot)},TS.utility.randomInt(100,1e4))}TS.dnd.checkForChanges()};var _onDisconnected=function(){clearTimeout(_next_event_timer)};var _memberJoinedTeam=function(member){TS.dnd.refreshMember(member)};var _memberDeletedChanged=function(member){if(!member.deleted)TS.dnd.refreshMember(member)};var _calcNextCheckTime=function(now){var next_ts;if(!now)now=_now();var next_self=_nextTime(TS.model.user,now);if(next_self)next_ts=next_self;var next_member;var next_member_time;for(var uid in TS.model.dnd.team){if(uid==TS.model.user.id)continue;next_member=TS.members.getMemberById(uid);if(!next_member)continue;next_member_time=_nextTime(next_member,now);if(!next_member_time)continue;if(!next_ts||next_member_time<next_ts)next_ts=next_member_time}var max_delay=_MAX_TIMER_DELAY+now;if(!next_ts||next_ts>max_delay)next_ts=max_delay;var min_delay=_MIN_TIMER_DELAY+now;if(next_ts<min_delay)next_ts=min_delay;return next_ts};var _updateUserDndProps=function(user_id,props,team_props){if(!team_props)team_props=TS.model.dnd.team;if(user_id===TS.model.user.id){if(props.dnd_enabled){TS.model.dnd.next_dnd_start_ts=props.next_dnd_start_ts;TS.model.dnd.next_dnd_end_ts=props.next_dnd_end_ts}else{TS.model.dnd.next_dnd_start_ts=null;TS.model.dnd.next_dnd_end_ts=null}if("snooze_enabled"in props)TS.model.dnd.snooze_enabled=props.snooze_enabled;if("snooze_endtime"in props)TS.model.dnd.snooze_endtime=props.snooze_endtime}if(props.dnd_enabled){team_props[user_id]={next_dnd_start_ts:props.next_dnd_start_ts,next_dnd_end_ts:props.next_dnd_end_ts}}else{team_props[user_id]={next_dnd_start_ts:null,next_dnd_end_ts:null}}};var _team_fetch_in_progress=false;var _fetchTeamInfo=function(first_boot){if(_team_fetch_in_progress)return;_team_fetch_in_progress=true;var args={team:TS.model.team.id};if(first_boot)args.first_boot=true;return TS.api.call("dnd.teamInfo",args,function(ok,data){_team_fetch_in_progress=false;if(!ok){if(first_boot)_team_info_first_boot_fail_time=_now();TS.warn("dnd.teamInfo failed");return}_team_info_first_boot_fail_time=null;var team_data={};if(data.users){_.forOwn(data.users,function(props,user_id){_updateUserDndProps(user_id,props,team_data)});TS.model.dnd.team=team_data}},true)};var _team_multi_fetch_in_progress=false;var _fetchUsersInfo=function(members){if(_team_multi_fetch_in_progress)return;_team_multi_fetch_in_progress=true;var member_ids=_.pluck(members,"id").join(",");return TS.api.call("dnd.teamInfo",{users:member_ids},function(ok,data,args){_team_multi_fetch_in_progress=false;if(!ok){TS.warn("dnd.teamInfo failed for a multi-user request");return}if(data.users){_.forOwn(data.users,function(props,user_id){_updateUserDndProps(user_id,props)})}},true)};var _current_single_user_requests={};var _fetchUserInfo=function(member){if(_current_single_user_requests[member.id])return;_current_single_user_requests[member.id]=true;return new Promise(function(resolve,reject){setTimeout(function(){TS.api.call("dnd.info",{user:member.id},function(ok,data,args){delete _current_single_user_requests[member.id];if(!ok){TS.warn("dnd.info failed for "+member.id);reject(new Error("dnd.info failed for "+member.id));return}var user_id=member.id;var props=data;_updateUserDndProps(user_id,props);resolve()},true)},_single_user_info_delay*1e3)})};var _startTime=function(member){if(member.is_self)return TS.model.dnd.next_dnd_start_ts;var times=TS.model.dnd.team[member.id];if(!times)return null;return times.next_dnd_start_ts};var _endTime=function(member){if(member.is_self){if(TS.model.dnd.snooze_enabled)return TS.model.dnd.snooze_endtime;return TS.model.dnd.next_dnd_end_ts}var times=TS.model.dnd.team[member.id];if(!times)return null;return times.next_dnd_end_ts};var _nextTime=function(member,now){if(!now)now=_now();var start=_startTime(member);var end=_endTime(member);if(start&&end){if(start>now&&start<end)return start}if(end){if(end>now)return end;var delayed_fetch=end+_team_info_delay;if(delayed_fetch>=now)return delayed_fetch}return null};var _now=function(){return Math.floor(Date.now()/1e3)};var _snoozeReadableCountdown=function(end_time_ts){var remaining=end_time_ts-_now();if(remaining<0)return"0s";var hours,minutes;hours=remaining/3600;if(hours>=1){hours=Math.floor(hours);minutes=(remaining-hours*3600)/60;minutes=Math.round(minutes);if(minutes===60)return hours+1+"h";if(minutes===0)return hours+"h";return hours+"h"+" "+minutes+"m"}minutes=remaining/60;if(minutes>=1){minutes=Math.round(minutes);if(minutes===60)return"1h";return minutes+"m"}return remaining+"s"};var _memberHasStaleTimes=function(member,now){if(!now)now=_now();var end=_endTime(member);if(!end||end>now)return false;var delta=now-end;if(_timeWasProbablyASnooze(end)){return true}else{return delta>=_team_info_delay}};var _timeWasProbablyASnooze=function(end_ts){var d=new Date(end_ts*1e3);var seconds=d.getSeconds();var minutes=d.getMinutes();var probably_scheduled=seconds===0&&(minutes===0||minutes===30);return!probably_scheduled};var _log=function(s){TS.log(2002,s)};var _readableTs=function(ts,include_date){if(!ts)return"<null>";var d=new Date(ts*1e3);if(include_date)return d.toTimeString()+" ("+d.toDateString()+")";return d.toTimeString()}})();(function(){"use strict";TS.registerModule("ui.inline_saver",{onStart:function(){},show:function(settings){if(!settings||!settings.target){TS.warn("TS.ui.inline_saver called without valid settings.");return}var $el=$(settings.target);if(!$el.length){TS.warn("TS.ui.inline_saver called without a valid target.");return}var $inline_saver=$(TS.templates.inline_saver({target:settings.target}));var $existing_saver=$('ts-inline-saver[data-target="'+settings.target+'"]');if($existing_saver.length){$existing_saver.replaceWith($inline_saver)}else{$inline_saver.insertAfter($el)}setTimeout(function(){$inline_saver.removeClass("saving").addClass("saved");setTimeout(function(){$inline_saver.remove()},_fade_duration)},_spin_duration)}});var _spin_duration=500;var _fade_duration=1500})();(function(){"use strict";TS.registerModule("ui.messages",{onStart:function(){TS.pins.pinned_status_changed_sig.add(function(){_updateMsgActions()});var $body=$("body");$body.on("click.msg_action","ts-message",function(e){if(TS.client&&TS.client.ui.checkForEditing(e))return;_msgActionHandler(e)});if(TS.replies){var timer_delay=150;$body.on("mousedown.maybe_select_message",'ts-message[data-selectable="true"]',function(e){if(TS.client&&TS.client.ui.checkForEditing(e))return;if(TS.model.menu_is_showing||TS.emoji_menu.is_showing)return;if(TS.utility.isAnyTextSelected())return;var click_timer;$body.on("mouseup.select_message",'ts-message[data-selectable="true"]',function(e2){if(TS.utility.isAnyTextSelected())return;click_timer=setTimeout(function(){if(TS.utility.isAnyTextSelected())return;if(_isValidClick(e,e2))_msgSelectHandler(e);$body.off("mouseup.select_message mousedown.second_click dblclick.select_text",'ts-message[data-selectable="true"]')},timer_delay)}).on("dblclick.select_text",'ts-message[data-selectable="true"]',function(e){clearTimeout(click_timer);$body.off("dblclick.select_text",'ts-message[data-selectable="true"]')})}).on("keydown.esc_deselect_messages",function(e){if(e.which!=TS.utility.keymap.esc)return;if(TS.menu.isRedundantClick(e))return;if(TS.client&&TS.client.ui.checkForEditing(e))return;if(TS.model.menu_is_showing)return;if(TS.emoji_menu.is_showing)return;if(TS.model.dialog_is_showing)return;TS.ui.messages.deselectAll()})}},selectMsgEl:function($el,no_scroll,selecting_after_rebuild){var model_ob=TS.shared.getActiveModelOb();var msg_ts=$el.data("ts");var msg=TS.utility.msgs.getMsg(msg_ts,model_ob.msgs);var replies_enabled=TS.replies&&TS.replies.isEnabledForModelOb(model_ob)&&TS.client;if(!replies_enabled)return Promise.reject();if(!msg)msg=TS.utility.msgs.getMsg(msg_ts,model_ob._archive_msgs);if(!msg){TS.error("WTF no message to select?");return Promise.reject()}var thread_ts=msg.thread_ts||msg.ts;TS.ui.replies.openConversation(model_ob,thread_ts);return Promise.resolve()},deselectMsgEl:function($el,no_scroll){if(no_scroll){$el.removeClass("selected")}else{_scrollMsgBasedOnSelection($el)}$el.find(".message_actions, .message_reply").empty();if(TS.ui.replies){TS.ui.replies.closeConversation($el)}},getSelectedMessage:function(){var $selected_msg=$(".msgs_holder ts-message.selected");if(!$selected_msg.length&&TS.replies&&TS.replies.isEnabled()){return $("ts-conversation ts-message.selected")}return $selected_msg},deselectAll:function(){var $selected_msg=TS.ui.messages.getSelectedMessage();if($selected_msg.length)TS.ui.messages.deselectMsgEl($selected_msg)},updateMessageActions:function(model_ob,$msg_el,msg){var actions=TS.utility.msgs.getMsgActions(msg,model_ob);var allow_mark_unread=TS.client&&TS.utility.msgs.getMarkMsgForUnreadPoint(msg.ts,model_ob.msgs)&&!TS.model.archive_view_is_showing;actions.mark_unread=!!allow_mark_unread;var actions_html=TS.templates.message_actions({actions:actions,msg:msg,model_ob:model_ob,abs_permalink:TS.utility.msgs.constructAbsoluteMsgPermalink(model_ob,msg.ts),ts_tip_delay_class:"ts_tip_delay_600"});$msg_el.find(".message_actions").html(actions_html);if(TS.ui.replies&&$msg_el.is(".selected"))TS.ui.replies.updateMessageActions(model_ob,msg)}});var _isValidClick=function(mousedown_event,mouseup_event){var p1={x:mousedown_event.pageX,y:mousedown_event.pageY};var p2={x:mouseup_event.pageX,y:mouseup_event.pageY};var click_distance_threshold_px=4;var delta=Math.sqrt(Math.pow(p2.x-p1.x,2)+Math.pow(p2.y-p1.y,2));return delta<click_distance_threshold_px};var _msgActionHandler=function(e){var $el=$(e.target);var $action_el=$el.closest("[data-action]");if($action_el.length){var $msg_el=$el.closest("ts-message");var model_ob_id=$msg_el.data("model-ob-id");var model_ob=model_ob_id?TS.shared.getModelObById(model_ob_id):TS.shared.getActiveModelOb();var msg_ts=$msg_el.data("ts");var msg=TS.utility.msgs.getMsg(msg_ts,model_ob.msgs);var action=$action_el.data("action");var in_archives=false;if(!msg){msg=TS.utility.msgs.getMsg(msg_ts,model_ob._archive_msgs);if(msg)in_archives=true}if(!msg&&TS.replies){msg=TS.replies.getMessage(model_ob,msg_ts)}if(!msg){TS.error("WTF no message to click?");return}var rxn_key=TS.rxns.getRxnKeyByMsgType(msg);switch(action){case"actions_menu":if(in_archives){TS.menu.startWithMessageActions(e,$msg_el.data("ts"),model_ob._archive_msgs,model_ob)}else{TS.menu.startWithMessageActions(e,$msg_el.data("ts"),model_ob.msgs,model_ob)}break;case"reaction":TS.emoji_menu.startEmoForRxn(e,rxn_key);break;case"pin":TS.pins.startPinMessage(msg_ts,model_ob);break;case"unpin":TS.pins.unPinMessage(msg_ts,model_ob);break;case"edit":TS.msg_edit.startEdit(msg_ts,model_ob);break;case"delete":TS.msg_edit.startDelete(msg_ts,model_ob);break;case"mark_unread":TS.client.msg_pane.setUnreadPoint(msg_ts);break;case"reply":if($msg_el.length&&TS.replies&&TS.replies.canReplyToMsg(model_ob,msg)){TS.ui.messages.selectMsgEl($msg_el)}break;case"jump_to_original":TS.client.ui.tryToJump(model_ob.id,msg.ts);break;case"copy_link":TS.tips.updateFloater({title:"Copied!",classes_to_add:["success"]});TS.clipboard.writeText($action_el.data("permalink"));break;default:TS.error("WTF no action?");break}}};var _msgSelectHandler=function(e){var $el=$(e.target);var $msg_el=$el.closest("ts-message");var model_ob=TS.shared.getActiveModelOb();var msg_ts=$msg_el.data("ts");var msg=TS.utility.msgs.getMsg(msg_ts,model_ob.msgs);if(!msg)msg=TS.utility.msgs.getMsg(msg_ts,model_ob._archive_msgs);if(!TS.replies||!TS.replies.canReplyToMsg(model_ob,msg))return;if(!msg.thread_ts&&!msg.reply_count){return}if(!$msg_el.closest("#flex_contents").length){return}if(!msg&&TS.replies){msg=TS.replies.getMessage(model_ob.id,msg_ts)}if(!msg){TS.error("WTF no message to click?");return}var selectors_to_ignore=["a",".star",".emoji_rxn",".delete_attachment_link",".inline_message_input_container",".msg_inline_img_expander",".msg_inline_img_collapser",".msg_inline_email_expander",".msg_inline_email_collapser",".msg_inline_video_expander",".msg_inline_video_collapser",".msg_inline_other_expander",".msg_inline_other_collapser",".msg_inline_audio_expander",".msg_inline_audio_collapser",".msg_inline_attachment_expander",".msg_inline_attachment_collapser",".msg_inline_file_preview_expander",".msg_inline_file_preview_collapser",".msg_inline_room_preview_expander",".msg_inline_room_preview_collapser",".msg_inline_holder",".preview_show_btn",".inline_collapsed"];if($el.closest(selectors_to_ignore.join(",")).length==1)return;var replies_enabled=TS.replies&&TS.replies.isEnabledForModelOb(model_ob);var is_in_conversation=replies_enabled&&$msg_el.is("#flex_contents .convo_container ts-message");if(is_in_conversation){}else if($msg_el.hasClass("selected")){TS.ui.messages.deselectMsgEl($msg_el)}else{var $existing_sel=TS.ui.messages.getSelectedMessage();if($existing_sel.length){TS.ui.messages.deselectMsgEl($existing_sel)}if(replies_enabled&&!e.altKey){TS.ui.messages.selectMsgEl($msg_el);return}if(replies_enabled&&(e.metaKey||e.ctrlKey)){TS.ui.messages.selectMsgEl($msg_el);return}}};var _scrollMsgBasedOnSelection=function($msg_el,no_scroll){var $msg_body_el=$msg_el.find(".message_body");if(!$msg_body_el.length)$msg_body_el=$msg_el.find(".comment");if(no_scroll||!$msg_body_el.length){$msg_el.toggleClass("selected");return}TS.ui.utility.preventElementFromScrolling($msg_body_el,function(){$msg_el.toggleClass("selected")})};var _updateMsgActions=function(msg_ts){var $msg_els;var model_ob=TS.shared.getActiveModelOb();var msg;if(msg_ts){$msg_els=$("#"+TS.templates.makeMsgDomId(msg_ts))}else{$msg_els=$(".msgs_holder").find("ts-message.selected")}if($msg_els.length===0)return;$msg_els.each(function(){var $msg_el=$(this);msg=TS.utility.msgs.getMsg($msg_el.data("ts"),model_ob.msgs);if(!msg)msg=TS.utility.msgs.getMsg(msg_ts,model_ob._archive_msgs);if(!msg){TS.error("WTF no message to update?");return}TS.ui.messages.updateMessageActions(model_ob,$msg_el,msg)})}})();(function(){"use strict";TS.registerModule("frecency",{onStart:function(){},construct:function(namespace,options){return _createFrecency(namespace,options)}});var _DAY=1e3*60*60*24;var _BUCKETS=[1e3*60*60*4,_DAY,_DAY*3,_DAY*7,_DAY*30,_DAY*90];var _WEIGHTS=[100,80,60,40,20,10];var _REDUCED_MULTIPLIER=.5;var _PRUNE_AFTER=_BUCKETS[_BUCKETS.length-1];var _PRUNE_BELOW_COUNT=100;function _createFrecency(namespace,options){if(_instances[namespace])return _instances[namespace];var _cache;_cache=TS.storage.fetchFrecency(namespace)||{};if(options&&options.onStart)_cache=options.onStart(namespace);function _query(list,text,bonusPoints){var keys=Object.keys(_cache);if(!bonusPoints)bonusPoints=function(){return 0};var hits={};_.each(keys,function(key){if(key.indexOf(text)>-1||text.indexOf(key)>-1){if(Array.isArray(_cache[key])){_.each(_cache[key],function(item){
if(hits[item.id]){var old_score=_calculateScore(hits[item.id]);var new_score=_calculateScore(item);if(new_score>old_score){hits[item.id]=item}}else{hits[item.id]=item}})}else{if(hits[_cache[key].id]){var old_score=_calculateScore(hits[_cache[key].id]);var new_score=_calculateScore(_cache[key]);if(new_score>old_score){hits[_cache[key].id]=_cache[key]}}else{hits[_cache[key].id]=_cache[key]}}}});var new_list=[];_.each(list,function(item,index){var extra_score=0;if(_cache[item.id]){extra_score=_calculateScore(_cache[item.id])}extra_score+=bonusPoints(item,text);new_list.push({id:item.id,score:_calculateScore(hits[item.id])+extra_score,original_index:index})});new_list.sort(function(a,b){if(a.score===b.score)return a.original_index-b.original_index;return b.score-a.score});return new_list}function _record(item,text){if(_cache[text]&&!Array.isArray(_cache[text])){if(_cache[text].id===item.id){_countVisit(_cache[text])}else{_cache[text]=[_cache[text],_createCacheRecord(item.id)]}}else if(Array.isArray(_cache[text])){var exists=false;for(var i=0;i<_cache[text].length;i++){if(_cache[text][i].id===item.id){_countVisit(_cache[text][i]);exists=true;break}}if(!exists){_cache[text].push(_createCacheRecord(item.id))}}else{_cache[text]={id:item.id,count:1,visits:[Date.now()]}}if(_cache[item.id]){_countVisit(_cache[item.id]);_cache[item.id]._reduced=true}else{_cache[item.id]=_createCacheRecord(item.id);_cache[item.id]._reduced=true}if(options&&options.recordFunc){options.recordFunc(_cache)}else{TS.storage.storeFrecency(namespace,_cache)}}function _countVisit(item){item.count++;if(item.visits.length===10)item.visits.shift();item.visits.push(Date.now())}function _createCacheRecord(id){return{id:id,count:1,visits:[Date.now()]}}function _getMostCommon(){var new_list=[];_.each(_cache,function(item){if(Array.isArray(item)){_.each(item,function(entry){new_list.push({id:entry.id,score:_calculateScore(entry)})})}else{new_list.push({id:item.id,score:_calculateScore(item)})}});new_list=_.uniq(new_list,"id");new_list.sort(function(a,b){return b.score-a.score});return new_list}function _calculateScore(item){if(!item||!item.visits)return 0;var points=0;var i=item.visits.length-1;var now=Date.now();for(i;i>=0;i--)points+=_weighVisit(now-item.visits[i]);if(item._reduced){points*=_REDUCED_MULTIPLIER}return item.count*points/item.visits.length}function _weighVisit(recency){var i=0;var length=_BUCKETS.length;for(i;i<length;i++){if(recency<_BUCKETS[i])return _WEIGHTS[i]}return 0}function _getCache(item){if(item)return _cache[item];return _cache}function _setCache(data){_cache=data}function _clearCache(){_cache={};TS.storage.clearFrecency(namespace);if(options&&options.onClearCache)options.onClearCache()}function _pruneCache(){var keys=Object.keys(_cache);_.each(keys,function(key){if(_.isArray(_cache[key])){for(var i=_cache[key].length;i>-1;i--){if(_shouldPruneCacheItem(_cache[key][i])){_cache[key].splice(i,1)}}if(!_cache[key].length){_cache[key]=null;delete _cache[key]}}else{if(_shouldPruneCacheItem(_cache[key])){_cache[key]=null;delete _cache[key]}}})}function _shouldPruneCacheItem(item){if(!item||_.isEmpty(item.visits)){return true}else{if(Date.now()-item.visits[item.visits.length-1]>_PRUNE_AFTER&&item.count<_PRUNE_BELOW_COUNT){return true}}}var api={query:_query,record:_record,getMostCommon:_getMostCommon,_getCache:_getCache,_setCache:_setCache,_clearCache:_clearCache,_pruneCache:_pruneCache,_test:{_REDUCED_MULTIPLIER:_REDUCED_MULTIPLIER,_PRUNE_BELOW_COUNT:_PRUNE_BELOW_COUNT}};_instances[namespace]=api;return api}var _instances={}})();(function(){"use strict";TS.registerModule("sorter",{onStart:function(){},search:function(query,data,options){return _search(query,data,options)},printTest:function(query,options){var all_members=TS.members.getActiveMembersWithSlackbotAndNotSelf();var all_channels=TS.channels.getUnarchivedChannelsForUser();var all_groups=TS.groups.getUnarchivedGroups();var all_mpims=TS.mpims.getVisibleMpims();var all_teams=_.values(TS.boot_data.other_accounts);var data={members:all_members,channels:all_channels,groups:all_groups,mpims:all_mpims,teams:all_teams};TS.sorter.search(query,data,_.extend({print:true},options))}});var _makeFuzzySearcher=function(query,fuzzy_limit){if(fuzzy_limit==null)fuzzy_limit=10;query=query.toLocaleLowerCase();var only_members=query.charAt(0)==="@";var only_channels=query.charAt(0)==="#";if(only_members||only_channels)query=query.substring(1);var fuzzy_options={fuzzy_limit:fuzzy_limit};var fuzzy=TS.fuzzy.makeFuzzyMatcher(query,fuzzy_options);var sub_queries=query.split(/[,| ]/).filter(function(i){return!!i});sub_queries=sub_queries.map(function(q){q=q.charAt("0")==="@"?q.substring(1):q;return TS.fuzzy.makeFuzzyMatcher(q,fuzzy_options)});var scoreMember=function(member,matcher){var name_score=Infinity;var rn_score=Infinity;var rn_norm_score=Infinity;name_score=matcher.score(member.name);if(member._real_name_lc){rn_score=matcher.score(member._real_name_lc);if(member._real_name_lc!==member._real_name_normalized_lc){rn_norm_score=matcher.score(member._real_name_normalized_lc)}}var score=Math.min(name_score,rn_score,rn_norm_score);return score};return{query:query,only_channels:only_channels,only_members:only_members,matchesChannel:function(c){if(only_members)return false;if(only_channels&&!query){c._jumper_score=0;return true}var score=fuzzy.score(c.name);c._jumper_score=score;return score<=fuzzy_limit},matchesGroup:function(g){if(only_channels||only_members)return false;var score=fuzzy.score(g.name);g._jumper_score=score;return score<=fuzzy_limit},matchesMember:function(m){if(only_channels)return false;if(only_members&&!query){m._jumper_score=0;return true}var score=scoreMember(m,fuzzy);m._jumper_score=score;return score<=fuzzy_limit},matchesMpim:function(mpim){if(only_channels||only_members)return false;var members=TS.mpims.getMembersInDisplayOrder(mpim);var scores=sub_queries.map(function(q){var scores=members.map(function(m){return scoreMember(m,q)});return _.min(scores)}.bind(this));var total=_.sum(scores);mpim._jumper_score=total;return total<=fuzzy_limit},matchesTeam:function(team){if(only_channels||only_members)return false;var score=fuzzy.score(team.team_name.toLocaleLowerCase());team._jumper_score=score;return score<=fuzzy_limit}}};var _search=function(query,data,options){var searcher=_makeFuzzySearcher(query,options.fuzzy_limit);var exact_match=null;var member_matches=[];var channel_matches=[];var channel_matches_not_member=[];var group_matches=[];var mpim_matches=[];var team_matches=[];if(!searcher.only_channels){member_matches=data.members.filter(function(m){if(options.prefer_exact_match&&m.name===searcher.query){exact_match=m;return false}return searcher.matchesMember(m)})}if(!searcher.only_members){data.channels.forEach(function(c){if(options.prefer_exact_match&&c.name===searcher.query){exact_match=c;return false}var matched=searcher.matchesChannel(c);if(!matched)return;if(c.is_member){channel_matches.push(c)}else{channel_matches_not_member.push(c)}})}if(!searcher.only_channels&&!searcher.only_members){group_matches=data.groups.filter(function(g){if(options.prefer_exact_match&&g.name===searcher.query){exact_match=g;return false}return searcher.matchesGroup(g)});mpim_matches=data.mpims.filter(function(mpim){return searcher.matchesMpim(mpim)});team_matches=data.teams.filter(function(team){if(options.prefer_exact_match&&team.team_name.toLocaleLowerCase()===searcher.query){exact_match=team;return false}var match=searcher.matchesTeam(team);return match})}var primary_matches,secondary_matches,sort_locale_aware;primary_matches=member_matches.concat(channel_matches,group_matches,mpim_matches);sort_locale_aware=primary_matches.length<24;primary_matches.sort(_.partial(_sortFuzzy,sort_locale_aware));secondary_matches=channel_matches_not_member.concat(team_matches);sort_locale_aware=secondary_matches.length<24;secondary_matches.sort(_.partial(_sortFuzzy,sort_locale_aware));var all_matches=primary_matches.concat(secondary_matches);var filtered_matches=all_matches;if(options.prefer_exact_match&&exact_match){filtered_matches.unshift(exact_match)}if(options.frecency){filtered_matches=options.frecency.query(all_matches,query,_frecencyBonusPoints)}if(options.limit){filtered_matches=_.take(filtered_matches,options.limit)}if(options.frecency){var matches_for_render=[];_.forEach(filtered_matches,function(f_match){var model_ob;var team_match=_.find(TS.boot_data.other_accounts,function(account){return account.id===f_match.id&&account.team_id!=TS.model.team.id});if(team_match){model_ob=team_match}else if(f_match.id.charAt(0)==="U"){model_ob=TS.members.getMemberById(f_match.id)}else{model_ob=TS.shared.getModelObById(f_match.id)}matches_for_render.push({model_ob:model_ob,score:f_match.score})});filtered_matches=matches_for_render}if(options.print){var output="\n";filtered_matches.forEach(function(match){if(match._jumper_score!=null)output+="["+match._jumper_score+"]";if(match.is_mpim){output+=TS.mpims.getDisplayName(match)}else if(match.is_channel){output+="#"+match.name}else if(match.is_group){output+=match.name}else if(match.team_id){output+=match.team_name}else{output+="@"+match.name;if(match.profile.real_name)output+=" "+match.profile.real_name}output+="\n"});TS.info(output)}return filtered_matches};var _getNameForComparison=function(model_ob){var name;if(model_ob.is_mpim){name=TS.mpims.getDisplayNameLowerCase(model_ob)}else if(model_ob._name_lc){name=model_ob._name_lc}else if(model_ob.team_name){name=model_ob.team_name.toLocaleLowerCase()}else{name=model_ob.name}return name};var _sortFuzzy=function(locale_aware,a,b){if(a.is_mpim&&!b.is_mpim)return 1;if(b.is_mpim&&!a.is_mpim)return-1;if(!a.is_mpim&&!b.is_mpim){var score_diff=a._jumper_score-b._jumper_score;if(score_diff!==0)return score_diff}if(a.is_mpim&&b.is_mpim){var mpim_score_diff=a._jumper_score-b._jumper_score;if(mpim_score_diff!==0)return mpim_score_diff;var member_count_diff=TS.mpims.getMemberCount(a)-TS.mpims.getMemberCount(b);if(member_count_diff!==0)return member_count_diff}var a_name=_getNameForComparison(a);var b_name=_getNameForComparison(b);if(locale_aware){return a_name.localeCompare(b_name)}else{if(a_name>b_name)return 1;if(b_name>a_name)return-1;return 0}};var _frecencyBonusPoints=function(item,query){if(item.is_mpim)return 0;var fuzziness=item._jumper_score;if(!_.isFinite(fuzziness))return 0;var scaler=Math.pow(.5,fuzziness);var exact_match_bonus=500;return Math.round(exact_match_bonus*scaler)}})();(function(){"use strict";TS.registerModule("fuzzy",{onStart:function(){},score:function(str,query,options){if(!options)options={};var matcher=TS.fuzzy.makeFuzzyMatcher(query,options);return matcher.score(str)},makeFuzzyMatcher:function(query,options){var query_node=_queryToLinkedList(query);if(null==options.fuzzy_limit)options.fuzzy_limit=Infinity;return{score:function(str){var should_continue=_containsAllLetters(str,query_node);if(!should_continue)return Infinity;if(!query_node)return Infinity;var node=_lettersToGraph(str);if(!node)return Infinity;var result=_searchWordBoundariesOnly(node,query_node,options);if(!result)return Infinity;var summed_up=_countResult(result);if(summed_up>options.fuzzy_limit)return Infinity;return summed_up}}},test:function(){return{lettersToGraph:_lettersToGraph,queryToLinkedList:_queryToLinkedList}}});var _ignored_chars=" -_'.";var _countResult=function(result){if(!result)return 0;return result.count+_countResult(result.next)};var _searchWordBoundariesOnly=function(node,query_node,options){var first=_searchWordBoundariesOnlyWorker(node,query_node,0,options);if(!first){first=_.reduce(node.jumps,function(match,jump_node){if(match||jump_node===node)return match;return _searchWordBoundariesOnlyWorker(jump_node,query_node,1,options)},null)}return first};var _searchWordBoundariesOnlyWorker=function(node,query_node,score,options){if(!node)return null;var this_match;if(!node.visited&&(node.letter===query_node.letter||node.ignored&&query_node.is_separator)){this_match={node:node,count:score}}if(!this_match)return null;if(!query_node.next)return this_match;node.visited=true;var next=_searchWordBoundariesOnlyWorker(node.next,query_node.next,0,options);var next_query_node=query_node.next;if(next_query_node.is_space){if(next_query_node.next)next_query_node=next_query_node.next}if(!next){next=_.reduce(node.jumps,function(result,jump_node){if(result)return result;if(jump_node.visited||jump_node===node)return result;return _searchWordBoundariesOnlyWorker(jump_node,next_query_node,1,options)},null)}node.visited=false;if(next){this_match.next=next;return this_match}return null};var _lettersToGraph=function(str){var letters=str.split("");var l=letters.shift();return _lettersToGraphWorker(l,null,letters,[],0)};var _lettersToGraphWorker=function(letter,prev,rest,jumps,index){if(!letter)return null;var node=_makeLetterNode(letter,prev,jumps,index);if(!prev||prev.ignored&&!node.ignored){jumps.push(node)}var next_node=_lettersToGraphWorker(rest.shift(),node,rest,jumps,index+1);if(next_node){node.next=next_node}return node};var _makeLetterNode=function(letter,prev,jumps,index){return{letter:letter,ignored:_ignored_chars.indexOf(letter)!==-1,next:null,prev:prev,jumps:jumps,visited:false,index:index}};var _queryToLinkedList=function(query){if(!query)return null;var letters=query.split("");return _queryToLinkedListWorker(letters,0)};var _queryToLinkedListWorker=function(letters,index){if(index>=letters.length)return null;var letter=letters[index];var is_separator=_ignored_chars.indexOf(letter)!==-1;var is_space=letter===" ";return{letter:letter,is_separator:is_separator,is_space:is_space,next:_queryToLinkedListWorker(letters,index+1),index:index}};var _containsAllLetters=function(str,query_node){if(!query_node)return true;var found_it=query_node.is_separator||str.indexOf(query_node.letter)!==-1;if(!found_it)return false;return _containsAllLetters(str,query_node.next)}})();(function(){"use strict";TS.registerModule("ui.shared_channels_invites",{onStart:function(){if(TS.channels)TS.channels.archived_sig.add(_handleArchiveSharedChannel);if(TS.groups)TS.groups.archived_sig.add(_handleArchiveSharedChannel);TS.ui.validation.register("valid_invite",_validateValidInvite)},start:function(){if(TS.members.canUserCreateSharedChannels())_start()}});var _$div;var _$body;var _shared_invites=[];var _private_shared_invites=[];var _shared_channels=[];var _private_shared_channels=[];var _start=function(){var settings={body_template_html:TS.templates.shared_channels_invites_modal(),onShow:_onShow,onCancel:_onCancel};TS.ui.fs_modal.start(settings)};var _onShow=function(){_$div=$("#sci_container");_$body=$("body");_$div.on("click",'[data-action="sci_to_create"]',_switchToCreate);_$div.on("click",'[data-action="sci_cancel"]',_switchToManage);_$div.on("click",'[data-action="sci_create"]',_createInvite);_$div.on("click",'[data-action="sci_show_action"]',_showAction);_$div.on("click",'[data-action="sci_toggle_contents"]',_toggleContents);_$div.on("click",'[data-action="sci_toggle_send_email"]',_toggleSendEmail);_$div.on("click",'[data-action="sci_toggle_copy_link"]',_toggleCopyLink);_$div.on("click",'[data-action="sci_send"]',_sendInviteEmail);_$div.on("click",'[data-action="sci_copy"]',_maybeCopyLink);_$div.on("click",'[data-action="sci_revoke"]',_revokeSharedInvite);_$div.on("click",'[data-action="sci_archive"]',_archiveSharedChannel);_$div.on("change",'[type="radio"][name="share_with"]',_toggleShareWith);_$div.on("input","#sci_create [data-validation]",function(e){var $container=_$div.find("#sci_create");_toggleButton($container.find(_getCreateViewValidationSelector()),$container.find('[data-action="sci_create"]'))});_$div.on("input","input[data-invite-id]",function(e){var $container=$(e.target).parent();_toggleButton($container,$container.find('[data-action="sci_send"]'))});_$body.on("keyup.sci",_onKeyUp);_promiseToGetData().then(_switchToManage).catch(_handleError)};var _onCancel=function(){_updateBackButton(true);_$div=null;_$body.off("keyup.sci");_$body=null;_setSharedInvitesIntoModel([]);_setSharedInvitesIntoModel([],true);_setSharedChannelsIntoModel([]);_setSharedChannelsIntoModel([],true)};var _setSharedInvitesIntoModel=function(shared_invites,is_private){if(is_private){_private_shared_invites=shared_invites}else{_shared_invites=shared_invites}};var _getSharedInvitesFromModel=function(is_private){return is_private?_private_shared_invites:_shared_invites};var _getSharedInviteFromModelById=function(id,is_private){return _.find(_getSharedInvitesFromModel(is_private),function(invite){return invite.invite_id==id})};var _removeSharedInviteFromModelById=function(id,is_private){_.remove(_getSharedInvitesFromModel(is_private),function(invite){return invite.invite_id==id})};var _findSharedInviteByTeamDomainAndChannelName=function(team_domain,channel_name){return _.find(_getSharedInvitesFromModel(),function(invite){return invite.team.domain===team_domain&&invite.channel_name===channel_name})||_.find(_getSharedInvitesFromModel(true),function(invite){return invite.team.domain===team_domain&&invite.channel_name===channel_name})};var _isPrivateInviteById=function(id){return!!_getSharedInviteFromModelById(id,true)};var _setSharedChannelsIntoModel=function(shared_channels,is_private){if(is_private){_private_shared_channels=shared_channels}else{_shared_channels=shared_channels}};var _getSharedChannelsFromModel=function(is_private){return is_private?_private_shared_channels:_shared_channels};var _removeSharedChannelFromModelById=function(id,is_private){_.remove(_getSharedChannelsFromModel(is_private),function(shared_item){return shared_item.channel==id})};var _getSharedChannelsForTemplate=function(is_private){return _getSharedChannelsFromModel(is_private).map(function(shared_channel){var model_ob=TS.shared.getModelObById(shared_channel.channel);return $.extend({},shared_channel,model_ob)})};var _getEnterpriseTeamsFromModelLessOwn=function(){return _isEnterprise()?_.filter(TS.model.enterprise._teams,function(team){return team.id!==TS.model.team.id}):[]};var _promiseToGetData=function(){return Promise.all([_promiseToCallListSharedInvites().reflect(),_promiseToCallListSharedInvites(true).reflect(),_promiseToCallListShared().reflect(),_promiseToCallListShared(true).reflect()]).then(function(responses){var rejection_reasons=[];responses.forEach(function(response){if(response.isFulfilled())return;rejection_reasons.push(response.reason())});if(rejection_reasons.length){return Promise.reject(new Error("Some shared channels start APIs failed:\n"+rejection_reasons.join("\n")))}else{_setSharedInvitesIntoModel(responses[0].value().data.invites);_setSharedInvitesIntoModel(responses[1].value().data.invites,true);_setSharedChannelsIntoModel(responses[2].value().data.channels);_setSharedChannelsIntoModel(responses[3].value().data.channels,true)}})};var _promiseToCallInviteShared=function(args,is_private){return TS.api.call(is_private?"groups.inviteShared":"channels.inviteShared",args)};var _promiseToCallListShared=function(is_private){return TS.api.call(is_private?"groups.listShared":"channels.listShared")};var _promiseToCallListSharedInvites=function(is_private){return TS.api.call(is_private?"groups.listSharedInvites":"channels.listSharedInvites")};var _promiseToCallRevokeSharedInvite=function(args,is_private){return TS.api.call(is_private?"groups.revokeSharedInvite":"channels.revokeSharedInvite",args)};var _promiseToCallSendSharedInvite=function(args,is_private){return TS.api.call(is_private?"groups.sendSharedInvite":"channels.sendSharedInvite",args)};var _promiseToCallCreateShared=function(args,is_private){return TS.api.call(is_private?"enterprise.groups.createShared":"enterprise.channels.createShared",args)};var _createInvite=function(){var $container=_$div.find("#sci_create");var $contents=$container.find(_getCreateViewValidationSelector());if(!TS.ui.validation.validate($contents,{quiet:true,fast:true})){TS.ui.validation.validate($contents);Ladda.stopAll();$container.find('[data-action="sci_create"]').addClass("disabled");return}var args={};var is_private=!$container.find('[name="access"]').prop("checked");if(_isEnterprise()){switch($container.find('[name^="share_with"]:checked').val()){case"specific":args.target_domains=$container.find('[name="domains"]').val();break;case"external":args.target_domain=$container.find('[name="domain"]').val();break;case"all":args.all_teams=true;break}}else{args.target_domain=$container.find('[name="domain"]').val()}var channel_name=$container.find('[name="channel_name"]').val();if(channel_name)args.channel_name=channel_name;var purpose=$container.find('[name="purpose"]').val();if(purpose)args.purpose=purpose.trim();if(args.target_domain){_promiseToCallInviteShared(args,is_private).then(function(response){var invite_id=response.data.invite_id;_switchToSend(response.data);return _promiseToCallListSharedInvites(is_private).then(function(response){_setSharedInvitesIntoModel(response.data.invites,is_private);_rebuildSharedInvite(invite_id)})}).catch(_handleError)}else{_promiseToCallCreateShared(args,is_private).then(function(){return _promiseToCallListShared(is_private).then(function(response){_setSharedChannelsIntoModel(response.data.channels,is_private);_switchToManage()})}).catch(_handleError)}};var _sendInviteEmail=function(e){var $el=$(e.target);var $container=$el.parent();if(!TS.ui.validation.validate($container,{quiet:true,fast:true})){TS.ui.validation.validate($container);$container.find('[data-action="sci_send"]').addClass("disabled");return}var invite_id=$el.data("invite-id");var $input=$container.find("input");var email=$input.val();if(!email)return;var is_private=_isPrivateInviteById(invite_id);var args={invite_id:invite_id,email:email};_promiseToCallSendSharedInvite(args,is_private).then(function(){$input.val("");return _promiseToCallListSharedInvites(is_private).then(function(response){_setSharedInvitesIntoModel(response.data.invites,is_private);_rebuildEmailedInvitations(invite_id);_addSentEmailsFeedback(invite_id)})}).catch(_handleError)};var _maybeCopyLink=function(e){var $el=$(e.target);var $container=$el.parent();var $input=$container.find("input");var $feedback=$container.find("label > span");var input=$input.get(0);var link=$input.val();if(TS.clipboard.canWriteText()){TS.clipboard.writeText(link)}else{_showEphemeralCopyLinkFeedback($feedback)}if(input)input.setSelectionRange(0,link.length)};var _revokeSharedInvite=function(e){var $el=$(e.target);var invite_id=$el.data("invite-id");var is_private=_isPrivateInviteById(invite_id);_promiseToCallRevokeSharedInvite({invite_id:invite_id},is_private).then(function(response){_removeSharedInviteFromModelById(invite_id,is_private);_removeSharedInvite(invite_id);_maybeRebuildManageView()}).catch(_handleError)};var _archiveSharedChannel=function(e){var $el=$(e.target);var channel_id=$el.data("channel-id");var model_ob=TS.shared.getModelObById(channel_id);if(!model_ob)return;if(model_ob.is_channel){TS.channels.ui.showArchiveChannelDialog(model_ob)}else if(model_ob.is_group&&!model_ob.is_mpim){TS.channels.ui.showArchiveGroupDialog(model_ob)}};var _handleArchiveSharedChannel=function(channel){if(!_$div)return;_removeSharedChannelFromModelById(channel.id,channel.is_group);_removeSharedChannel(channel.id);_maybeRebuildManageView()};var _switchToManage=function(){var template_args={shared_invites:_getSharedInvitesFromModel(),shared_channels:_getSharedChannelsForTemplate(),private_shared_invites:_getSharedInvitesFromModel(true),private_shared_channels:_getSharedChannelsForTemplate(true)};var html=TS.templates.shared_channels_invites_manage(template_args);_$div.find("#sci_manage").html(html);_hideAllSectionsBut("#sci_manage");_updateBackButton(true)};var _switchToCreate=function(){var is_enterprise=_isEnterprise();var template_args={reserved_domain:TS.model.team.domain};if(is_enterprise)template_args.enterprise_info=TS.model.enterprise;var html=TS.templates.shared_channels_invites_create(template_args);_$div.find("#sci_create").html(html).find("textarea").autogrow();_hideAllSectionsBut("#sci_create");_setupTeamNameOverlayEffect();_setupToggleInput();if(is_enterprise)_makeEnterpriseTeamsPicker();_$div.find('#sci_create [name="domain"]').focus();Ladda.bind('#sci_create [data-action="sci_create"]');_updateBackButton()};var _switchToSend=function(args){var html=TS.templates.shared_channels_invites_send(args);_$div.find("#sci_send").html(html);_hideAllSectionsBut("#sci_send");_updateBackButton()};var _hideAllSectionsBut=function(id){var sections=["#sci_loading","#sci_manage","#sci_create","#sci_send"].filter(function(section_id){return section_id!==id}).join(", ");_$div.find(sections).addClass("hidden");_$div.find(id).removeClass("hidden")};var _updateBackButton=function(unbind){if(unbind){TS.ui.fs_modal.unbindBackButton();TS.ui.fs_modal.hideBackButton()}else{TS.ui.fs_modal.bindBackButton(_switchToManage);TS.ui.fs_modal.showBackButton()}};var _onKeyUp=function(e){if(e.which!==TS.utility.keymap.enter)return;var $el=$(e.target);if($el.is("input[data-invite-id]"))return void _sendInviteEmail(e);if($el.is('input[name="domain"], input[name="channel_name"]')){TS.ui.startButtonSpinner($('#sci_create [data-action="sci_create"]').get(0));_createInvite(e);return}};var _setupTeamNameOverlayEffect=function(){var overlay=_$div.find("#sci_create .placeholder_overlay");_$div.find('#sci_create input[name="domain"]').on("input",function(e){overlay.toggleClass("hidden",!!$(e.target).val())})};var _setupToggleInput=function(){_$div.find('#sci_create [name="access"]').togglify({on_text:"Public",off_text:"Private",label:_getToggleInputLabel(),off_label:_getToggleInputOffLabel(),off_class:"ts_toggle_orange",initial_state:true})};var _getToggleInputLabel=function(){var label="Anyone on your team can join";if(_isEnterprise()){var name=TS.utility.htmlEntities(TS.model.enterprise.name);switch(_$div.find('[name^="share_with"]:checked').val()){case"specific":label="Specific teams at "+name+" can join";break;case"all":label="Anyone at "+name+" can join";break}}return label};var _getToggleInputOffLabel=function(){var label="Restricted to invited members";if(_isEnterprise()){var name=TS.utility.htmlEntities(TS.model.enterprise.name);switch(_$div.find('[name^="share_with"]:checked').val()){case"specific":label+=" on specific "+name+" teams";break;case"all":label+=" at "+name;break}}return label};var _updateToggleInputLabels=function(){_$div.find(".ts_toggle_on_label").text(_getToggleInputLabel());_$div.find(".ts_toggle_off_label").text(_getToggleInputOffLabel())};var _showAction=function(e){_collapseAction();var $el=$(e.currentTarget).addClass("showing_sci_action");if($el.is(".sci_send_email_container"))$el.find("input").focus()};var _collapseAction=function(){_$div.find(".showing_sci_action").removeClass("showing_sci_action")};var _toggleShareWith=function(e){var $el=$(e.target);var $container=_$div.find("#sci_create");var checked=$el.val();var show_specific=checked==="specific";var show_external=checked==="external";$("#sci_specific_team").toggleClass("hidden",!show_specific);$("#sci_external_team").toggleClass("hidden",!show_external);$container.find('[for="share_with_specific"]').toggleClass("hidden",!show_specific);$container.find('[for="share_with_external"]').toggleClass("hidden",!show_external);if(checked==="specific")$container.find('[name="team_list"]').focus();if(checked==="external")$container.find('[name="domain"]').focus();_toggleButton($container.find(_getCreateViewValidationSelector()),$container.find('[data-action="sci_create"]'));_updateToggleInputLabels()};var _makeEnterpriseTeamsPicker=function(){var $container=_$div.find("#sci_create");$container.find('[name="domains"]').each(function(index,el){var $el=$(el);TS.ui.team_picker.make($el,{teams:_getEnterpriseTeamsFromModelLessOwn()});$el.on("change",function(){var value=TS.ui.team_picker.value($el).map(function(item){return item.team.domain}).join(",");$el.val(value);_toggleButton($container.find(_getCreateViewValidationSelector()),$container.find('[data-action="sci_create"]'))})})};var _toggleContents=function(e){if($(e.target).is("a, input, .btn"))return;var $el=$(e.currentTarget);var is_showing=$el.hasClass("showing_contents");$el.toggleClass("showing_contents",!is_showing);$el.find(".sci_toggle_icon").toggleClass("ts_icon_caret_right",is_showing).toggleClass("ts_icon_caret_down",!is_showing)};var _toggleSendEmail=function(e){var $el=$(e.target).closest(".sci_invite_container").find(".sci_send_email_mini_container");$el.toggleClass("hidden",!$el.hasClass("hidden")).find("input").focus();_collapseCopyLink(e)};var _toggleCopyLink=function(e){var $el=$(e.target).closest(".sci_invite_container").find(".sci_copy_link_mini_container");$el.toggleClass("hidden",!$el.hasClass("hidden"));_collapseSendEmail(e)};var _collapseSendEmail=function(e){$(e.target).closest(".sci_invite_container").find(".sci_send_email_mini_container").addClass("hidden")};var _collapseCopyLink=function(e){$(e.target).closest(".sci_invite_container").find(".sci_copy_link_mini_container").addClass("hidden")};var _addSentEmailsFeedback=function(id){if(!id)return;var invite=_getSharedInviteFromModelById(id,_isPrivateInviteById(id));if(!invite)return;_$div.find('.sci_send_email_container [data-action="replace_sent_emails"]').replaceWith(TS.templates.shared_channels_invites_sent_emails(invite))};var _showEphemeralCopyLinkFeedback=function($el){var timeout=$el.data("timeout");clearTimeout(timeout);$el.removeClass("hidden").data("timeout",setTimeout(function(){$el.addClass("hidden")},3e3))};var _rebuildEmailedInvitations=function(id){if(!id)return;var invite=_getSharedInviteFromModelById(id,_isPrivateInviteById(id));if(!invite)return;_$div.find("#sci_invite_container_"+id+' [data-action="replace_emailed_invites"]').replaceWith(TS.templates.shared_channels_invites_emailed_invitations(invite))};var _removeSharedInvite=function(id){if(!id)return;_$div.find("#sci_invite_container_"+id).remove();var $el=_$div.find("#sci_invites_container");if($el.children().length===1)$el.addClass("hidden")};var _rebuildSharedInvite=function(id){if(!id)return;var invite=_getSharedInviteFromModelById(id,_isPrivateInviteById(id));if(!invite)return;var $el=_$div.find("#sci_invite_container_"+id);if($el.length){$el.replaceWith(TS.templates.shared_channels_invites_invite(invite))}else{_$div.find("#sci_invites_container .sci_list_header").after(TS.templates.shared_channels_invites_invite(invite))}_$div.find("#sci_invites_container").removeClass("hidden")};var _removeSharedChannel=function(id){if(!id)return;var $el=_$div.find("#sci_channels_container");$el.find('.sci_channel_container[data-channel-id="'+id+'"]').remove();if($el.children().length===1)$el.addClass("hidden")};var _maybeRebuildManageView=function(){if(!_getSharedInvitesFromModel().length&&!_getSharedChannelsFromModel().length&&!_getSharedInvitesFromModel(true).length&&!_getSharedChannelsFromModel(true).length)_switchToManage()};var _toggleButton=function($container,$btn){$btn.toggleClass("disabled",!TS.ui.validation.validate($container,{quiet:true,fast:true}))};var _getCreateViewValidationSelector=function(){var selectors=['[name="channel_name"]','[name="purpose"]'];if(_isEnterprise()){switch(_$div.find('[name^="share_with"]:checked').val()){case"specific":selectors.push('[name="team_list"]');break;case"external":selectors.push('[name="domain"]');break}}else{selectors.push('[name="domain"]')}return selectors.join(", ")};var _isEnterprise=function(){return TS.boot_data.page_needs_enterprise};var _validateValidInvite=function($el,options){if(!_$div)return true;if(!$el.is("input"))return true;var $container=$("#sci_create");var $domain_el=$el.is('[name="domain"]')?$el:$container.find("[name=domain]");var $channel_el=$el.is("[name=channel_name]")?$el:$container.find("[name=channel_name]");var domain=$domain_el.val().trim();var channel=$channel_el.val().trim();if(_findSharedInviteByTeamDomainAndChannelName(domain,channel)){if(!options.quiet)$el.addClass("invalid_invite");
return void TS.ui.validation.showWarning($el,"This invite already exists. Try a different team or channel!",options)}if($domain_el===$el){if(channel&&!options.quiet&&$channel_el.hasClass("invalid_invite")){$channel_el.removeClass("invalid_invite");TS.ui.validation.validate($channel_el)}}else{if(domain&&!options.quiet&&$domain_el.hasClass("invalid_invite")){$domain_el.removeClass("invalid_invite");TS.ui.validation.validate($domain_el)}}if(!options.quiet)$el.removeClass("invalid_invite");return true};var _handleUnexpectedError=function(error){var message=error.message||"";if(error.data&&error.data.error)message+=": "+error.data.error;TS.error(message);TS.generic_dialog.alert("Sorry! Something went wrong. Please try again.")};var _handleError=function(error){var body;switch(error.data.error){case"invalid_target_domain":body="Darn&mdash;we couldnt find a team with that domain. Try again?";break;case"name_taken":body="Darn&mdash;that channel name is already taken. Try another?";break;case"invite_exists":body="An invitation already exists for that team and channel.";break;case"shared_channel_exists":body="Good news! That team has already joined the shared channel.";break;case"not_paid":body="Darn&mdash;that team has to upgrade to a paid Slack plan to join a shared channel.";break;default:return _handleUnexpectedError(error)}TS.generic_dialog.alert(body)}})();(function(){"use strict";TS.registerModule("ui.team_picker",{onStart:function(){},make:function($el,options){options=options||{};var prev_query;var start_regex;var suffix_regex;if(!options.append)$el.addClass("hidden");$el.filterSelect({append:!!options.append,data:_makeTeamsWithPreselectsForTemplate(options.teams||[],options.preselected_ids||[]),per_page:50,placeholder_text:"Add teams",classes:options.classes||"normal_style",single:!!options.single,template:function(item){var html=TS.templates.invite_team_small({team:item.team});return new Handlebars.SafeString(html)},tokenTemplate:function(item){var html=TS.templates.invite_team_token({team:item.team});return new Handlebars.SafeString(html)},filter:function(item,query){var team=item.team;if(prev_query!==query){start_regex=new RegExp("^"+TS.utility.regexpEscape(query),"i");suffix_regex=new RegExp("(-|_|\\+|\\s|\\.|@)"+TS.utility.regexpEscape(query),"i");prev_query=query}return _checkTeamMatch(team,start_regex)||_checkTeamMatch(team,suffix_regex)},noResultsTemplate:function(query){if(!query){return"No teams found"}else{return"No teams found matching <strong>"+TS.utility.htmlEntities(query)+"</strong>"}}})},value:function($el){return $el.filterSelect("value")}});var _makeTeamsWithPreselectsForTemplate=function(teams,preselected_ids){return teams&&teams.map(function(team){return{team:team,preselected:preselected_ids.indexOf(team.id)!==-1}})};var _checkTeamMatch=function(team,regex){return team.name&&team.name.match(regex)}})();(function(){"use strict";TS.registerModule("user_groups",{updated_sig:new signals.Signal,onStart:function(){if(TS.client){TS.client.login_sig.add(TS.user_groups.onLogin)}else if(TS.web){TS.web.login_sig.add(TS.user_groups.onLogin)}},onLogin:function(){_login_sig_fired=true;TS.user_groups.sortUserGroups()},getUserGroupsByHandle:function(handle){handle=TS.utility.getLowerCaseValue(handle);var user_groups=TS.model.user_groups;var user_group=_handle_map[handle];if(user_group)return user_group;if(!user_groups)return;for(var i=0;i<user_groups.length;i++){user_group=user_groups[i];if(user_group.handle==handle||"@"+user_group.handle==handle){TS.warn(handle+" not in _handle_map?");_handle_map["@"+handle]=user_group;_handle_map[handle]=user_group;return user_group}}return null},getUserGroupsById:function(id){if(TS.model.user&&TS.model.user.is_restricted)return false;var user_groups=TS.model.user_groups;var user_group=_id_map[id];if(user_group)return user_group;if(!user_groups)return;for(var i=0;i<user_groups.length;i++){user_group=user_groups[i];if(user_group.id==id){TS.warn(id+" not in _id_map?");_id_map[id]=user_group;return user_group}}return null},getUserGroupMembers:function(id,handler){TS.api.call("subteams.users.list",{subteam:id,include_disabled:1},function(ok,data){if(ok&&data){var user_group=TS.user_groups.getUserGroupsById(id);if(user_group){user_group.users=data.users;user_group.user_count=data.users.length;TS.user_groups.upsertUserGroupAndSignal(user_group);user_group=TS.user_groups.getUserGroupsById(id);if(handler){handler(user_group)}}}})},updateMembersOfUserGroup:function(data,handler){TS.api.call("subteams.users.update",data,handler)},createUserGroup:function(data,handler){TS.api.call("subteams.create",data,handler)},updateUserGroup:function(data,handler){TS.api.call("subteams.update",data,handler)},enableUserGroup:function(user_group_id,handler){TS.api.call("subteams.enable",{subteam:user_group_id},handler)},disableUserGroup:function(user_group_id,handler){TS.api.call("subteams.disable",{subteam:user_group_id},handler)},deleteUserGroup:function(user_group_id,handler){TS.api.call("subteams.delete",{subteam:user_group_id,include_disabled:1},handler)},getMembersInCorG:function(user_group_id,id,callback){var ug=TS.user_groups.getUserGroupsById(user_group_id);var channel=TS.channels.getChannelById(id)||TS.groups.getGroupById(id);var result=[];var filter_members=function(){var group=TS.user_groups.getUserGroupsById(user_group_id);var members=group.users.filter(function(member_id){return channel.members.indexOf(member_id)!==-1});return members};var do_work=function(){result=filter_members();return callback(result)};if(!ug||!channel){return callback(result)}if(ug.users===undefined){if(!_pending_group_requests[user_group_id]){_pending_group_requests[user_group_id]=true;TS.user_groups.getUserGroupMembers(user_group_id,function(updated_group){if(updated_group&&updated_group.users){_pending_group_requests[user_group_id]=false;ug=updated_group;return do_work()}})}else{return callback(result)}}else{return do_work()}},upsertUserGroup:function(user_group){if(TS.model.user&&TS.model.user.is_restricted)return false;var existing_user_group=TS.user_groups.getUserGroupsById(user_group.id);user_group._name_lc=user_group.name.toLowerCase();if(existing_user_group){TS.log(4,'updating existing user group "'+user_group.id+'"');var user_user_group=TS.model.your_user_group_regex[user_group.id];if(user_user_group)TS.user_groups.removeSelfUserGroup(existing_user_group.id);for(var k in user_group){if(existing_user_group[k]!=user_group[k]){existing_user_group[k]=user_group[k]}}if(!user_group.date_delete&&user_group.users&&user_group.users.indexOf(TS.model.user.id)!==-1){if(!TS.user_groups.getUserGroupsById(user_group.id)){TS.model.user_groups.push(user_group)}TS.user_groups.upsertSelfUserGroup(existing_user_group.id);_assignMapsForGroup(user_group)}}else if(!user_group.date_delete){TS.log(4,'Adding user group "'+user_group.id+'"');if(!TS.user_groups.getUserGroupsById(user_group.id)){TS.model.user_groups.push(user_group)}_assignMapsForGroup(user_group)}TS.user_groups.sortUserGroups();TS.user_groups.updated_sig.dispatch()},sortUserGroups:function(){if(!_login_sig_fired)return;TS.model.user_groups.sort(function(a,b){return a._name_lc.localeCompare(b._name_lc)})},upsertUserGroupAndSignal:function(user_group){TS.user_groups.upsertUserGroup(user_group);TS.user_groups.updated_sig.dispatch(user_group.id)},removeUserGroup:function(user_group){var existing_user_group=TS.user_groups.getUserGroupsById(user_group.id);if(existing_user_group){TS.user_groups.removeSelfUserGroup(existing_user_group.id);_deleteMapsForGroup(existing_user_group);existing_user_group.date_delete=-1}},removeUserGroupAndSignal:function(user_group){TS.user_groups.removeUserGroup(user_group);TS.user_groups.updated_sig.dispatch(user_group.id)},upsertSelfUserGroup:function(user_group_id){var existing_user_group_regex=TS.model.your_user_group_regex[user_group_id];if(existing_user_group_regex)TS.user_groups.removeSelfUserGroup(user_group_id);var ug=TS.user_groups.getUserGroupsById(user_group_id);if(ug&&!ug.date_delete){var user_group_regex=new RegExp("<!subteam\\^("+ug.id+(ug.handle?"|"+ug.handle:"")+")\\b");TS.model.your_user_group_regex[ug.id]=user_group_regex;if(ug.handle){TS.model.highlight_words.push("@"+ug.handle);TS.model.highlight_words_regex=null}}},removeSelfUserGroup:function(user_group_id){TS.model.your_user_group_regex[user_group_id]=null;delete TS.model.your_user_group_regex[user_group_id];var ug=TS.user_groups.getUserGroupsById(user_group_id);if(ug){if(ug.handle)TS.utility.removeFromArray(TS.model.highlight_words,"@"+ug.handle);_deleteMapsForGroup(ug);TS.model.highlight_words_regex=null;TS.user_groups.updated_sig.dispatch(ug.id)}},test:function(){return{clearUseGroupMaps:_clearUseGroupMaps}}});var _handle_map={};var _id_map={};var _clearUseGroupMaps=function(){_handle_map={};_id_map={}};var _assignMapsForGroup=function(user_group){if(!user_group)return;if(user_group.handle){_handle_map[user_group.handle]=user_group;_handle_map["@"+user_group.handle]=user_group}_id_map[user_group.id]=user_group};var _deleteMapsForGroup=function(user_group){if(!user_group)return;if(user_group.handle){delete _handle_map[user_group.handle];delete _handle_map["@"+user_group.handle]}delete _id_map[user_group.id]};var _pending_group_requests={};var _login_sig_fired})();(function(){"use strict";TS.registerModule("ui.admin_user_groups",{user_groups_fetched:new signals.Signal,onStart:function(){$("body").on("click",'[data-action="admin_user_groups_modal"]',function(){_start()});$("body").on("click",'[data-action="admin_user_groups_modal_new"]',function(){TS.ui.admin_user_groups.add()})},start:function(){_start()},add:function(){_start();_close_when_done=true;_switchSettingsFormView()},editInfo:function(user_group){_start();_close_when_done=true;_switchSettingsFormView(user_group)},editMembers:function(user_group){_start();_close_when_done=true;_switchMembersFormView(user_group,false)},disable:function(user_group){_start();_close_when_done=true;_switchToggleView(user_group,"disable_user_group")},enable:function(user_group){_start();_close_when_done=true;_switchToggleView(user_group,"enable_user_group")},remove:function(user_group){_start();_close_when_done=true;_switchToggleView(user_group,"delete_user_group")}});var _$div;var _$all_user_groups;var _$user_groups_form_div;var _$user_groups_toggle_div;var _refresh_list=true;var _user_groups=[];var _temp_user_group;var _close_when_done=false;var _start=function(){var body_template_html=TS.templates.user_group_modal({show_info_pane:!TS.model.prefs.hide_user_group_info_pane,show_user_groups_add:TS.members.canUserCreateAndDeleteUserGroups()});var settings={body_template_html:body_template_html,onShow:_onShow,onCancel:_onCancel};TS.ui.fs_modal.start(settings)};var _onShow=function(){_$div=$("#user_groups_container");_$all_user_groups=$("#all_user_groups");_$user_groups_form_div=$("#user_groups_form_div");_$user_groups_toggle_div=$("#user_groups_toggle_div");_switchListView();_$div.find('[data-action="open_form"]').on("click",function(e){e.preventDefault();var id=$(this).closest(".user_group_item").data("user-group-id");var user_group=_getUserGroupFromId(id);_switchSettingsFormView(user_group)})};var _onCancel=function(){_refresh_list=true;if(_temp_user_group){TS.user_groups.deleteUserGroup(_temp_user_group.id)}_$div=null;_$all_user_groups=null;_$user_groups_form_div=null;_$user_groups_toggle_div=null;_close_when_done=false;_$monkey_scroll=null;_$icon_close=null;$(window).off("resize",_onResizeList)};var _onReset=function(e){if(e)e.preventDefault();if(!_close_when_done){_switchListView()}else{TS.ui.fs_modal.close();_$monkey_scroll=null}};var _onUpdateComplete=function(){if(!_close_when_done){_refresh_list=true;_switchListView()}else{TS.ui.fs_modal.close();_$monkey_scroll=null}};var _bindBackButton=function(){if(!_close_when_done){TS.ui.fs_modal.bindBackButton(_switchListView);TS.ui.fs_modal.showBackButton()}};var _findAutoUserGroup=function(auto_type){if(!_user_groups||!auto_type)return false;for(var i=0,j=_user_groups.length;i<j;i++){if(_user_groups[i].auto_type===auto_type){return _user_groups[i]}}return false};var _alertIfNotOk=function(ok,data){if(!ok){var group_name=$("#user_group_name_input").val()||"";var group_handle=$("#user_group_handle_input").val()||"";data.group_name=group_name;data.group_handle=group_handle;if(data.error&&(data.error==="forbidden_handle"||data.error==="forbidden_name")){var combined_input=group_name+group_handle;if(combined_input){var auto_owners=_findAutoUserGroup("owner");var auto_admins=_findAutoUserGroup("admin");var looks_like_admin_group=!!combined_input.match(/admins/i);var looks_like_owner_group=!!combined_input.match(/owners/i);data.suggest_auto_group=true;data.can_create_auto_owners=looks_like_owner_group&&TS.model.user.is_admin&&!auto_owners;data.can_enable_auto_owners=looks_like_owner_group&&auto_owners&&auto_owners.date_delete;data.can_create_auto_admins=looks_like_admin_group&&TS.model.user.is_admin&&!auto_admins;data.can_enable_auto_admins=looks_like_admin_group&&auto_admins&&auto_admins.date_delete}}$("#user_group_alerts").html(TS.templates.user_group_alerts(data));return true}return false};var _onResizeList=function(){var $groups_header=$("#user_groups_header");var $list=$("#user_groups_list_div");var groups_header_padding=parseInt($groups_header.css("padding-top"),10);var header_height=$groups_header[0].offsetHeight;var window_height=$(window).height();var min_list_height=250;var height=Math.max(min_list_height,window_height-header_height-groups_header_padding);$list.css("height",height)};var _switchListView=function(highlight_id){if(_refresh_list){var $user_group_list=$("#user_groups_list_div");$user_group_list.html(Handlebars.helpers.loadingHTML());TS.api.call("subteams.list",{include_disabled:1,include_users:1},function(ok,data){if(_alertIfNotOk(ok,data))return;_user_groups=data.subteams;for(var i=0,j=_user_groups.length;i<j;i++){_user_groups[i]._name_lc=_user_groups[i].name.toLowerCase()}_user_groups.sort(function(a,b){return a._name_lc.localeCompare(b._name_lc)});TS.ui.admin_user_groups.user_groups_fetched.dispatch(_user_groups);_refreshList();_bindListUI();if(highlight_id){$('#fs_modal [data-user-group-id="'+highlight_id+'"]').addClass("highlight_yellow");$("#fs_modal").animate({scrollTop:$(".highlight_yellow").offset().top},500)}});_refresh_list=false}_$all_user_groups.removeClass("hidden");_$user_groups_form_div.addClass("hidden");_$user_groups_toggle_div.addClass("hidden");TS.ui.fs_modal.hideBackButton()};var _bindListUI=function(){$(window).on("resize",_onResizeList);_onResizeList();$("#user_groups_list_div").monkeyScroll();_$monkey_scroll=$("#user_groups_list_div").data("monkeyScroll");$("#user_group_modal_search").on("keydown keyup change",_updateSearch);_$icon_close=$("#user_groups_header .user_groups_search .icon_close");_$icon_close.off("click").on("click",_clearSearch);_$all_user_groups.off("click");_$all_user_groups.on("click",'[data-action="open_form"]',function(e){e.preventDefault();var $target=$(e.target);var id=$target.closest(".user_group_item").data("user-group-id");var user_group=_getUserGroupFromId(id);_switchSettingsFormView(user_group)});_$all_user_groups.on("click",'[data-action="edit_members"]',function(e){e.preventDefault();var $target=$(e.target);var id=$target.closest(".user_group_item").data("user-group-id");var user_group=_getUserGroupFromId(id);_switchMembersFormView(user_group)});_$all_user_groups.on("click",'[data-action="hide_info_pane"]',function(e){e.preventDefault();TS.prefs.setPrefByAPI({hide_user_group_info_pane:true},function(ok,data){if(_alertIfNotOk(ok,data))return;_$div.find(".info_panel").addClass("hidden")})});_$all_user_groups.on("click",".user_group_toggle_btn",function(e){e.preventDefault();var $target=$(e.target).closest("button, a");var id=$target.closest(".user_group_item").data("user-group-id");var action=$target.data("action");var user_group=_getUserGroupFromId(id);_switchToggleView(user_group,action)});_$all_user_groups.on("click",".clear_members_filter",_clearSearch);var autoMethodHandler=function(ok,data){if(ok){_refresh_list=true;_close_when_done=false;_switchListView(data.subteam&&data.subteam.id?data.subteam.id:null)}};var auto_methods={owners:{create:function(){TS.api.call("subteams.createAuto",{type:"owner"},autoMethodHandler)},enable:function(){var user_group=_findAutoUserGroup("owner");if(!user_group)return;TS.user_groups.enableUserGroup(user_group.id,autoMethodHandler)}},admins:{create:function(){TS.api.call("subteams.createAuto",{type:"admin"},autoMethodHandler)},enable:function(){var user_group=_findAutoUserGroup("admin");if(!user_group)return;TS.user_groups.enableUserGroup(user_group.id,autoMethodHandler)}}};_$user_groups_form_div.off("click").on("click","a.user_group_auto_action",function(e){var $target=$(e.target);var type=$target.data("auto-type");var action=$target.data("auto-action");if(auto_methods[type]&&auto_methods[type][action]){auto_methods[type][action]();e.preventDefault();return false}})};var _switchToggleView=function(user_group,action){if(!user_group){TS.warn("Cannot switch toggle view to undefined user group");return}_$user_groups_toggle_div.html(TS.templates.user_group_toggle({action:action,user_group:user_group,show_delete:TS.boot_data.feature_subteams_hard_delete&&!user_group.auto_type&&!user_group.is_external}));_$user_groups_toggle_div.find('[data-action="cancel"]').on("click",_onReset);_$user_groups_toggle_div.find(".user_group_toggle_btn").on("click",function(e){var action=$(this).data("action");TS.user_groups[action](user_group.id,function(ok,data){if(_alertIfNotOk(ok,data))return;if(action==="enableUserGroup"){_enableUserGroup(user_group)}_onUpdateComplete()})});_$user_groups_toggle_div.find('[data-action="switch_delete_user_group"]').on("click",function(e){e.preventDefault();_switchToggleView(user_group,"delete_user_group")});_$all_user_groups.addClass("hidden");_$user_groups_toggle_div.removeClass("hidden");_bindBackButton()};var _enableUserGroup=function(user_group){var ug=TS.user_groups.getUserGroupsById(user_group.id);if(!ug)TS.user_groups.upsertUserGroup(TS.utility.clone(user_group))};var _switchSettingsFormView=function(user_group){_$user_groups_form_div.html(TS.templates.user_group_settings_form(user_group));var channels=TS.channels.getUnarchivedChannelsForUser().map(function(option){return{id:option.id,name:option.name}});var groups=TS.groups.getUnarchivedGroups().map(function(option){return{id:option.id,name:option.name,is_group:true}});var options=channels.concat(groups);if(user_group){var default_channels_groups=user_group.prefs.channels.concat(user_group.prefs.groups);default_channels_groups.forEach(function(item){for(var i=0;i<options.length;i++){if(item==options[i].id){options[i].selected=true;break}}})}$("#user_group_default_channels").filterSelect({data:options,template:function(item){if(item.is_group){return item.name}return"#"+item.name},placeholder_text:"Select the default channels for this user group (optional)",filter:function(item,query){var start_regex=new RegExp("^"+TS.utility.regexpEscape(query),"i");var prefix_regex=new RegExp("^"+TS.utility.regexpEscape(query.replace("#","")),"i");var suffix_regex=new RegExp("(-|_|\\+|\\s|\\.|#)"+TS.utility.regexpEscape(query),"i");return item.name.match(prefix_regex)||item.name.match(start_regex)||item.name.match(suffix_regex)}});_bindSettingsFormUI(user_group);_$all_user_groups.addClass("hidden");_$user_groups_form_div.removeClass("hidden");_bindBackButton()};var _bindSettingsFormUI=function(user_group){var save_function;var is_new;var user_group_id;if(user_group){save_function=TS.user_groups.updateUserGroup;is_new=false;user_group_id=user_group.id}else{save_function=TS.user_groups.createUserGroup;is_new=true}_$user_groups_form_div.find(".user_group_settings_form").on("submit",function(e){e.preventDefault();var name=$('input[name="name"]').val();var handle=$('input[name="handle"]').val();var description=$('input[name="description"]').val();var channels=$("#user_group_default_channels").filterSelect("value").map(function(channel){return channel.id});save_function({subteam:user_group_id,name:name,handle:handle,description:description,channels:channels},function(ok,data){if(_alertIfNotOk(ok,data))return;if(is_new){_temp_user_group=data.subteam;_switchMembersFormView(data.subteam,is_new)}else{_onUpdateComplete()}})});_$user_groups_form_div.find(".user_group_settings_form").on("reset",_onReset);var $button=$("#save_user_group");var $input=$("#user_group_name_input");function inputChange(){var value=$input.val();if(value&&value.length){$button.removeAttr("disabled")}else{$button.attr("disabled",true)}}if($button.length&&$input.length){$input.on("change",inputChange);$input.on("keyup",inputChange);inputChange()}};var _switchMembersFormView=function(user_group,is_new){var is_locked=!!user_group.is_external||!!user_group.auto_type;var options=TS.members.getMembersForUser().filter(_isFullMember).map(function(member){return{member:member}});var renderForm=function(){_$user_groups_form_div.html(TS.templates.user_group_members_form({is_new:is_new,is_locked:is_locked,user_group:user_group}))};var renderUI=function(){var $member_count=$("#member_count");var member_count=user_group.user_count||0;var updateForm=function(){var $button=$(is_new?"#create_group":"#save_group");if($button.length){if(member_count<1){$button.prop("disabled",true)}else{$button.prop("disabled",false)}}};$("#user_group_members_select").filterSelect({data:options,template:function(item){var html=TS.templates.user_group_invite_member_small(item);return new Handlebars.SafeString(html)},onItemAdded:function(item){member_count++;$member_count.html(member_count);updateForm()},onItemRemoved:function(item){member_count--;$member_count.html(member_count);updateForm()},filter:function(item,query){var member=item.member;if(query.charAt(0)==="@")query=query.substr(1);var start_regex=new RegExp("^"+TS.utility.regexpEscape(query),"i");var suffix_regex=new RegExp("(-|_|\\+|\\s|\\.|@)"+TS.utility.regexpEscape(query),"i");return TS.members.checkMemberMatch(member,start_regex)||TS.members.checkMemberMatch(member,suffix_regex)},disabled:!!user_group.is_external||!!user_group.auto_type});_bindMembersFormUI(user_group,is_new);_$all_user_groups.addClass("hidden");_$user_groups_form_div.removeClass("hidden");updateForm()};if(is_new){renderForm();TS.ui.fs_modal.hideBackButton();renderUI()}else{var selected_members;var work=function(){selected_members=user_group.users;selected_members.forEach(function(item){for(var i=0;i<options.length;i++){if(item==options[i].member.id){options[i].selected=true;break}}});renderForm();_bindBackButton();renderUI()};if(user_group.users===undefined){TS.user_groups.getUserGroupMembers(user_group.id,function(updated_group){if(updated_group&&updated_group.users){user_group=updated_group;return work()}})}else{return work()}}};var _bindMembersFormUI=function(user_group,is_new){_$user_groups_form_div.find(".user_group_members_form").on("submit",function(e){e.preventDefault();var members=$("#user_group_members_select").filterSelect("value").map(function(option){return option.member.id});TS.user_groups.updateMembersOfUserGroup({subteam:user_group.id,users:members},function(ok,data){if(_alertIfNotOk(ok,data))return;_temp_user_group=null;_onUpdateComplete()})});_$user_groups_form_div.find(".user_group_members_form").on("reset",function(e){e.preventDefault();if(is_new){if(TS.boot_data.feature_subteams_hard_delete){TS.user_groups.deleteUserGroup(user_group.id,function(ok,data){if(_alertIfNotOk(ok,data))return;_temp_user_group=null;_onReset(e)})}else{TS.user_groups.disableUserGroup(user_group.id,function(ok,data){if(_alertIfNotOk(ok,data))return;_temp_user_group=null;_onReset(e)})}}else{_onReset(e)}})};var _updateSearch=function(e){var $input=$(e.target);var value=$input.val();if(value!==_last_query){_last_query=value;_$icon_close.toggleClass("hidden",value==="");_refreshList()}};var _clearSearch=function(){var $input=$("#user_group_modal_search");_last_query="";$input.val("");setTimeout(function(){$input.focus()},0);_$icon_close.addClass("hidden");_refreshList()};var _refreshList=function(){var $list_div=$("#user_groups_list_div");var query=_last_query;var html;$("#user_groups_header .user_groups_search").toggleClass("hidden",!_user_groups.length);if(typeof query==="string"&&query.length){var user_groups=_user_groups.filter(function(ug){return ug.handle.indexOf(query)!==-1||ug._name_lc.indexOf(query)!==-1||ug.description&&ug.description.toLowerCase().indexOf(query)!==-1});if(user_groups.length){$list_div.html(TS.templates.builders.buildUserGroupListHTML(user_groups));if(_$monkey_scroll)_$monkey_scroll.updateFunc();return}var template_args={query:query,tab:{label:"user groups"}};html='<div class="no_results top_margin">'+TS.templates.team_list_no_results(template_args)+"</div>"}else{html=TS.templates.builders.buildUserGroupListHTML(_user_groups)}$list_div.html(html);if(_$monkey_scroll)_$monkey_scroll.updateFunc()};var _isFullMember=function(member){if(!member.deleted&&!member.is_ultra_restricted&&!member.is_restricted&&!(member.is_bot||member.is_slackbot)){return true}return false};var _getUserGroupFromId=function(id){if(id){for(var i=0;i<_user_groups.length;i++){if(_user_groups[i].id==id){return _user_groups[i]}}}return};var _last_query;var _$monkey_scroll;var _$icon_close})();(function(){"use strict";TS.registerModule("enterprise",{enterprise_domain_changed_sig:new signals.Signal,onStart:function(){if(TS.boot_data.page_needs_enterprise)_maybeSetupEnterpriseModel()},upsertAndSignal:function(enterprise){if(!TS.boot_data.page_needs_enterprise)TS.warn("Unexpected call to TS.enterprise.upsertAndSignal");if(!enterprise)return;var upsert=TS.enterprise.upsertEnterprise(enterprise);if(upsert.status=="CHANGED"){if(upsert.what_changed.indexOf("name")!=-1){TS.enterprise.enterprise_name_changed_sig.dispatch(upsert.enterprise)}}return upsert},upsertEnterprise:function(enterprise){if(!TS.boot_data.page_needs_enterprise)TS.warn("Unexpected call to TS.enterprise.upsertEnterprise");_maybeSetupEnterpriseModel();var existing_enterprise=TS.model.enterprise;var status="NOOP";var what_changed=[];if(enterprise){TS.log(4,'updating enterprise "'+enterprise.id+'"');for(var k in enterprise){if(existing_enterprise[k]!=enterprise[k]){if(k=="_teams"){if(enterprise._teams&&enterprise._teams.length){if(typeof enterprise._teams[0]==="object"){_mergeTeams(enterprise._teams)}else if(typeof enterprise._teams[0]==="string"){_deleteTeams(enterprise._teams)}what_changed.push(k);status="CHANGED"}}else if(k=="icon"){existing_enterprise[k]=enterprise[k];what_changed.push(k);status="CHANGED"}else if(existing_enterprise[k]!=enterprise[k]){if(enterprise[k]&&!TS.utility.isScalar(enterprise[k])){existing_enterprise[k]=enterprise[k];TS.warn(k+" is not scalar! it needs to be handled by upsertEnterprise specifically to test if it has changed! "+typeof enterprise[k])}else if(typeof enterprise[k]!="boolean"||!enterprise[k]!=!existing_enterprise[k]){existing_enterprise[k]=enterprise[k];what_changed.push(k);status="CHANGED"}}}}}return{status:status,enterprise:existing_enterprise,what_changed:what_changed}},promiseToEnsureEnterprise:function(){if(!TS.boot_data.page_needs_enterprise)TS.warn("Unexpected call to TS.enterprise.promiseToEnsureEnterprise");return Promise.all([TS.api.call("enterprise.info").reflect(),TS.api.call("enterprise.teams.list",{include_archived:false,include_deleted:false}).reflect()]).then(function(responses){var rejection_reasons=[];responses.forEach(function(response){if(response.isFulfilled())return;rejection_reasons.push(response.reason())});if(rejection_reasons.length){return Promise.reject(new Error("Some enterprise APIs failed:\n"+rejection_reasons.join("\n")))}else{var enterprise=responses[0].value().data.enterprise;enterprise._teams=responses[1].value().data.teams;TS.enterprise.upsertEnterprise(enterprise)}})}});var _maybeSetupEnterpriseModel=function(){if(TS.model.enterprise)return;TS.model.enterprise={};TS.model.enterprise._teams=[]};var _isEmpty=function(teams){if(teams&&teams.length)_.remove(teams,function(team){return!team});return!(teams&&teams.length)};var _getIndexForNewTeam=function(team){for(var i=TS.model.enterprise._teams.length;i>0;i--){if(TS.model.enterprise._teams[i-1].id<team.id)return i}return 0};var _mergeTeams=function(teams){if(_isEmpty(teams))return;var map=TS.model.enterprise._teams.reduce(function(accumulator,team){accumulator[team.id]=team;return accumulator},{});teams.forEach(function(team){var existing_team=map[team.id];if(existing_team){$.extend(true,existing_team,team)}else{TS.model.enterprise._teams.splice(_getIndexForNewTeam(team),0,team)}})};var _deleteTeams=function(teams){if(_isEmpty(teams))return;_.remove(TS.model.enterprise._teams,function(team){return teams.indexOf(team.id)!=-1})}})();(function(){"use strict";TS.registerModule("ui.email_healing",{onStart:function(){_bindEmailInputs()},test:function(){return{_correctEmailTypos:_correctEmailTypos}}});var _DEFAULT_DELAY=750;var _tld_mistakes={cmo:"com",con:"com",om:"com","com.com":"com",cm:"com",vom:"com",cim:"com",cpm:"com",ccom:"com",coom:"com",comm:"com",c:"com"};var _domain_mistakes={gmai:"gmail",gamil:"gmail",gmil:"gmail",gmial:"gmail",gmal:"gmail",gmaill:"gmail",gnail:"gmail",gamail:"gmail",gmsil:"gmail",yhoo:"yahoo",yahooo:"yahoo",yaho:"yahoo",homail:"hotmail",hotmaill:"hotmail",outook:"outlook",outlock:"outlook",otlook:"outlook",outlolk:"outlook"};var _bindEmailInputs=function(){$("body").on("input","[data-email-healing]",function(){var $email=$(this);clearTimeout($email.data("correct_email_typos_timer"));var delay=$email.attr("data-email-healing-delay");if(delay==="none"){_correctEmailTypos($email)}else{delay=parseInt(delay,10)||_DEFAULT_DELAY;delay=isNaN(delay)?_DEFAULT_DELAY:delay;var correct_email_typos_timer=setTimeout(function(){_correctEmailTypos($email)},delay);$email.data("correct_email_typos_timer",correct_email_typos_timer)}}).on("blur","[data-email-healing]",function(){var $email=$(this);clearTimeout($email.data("correct_email_typos_timer"));_correctEmailTypos($email)})};var _correctEmailTypos=function($email){if($email.attr("data-email-healing")!=="true")return;var has_typo=false;var $email_overlay=$email.siblings(".email_healing_overlay");var email_val=TS.utility.htmlEntities($email.val().trim());var shadow_val=email_val;var mistake;var regex;for(mistake in _tld_mistakes){regex=new RegExp("\\."+mistake+"$");if(regex.test(email_val)){has_typo=true;email_val=email_val.replace(regex,"."+_tld_mistakes[mistake]);shadow_val=shadow_val.replace(regex,'.<span class="seafoam_green">'+_tld_mistakes[mistake]+"</span>")}}for(mistake in _domain_mistakes){regex=new RegExp("@"+mistake+"\\.");if(regex.test(email_val)){has_typo=true;email_val=email_val.replace(regex,"@"+_domain_mistakes[mistake]+".");shadow_val=shadow_val.replace(regex,'@<span class="seafoam_green">'+_domain_mistakes[mistake]+"</span>.")}}if(has_typo){var delay=$email.attr("data-email-healing-delay");if(delay==="none"){$email.attr("data-email-healing","false").val(email_val)}else{var fade_in_duration=1e3;$email.attr("data-email-healing","false");$email_overlay.html(shadow_val).removeClass("hidden").addClass("fade_in_out");setTimeout(function(){$email.val(email_val);setTimeout(function(){$email_overlay.addClass("hidden")},fade_in_duration)},fade_in_duration)}}}})();(function(){"use strict";TS.registerModule("utility.search",{onStart:function(){},makeClause:function(type,value,field_id){if(_validateClauseParameters(type,value,field_id))return;var clause={type:type.toLowerCase(),value:value};if(field_id)clause.field_id=field_id;return clause},makeConjunction:function(type,clauses){if(_validateConjunctionParameters(type,clauses))return;return{type:type.toLowerCase(),clauses:clauses}},promiseToSearch:function(args){if(!args||!args.query)return Promise.reject(new Error("cannot search without arguments and a query"));if(args.all_of_org&&!TS.boot_data.page_needs_enterprise)return Promise.reject(new Error("cannot search an org when not an enterprise team"));
var calling_args={query:JSON.stringify(args.query)};["sort","sort_direction","count","cursor_mark"].forEach(function(key){if(args[key])calling_args[key]=args[key]});return TS.api.call(args.all_of_org?"search.team":"search.enterprise",calling_args).catch(_handleError)}});var _validateClauseParameters=function(type,value,field_id){if(!type)return void TS.error("cannot make a clause without a type");if(!value)return void TS.error("cannot make a clause without a value");if(type==="custom"&&!field_id)return void TS.error("cannot make a custom type clause without a field id")};var _validateConjunctionParameters=function(type,clauses){if(!type)return void TS.error("cannot make a conjunction without an 'and' or 'or' type");if(!clauses||clauses.length<2)return void TS.error("cannot make a conjunction without at least two clauses")};var _handleError=function(error){TS.error(error.data.error+" error occured while searching");TS.generic_dialog.alert("Sorry! Something went wrong. Please try again.");throw error}})();
