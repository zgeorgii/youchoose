(function(){"use strict";TS.registerModule("generic_dialog",{div:null,is_showing:false,default_setting:{title:"",body:"BODY",body_template:null,show_go_button:true,show_secondary_go_button:false,show_cancel_button:true,go_button_text:"OK",go_button_class:"",secondary_go_button_text:"OK 2",secondary_go_button_class:"",cancel_button_text:"Cancel",onGo:null,onSecondaryGo:null,onCancel:null,onEnd:null,show_throbber:false,esc_for_ok:false,onShow:null,force_small:false,enter_always_gos:false,fullscreen:false},current_setting:null,body_template_html:{},Q:[],onStart:function(){TS.generic_dialog.body_template_html["generic_dialog_sample"]=TS.templates.generic_dialog_sample()},onKeydown:function(e){var current_setting=TS.generic_dialog.current_setting;if(e.which==TS.utility.keymap.enter){if(TS.utility.getActiveElementProp("NODENAME")=="BODY"||current_setting.enter_always_gos){if(current_setting.show_go_button){TS.generic_dialog.go();e.preventDefault()}}}else if(e.which==TS.utility.keymap.esc){if(TS.utility.getActiveElementProp("NODENAME")=="BODY"){if(current_setting.show_cancel_button){TS.generic_dialog.cancel()}else if(current_setting.esc_for_ok){TS.generic_dialog.go()}}}},alert:function(txt,title,go_button_text){return new Promise(function(resolve){TS.generic_dialog.start({title:title||"",body:txt,show_cancel_button:false,esc_for_ok:true,fullscreen:false,go_button_text:go_button_text,onGo:resolve})})},start:function(setting){if(setting.fullscreen){TS.ui.fs_modal.start(setting);return}if(TS.generic_dialog.is_showing){if(setting.unique&&TS.generic_dialog.current_setting.unique==setting.unique){TS.info("redundant generic dialog not Qed: "+setting.unique)}else{TS.generic_dialog.Q.push(setting)}return}var current_setting=TS.generic_dialog.current_setting=$.extend(TS.utility.clone(TS.generic_dialog.default_setting),setting);if(typeof setting.show_close_button==="undefined"){current_setting.show_close_button=current_setting.show_cancel_button}if(!TS.generic_dialog.div)TS.generic_dialog.build();var div=TS.generic_dialog.div;var body_html=current_setting.body;if(current_setting.body_template){if(TS.generic_dialog.body_template_html[current_setting.body_template]){body_html=TS.generic_dialog.body_template_html[current_setting.body_template];if(current_setting.body){TS.warn("both body and body_template were passed on settings, using body_template")}}else{TS.error(current_setting.body_template+" not found in TS.generic_dialog.body_template_html")}}var html=TS.templates.generic_dialog({title:current_setting.title,body:body_html});div.empty();div.html(html);div.find(".close").bind("click",function(){if(current_setting.show_cancel_button){TS.generic_dialog.cancel()}else if(current_setting.esc_for_ok){TS.generic_dialog.go()}});div.find(".dialog_go").click(TS.generic_dialog.go);div.find(".dialog_go").html(current_setting.go_button_text);if(current_setting.show_go_button){div.find(".dialog_go").removeClass("hidden").addClass(current_setting.go_button_class)}else{div.find(".dialog_go").addClass("hidden")}div.find(".dialog_secondary_go").click(TS.generic_dialog.secondaryGo);div.find(".dialog_secondary_go").html(current_setting.secondary_go_button_text);if(current_setting.show_secondary_go_button){div.find(".dialog_secondary_go").removeClass("hidden").addClass(current_setting.secondary_go_button_class)}else{div.find(".dialog_secondary_go").addClass("hidden")}div.find(".dialog_cancel").click(TS.generic_dialog.cancel);div.find(".dialog_cancel").html(current_setting.cancel_button_text);div.find(".dialog_cancel").toggleClass("hidden",!current_setting.show_cancel_button);div.find(".close").toggleClass("hidden",!current_setting.show_close_button);if(current_setting.show_throbber){div.find(".throbber").removeClass("hidden")}else{div.find(".throbber").addClass("hidden")}if(current_setting.title){div.find(".modal-header").removeClass("hidden")}else{div.find(".modal-header").addClass("hidden")}if(!current_setting.show_go_button&&!current_setting.show_secondary_go_button&&!current_setting.show_cancel_button){div.find(".modal-footer").addClass("hidden")}else{div.find(".modal-footer").removeClass("hidden")}div.modal("show");if(current_setting.title||current_setting.force_small){div.removeClass("small")}else{div.addClass("small");div.css("margin-left",-div.width()/2)}if(document.activeElement&&document.activeElement!=document.body){document.activeElement.blur()}if(current_setting.onShow){current_setting.onShow()}},go:function(){if(!TS.generic_dialog.is_showing){TS.error("not showing?");return}var current_setting=TS.generic_dialog.current_setting;var div=TS.generic_dialog.div;if(current_setting.onGo){if(current_setting.onGo()!==false){div.modal("hide")}}else{div.modal("hide")}},secondaryGo:function(e){if(!TS.generic_dialog.is_showing){TS.error("not showing?");return}var current_setting=TS.generic_dialog.current_setting;var div=TS.generic_dialog.div;if(current_setting.onSecondaryGo){if(current_setting.onSecondaryGo(e)!==false){div.modal("hide")}}else{div.modal("hide")}},cancel:function(){var current_setting=TS.generic_dialog.current_setting;TS.generic_dialog.div.modal("hide");if(current_setting.onCancel){current_setting.onCancel()}},end:function(){var current_setting=TS.generic_dialog.current_setting;TS.generic_dialog.is_showing=TS.model.dialog_is_showing=false;$(window.document).unbind("keydown",TS.generic_dialog.onKeydown);TS.generic_dialog.div.empty();if(current_setting.onEnd){current_setting.onEnd()}if(!TS.generic_dialog.is_showing&&TS.generic_dialog.Q.length){var o=TS.generic_dialog.Q.shift();TS.generic_dialog.start(o)}},build:function(){$("body").append('<div id="generic_dialog" class="modal hide fade" data-keyboard="false" data-backdrop="static"></div>');var div=TS.generic_dialog.div=$("#generic_dialog");div.on("hidden",function(e){if(e.target!=this)return;setTimeout(function(){TS.generic_dialog.end();div.removeAttr("data-qa")},200)});div.on("show",function(e){if(e.target!=this)return;TS.generic_dialog.is_showing=TS.model.dialog_is_showing=true});div.on("shown",function(e){if(e.target!=this)return;setTimeout(function(){if(!TS.generic_dialog.is_showing)return;div.find(".title_input").select();$(window.document).bind("keydown",TS.generic_dialog.onKeydown);div.attr("data-qa","generic_dialog_ready")},100)})}})})();(function(){"use strict";TS.registerModule("sidebar_themes",{default_themes:{default_theme:{column_bg:"#4D394B",menu_bg:"#3E313C",active_item:"#4C9689",active_item_text:"#FFFFFF",hover_item:"#3E313C",text_color:"#FFFFFF",active_presence:"#38978D",badge:"#EB4D5C"},hoth_theme:{column_bg:"#F8F8FA",menu_bg:"#F8F8FA",active_item:"#CAD1D9",active_item_text:"#FFFFFF",hover_item:"#FFFFFF",text_color:"#383F45",active_presence:"#60D156",badge:"#FF8669"},monument_theme:{column_bg:"#0D7E83",menu_bg:"#076570",active_item:"#F79F66",active_item_text:"#FFFFFF",hover_item:"#D37C71",text_color:"#FFFFFF",active_presence:"#F79F66",badge:"#F15340"},chocolate_theme:{column_bg:"#544538",menu_bg:"#42362B",active_item:"#5DB09D",active_item_text:"#FFFFFF",hover_item:"#4A3C30",text_color:"#FFFFFF",active_presence:"#FFFFFF",badge:"#5DB09D"},ocean_theme:{column_bg:"#303E4D",menu_bg:"#2C3849",active_item:"#6698C8",active_item_text:"#FFFFFF",hover_item:"#4A5664",text_color:"#FFFFFF",active_presence:"#94E864",badge:"#78AF8F"},workhard_theme:{column_bg:"#4D5250",menu_bg:"#444A47",active_item:"#D39B46",active_item_text:"#FFFFFF",hover_item:"#434745",text_color:"#FFFFFF",active_presence:"#99D04A",badge:"#DB6668"},solanum_theme:{column_bg:"#4F2F4C",menu_bg:"#452842",active_item:"#8C5888",active_item_text:"#FFFFFF",hover_item:"#3E313C",text_color:"#FFFFFF",active_presence:"#D0FF00",badge:"#889100"},brinjal_theme:{column_bg:"#4F2F4C",menu_bg:"#452842",active_item:"#8C5888",active_item_text:"#FFFFFF",hover_item:"#3E313C",text_color:"#FFFFFF",active_presence:"#00FFB7",badge:"#DE4C0D"},cotton_theme:{column_bg:"#BB6A76",menu_bg:"#AD5B67",active_item:"#62B791",active_item_text:"#FFFFFF",hover_item:"#A5516A",text_color:"#FFFFFF",active_presence:"#68F798",badge:"#694464"},eco_theme:{column_bg:"#86A34E",menu_bg:"#94AF63",active_item:"#FFFFFF",active_item_text:"#6D8B42",hover_item:"#94AF63",text_color:"#FFFFFF",active_presence:"#FFB10A",badge:"#DFA044"}},onStart:function(){if(TS.client)TS.client.login_sig.add(TS.sidebar_themes.onLogin,TS.sidebar_themes)},onLogin:function(ok,data){if(TS.model.prefs.sidebar_theme)TS.prefs.sidebar_theme_changed_sig.dispatch()}})})();(function(){"use strict";TS.registerModule("ui.tabs",{instances:[],onStart:function(){},create:function(element){if(!element){return false}return new Tabs(element)}});function Tabs(element,config){if(typeof element==="undefined"){return null}this.element=element;var _tabs=_retrieveTabs(element);var _panels=_retrievePanels(_tabs);this.element.on("click",".tab",function(){return _activate(this,element,_tabs,_panels).bind(this)});_activate(_tabs[0],element,_tabs,_panels);return this}Tabs.prototype.destroy=function(){this.element.off();this.element.remove()};function _retrievePanels(tabs){if(typeof tabs==="undefined"){return[]}return tabs.map(function(index,item){return $(item).attr("href")}).map(function(index,id){return $(id)})}function _retrieveTabs(element){if(typeof element==="undefined"){return[]}return element.find(".tab").map(function(index,item){return $(item)})}function _activate(tab,element,tabs,panels){if(typeof tab==="undefined"){return false}panels.map(function(index,$item){return $item.removeClass("active")});tabs.map(function(index,$tab){return $tab.removeClass("active")});$(tab).addClass("active");var target=$(tab).attr("href");return $(target).addClass("active")}$(document).on("click",".tab",function(e){e.preventDefault()})})();(function(){"use strict";TS.registerModule("help_dialog",{div:null,showing:false,last_tab:null,last_issue_screen:null,onStart:function(){TS.help.issues_sorted_sig.add(TS.help_dialog.onIssuesSorted);TS.help_dialog.just_docs=TS.qs_args["just_docs"]!="0"},onKeydown:function(e){if(!TS.help_dialog.showing)return;if(e.which==TS.utility.keymap.enter&&TS.utility.cmdKey(e)){if(TS.utility.getActiveElementProp("id")=="issue_reply_text"){TS.help_dialog.replyToIssue();e.preventDefault()}else if(TS.utility.getActiveElementProp("id")=="issue_new_text"){TS.help_dialog.createIssue();e.preventDefault()}}else if(e.which==TS.utility.keymap.esc){if(TS.utility.getActiveElementProp("NODENAME")=="BODY"&&TS.help_dialog.last_issue_screen!="new"&&TS.help_dialog.last_issue_screen!="reply"){TS.help_dialog.cancel()}}},start:function(tab,highlight_selector){tab=tab||TS.help_dialog.last_tab;if(TS.help_dialog.just_docs){if(tab=="issues")tab="docs"}if(!TS.help_dialog.div)TS.help_dialog.build();if(TS.help_dialog.showing)return;var div=TS.help_dialog.div;var html=TS.templates.help_dialog({member:TS.model.user,issue_list_html:TS.help_dialog.buildIssueListHTML(),more_url:TS.help.more_url,max_title_chars:TS.help.max_title_chars});div.empty();div.html(html);div.find(".dialog_tabs a").bind("click",function(e){var $tab=$(this);div.find(".dialog_tabs a").removeClass("active");div.find(".dialog_tab_pane").removeClass("active");$tab.addClass("active");$("#"+$tab.data("pane-id")).addClass("active");TS.help_dialog.last_tab=$tab.data("which");TS.client.ui.updateClosestMonkeyScroller($("#help_docs_scroller"));TS.client.ui.updateClosestMonkeyScroller($("#help_issues_scroller"));if(TS.help_dialog.last_tab=="docs"){}else{div.find(".modal-footer").removeClass("hidden")}});if(tab=="issues"){$("#help_issues_tab").trigger("click")}else{$("#help_docs_tab").trigger("click")}$("#help_issues_list").bind("click",function(e){var $el=$(e.target);var issue_id=$el.closest(".issue_list_div").data("issue-id");if(!issue_id)return;TS.help_dialog.showIssue(issue_id)});$("#new_issue_submit_btn").bind("click",TS.help_dialog.createIssue);$("#new_issue_cancel_btn").bind("click",TS.help_dialog.showIssueList);$("#new_issue_btn").click(TS.help_dialog.showNewIssueForm);$("#issue_resolved_btn").bind("click",TS.help_dialog.markIssueResolved);$("#issue_back_btn").bind("click",TS.help_dialog.showIssueList);$("#issue_reply_btn").bind("click",TS.help_dialog.showIssueReplyForm);$("#issue_reply_submit_btn").bind("click",TS.help_dialog.replyToIssue);$("#issue_reply_cancel_btn, #issue_reply_title").bind("click",function(){TS.help_dialog.showIssue()});TS.help_dialog.last_issue_screen="list";TS.help_dialog.getElsForScreen("new").addClass("hidden");TS.help_dialog.getElsForScreen("issue").addClass("hidden");TS.help_dialog.getElsForScreen("reply").addClass("hidden");$("#issues_overlaid_throbber").addClass("hidden");$("#issue_new_title").bind("textchange",function(e,prev_txt){var input=$(this);var val=input.val();if(val.length>TS.help.max_title_chars){input.val(val.substr(0,TS.help.max_title_chars))}});if(TS.help_dialog.just_docs){$("#help_dialog").find(".with_tabs").removeClass("with_tabs");$("#help_dialog").find(".dialog_tabs").addClass("hidden");$("#help_dialog").find(".no_tabs_title").removeClass("hidden");$("#help_dialog").find("#cant_find").removeClass("hidden")}TS.help_dialog.updateDocsTab();div.modal("show")},updateDocsTab:function(){if(!TS.help_dialog.just_docs)return;var unread_count=0;var open_count=0;var all_count=TS.help.issues.length;var issue;for(var i=0;i<TS.help.issues.length;i++){issue=TS.help.issues[i];if(issue.state=="unread"){unread_count++}else if(issue.state=="open"){open_count++}}$("#help_dialog").find("#no_open_issues, #unread_issues, #open_issues, #unread_issues_many, #unread_issues_singular, #open_issues_many, #open_issues_singular").addClass("hidden");if(all_count){$("#no_open_issues").removeClass("hidden")}else{$("#cant_find").removeClass("hidden");$("#help_divider").addClass("hidden")}if(unread_count){$("#unread_issues").removeClass("hidden");$("#help_divider").removeClass("hidden");$("#no_open_issues").addClass("hidden");if(unread_count>1){$("#unread_issues_count_txt").text(unread_count);$("#unread_issues_many").removeClass("hidden")}else{$("#unread_issues_singular").removeClass("hidden")}}else if(open_count){$("#open_issues").removeClass("hidden");$("#help_divider").removeClass("hidden");$("#no_open_issues").addClass("hidden");if(open_count>1){$("#open_issues_count_txt").text(open_count);$("#open_issues_many").removeClass("hidden")}else{$("#open_issues_singular").removeClass("hidden")}}},onIssuesSorted:function(){if(!TS.help_dialog.showing)return;TS.help_dialog.updateDocsTab();$("#help_issues_list").html(TS.help_dialog.buildIssueListHTML())},buildIssueListHTML:function(){var html="";var issue;for(var i=0;i<TS.help.issues.length;i++){issue=TS.help.issues[i];html+=TS.templates.issue_list_item({issue:issue})}return html},getElsForScreen:function(screen){if(screen=="list")return $("#help_issues_list, #help_issues_list_btns");if(screen=="new")return $("#help_issue_new_form_div, #help_issue_new_form_btns");if(screen=="issue")return $("#help_issue_div, #help_issue_btns");if(screen=="reply")return $("#help_issue_reply_form_div, #help_issue_reply_form_btns");return $("#wtfjones")},startWorking:function(){$("#issues_overlaid_throbber").removeClass("hidden").css("opacity",0).transition({opacity:1},200);$("#help_dialog .modal-footer").find(".btn.disable_when_working").addClass("disabled")},stopWorking:function(){$("#issues_overlaid_throbber").transition({opacity:0},100).delay(100).addClass("hidden");$("#help_dialog .modal-footer").find(".btn").removeClass("disabled")},showIssueScreen:function(screen,and_then){var $el_to_hide=TS.help_dialog.getElsForScreen(TS.help_dialog.last_issue_screen);var $el_to_show=TS.help_dialog.getElsForScreen(screen);$el_to_hide.transition({opacity:0},100,function hideTransitionComplete(){if(hideTransitionComplete.run)return;hideTransitionComplete.run=true;if(!TS.help_dialog.showing)return;$el_to_hide.addClass("hidden");$el_to_show.removeClass("hidden").css("opacity",0).transition({opacity:1},100,function showTransitionComplete(){if(showTransitionComplete.run)return;showTransitionComplete.run=true;if(!TS.help_dialog.showing)return;if(and_then){and_then()}TS.client.ui.updateClosestMonkeyScroller($("#help_issues_scroller"))})});TS.help_dialog.last_issue_screen=screen},showIssueList:function(){TS.help_dialog.showIssueScreen("list")},showIssueReplyForm:function(){var issue=TS.help.getIssueById(TS.help_dialog.last_issue_id);if(!issue)return;$("#issue_reply_title").text(issue.title);$("#issue_reply_footer").html(TS.templates.help_issue_reply_comments({issue:issue}));TS.client.ui.updateClosestMonkeyScroller($("#help_issues_scroller"));TS.help_dialog.showIssueScreen("reply",function(){$("#issue_reply_text").focus();TS.client.ui.updateClosestMonkeyScroller($("#help_issues_scroller"))})},showNewIssueForm:function(){TS.help_dialog.showIssueScreen("new",function(){$("#issue_new_title").focus()})},showIssue:function(id){var issue=TS.help.getIssueById(id);var and_then;if(id&&!issue){return}if(issue){TS.help_dialog.last_issue_id=id;TS.help_dialog.startWorking();$("#help_issue_div").empty();and_then=function(){TS.help.fetchIssueDetails(id,function(ok,issue,err_str){if(!TS.help_dialog.showing)return;if(!ok){TS.generic_dialog.alert("Failed to retrieve the request details.<br><br>"+err_str);TS.help_dialog.stopWorking();TS.help_dialog.showIssueList();return}setTimeout(function(){if(!TS.help_dialog.showing)return;TS.help.markIssueRead(id,function(ok,err_str){if(!TS.help_dialog.showing)return;$("#help_issue_div").html(TS.templates.help_issue_div({issue:issue,show_comments:true}));TS.client.ui.updateClosestMonkeyScroller($("#help_issues_scroller"));TS.help_dialog.stopWorking()});if(issue.state=="resolved"||issue.is_closed){$("#issue_resolved_btn").addClass("hidden")}else{$("#issue_resolved_btn").removeClass("hidden")}if(issue.is_closed){$("#issue_reply_btn").addClass("hidden")}else{$("#issue_reply_btn").removeClass("hidden")}},1e3)});$("#help_issue_div").html(TS.templates.help_issue_div({issue:issue}));TS.client.ui.updateClosestMonkeyScroller($("#help_issues_scroller"))}}TS.help_dialog.showIssueScreen("issue",and_then)},markIssueResolved:function(){TS.help_dialog.startWorking();TS.help.markIssueResolved(TS.help_dialog.last_issue_id,function(ok,err_str){if(!TS.help_dialog.showing)return;if(!ok){TS.generic_dialog.alert("Failed to mark the request resolved.<br><br>"+err_str)}TS.help_dialog.stopWorking();TS.help_dialog.showIssueList()})},createIssue:function(){var text=$("#issue_new_text").val();var title=$("#issue_new_title").val()||"";if(title.length>TS.help.max_title_chars){TS.info("too long");return}if(!text){return}if(!title){title=text.substr(0,50)}var args={title:title,text:text};TS.help_dialog.startWorking();TS.help.createIssue(args,function(ok,err_str){if(!TS.help_dialog.showing)return;TS.help_dialog.stopWorking();if(!ok){TS.generic_dialog.alert("Failed to create request.<br><br>"+err_str)}else{TS.help_dialog.showIssueList();$("#issue_new_text").val("");$("#issue_new_title").val("")}})},replyToIssue:function(){var text=$("#issue_reply_text").val();if(!text){return}TS.help_dialog.startWorking();TS.help.replyToIssue(TS.help_dialog.last_issue_id,text,function(ok,err_str,err_code){if(!TS.help_dialog.showing)return;TS.help_dialog.stopWorking();if(!ok){if(err_code=="ticket_closed"){TS.generic_dialog.alert("Failed to add comment.<br><br>"+err_str)}else{TS.generic_dialog.alert("Failed to add comment.<br><br>"+err_str)}}else{TS.help_dialog.showIssue(TS.help_dialog.last_issue_id);$("#issue_reply_text").val("")}})},go:function(){if(!TS.help_dialog.showing){TS.error("not showing?");return}var div=TS.help_dialog.div;div.modal("hide")},cancel:function(){TS.help_dialog.div.modal("hide")},end:function(){TS.help_dialog.showing=TS.model.dialog_is_showing=false;$(window.document).unbind("keydown",TS.help_dialog.onKeydown)},build:function(){$("body").append('<div id="help_dialog" class="modal hide fade"></div>');var div=TS.help_dialog.div=$("#help_dialog");div.on("hide",function(e){if(e.target!=this)return;TS.help_dialog.end()});div.on("show",function(e){if(e.target!=this)return;TS.help_dialog.showing=TS.model.dialog_is_showing=true});div.on("shown",function(e){if(e.target!=this)return;$(window.document).bind("keydown",TS.help_dialog.onKeydown);TS.client.ui.updateClosestMonkeyScroller($("#help_issues_scroller"));TS.client.ui.updateClosestMonkeyScroller($("#help_docs_scroller"))})}})})();(function(){"use strict";TS.registerModule("ui.comments",{editing_file:null,editing_comment:null,editing:false,$edit_form:null,bound:false,onStart:function(){TS.ui.comments.$edit_form=$("#file_edit_comment_form");var $file_comment=$("#file_comment");$file_comment.one("focus.uicomments",function(){TS.ui.comments.bindInput($file_comment)})},bindInput:function(input,callback){input.TS_tabComplete({complete_cmds:false,complete_channels:true,complete_emoji:true,complete_member_specials:false,onComplete:function(txt){TS.utility.populateInput(input,txt)}});input.bind("keydown.cmd_submit",function(e){if(e.which===TS.utility.keymap.enter){if(input.tab_complete_ui("isShowing")){e.preventDefault();return}if(TS.model.prefs.enter_is_special_in_tbt&&TS.utility.isCursorWithinTBTs(input)){if(e.shiftKey){$(this).closest("form").submit();e.preventDefault()}return}if(!e.shiftKey&&!e.altKey&&!e.ctrlKey){if(callback){callback()}else{$(this).closest("form").submit()}e.preventDefault()}}});input.tab_complete_ui({id:"comment_input_tab_ui",min_width:300,narrow:!!TS.client,no_model_ob:true,scroll_with_element:!!TS.client})},unbindInput:function($input){if(!$input)return;$input.unbind("keydown.cmd_submit");$input.removeData()},bindEditForm:function(){TS.ui.comments.bound=true;var $edit_form=TS.ui.comments.$edit_form;$("#file_edit_comment").css("overflow","hidden").autogrow();TS.ui.comments.bindInput($("#file_edit_comment"));$edit_form.unbind("submit").bind("submit",TS.ui.comments.submitEditForm);$edit_form.find(".save").unbind("click").bind("click",function(e){TS.ui.comments.submitEditForm();return false});$edit_form.find(".cancel").unbind("click").bind("click",function(e){TS.ui.comments.onEndEdit();return false});$edit_form.unbind("destroyed").bind("destroyed",function(){$("#file_comment_form").after($(this)[0].outerHTML);TS.ui.comments.$edit_form=$("#file_edit_comment_form");TS.ui.comments.bound=false;if(!TS.ui.comments.editing)return;TS.ui.comments.onEndEdit()})},submitEditForm:function(){var val=$("#file_edit_comment").val();if(!$.trim(val)){if(TS.client)TS.sounds.play("beep");return false}TS.ui.comments.saveEdit();return false},startEdit:function(file_id,comment_id,$originated_from){if(TS.ui.comments.editing){TS.ui.comments.onEndEdit()}var file=TS.files.getFileById(file_id);if(!file){TS.error("no file?");return null}var comment=TS.files.getFileCommentById(file,comment_id);if(!comment){TS.error("no comment?");return null}var $edit_form=TS.ui.comments.$edit_form;var $comment_div;if(!$originated_from){$comment_div=$("#"+comment.id)}else{$comment_div=$originated_from.closest(".comment")}if(!$comment_div.length){TS.error("no #"+comment.id+"?");return}$comment_div.addClass("comment_editing").append($edit_form);$("#file_edit_comment").val("").css("height","");if(!TS.ui.comments.bound){TS.ui.comments.bindEditForm()}$edit_form.removeClass("hidden");$("#file_edit_comment").val(TS.format.unFormatMsg(comment.comment)).focus().setCursorPosition(1e6).trigger("keyup");$("#file_comment_form").css("visibility","hidden");TS.ui.comments.editing=true;TS.ui.comments.editing_file=file;TS.ui.comments.editing_comment=comment},saveEdit:function(){var file=TS.ui.comments.editing_file;var comment=TS.ui.comments.editing_comment;var $comment_bodies=$('.comment[data-comment-id="'+comment.id+'"] .comment_body');var val=TS.format.cleanMsg($("#file_edit_comment").val());if(val!=comment.comment){var was_comment=comment.comment;comment.comment=val;if($comment_bodies.length){$comment_bodies.html(TS.format.formatJustText(comment.comment))}TS.api.call("files.comments.edit",{file:file.id,id:comment.id,comment:val},function(ok,data,args){if(!ok){comment.comment=was_comment;if($comment_bodies.length){$comment_bodies.html(TS.format.formatJustText(comment.comment))}alert("save failed")}})}TS.ui.comments.onEndEdit()},onEndEdit:function(){var comment=TS.ui.comments.editing_comment;if(!comment)return;TS.ui.comments.$edit_form.addClass("hidden");$('[data-comment-id="'+comment.id+'"].comment_editing').removeClass("comment_editing");$("#file_comment_form").css("visibility","");TS.ui.comments.editing=false;TS.ui.comments.editing_file=null;TS.ui.comments.editing_comment=null},startDelete:function(file_id,comment_id){var file=TS.files.getFileById(file_id);if(!file){TS.error("no file?");return null}var comment=TS.files.getFileCommentById(file,comment_id);if(!comment){TS.error("no comment?");return null}TS.generic_dialog.start({title:"Delete a file comment",body:"<p>Are you sure you want to delete this comment? This cannot be undone.</p>"+TS.templates.builders.buildCommentHTML({comment:comment,file:file,show_comment_actions:false,hide_star:true}),go_button_text:"Yes, delete the comment",go_button_class:"btn_danger",onGo:function(){TS.ui.comments.commitDelete(file_id,comment_id)}})},commitDelete:function(file_id,comment_id){var file=TS.files.getFileById(file_id);if(!file){TS.error("no file?");return null}var comment=TS.files.getFileCommentById(file,comment_id);if(!comment){TS.error("no comment?");return null}TS.api.call("files.comments.delete",{file:file_id,id:comment_id},function(ok,data,args){if(ok){if(TS.client){}else{TS.files.deleteCommentOnFile(comment.id,file)}}else{if(data.error=="comment_not_found"){TS.files.deleteCommentOnFile(comment.id,file)}}})},removeFileComment:function(file,comment_id,completeFunc){$('.comment[data-comment-id="'+comment_id+'"]').slideUp(200,function(){var parent_node=this.parentNode;$(this).remove();if(parent_node.innerHTML.match(/^[\s\r\n]*$/))$(parent_node).empty();if(typeof completeFunc==="function")completeFunc.apply(this,arguments)})}})})();(function(){"use strict";TS.registerModule("ds.msg_handlers",{onStart:function(){TS.ds.on_msg_sig.add(_msgReceived)},hello:function(imsg){TS.model.members.forEach(function(member){member.ds_active=false});if(!imsg.active||!imsg.active.length)return;var member;for(var i=0;i<imsg.active.length;i++){member=TS.members.getMemberById(imsg.active[i]);if(!member){TS.error('unknown member: "'+imsg.active[i]+'"');return}member.ds_active=true}},presence_change:function(imsg){var member=TS.members.getMemberById(imsg.user);if(!member){TS.error('unknown member: "'+imsg.user+'"');return}if(imsg.presence!="away"&&imsg.presence!="active"){TS.error('unknown presence: "'+imsg.presence+'"');return}if(member.ds_active&&imsg.presence=="active")return;if(!member.ds_active&&imsg.presence=="away")return;member.ds_active=imsg.presence=="active";TS.members.ds_presence_changed_sig.dispatch(member)}});var _msgReceived=function(imsg){if(imsg.reply_to)return;if(imsg.event=="rocket")return;if(!TS.ds.msg_handlers[imsg.type]){TS.error("non handled non rocket event received\n"+JSON.stringify(imsg,null,"  "));return}TS.ds.msg_handlers[imsg.type](imsg)}})();(function(){"use strict";TS.registerModule("inline_audios",{no_scrolling:false,onStart:function(){},shouldExpand:function(container_id,inline_audio){if(TS.model.expandable_state["aud_"+container_id+TS.utility.htmlEntities(inline_audio.src)])return true;if(TS.model.expandable_state["aud_"+container_id+TS.utility.htmlEntities(inline_audio.src)]===false)return false;if(inline_audio.internal_file_id)return TS.model.prefs.expand_internal_inline_imgs;return TS.model.prefs.expand_inline_imgs},expandAllInCurrent:function(){TS.inline_audios.no_scrolling=true;$(".msg_inline_audio_expander").trigger("click");TS.inline_audios.no_scrolling=false;if(TS.client){TS.client.ui.instaScrollMsgsToBottom(false)}},collapseAllInCurrent:function(){$(".msg_inline_audio_collapser").trigger("click")},expand:function(container_id,src){TS.model.expandable_state["aud_"+container_id+TS.utility.htmlEntities(src)]=true;TS.storage.storeExpandableState(TS.model.expandable_state);var selector="#"+TS.utility.makeSafeForDomId(container_id);var $el=$(selector);if(!$el.length)return;var was_at_bottom=TS.client&&TS.client.ui.areMsgsScrolledToBottom();var filter=function(i){return $(this).data("real-src")==src};var $holder=TS.boot_data.feature_attachments_inline?$el.find(".inline_attachment").filter(filter):null;if(!$holder||!$holder.length)$holder=$el.find(".msg_inline_audio_holder").filter(filter);$holder.removeClass("hidden");$el.find(".msg_inline_audio_expander").filter(filter).addClass("hidden");$el.find(".msg_inline_audio_collapser").filter(filter).removeClass("hidden");if(TS.client)TS.client.ui.checkInlineImgsAndIframesEverywhere();$holder.css("opacity",0).stop().animate({opacity:1},300);if(!TS.inline_audios.no_scrolling){if(TS.client&&was_at_bottom){TS.client.ui.instaScrollMsgsToBottom(false);$el.children().first().scrollintoview({duration:0,offset:"top",px_offset:10,direction:"y"})}else{$el.find(".msg_inline_audio").last().scrollintoview({duration:200,offset:"bottom",px_offset:-10,direction:"y"})}}if(TS.client)TS.client.ui.checkInlineImgsAndIframesEverywhere()},collapse:function(container_id,src){TS.model.expandable_state["aud_"+container_id+TS.utility.htmlEntities(src)]=false;TS.storage.storeExpandableState(TS.model.expandable_state);var selector="#"+TS.utility.makeSafeForDomId(container_id);var $el=$(selector);if(!$el.length)return;var filter=function(i){return $(this).data("real-src")==src};var $holder=TS.boot_data.feature_attachments_inline?$el.find(".inline_attachment").filter(filter):null;if(!$holder||!$holder.length)$holder=$el.find(".msg_inline_audio_holder").filter(filter);$holder.css("visibility","hidden");$el.find(".msg_inline_audio_expander").filter(filter).removeClass("hidden");$el.find(".msg_inline_audio_collapser").filter(filter).addClass("hidden");$holder.find(".msg_inline_audio_iframe_div").html("");setTimeout(function(){$holder.addClass("hidden");$holder.css("visibility","visible")},200)},checkForInlineAudioClick:function(e,match){if(!e.target)return;var $el=$(e.target);var container_id;if(TS.boot_data.feature_message_replies){var $message=$el.closest(".message");container_id=$message.attr("id");if(!container_id)return}else{var msg_id=$el.closest(".message").data("ts");container_id=TS.templates.makeMsgDomId(msg_id);if(!msg_id&&match){msg_id=$el.closest(".search_message_result").data("ts");container_id=TS.templates.makeMSRDomId(match)}if(!msg_id)return}var $msg_inline_audio_expander=$el.closest(".msg_inline_audio_expander");if($msg_inline_audio_expander.length){e.preventDefault();TS.inline_audios.expand(container_id,$msg_inline_audio_expander.data("real-src"))}var $msg_inline_audio_collapser=$el.closest(".msg_inline_audio_collapser");if($msg_inline_audio_collapser.length){e.preventDefault();TS.inline_audios.collapse(container_id,$msg_inline_audio_collapser.data("real-src"))}var $inline_audio_play_link=$el.closest(".inline_audio_play_link");if($inline_audio_play_link.length){e.preventDefault();var url=$inline_audio_play_link.attr("href");return alert("play "+url)}},makeInternalInlineAudio:function(key,attachment){if(!attachment.audio_html)return;attachment.safe_audio_html=attachment.audio_html;attachment.safe_audio_html=TS.utility.swapInRedirUrlForIframe(attachment.safe_audio_html);if(TS.client)attachment.safe_audio_html=TS.utility.getPlaceholderHTMLFromIframe(attachment.safe_audio_html);TS.model.inline_audios[key]={src:TS.utility.htmlEntities(attachment.audio_url||attachment.audio_html),attachment:attachment}}})})();(function(){"use strict";TS.registerModule("privacy_policy_dialog",{div:null,is_showing:false,default_setting:{title:"",body:"BODY",body_template:null,onGo:null,onCancel:null,onEnd:null,esc_for_ok:false,onShow:null,force_small:false,enter_always_gos:false},current_setting:null,body_template_html:{},Q:[],onStart:function(){},start:function(setting){if(TS.privacy_policy_dialog.is_showing){if(setting.unique&&TS.privacy_policy_dialog.current_setting.unique==setting.unique){
TS.info("redundant generic dialog not Qed: "+setting.unique)}else{TS.privacy_policy_dialog.Q.push(setting)}return}var current_setting=TS.privacy_policy_dialog.current_setting=$.extend(TS.utility.clone(TS.privacy_policy_dialog.default_setting),setting);if(!TS.privacy_policy_dialog.div)TS.privacy_policy_dialog.build();var div=TS.privacy_policy_dialog.div;var html=TS.templates.privacy_policy_dialog({title:current_setting.title,body:current_setting.body,footer:current_setting.footer});div.empty();div.html(html);div.find(".close").bind("click",function(){if(current_setting.show_cancel_button){TS.privacy_policy_dialog.cancel()}else if(current_setting.esc_for_ok){TS.privacy_policy_dialog.go()}});div.find(".dialog_go").click(TS.privacy_policy_dialog.go);if(current_setting.go_button_text){div.find(".dialog_go").html(current_setting.go_button_text)}if(current_setting.show_go_button){div.find(".dialog_go").removeClass("hidden").addClass(current_setting.go_button_class)}div.css("opacity",0);div.css("display","block");window.setTimeout(function(){div.css("marginLeft","0px");div.slideDown(function(){div.animate({opacity:1},{duration:500,complete:function(){div.addClass("fading-in");div.modal({backdrop:false}).show();if(document.activeElement&&document.activeElement!=document.body){document.activeElement.blur()}if(current_setting.onShow){current_setting.onShow()}}})})},1)},go:function(e){if(!TS.privacy_policy_dialog.is_showing){TS.error("not showing?");return}var current_setting=TS.privacy_policy_dialog.current_setting;var div=TS.privacy_policy_dialog.div;function goComplete(){div.removeClass("fading-in");div.fadeOut(750,function(){div.modal("hide")})}if(current_setting.onGo){if(current_setting.onGo(e)!==false){goComplete()}}else{goComplete()}},cancel:function(){var current_setting=TS.privacy_policy_dialog.current_setting;var div=TS.privacy_policy_dialog.div;div.removeClass("fading-in");div.fadeOut(750,function(){div.modal("hide")});if(current_setting.onCancel){current_setting.onCancel()}},end:function(){var current_setting=TS.privacy_policy_dialog.current_setting;TS.privacy_policy_dialog.is_showing=TS.model.dialog_is_showing=false;TS.privacy_policy_dialog.div.empty();if(current_setting.onEnd){current_setting.onEnd()}if(!TS.privacy_policy_dialog.is_showing&&TS.privacy_policy_dialog.Q.length){var o=TS.privacy_policy_dialog.Q.shift();TS.privacy_policy_dialog.start(o)}},build:function(){$("body").append('<div id="privacy_policy_dialog" class="modal" data-keyboard="false"></div>');var div=TS.privacy_policy_dialog.div=$("#privacy_policy_dialog");div.on("hidden",function(e){if(e.target!=this)return;setTimeout(function(){TS.privacy_policy_dialog.end()},200)});div.on("show",function(e){if(e.target!=this)return;TS.privacy_policy_dialog.is_showing=TS.model.dialog_is_showing=true})}})})();(function(){"use strict";TS.registerModule("clipboard",{onStart:function(){},canWriteText:function(){return _implementation._canWriteText()},writeText:function(str){_implementation._writeText(str)},canWriteHTML:function(){return _implementation._canWriteHTML()},writeHTML:function(str){_implementation._writeHTML(str)},test:function(){return{detectImplementation:_detectImplementation}}});var _implementation;var _canCopy=false;var _detectImplementation=function(){if(_ssbImplementation._canWriteText()){_implementation=_ssbImplementation}else{_detectSupport();_implementation=_browserImplementation}};var _detectSupport=function(){_canCopy=false;if(bowser){if(bowser.chrome&&bowser.version>=42)_canCopy=true;if(bowser.firefox&&bowser.version>=41)_canCopy=true;if(bowser.msie&&bowser.version>=9)_canCopy=true;if(bowser.opera&&bowser.version>=29)_canCopy=true}$(window).one("click.check_clipboard_support",function(){_canCopy=document.queryCommandSupported("copy")})};var _browserImplementation={_canWriteText:function(){return _canCopy},_writeText:function(text){var temp_node=document.createElement("textarea");temp_node.appendChild(document.createTextNode(text));document.body.appendChild(temp_node);this._writeNode(temp_node);document.body.removeChild(temp_node)},_canWriteHTML:function(){return _canCopy},_writeHTML:function(html){var temp_node=$("<p>").html(html);$("body").append(temp_node);this._writeNode(temp_node);temp_node.remove()},_writeNode:function(node){try{this._saveSelection();node.select();document.execCommand("copy")}catch(e){TS.warn("Something bad happened when we tried to copy: "+e)}finally{this._restoreSelection()}},_saveSelection:function(){this._current_ranges=[];this._sel=window.getSelection();for(var i=0;i<this._sel.rangeCount;i++){this._current_ranges.push(this._sel.getRangeAt(i))}},_restoreSelection:function(){var self=this;this._sel.removeAllRanges();this._current_ranges.forEach(function(range){self._sel.addRange(range)})}};var _ssbImplementation={_canWriteText:function(){return window.TSSSB&&TSSSB.call("canClipboardWriteString")},_writeText:function(str){TSSSB.call("clipboardWriteString",str)},_canWriteHTML:function(){return false},_writeHTML:function(){return TS.warn("We cannot write HTML in SSB")}};_detectImplementation()})();(function(){"use strict";TS.registerModule("inline_imgs",{no_scrolling:false,onStart:function(){},shouldExpand:function(container_id,inline_img){if(!inline_img||!inline_img.src)return false;if(TS.model.expandable_state["img_"+container_id+inline_img.src])return true;if(TS.model.expandable_state["img_"+container_id+inline_img.src]===false)return false;if(inline_img.should_expand===true)return true;if(!inline_img.internal_file_id){if(TS.model.prefs.obey_inline_img_limit&&inline_img.bytes>TS.model.inline_img_byte_limit)return false;if(inline_img.width&&inline_img.height){if(inline_img.width*inline_img.height>TS.model.inline_img_pixel_limit)return false}}if(inline_img.internal_file_id){var inline_file_state=TS.inline_file_previews.expandableState(container_id,inline_img.internal_file_id);if(typeof inline_file_state==="boolean")return inline_file_state;return TS.model.prefs.expand_internal_inline_imgs}return TS.model.prefs.expand_inline_imgs},expandAllInCurrent:function(){TS.inline_imgs.no_scrolling=true;$(".msg_inline_img_expander").trigger("click");$(".msg_inline_img_toggler.collapsed").trigger("click");TS.inline_imgs.no_scrolling=false;if(TS.client){TS.client.ui.instaScrollMsgsToBottom(false)}},collapseAllInCurrent:function(){$(".msg_inline_img_collapser").trigger("click");$(".msg_inline_img_toggler.expanded").trigger("click")},expand:function(container_id,src){TS.model.expandable_state["img_"+container_id+src]=true;TS.storage.storeExpandableState(TS.model.expandable_state);var selector="#"+TS.utility.makeSafeForDomId(container_id);var $el=$(selector);if(!$el.length)return;var was_at_bottom=TS.client&&TS.client.ui.areMsgsScrolledToBottom();var filter=function(i){return $(this).data("real-src")==src};var $holder=TS.boot_data.feature_attachments_inline?$el.find(".inline_attachment").filter(filter):null;if(!$holder||!$holder.length)$holder=$el.find(".msg_inline_img_holder").filter(filter);$holder.removeClass("hidden");$el.find(".msg_inline_img_expander").filter(filter).addClass("hidden");$el.find(".msg_inline_img_collapser").filter(filter).removeClass("hidden");$el.find(".msg_inline_img_toggler").removeClass("collapsed").addClass("expanded");$el.find(".too_large_for_auto_expand").addClass("hidden");$el.find(".inline_img_bytes").removeClass("hidden");if(TS.client)TS.client.ui.checkInlineImgsAndIframesEverywhere();$holder.css("opacity",0).stop().animate({opacity:1},300);if(!TS.inline_imgs.no_scrolling){if(TS.client&&was_at_bottom){TS.client.ui.instaScrollMsgsToBottom(false);$holder.scrollintoview({duration:0,offset:"top",px_offset:10,direction:"y"})}else{$holder.scrollintoview({duration:200,offset:"bottom",px_offset:-10,direction:"y"})}}if(TS.client)TS.client.ui.checkInlineImgsAndIframesEverywhere()},collapse:function(container_id,src){TS.model.expandable_state["img_"+container_id+src]=false;TS.storage.storeExpandableState(TS.model.expandable_state);var selector="#"+TS.utility.makeSafeForDomId(container_id);var $el=$(selector);if(!$el.length)return;var filter=function(i){return $(this).data("real-src")==src};var $holder=TS.boot_data.feature_attachments_inline?$el.find(".inline_attachment").filter(filter):null;if(!$holder||!$holder.length)$holder=$el.find(".msg_inline_img_holder").filter(filter);$el.find(".msg_inline_img_expander").filter(filter).removeClass("hidden");$el.find(".msg_inline_img_collapser").filter(filter).addClass("hidden");$el.find(".msg_inline_img_toggler").removeClass("expanded").addClass("collapsed");$holder.addClass("hidden")},checkForInlineImgClick:function(e,match){if(!e.target)return;var $el=$(e.target);var container_id;if(TS.boot_data.feature_message_replies){var $message=$el.closest(".message");container_id=$message.attr("id");if(!container_id)return}else{var msg_id=$el.closest(".message").data("ts");container_id=TS.templates.makeMsgDomId(msg_id);if(match){msg_id=$el.closest(".search_message_result").data("ts");container_id=TS.templates.makeMSRDomId(match)}if(!msg_id)return}var $too_large_but_expand_anyway=$el.closest(".too_large_but_expand_anyway");if($too_large_but_expand_anyway.length){e.preventDefault();TS.inline_imgs.expand(container_id,$too_large_but_expand_anyway.data("real-src"))}var $msg_inline_img_toggler=$el.closest(".msg_inline_img_toggler");if($msg_inline_img_toggler.length){e.preventDefault();var src=$msg_inline_img_toggler.next("*[data-real-src]").data("real-src");if(TS.inline_imgs.shouldExpand(container_id,TS.model.inline_imgs[src])){TS.inline_imgs.collapse(container_id,src)}else{TS.inline_imgs.expand(container_id,src)}return}var $msg_inline_img_expander=$el.closest(".msg_inline_img_expander");if($msg_inline_img_expander.length){e.preventDefault();TS.inline_imgs.expand(container_id,$msg_inline_img_expander.data("real-src"))}var $msg_inline_img_collapser=$el.closest(".msg_inline_img_collapser");if($msg_inline_img_collapser.length){e.preventDefault();TS.inline_imgs.collapse(container_id,$msg_inline_img_collapser.data("real-src"))}},makeInternalInlineImg:function(key,img){var max_w=400;var max_h=500;if(TS.model.inline_imgs[key]){img.internal_file_id=TS.model.inline_imgs[key].internal_file_id||img.internal_file_id;img.link_url=TS.model.inline_imgs[key].link_url||img.link_url;img.src=TS.model.inline_imgs[key].src||img.src}TS.model.inline_imgs[key]=img;img.src=img.src||key;img.bytes=parseInt(img.bytes);img.width=img.display_w=parseInt(img.width);img.height=img.display_h=parseInt(img.height);if(img.display_w>max_w){img.display_w=max_w;img.display_h=parseInt(img.height*(img.display_w/img.width))}if(img.display_h>max_h){img.display_h=max_h;img.display_w=parseInt(img.width*(img.display_h/img.height))}var proxied_src=TS.utility.getImgProxyURL(img.src,img.display_w,img.display_h);if(proxied_src!=img.src){img.proxied_src=proxied_src}else{delete img.proxied_src}}})})();(function(){"use strict";TS.registerModule("kb_nav",{onStart:function(){},start:function($context,selector,container_selector,settings){_$context=$context;_item_selector=selector;_mouse.lastX=null;_mouse.lastY=null;if(!container_selector){container_selector="#menu"}_$container=$(container_selector);_use_data_ordering=settings&&!!settings.use_data_ordering;_settings=settings;$(document).on("mousemove.keyboard_navigation",_watchMouse);$(document).on("keydown",TS.kb_nav.onKeyDown);_$context.on("mouseenter.keyboard_navigation",_item_selector,_onHoverItem)},end:function(){_clearHighlightedItem();_disableKeyboardMode();if(_$context){_$context.off(".keyboard_navigation")}_$context=null;_item_selector=null;_$highlighted_item=null;_allow_highlight_without_blurring_input=false;_submit_item_handler=null;_use_data_ordering=false;_settings=null;$(document).off("mousemove.keyboard_navigation",_watchMouse);$(document).off("keydown",TS.kb_nav.onKeyDown)},getHighlightedItem:function(){return _$highlighted_item},clearHighlightedItem:function(){_clearHighlightedItem()},highlightFirstItem:function(){var first=_getFirst();if(first&&first.length>0){_enableKeyboardMode();_highlightItemWithKey(first)}else{_clearHighlightedItem()}},highlightItemWithKey:function($el,no_scroll){_highlightItemWithKey($el,no_scroll)},setAllowHighlightWithoutBlurringInput:function(bool){_allow_highlight_without_blurring_input=bool},setSubmitItemHandler:function(cb){_submit_item_handler=cb},onKeyDown:function(e){var keymap=TS.utility.keymap;var key=e.which;var modifier_pressed=e.metaKey||e.ctrlKey||e.shiftKey||e.altKey;if(key==keymap.up&&(_allow_highlight_without_blurring_input&&!modifier_pressed||!_isElementTextInput(e.target))){e.stopPropagation();e.preventDefault();_enableKeyboardMode();_moveHighlightUp(e);return}if(key==keymap.down&&(_allow_highlight_without_blurring_input&&!modifier_pressed||!_isElementTextInput(e.target))){e.stopPropagation();e.preventDefault();_enableKeyboardMode();_moveHighlightDown(e);return}if(key==keymap.left&&!_isElementTextInput(e.target)){e.stopPropagation();e.preventDefault();_enableKeyboardMode();if(_settings&&_settings.onLeftKeyDownIfSubmenuExists&&_settings.onLeftKeyDownIfSubmenuExists(e))return;_moveHighlightUp(e);return}if(key==keymap.right&&!_isElementTextInput(e.target)){e.stopPropagation();e.preventDefault();_enableKeyboardMode();if(_settings&&_settings.onRightKeyDownIfSubmenuExists&&_settings.onRightKeyDownIfSubmenuExists(e))return;_moveHighlightDown(e);return}if(key==keymap.tab){e.stopPropagation();e.preventDefault();_enableKeyboardMode();if(!_allow_highlight_without_blurring_input&&_isElementTextInput(e.target)){$(e.target).blur()}if(e.shiftKey){_moveHighlightUp(e)}else{_moveHighlightDown(e)}return}if(key==keymap.enter&&_$highlighted_item){if(_submit_item_handler){var li=_$highlighted_item.get(0);if(li){_submit_item_handler.call(li,e)}else{_submit_item_handler(e)}return}e.stopPropagation();e.preventDefault();_submitHighlightedItem();return}}});var _css={keyboard_active:"keyboard_active",no_pointer_events:"no_pointer_events"};var _$container=null;var _$context=null;var _keyboard_active=false;var _item_selector=null;var _$highlighted_item=null;var _allow_highlight_without_blurring_input=false;var _submit_item_handler=null;var _use_data_ordering=false;var _settings;var _enableKeyboardMode=function(){if(_keyboard_active)return;_$container.addClass(_css.keyboard_active);_$container.addClass(_css.no_pointer_events);_keyboard_active=true};var _mouse={lastX:null,lastY:null};var _watchMouse=function(e){if(!_keyboard_active){_mouse.lastX=e.clientX;_mouse.lastY=e.clientY;return}if(_mouse.lastX===null){_mouse.lastX=e.clientX;_mouse.lastY=e.clientY}else{if(e.clientX!==_mouse.lastX||e.clientY!==_mouse.lastY){_disableKeyboardMode()}_mouse.lastX=e.clientX;_mouse.lastY=e.clientY}};var _disableKeyboardMode=function(){if(!_keyboard_active)return;_clearHighlightedItem();_$container.removeClass(_css.keyboard_active);_$container.removeClass(_css.no_pointer_events);_keyboard_active=false};var _moveHighlightUp=function(e){var next_item;var selector=_item_selector;if(_$highlighted_item){next_item=_getPrev(_$highlighted_item)}else{next_item=_getLast()}if(next_item&&next_item.length>0){_highlightItemWithKey(next_item)}else if(_$context.children(selector).filter(":not(.disabled):visible").length!==0){_clearHighlightedItem();_moveHighlightUp(e)}};var _moveHighlightDown=function(e){var next_item;var selector=_item_selector;if(_$highlighted_item){next_item=_getNext(_$highlighted_item)}else{next_item=_getFirst()}if(next_item&&next_item.length>0){_highlightItemWithKey(next_item)}else if(_$context.children(selector).filter(":not(.disabled):visible").length!==0){_clearHighlightedItem();_moveHighlightDown(e)}};var _highlightItemWithKey=function($el,no_scroll){_clearHighlightedItem();_$highlighted_item=$el;var px_offset=0;if(_settings&&_settings.px_offset)px_offset=_settings.px_offset;$el.addClass("highlighted");if(!no_scroll)$el.scrollintoview({offset:"top",px_offset:px_offset,duration:0});if(!_settings||!_settings.no_blur){$el.find("a:first").focus()}_$highlighted_item.trigger("highlighted")};var _clearHighlightedItem=function(){if(_$highlighted_item){_$highlighted_item.trigger("unhighlighted");_$highlighted_item.removeClass("highlighted");_$highlighted_item=null}};var _onHoverItem=function(e){_clearHighlightedItem();_$highlighted_item=$(e.target).closest(_item_selector);_$highlighted_item.trigger("highlighted")};var _submitHighlightedItem=function(){if(_$highlighted_item){_$highlighted_item.find("a:first").click()}};var _isElementTextInput=function(el){return $(el).is("input, textarea")};var _getFirst=function(){if(_use_data_ordering){if(_settings.scrollToStartImmediately)_settings.scrollToStartImmediately();var ordered=_getElementsOrdered();if(ordered.length===0)return null;return $(ordered[0])}else{return _$context.children(_item_selector).filter(":not(.disabled):visible:first")}};var _getLast=function(){if(_use_data_ordering){if(_settings.scrollToEndImmediately)_settings.scrollToEndImmediately();var ordered=_getElementsOrdered();if(ordered.length===0)return null;return $(ordered[ordered.length-1])}else{return _$context.children(_item_selector).filter(":not(.disabled):visible:last")}};var _getNext=function($current){if(_use_data_ordering){var ordered=_getElementsOrdered();var order_index=$current.data("order-index");for(var i=0;i<ordered.length;i++){if($(ordered[i]).data("order-index")==order_index){if(i+1<ordered.length)return $(ordered[i+1]);break}}return null}else{return $current.nextAll(_item_selector).filter(":not(.disabled):visible:first")}};var _getPrev=function($current){if(_use_data_ordering){var ordered=_getElementsOrdered();var order_index=$current.data("order-index");for(var i=0;i<ordered.length;i++){if($(ordered[i]).data("order-index")==order_index){if(i-1>=0)return $(ordered[i-1]);break}}return null}else{return $current.prevAll(_item_selector).filter(":not(.disabled):visible:first")}};var _getElementsOrdered=function(){var $items=_$context.children(_item_selector).filter(":not(.disabled):visible");var items=$.makeArray($items);items.sort(function(a,b){var a_index=$(a).data("order-index");var b_index=$(b).data("order-index");return a_index-b_index});return items}})();(function(){"use strict";TS.registerModule("sounds",{onStart:function(){var root_url=TS.boot_data.abs_root_url;var all_sounds=[].concat(TS.boot_data.notification_sounds||[]).concat(TS.boot_data.alert_sounds||[]).concat(TS.boot_data.chat_sounds||[]).concat(TS.boot_data.call_sounds||[]);var preloadA=[];TS.log(37,"adding all_sounds: "+all_sounds.length);all_sounds.forEach(function(sound){if(!sound.url)return;if(sound.url.indexOf("http")!==0){sound.url=root_url+sound.url.replace("/","")}TS.log(37,"adding sound: "+sound.value);_sounds[sound.value]={url:sound.url};TS.log(37,"_sounds["+sound.value+"] = "+_sounds[sound.value]);preloadA.push(sound.url)});if(window.Audio){soundManager.onready(function(){$.each(_sounds,function(key,object){_sounds[key]=soundManager.createSound(object)})})}try{if(TSSSB.call("preloadSounds",preloadA)){TS.log(37,"called TSSSB.call('preloadSounds', '"+preloadA+"')")}else{TS.log(37,"NOT CALLED TSSSB.call('preloadSounds', '"+preloadA+"')")}}catch(err){TS.warn("error calling TSSSB.preloadSounds "+err+" "+preloadA)}},shouldMuteSounds:function(options){options=options||{};options.ignore_mute=options.ignore_mute||false;var should_mute=TS.model&&TS.model.prefs&&TS.model.prefs.mute_sounds;should_mute=should_mute||TSSSB.call("shouldMuteAudio");should_mute=should_mute&&!options.ignore_mute;return should_mute},filenameForSoundName:function(which){if(which=="new_message"){which=TS.model.prefs.new_msg_snd}if(which=="none"){return}if(which=="beep"){which="frog.mp3"}if(!(which in _sounds)){TS.warn("unknown sound: "+which);return}if(TS.sounds.shouldMuteSounds()){return}return which},soundForName:function(which,options){which=TS.sounds.filenameForSoundName(which);if(!which){return}if(TS.sounds.shouldMuteSounds(options)){return}return _sounds[which]},play:function(which,options){options=options||{};options.should_loop=options.should_loop||false;options.playback_device=options.playback_device||"";options.ignore_mute=options.ignore_mute||false;var sound=TS.sounds.soundForName(which,options);if(sound){var args={url:sound.url,should_loop:options.should_loop,playback_device:options.playback_device};if(TSSSB.call("playRemoteSound",args)){TS.log(37,"called TSSSB.call('playRemoteSound', '"+JSON.stringify(args)+"'})")}else{TS.log(37,"calling sound.play()");sound.play({loops:options.should_loop?999999:0})}}else if(soundManager){TS.warn("sound is null: "+which+" window.Audio: "+window.Audio+" window.winssb: "+window.winssb+" soundManager.ok(): "+soundManager.ok()+" soundManager.html5Only: "+soundManager.html5Only+" soundManager.canPlayMIME('audio/mp3'): "+soundManager.canPlayMIME("audio/mp3"))}},stop:function(which,options){options=options||{};options.ignore_mute=options.ignore_mute||false;var sound=TS.sounds.soundForName(which,options);if(sound){if(TSSSB.call("stopRemoteSound",sound.url)){TS.log(37,"called TSSSB.call('stopRemoteSound', '"+sound.url+"')")}else{TS.log(37,"calling sound.stop()");sound.stop()}}else if(soundManager){TS.warn("sound is null: "+which+" window.Audio: "+window.Audio+" window.winssb: "+window.winssb+" soundManager.ok(): "+soundManager.ok()+" soundManager.html5Only: "+soundManager.html5Only+" soundManager.canPlayMIME('audio/mp3'): "+soundManager.canPlayMIME("audio/mp3"))}},getNotificationSoundNameFromFilename:function(filename){var notif_sound=_.find(TS.boot_data.notification_sounds,{value:filename});if(!notif_sound){TS.error("No notification sound found matching "+filename);return}return notif_sound.label}});var _sounds={}})();(function(){"use strict";TS.registerModule("bandwidth",{onStart:function(){},promiseToCheckBandwidth:function(){if(_run_test_p)return _run_test_p;_run_test_p=_runTest();_run_test_p.catch(function(){_run_test_p=null});return _run_test_p}});var _bw;var _run_test_p;function _runTest(){return new Promise(function(resolve,reject){_bw={base_url:(window.cdn_url||"")+"/beacons/boomerang1/",timeout:3e4,nruns:5,latency_runs:10,results:[],latencies:[],latency:null,runs_left:0,aborted:false,complete:false};_bw.images=[{name:"image-0.png",size:11483,timeout:1400},{name:"image-1.png",size:40658,timeout:1200},{name:"image-2.png",size:164897,timeout:1300},{name:"image-3.png",size:381756,timeout:1500},{name:"image-4.png",size:1234664,timeout:1200},{name:"image-5.png",size:4509613,timeout:1200},{name:"image-6.png",size:9084559,timeout:1200}];_bw.images.end=_bw.images.length;_bw.images.start=0;_bw.images.l={name:"image-l.gif",size:35,timeout:1e3};_bw.images.start=0;_bw.runs_left=_bw.nruns;_bw.latency_runs=10;_bw.results=[];_bw.latencies=[];_bw.latency=null;_bw.complete=false;_bw.aborted=false;_bw.ncmp=function(a,b){return a-b};_bw.iqr=function(a){var l=a.length-1;var q1=(a[Math.floor(l*.25)]+a[Math.ceil(l*.25)])/2;var q3=(a[Math.floor(l*.75)]+a[Math.ceil(l*.75)])/2;var b=[];var i;var fw=(q3-q1)*1.5;l++;for(i=0;i<l&&a[i]<q3+fw;i++){if(a[i]>q1-fw){b.push(a[i])}}return b};_bw.calcLatency=function(){var i;var n;var sum=0;var sumsq=0;var amean;var median;var std_dev;var std_err;var lat_filtered;lat_filtered=this.iqr(this.latencies.sort(this.ncmp));n=lat_filtered.length;for(i=1;i<n;i++){sum+=lat_filtered[i];sumsq+=lat_filtered[i]*lat_filtered[i]}n--;amean=Math.round(sum/n);std_dev=Math.sqrt(sumsq/n-sum*sum/(n*n));std_err=(1.96*std_dev/Math.sqrt(n)).toFixed(2);std_dev=std_dev.toFixed(2);n=lat_filtered.length-1;median=Math.round((lat_filtered[Math.floor(n/2)]+lat_filtered[Math.ceil(n/2)])/2);return{mean:amean,median:median,stddev:std_dev,stderr:std_err}};_bw.calcBW=function(){var i;var j;var n=0;var r;var bandwidths=[];var bandwidths_corrected=[];var sum=0;var sumsq=0;var sum_corrected=0;var sumsq_corrected=0;var amean;var std_dev;var std_err;var median;var amean_corrected;var std_dev_corrected;var std_err_corrected;var median_corrected;var nimgs;var bw;var bw_c;for(i=0;i<this.nruns;i++){if(!this.results[i]||!this.results[i].r){continue}r=this.results[i].r;nimgs=0;for(j=r.length-1;j>=0&&nimgs<3;j--){if(typeof r[j]==="undefined"){break}if(r[j].t===null){continue}n++;nimgs++;bw=this.images[j].size*1e3/r[j].t;bandwidths.push(bw);bw_c=this.images[j].size*1e3/(r[j].t-this.latency.mean);bandwidths_corrected.push(bw_c)}}if(bandwidths.length>3){bandwidths=this.iqr(bandwidths.sort(this.ncmp));bandwidths_corrected=this.iqr(bandwidths_corrected.sort(this.ncmp))}else{bandwidths=bandwidths.sort(this.ncmp);bandwidths_corrected=bandwidths_corrected.sort(this.ncmp)}n=Math.max(bandwidths.length,bandwidths_corrected.length);for(i=0;i<n;i++){if(i<bandwidths.length){sum+=bandwidths[i];sumsq+=Math.pow(bandwidths[i],2)}if(i<bandwidths_corrected.length){sum_corrected+=bandwidths_corrected[i];sumsq_corrected+=Math.pow(bandwidths_corrected[i],2)}}n=bandwidths.length;amean=Math.round(sum/n);std_dev=Math.sqrt(sumsq/n-Math.pow(sum/n,2));std_err=Math.round(1.96*std_dev/Math.sqrt(n));std_dev=Math.round(std_dev);n=bandwidths.length-1;median=Math.round((bandwidths[Math.floor(n/2)]+bandwidths[Math.ceil(n/2)])/2);n=bandwidths_corrected.length;amean_corrected=Math.round(sum_corrected/n);std_dev_corrected=Math.sqrt(sumsq_corrected/n-Math.pow(sum_corrected/n,2));std_err_corrected=(1.96*std_dev_corrected/Math.sqrt(n)).toFixed(2);std_dev_corrected=std_dev_corrected.toFixed(2);n=bandwidths_corrected.length-1;median_corrected=Math.round((bandwidths_corrected[Math.floor(n/2)]+bandwidths_corrected[Math.ceil(n/2)])/2);return{mean:amean,stddev:std_dev,stderr:std_err,median:median,mean_corrected:amean_corrected,stddev_corrected:std_dev_corrected,stderr_corrected:std_err_corrected,median_corrected:median_corrected}};_bw.defer=function(method){var that=this;return setTimeout(function(){method.call(that);that=null},10)};_bw.loadImg=function(i,run,callback){var url=this.base_url+this.images[i].name+"?t="+Date.now()+Math.random();var timer=0;var tstart=0;var img=new Image;var that=this;img.onload=function(){img.onload=img.onerror=null;img=null;clearTimeout(timer);if(callback){callback.call(that,i,tstart,run,true)}that=callback=null};img.onerror=function(){img.onload=img.onerror=null;img=null;clearTimeout(timer);if(callback){callback.call(that,i,tstart,run,false)}that=callback=null};timer=setTimeout(function(){if(callback){callback.call(that,i,tstart,run,null)}},this.images[i].timeout+Math.min(400,this.latency?this.latency.mean:400));tstart=Date.now();img.src=url};_bw.latLoaded=function(i,tstart,run,success){if(run!==this.latency_runs+1)return;if(success!==null){var lat=Date.now()-tstart;this.latencies.push(lat)}if(this.latency_runs===0){this.latency=this.calcLatency()}this.defer(this.iterate)};_bw.imgLoaded=function(i,tstart,run,success){if(run!==this.runs_left+1)return;if(this.results[this.nruns-run].r[i])return;if(success===null){this.results[this.nruns-run].r[i+1]={t:null,state:null,run:run};return}var result={start:tstart,end:Date.now(),t:null,state:success,run:run};if(success){result.t=result.end-result.start}this.results[this.nruns-run].r[i]=result;if(i>=this.images.end-1||typeof this.results[this.nruns-run].r[i+1]!=="undefined"){if(run===this.nruns){this.images.start=i}this.defer(this.iterate)}else{this.loadImg(i+1,run,this.imgLoaded)}};_bw.iterate=function(){if(this.aborted){return false}if(!this.runs_left){this.finish()}else if(this.latency_runs){this.loadImg("l",this.latency_runs--,this.latLoaded)}else{this.results.push({r:[]});this.loadImg(this.images.start,this.runs_left--,this.imgLoaded)}};_bw.finish=function(){if(!this.latency){this.latency=this.calcLatency()}var bw=this.calcBW();var o={bw:bw.median_corrected,bw_err:parseFloat(bw.stderr_corrected,10),lat:this.latency.mean,lat_err:parseFloat(this.latency.stderr,10)};if(isNaN(o.bw)||isNaN(o.lat)){o.kbps=0;o.mbps=0;reject(new Error("bandwidth test failed"));return}o.kbps=Math.round(o.bw*8/1024);o.mbps=Math.round(10*o.kbps/1024)/10;if(_bw.timer){window.clearTimeout(_bw.timer)}resolve(o)};_bw.timer=setTimeout(function(){_bw.aborted=true;_bw.finish()},_bw.timeout);_bw.defer(_bw.iterate)})}})();
